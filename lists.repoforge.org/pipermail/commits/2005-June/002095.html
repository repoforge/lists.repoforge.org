<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r3293 - in trunk/tools/pydar2: . dries dries/pydar2 pydar	scripts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r3293%20-%20in%20trunk/tools/pydar2%3A%20.%20dries%20dries/pydar2%20pydar%0A%09scripts&In-Reply-To=%3C20050608185215.903C9944A90%40pooch.vmhosting.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002094.html">
   <LINK REL="Next"  HREF="002096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r3293 - in trunk/tools/pydar2: . dries dries/pydar2 pydar	scripts</H1>
    <B>packagers at lists.rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r3293%20-%20in%20trunk/tools/pydar2%3A%20.%20dries%20dries/pydar2%20pydar%0A%09scripts&In-Reply-To=%3C20050608185215.903C9944A90%40pooch.vmhosting.org%3E"
       TITLE="[svn] r3293 - in trunk/tools/pydar2: . dries dries/pydar2 pydar	scripts">packagers at lists.rpmforge.net
       </A><BR>
    <I>Wed Jun  8 20:52:15 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002094.html">[svn] r3292 - in trunk/tools/dconf: . config
</A></li>
        <LI>Next message: <A HREF="002096.html">[svn] r3294 - in trunk/rpms: perl-Apache-AuthCookie	perl-Apache-DBILogin perl-Apache-Htpasswd perl-Authen-SASL	perl-Business-ISBN perl-Business-ISBN-Data	perl-CGI-Application perl-CPANPLUS perl-CSS-Tiny	perl-Chemistry-File-MDLMol perl-Chemistry-Mol	perl-Class-Autouse perl-Class-Loader perl-Class-MethodMaker	perl-Class-ReturnValue perl-Clone perl-Compress-Bzip2	perl-Compress-LZF perl-Config-General perl-Config-Record	perl-Config-Tiny perl-Convert-IBM390 perl-Convert-PEM	perl-Crypt-CAST5_PP perl-Crypt-CBC perl-Crypt-OpenSSL-DSA	perl-Crypt-OpenSSL-RSA perl-DBD-CSV perl-DBD-File	perl-DBIx-Abstract perl-DateTime	perl-DateTime-Event-Recurrence perl-DateTime-Locale	perl-DateTime-Set perl-DateTime-TimeZone perl-Event	perl-ExtUtils-CBuilder perl-ExtUtils-ParseXS	perl-File-ReadBackwards perl-File-Slurp perl-Filter-Simple	perl-GD-Convert perl-Graph perl-Image-Imlib2 perl-Inline-TT	perl-Lingua-EN-NameParse perl-Lingua-Stem-Snowball	perl-List-MoreUtils perl-Locale-Maketext-Lexicon	perl-Log-Log4perl perl-MIME-Types perl-MKDoc-XML	perl-MP3-Info perl-Math-BigInt-GMP perl-Math-Fleximal	perl-Module-CoreList perl-Module-Depends perl-Module-Info	perl-Module-Starter perl-Net-DAV-Server perl-Net-DMAP-Server	perl-Net-DPAP-Client perl-Net-IMAP-Simple perl-Net-IP	perl-Net-Netmask perl-Net-SSH-Perl perl-PHP-Perlinfo perl-POE	perl-POE-Component-Server-HTTP perl-PPI perl-Params-Validate	perl-Parse-FixedLength perl-RPC-XML perl-SQL-Statement	perl-SVG-Metadata perl-SVN-Mirror perl-Sort-Versions	perl-Spiffy perl-Spoon perl-Spreadsheet-WriteExcel	perl-String-Approx perl-String-CRC32 perl-String-Ediff	perl-String-ShellQuote perl-Test-AutoBuild	perl-Test-Exception perl-Test-ISBN perl-Test-Manifest	perl-Text-Autoformat perl-Text-German perl-Text-vCard	perl-Text-vFile-asData perl-Unix-Processors	perl-WWW-Search-Ebay perl-X11-Protocol	perl-XML-Generator-vCard-RDF perl-XML-Writer perl-YAML
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2095">[ date ]</a>
              <a href="thread.html#2095">[ thread ]</a>
              <a href="subject.html#2095">[ subject ]</a>
              <a href="author.html#2095">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dries
Date: 2005-06-08 20:52:13 +0200 (Wed, 08 Jun 2005)
New Revision: 3293

Modified:
   trunk/tools/pydar2/dries/index-part.html
   trunk/tools/pydar2/dries/pydar2/index-part.html
   trunk/tools/pydar2/dries/pydar2/planning-part.html
   trunk/tools/pydar2/pydar-buildserver-master.py
   trunk/tools/pydar2/pydar-buildserver-slave.py
   trunk/tools/pydar2/pydar/buildrootresult.py
   trunk/tools/pydar2/pydar/command.py
   trunk/tools/pydar2/pydar/commandlist.py
   trunk/tools/pydar2/pydar/preparespecfilescript.py
   trunk/tools/pydar2/pydar/preparespecfilescriptlist.py
   trunk/tools/pydar2/pydar/specrepository.py
   trunk/tools/pydar2/pydar/svnwrapper.py
   trunk/tools/pydar2/pydar/target.py
   trunk/tools/pydar2/pydar/yumbasedbuildroot.py
   trunk/tools/pydar2/scripts/rpmforgedriesrepo.py
   trunk/tools/pydar2/scripts/rpmforgegetsources.py
Log:
update

Modified: trunk/tools/pydar2/dries/index-part.html
===================================================================
--- trunk/tools/pydar2/dries/index-part.html	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/dries/index-part.html	2005-06-08 18:52:13 UTC (rev 3293)
@@ -6,7 +6,7 @@
 collaboration of several packagers. The aim of RPMforge is to provide packages for 
 various RPM-based distributions and a multitude of architectures (x86, AMD64, alpha and sparc) That's why 
 you will find so many rpms of Bert, Dag and Matthias on my site: i'm rebuilding all of 
-their spec files for Aurora Linux 1.92 (sparc).&lt;/p&gt;
+their spec files for Aurora Linux 1.92 (sparc) for example.&lt;/p&gt;
 &lt;p&gt;
 This repository contains TOTALRPMS rpm files and TOTALSRPMS source rpm files, divided as follows:
 &lt;ul&gt;

Modified: trunk/tools/pydar2/dries/pydar2/index-part.html
===================================================================
--- trunk/tools/pydar2/dries/pydar2/index-part.html	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/dries/pydar2/index-part.html	2005-06-08 18:52:13 UTC (rev 3293)
@@ -6,11 +6,13 @@
     &lt;li&gt;A central server contains a queue of spec files to build&lt;/li&gt;
     &lt;li&gt;One or more clients are able to build rpm files for certain distribution/architecture combinations&lt;/li&gt;
     &lt;li&gt;You can change most of the behaviour with options or userdefined scripts&lt;/li&gt;
+    &lt;li&gt;It is possible to automatically queue builds of spec files&lt;/li&gt;
   &lt;/ul&gt;
 &lt;/p&gt;
 &lt;h2&gt;What is the status of pydar2?&lt;/h2&gt;
 &lt;p&gt;
-Pydar2 is not fully finished. There's no decent documentation yet and not all the functionality is ready. These pages are currently meant for people who are really interested in buildsystems.
+Pydar2 is not fully finished. There's no decent documentation yet and not all the functionality is ready. These pages are currently meant for people who are really interested in buildsystems. I'm currently using 
+pydar2 myself so it is possible to use it already.
 &lt;/p&gt;
 &lt;p&gt;
 I'm going to try to keep a &lt;a href=&quot;planning.html&quot;&gt;planning of pydar2&lt;/a&gt; up to date so you can track the progress if you wish.

Modified: trunk/tools/pydar2/dries/pydar2/planning-part.html
===================================================================
--- trunk/tools/pydar2/dries/pydar2/planning-part.html	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/dries/pydar2/planning-part.html	2005-06-08 18:52:13 UTC (rev 3293)
@@ -5,20 +5,19 @@
   &lt;li&gt;23/5/2005: get the first pages about pydar2 online: done&lt;/li&gt;
   &lt;li&gt;25/5/2005: change buildroot so it checks for a yum config for a buildmachineid first: done&lt;/li&gt;
   &lt;li&gt;25/5/2005: basic document about installing the slave buildmachines: done&lt;/li&gt;
-  &lt;li&gt;Create templates for the yum configurations: only for fc&lt;/li&gt;
+  &lt;li&gt;Create templates for the yum configurations: only for fc done&lt;/li&gt;
   &lt;li&gt;26/5/2005: update the classdiagram and put it online: done&lt;/li&gt;
   &lt;li&gt;create a basic document about the client: todo&lt;/li&gt;
   &lt;li&gt;28/5/2005: make sure the mails contain meaningfull stuff: done&lt;/li&gt;
   &lt;li&gt;finish the spec file of pydar2 and build the rpms + put them online: not yet done.. &lt;/li&gt;
-  &lt;li&gt;Basic version of autoqueueing: &lt;/li&gt;
-  &lt;li&gt;
+  &lt;li&gt;Basic version of autoqueueing: done&lt;/li&gt;
+  &lt;li&gt;RsyncYumBasedBuildRoot: first version done&lt;/li&gt;
+  
 &lt;/ul&gt;
 &lt;/p&gt;
 &lt;h2&gt;Near future:&lt;/h2&gt;
 &lt;p&gt;
 &lt;ul&gt;
-  &lt;li&gt;automatically fill the queue&lt;/li&gt;
-  &lt;li&gt;RsyncYumBasedBuildRoot: seems to work ok!&lt;/li&gt;
   &lt;li&gt;finish MemoryStorage so it's possible to use pydar2 without 
   a PostgreSQL database (and without much persistence data)&lt;/li&gt;
 &lt;/ul&gt;
@@ -33,5 +32,5 @@
   &lt;li&gt;Check if it is possible to make pydar2 agnostic about 
   spec files and rpms. Would it be difficult to build other 
   stuff like slackware packages for example?&lt;/li&gt;
-  &lt;li&gt;Create an selinux config for at least the master and the client.&lt;/li&gt;
+  &lt;li&gt;Create an selinux config for at least the master and the client. The slave is currently very insecure and uses sudo for certain tasks so slave buildmachines should at least not be publicaly accessible.&lt;/li&gt;
 &lt;/ul&gt;

Modified: trunk/tools/pydar2/pydar/buildrootresult.py
===================================================================
--- trunk/tools/pydar2/pydar/buildrootresult.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/buildrootresult.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -20,6 +20,13 @@
 
 
 class BuildRootResult:
+    def getContainsErrorsText(self):
+        if self.containsErrors():
+            return &quot;The log contains errors.\n&quot;
+        else:
+            return &quot;The log contains no errors.\n&quot;
+        
+    
     def __init__(self,buildrootobj):
         self.__buildrootobj = buildrootobj
         self.__containsErrors = 0

Modified: trunk/tools/pydar2/pydar/command.py
===================================================================
--- trunk/tools/pydar2/pydar/command.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/command.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -73,5 +73,21 @@
         (dir,fname) = os.path.split(tmp)
         return fname
   
+    def toMultiLineString(self):
+        output = &quot;&quot;
+        output = output + &quot;command id: &quot; + str(self.getId()) + &quot;\n&quot;
+        output = output + &quot;spec file: &quot; + self.getSpecFileFileName() + &quot; (&quot; + str(self.getSpecFileId()) + &quot;)\n&quot;
+        output = output + &quot;spec repo: &quot; + self.getSpecRepositoryName() + &quot; (&quot; + str(self.getSpecRepoId()) + &quot;)\n&quot;
+        output = output + &quot;defines: &quot; + self.getDefines() + &quot;\n&quot;
+        output = output + &quot;command name: &quot; + self.getCommandName() + &quot;\n&quot;
+        output = output + &quot;user id: &quot; + str(self.getUserId()) + &quot;\n&quot;
+        output = output + &quot;priority: &quot; + str(self.getPriority()) + &quot;\n&quot;
+        output = output + &quot;to email: &quot; + self.getToEmail() + &quot;\n&quot;
+        output = output + &quot;target id: &quot; + str(self.getTargetId()) + &quot;\n&quot;
+        output = output + &quot;version: &quot; + str(self.getVersion()) + &quot;\n&quot;
+        output = output + &quot;authority: &quot; + str(self.getAuthority()) + &quot;\n&quot;
+        
+        return output
+    
     def toString(self):
         return &quot;commandName=&quot; + self.getCommandName()  + &quot;,userId=&quot; + str(self.getUserId()) + &quot;,specRepoId=&quot; + str(self.getSpecRepoId())  + &quot;,toEmail=&quot; + self.getToEmail()  + &quot;,specFileId=&quot; + str(self.getSpecFileId()) + &quot;,distroArchTag=&quot; + self.getDistroArchTag()  +  &quot;,commandId=&quot; + str(self.getId()) + &quot;,priority=&quot; + str(self.getPriority())

Modified: trunk/tools/pydar2/pydar/commandlist.py
===================================================================
--- trunk/tools/pydar2/pydar/commandlist.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/commandlist.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -20,6 +20,12 @@
 import storagefactory
 from mastercommand import MasterCommand
 from log4py import Logger
+from buildrootresult import BuildRootResult
+import smtplib
+from email.MIMEText import MIMEText
+from email.MIMEMultipart import MIMEMultipart
+from email.MIMEBase import MIMEBase
+from email import Encoders
 
 class CommandList:
     def __init__(self):
@@ -37,14 +43,15 @@
         
         
     def __createCommandDir(self,aCommand):
+        brr = BuildRootResult(None)
         commanddir = self.__config.getMasterWebRoot() + &quot;/&quot; + str(aCommand.getId())
         self.__cat.debug(&quot;command dir=&quot; + commanddir)
         os.mkdir(commanddir)
         shutil.copy(aCommand.getSpecRepositorySpecFile().getFullPath(), commanddir + &quot;/&quot;)
         # now we run some user defined scripts which may download sources, alter the spec file and so on
         # first the scripts defined by the specrepository, then the scripts defined by the target
-        aCommand.getSpecRepository().runPrepareSpecFileScripts(aCommand,commanddir)
-        aCommand.getTarget().runPrepareSpecFileScripts(aCommand,commanddir)
+        aCommand.getSpecRepository().runPrepareSpecFileScripts(aCommand,commanddir, brr)
+        aCommand.getTarget().runPrepareSpecFileScripts(aCommand,commanddir, brr)
         # also create a filelist
         self.__cat.debug(&quot;creating a filelist&quot;)
         fl = open(commanddir + &quot;/filelist.txt&quot;,&quot;w&quot;)
@@ -53,7 +60,39 @@
             if entry != &quot;filelist.txt&quot;:
                 fl.write(entry + &quot;\n&quot;)
         fl.close()
+        self.__mailPrepareInfo(aCommand, brr, commanddir)
         
+    def __mailPrepareInfo(self, command, brr, commanddir):
+        self.__cat.debug(&quot;start&quot;)
+        subject = &quot;pydar2:: prepare: &quot; + command.getDistroArchTag() + &quot; - &quot; + command.getSpecFileShortFileName()
+        self.__cat.debug(&quot;subject set&quot;)
+        output = brr.getContainsErrorsText() + &quot;\n&quot;
+        self.__cat.debug(&quot;errors descr added&quot;)
+        output = output + &quot;commanddir: &quot;+ commanddir + &quot;\n&quot;
+        output = output + command.toMultiLineString()
+        output = output + &quot;\nLog:\n&quot;
+        output = output + brr.getLog() + &quot;\n&quot;
+        specfilecontents = self.__getSpecFileContents(command, commanddir)
+        msg = MIMEMultipart()
+        msg['Subject'] = subject
+        msg['From'] = &quot;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">pydar-dries at vmhosting.org</A>&quot;
+        msg['To'] = command.getToEmail()
+        me = &quot;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">pydar-dries at vmhosting.org</A>&quot;
+        you = command.getToEmail()
+        msg.attach(MIMEText(output))
+        msg.attach(MIMEText(specfilecontents))
+        s = smtplib.SMTP(&quot;127.0.0.1&quot;)
+        s.sendmail(me, [you], msg.as_string())
+        s.close()
+
+    def __getSpecFileContents(self, command, commanddir):
+        fp = open(os.path.join(commanddir, command.getSpecFileShortFileName()))
+        retval = fp.read()
+        fp.close()
+        return retval
+    
+        
+        
     def __checkAndCreateCommand(self,commandName,userId,specRepoName,specFilePath,toEmail,distroArchTag,priority,targetName):
         if commandName != &quot;BUILDSPECBYPATH&quot;:
             raise Exception(&quot;unknown command name&quot;)

Modified: trunk/tools/pydar2/pydar/preparespecfilescript.py
===================================================================
--- trunk/tools/pydar2/pydar/preparespecfilescript.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/preparespecfilescript.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -22,5 +22,5 @@
 from callablescript import CallableScript
 
 class PrepareSpecFileScript(CallableScript):
-    def runScript(self,aCommand, commanddir):
-        return self._getMethod().__call__(aCommand, commanddir)
+    def runScript(self,aCommand, commanddir, brr):
+        return self._getMethod().__call__(aCommand, commanddir, brr)

Modified: trunk/tools/pydar2/pydar/preparespecfilescriptlist.py
===================================================================
--- trunk/tools/pydar2/pydar/preparespecfilescriptlist.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/preparespecfilescriptlist.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -28,8 +28,8 @@
         self.__cat.debug(&quot;new script added&quot;)
         self.__scriptsList.append(newScript)
         
-    def runScripts(self,aCommand,commanddir):
+    def runScripts(self,aCommand,commanddir, brr):
         for f in self.__scriptsList:
             self.__cat.debug(&quot;going to run a script&quot;)
-            f.runScript(aCommand,commanddir)
+            f.runScript(aCommand,commanddir, brr)
         return True

Modified: trunk/tools/pydar2/pydar/specrepository.py
===================================================================
--- trunk/tools/pydar2/pydar/specrepository.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/specrepository.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -80,8 +80,8 @@
     def appendPrepareSpecFileScript(self,newScript):
         self.__prepareSpecFileScriptList.appendScript(newScript)
         
-    def runPrepareSpecFileScripts(self,aCommand,commanddir):
-        self.__prepareSpecFileScriptList.runScripts(aCommand,commanddir)
+    def runPrepareSpecFileScripts(self,aCommand,commanddir, brr):
+        self.__prepareSpecFileScriptList.runScripts(aCommand,commanddir, brr)
     
     def setUpdateSiteScript(self,newScript):
         self.__updateSiteScript = newScript

Modified: trunk/tools/pydar2/pydar/svnwrapper.py
===================================================================
--- trunk/tools/pydar2/pydar/svnwrapper.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/svnwrapper.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -95,6 +95,11 @@
         self.cat.debug(&quot;start&quot;)
 
     def getLastCommitRev(self,dirpath,fullpath):
+        #if dirpath[len(dirpath)-1] == &quot;/&quot;:
+        #    self.cat.debug(&quot;removing last '/'&quot;)
+        #    dirpath = dirpath[0:len(dirpath)-2]
+        #else:
+        #    self.cat.debug(&quot;last char:&quot; + dirpath[len(dirpath)-1])
         self.cat.debug(&quot;start,dirpath=&quot; + dirpath + &quot;,fullpath=&quot;+fullpath)
         adm_baton = svn.wc.svn_wc_adm_open(None,dirpath,False,True,self.pool)
         entry = svn.wc.svn_wc_entry(fullpath,adm_baton,0,self.pool)

Modified: trunk/tools/pydar2/pydar/target.py
===================================================================
--- trunk/tools/pydar2/pydar/target.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/target.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -65,8 +65,8 @@
     def appendPrepareSpecFileScript(self,newScript):
         self.__prepareSpecFileScriptList.appendScript(newScript)
         
-    def runPrepareSpecFileScripts(self,aCommand,commanddir):
-        self.__prepareSpecFileScriptList.runScripts(aCommand,commanddir)
+    def runPrepareSpecFileScripts(self,aCommand,commanddir, brr):
+        self.__prepareSpecFileScriptList.runScripts(aCommand,commanddir, brr)
 
     def setGetRpmDataScript(self, newScript):
         self.__getRpmDataScript = newScript

Modified: trunk/tools/pydar2/pydar/yumbasedbuildroot.py
===================================================================
--- trunk/tools/pydar2/pydar/yumbasedbuildroot.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar/yumbasedbuildroot.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -213,9 +213,10 @@
         script = script + &quot;done\n&quot;
         script = script + &quot;chown -R root.root &quot; + self.rootdir + &quot;/usr/src/redhat\n&quot;
         # the following command first checks if the dependencies are ok
-        script = script + &quot;(/usr/bin/rpmbuild --root=&quot; + self.rootdir + &quot; --nobuild --bs &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &amp;&amp; &quot;
+        # ex: --define '_topdir /var/lib/pydar2/roots/yum-fc3-i386/usr/src/redhat'
+        script = script + &quot;(/usr/bin/rpmbuild --define '_topdir &quot; + self.rootdir + &quot;/usr/src/redhat' &quot; + command.getDefines() + &quot; --root=&quot; + self.rootdir + &quot; --nobuild --bs &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &amp;&amp; echo \&quot;deps check ok\&quot; &amp;&amp; &quot;
         # do the real build
-        script = script + &quot;/usr/sbin/chroot &quot; + self.rootdir + &quot; /usr/bin/rpmbuild --nodeps -ba /usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot;) &gt; &quot; + self.rootdir + &quot;/buildlog.txt 2&gt;&amp;1&quot;
+        script = script + &quot;/usr/sbin/chroot &quot; + self.rootdir + &quot; /usr/bin/rpmbuild --nodeps -ba /usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &quot; + command.getDefines() + &quot; ) &gt; &quot; + self.rootdir + &quot;/buildlog.txt 2&gt;&amp;1&quot;
         self.__cat.debug( &quot;script contains: &quot; + script)
         return script
         

Modified: trunk/tools/pydar2/pydar-buildserver-master.py
===================================================================
--- trunk/tools/pydar2/pydar-buildserver-master.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar-buildserver-master.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -32,6 +32,11 @@
 from optparse import OptionParser
 import time
 from rights import Rights
+import smtplib
+from email.MIMEText import MIMEText
+from email.MIMEMultipart import MIMEMultipart
+from email.MIMEBase import MIMEBase
+from email import Encoders
 
 #os.environ['HOME'] = '/root'
 
@@ -52,8 +57,6 @@
 
 # first pydar is based on mach only: sometimes the name machRoot is still used for a distro/arch combination
 
-testje = None
-
 class MasterRpc:
     def __init__(self):
         self.__cat = Logger().get_instance(self)

Modified: trunk/tools/pydar2/pydar-buildserver-slave.py
===================================================================
--- trunk/tools/pydar2/pydar-buildserver-slave.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/pydar-buildserver-slave.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -165,19 +165,10 @@
             rpmspart = rpmspart + &quot;  &quot; + brr.getSrpm()
         else:
             subject = &quot;pydar2:: build failed: &quot; + command.getDistroArchTag() + &quot; - &quot; + command.getSpecFileShortFileName()
-        if brr.containsErrors():
-            output = output + &quot;The log contains errors.\n\n&quot;
-        else:
-            output = output + &quot;The log contains no errors.\n\n&quot;
-        output = output + &quot;command id: &quot; + str(command.getId()) + &quot;\n&quot;
-        output = output + &quot;spec file: &quot; + command.getSpecFileFileName() + &quot; (&quot; + str(command.getSpecFileId()) + &quot;)\n&quot;
-        output = output + &quot;spec repo: &quot; + command.getSpecRepositoryName() + &quot; (&quot; + str(command.getSpecRepoId()) + &quot;)\n&quot;
-        output = output + &quot;defines: &quot; + command.getDefines() + &quot;\n&quot;
-        output = output + &quot;command name: &quot; + command.getCommandName() + &quot;\n&quot;
-        output = output + &quot;user id: &quot; + str(command.getUserId()) + &quot;\n&quot;
-        output = output + &quot;priority: &quot; + str(command.getPriority()) + &quot;\n&quot;
-        output = output + &quot;to email: &quot; + command.getToEmail() + &quot;\n&quot;
-        output = output + &quot;target id: &quot; + str(command.getTargetId()) + &quot;\n&quot;
+        output = output + brr.getContainsErrorsText() + &quot;\n&quot;
+        
+        output = output + command.toMultiLineString()
+        
         output = output + rpmspart + &quot;\n&quot;
         output = output + &quot;\nLog:\n&quot;
         output = output + brr.getLog()

Modified: trunk/tools/pydar2/scripts/rpmforgedriesrepo.py
===================================================================
--- trunk/tools/pydar2/scripts/rpmforgedriesrepo.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/scripts/rpmforgedriesrepo.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -21,7 +21,7 @@
 
 import os, re, string
 
-def RpmforgeAlterSpecFile(command, commanddir):
+def RpmforgeAlterSpecFile(command, commanddir, brr):
     print &quot;RpmforgeAlterSpecFile start&quot;
     # get the directory of the svn checkout
     fullpath = command.getSpecRepositorySpecFile().getFullPath()

Modified: trunk/tools/pydar2/scripts/rpmforgegetsources.py
===================================================================
--- trunk/tools/pydar2/scripts/rpmforgegetsources.py	2005-06-07 20:33:48 UTC (rev 3292)
+++ trunk/tools/pydar2/scripts/rpmforgegetsources.py	2005-06-08 18:52:13 UTC (rev 3293)
@@ -20,9 +20,16 @@
 # the rpmforge subversion contains the patches and sometimes some sources
 
 import os, commands, string, shutil, tempfile, posixpath
+import smtplib
+from email.MIMEText import MIMEText
+from email.MIMEMultipart import MIMEMultipart
+from email.MIMEBase import MIMEBase
+from email import Encoders
 
-def RpmforgeGetSources(command, commanddir):
+
+def RpmforgeGetSources(command, commanddir, brr):
     print &quot;RpmforgeGetSources start&quot;
+    brr.logDebugLine(&quot;getting the sources for command &quot; + str(command.getId()))
     # get the directory of the svn checkout
     fullpath = command.getSpecRepositorySpecFile().getFullPath()
     (dir,fname) = os.path.split(fullpath)
@@ -33,26 +40,32 @@
         # make sure its not a spec file &amp;&amp; regular file
         rindex = string.rfind(entry,'.spec')
         if os.path.isfile(os.path.join(dir,entry)) and not (rindex &gt; 0 and rindex == len(entry) - len('.spec')):
-            print &quot;lets copy: &quot; + entry
+            print &quot;lets copy (specrepo-&gt;commanddir): &quot; + entry
+            brr.logDebugLine(&quot;copying  (specrepo-&gt;commanddir)&quot; + entry)
             shutil.copy(os.path.join(dir,entry), commanddir)
         else:
-            print &quot;wont copy: &quot; + entry
+            print &quot;wont copy  (specrepo-&gt;commanddir): &quot; + entry
+            brr.logDebugLine(&quot;wont copy  (specrepo-&gt;commanddir): &quot; + str(entry))
     # now download the other files with spectool or get them from a cache
     # first check if there is already a cache directory
     cacheDir = &quot;/var/lib/pydar2/cachedsources/&quot; + str(command.getSpecRepoId()) + &quot;/&quot; + str(command.getSpecFileId())  + &quot;/&quot; + str(command.getVersion()) + &quot;/&quot;
     print &quot;cacheDir set to: &quot; + cacheDir
+    brr.logDebugLine(&quot;cacheDir: &quot;+ str(cacheDir))
     if posixpath.isdir(cacheDir):
         # the cacheDir exists, lets use it
         print &quot;cachedir ok&quot;
+        brr.logDebugLine(&quot;the cachedir exists&quot;)
     else:
         # the cacheDir does not exist, create it and fill it
         os.makedirs(cacheDir)
         print &quot;cacheDir created&quot;
+        brr.logDebugLine(&quot;the cachedir did not exist&quot;)
         defines = command.getDefines()
         spectoolcommand = &quot;spectool &quot; + defines + &quot; -gf &quot; + os.path.join(commanddir, fname)
         print &quot;spectoolcommand: &quot; + spectoolcommand
         (tempfd, tempfilepath)   = tempfile.mkstemp('pydar2')
         print 'tempfilepath: ' + tempfilepath
+        brr.logDebugLine(&quot;spectoolcommand: &quot; + str(spectoolcommand) + &quot; and tempfilepath: &quot;+ str(tempfilepath))
         os.write(tempfd, &quot;cd &quot; + cacheDir + &quot;\n&quot;)
         os.write(tempfd, spectoolcommand + &quot;\n&quot;)
         os.close(tempfd)
@@ -60,12 +73,15 @@
         (status,output) = commands.getstatusoutput(&quot;/bin/bash &quot; + tempfilepath)
         print &quot;status: &quot; + str(status)
         print &quot;output: &quot; + (output)
+        brr.logDebugLine(&quot;status: &quot; + str(status) + &quot;, output: &quot;+ str(output))
+        
     # now copy everything from the cache to the commanddir
     dirlist = os.listdir(cacheDir)
     for entry in dirlist:
         rindex = string.rfind(entry,'.spec')
     if os.path.isfile(os.path.join(cacheDir,entry)) and not (rindex &gt; 0 and rindex == len(entry) - len('.spec')):
-        print &quot;lets copy: &quot; + entry
+        print &quot;lets copy  (cachedir-&gt;commanddir): &quot; + entry
+        
         shutil.copy(os.path.join(cacheDir,entry), commanddir)
     else:
-        print &quot;wont copy: &quot; + entry
+        print &quot;wont copy  (cachedir-&gt;commanddir): &quot; + entry


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002094.html">[svn] r3292 - in trunk/tools/dconf: . config
</A></li>
	<LI>Next message: <A HREF="002096.html">[svn] r3294 - in trunk/rpms: perl-Apache-AuthCookie	perl-Apache-DBILogin perl-Apache-Htpasswd perl-Authen-SASL	perl-Business-ISBN perl-Business-ISBN-Data	perl-CGI-Application perl-CPANPLUS perl-CSS-Tiny	perl-Chemistry-File-MDLMol perl-Chemistry-Mol	perl-Class-Autouse perl-Class-Loader perl-Class-MethodMaker	perl-Class-ReturnValue perl-Clone perl-Compress-Bzip2	perl-Compress-LZF perl-Config-General perl-Config-Record	perl-Config-Tiny perl-Convert-IBM390 perl-Convert-PEM	perl-Crypt-CAST5_PP perl-Crypt-CBC perl-Crypt-OpenSSL-DSA	perl-Crypt-OpenSSL-RSA perl-DBD-CSV perl-DBD-File	perl-DBIx-Abstract perl-DateTime	perl-DateTime-Event-Recurrence perl-DateTime-Locale	perl-DateTime-Set perl-DateTime-TimeZone perl-Event	perl-ExtUtils-CBuilder perl-ExtUtils-ParseXS	perl-File-ReadBackwards perl-File-Slurp perl-Filter-Simple	perl-GD-Convert perl-Graph perl-Image-Imlib2 perl-Inline-TT	perl-Lingua-EN-NameParse perl-Lingua-Stem-Snowball	perl-List-MoreUtils perl-Locale-Maketext-Lexicon	perl-Log-Log4perl perl-MIME-Types perl-MKDoc-XML	perl-MP3-Info perl-Math-BigInt-GMP perl-Math-Fleximal	perl-Module-CoreList perl-Module-Depends perl-Module-Info	perl-Module-Starter perl-Net-DAV-Server perl-Net-DMAP-Server	perl-Net-DPAP-Client perl-Net-IMAP-Simple perl-Net-IP	perl-Net-Netmask perl-Net-SSH-Perl perl-PHP-Perlinfo perl-POE	perl-POE-Component-Server-HTTP perl-PPI perl-Params-Validate	perl-Parse-FixedLength perl-RPC-XML perl-SQL-Statement	perl-SVG-Metadata perl-SVN-Mirror perl-Sort-Versions	perl-Spiffy perl-Spoon perl-Spreadsheet-WriteExcel	perl-String-Approx perl-String-CRC32 perl-String-Ediff	perl-String-ShellQuote perl-Test-AutoBuild	perl-Test-Exception perl-Test-ISBN perl-Test-Manifest	perl-Text-Autoformat perl-Text-German perl-Text-vCard	perl-Text-vFile-asData perl-Unix-Processors	perl-WWW-Search-Ebay perl-X11-Protocol	perl-XML-Generator-vCard-RDF perl-XML-Writer perl-YAML
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2095">[ date ]</a>
              <a href="thread.html#2095">[ thread ]</a>
              <a href="subject.html#2095">[ subject ]</a>
              <a href="author.html#2095">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
