<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [SVN] r2190 - in trunk/web: . dweb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5BSVN%5D%20r2190%20-%20in%20trunk/web%3A%20.%20dweb&In-Reply-To=%3C20040914194611.DA24D17F74%40web22.us.megagiga.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000995.html">
   <LINK REL="Next"  HREF="000997.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[SVN] r2190 - in trunk/web: . dweb</H1>
    <B>svn-commits at rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5BSVN%5D%20r2190%20-%20in%20trunk/web%3A%20.%20dweb&In-Reply-To=%3C20040914194611.DA24D17F74%40web22.us.megagiga.com%3E"
       TITLE="[SVN] r2190 - in trunk/web: . dweb">svn-commits at rpmforge.net
       </A><BR>
    <I>Tue Sep 14 21:46:11 CEST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000995.html">[SVN] r2189 - trunk/web
</A></li>
        <LI>Next message: <A HREF="000997.html">[SVN] r2191 - in trunk/web: . user
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#996">[ date ]</a>
              <a href="thread.html#996">[ thread ]</a>
              <a href="subject.html#996">[ subject ]</a>
              <a href="author.html#996">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dag
Date: 2004-09-14 21:46:10 +0200 (Tue, 14 Sep 2004)
New Revision: 2190

Added:
   trunk/web/dweb/
   trunk/web/dweb/cfg_foot.inc.php
   trunk/web/dweb/cfg_head.inc.php
   trunk/web/dweb/dyndns.php
   trunk/web/dweb/mod_append.inc.php
   trunk/web/dweb/mod_buttons.inc.php
   trunk/web/dweb/mod_deny.inc.php
   trunk/web/dweb/mod_dir.inc.php
   trunk/web/dweb/mod_dns.inc.php
   trunk/web/dweb/mod_error.inc.php
   trunk/web/dweb/mod_https.inc.php
   trunk/web/dweb/mod_lang.inc.php
   trunk/web/dweb/mod_layout.inc.php
   trunk/web/dweb/mod_manpage.inc.php
   trunk/web/dweb/mod_menu.inc.php
   trunk/web/dweb/mod_news.inc.php
   trunk/web/dweb/mod_photo.inc.php
   trunk/web/dweb/mod_prepend.inc.php
   trunk/web/dweb/mod_protest.inc.php
   trunk/web/dweb/mod_quote.inc.php
   trunk/web/dweb/mod_sitemap.inc.php
   trunk/web/dweb/mod_useragent.inc.php
Log:
Add

Added: trunk/web/dweb/cfg_foot.inc.php
===================================================================
--- trunk/web/dweb/cfg_foot.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/cfg_foot.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,2 @@
+&lt;?_foot()?&gt;
+&lt;?include('mod_append.inc.php')?&gt;

Added: trunk/web/dweb/cfg_head.inc.php
===================================================================
--- trunk/web/dweb/cfg_head.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/cfg_head.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,8 @@
+&lt;?
+	include_once('mod_prepend.inc.php');
+
+	_head(_title_read(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[REQUEST_NAME]&quot;, $_SERVER['REQUEST_NAME']));
+
+	if (is_file(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[DIRNAME]/.readme&quot;))
+		include_once(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[DIRNAME]/.readme&quot;);
+?&gt;

Added: trunk/web/dweb/dyndns.php
===================================================================
--- trunk/web/dweb/dyndns.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/dyndns.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,32 @@
+&lt;?php
+	_head('DynDns');
+	
+	if (!empty($in['hostname']) and
+		!empty($in['myip'])) {
+
+		$list=explode('.', $in['hostname']);
+		$hostname=$list[0];
+		array_shift($list);
+		$domain=implode('.', $list);
+
+		echo &quot;&lt;pre&gt;&quot;;
+		exec(&quot;cat &lt;&lt;EOF | nsupdate -d -k \&quot;/var/named/keys/Kkey-dag.+157+53983.key\&quot; 2&gt;&amp;1
+server localhost
+zone $domain
+update delete $hostname
+update add $hostname 60 A $in[myip]
+send
+EOF
+&quot;, $array, $ret);
+		echo &quot;&lt;/pre&gt;&quot;;
+		if ($ret==0)
+			echo &quot;Updated successfully !&quot;;
+		else	
+			echo &quot;Something failed ;(&lt;br&gt;&lt;pre&gt;&quot;;
+			foreach ($array as $line) echo &quot;$line&lt;br&gt;&quot;;
+			echo &quot;&lt;/pre&gt;&quot;;
+	} else {
+		echo &quot;Not all information was provided. Sorry&quot;;
+	}
+	_foot();
+?&gt;

Added: trunk/web/dweb/mod_append.inc.php
===================================================================
--- trunk/web/dweb/mod_append.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_append.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,16 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/
+	global $cfg;
+
+	if (!empty($cfg['error_body'])) {
+		mail($_SERVER['SERVER_ADMIN'], $cfg['error_subject'], $cfg['error_body'], &quot;From: Dweb Error $in[error] &lt;root&gt;\nX-Mailer: Dag PHP Script\n&quot;);
+	}
+	exit;
+?&gt;

Added: trunk/web/dweb/mod_buttons.inc.php
===================================================================
--- trunk/web/dweb/mod_buttons.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_buttons.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,122 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+
+  global $BFONT, $BFONTSIZE, $BXOFFSET, $BYOFFSET, $BVERSION, $BWIMAGE, $BHIMAGE, $BBORDER;
+  $BFONT=&quot;$DOCUMENT_ROOT/fonts/harquil.ttf&quot;;
+  $BFONTSIZE=17;
+  $BXOFFSET=4;
+  $BYOFFSET=3;
+  $BVERSION=4;
+
+  $BWIMAGE=130;
+  $BHIMAGE=20;
+  $BORDER=1;
+
+  /* button-creation function */
+  function _createButton($string,$method) {
+   global $DOCUMENT_ROOT, $BWIMAGE, $BHIMAGE;
+   global $BFONT, $BXOFFSET, $BYOFFSET, $BFONTSIZE, $BVERSION;
+   $b=0;
+   $string=strtolower($string);
+   $name=_createName($string);
+
+   if ($name!='' &amp;&amp;
+       !is_file(&quot;$DOCUMENT_ROOT/buttons/$name-$method-$BVERSION.png&quot;)) {
+    $im=ImageCreate($BWIMAGE,$BHIMAGE); 
+
+    $a=ImageTTFBBox($BFONTSIZE,0,$BFONT,$string);
+    if ($a[4]-$a[6]-1+$BXOFFSET*2&gt;$BWIMAGE) {
+     $pos=strrpos($string,' ');
+     $string2=substr($string,$pos);
+     $string=substr($string,0,$pos);
+     $im=ImageCreate($BWIMAGE,round($BHIMAGE*1.8)); 
+     $b=ImageTTFBBox($BFONTSIZE,0,$BFONT,$string2);
+    }
+    
+    $tpc=$bgc=ImageColorAllocate($im,255,255,255); 
+    $fgc=ImageColorAllocate($im,127,127,147);
+    switch ($method) {
+     case &quot;on&quot;: 
+      $fgc=ImageColorAllocate($im,192,192,240); break;
+      break;
+     case &quot;in&quot;:
+      $bgc=ImageColorAllocate($im,192,192,240);
+      $fgc=ImageColorAllocate($im,255,255,255); break;
+     case &quot;off&quot;: 
+      $fgc=ImageColorAllocate($im,192,192,192); break;
+    }
+    ImageFill($im,0,0,$bgc);
+    switch ($method) {
+     case &quot;on&quot;: case &quot;in&quot;: 
+      ImageTTFText($im,$BFONTSIZE*1.25,5,$BXOFFSET,$BFONTSIZE+2,$fgc,$BFONT,$string);
+      if (is_array($b)) 
+       ImageTTFText($im,$BFONTSIZE*1.25,5,($BWIMAGE-($b[4]-$b[6]+$BXOFFSET+1))*2,($BFONTSIZE+10)*2,$fgc,$BFONT,$string2);
+      break;
+     default: 
+      ImageTTFText($im,$BFONTSIZE,0,$BXOFFSET,$BFONTSIZE-$BYOFFSET,$fgc,$BFONT,$string);
+      if (is_array($b)) 
+       ImageTTFText($im,$BFONTSIZE,0,$BWIMAGE-($b[4]-$b[6]+$BXOFFSET+1),$BFONTSIZE*1.8,$fgc,$BFONT,$string2);
+    }
+    ImageColorTransparent($im,$tpc);
+    ImagePng($im,&quot;$DOCUMENT_ROOT/buttons/$name-$method-$BVERSION.png&quot;); 
+    ImageDestroy($im); 
+   }
+   if ($name!='')
+    echo $name.&quot;_$method = new Image(); $name&quot;.&quot;_$method.src = \&quot;/buttons/$name-$method-$BVERSION.png\&quot;;\n&quot;;
+  }
+
+  /* html button function */
+  function _addButton($string,$method,$page) {
+   global $BWIMAGE, $BHIMAGE, $DOCUMENT_ROOT, $BBORDER;
+   global $BFONT, $BXOFFSET, $BYOFFSET, $BFONTSIZE, $BVERSION;
+   $string2=strtolower($string);
+   $name=_createName($string2);
+//   echo &quot;&lt;tr&gt;&lt;td id=\&quot;menu\&quot; align=\&quot;left\&quot;&gt;&quot;;
+   echo '&lt;tr&gt;&lt;td align=&quot;left&quot; style=&quot;border-right: 1px solid black&quot;&gt;';
+   if ($name!='') {
+    echo &quot;&lt;acronym title=\&quot;$string\&quot;&gt;&quot;;
+/* GEBRUIK DEZE CODE ALS TTF BESTAAT */
+    $HEIGHT=$BHIMAGE;
+    $a=ImageTTFBBox($BFONTSIZE,0,$BFONT,$string2);
+    if ($a[4]-$a[6]-1+$BXOFFSET*2&gt;$BWIMAGE) $HEIGHT=round($BHIMAGE*1.8);
+/* VERWIJDER DEZE CODE */
+//  $im=ImageCreateFromGif(&quot;$DOCUMENT_ROOT/buttons/$name-$method.png&quot;); 
+//  $HEIGHT=ImageSY($im); 
+    switch ($method) {
+     case 'in':
+      echo &quot;&lt;img src=\&quot;/buttons/$name-$method-$BVERSION.png\&quot; width=\&quot;$BWIMAGE\&quot; height=\&quot;$HEIGHT\&quot; border=\&quot;0\&quot; alt=\&quot;-&amp;gt; $string\&quot; hspace=\&quot;0\&quot; vspace=\&quot;0\&quot; align=\&quot;left\&quot;&gt;&quot;;
+      break;
+     case 'off':
+      echo &quot;&lt;img src=\&quot;/buttons/$name-$method-$BVERSION.png\&quot; width=\&quot;$BWIMAGE\&quot; height=\&quot;$HEIGHT\&quot; border=\&quot;0\&quot; alt=\&quot;[$string]\&quot; hspace=\&quot;0\&quot; vspace=\&quot;0\&quot; align=\&quot;left\&quot;&gt;&quot;;
+      break;
+     case 'on':
+      echo &quot;&lt;a href=\&quot;$page\&quot;&gt;&lt;img src=\&quot;/buttons/$name-$method-$BVERSION.png\&quot; width=\&quot;$BWIMAGE\&quot; height=\&quot;$HEIGHT\&quot; border=\&quot;0\&quot; alt=\&quot;$string\&quot; name=\&quot;$name\&quot; hspace=\&quot;0\&quot; vspace=\&quot;0\&quot; align=\&quot;left\&quot;&gt;&lt;/a&gt;&quot;;
+      break;
+     default:
+      echo &quot;&lt;a href=\&quot;$page\&quot; onMouseOver=\&quot;chg('$name','_on');\&quot; onMouseOut=\&quot;chg('$name','_');\&quot;&gt;&lt;img src=\&quot;/buttons/$name-$method-$BVERSION.png\&quot; width=\&quot;$BWIMAGE\&quot; height=\&quot;$HEIGHT\&quot; border=\&quot;0\&quot; alt=\&quot;$string\&quot; name=\&quot;$name\&quot; hspace=\&quot;0\&quot; vspace=\&quot;0\&quot; align=\&quot;left\&quot;&gt;&lt;/a&gt;&quot;;
+    }
+    echo '&lt;/acronym&gt;';
+   } else {
+    if ($page=='down-left') 
+      echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=\&quot;border-top: 1px solid black; border-right: 1px solid black;\&quot;&gt;&quot;;
+    else if (is_file(&quot;$DOCUMENT_ROOT/images/$page.png&quot;)) {
+     $im=ImageCreatefrompng(&quot;$DOCUMENT_ROOT/images/$page.png&quot;);
+     echo &quot;&lt;img src=\&quot;/images/$page.png\&quot; width=\&quot;$BWIMAGE\&quot; height=\&quot;&quot;.ImageSY($im).&quot;\&quot; border=\&quot;0\&quot; alt=\&quot;&amp;nbsp;\&quot; hspace=\&quot;0\&quot; vspace=\&quot;0\&quot; align=\&quot;left\&quot;&gt;\n&quot;;
+     ImageDestroy($im); 
+    } else {
+     spc($BWIMAGE,round($BHIMAGE/3),&quot;--------&quot;);
+    }
+   }
+   echo &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;
+  }
+/* End of shared stuff. */
+
+/* Move modified functions below and change them. */
+?&gt;

Added: trunk/web/dweb/mod_deny.inc.php
===================================================================
--- trunk/web/dweb/mod_deny.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_deny.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,71 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+/*
+	Description: Deny requests based on several characteristics.
+
+		deny_error_page		Page to load if denied
+		deny_redirect		URL to redirect to if denied
+		deny_referer		Deny based on referer
+		deny_request		Deny based on request method
+		deny_user_agent		Deny based on user agent
+*/
+	global $cfg, $in;
+
+	/* Default configuration variables */
+//	_cfg_default('deny_referer',	'google');
+//	_cfg_default('deny_user_agent',	Array('webcopier', 'spider'));
+	_cfg_default('deny_error_page',	'/index.php');
+
+	function _deny() {
+		global $cfg;
+
+		if (!empty($cfg['deny_redirect'])) {
+			header('HTTP/1.0 302 ');
+			header(&quot;Location: $cfg[deny_redirect]&quot;);
+		} else {
+			header('HTTP/1.0 403 ');
+			include(&quot;$_SERVER[DOCUMENT_ROOT]$cfg[path]/$cfg[deny_error_page]&quot;);
+		}
+		exit;
+	}
+
+	/* Business logic */
+	if (!empty($cfg['deny_referer']) and
+		array_key_exists('HTTP_REFERER',$_SERVER)) {
+		foreach ($cfg['deny_referer'] as $referer) {
+			if (eregi($referer, $_SERVER['HTTP_REFERER']))
+				_deny();
+		}
+	}
+
+	if (!empty($cfg['deny_user_agent']) and
+		array_key_exists('HTTP_USER_AGENT',$_SERVER)) {
+		foreach ($cfg['deny_user_agent'] as $user_agent) {
+			if (eregi($user_agent, $_SERVER['HTTP_USER_AGENT']))
+				_deny();
+		}
+	}
+
+	if (!empty($cfg['deny_request']) and
+		array_key_exists('REQUEST_METHOD',$_SERVER)) {
+		foreach ($cfg['deny_request'] as $request) {
+			if (eregi($request, $_SERVER['REQUEST_METHOD']))
+				_deny();
+		}
+	}
+
+	if (!empty($cfg['deny_remote_addr']) and
+		array_key_exists('REMOTE_ADDR',$_SERVER)) {
+		foreach ($cfg['deny_remote_addr'] as $remote_addr) {
+			if (eregi($remote_addr, $_SERVER['REMOTE_ADDR']))
+				_deny();
+		}
+	}
+?&gt;

Added: trunk/web/dweb/mod_dir.inc.php
===================================================================
--- trunk/web/dweb/mod_dir.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_dir.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,131 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/
+/*
+	Description: Creates a directory-structured path (mod_structure ?)
+	Description: Creates a directory-structured menu
+
+*/
+
+
+//	_cfg_default('sitemap_ext_include',	'.(php|pdf|rtf|rpm|html|gz|bz2)$');
+	_cfg_default('sitemap_ext_include',	'.*$');
+	_cfg_default('sitemap_ext_exclude',	'.(inc|inc.php)$');
+	_cfg_default('sitemap_file_exclude',	'^((index.php|index.html|submit.php|photo.php|mail.php|error.php)$|\.)');
+	_cfg_default('sitemap_dir_exclude',	'^\.');
+	_cfg_default('sitemap_title_exclude',	'\$|draft|hidden|old');
+//	_cfg_default('sitemap_depth',		0);
+	_cfg_default('sitemap_hiddenfile',	'.hidden');
+//	_cfg_default('desc_indexfile',		'.index');
+	_cfg_default('dir_date_format',		'D d M Y');
+
+function _dirindex_dir() {
+	global $cfg, $in;
+	$dir=_rtrim(rawurldecode($_SERVER['REQUEST_NAME']), '/');
+	$d=dir(&quot;$_SERVER[DOCUMENT_ROOT]$dir&quot;);
+	$dirs=$files=array();
+	echo '&lt;table id=&quot;dir&quot; width=&quot;100%&quot;&gt;';
+//	echo '&lt;col id=&quot;n&quot;&gt;&lt;col id=&quot;m&quot;&gt;&lt;col id=&quot;s&quot;&gt;&lt;col id=&quot;d&quot;&gt;';
+	echo '&lt;tr&gt;&lt;th id=&quot;n&quot;&gt;&lt;a href=&quot;?N=A&quot;&gt;Name&lt;/a&gt;';
+	echo '&lt;th id=&quot;m&quot;&gt;&lt;a href=&quot;?M=D&quot;&gt;Last Modified&lt;/a&gt;';
+	echo '&lt;th id=&quot;s&quot;&gt;&lt;a href=&quot;?S=D&quot;&gt;Size&lt;/a&gt;';
+	echo '&lt;th id=&quot;d&quot;&gt;&lt;a href=&quot;?D=A&quot;&gt;Description&lt;/a&gt;';
+	echo '&lt;tr&gt;&lt;td id=&quot;n&quot;&gt;';
+	_link('..', 'Parent Directory', 'sub');
+	echo '&lt;td id=&quot;m&quot;&gt;-&lt;td id=&quot;s&quot;&gt;-&lt;td id=&quot;d&quot;&gt;-';
+	while($entry=$d-&gt;read()) {
+		$file=&quot;$_SERVER[DOCUMENT_ROOT]$dir/$entry&quot;;
+		if (is_readable($file)) {
+			if (is_file($file) and
+				ereg($cfg['sitemap_ext_include'], $entry) and
+				!ereg($cfg['sitemap_ext_exclude'], $entry) and
+				!ereg($cfg['sitemap_file_exclude'], $entry)) {
+				$files[]=$entry;
+			} elseif (is_dir($file) and
+				!ereg('\.+$', $entry) and
+				!ereg($cfg['sitemap_file_exclude'], $entry) and
+				!ereg($cfg['sitemap_dir_exclude'], $entry) and
+				!@is_file(&quot;$file/$cfg[sitemap_hiddenfile]&quot;) and
+				(!ereg('^intern$', $entry) or
+				(_isPrivate()))) {
+				$dirs[]=$entry;
+			}
+		}
+	}
+	$d-&gt;close();
+
+	$ddates = $ddescs = array();
+	$fdates = $fdescs = $fsizes = array();
+
+	$cdir=&quot;$_SERVER[DOCUMENT_ROOT]$dir&quot;;
+
+	$dc = count($dirs);
+	for ($i=0; $i&lt;$dc; $i++) {
+		$ddates[] = filemtime(&quot;$cdir/$dirs[$i]&quot;);
+		if (ereg('^_buildlogs$', $dirs[$i]))	$ddescs[]='Build logs';
+//		else					$ddescs[]='Directory';
+		else					$ddescs[]='-';
+	}
+
+	$fc = count($files);
+	for ($i=0; $i&lt;$fc; $i++) {
+		$fsizes[] = filesize(&quot;$cdir/$files[$i]&quot;);
+		$fdates[] = filemtime(&quot;$cdir/$files[$i]&quot;);
+
+		$arch='(athlon|i.86|noarch|x86_64)';
+		$ext='(rpm|log\.(gz|bz2))';
+
+		if (ereg(&quot;\.rh6\..*$arch\.$ext$&quot;, $files[$i], $a))		$fdescs[]=&quot;Red Hat 6.X - $a[1]&quot;;
+		elseif (ereg(&quot;\.rh62\..*$arch\.$ext$&quot;, $files[$i], $a))		$fdescs[]=&quot;Red Hat 6.2 - $a[1]&quot;;
+		elseif (ereg(&quot;\.rh7\..*$arch\.$ext$&quot;, $files[$i], $a))		$fdescs[]=&quot;Red Hat 7.X - $a[1]&quot;;
+		elseif (ereg(&quot;\.rh73\..*$arch\.$ext$&quot;, $files[$i], $a))		$fdescs[]=&quot;Red Hat 7.3 - $a[1]&quot;;
+		elseif (ereg(&quot;\.rh8.?\..*$arch\.$ext$&quot;, $files[$i], $a))	$fdescs[]=&quot;Red Hat 8.0 - $a[1]&quot;;
+		elseif (ereg(&quot;\.rh9.?\..*$arch\.$ext$&quot;, $files[$i], $a))	$fdescs[]=&quot;Red Hat 9 - $a[1]&quot;;
+		elseif (ereg(&quot;\..*el2.*\..*$arch\.$ext$&quot;, $files[$i], $a))	$fdescs[]=&quot;Red Hat EL 2.1 - $a[1]&quot;;
+		elseif (ereg(&quot;\..*el3\..*$arch\.$ext$&quot;, $files[$i], $a))	$fdescs[]=&quot;Red Hat EL 3 - $a[1]&quot;;
+		elseif (ereg(&quot;\..*fc1\..*$arch\.$ext$&quot;, $files[$i], $a))	$fdescs[]=&quot;Fedora Core 1 - $a[1]&quot;;
+		elseif (ereg(&quot;\..*fc2\..*$arch\.$ext$&quot;, $files[$i], $a))	$fdescs[]=&quot;Fedora Core 2 - $a[1]&quot;;
+		elseif (ereg(&quot;\..*\.0\..*$arch\.$ext$&quot;, $files[$i], $a))	$fdescs[]=&quot;All distributions - $a[1]&quot;;
+		elseif (ereg('\.src\.rpm$', $files[$i]))			$fdescs[]='Source package';
+//		elseif (eregi('\.ogg$', $files[$i]))				$fdescs[]='Ogg Vorbis music file';
+		elseif (eregi('\.doc$', $files[$i]))				$fdescs[]='Word document';
+		elseif (eregi('\.([a-z]{1,5})$', $files[$i], $a))		$fdescs[]=strtoupper($a[1]).' file';
+		else								$fdescs[]='-';
+	}
+
+	if (!empty($in['M']) and $in['M'] == 'D') {
+		array_multisort($ddates, SORT_NUMERIC, SORT_DESC, $dirs, $ddescs);
+		array_multisort($fdates, SORT_NUMERIC, SORT_DESC, $files, $fsizes, $fdescs);
+	} elseif (!empty($in['S']) and $in['S'] == 'D') {
+		array_multisort($dirs, SORT_STRING, SORT_DESC, $ddates, $ddescs);
+		array_multisort($fsizes, SORT_NUMERIC, SORT_DESC, $files, $fdates, $fdescs);
+	} elseif (!empty($in['D']) and $in['D'] == 'A') {
+		array_multisort($ddescs, SORT_STRING, SORT_ASC, $dirs, $ddates);
+		array_multisort($fdescs, SORT_STRING, SORT_ASC, $files, $fdates, $fsizes);
+	} else {
+		array_multisort($dirs, SORT_STRING, SORT_ASC, $ddates, $ddescs);
+		array_multisort($files, SORT_STRING, SORT_ASC, $fdates, $fsizes, $fdescs);
+	}	
+
+	for ($i=0; $i&lt;$dc; $i++) {
+		echo '&lt;tr&gt;&lt;td id=&quot;n&quot;&gt;';
+		_link(&quot;$dirs[$i]/&quot;, &quot;$dirs[$i]/&quot;, 'sub'); 
+		echo '&lt;td id=&quot;m&quot;&gt;'.date($cfg['dir_date_format'], $ddates[$i]).'&lt;td id=&quot;s&quot;&gt;-&lt;td id=&quot;d&quot;&gt;'.&quot;$ddescs[$i]\n&quot;;
+	}
+
+	for ($i=0; $i&lt;$fc; $i++) {
+		echo '&lt;tr&gt;&lt;td id=&quot;n&quot;&gt;';
+		_link($files[$i]); 
+		echo '&lt;td id=&quot;m&quot;&gt;'.date($cfg['dir_date_format'], $fdates[$i]).'&lt;td id=&quot;s&quot;&gt;'.round($fsizes[$i]/1024).' kB&lt;td id=&quot;d&quot;&gt;'.&quot;$fdescs[$i]\n&quot;;
+	}
+
+	echo '&lt;tr&gt;&lt;th&gt;&lt;th&gt;&lt;th&gt;&lt;th&gt;';
+	echo '&lt;/table&gt;';
+}
+?&gt;

Added: trunk/web/dweb/mod_dns.inc.php
===================================================================
--- trunk/web/dweb/mod_dns.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_dns.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,89 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/
+
+	function _validate_ns($ip) {
+		global $NS_LIST;
+		reset($NS_LIST);
+		while(list($nr,$a)=each($NS_LIST))
+			if ($ip==$a) return true;
+		return false;
+	}
+
+	function _count_ns($nsiplist) {
+		$i=0;
+		while (list($nr,$ip)=each($nsiplist))
+			if (_validate_ns($ip)) $i++;
+		return $i;
+	}
+
+	function _validate_mx($ip) {
+		global $MX_LIST;
+		reset($MX_LIST);
+		while(list($nr,$a)=each($MX_LIST))
+			if ($ip==$a) return true;
+		return false;
+	}
+
+	function _count_mx($mxiplist,$mxweight) {
+		$i=0;
+		$min=min($mxweight);
+		while (list($nr,$ip)=each($mxiplist))
+			if (_validate_mx($ip) &amp;&amp; ($mxweight[$nr]&gt;$min)) $i++;
+		return $i;
+	}
+
+	function _getdnsrr($domain,$type,$nsserver,&amp;$rrlist) {
+		$rrlist=Array();
+		$ret=false;
+		exec(&quot;host -t $type $domain $nsserver&quot;,$array,$ret);
+		if ($ret==0 &amp;&amp; !eregi(&quot;not found&quot;,$array[0])) {
+			while (list($nr,$a)=each($array)) {
+				if (preg_match(&quot;/^$domain\s+/i&quot;,$a)) {
+					$tmp=split(&quot; &quot;,$a);
+					$c=count($tmp)-1;
+					$rrlist[]=_rtrim($tmp[$c],&quot;.&quot;);
+					$ret=true;
+				}
+			}
+		}
+		return $ret;
+	}
+
+	function _getauthns($domain) {
+		if (_getdnsrr($domain,&quot;NS&quot;,&quot;&quot;,$nslist)) {
+			return $nslist[0];
+		}
+		return &quot;&quot;;
+	}
+
+	function _getdnsrr_root($domain,$type,&amp;$rrlist) {
+		$tmp=split(&quot;\.&quot;,$domain);
+		$c=count($tmp)-1;
+		$tld=$tmp[$c];
+		_getdnsrr($tld,&quot;NS&quot;,&quot;&quot;,$array);
+		_getdnsrr($domain,$type,$array[0],$rrlist);
+	}
+
+	function _resolve(&amp;$output) {
+		$num_args=func_num_args();
+		if ($num_args&gt;1) $input=func_get_arg(1);
+		if (!$input) $input=$output;
+		if (is_array($input)) {
+			$output=Array();
+			while (list($nr,$a)=each($input))
+				$output[$nr]=gethostbyname($a);
+			return true;
+		} else if (is_string($input)) {
+			$output=gethostbyname($input);
+			return true;
+		}
+		return false;
+	}
+?&gt;

Added: trunk/web/dweb/mod_error.inc.php
===================================================================
--- trunk/web/dweb/mod_error.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_error.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,73 @@
+&lt;?
+	global $errors, $messages;
+	_mod_load('mod_layout');
+	_mod_load('mod_menu');
+
+	// Default settings
+	_cfg_default('error_mail_remotereferer',	false);
+	_cfg_default('error_mail_localreferer',		true);
+	_cfg_default('error_mailaddress',		$_SERVER['SERVER_ADMIN']);
+
+	$errors=array(
+		'400' =&gt; 'Bad Request',
+		'401' =&gt; 'Authorization Required',
+		'402' =&gt; 'Payment Required',
+		'403' =&gt; 'Forbidden',
+		'404' =&gt; 'Not Found',
+		'405' =&gt; 'Method Not Allowed',
+		'406' =&gt; 'Not Acceptable',
+		'407' =&gt; 'Proxy Authentication Required',
+		'408' =&gt; 'Request Time-out',
+		'409' =&gt; 'Conflict',
+		'410' =&gt; 'Gone',
+		'411' =&gt; 'Length Required',
+		'412' =&gt; 'Precondition Failed',
+		'413' =&gt; 'Request Entity Too Large',
+		'414' =&gt; 'Request-URI Too Large',
+		'415' =&gt; 'Unsupported Media Type',
+		'416' =&gt; 'Requested Range Not Satisfiable',
+		'500' =&gt; 'Internal Server Error',
+		'501' =&gt; 'Not Implemented',
+		'502' =&gt; 'Bad Gateway',
+		'503' =&gt; 'Service Unavailable',
+		'504' =&gt; 'Gateway Time-out',
+		'505' =&gt; 'HTTP Version not supported',
+		'' =&gt; 'Hey you, don\'t do that ;)'
+	);
+
+	$messages=array(
+		'400' =&gt; 'Your browser (or proxy) sent a request that this server could not understand.',
+		'401' =&gt; 'This server could not verify that you are authorized to access the document requested. Either you supplied the wrong credentials (e.g., bad password), or your browser doesn\'t understand how to supply the credentials required.',
+		'403' =&gt; 'You don\'t have permission to access that URL on this server.',
+		'404' =&gt; &quot;The requested URL (<A HREF="http://$_SERVER[SERVER_NAME">http://$_SERVER[SERVER_NAME</A>]$_SERVER[REQUEST_NAME]) was not found on this server.&quot;,
+		'405' =&gt; &quot;The $_SERVER[REDIRECT_REQUEST_METHOD] method is not allowed for the requested URL.&quot;,
+		'406' =&gt; &quot;An appropriate representation of the requested resource could not be found on this server.&quot;,
+		'500' =&gt; &quot;The server encountered an internal error or misconfiguration and was unable to complete your request.&lt;p&gt;Please contact the server administrator, $_SERVER[SERVER_ADMIN], and inform him of the time the error occurred, and anything you might have done that may have caused the error.&quot;,
+	 	'' =&gt; 'We don\'t like people doing things they shouldn\'t do. Traceback has been mailed to our lawyers. Expect a phone-call from them soon ;)'
+	);
+
+	function _error_mail() {
+		global $cfg, $errors;
+		if(!$cfg['error_mail_remotereferer']) return;
+?&gt;&lt;p&gt;
+	At this very moment a mail has been sent to our webmaster to correct the error.
+	Please come back soon when we have verified the problem. Thank you for your patience!
+&lt;/p&gt;&lt;?
+
+		$subject=&quot;[DWEB] ERROR $_SERVER[REDIRECT_STATUS]: &quot;.$errors[$_SERVER['REDIRECT_STATUS']].&quot; (<A HREF="http://$_SERVER[SERVER_NAME">http://$_SERVER[SERVER_NAME</A>]$_SERVER[REQUEST_URI])&quot;;
+		$body=&quot;---\n&quot;.
+			&quot;Error: $_SERVER[REDIRECT_STATUS] &quot;.$errors[$_SERVER['REDIRECT_STATUS']].&quot;\n&quot;.
+			&quot;Referrer: $_SERVER[HTTP_REFERER]\n&quot;.
+			&quot;Bad Link: <A HREF="http://$_SERVER[SERVER_NAME">http://$_SERVER[SERVER_NAME</A>]$_SERVER[REQUEST_URI]\n&quot;.
+			&quot;IP Address: $_SERVER[REMOTE_ADDR]&quot;.
+			(isset($_SERVER['REMOTE_HOST'])?&quot; ($_SERVER[REMOTE_HOST])\n&quot;:&quot;\n&quot;).
+			(isset($_SERVER['HTTP_USER_AGENT'])?&quot;User Agent: $_SERVER[HTTP_USER_AGENT]\n&quot;:'').
+			(isset($_SERVER['HTTP_X_FORWARDED_FOR'])?&quot;Internal IP: $_SERVER[HTTP_X_FORWARDED_FOR]\n&quot;:'').
+			(isset($_SERVER['HTTP_VIA'])?&quot;Via: $_SERVER[HTTP_VIA]\n&quot;:'').
+			&quot;---\n\n&quot;;
+		$ret=mail($cfg['error_mailaddress'], $subject, $body, &quot;From: Dweb Error $_SERVER[REDIRECT_STATUS] &lt;root&gt;\nX-Mailer: Dag PHP Script\n&quot;);
+		if (!$ret)
+			echo 'Sending mail failed utterly.';
+		return $ret;
+	}
+?&gt;

Added: trunk/web/dweb/mod_https.inc.php
===================================================================
--- trunk/web/dweb/mod_https.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_https.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,26 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+
+/*
+	Description: Automatically redirect to https for certain directories.
+ 
+		https_paths		List of paths for which to redirect (default: empty)
+*/
+
+	if ($_SERVER['HTTPS']=='on')
+		return 0;
+
+	if (!empty($cfg['https_paths']) and ereg($cfg['https_paths'], $_SERVER['REQUEST_NAME'])) {
+		/* It seems you have to send your own HTTP-status when Apache overrides Location: */
+		header(&quot;HTTP/1.0 302 &quot;);
+		header(&quot;Location: <A HREF="https://$_SERVER[SERVER_NAME">https://$_SERVER[SERVER_NAME</A>]$_SERVER[REQUEST_NAME]&quot;);
+		exit;
+	}
+?&gt;

Added: trunk/web/dweb/mod_lang.inc.php
===================================================================
--- trunk/web/dweb/mod_lang.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_lang.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,20 @@
+&lt;?php
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+
+	/* get real doc-root */
+/*
+	if (ereg(&quot;^/nl/&quot;,$_SERVER['REQUEST_NAME'])) 
+		$cfg['path']=&quot;/nl/&quot;;
+	elseif (ereg(&quot;^/fr/&quot;,$_SERVER['REQUEST_NAME'])) 
+		$cfg['path']=&quot;/fr/&quot;;
+	elseif (ereg(&quot;^/de/&quot;,$_SERVER['REQUEST_NAME'])) 
+		$cfg['path']=&quot;/de/&quot;;
+*/
+?&gt;

Added: trunk/web/dweb/mod_layout.inc.php
===================================================================
--- trunk/web/dweb/mod_layout.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_layout.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,76 @@
+&lt;?
+/*
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/
+	_mod_search('cfg_layout');
+
+function _link(/* link,name,class */) {
+	global $desc;
+	$numargs=func_num_args();
+	$link=func_get_arg(0);
+	$des='';
+	_desc_read($link);
+	if (!empty($desc[$link]))
+			$des=&quot; title=\&quot;$desc[$link]\&quot;&quot;;
+	if ($numargs==1)
+		echo &quot;&lt;a href=\&quot;$link\&quot;$des&gt;$link&lt;/a&gt;&quot;;
+	elseif ($numargs==2)
+		echo &quot;&lt;a href=\&quot;$link\&quot;$des&gt;&quot;.func_get_arg(1).&quot;&lt;/a&gt;&quot;;
+	else
+		echo &quot;&lt;a href=\&quot;$link\&quot;$des class=\&quot;&quot;.func_get_arg(2).&quot;\&quot;&gt;&quot;.func_get_arg(1).&quot;&lt;/a&gt;&quot;;
+}
+
+function _title($title) {
+	echo &quot;&lt;div class=\&quot;title\&quot;&gt;&lt;a name=\&quot;&quot;._createName($title).&quot;\&quot;&gt;$title&lt;/a&gt;&lt;/div&gt;\n&quot;;
+}
+
+function _header() {
+	global $cfg;
+	header('Cache-Control: no-cache; must-revalidate');
+	header(&quot;Content-Type: text/html; charset=$cfg[charset]&quot;);
+//	header(&quot;Expires: &quot;.date(&quot;D, d M Y H:i:s&quot;,time()).&quot; GMT&quot;);
+	header('Expires: 0');
+	if(file_exists(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[REQUEST_NAME]&quot;))
+		header('Last-Modified: '.gmdate('D, d M Y H:i:s', filemtime(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[REQUEST_NAME]&quot;)).' GMT');
+	header('Pragma: no-cache, no-store');
+}
+
+/* Generate Meta-headers */
+function _meta_generate($pagetitle) {
+	global $meta, $cfg, $title;
+
+    if (empty($meta['title']))
+		$meta['title']=$pagetitle;
+
+    if ($meta['description']=='')
+		$meta['description']=$pagetitle;
+
+    end($title);
+	while(prev($title))
+		$meta['keywords'].=current($title).', ';
+
+    if (!empty($cfg['keywords']))
+		$meta['keywords'].=$cfg['keywords'];
+
+    $meta['keywords']=$meta['title'].', '.$meta['keywords'];
+
+	//  $meta['date']=date('D, d M Y H:i:s').' GMT';
+}
+
+/* Place Meta-headers */
+function _meta() {
+	global $meta;
+
+	echo &quot;\n&quot;;
+//	echo &quot;&lt;!-- meta start --&gt;\n&quot;;
+	reset($meta);   
+	while (list($name,$content)=each($meta))
+		echo '&lt;meta name=&quot;'.ucfirst($name).&quot;\&quot; content=\&quot;$content\&quot;&gt;\n&quot;;
+//	echo &quot;&lt;!-- meta end --&gt;\n&quot;;
+}
+?&gt;

Added: trunk/web/dweb/mod_manpage.inc.php
===================================================================
--- trunk/web/dweb/mod_manpage.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_manpage.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,12 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/
+
+	$MANPAGE='<A HREF="http://www.rivertown.net/cgi-bin/man-cgi?">http://www.rivertown.net/cgi-bin/man-cgi?</A>';
+?&gt;

Added: trunk/web/dweb/mod_menu.inc.php
===================================================================
--- trunk/web/dweb/mod_menu.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_menu.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,169 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+/*
+	Description: Creates a directory-structured path (mod_structure ?)
+	Description: Creates a directory-structured menu
+
+		structure_delimiter
+
+		menu_updated_format
+		menu_delimiter
+		menu_end_delimiter
+		menu_expand_all
+
+		sitemap_dir_exclude
+*/
+
+	/* Default configuration variables */
+	_cfg_default('structure_delimiter',	'&amp;nbsp;&amp;gt;&amp;nbsp;');
+
+	_cfg_default('menu_updated_format',	'D d F Y H:i T');
+	_cfg_default('menu_expand_all',		false);
+	_cfg_default('menu_delimiter',		'&amp;middot;&amp;nbsp;');
+	_cfg_default('menu_end_delimiter',	'&amp;middot;&amp;nbsp;');
+	_cfg_default('menu_file',		'.menu');
+	_cfg_default('sitemap_dir_exclude',	'^$');
+
+	/* Reading titles */
+	_setRelDirname();
+	$temp=explode('/',$_SERVER['RELDIRNAME']);
+	$p='';
+	$fp=$cfg['path'];
+	for($i=0; $i&lt;count($temp); $i++) {
+//		echo &quot;TEST: $_SERVER[RELDIRNAME] | $temp[$i] | $p | $fp&lt;br&gt;\n&quot;;
+		if ($temp[$i]!='') {
+			$p.=$temp[$i].'/';
+			$fp=&quot;$cfg[path]$p&quot;;
+		}
+		_title_set(&quot;$_SERVER[DOCUMENT_ROOT]$fp&quot;, $fp);
+	}
+	if (is_readable(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[REQUEST_NAME]&quot;) and 
+		(empty($title[$_SERVER['REQUEST_NAME']]))) 
+		_title_set(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[REQUEST_NAME]&quot;,rawurldecode($_SERVER['REQUEST_NAME']));
+
+function _updated() {
+	global $cfg;
+	echo '&lt;div class=&quot;updated&quot;&gt;Last modified on: ';
+	if(file_exists(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[REQUEST_NAME]&quot;))
+	echo date($cfg['menu_updated_format'], @filemtime(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[REQUEST_NAME]&quot;));
+	echo '&lt;/div&gt;';
+}
+
+function _structure($pagetitle) {
+	global $title, $cfg;
+	echo '&lt;span class=&quot;structure&quot;&gt;';
+	reset($title);
+	while (list($p,$t)=each($title)) {
+		if ($p!=$_SERVER['REQUEST_NAME']) {
+			echo $cfg['structure_delimiter'];
+//			if (substr($t,0,1)!='[')
+				_link($p, $t);
+//			else
+//				echo &quot;$t&quot;;
+		} else {
+			echo &quot;$cfg[structure_delimiter]&lt;span class=\&quot;structactive\&quot;&gt;$pagetitle&lt;/span&gt;&quot;;
+		}
+		echo '&amp;nbsp;';
+	}
+	echo &quot;&lt;/span&gt;\n&quot;;
+}
+
+function _menu() {
+	echo &quot;\n&lt;!-- menu start --&gt;\n&quot;;
+	echo &quot;&lt;div class=\&quot;menu\&quot;&gt;\n&quot;;
+	_menu_dir('/');
+	echo &quot;&lt;/div&gt;\n&quot;;
+	echo &quot;&lt;!-- menu end --&gt;\n&quot;;
+}
+
+function _menu_depth($i) {
+	global $cfg;
+	$str='';
+	for ($j=1; $j&lt;$i; $j++)
+		$str.=$cfg['menu_delimiter'];
+	if ($i&gt;=1) 
+		$str.=$cfg['menu_end_delimiter'];
+	return $str;
+}
+
+function _menu_dir($path) {
+	global $cfg;
+
+	echo &quot;\n&quot;;
+
+	$temp=explode('/', $path);
+	$i=count($temp);
+
+	$fp=_rtrim(&quot;$cfg[path]$path&quot;, '/');
+
+	if (is_dir(&quot;$_SERVER[DOCUMENT_ROOT]$fp&quot;) and
+		is_readable(&quot;$_SERVER[DOCUMENT_ROOT]$fp/$cfg[menu_file]&quot;)) {
+		$fp=fopen(&quot;$_SERVER[DOCUMENT_ROOT]$fp/$cfg[menu_file]&quot;,'r');
+		while ($data=fgetcsv($fp,1000)) {
+			if(empty($data) or
+				eregi('^#', $data[0])) 
+				continue;
+			echo _menu_depth($i-2);
+			if (empty($data[1])) $data[1]='';
+			if (empty($data[2])) $data[2]='';
+			$link=$data[0];
+			$file=substr($data[0], 0, strcspn($data[0], '?#'));
+			$title=$data[1];
+			$des=$data[2];
+			if (!empty($link) and !empty($des)) _desc_set($link, $des);
+			if (!empty($link) and $title=='') $title=_title_read(&quot;$_SERVER[DOCUMENT_ROOT]$file&quot;, '');
+			if (empty($link)) {
+				if (!empty($title))
+					echo &quot;&lt;span class=\&quot;nolink\&quot;&gt;$title&lt;/span&gt;&lt;br&gt;&quot;;
+				else 
+					echo '&lt;br&gt;';
+			} elseif (is_dir(&quot;$_SERVER[DOCUMENT_ROOT]$link&quot;) and
+					is_readable(&quot;$_SERVER[DOCUMENT_ROOT]$link/$cfg[menu_file]&quot;)){
+				if ($link==$_SERVER['REQUEST_URI']) {
+					_link('#', $title, 'activesub'); echo &quot;&lt;br&gt;\n&quot;;
+					_menu_dir($link);
+				} elseif (eregi(&quot;^$file&quot; ,$_SERVER['REQUEST_NAME'])) {
+					_link($file, $title, 'relatedsub'); echo &quot;&lt;br&gt;\n&quot;;
+					_menu_dir($file);
+				} else {
+					_link($file, $title, 'sub'); echo '&lt;br&gt;';
+					if ($cfg['menu_expand_all'] and
+						!ereg($cfg['sitemap_dir_exclude'],$link)) {
+						_menu_dir($file);
+					}
+				}
+			} elseif (is_readable(&quot;$_SERVER[DOCUMENT_ROOT]$file&quot;) or
+						is_dir(&quot;$_SERVER[DOCUMENT_ROOT]$file&quot;) or
+  						eregi('^javascript:',$link)) {
+				if ($link==$_SERVER['REQUEST_NAME']) {
+					_link($link, $title, 'active'); echo '&lt;br&gt;';
+				} elseif ($file==$_SERVER['REQUEST_NAME']) {
+					_link($link, $title, 'activelink'); echo '&lt;br&gt;';
+				} elseif (eregi(&quot;^$path&quot;,&quot;$link&quot;)) {
+					_link($link, $title); echo '&lt;br&gt;';
+//				} elseif (is_dir(&quot;$_SERVER[DOCUMENT_ROOT]$file&quot;)) {
+//					_link($link,&quot;$title..&quot;,'external'); echo '&lt;br&gt;';
+				} else {
+					_link($link, &quot;$title..&quot;, 'external'); echo '&lt;br&gt;';
+				}
+			} elseif (eregi('^ftp:',$link) or
+						eregi('^file:',$link) or
+						eregi('^http:',$link) or
+						eregi('^https:',$link)) {
+					_link($link, &quot;$title..&quot;, 'external'); echo '&lt;br&gt;';
+			} else {
+					echo &quot;&lt;textspan class=\&quot;missing\&quot; title=\&quot;$des\&quot;&gt;$title&lt;/textspan&gt;&lt;br&gt;&quot;;
+			}
+			echo &quot;\n&quot;;
+		}
+		fclose ($fp);
+	}
+}
+?&gt;

Added: trunk/web/dweb/mod_news.inc.php
===================================================================
--- trunk/web/dweb/mod_news.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_news.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,125 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+
+	$newsdir = &quot;$_SERVER[DOCUMENT_ROOT]/buttons/&quot;; // store temp files here (make sure webserver has write permission!)
+	$timeout = 3; // number of seconds to wait for a connection
+	$font_face = &quot;Lucida,Verdana,Helvetica,Arial&quot;; //font face
+	$font_color = '#FFFFFF'; //font color
+	$link_color = ''; //link color
+	$font_size = '2'; //font size
+
+	function getxml($xml) {
+	  global $newsdir, $timeout;
+	
+	  // convert agelimit to seconds
+//	 $agelimit*=60;
+	 $timestamp=filectime($newsdir.basename($xml));
+ 	 $age=time()-$timestamp;
+ 	 $test='';
+ 	 if($age&gt;$agelimit) {
+ 	   $url = parse_url($xml);
+ 	   $fp = fsockopen($url['host'], 80, &amp;$errno, &amp;$errstr, $timeout);
+ 	   socket_set_timeout($fp, $timeout, 0);
+ 	   socket_set_blocking($fp, 0);
+ 	   if (!$fp) return;  //just quit on error
+ 	   else {
+//      $local = fopen($newsdir . basename($xml), &quot;w&quot;);
+//      if (!$local) return; //just quit on error
+ 	     fputs($fp, 'GET /' . $url['path'] . &quot; HTTP/1.0\r\n\r\n&quot;);
+ 	     while(!feof($fp))
+        $test.=fgets($fp, 128); 
+//        fwrite($local, fgets($fp, 128));
+//      fclose($local);
+	    }
+ 	   $i=0;
+	    $content=split(&quot;\n&quot;,$test);
+ 	   reset($content);
+	    $local = fopen($newsdir.basename($xml), 'w');
+ 	   if (!$local) return; //just quit on error
+ 	   fwrite($local, &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;ISO-8859-1\&quot;?&gt;&lt;rdf:RDF xmlns:rdf=\&quot;<A HREF="http://www.w3.org/1999/02/22-rdf-syntax-ns#\">http://www.w3.org/1999/02/22-rdf-syntax-ns#\</A>&quot; xmlns=\&quot;<A HREF="http://my.netscape.com/rdf/simple/0.9/\">http://my.netscape.com/rdf/simple/0.9/\</A>&quot;&gt;\n  &lt;channel&gt;\n\n&quot;);
+ 	   while(next($content)) {
+ 	     if (ereg('^&amp;&amp;',current($content))) {
+ 	       $title=chop(next($content));
+ 	       $link=chop(next($content));
+ 	       $date=chop(next($content));
+ 	       if ($title!=&quot;&quot;and$link!=&quot;&quot;)
+ 	         fwrite($local, &quot;    &lt;item&gt;\n      &lt;title&gt;$title&lt;/title&gt;\n      &lt;link&gt;$link&lt;/link&gt;\n    &lt;/item&gt;\n\n&quot;);
+ 	       $i++;                                     
+ 	     }
+ 	   }
+ 	   fwrite($local, &quot;  &lt;/channel&gt;\n&lt;/rdf:RDF&gt;&quot;);
+ 	   fclose($local);
+ 	 }
+ 	 listrdf(basename($xml));
+	}
+	
+	function getrdf($rdf,$agelimit) {
+ 	 global $newsdir, $timeout;
+
+//	convert agelimit to seconds
+	$agelimit *= 60;
+	$timestamp = filectime($newsdir.basename($rdf));
+	$age = time() - $timestamp;
+	if($age &gt; $agelimit) {
+		$url = parse_url($rdf);
+		$fp = fsockopen($url['host'], &quot;80&quot;, &amp;$errno, &amp;$errstr, $timeout);
+		if (!$fp) return;  //just quit on error
+		else {
+			$local = fopen($newsdir.basename($rdf), &quot;w&quot;);
+			if (!$local) return; //just quit on error
+			fputs($fp, &quot;GET /&quot; . $url['path'] . &quot; HTTP/1.1\r\nHost: &quot; . $url['host'] . &quot;\r\n\r\n&quot;);
+			while(!feof($fp))
+				fwrite($local, fgets($fp, 128));
+				fclose($local);
+			}
+		}
+		listrdf(basename($rdf));
+	}
+	
+	function makebullet($item) {
+		global $font_face, $font_color, $font_size, $link_color;
+
+		$item=ereg_replace('.*&lt;item&gt;','',$item);
+		eregi('&lt;description&gt;(.*)&lt;\/description&gt;',$item,$desc);
+		eregi('&lt;link&gt;(.*)&lt;\/link&gt;',$item,$link);
+		eregi('&lt;title&gt;(.*)&lt;\/title&gt;',$item,$title);
+		if ($title[1]) {
+			if ($desc[1]) {
+				echo &quot;&lt;li&gt;&lt;acronym title=\&quot;$desc[1]\&quot;&gt;&quot;;
+				_link($link[1],$title[1],&quot;_blank&quot;);
+				echo &quot;&lt;/a&gt;&lt;/acronym&gt;\n&quot;;
+ 			} else {
+				echo &quot;&lt;li&gt;&quot;;
+				_link($link[1],$title[1],&quot;_blank&quot;);
+			}
+		}
+	}
+ 
+	function listrdf($rdf) {
+		global $newsdir;
+
+		$fp = fopen($newsdir.$rdf,'r');
+		if (!$fp) return; //just quit on error
+		$pagetext = fread($fp, filesize($newsdir . $rdf));
+		fclose($fp);
+
+//		kill the crud at the top and bottom
+		$pagetext=ereg_replace('&lt;?xml.*/image&gt;','',$pagetext);
+		$pagetext=ereg_replace('&lt;/rdf.*','',$pagetext);
+		$pagetext=chop($pagetext);
+ 
+//		make an array and walk it, printing out the item
+		$items = explode('&lt;/item&gt;',$pagetext);
+		array_pop($items);
+		echo &quot;&lt;font face=\&quot;$font_face\&quot; color=\&quot;$font_color\&quot; size=\&quot;2\&quot;&gt;&quot;;
+		array_walk($items, 'makebullet');
+		echo '&lt;/font&gt;';
+	}                                                                       
+?&gt;

Added: trunk/web/dweb/mod_photo.inc.php
===================================================================
--- trunk/web/dweb/mod_photo.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_photo.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,147 @@
+&lt;?
+
+	/* Default configuration variables */
+	_cfg_default('photo_tnwidth',	120);
+	_cfg_default('photo_tnheight',	120);
+	_cfg_default('photo_tncols',	4);
+	_cfg_default('photo_tndir',	'.tn/');
+	_cfg_default('photo_command',	'convert -quality 100 -resize %wx%h %i %o');
+	_cfg_default('desc_indexfile',	'.index');
+
+	$photos=Array();
+
+function _photo_index($dir) {
+	global $cfg, $index, $photos;
+
+	if (is_readable(&quot;$dir$cfg[desc_indexfile]&quot;)) {
+		$photolist=file(&quot;$dir$cfg[desc_indexfile]&quot;);
+		$index=array();
+		reset($photolist);
+		while ($p=current($photolist)) {
+			$ret=split(&quot;\t+&quot;,$p);
+			if (isset($ret[1]))
+				$index[$ret[0]]=$ret[1];
+			next($photolist);
+		}
+	}
+
+	$photos=array();
+	$d=dir($dir);
+	while($entry=$d-&gt;read())
+		if (eregi('\.(gif|jpg|png)$', $entry))
+			$photos[]=$entry;
+	$d-&gt;close();
+	asort($photos);
+}
+
+function _photo_previous($photo) {
+	global $photos;
+	reset($photos);
+	while($entry=current($photos))
+		if ($entry==$photo)
+			return prev($photos);
+		else
+			next($photos);
+}
+
+function _photo_next($photo) {
+	global $photos;
+	foreach($photos as $entry)
+		if ($entry==$photo)
+			return current($photos);
+}
+
+function _photo_number($photo) {
+	global $photos;
+	$x=$i=1;
+	foreach($photos as $entry) {
+		if ($entry==$photo)
+			$x=$i;
+		$i++;
+	}
+	$entry=current($photos);
+	return &quot;photo $x of &quot;.--$i;
+}
+
+function _photo_navigation($ph) {
+	global $cfg, $index, $photos;
+	echo &quot;&lt;table border=\&quot;0\&quot; width=\&quot;100%\&quot;&gt;&lt;tr&gt;&lt;td align=\&quot;left\&quot; valign=\&quot;top\&quot; width=\&quot;$cfg[photo_tnwidth]\&quot;&gt;&quot;;
+	if ($photo=_photo_previous($ph) and isset($photo))
+		echo &quot;&lt;a href=\&quot;?photo=$photo\&quot;&gt;&lt;small&gt;&lt;b&gt;Previous&lt;/b&gt;&lt;/small&gt;&lt;br&gt;&lt;img src=\&quot;.tn/$photo.jpg\&quot; alt=\&quot;Previous\&quot; align=\&quot;left\&quot; title=\&quot;Previous image\&quot;&gt;&lt;/a&gt;&quot;;
+	echo &quot;&lt;/td&gt;&lt;td align=\&quot;center\&quot; valign=\&quot;top\&quot;&gt;&lt;small&gt;&lt;b&gt;&lt;a href=\&quot;?\&quot;&gt;Index&lt;/a&gt;&lt;/b&gt;&lt;br&gt;&quot;._photo_number($ph).&quot;&lt;br&gt;&lt;br&gt;$ph&lt;/small&gt;&lt;/td&gt;&lt;td align=\&quot;right\&quot; valign=\&quot;top\&quot; width=\&quot;$cfg[photo_tnwidth]\&quot;&gt;&quot;;
+	if ($photo=_photo_next($ph) and isset($photo))
+		echo &quot;&lt;a href=\&quot;?photo=$photo\&quot;&gt;&lt;small&gt;&lt;b&gt;Next&lt;/b&gt;&lt;/small&gt;&lt;br&gt;&lt;img src=\&quot;.tn/$photo.jpg\&quot; alt=\&quot;Next\&quot; align=\&quot;right\&quot; title=\&quot;Next image\&quot;&gt;&lt;/a&gt;&quot;;
+	echo &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;;
+	echo &quot;&lt;a href=\&quot;$ph\&quot;&gt;&lt;img src=\&quot;$ph\&quot; width=\&quot;100%\&quot; alt=\&quot;$ph\&quot; align=\&quot;center\&quot; title=\&quot;$ph\&quot;&gt;&lt;/a&gt;\n&quot;;
+	if (isset($index[$ph])) {
+		echo &quot;&lt;br clear=\&quot;all\&quot;&gt;\n&quot;;
+		echo '&lt;b&gt;'.$index[$ph].&quot;&lt;/b&gt;\n&quot;;
+	}
+}
+
+function _photo_dir($dir) {
+	global $cfg, $index, $photos;
+
+	if (empty($photos) and !empty($dir))
+		_photo_index(&quot;$_SERVER[DOCUMENT_ROOT]$_SERVER[REQUEST_NAME]&quot;);
+
+	$colperc=round(100/$cfg['photo_tncols']);
+
+	$i=1;
+	foreach($photos as $entry) {
+
+		if (eregi('\.(gif|jpg|png)$', $entry) and is_readable(&quot;$dir$entry&quot;)) {
+			$tnfile=&quot;$dir$cfg[photo_tndir]$entry.jpg&quot;;
+			$tnlink=&quot;$cfg[photo_tndir]$entry.jpg&quot;;
+			if (!is_readable($tnfile)) {
+				if (eregi(&quot;\.gif$&quot;, $entry)) {
+					$src_img=ImageCreateFromGIF(&quot;$dir$entry&quot;);
+				} elseif (eregi(&quot;\.jpg$&quot;, $entry)) {
+					$src_img=ImageCreateFromJPEG(&quot;$dir$entry&quot;);
+				} elseif (eregi(&quot;\.png$&quot;, $entry)) {
+					$src_img=ImageCreateFromPNG(&quot;$dir$entry&quot;);
+				}
+				$tnwidth=$cfg['photo_tnwidth'];
+				$tnheight=$cfg['photo_tnheight'];
+				if ($src_img) {
+					$width=ImageSX($src_img);
+					$height=ImageSY($src_img);
+					if ($height&gt;$width)
+						$tnwidth=round($tnheight*$width/$height);
+					else
+						$tnheight=round($tnwidth*$height/$width);
+				}
+				if (is_writable(&quot;$dir$cfg[photo_tndir]&quot;)) {
+					if (empty($cfg['photo_command'])) {
+						$dst_img=ImageCreateTrueColor($tnwidth, $tnheight);
+						ImageCopyResampled($dst_img, $src_img, 0, 0, 0, 0, $tnwidth, $tnheight, $width, $height);
+//						ImagePNG($dst_img, $tnfile);
+						ImageJPEG($dst_img, $tnfile, 100);
+						imagedestroy($dst_img);
+					} else {
+						$cmd=$cfg['photo_command'];
+						$cmd=ereg_replace('%w', &quot;$tnwidth&quot;, $cmd);
+						$cmd=ereg_replace('%h', &quot;$tnheight&quot;, $cmd);
+						$cmd=ereg_replace('%i', &quot;$dir$entry&quot;, $cmd);
+						$cmd=ereg_replace('%o', $tnfile, $cmd);
+						exec($cmd, $array, $ret);
+					}
+					imagedestroy($src_img);
+				} else {
+					$tnlink=$entry;
+				}
+			}
+			if (empty($index[$entry])) {
+				$tntitle=$entry;
+				$tntext='';
+			} else {
+				$tntitle=&quot;$entry:\n&quot;.htmlspecialchars(strip_tags(trim($index[$entry])));
+				$tntext='&lt;br clear=&quot;all&quot;&gt;'.trim($index[$entry]);
+			}
+			echo &quot;&lt;td width=\&quot;$colperc%\&quot; align=\&quot;center\&quot; valign=\&quot;top\&quot;&gt;&lt;font size=\&quot;1\&quot;&gt;-&quot;.$i++.&quot;-&lt;br&gt;&lt;a href=\&quot;?photo=$entry\&quot; title=\&quot;$tntitle\&quot;&gt;&lt;img src=\&quot;$tnlink\&quot; alt=\&quot;$entry\&quot; border=\&quot;2\&quot;&gt;&lt;/a&gt;\n$tntext&lt;/font&gt;&lt;/td&gt;\n&quot;;
+			if ((($i-2)%$cfg['photo_tncols'])==($cfg['photo_tncols']-1))
+				echo &quot;&lt;/tr&gt;&lt;tr&gt;\n&quot;;
+		}
+	}
+}
+?&gt;

Added: trunk/web/dweb/mod_prepend.inc.php
===================================================================
--- trunk/web/dweb/mod_prepend.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_prepend.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,368 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+	/* Turn on output buffering */
+	ob_start();
+	global $cfg, $desc, $headers, $in, $meta, $title;
+
+	/* initializing arrays */
+	$cfg=$desc=$headers=$in=$meta=$title=array();
+
+	/* getting parameters */
+	if(!empty($HTTP_POST_VARS)) 
+		$in=$HTTP_POST_VARS;
+	else
+		$in=$HTTP_GET_VARS;
+
+	/* base variables */ 
+	$cfg['indexfile']='index.php';
+	$cfg['debug']=$in['debug'];
+//	$cfg['debug']='all';
+
+	$cfg['charset']='ISO-8859-15';
+	$cfg['internal_hosts']='^$';
+	$cfg['lang']='en';
+	$cfg['path']='/';
+	$cfg['titlefile']='.title';
+	$cfg['error_alert']=true;
+	$cfg['error_display']=false;
+
+	/* Fix some default variables */
+	$_SERVER['HTTP_HOST']=_rtrim($_SERVER['HTTP_HOST'], '/');
+	list($_SERVER['REQUEST_NAME'])=split('[?#]', str_replace($cfg['indexfile'], '', $_SERVER['REQUEST_URI']));
+	$_SERVER['SCRIPT_NAME']=str_replace($cfg['indexfile'], '', $_SERVER['SCRIPT_NAME']);
+	$_SERVER['DIRNAME']=dirname(&quot;$_SERVER[REQUEST_NAME]file&quot;).'/';
+	if ($_SERVER['DIRNAME']=='//') $_SERVER['DIRNAME']='/';
+	$_SERVER['REFERER']=rawurldecode($_SERVER['REFERER']);
+
+	/* default settings (meta-tags and order) */
+	$meta['keywords']='';
+	$meta['description']='';
+	$meta['robots']='index,follow';
+	$meta['author']='Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt;';
+	$meta['copyright']='&amp;copy; 1995-2004 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt;. All rights reserved.';
+//	$meta['email']='<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>';
+//	$meta['generator']='vim+php+ht-dig+apache+linux=Open Source at its best.';
+	$meta['language']='English';
+
+	$headers=getallheaders();
+
+	/* Load site-specific stuff */
+	_mod_search('cfg_local');
+
+	if (empty($cfg['modules'])) {
+		echo '&lt;!-- DEBUG: No extra modules loaded, $cfg[modules] not set --&gt;\n';
+	} else {
+		foreach(explode(',', $cfg['modules']) as $mod) {
+			_mod_load(&quot;mod_$mod&quot;);
+		}
+	}
+	setlocale(LC_ALL, $cfg['lang']);
+	_setRelDirname();
+
+	if (!empty($cfg['debug']))
+		_debug();
+
+	function _errorhandler($nr, $str, $file, $line, $context) {
+		global $cfg;
+//		if (!in_array($nr, array(E_USER_ERROR, E_ERROR, E_USER_NOTICE, E_PARSE))) return 0;
+		$type=array(
+			E_ERROR			=&gt; 'Error',			// 1
+			E_WARNING		=&gt; 'Warning',			// 2
+			E_PARSE			=&gt; 'Parse Error',		// 4
+			E_NOTICE		=&gt; 'Notice',			// 8
+			E_CORE_ERROR		=&gt; 'Core Error',		// 16
+			E_CORE_WARNING		=&gt; 'Core Warning',		// 32
+			E_COMPILE_ERROR		=&gt; 'Compile Error',		// 64
+			E_COMPILE_WARNING	=&gt; 'Compile Warning',		// 128
+			E_USER_ERROR		=&gt; 'User Error',		// 256
+			E_USER_WARNING		=&gt; 'User Warning',		// 512
+			E_USER_NOTICE		=&gt; 'User Notice',		// 1024
+		);
+		if (!isset($cfg['error_body'])) {
+			$cfg['error_subject']=&quot;[DWEB] PHP ERROR in <A HREF="http://$_SERVER[SERVER_NAME">http://$_SERVER[SERVER_NAME</A>]$_SERVER[REQUEST_URI]&quot;;
+			$cfg['error_body']=&quot;---\n&quot;.
+				(isset($_SERVER['HTTP_REFERER'])?&quot;Referer: $_SERVER[HTTP_REFERER]\n&quot;:'').
+				&quot;Bad Link: <A HREF="http://$_SERVER[SERVER_NAME">http://$_SERVER[SERVER_NAME</A>]$_SERVER[REQUEST_URI]\n&quot;.
+				&quot;IP Address: $_SERVER[REMOTE_ADDR] ($_SERVER[REMOTE_HOST])\n&quot;.
+				(isset($_SERVER['HTTP_USER_AGENT'])?&quot;User Agent: $_SERVER[HTTP_USER_AGENT]\n&quot;:'').
+                        	(isset($_SERVER['HTTP_X_FORWARDED_FOR'])?&quot;Internal IP: $_SERVER[HTTP_X_FORWARDED_FOR]\n&quot;:'').
+	                        (isset($_SERVER['HTTP_VIA'])?&quot;Via: $_SERVER[HTTP_VIA]\n&quot;:'').
+        	                &quot;---\n\n&quot;;
+		}
+		$cfg['error_body'].=&quot;PHP $type[$nr] [$nr]: $str &quot;.&quot;at line $line in $file\n&quot;;
+//                              print_r($context).&quot;\n\n&quot;;
+		if($nr==E_ERROR) {
+			_foot();
+			include('mod_append.inc.php');
+		}
+	}
+
+	if ($cfg['error_alert']) {
+		set_error_handler('_errorhandler');
+	}
+
+	if ($cfg['error_display']) {
+		if ($cfg['debug']=='all')
+			error_reporting(E_ALL);
+		else 
+			error_reporting(E_ALL ^ E_NOTICE);
+	} else {
+		if (empty($cfg['debug']))
+			error_reporting(0); 
+	}
+	
+	/* Search module and load it */
+	function _mod_search($mod) {
+		global $cfg, $desc, $meta, $title;
+		$t=explode('/', _rtrim($_SERVER['DIRNAME'], '/'));
+		for($i=1; $i&lt;=count($t); $i++) {
+			$p='/';
+			for($j=1; $j&lt;count($t)+1-$i; $j++) $p.=$t[$j].'/';
+			if (@is_readable(&quot;$_SERVER[DOCUMENT_ROOT]$p$mod.inc.php&quot;)) {
+				if (!empty($cfg['debug']))
+					echo &quot;&lt;!-- DEBUG: Module $p$mod found and loaded --&gt;\n&quot;;
+				include_once(&quot;$_SERVER[DOCUMENT_ROOT]$p$mod.inc.php&quot;);
+				return 0;
+			}
+		}
+		if (file_exists(&quot;$mod.inc.php&quot;) and is_readable(&quot;$mod.inc.php&quot;)) {
+			if (!empty($cfg['debug']))
+				echo &quot;&lt;!-- DEBUG: Module $mod loaded via include-path --&gt;\n&quot;;
+			include_once(&quot;$mod.inc.php&quot;);
+			return 0;
+		}
+		if (!empty($cfg['debug']))
+			echo &quot;&lt;!-- DEBUG: Module $p$mod not found --&gt;\n&quot;;
+		return 1;
+	}
+
+	function _mod_load($mod) {
+		global $cfg, $desc, $meta, $title;
+		if (is_readable(&quot;$_SERVER[DOCUMENT_ROOT]$cfg[path]/$mod.inc.php&quot;)) {
+			if (!empty($cfg['debug']))
+				echo &quot;&lt;!-- DEBUG: Module $cfg[path]$mod loaded --&gt;\n&quot;;
+			include_once(&quot;$_SERVER[DOCUMENT_ROOT]/$cfg[path]$mod.inc.php&quot;);
+			return 0;
+		} else {
+			if (!empty($cfg['debug'])) {
+				echo &quot;&lt;!-- DEBUG: Module $mod loaded via include-path --&gt;\n&quot;;
+			}
+			include_once(&quot;$mod.inc.php&quot;);
+		}
+		return 1;
+	}
+
+	function _isPrivate() {
+		global $cfg;
+		if ((isset($_SERVER['REMOTE_HOST']) and preg_match(&quot;/$cfg[internal_hosts]/i&quot;, $_SERVER['REMOTE_HOST'])) or
+			(preg_match(&quot;/$cfg[internal_hosts]/i&quot;, $_SERVER['REMOTE_ADDR'])))
+			return 1;
+		return 0; 
+	}
+
+	function _title_set($file, $name) {
+		global $title;
+		if (empty($title[$name])) 
+			$title[$name]=_title_read($file);
+	}
+
+	function _title_read(/* $file,$name */) {
+		global $cfg, $title;
+		$numargs=func_num_args();
+		$file=func_get_arg(0);
+		if (!empty($title[$file]))
+			return $title[$file];
+		if (is_file($file)) {
+			if (@is_readable($file))
+				$name=_title_get($file);
+		} else {
+			if (@is_readable(&quot;$file/$cfg[titlefile]&quot;))
+				$name=rtrim(current(file(&quot;$file/$cfg[titlefile]&quot;)));
+			elseif (@is_readable(&quot;$file/$cfg[indexfile]&quot;))
+				$name=_title_get(&quot;$file/$cfg[indexfile]&quot;);
+			elseif (@is_readable(&quot;$file/index.html&quot;))
+				$name=_title_get(&quot;$file/index.html&quot;);
+			elseif (@is_readable(&quot;$file/index.cgi&quot;))
+				$name=_title_get(&quot;$file/index.cgi&quot;);
+		}
+		if (empty($name)) {
+			if ($numargs==2) {
+				$name=func_get_arg(1);
+				if ($name!='') 
+					$name=&quot;[$name]&quot;;
+			} else {
+				$name='['.rawurldecode(basename($file)).']';
+			}
+		}
+		return $name;
+	}
+
+	function _title_get($file) {
+		if ($fd=fopen($file,'r')) {
+			$contents=fread($fd, 2048);
+			fclose ($fd);
+			if(eregi(&quot;_head\([\'\&quot;]([^\'\&quot;]+)[\'\&quot;]\)&quot;, $contents, $regs) or
+				eregi(&quot;&lt;title\n?&gt;([^&lt;]+)&lt;/title\n?&gt;&quot;, $contents, $regs)) {
+				return strip_tags($regs[1]);
+			}
+		}
+		return false;
+	}
+
+	function _desc_set($file, $des) {
+		global $desc;
+		if (empty($desc[$file])) 
+			$desc[$file]=$des;
+	}
+
+	function _desc_read($file) {
+		global $cfg, $desc, $title;
+		$des=false;
+		if (!empty($desc[$file]))
+			return $desc[$file];
+		$full=&quot;$_SERVER[DOCUMENT_ROOT]/$file&quot;;
+		if (is_file($full)) {
+			if (is_readable($full))
+				$des=_desc_get($full);
+		} else {
+			if (is_readable(&quot;$full/.desc&quot;))
+				$des=rtrim(current(file(&quot;$full/.desc&quot;)));
+			elseif (is_readable(&quot;$full/index.php&quot;))
+				$des=_desc_get(&quot;$full/index.php&quot;);
+			elseif (is_readable(&quot;$full/.readme&quot;))
+				$des=_desc_get(&quot;$full/.readme&quot;);
+		}
+		if (!$des) {
+			if (!empty($title[$file]))
+				return $title[$file];
+		}
+		$desc[$file]=$des;
+		return $des;
+	}
+
+	function _desc_get($file) {
+		global $title;
+		if ($fd=fopen($file,'r')) {
+			$contents=fread($fd, 2048);
+			fclose ($fd);
+			if(eregi('\$meta\[[\&quot;]description[\&quot;]\]=[\&quot;]([^\&quot;]*)[\&quot;]', $contents, $regs)
+//				or preg_match('/&lt;div class=&quot;intro&quot;&gt;(.*?)&lt;\/div&gt;/s',$contents,$regs)
+				)
+				return strip_tags($regs[1]);
+			elseif (!empty($title[$file]))
+				return $title[$file];
+		}
+		return false;
+	}
+
+	function _ltrim($str, $charlist) {
+		return substr($str,strspn($str,$charlist));
+	}
+
+	function _rtrim($str,$charlist) {
+		$rev=strrev($str);
+		$rev=substr($rev,strspn($rev,$charlist));
+		return strrev($rev);
+	}
+
+	/* Clean up $cfg[path] */
+	function _setRelDirname() {
+		global $cfg;
+		if ($cfg['path']!='' and $cfg['path']!='/') {
+			$_SERVER['RELDIRNAME']='/'._ltrim(str_replace(_ltrim($cfg['path'],'/'),'',$_SERVER['DIRNAME']),'/');
+		} else {
+			$cfg['path']='/';
+			$_SERVER['RELDIRNAME']=$_SERVER['DIRNAME'];
+		}
+	}
+
+	function spc($width,$height,$alt) {
+		echo &quot;&lt;img src=\&quot;/images/spacer.gif\&quot; width=\&quot;$width\&quot; height=\&quot;$height\&quot; border=\&quot;0\&quot; alt=\&quot;$alt\&quot; hspace=\&quot;0\&quot; vspace=\&quot;0\&quot;&gt;&quot;;
+	}
+
+	function _getLastUpdated() {
+		global $meta;
+		if (!empty($meta['id']) and ereg('Id: .+,v .+ ([0-9]{4})/([0-9]{2})/([0-9]{2}) ([0-9]{2}):([0-9]{2}):([0-9]{2}) .+ Exp ',$meta['id'],$date))
+			return mktime($date[4],$date[5],$date[6],$date[2],$date[3],$date[1]);
+	}
+
+	function _lastUpdated($file) {
+		global $cfg;
+		if ($file) {
+			if(is_file($file))
+				echo '&lt;small&gt;&lt;b&gt;Updated '.gmdate('d F Y',filemtime($file)).&quot;&lt;/b&gt;&lt;/small&gt;\n&quot;;
+			else
+				echo '&lt;small&gt;&lt;b&gt;File is missing!&lt;/b&gt;&lt;/small&gt;';
+		} else {
+			if ($date=_getLastUpdated())
+				echo &quot;&lt;div id=\&quot;updated\&quot;&gt;&quot;.$cfg['last updated'].strftime(&quot;%d %B %Y&quot;,$date).&quot;&lt;/div&gt;\n&quot;;
+		}
+	}
+
+	/* creates a filename of a string */
+	function _createName($title) {
+		$name='';
+		$title=strtolower($title);
+		for ($i=0;$i&lt;strlen($title);$i++) {
+			$chr=substr($title,$i,1);
+			if ((ord($chr)&gt;=ord('a') and ord($chr)&lt;=ord('z')) or
+				(ord($chr)&gt;=ord('0') and ord($chr)&lt;=ord('9') and $name!=''))
+				$name.=$chr;
+			elseif($chr==' ')
+				$name.='-';
+		}
+		return $name;
+	}
+
+	function _cfg_default($var, $val) {
+		global $cfg;
+		if(empty($cfg[$var]))
+			$cfg[$var]=$val;
+	}
+
+	function _debug_array($aname, $array) {
+		if (!empty($array)) {
+			echo &quot;\n&quot;;
+			reset($array);
+			while (list($name,$value)=each($array))
+				echo &quot;&lt;!-- \$$aname&quot;.&quot;['$name']='$value' --&gt;\n&quot;;
+		}
+	}
+
+	/* Print debug information */
+	function _debug() {
+		global $GLOBALS, $cfg, $desc, $headers, $in, $menu, $title;
+		_debug_array('_SERVER', $_SERVER);
+//		_debug_array('GLOBALS', $GLOBALS);
+		_debug_array('cfg', $cfg);
+		_debug_array('desc', $desc);
+		_debug_array('headers', $headers);
+		_debug_array('in', $in);
+		_debug_array('menu', $menu);
+		_debug_array('title', $title);
+		echo &quot;\n&quot;;
+	}
+
+	function _human_filesize($bytes) {
+		$current = 0;
+		$long_unit = Array(&quot;bytes&quot;,&quot;kilobytes&quot;,&quot;megabytes&quot;,&quot;gigabytes&quot;,&quot;terabytes&quot;);
+		$short_unit = Array(&quot;B&quot;,&quot;kB&quot;,&quot;MB&quot;,&quot;GB&quot;,&quot;TB&quot;);
+		while ($bytes &gt; 1024) {
+			$current++;
+			$bytes /= 1024;
+	}
+	return round($bytes, 2).&quot; &quot;.$short_unit[$current];
+}
+
+
+/* End of shared stuff. */
+
+/* Move modified functions below and change them. */
+?&gt;

Added: trunk/web/dweb/mod_protest.inc.php
===================================================================
--- trunk/web/dweb/mod_protest.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_protest.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,45 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+/*
+	Description: Put up a protest page. (/protest.php)
+
+		protest_all_hits	Show protest page for every hit (default: false)
+		protest_no_bots		Don't show protest for spiders/bots (default: true)
+		protest_page		The page to show, relative to website (default: /protest.php)
+*/
+	global $cfg, $in;
+
+	/* Default configuration variables */
+	_cfg_default('protest_all_hits',	false);
+	_cfg_default('protest_no_bots',		true);
+	_cfg_default('protest_page',		'/protest.php');
+
+	/* Business logic */
+	if (!array_key_exists('protest',$in)) {
+		if (empty($cfg['debug'])) {
+			if (!($cfg['protest_no_bots'] and (eregi('(bot|spider|validator)', $_SERVER['HTTP_USER_AGENT'])))) {
+				if (($cfg['protest_all_hits'] and ($_SERVER['HTTP_REFERER']!=&quot;<A HREF="http://$_SERVER[HTTP_HOST">http://$_SERVER[HTTP_HOST</A>]$_SERVER[REQUEST_URI]&quot;)) or
+					(!eregi($_SERVER['SERVER_NAME'], $_SERVER['HTTP_REFERER']))) {
+					$file=&quot;$_SERVER[DOCUMENT_ROOT]$cfg[path]$cfg[protest_page]&quot;;
+					if (is_readable($file)) {
+						include(&quot;$_SERVER[DOCUMENT_ROOT]$cfg[path]$cfg[protest_page]&quot;);
+						exit;
+					} else {
+						echo &quot;&lt;!-- DEBUG(protest): protest_page ($file) not found. --&gt;\n&quot;;
+					}
+				}
+			}
+		} else {
+			echo &quot;&lt;!-- DEBUG(protest): Module mod_protest is disabled because debugging is on --&gt;\n&quot;;
+		}
+	} else {
+		echo &quot;&lt;!-- DEBUG(protest): Module mod_protest is disabled because \$in['protest'] is defined --&gt;\n&quot;;
+	}
+?&gt;

Added: trunk/web/dweb/mod_quote.inc.php
===================================================================
--- trunk/web/dweb/mod_quote.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_quote.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,39 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/ 
+/*
+	Description: Shows a quote randomly from a file of quotes.
+*/
+
+	function randomint($max) { 
+		$startseed=(double)microtime()*getrandmax(); 
+		srand($startseed);
+		return (rand()%$max); 
+	} 
+
+	function enhance($line,$str) { 
+		return eregi_replace('(dag)',&quot;&lt;a href=\&quot;$str\&quot;&gt;\\1&lt;/a&gt;&quot;,$line);
+	}
+
+	/* get a quote about dag */
+	function _quote($fn) {
+		if(is_file($fn)) {
+			$fp=fopen($fn,'r');
+			$line=&quot;#&quot;;
+			while (ereg('^#',$line)) {
+				fseek($fp,randomint(filesize($fn)-50));
+				while (fgetc($fp)!=&quot;\n&quot;);
+				$line=trim(fgets($fp,1024));
+			}
+			fclose($fp);
+//			echo enhance($line,$str);
+			return $line;
+		}
+	}
+?&gt;

Added: trunk/web/dweb/mod_sitemap.inc.php
===================================================================
--- trunk/web/dweb/mod_sitemap.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_sitemap.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,89 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/
+
+	_cfg_default('sitemap_ext_include',	'.(php|pdf|rtf|rpm|html)$');
+	_cfg_default('sitemap_ext_exclude',	'.(inc|inc.php)$');
+	_cfg_default('sitemap_file_exclude',	'^((error.php|dir.php|index.html|index.php|mail.php|photo.php|submit.php)$|\.)');
+	_cfg_default('sitemap_title_exclude',	'\$|draft|hidden|old');
+	_cfg_default('sitemap_dir_exclude',	'^\.');
+	_cfg_default('sitemap_depth',		0);
+	_cfg_default('sitemap_hiddenfile',	'.hidden');
+	_cfg_default('desc_indexfile',		'.index');
+
+function _sitemap_index() {
+	global $cfg;
+	echo '&lt;ul type=&quot;square&quot;&gt;&lt;li&gt;';
+	_link($cfg['path'], _title_read(&quot;$_SERVER[DOCUMENT_ROOT]$cfg[path]&quot;, ''));
+	_sitemap_dir($cfg['path'], 1);
+	echo '&lt;/ul&gt;';
+}
+
+function _sitemap_dir($dir,$depth) {
+	global $cfg;
+	if ($cfg['sitemap_depth']!=0 and $depth&gt;$cfg['sitemap_depth']) return;
+	$dir=_rtrim($dir, '/');
+
+	$entries=array();
+	$d=dir(&quot;$_SERVER[DOCUMENT_ROOT]$dir&quot;);
+	while($entry=$d-&gt;read()) {
+		$file=&quot;$_SERVER[DOCUMENT_ROOT]$dir/$entry&quot;;
+		if (is_readable($file)) {
+			if (is_file($file) and
+				ereg($cfg['sitemap_ext_include'], $entry) and
+				!ereg($cfg['sitemap_ext_exclude'], $entry) and
+				!ereg($cfg['sitemap_file_exclude'], $entry)) {
+				$title=_title_read($file, $entry);
+				if ($title!='')
+					if (_isPrivate() or
+						!eregi($cfg['sitemap_title_exclude'], $title)) {
+						$entries[$entry]=$title;
+						$desc[$entry]=_desc_read($file);
+					}
+			} elseif (is_dir($file) and
+				!ereg('\.+$', $entry) and
+				!ereg($cfg['sitemap_file_exclude'], $entry) and
+				!ereg($cfg['sitemap_dir_exclude'], &quot;$dir/$entry&quot;) and
+				!@is_file(&quot;$file/$cfg[sitemap_hiddenfile]&quot;) and
+				(!ereg('^intern$',$entry) or
+				(_isPrivate()))) {
+				$title=_title_read($file, '');
+				if ($title!='') {
+					if (_isPrivate() or
+						!eregi($cfg['sitemap_title_exclude'], $title)) {
+						$entries[$entry]=$title;
+						$desc[$entry]=_desc_read($file);
+					}
+				} elseif (@is_file(&quot;$file/$cfg[desc_indexfile]&quot;)) {
+					$entries[$entry]=ucwords($entry);
+					$desc[$entry]=_desc_read($file);
+				}
+			}
+       	 	}
+	}
+	$d-&gt;close();
+	asort($entries);
+	reset($entries);
+	while(list($entry,$title)=each($entries)) {
+		$file=&quot;$_SERVER[DOCUMENT_ROOT]$dir/$entry&quot;;
+		if (is_file($file)) {
+			echo '&lt;ul type=&quot;disc&quot;&gt;&lt;li&gt; ';
+			_link(&quot;$dir/$entry&quot;, $title, $desc[$entry]);
+			echo '&lt;/ul&gt;';
+		} elseif (is_dir($file)) {
+			echo '&lt;ul type=&quot;circle&quot;&gt;&lt;li&gt; ';
+			_link(&quot;$dir/$entry/&quot;, $title, $desc[$entry]);
+			echo '&lt;/ul&gt;';
+			echo '&lt;ul&gt;';
+			_sitemap_dir(&quot;$dir/$entry&quot;, $depth++);
+			echo &quot;&lt;/ul&gt;\n&quot;;
+		}
+	}
+}
+?&gt;

Added: trunk/web/dweb/mod_useragent.inc.php
===================================================================
--- trunk/web/dweb/mod_useragent.inc.php	2004-09-14 19:43:21 UTC (rev 2189)
+++ trunk/web/dweb/mod_useragent.inc.php	2004-09-14 19:46:10 UTC (rev 2190)
@@ -0,0 +1,43 @@
+&lt;?
+/*  
+	This file is a shared library and contains code that is used
+	by more than one website. Everything that is specific to a
+	certain website must go in cfg_local.inc.php.
+
+	If you really need to change functions in this file, please
+	send them to <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com.</A>
+*/
+
+//	$CSS=false;
+	$CSS=true;
+	$IE4=$IE3=$NS4=$NS3=$WIN=false;
+//	$NS4=1;
+
+	/* determine browser */
+/*	if (!isset($_SERVER[HTTP_USER_AGENT])) $_SERVER[HTTP_USER_AGENT]='none';
+	if (ereg('Win', $_SERVER[HTTP_USER_AGENT],$version)) $WIN=true;
+	if (ereg(&quot;MSIE.([0-9])&quot;, $_SERVER[HTTP_USER_AGENT],$version)) {
+		$ver=(int)$version[1];
+		if ($ver&gt;=4) $IE4=true;
+		elseif ($ver==3) $IE3=true;
+	} elseif (ereg(&quot;ozilla.([0-9])&quot;, $_SERVER[HTTP_USER_AGENT],$version)) {
+		$ver=(int)$version[1];
+		if ($ver&gt;=4) $NS4=true; 
+		elseif($ver==3) $NS3=true; 
+	}*/
+
+	/* determine browser */
+//	if (!isset($_SERVER[HTTP_USER_AGENT])) $_SERVER[HTTP_USER_AGENT]='none';
+//	if (eregi(&quot;Win&quot;,$_SERVER[HTTP_USER_AGENT])) $WIN=true;
+	if (preg_match('/MSIE [4-9]/i', $_SERVER['HTTP_USER_AGENT'])) {
+		$IE4=true;
+	} elseif (preg_match('/MSIE 3/i', $_SERVER['HTTP_USER_AGENT'])) {
+		$IE3=true;
+	} elseif (preg_match('/ozilla\/[5-9]/i', $_SERVER['HTTP_USER_AGENT'])) {
+		$NS6=true;
+	} elseif (preg_match('/ozilla\/4/i', $_SERVER['HTTP_USER_AGENT'])) {
+		$NS4=true; 
+	} elseif (preg_match('/ozilla\/3/i', $_SERVER['HTTP_USER_AGENT'])) {
+		$NS3=true; 
+	}
+?&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000995.html">[SVN] r2189 - trunk/web
</A></li>
	<LI>Next message: <A HREF="000997.html">[SVN] r2191 - in trunk/web: . user
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#996">[ date ]</a>
              <a href="thread.html#996">[ thread ]</a>
              <a href="subject.html#996">[ subject ]</a>
              <a href="author.html#996">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
