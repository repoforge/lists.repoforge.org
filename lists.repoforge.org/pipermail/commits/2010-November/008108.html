<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r9324 - in /trunk/elrepo/dag: cciss-kmod/ drbd83-kmod/ drbd83-utils/ gpfs-kmod/ lin_tape-kmod/ mhvtl-kmod/ mhvtl-utils/ ndiswrapper-kmod/ ndiswrapper-utils/ ocfs2-kmod/ ocfs2-tools/ open-vm-kmod/ open-vm-tools/
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r9324%20-%20in%20/trunk/elrepo/dag%3A%20cciss-kmod/%20drbd83-kmod/%0A%20drbd83-utils/%0A%20gpfs-kmod/%20lin_tape-kmod/%20mhvtl-kmod/%20mhvtl-utils/%20ndiswrapper-kmod/%0A%20ndiswrapper-utils/%20ocfs2-kmod/%20ocfs2-tools/%20open-vm-kmod/%20open-vm-tools/&In-Reply-To=%3C201011291526.oATFQZkw022537%40surya.karan.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008107.html">
   <LINK REL="Next"  HREF="008109.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r9324 - in /trunk/elrepo/dag: cciss-kmod/ drbd83-kmod/ drbd83-utils/ gpfs-kmod/ lin_tape-kmod/ mhvtl-kmod/ mhvtl-utils/ ndiswrapper-kmod/ ndiswrapper-utils/ ocfs2-kmod/ ocfs2-tools/ open-vm-kmod/ open-vm-tools/</H1>
    <B>Dag Wieers</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r9324%20-%20in%20/trunk/elrepo/dag%3A%20cciss-kmod/%20drbd83-kmod/%0A%20drbd83-utils/%0A%20gpfs-kmod/%20lin_tape-kmod/%20mhvtl-kmod/%20mhvtl-utils/%20ndiswrapper-kmod/%0A%20ndiswrapper-utils/%20ocfs2-kmod/%20ocfs2-tools/%20open-vm-kmod/%20open-vm-tools/&In-Reply-To=%3C201011291526.oATFQZkw022537%40surya.karan.org%3E"
       TITLE="[svn] r9324 - in /trunk/elrepo/dag: cciss-kmod/ drbd83-kmod/ drbd83-utils/ gpfs-kmod/ lin_tape-kmod/ mhvtl-kmod/ mhvtl-utils/ ndiswrapper-kmod/ ndiswrapper-utils/ ocfs2-kmod/ ocfs2-tools/ open-vm-kmod/ open-vm-tools/">dag at wieers.com
       </A><BR>
    <I>Mon Nov 29 16:26:35 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="008107.html">[svn] r9323 - in /trunk/elrepo: ./ dag/
</A></li>
        <LI>Next message: <A HREF="008109.html">[svn] r9325 - /trunk/elrepo/dag/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8108">[ date ]</a>
              <a href="thread.html#8108">[ thread ]</a>
              <a href="subject.html#8108">[ subject ]</a>
              <a href="author.html#8108">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dag
Date: Mon Nov 29 15:26:35 2010
New Revision: 9324

URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge?rev=9324&amp;view=rev">http://svn.rpmforge.net/viewvc/rpmforge?rev=9324&amp;view=rev</A>
Log:
Initial import of my EL5 SPEC files.

Added:
    trunk/elrepo/dag/cciss-kmod/
    trunk/elrepo/dag/cciss-kmod/cciss-kmod-el5.spec
    trunk/elrepo/dag/cciss-kmod/kmodtool-cciss-el5.sh
    trunk/elrepo/dag/drbd83-kmod/
    trunk/elrepo/dag/drbd83-kmod/drbd83-kmod-el5.spec   (with props)
    trunk/elrepo/dag/drbd83-kmod/kmodtool-drbd83-el5   (with props)
    trunk/elrepo/dag/drbd83-utils/
    trunk/elrepo/dag/drbd83-utils/drbd83-utils.spec   (with props)
    trunk/elrepo/dag/gpfs-kmod/
    trunk/elrepo/dag/lin_tape-kmod/
    trunk/elrepo/dag/lin_tape-kmod/kmodtool-lin_tape-el5
    trunk/elrepo/dag/lin_tape-kmod/lin_tape-98-lin_tape.permissions
    trunk/elrepo/dag/lin_tape-kmod/lin_tape-depmod.conf
    trunk/elrepo/dag/lin_tape-kmod/lin_tape-kmod-el5.spec
    trunk/elrepo/dag/mhvtl-kmod/
    trunk/elrepo/dag/mhvtl-utils/
    trunk/elrepo/dag/ndiswrapper-kmod/
    trunk/elrepo/dag/ndiswrapper-kmod/kmodtool-ndiswrapper-el5   (with props)
    trunk/elrepo/dag/ndiswrapper-kmod/ndiswrapper-kmod-el5.spec   (with props)
    trunk/elrepo/dag/ndiswrapper-utils/
    trunk/elrepo/dag/ndiswrapper-utils/ndiswrapper-utils.spec   (with props)
    trunk/elrepo/dag/ocfs2-kmod/
    trunk/elrepo/dag/ocfs2-kmod/kmodtool-ocfs2-el5   (with props)
    trunk/elrepo/dag/ocfs2-kmod/ocfs2-kmod-el5.spec   (with props)
    trunk/elrepo/dag/ocfs2-tools/
    trunk/elrepo/dag/ocfs2-tools/o2cb.init.sh   (with props)
    trunk/elrepo/dag/ocfs2-tools/o2cb.sysconfig   (with props)
    trunk/elrepo/dag/ocfs2-tools/ocfs2-tools.spec   (with props)
    trunk/elrepo/dag/ocfs2-tools/ocfs2.init   (with props)
    trunk/elrepo/dag/open-vm-kmod/
    trunk/elrepo/dag/open-vm-tools/

Added: trunk/elrepo/dag/cciss-kmod/cciss-kmod-el5.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/cciss-kmod/cciss-kmod-el5.spec?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/cciss-kmod/cciss-kmod-el5.spec?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/cciss-kmod/cciss-kmod-el5.spec (added)
+++ trunk/elrepo/dag/cciss-kmod/cciss-kmod-el5.spec Mon Nov 29 15:26:35 2010
@@ -1,0 +1,85 @@
+# Define the kmod package name here.
+%define  kmod_name cciss
+
+# If kversion isn't defined on the rpmbuild line, define it here.
+%{!?kversion:%define kversion 2.6.18-8.el5}
+
+%define real_version 3.6.20-20
+
+Name:    %{kmod_name}-kmod
+Version: 3.6.20.20
+Release: 1%{?dist}
+Group:   System Environment/Kernel
+License: GPL v2
+Summary: %{kmod_name} kernel module(s)
+URL:     <A HREF="http://www.kernel.org/">http://www.kernel.org/</A>
+
+BuildRoot:     %{_tmppath}/%{name}-%{version}-%{release}-build-%(%{__id_u} -n)
+ExclusiveArch: i686 x86_64
+
+# Sources.
+Source0:  <A HREF="http://dl.sf.net/project/cciss/cciss%203.6%20source%20tarballs/cciss-source-%{real_version">http://dl.sf.net/project/cciss/cciss%203.6%20source%20tarballs/cciss-source-%{real_version</A>}.tar.gz
+Source10: kmodtool-el5-%{kmod_name}.sh
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+# Disable the building of the debug package(s).
+%define debug_package %{nil}
+
+%description
+This package provides the %{kmod_name} kernel module(s).
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the Linux kernel and not on any one specific build.
+
+%prep
+%setup -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -a %{kmod_name}-source-%{real_version} _kmod_build_$kvariant
+    %{__cat} &lt;&lt;EOF &gt;_kmod_build_$kvariant/drivers/block/%{kmod_name}.conf
+override %{kmod_name} * weak-updates/%{kmod_name}
+EOF
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant/drivers/block
+#    %{__mv} -v Makefile_redhat Makefile
+    %{__make} -C &quot;${ksrc}&quot; %{?_smp_mflags} modules M=$PWD
+    popd
+done
+
+%install
+export INSTALL_MOD_PATH=$RPM_BUILD_ROOT
+export INSTALL_MOD_DIR=extra/%{kmod_name}
+for kvariant in %{kvariants} ; do
+    ksrc=%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant/drivers/block
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=$PWD
+    %{__install} -d ${INSTALL_MOD_PATH}/etc/depmod.d/
+    %{__install} %{kmod_name}.conf ${INSTALL_MOD_PATH}/etc/depmod.d/
+    popd
+done
+# Strip the module(s).
+find ${INSTALL_MOD_PATH} -type f -name \*.ko -exec %{__strip} --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf $RPM_BUILD_ROOT
+
+%changelog
+* Fri Aug 20 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 3.6.20.20-1
+- Initial el5 build of the kmod package.

Added: trunk/elrepo/dag/cciss-kmod/kmodtool-cciss-el5.sh
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/cciss-kmod/kmodtool-cciss-el5.sh?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/cciss-kmod/kmodtool-cciss-el5.sh?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/cciss-kmod/kmodtool-cciss-el5.sh (added)
+++ trunk/elrepo/dag/cciss-kmod/kmodtool-cciss-el5.sh Mon Nov 29 15:26:35 2010
@@ -1,0 +1,268 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Provides:         kabi-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+Conflicts:        module-init-tools = 3.3-0.pre3.1.60.el5
+EOF
+
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel module(s) built
+for the Linux kernel using the %{_target_cpu} family of processors.
+
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+echo &quot;Done.&quot;
+
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+    fi
+
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --remove-modules
+fi
+echo &quot;Done.&quot;
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;%config /etc/depmod.d/${kmod_name}.conf&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Added: trunk/elrepo/dag/drbd83-kmod/drbd83-kmod-el5.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/drbd83-kmod/drbd83-kmod-el5.spec?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/drbd83-kmod/drbd83-kmod-el5.spec?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/drbd83-kmod/drbd83-kmod-el5.spec (added)
+++ trunk/elrepo/dag/drbd83-kmod/drbd83-kmod-el5.spec Mon Nov 29 15:26:35 2010
@@ -1,0 +1,107 @@
+# $Id$
+# Authority: dag
+
+%{!?kversion: %define kversion 2.6.18-8.el5}
+
+# Define the kmod package name here.
+%define kmod_name drbd83
+%define short_name drbd
+
+Summary: Distributed Redundant Block Device driver for Linux
+Name: %{kmod_name}-kmod
+Version: 8.3.9
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="http://www.drbd.org/">http://www.drbd.org/</A>
+
+# Sources.
+Source0: <A HREF="http://oss.linbit.com/drbd/8.3/drbd-%{version">http://oss.linbit.com/drbd/8.3/drbd-%{version</A>}.tar.gz
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+### We cannot obsolete all Linbit drbd-km-%{kversion} variants
+Conflicts: kmod-drbd &lt; 8.2
+Obsoletes: kmod-drbd82 &lt;= %{version}-%{release}
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+Drbd is a distributed replicated block device. It mirrors a
+block device over the network to another machine. Think of it
+as networked raid 1. It is a building block for setting up
+high availability (HA) clusters.
+
+%prep
+%setup -c -T -a 0
+
+%define __find_requires sh %{_builddir}/%{buildsubdir}/filter-requires.sh
+echo &quot;/usr/lib/rpm/redhat/find-requires | sed -e '/^ksym.*/d'&quot; &gt;filter-requires.sh
+
+pushd %{short_name}-%{version}
+%configure \
+    --with-km \
+    --without-bashcompletion \
+    --without-heartbeat \
+    --without-pacemaker \
+    --without-rgmanager \
+    --without-udev \
+    --without-utils \
+    --without-xen
+popd
+for kvariant in %{kvariants} ; do
+    %{__cp} -a %{short_name}-%{version} _kmod_build_$kvariant
+    %{__cat} &lt;&lt;-EOF &gt;_kmod_build_$kvariant/drbd/%{kmod_name}.conf
+	override %{kmod_name} * weak-updates/%{kmod_name}
+	EOF
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    %{__make} -C _kmod_build_$kvariant KDIR=&quot;${ksrc}&quot; module
+done
+
+%install
+%{__rm} -rf %{buildroot}
+
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/drbd
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -Dp -m0644 %{kmod_name}.conf %{buildroot}/etc/depmod.d/%{kmod_name}.conf
+    popd
+done
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Fri Oct 22 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 8.3.9-1
+- Updated to release 8.3.9.
+
+* Sun Oct 03 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 8.3.8.1-1
+- Updated to release 8.3.8.1.
+
+* Fri Jun 11 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 8.3.8-1
+- Initial package. (using DAR)

Propchange: trunk/elrepo/dag/drbd83-kmod/drbd83-kmod-el5.spec
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/drbd83-kmod/kmodtool-drbd83-el5
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/drbd83-kmod/kmodtool-drbd83-el5?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/drbd83-kmod/kmodtool-drbd83-el5?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/drbd83-kmod/kmodtool-drbd83-el5 (added)
+++ trunk/elrepo/dag/drbd83-kmod/kmodtool-drbd83-el5 Mon Nov 29 15:26:35 2010
@@ -1,0 +1,281 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Provides:         kabi-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Requires: drbd83-utils &gt;= %{?epoch:%{epoch}:}%{version}
+
+### We cannot obsolete all Linbit drbd-km-%{kversion} variants
+Conflicts: kmod-drbd &lt; 8.2
+Obsoletes: kmod-drbd82 &lt;= %{version}-%{release}
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel module built
+for the Linux kernel using the %{_target_cpu} family of processors.
+
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+if [ &quot;\$1&quot; = &quot;1&quot; ]; then
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+echo &quot;Done.&quot;
+fi
+
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+    fi
+
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --remove-modules
+fi
+
+if [ &quot;\$1&quot; = &quot;1&quot; ]; then
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+fi
+echo &quot;Done.&quot;
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;%config /etc/depmod.d/${kmod_name}.conf&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: trunk/elrepo/dag/drbd83-kmod/kmodtool-drbd83-el5
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/drbd83-utils/drbd83-utils.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/drbd83-utils/drbd83-utils.spec?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/drbd83-utils/drbd83-utils.spec?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/drbd83-utils/drbd83-utils.spec (added)
+++ trunk/elrepo/dag/drbd83-utils/drbd83-utils.spec Mon Nov 29 15:26:35 2010
@@ -1,0 +1,167 @@
+# $Id$
+# Authority: dag
+
+%define real_name drbd
+
+Summary: Management utilities for DRBD %{version}
+Name: drbd83-utils
+Version: 8.3.9
+Release: 1%{?dist}
+License: GPLv2+
+Group: System Environment/Kernel
+URL: <A HREF="http://www.drbd.org/">http://www.drbd.org/</A>
+
+Source: <A HREF="http://oss.linbit.com/drbd/8.3/drbd-%{version">http://oss.linbit.com/drbd/8.3/drbd-%{version</A>}.tar.gz
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+BuildRequires: flex
+BuildRequires: udev
+Requires: chkconfig
+Requires: udev
+
+### Virtual provides that people may use
+Provides: drbd = %{version}-%{release}
+Provides: drbd83 = %{version}-%{release}
+
+### Package drbd from CentOS is drbd 8.0, but from Linbit is 8.2 or 8.3
+Conflicts: drbd &lt; 8.2
+Conflicts: drbd-utils &lt; 8.2
+
+### Obsolete packages from Linbit (included in this package)
+Obsoletes: drbd &lt;= %{version}-%{release}
+Obsoletes: drbd-bash-completion &lt;= %{version}-%{release}
+Obsoletes: drbd-heartbeat &lt;= %{version}-%{release}
+Obsoletes: drbd-pacemaker &lt;= %{version}-%{release}
+Obsoletes: drbd-rgmanager &lt;= %{version}-%{release}
+Obsoletes: drbd-udev &lt;= %{version}-%{release}
+Obsoletes: drbd-utils &lt;= %{version}-%{release}
+Obsoletes: drbd-xen &lt;= %{version}-%{release}
+
+### Upgrade path from CentOS drbd82 to drbd83 is guaranteed
+Obsoletes: drbd82 &lt;= %{version}-%{release}
+Obsoletes: drbd82-bash-completion &lt;= %{version}-%{release}
+Obsoletes: drbd82-heartbeat &lt;= %{version}-%{release}
+Obsoletes: drbd82-pacemaker &lt;= %{version}-%{release}
+Obsoletes: drbd82-rgmanager &lt;= %{version}-%{release}
+Obsoletes: drbd82-udev &lt;= %{version}-%{release}
+Obsoletes: drbd82-utils &lt;= %{version}-%{release}
+Obsoletes: drbd82-xen &lt;= %{version}-%{release}
+
+### Obsolete older CentOS packages
+Obsoletes: drbd83 &lt;= %{version}-%{release}
+
+%description
+DRBD mirrors a block device over the network to another machine.
+Think of it as networked raid 1. It is a building block for
+setting up high availability (HA) clusters.
+
+This packages includes the DRBD administration tools and integration
+scripts for heartbeat, pacemaker, rgmanager and xen.
+
+%prep
+%setup -n %{real_name}-%{version}
+
+%build
+%configure \
+    --without-km \
+    --with-initdir=&quot;%{_initrddir}&quot; \
+    --with-rgmanager \
+    --with-utils
+%{__make} %{?_smp_mflags}
+
+%install
+%{__rm} -rf %{buildroot}
+%{__make} install DESTDIR=&quot;%{buildroot}&quot;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%post
+/sbin/chkconfig --add drbd
+
+for i in $(seq 0 15); do
+    if [ ! -b /dev/drbd$i ]; then
+        mknod -m0660 /dev/drbd$i b 147 $i
+    fi
+done
+
+if /usr/bin/getent group | grep -q ^haclient; then
+   chgrp haclient /sbin/drbdsetup
+   chmod o-x,u+s /sbin/drbdsetup
+   chgrp haclient /sbin/drbdmeta
+   chmod o-x,u+s /sbin/drbdmeta
+fi
+
+%preun
+if [ $1 -eq 0 ]; then
+    %{_initrddir}/drbd stop &amp;&gt;/dev/null
+    /sbin/chkconfig --del drbd
+fi
+
+%files
+%defattr(-, root, root, 0755)
+%doc ChangeLog COPYING README scripts/drbd.conf.example
+%doc %{_mandir}/man5/drbd.conf.5*
+%doc %{_mandir}/man8/drbd.8*
+%doc %{_mandir}/man8/drbdadm.8*
+%doc %{_mandir}/man8/drbddisk.8*
+%doc %{_mandir}/man8/drbdmeta.8*
+%doc %{_mandir}/man8/drbdsetup.8*
+%config %{_initrddir}/drbd
+%config %{_sysconfdir}/bash_completion.d/drbdadm*
+%config %{_sysconfdir}/udev/rules.d/65-drbd.rules*
+%config(noreplace) %{_sysconfdir}/drbd.conf
+%dir %{_sysconfdir}/drbd.d/
+%config(noreplace) %{_sysconfdir}/drbd.d/global_common.conf
+%dir %{_localstatedir}/lib/drbd/
+/sbin/drbdsetup
+/sbin/drbdadm
+/sbin/drbdmeta
+%{_sbindir}/drbd-overview
+%dir %{_prefix}/lib/drbd/
+%{_prefix}/lib/drbd/outdate-peer.sh
+%{_prefix}/lib/drbd/snapshot-resync-target-lvm.sh
+%{_prefix}/lib/drbd/unsnapshot-resync-target-lvm.sh
+%{_prefix}/lib/drbd/notify-out-of-sync.sh
+%{_prefix}/lib/drbd/notify-split-brain.sh
+%{_prefix}/lib/drbd/notify-emergency-reboot.sh
+%{_prefix}/lib/drbd/notify-emergency-shutdown.sh
+%{_prefix}/lib/drbd/notify-io-error.sh
+%{_prefix}/lib/drbd/notify-pri-lost-after-sb.sh
+%{_prefix}/lib/drbd/notify-pri-lost.sh
+%{_prefix}/lib/drbd/notify-pri-on-incon-degr.sh
+%{_prefix}/lib/drbd/notify.sh
+
+### heartbeat
+%{_sysconfdir}/ha.d/resource.d/drbddisk
+%{_sysconfdir}/ha.d/resource.d/drbdupper
+
+### pacemaker
+%{_prefix}/lib/drbd/crm-fence-peer.sh
+%{_prefix}/lib/drbd/crm-unfence-peer.sh
+%{_prefix}/lib/ocf/resource.d/linbit/drbd
+
+### rgmanager
+%{_datadir}/cluster/drbd.sh
+%{_datadir}/cluster/drbd.metadata
+
+### xen
+%{_sysconfdir}/xen/scripts/block-drbd
+
+%changelog
+* Fri Oct 22 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 8.3.9-1
+- Updated to release 8.3.9.
+
+* Sun Oct 03 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 8.3.8.1-1
+- Updated to release 8.3.8.1.
+
+* Tue Jun 15 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 8.3.8-3
+- Added rgmanager scripts (not enabled by default). (Joseph L. Casale)
+
+* Tue Jun 15 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 8.3.8-2
+- Create block devices in %%post.
+- Unload module after stop to warn user that it may be used.
+- Better heartbeat integration (using group haclient).
+
+* Fri Jun 11 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 8.3.8-1
+- Initial package. (using DAR)

Propchange: trunk/elrepo/dag/drbd83-utils/drbd83-utils.spec
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/lin_tape-kmod/kmodtool-lin_tape-el5
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/lin_tape-kmod/kmodtool-lin_tape-el5?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/lin_tape-kmod/kmodtool-lin_tape-el5?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/lin_tape-kmod/kmodtool-lin_tape-el5 (added)
+++ trunk/elrepo/dag/lin_tape-kmod/kmodtool-lin_tape-el5 Mon Nov 29 15:26:35 2010
@@ -1,0 +1,280 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Provides:         kabi-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel module built
+for the Linux kernel using the %{_target_cpu} family of processors.
+
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+if [ &quot;\$1&quot; = &quot;1&quot; ]; then
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+echo &quot;Done.&quot;
+fi
+
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+    fi
+
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --remove-modules
+fi
+
+if [ &quot;\$1&quot; = &quot;1&quot; ]; then
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+fi
+echo &quot;Done.&quot;
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;%doc COPYING* lin_tape.fixlist lin_tape_*.ReadMe messages&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;%config /etc/depmod.d/${kmod_name}.conf&quot;
+#    echo &quot;%config %{_sysconfdir}/udev/rules/98-lin_tape.rules&quot;
+    echo &quot;%config %{_sysconfdir}/udev/permissions.d/98-lin_tape.permissions&quot;
+#    echo &quot;%{_sbindir}/udev.get_lin_tape_id.sh&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Added: trunk/elrepo/dag/lin_tape-kmod/lin_tape-98-lin_tape.permissions
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/lin_tape-kmod/lin_tape-98-lin_tape.permissions?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/lin_tape-kmod/lin_tape-98-lin_tape.permissions?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/lin_tape-kmod/lin_tape-98-lin_tape.permissions (added)
+++ trunk/elrepo/dag/lin_tape-kmod/lin_tape-98-lin_tape.permissions Mon Nov 29 15:26:35 2010
@@ -1,0 +1,2 @@
+IBMtape*:root:root:666
+IBMchanger*:root:root:666

Added: trunk/elrepo/dag/lin_tape-kmod/lin_tape-depmod.conf
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/lin_tape-kmod/lin_tape-depmod.conf?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/lin_tape-kmod/lin_tape-depmod.conf?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/lin_tape-kmod/lin_tape-depmod.conf (added)
+++ trunk/elrepo/dag/lin_tape-kmod/lin_tape-depmod.conf Mon Nov 29 15:26:35 2010
@@ -1,0 +1,9 @@
+#
+# lin_tape.conf
+#
+
+# Add on (replacement) lin_tape IBM TotalStorage / SystemStorage driver
+
+# override default search ordering for kmod packaging
+override lin_tape * weak-updates/lin_tape
+

Added: trunk/elrepo/dag/lin_tape-kmod/lin_tape-kmod-el5.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/lin_tape-kmod/lin_tape-kmod-el5.spec?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/lin_tape-kmod/lin_tape-kmod-el5.spec?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/lin_tape-kmod/lin_tape-kmod-el5.spec (added)
+++ trunk/elrepo/dag/lin_tape-kmod/lin_tape-kmod-el5.spec Mon Nov 29 15:26:35 2010
@@ -1,0 +1,100 @@
+# $Id$
+# Authority: dag
+
+%{!?kversion:%define kversion 2.6.18-8.el5}
+
+# Define the kmod package name here.
+%define kmod_name lin_tape
+
+Summary: IBM Tape SCSI Device Driver for Linux
+Name: lin_tape-kmod
+Version: 1.41.1
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/">ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/</A>
+
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+ExclusiveArch: i686 x86_64
+
+# Sources.
+Source0: <A HREF="http://delivery04.dhe.ibm.com/sar/CMA/STA/010nr/0/lin_tape-1.41.1-1.src.rpm">http://delivery04.dhe.ibm.com/sar/CMA/STA/010nr/0/lin_tape-1.41.1-1.src.rpm</A>
+#Source0: <A HREF="ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/lin_tape/lin_tape-%{version">ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/lin_tape/lin_tape-%{version</A>}-1.src.rpm.bin
+Source1: lin_tape-depmod.conf
+Source2: lin_tape-98-lin_tape.permissions
+Source10: kmodtool-%{kmod_name}
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the The IBM Tape Device Driver driver module for
+IBM TotalStorage and SystemStorage tape devices.
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the Linux kernel and not on any one specific build.
+
+%prep
+%setup -c -T
+rpm2cpio %{SOURCE0} | cpio -i -d --verbose
+tar -xvzf lin_tape-%{version}.tgz
+for kvariant in %{kvariants} ; do
+    %{__cp} -a %{kmod_name}-%{version} _kmod_build_$kvariant
+    %{__cat} &lt;&lt;-EOF &gt;_kmod_build_$kvariant/%{kmod_name}.conf
+override %{kmod_name} * weak-updates/%{kmod_name}
+EOF
+done
+
+### Move documentation in place
+(cd %{kmod_name}-%{version}; %{__cp} -av COPYING* lin_tape.fixlist lin_tape_*.ReadMe messages ..)
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant
+    %{__make} -C &quot;${ksrc}&quot; modules M=&quot;$PWD&quot;
+    popd
+done
+
+%install
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -Dp -m0644 %{kmod_name}.conf %{buildroot}%{_sysconfdir}/depmod.d/%{kmod_name}.conf
+    popd
+done
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+### The udev stuff was removed somewhere after 1.34.0 (no longer necessary?)
+#%{__install} -Dp -m0644 %{kmod_name}-%{version}/98-lin_tape.rules %{buildroot}%{_sysconfdir}/udev/rules/98-lin_tape.rules
+#%{__install} -Dp -m0755 %{kmod_name}-%{version}/udev.get_lin_tape_id.sh %{buildroot}%{_sbindir}/udev.get_lin_tape_id.sh
+%{__install} -Dp -m0644 %{SOURCE2} %{buildroot}%{_sysconfdir}/udev/permissions.d/98-lin_tape.permissions
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Thu Aug 12 2010 Dag Wie&#195;&#171;rs &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 1.41.1-1
+- Updated to release 1.41.1.
+
+* Fri Jun 18 2010 Dag Wie&#195;&#171;rs &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 1.34.0-1
+- Updated to release 1.34.0.
+
+* Tue Jan 12 2010 Philip J Perry &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at elrepo.org</A>&gt; - 1.29.0-1
+- Initial build of the kmod package.

Added: trunk/elrepo/dag/ndiswrapper-kmod/kmodtool-ndiswrapper-el5
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ndiswrapper-kmod/kmodtool-ndiswrapper-el5?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ndiswrapper-kmod/kmodtool-ndiswrapper-el5?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ndiswrapper-kmod/kmodtool-ndiswrapper-el5 (added)
+++ trunk/elrepo/dag/ndiswrapper-kmod/kmodtool-ndiswrapper-el5 Mon Nov 29 15:26:35 2010
@@ -1,0 +1,277 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Provides:         kabi-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Requires: ndiswrapper-utils &gt;= %{?epoch:%{epoch}:}%{version}
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel module built
+for the Linux kernel using the %{_target_cpu} family of processors.
+
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+if [ &quot;\$1&quot; = &quot;1&quot; ]; then
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+echo &quot;Done.&quot;
+fi
+
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+    fi
+
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --remove-modules
+fi
+
+if [ &quot;\$1&quot; = &quot;1&quot; ]; then
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+fi
+echo &quot;Done.&quot;
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;%config /etc/depmod.d/${kmod_name}.conf&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: trunk/elrepo/dag/ndiswrapper-kmod/kmodtool-ndiswrapper-el5
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/ndiswrapper-kmod/ndiswrapper-kmod-el5.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ndiswrapper-kmod/ndiswrapper-kmod-el5.spec?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ndiswrapper-kmod/ndiswrapper-kmod-el5.spec?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ndiswrapper-kmod/ndiswrapper-kmod-el5.spec (added)
+++ trunk/elrepo/dag/ndiswrapper-kmod/ndiswrapper-kmod-el5.spec Mon Nov 29 15:26:35 2010
@@ -1,0 +1,96 @@
+# $Id$
+# Authority: dag
+
+%define kversion 2.6.18-8.el5
+
+# Define the kmod package name here.
+%define kmod_name ndiswrapper
+
+Summary: %{kmod_name} kernel modules
+Name: %{kmod_name}-kmod
+Version: 1.56
+Release: 1%{?dist}
+License: GPL v2
+Group: System Environment/Kernel
+URL: <A HREF="http://ndiswrapper.sourceforge.net/">http://ndiswrapper.sourceforge.net/</A>
+
+# Sources.
+Source0: <A HREF="http://heanet.dl.sourceforge.net/project/ndiswrapper/stable/%{version">http://heanet.dl.sourceforge.net/project/ndiswrapper/stable/%{version</A>}/ndiswrapper-%{version}.tar.gz
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+# If kversion isn't defined on the rpmbuild line, build for the current kernel.
+%{!?kversion: %define kversion %(uname -r)}
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the %{kmod_name} kernel modules.
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the Linux kernel and not on any one specific build.
+
+%prep
+%setup -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -a %{kmod_name}-%{version} _kmod_build_$kvariant
+    %{__cat} &lt;&lt;-EOF &gt;_kmod_build_$kvariant/driver/%{kmod_name}.conf
+	override %{kmod_name} * weak-updates/%{kmod_name}
+	EOF
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    %{__make} -C _kmod_build_$kvariant KVERS=&quot;%{kversion}&quot; KBUILD=&quot;${ksrc}&quot;
+done
+
+%install
+%{__rm} -rf %{buildroot}
+
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/driver
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -Dp -m0644 %{kmod_name}.conf %{buildroot}/etc/depmod.d/%{kmod_name}.conf
+    popd
+done
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Wed Jun 16 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 1.56-1
+- Updated to release 1.56.
+
+* Fri Oct 23 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 1.54-4
+- Revised the kmodtool file and this spec file.
+
+* Fri Oct 09 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 1.54-3
+- Revised the kmodtool file and this spec file.
+
+* Mon Aug 17 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 1.54-2
+- Revised the kmodtool file and this spec file.
+
+* Thu May 07 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 1.54-1
+- Initial build of the kmod packages.
+

Propchange: trunk/elrepo/dag/ndiswrapper-kmod/ndiswrapper-kmod-el5.spec
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/ndiswrapper-utils/ndiswrapper-utils.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ndiswrapper-utils/ndiswrapper-utils.spec?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ndiswrapper-utils/ndiswrapper-utils.spec?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ndiswrapper-utils/ndiswrapper-utils.spec (added)
+++ trunk/elrepo/dag/ndiswrapper-utils/ndiswrapper-utils.spec Mon Nov 29 15:26:35 2010
@@ -1,0 +1,59 @@
+# $Id$
+# Authority: dag
+
+%define real_name ndiswrapper
+
+Summary: Ndiswrapper utilities
+Name: ndiswrapper-utils
+Version: 1.56
+Release: 1%{?dist}
+License: GPL v2
+Group: System Environment/Kernel
+URL: <A HREF="http://ndiswrapper.sourceforge.net/">http://ndiswrapper.sourceforge.net/</A>
+
+Source: <A HREF="http://heanet.dl.sourceforge.net/project/ndiswrapper/stable/%{version">http://heanet.dl.sourceforge.net/project/ndiswrapper/stable/%{version</A>}/ndiswrapper-%{version}.tar.gz
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+%description
+This package provides the utilities to use the ndiswrapper kernel module.
+
+%prep
+%setup -n %{real_name}-%{version}
+
+### Disable driver build
+echo &quot;install:&quot; &gt;driver/Makefile
+
+%build
+%{__make}
+
+%install
+%{__rm} -rf %{buildroot}
+%{__make} install DESTDIR=&quot;%{buildroot}&quot;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%files
+%defattr(-, root, root, 0755)
+%doc AUTHORS ChangeLog
+%doc %{_mandir}/man8/loadndisdriver.8*
+%doc %{_mandir}/man8/ndiswrapper.8*
+/sbin/loadndisdriver
+%{_sbindir}/ndiswrapper
+%{_sbindir}/ndiswrapper-buginfo
+
+%changelog
+* Wed Jun 16 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 1.56-1
+- Updated to release 1.56.
+
+* Fri Oct 23 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 1.54-4
+- Revised the kmodtool file and this spec file.
+
+* Fri Oct 09 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 1.54-3
+- Revised the kmodtool file and this spec file.
+
+* Mon Aug 17 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 1.54-2
+- Revised the kmodtool file and this spec file.
+
+* Thu May 07 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt; - 1.54-1
+- Initial build of the kmod packages.

Propchange: trunk/elrepo/dag/ndiswrapper-utils/ndiswrapper-utils.spec
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/ocfs2-kmod/kmodtool-ocfs2-el5
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-kmod/kmodtool-ocfs2-el5?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-kmod/kmodtool-ocfs2-el5?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ocfs2-kmod/kmodtool-ocfs2-el5 (added)
+++ trunk/elrepo/dag/ocfs2-kmod/kmodtool-ocfs2-el5 Mon Nov 29 15:26:35 2010
@@ -1,0 +1,280 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Provides:         kabi-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+Provides:         ocfs2 = %{version}-%{release}
+Obsoletes:        ocfs2 &lt; %{version}
+EOF
+
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Requires: kernel${dashvariant} &gt;= 2.6.18-92.el5
+Requires: ocfs2-tools
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel module built
+for the Linux kernel using the %{_target_cpu} family of processors.
+
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+if [ &quot;\$1&quot; = &quot;1&quot; ]; then
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+echo &quot;Done.&quot;
+fi
+
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+    fi
+
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working. This may take some time ...&quot;
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --remove-modules
+fi
+
+if [ &quot;\$1&quot; = &quot;1&quot; ]; then
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; | /sbin/weak-modules --add-modules
+fi
+fi
+echo &quot;Done.&quot;
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;%config /etc/depmod.d/${kmod_name}.conf&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: trunk/elrepo/dag/ocfs2-kmod/kmodtool-ocfs2-el5
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/ocfs2-kmod/ocfs2-kmod-el5.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-kmod/ocfs2-kmod-el5.spec?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-kmod/ocfs2-kmod-el5.spec?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ocfs2-kmod/ocfs2-kmod-el5.spec (added)
+++ trunk/elrepo/dag/ocfs2-kmod/ocfs2-kmod-el5.spec Mon Nov 29 15:26:35 2010
@@ -1,0 +1,102 @@
+# $Id$
+# Authority: dag
+
+### Version 1.4.7 needs at least kernel 2.6.18-92.el5
+%define kversion 2.6.18-92.el5
+
+# Define the kmod package name here.
+%define kmod_name ocfs2
+
+Summary: OCFS2 driver module
+Name: %{kmod_name}-kmod
+Version: 1.4.7
+Release: 1%{?dist}
+License: GPL v2
+Group: System Environment/Kernel
+URL: <A HREF="http://oss.oracle.com/projects/ocfs2/">http://oss.oracle.com/projects/ocfs2/</A>
+
+# Sources.
+Source0: <A HREF="http://oss.oracle.com/projects/ocfs2/dist/files/source/v1.4/%{kmod_name">http://oss.oracle.com/projects/ocfs2/dist/files/source/v1.4/%{kmod_name</A>}-%{version}.tar.gz
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+# If kversion isn't defined on the rpmbuild line, build for the current kernel.
+%{!?kversion: %define kversion %(uname -r)}
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the kernel OCFS2 driver module.
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the CentOS kernel and not on any one specific build.
+
+OCFS2 is a POSIX-compliant shared-disk cluster file system for Linux
+capable of providing both high performance and high availability.
+
+%prep
+%setup -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -a %{kmod_name}-%{version} _kmod_build_$kvariant
+    %{__cat} &lt;&lt;-EOF &gt;_kmod_build_$kvariant/fs/%{kmod_name}.conf
+	override %{kmod_name} * weak-updates/%{kmod_name}
+	override %{kmod_name}_nodemanager * weak-updates/%{kmod_name}/cluster
+	override %{kmod_name}_dlm * weak-updates/%{kmod_name}/dlm
+	override %{kmod_name}_dlmfs * weak-updates/%{kmod_name}/dlm
+	EOF
+    pushd _kmod_build_$kvariant
+    %configure --with-vendor=&quot;rhel5&quot; --with-vendorkernel=&quot;%{kversion}&quot;
+    popd
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/fs
+    %{__make} -C &quot;${ksrc}&quot; modules M=&quot;$PWD&quot;
+    popd
+done
+
+%install
+%{__rm} -rf %{buildroot}
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/fs
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -Dp -m0644 %{kmod_name}.conf %{buildroot}/etc/depmod.d/%{kmod_name}.conf
+    popd
+done
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Wed Jun 16 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 1.4.7-1
+- Updated to release 1.4.7.
+
+* Wed Aug 12 2009 Philip J Perry &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at elrepo.org</A>&gt; - 1.4.2-2
+- Fixed dependencies.
+- Fixed install path.
+- Fixed configure options.
+
+* Tue Aug 04 2009 Philip J Perry &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at elrepo.org</A>&gt; - 1.4.2-1
+- Initial build of the kmod package.

Propchange: trunk/elrepo/dag/ocfs2-kmod/ocfs2-kmod-el5.spec
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/ocfs2-tools/o2cb.init.sh
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-tools/o2cb.init.sh?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-tools/o2cb.init.sh?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ocfs2-tools/o2cb.init.sh (added)
+++ trunk/elrepo/dag/ocfs2-tools/o2cb.init.sh Mon Nov 29 15:26:35 2010
@@ -1,0 +1,1545 @@
+#!/bin/bash
+# init fragment for O2CB.
+#
+# chkconfig: 2345 24 20
+# description: Load O2CB cluster services at system boot.
+#
+### BEGIN INIT INFO
+# Provides: o2cb
+# Required-Start: $network
+# Should-Start:
+# Required-Stop:
+# Default-Start: 2 3 5
+# Default-Stop:
+# Short-Description: Load O2CB cluster services at system boot.
+# Description: Load O2CB cluster services at system boot.
+### END INIT INFO
+
+# Force LC_ALL=C
+export LC_ALL=C
+
+# Let's try to use the LSB functions
+. /lib/lsb/init-functions
+if [ $? != 0 ]
+then
+    echo &quot;Unable to load LSB init functions&quot; &gt;&amp;2
+    exit 1
+fi
+
+CLUSTERCONF=/etc/ocfs2/cluster.conf
+
+OCFS2_SYS_DIR=&quot;/sys/fs/ocfs2&quot;
+LOADED_PLUGINS_FILE=&quot;${OCFS2_SYS_DIR}/loaded_cluster_plugins&quot;
+CLUSTER_STACK_FILE=&quot;${OCFS2_SYS_DIR}/cluster_stack&quot;
+
+if [ -f /etc/sysconfig/o2cb ]
+then
+    # Red Hat and Novell
+    CONFIGURATION=/etc/sysconfig/o2cb
+elif [ -f /etc/default/o2cb ]
+then
+    # Debian
+    CONFIGURATION=/etc/default/o2cb
+    DPKGRECONF=yes
+elif [ -d /etc/sysconfig ]
+then
+    CONFIGURATION=/etc/sysconfig/o2cb
+else
+    CONFIGURATION=/etc/default/o2cb
+fi
+
+# How long to wait for things to start
+BRINGUP_TIMEOUT=5
+
+# The default values should always be in sync with the kernel
+DEF_HEARTBEAT_THRESHOLD=31
+DEF_IDLE_TIMEOUT_MS=30000
+DEF_KEEPALIVE_DELAY_MS=2000
+DEF_RECONNECT_DELAY_MS=2000
+
+# Minimum timeout values
+MIN_HEARTBEAT_THRESHOLD=7
+MIN_IDLE_TIMEOUT_MS=5000
+MIN_KEEPALIVE_DELAY_MS=1000
+MIN_RECONNECT_DELAY_MS=2000
+
+VERSION=@@VERSION@@
+
+# Source configuration
+[ -f &quot;${CONFIGURATION}&quot; ] &amp;&amp; . &quot;${CONFIGURATION}&quot;
+# Need this default
+[ -z &quot;$O2CB_STACK&quot; ] &amp;&amp; O2CB_STACK=o2cb
+
+configfs_path()
+{
+    # Note that this is only valid *after* configfs is loaded
+    if [ -d /sys/kernel/config ]
+    then
+        echo /sys/kernel/config
+    else
+        echo /config
+    fi
+}
+
+
+#
+# if_fail()
+#
+# Evaluates return codes.  If 0, prints &quot;OK&quot;, if 1, prints &quot;Failed&quot;
+# and exits.  If 2, status is &quot;already done&quot; and nothing is printed.
+# The rest of the functions in here all honor this convention.
+#
+if_fail()
+{
+    RC=&quot;$1&quot;
+    REASON=&quot;$2&quot;
+    if [ &quot;$RC&quot; = &quot;0&quot; ]
+    then
+        echo &quot;OK&quot;
+        return
+    elif [ &quot;$RC&quot; = &quot;2&quot; ]
+    then
+        return
+    fi
+    echo &quot;Failed&quot;
+    if [ -n &quot;${REASON}&quot; ]
+    then
+        echo &quot;${REASON}&quot; &gt;&amp;2
+    fi
+    exit 1
+}
+
+
+#
+# write_sysconfig()
+#
+# Writes the system configuration out
+#
+write_sysconfig()
+{
+    echo -n &quot;Writing O2CB configuration: &quot;
+    cat &gt;&quot;${CONFIGURATION}&quot; &lt;&lt;EOF
+#
+# This is a configuration file for automatic startup of the O2CB
+# driver.  It is generated by running /etc/init.d/o2cb configure.
+# On Debian based systems the preferred method is running
+# 'dpkg-reconfigure ocfs2-tools'.
+#
+
+# O2CB_ENABLED: 'true' means to load the driver on boot.
+O2CB_ENABLED=${O2CB_ENABLED:-false}
+
+# O2CB_STACK: The name of the cluster stack backing O2CB.
+O2CB_STACK=${O2CB_STACK}
+
+# O2CB_BOOTCLUSTER: If not empty, the name of a cluster to start.
+O2CB_BOOTCLUSTER=${O2CB_BOOTCLUSTER}
+
+# O2CB_HEARTBEAT_THRESHOLD: Iterations before a node is considered dead.
+O2CB_HEARTBEAT_THRESHOLD=${O2CB_HEARTBEAT_THRESHOLD}
+
+# O2CB_IDLE_TIMEOUT_MS: Time in ms before a network connection is considered dead.
+O2CB_IDLE_TIMEOUT_MS=${O2CB_IDLE_TIMEOUT_MS}
+
+# O2CB_KEEPALIVE_DELAY_MS: Max time in ms before a keepalive packet is sent
+O2CB_KEEPALIVE_DELAY_MS=${O2CB_KEEPALIVE_DELAY_MS}
+
+# O2CB_RECONNECT_DELAY_MS: Min time in ms between connection attempts
+O2CB_RECONNECT_DELAY_MS=${O2CB_RECONNECT_DELAY_MS}
+
+EOF
+
+    if [ $? != 0 ]
+    then
+        return 1
+    fi
+    return 0
+}
+
+#
+# read_timeout()
+#   Returns timeout value provided by user to caller in RET_VAL
+#
+read_timeout()
+{
+    if [ &quot;$#&quot; -lt &quot;4&quot; ]; then
+        echo &quot;read_timeout(): Requires more arguments&quot; &gt;&amp;2
+        exit 1
+    fi
+
+    ATTRIB_NAME=$1
+    ATTRIB_VAL=$2
+    MIN_ATTRIB_VAL=$3
+    DEF_ATTRIB_VAL=$4
+    RET_VAL=0
+
+    while :
+    do
+        if [ -z $ATTRIB_VAL ]; then
+            CUR=$DEF_ATTRIB_VAL
+        else
+            CUR=$ATTRIB_VAL
+        fi
+        echo -n &quot;Specify ${ATTRIB_NAME} (&gt;=$MIN_ATTRIB_VAL) [$CUR]: &quot;
+        read LINE
+        case &quot;$LINE&quot; in
+        &quot;&quot;)
+            RET_VAL=&quot;$ATTRIB_VAL&quot;
+            break
+            ;;
+
+        *[^0-9]*)
+            echo &quot;Invalid ${ATTRIB_NAME} value: $LINE&quot; &gt;&amp;2
+            ;;
+        *)
+            if [ $LINE -lt $MIN_ATTRIB_VAL ]; then
+                echo &quot;${ATTRIB_NAME} cannot be less than $MIN_ATTRIB_VAL&quot; &gt;&amp;2
+            else
+                RET_VAL=&quot;$LINE&quot;
+                break
+            fi
+            ;;
+        esac
+    done
+}
+
+set_timeouts()
+{
+    O2CB_HEARTBEAT_THRESHOLD_FILE_OLD=/proc/fs/ocfs2_nodemanager/hb_dead_threshold
+    O2CB_HEARTBEAT_THRESHOLD_FILE=$(configfs_path)/cluster/${CLUSTER}/heartbeat/dead_threshold
+    if [ -n &quot;$O2CB_HEARTBEAT_THRESHOLD&quot; ]; then
+        if [ -f &quot;$O2CB_HEARTBEAT_THRESHOLD_FILE&quot; ]; then
+            echo &quot;$O2CB_HEARTBEAT_THRESHOLD&quot; &gt; &quot;$O2CB_HEARTBEAT_THRESHOLD_FILE&quot;
+        elif [ -f &quot;$O2CB_HEARTBEAT_THRESHOLD_FILE_OLD&quot; ]; then
+            echo &quot;$O2CB_HEARTBEAT_THRESHOLD&quot; &gt; &quot;$O2CB_HEARTBEAT_THRESHOLD_FILE_OLD&quot;
+        fi
+    fi
+
+    O2CB_IDLE_TIMEOUT_MS_FILE=$(configfs_path)/cluster/${CLUSTER}/idle_timeout_ms
+    if [ -n &quot;$O2CB_IDLE_TIMEOUT_MS&quot; ]; then
+        if [ -f &quot;$O2CB_IDLE_TIMEOUT_MS_FILE&quot; ]; then
+            echo &quot;$O2CB_IDLE_TIMEOUT_MS&quot; &gt; &quot;$O2CB_IDLE_TIMEOUT_MS_FILE&quot;
+        fi
+    fi
+
+    O2CB_KEEPALIVE_DELAY_MS_FILE=$(configfs_path)/cluster/${CLUSTER}/keepalive_delay_ms
+    if [ -n &quot;$O2CB_KEEPALIVE_DELAY_MS&quot; ]; then
+        if [ -f &quot;$O2CB_KEEPALIVE_DELAY_MS_FILE&quot; ]; then
+            echo &quot;$O2CB_KEEPALIVE_DELAY_MS&quot; &gt; &quot;$O2CB_KEEPALIVE_DELAY_MS_FILE&quot;
+        fi
+    fi
+
+    O2CB_RECONNECT_DELAY_MS_FILE=$(configfs_path)/cluster/${CLUSTER}/reconnect_delay_ms
+    if [ -n &quot;$O2CB_RECONNECT_DELAY_MS&quot; ]; then
+        if [ -f &quot;$O2CB_RECONNECT_DELAY_MS_FILE&quot; ]; then
+            echo &quot;$O2CB_RECONNECT_DELAY_MS&quot; &gt; &quot;$O2CB_RECONNECT_DELAY_MS_FILE&quot;
+        fi
+    fi
+}
+
+show_timeouts()
+{
+
+    O2CB_HEARTBEAT_THRESHOLD_FILE_OLD=/proc/fs/ocfs2_nodemanager/hb_dead_threshold
+    O2CB_HEARTBEAT_THRESHOLD_FILE=$(configfs_path)/cluster/${CLUSTER}/heartbeat/dead_threshold
+    if [ -f &quot;$O2CB_HEARTBEAT_THRESHOLD_FILE&quot; ]; then
+        VAL=`cat &quot;$O2CB_HEARTBEAT_THRESHOLD_FILE&quot;`
+        echo &quot;Heartbeat dead threshold = ${VAL}&quot;
+    elif [ -f &quot;$O2CB_HEARTBEAT_THRESHOLD_FILE_OLD&quot; ]; then
+        VAL=`cat &quot;$O2CB_HEARTBEAT_THRESHOLD_FILE_OLD&quot;`
+        echo &quot;  Heartbeat dead threshold: ${VAL}&quot;
+    fi
+
+    O2CB_IDLE_TIMEOUT_MS_FILE=$(configfs_path)/cluster/${CLUSTER}/idle_timeout_ms
+    if [ -f &quot;$O2CB_IDLE_TIMEOUT_MS_FILE&quot; ]; then
+        VAL=`cat &quot;$O2CB_IDLE_TIMEOUT_MS_FILE&quot;`
+        echo &quot;  Network idle timeout: ${VAL}&quot;
+    fi
+
+    O2CB_KEEPALIVE_DELAY_MS_FILE=$(configfs_path)/cluster/${CLUSTER}/keepalive_delay_ms
+    if [ -f &quot;$O2CB_KEEPALIVE_DELAY_MS_FILE&quot; ]; then
+        VAL=`cat &quot;$O2CB_KEEPALIVE_DELAY_MS_FILE&quot;`
+        echo &quot;  Network keepalive delay: ${VAL}&quot;
+    fi
+
+    O2CB_RECONNECT_DELAY_MS_FILE=$(configfs_path)/cluster/${CLUSTER}/reconnect_delay_ms
+    if [ -f &quot;$O2CB_RECONNECT_DELAY_MS_FILE&quot; ]; then
+        VAL=`cat &quot;$O2CB_RECONNECT_DELAY_MS_FILE&quot;`
+        echo &quot;  Network reconnect delay: ${VAL}&quot;
+    fi
+}
+
+#
+# configure_ask()
+#
+# Ask configuration questions, setting the shell vars.
+#
+configure_ask()
+{
+    if [ -n &quot;$DPKGRECONF&quot; ]; then
+	cat &lt;&lt;EOF
+Configuring the O2CB driver.
+
+Please configure this service in the Debian way:
+
+ dpkg-reconfigure ocfs2-tools
+EOF
+
+	exit 0
+    fi
+
+    cat &lt;&lt;EOF
+Configuring the O2CB driver.
+
+This will configure the on-boot properties of the O2CB driver.
+The following questions will determine whether the driver is loaded on
+boot.  The current values will be shown in brackets ('[]').  Hitting
+&lt;ENTER&gt; without typing an answer will keep that current value.  Ctrl-C
+will abort.
+
+EOF
+
+    while :
+    do
+        if [ &quot;$O2CB_ENABLED&quot; = &quot;true&quot; ]
+        then
+            CUR=y
+        else
+            CUR=n
+        fi
+        echo -n &quot;Load O2CB driver on boot (y/n) [$CUR]: &quot;
+        read LINE
+        case &quot;$LINE&quot; in
+        &quot;&quot;)
+            break
+            ;;
+        y|Y)
+            O2CB_ENABLED=true
+            break
+            ;;
+        n|N)
+            O2CB_ENABLED=false
+            break
+            ;;
+        *)
+            echo &quot;Invalid answer: $LINE&quot; &gt;&amp;2
+            ;;
+        esac
+    done
+
+    while :
+    do
+        echo -n &quot;Cluster stack backing O2CB [$O2CB_STACK]: &quot;
+        read LINE
+        case &quot;$LINE&quot; in
+        &quot;&quot;)
+            break
+            ;;
+        ????)
+            O2CB_STACK=&quot;$LINE&quot;
+            break
+            ;;
+        *)
+            echo &quot;Invalid answer: $LINE&quot; &gt;&amp;2
+            ;;
+        esac
+    done
+
+    while :
+    do
+        echo -n &quot;Cluster to start on boot (Enter \&quot;none\&quot; to clear) [$O2CB_BOOTCLUSTER]: &quot;
+        read LINE
+        case &quot;$LINE&quot; in
+        &quot;&quot;)
+            break
+            ;;
+        none)
+            O2CB_BOOTCLUSTER=
+            break
+            ;;
+
+        *[^a-zA-Z0-9]*)
+            echo &quot;Invalid cluster name: $LINE&quot; &gt;&amp;2
+            ;;
+        *)
+            O2CB_BOOTCLUSTER=&quot;$LINE&quot;
+            break
+            ;;
+        esac
+    done
+
+    read_timeout &quot;heartbeat dead threshold&quot; &quot;$O2CB_HEARTBEAT_THRESHOLD&quot; &quot;$MIN_HEARTBEAT_THRESHOLD&quot; &quot;$DEF_HEARTBEAT_THRESHOLD&quot;
+    O2CB_HEARTBEAT_THRESHOLD=&quot;$RET_VAL&quot;
+
+    read_timeout &quot;network idle timeout in ms&quot; &quot;$O2CB_IDLE_TIMEOUT_MS&quot; &quot;$MIN_IDLE_TIMEOUT_MS&quot; &quot;$DEF_IDLE_TIMEOUT_MS&quot;
+    O2CB_IDLE_TIMEOUT_MS=&quot;$RET_VAL&quot;
+
+    read_timeout &quot;network keepalive delay in ms&quot; &quot;$O2CB_KEEPALIVE_DELAY_MS&quot; &quot;$MIN_KEEPALIVE_DELAY_MS&quot; &quot;$DEF_KEEPALIVE_DELAY_MS&quot;
+    O2CB_KEEPALIVE_DELAY_MS=&quot;$RET_VAL&quot;
+
+    read_timeout &quot;network reconnect delay in ms&quot; &quot;$O2CB_RECONNECT_DELAY_MS&quot; &quot;$MIN_RECONNECT_DELAY_MS&quot; &quot;$DEF_RECONNECT_DELAY_MS&quot;
+    O2CB_RECONNECT_DELAY_MS=&quot;$RET_VAL&quot;
+
+    # XXX ask about mount point base
+}
+
+
+#
+# make_dir()
+#
+# Create $1
+# Returns 0 on success, 1 on error, 2 if it already exists.
+#
+make_dir()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;make_dir(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    DIR=&quot;$1&quot;
+    if [ -e &quot;$DIR&quot; ]
+    then
+        if [ -d &quot;$DIR&quot; ]
+        then
+            return 2
+        fi
+        echo &quot;make_dir(): File $DIR is not a directory&quot; &gt;&amp;2
+        return 1
+    fi
+
+    echo -n &quot;Creating directory '$DIR': &quot;
+    mkdir -p &quot;$DIR&quot; 2&gt;/dev/null
+    if [ $? != 0 ]
+    then
+        echo &quot;Unable to create directory '$DIR'&quot; &gt;&amp;2
+        return 1
+    fi
+    return 0
+}
+
+
+#
+# driver_filesystem()
+# Check to see if a filesystem driver is loaded.
+#
+# 0 is loaded, 1 is not.
+#
+driver_filesystem()
+{
+    if [ -z &quot;$1&quot; ]
+    then
+        echo &quot;driver_filesystem(): Missing an argument&quot; &gt;&amp;2
+        exit 1
+    fi
+    FSNAME=&quot;$1&quot;
+    PSEUDO=&quot;$2&quot;
+
+    FSOUT=&quot;$(awk '(NF == 1 &amp;&amp; $1 ~ /^'$FSNAME'$/) || $2 ~ /^'$FSNAME'$/{
+                      print $1;exit
+                  }' /proc/filesystems 2&gt;/dev/null)&quot;
+
+    test -n &quot;$FSOUT&quot;
+    return $?
+}
+
+
+#
+# load_filesystem()
+# Load a filesystem driver.
+#
+# 0 is success, 1 is error, 2 is already loaded.
+#
+load_filesystem()
+{
+    if [ &quot;$#&quot; != &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;load_filesystem(): Missing an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    FSNAME=&quot;$1&quot;
+
+    driver_filesystem &quot;$FSNAME&quot; &amp;&amp; return 2
+
+    echo -n &quot;Loading filesystem \&quot;$FSNAME\&quot;: &quot;
+    modprobe -s &quot;$FSNAME&quot;
+    if [ &quot;$?&quot; != 0 ]
+    then
+        echo &quot;Unable to load filesystem \&quot;$FSNAME\&quot;&quot; &gt;&amp;2
+        return 1
+    fi
+
+    return 0
+}
+
+#
+# unload_filesystem()
+# Unload a filesystem driver.  Be careful to notice if the driver is
+# built-in and do nothing.
+#
+# 0 is success, 1 is error, 2 is already loaded.
+#
+unload_filesystem()
+{
+    if [ &quot;$#&quot; != &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;unload_filesystem(): Missing an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    FSNAME=&quot;$1&quot;
+
+    driver_filesystem &quot;$FSNAME&quot; || return 2
+
+    MODOUT=&quot;`awk '$1 ~ /^'$FSNAME'$/{print $1,$3;exit}' &lt; /proc/modules 2&gt;/dev/null`&quot;
+    if [ -z &quot;$MODOUT&quot; ]
+    then
+        # The driver is built in, we can't unload it.
+        return 2
+    fi
+
+    case &quot;$MODOUT&quot; in
+    $FSNAME\ 0)
+        ;;
+    $FSNAME\ *)
+        # The driver is busy, leave it alone
+        return 2
+        ;;
+    *)
+        echo -n &quot;Invalid module parsing! &quot;
+        return 1
+        ;;
+    esac
+
+    echo -n &quot;Unloading module \&quot;$FSNAME\&quot;: &quot;
+    modprobe -rs &quot;$FSNAME&quot;
+    if [ &quot;$?&quot; != 0 ]
+    then
+        echo &quot;Unable to unload module \&quot;$FSNAME\&quot;&quot; &gt;&amp;2
+        return 1
+    fi
+
+    return 0
+}
+
+#
+# check_filesystem()
+# Check to see if a filesystem of type $1 is mounted at $2.
+#
+# 0 is mounted, 1 is not.
+#
+check_filesystem()
+{
+    if [ &quot;$#&quot; != &quot;2&quot; -o -z &quot;$1&quot; -o -z &quot;$2&quot; ]
+    then
+        echo &quot;check_filesystem(): Missing arguments&quot; &gt;&amp;2
+        exit 1
+    fi
+    FSNAME=&quot;$1&quot;
+    MOUNTPOINT=&quot;$2&quot;
+
+    FULL_MOUNTSEARCH=&quot;`echo &quot;$MOUNTPOINT&quot; | sed -e 's/\//\\\\\//g'`&quot;
+    MOUNTOUT=&quot;`awk '$2 ~ /^'$FULL_MOUNTSEARCH'$/ &amp;&amp; $3 ~ /^'$FSNAME'$/{print $2; exit}' &lt; /proc/mounts 2&gt;/dev/null`&quot;
+    test -n &quot;$MOUNTOUT&quot;
+    return $?
+}
+
+#
+# mount_filesystem()
+# Mounts a pseudo-filesystem of type $1 on mountpoint $2.  It will
+# load the drivers for $1 and create $2 if needed.
+#
+# 0 is success, 1 is error, 2 is already mounted.
+#
+mount_filesystem()
+{
+    if [ &quot;$#&quot; != &quot;2&quot; -o -z &quot;$1&quot; -o -z &quot;$2&quot; ]
+    then
+        echo &quot;mount_filesystem(): Missing arguments&quot; &gt;&amp;2
+        return 1
+    fi
+    FSNAME=&quot;$1&quot;
+    MOUNTPOINT=&quot;$2&quot;
+
+    check_filesystem &quot;$FSNAME&quot; &quot;$MOUNTPOINT&quot; &amp;&amp; return 2
+
+    load_filesystem &quot;$FSNAME&quot;
+    if_fail $?
+
+    # XXX some policy?
+    if [ ! -e &quot;$MOUNTPOINT&quot; ]; then
+        make_dir $MOUNTPOINT
+        if_fail &quot;$?&quot;
+    fi
+
+    echo -n &quot;Mounting ${FSNAME} filesystem at ${MOUNTPOINT}: &quot;
+    mount -t ${FSNAME} ${FSNAME} ${MOUNTPOINT}
+    if [ $? != 0 ]
+    then
+        echo &quot;Unable to mount ${FSNAME} filesystem&quot; &gt;&amp;2
+        return 1
+    fi
+
+    return 0
+}
+
+#
+# unmount_filesystem()
+# Unmount a pseudo-filesystem of type $1 from mountpoint $2.  It will
+# remove the driver for $1 if it can.
+#
+# 0 is success, 1 is error, 2 is not mounted
+#
+unmount_filesystem()
+{
+    if [ &quot;$#&quot; != &quot;2&quot; -o -z &quot;$1&quot; -o -z &quot;$2&quot; ]
+    then
+        echo &quot;unmount_filesystem(): Missing arguments&quot; &gt;&amp;2
+        return 1
+    fi
+    FSNAME=&quot;$1&quot;
+    MOUNTPOINT=&quot;$2&quot;
+
+    if check_filesystem &quot;$FSNAME&quot; &quot;$MOUNTPOINT&quot;
+    then
+        echo -n &quot;Unmounting ${FSNAME} filesystem: &quot;
+        umount $MOUNTPOINT
+        RC=$?
+        if [ $RC != 0 ]
+        then
+            echo &quot;Unable to unmount ${FSNAME} filesystem&quot; &gt;&amp;2
+            return 1
+        fi
+        if_fail $RC  # For the success string
+    fi
+
+    unload_filesystem &quot;$FSNAME&quot;
+    return $?
+}
+
+#
+# status_filesystem()
+# Report the status of a filesystem, whether it is mounted or not
+#
+# 0 is not mounted, 1 is error, 2 is already mounted
+#
+status_filesystem()
+{
+    if [ &quot;$#&quot; != &quot;2&quot; -o -z &quot;$1&quot; -o -z &quot;$2&quot; ]
+    then
+        echo &quot;status_filesystem(): Missing arguments&quot; &gt;&amp;2
+        return 1
+    fi
+    FSNAME=&quot;$1&quot;
+    MOUNTPOINT=&quot;$2&quot;
+
+    echo -n &quot;Driver for \&quot;$FSNAME\&quot;: &quot;
+    if driver_filesystem &quot;$FSNAME&quot;
+    then
+        echo &quot;Loaded&quot;
+    else
+        echo &quot;Not loaded&quot;
+        return 0
+    fi
+
+    echo -n &quot;Filesystem \&quot;$FSNAME\&quot;: &quot;
+    if check_filesystem &quot;$FSNAME&quot; &quot;$MOUNTPOINT&quot;
+    then
+        echo &quot;Mounted&quot;
+        return 2
+    fi
+    echo &quot;Not mounted&quot;
+    return 0
+}
+
+status_daemon()
+{
+    DAEMON=&quot;/sbin/ocfs2_controld.${O2CB_STACK}&quot;
+    echo -n &quot;Checking for control daemon: &quot;
+    if [ -n &quot;$(pidofproc &quot;$DAEMON&quot;)&quot; ]
+    then
+        echo &quot;$DAEMON&quot;
+        return 0
+    else
+        echo &quot;not running&quot;
+        return 1
+    fi
+}
+
+bringup_daemon()
+{
+    DAEMON=&quot;/sbin/ocfs2_controld.${O2CB_STACK}&quot;
+    echo -n &quot;Starting $(basename &quot;$DAEMON&quot;): &quot;
+    start_daemon &quot;$DAEMON&quot;
+    [ $? != 0 ] &amp;&amp; return 1
+
+    COUNT=0
+    while [ -z &quot;$(pidofproc &quot;$DAEMON&quot;)&quot; ]
+    do
+        COUNT=&quot;$(expr &quot;$COUNT&quot; + 1)&quot;
+        if [ &quot;$COUNT&quot; -gt &quot;$BRINGUP_TIMEOUT&quot; ]
+        then
+            return 1
+        fi
+        sleep 1
+    done
+
+    return 0
+}
+
+kill_daemon()
+{
+    SIGNAL=&quot;$1&quot;
+    DAEMON=&quot;/sbin/ocfs2_controld.${O2CB_STACK}&quot;
+
+    status_daemon &gt;/dev/null 2&gt;&amp;1 || return 2
+
+    PID=&quot;$(pidofproc &quot;$DAEMON&quot;)&quot;
+
+    echo -n &quot;Stopping $(basename &quot;$DAEMON&quot;): &quot;
+    killproc &quot;$DAEMON&quot; $SIGNAL
+
+    TRIED=
+    while :
+    do
+        NEWPID=&quot;$(pidofproc &quot;$DAEMON&quot;)&quot;
+        if [ -z &quot;$NEWPID&quot; -o &quot;$NEWPID&quot; != &quot;$PID&quot; ]
+        then
+            echo &quot;Stopped&quot;
+            return
+        fi
+
+        [ -n &quot;$TRIED&quot; ] &amp;&amp; break
+        TRIED=t
+
+        # Give it one chance to exit
+        sleep 1
+    done
+
+    echo &quot;Failed&quot;
+    return 1
+}
+
+#
+# check_heartbeat()
+#
+# 0 is hb not active, 1 is error, 2 is hb active
+#
+check_heartbeat()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;check_heartbeat(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+
+    RC=0
+    if [ -d &quot;$(configfs_path)/cluster/${CLUSTER}/heartbeat/&quot; ]
+    then
+        ls -1 &quot;$(configfs_path)/cluster/${CLUSTER}/heartbeat/&quot; | while read HBUUID
+        do
+            if [ -d &quot;$(configfs_path)/cluster/${CLUSTER}/heartbeat/${HBUUID}&quot; ]
+            then
+                return 2;
+            fi
+        done
+        if [ $? = 2 ]
+        then
+            RC=2
+        fi
+    fi
+
+    return $RC
+}
+
+#
+# clean_heartbeat()
+# Removes the inactive heartbeat regions
+#
+clean_heartbeat()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;clean_heartbeat(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+
+    if [ ! -f &quot;$(configfs_path)/cluster/${CLUSTER}/heartbeat/*&quot; ]
+    then
+        return
+    fi
+
+    echo -n &quot;Cleaning heartbeat on ${CLUSTER}: &quot;
+
+    ls -1 &quot;$(configfs_path)/cluster/${CLUSTER}/heartbeat/&quot; | while read HBUUID
+    do
+        if [ ! -d &quot;$(configfs_path)/cluster/${CLUSTER}/heartbeat/${HBUUID}&quot; ]
+        then
+            continue
+        fi
+
+        OUTPUT=&quot;`ocfs2_hb_ctl -I -u ${HBUUID} 2&gt;&amp;1`&quot;
+        if [ $? != 0 ]
+        then
+            echo &quot;Failed&quot;
+            echo &quot;${OUTPUT}&quot; &gt;&amp;2
+            exit 1
+        fi
+
+        REF=&quot;`echo ${OUTPUT} | awk '/refs/ {print $2; exit;}' 2&gt;&amp;1`&quot;
+        if [ $REF != 0 ]
+        then
+           echo &quot;Failed&quot;
+           echo &quot;At least one heartbeat region still active&quot; &gt;&amp;2
+           exit 1
+        else
+           OUTPUT=&quot;`ocfs2_hb_ctl -K -u ${HBUUID} 2&gt;&amp;1`&quot;
+        fi
+    done
+    if [ $? = 1 ]
+    then
+        exit 1
+    fi
+    echo &quot;OK&quot;
+}
+
+#
+# clean_cluster()
+# Force cleans configured cluster
+#
+# 0 is clean, 1 is error, 2 is not clean
+#
+clean_cluster()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;clean_cluster(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+
+    if [ -d &quot;$(configfs_path)/cluster/${CLUSTER}/node/&quot; ]
+    then
+        ls -1 &quot;$(configfs_path)/cluster/${CLUSTER}/node/&quot; | while read NODE
+        do
+            rmdir &quot;$(configfs_path)/cluster/${CLUSTER}/node/${NODE}&quot; &gt;/dev/null 2&gt;&amp;1
+        done
+    fi
+
+    if [ -d &quot;$(configfs_path)/cluster/${CLUSTER}&quot; ]
+    then
+        rmdir &quot;$(configfs_path)/cluster/${CLUSTER}&quot; &gt;/dev/null 2&gt;&amp;1
+    fi
+
+    if [ -d &quot;$(configfs_path)/cluster/${CLUSTER}&quot; ]
+    then
+        return 2
+    fi
+
+    return 0
+}
+
+select_stack_plugin()
+{
+    case &quot;$O2CB_STACK&quot; in
+    o2cb)
+        echo o2cb
+        ;;
+    ????)
+        echo user
+        ;;
+    *)
+        echo -n &quot;Checking if cluster stack \&quot;$O2CB_STACK\&quot; is supported: &quot;
+        if_fail 1 &quot;Invalid cluster stack name \&quot;$O2CB_STACK\&quot;&quot;
+        ;;
+    esac
+ }
+
+#
+# load_stack_o2cb()
+# Load the o2cb stack.
+#
+# 0 is success, 1 is error, 2 is already loaded
+#
+load_stack_o2cb()
+{
+    PLUGIN=&quot;o2cb&quot;
+    PLUGIN_MODULE=&quot;ocfs2_stack_${PLUGIN}&quot;
+
+    #
+    # Older drivers don't have stack plugins.  They only support the
+    # classic stack.  It is loaded in ocfs2_nodemanager, which is pulled
+    # in during the load of ocfs2_dlmfs.  Thus, if we are using the classic
+    # stack and cannot load the stack plugin, we silently let the later
+    # code try for older drivers.
+    #
+    # For a newer driver, if ocfs2_stackglue is loaded, we'll see
+    # CLUSTER_STACK_FILE.  Thus, we can determine what mode we're in.
+    #
+    [ ! -e &quot;$CLUSTER_STACK_FILE&quot; ] &amp;&amp; \
+        modprobe -s ocfs2_stackglue
+
+    # If we're a newer driver, CLUSTER_STACK_FILE will now appear
+    if [ -e &quot;$CLUSTER_STACK_FILE&quot; ]
+    then
+        SP_OUT=&quot;$(awk '/^'$PLUGIN'$/{print; exit}' &quot;$LOADED_PLUGINS_FILE&quot; 2&gt;/dev/null)&quot;
+        if [ -z &quot;$SP_OUT&quot; ]
+        then
+            echo -n &quot;Loading stack plugin \&quot;$PLUGIN\&quot;: &quot;
+            modprobe -s &quot;$PLUGIN_MODULE&quot;
+            [ &quot;$?&quot; != 0 ] &amp;&amp; if_fail 1 &quot;Unable to load module \&quot;$PLUGIN_MODULE\&quot;&quot;
+            if_fail 0
+        fi
+    fi
+
+    mount_filesystem &quot;ocfs2_dlmfs&quot; &quot;/dlm&quot;
+    if_fail $?
+
+    return 0
+}
+
+#
+# load_stack_user()
+# Load the userspace stack plugin.
+#
+# 0 is success, 1 is error, 2 is already loaded
+#
+load_stack_user()
+{
+    PLUGIN=&quot;user&quot;
+    PLUGIN_MODULE=&quot;ocfs2_stack_${PLUGIN}&quot;
+
+    #
+    # Older drivers don't have stack plugins.  They only support the
+    # classic stack.  It is loaded in ocfs2_nodemanager, which is pulled
+    # in during the load of ocfs2_dlmfs.  Thus, if we are using the classic
+    # stack and cannot load the stack plugin, we silently let the later
+    # code try for older drivers.
+    #
+    # For a newer driver, if ocfs2_stackglue is loaded, we'll see
+    # CLUSTER_STACK_FILE.  Thus, we can determine what mode we're in.
+    #
+    [ ! -e &quot;$CLUSTER_STACK_FILE&quot; ] &amp;&amp; \
+        modprobe -s ocfs2_stackglue
+
+    if [ ! -e &quot;$CLUSTER_STACK_FILE&quot; ]
+    then
+        echo -n &quot;Checking if stack \&quot;$O2CB_STACK\&quot; is supported: &quot;
+        if_fail 1 &quot;User stack plugin is not supported&quot;
+    fi
+
+    SP_OUT=&quot;$(awk '/^'$PLUGIN'$/{print; exit}' &quot;$LOADED_PLUGINS_FILE&quot; 2&gt;/dev/null)&quot;
+    if [ -z &quot;$SP_OUT&quot; ]
+    then
+        echo -n &quot;Loading stack plugin \&quot;$PLUGIN\&quot;: &quot;
+        modprobe -s &quot;$PLUGIN_MODULE&quot;
+        [ &quot;$?&quot; != 0 ] &amp;&amp; if_fail 1 &quot;Unable to load module \&quot;$PLUGIN_MODULE\&quot;&quot;
+        if_fail 0
+    fi
+}
+
+#
+# unload_stack_plugins()
+# Since we can have both plugins unloaded, we just do the same work
+# for all stack types
+#
+unload_stack_plugins()
+{
+    # Whether not loaded or old drivers, if we can't find the stack glue,
+    # we have nothing to do.
+    [ ! -e &quot;$LOADED_PLUGINS_FILE&quot; ] &amp;&amp; return 2
+
+    while read plugin
+    do
+        unload_module &quot;ocfs2_stack_${plugin}&quot;
+        if_fail $? &quot;Unable to unload ocfs2_stack_${plugin}&quot;
+    done &lt;&quot;$LOADED_PLUGINS_FILE&quot;
+
+    unload_module &quot;ocfs2_stackglue&quot;
+    if_fail $? &quot;Unable to unload ocfs2_stackglue&quot;
+}
+
+#
+#
+# unload_stack_o2cb()
+# Unload the o2cb stack plugin
+#
+# 0 is success, 1 is error, 2 is not loaded.
+#
+unload_stack_o2cb()
+{
+    PLUGIN=&quot;o2cb&quot;
+    PLUGIN_MODULE=&quot;ocfs2_stack_${PLUGIN}&quot;
+
+    if [ -d &quot;$(configfs_path)/cluster/&quot; ]
+    then
+        ls -1 $(configfs_path)/cluster/ | while read CLUSTER
+        do
+            if [ ! -L &quot;$(configfs_path)/cluster/${CLUSTER}&quot; -a \
+                 -d &quot;$(configfs_path)/cluster/${CLUSTER}&quot; ]
+            then
+                echo &quot;Unable to unload modules as O2CB cluster ${CLUSTER} is still online&quot; &gt;&amp;2
+                exit 1
+            fi
+        done
+        if [ $? = 1 ]
+        then
+            exit 1
+        fi
+    fi
+
+    unmount_filesystem &quot;ocfs2_dlmfs&quot; &quot;/dlm&quot;
+    if_fail $?
+
+    unload_stack_plugins
+}
+
+#
+# unload_stack_user()
+# Unload the user stack plugin
+#
+# 0 is success, 1 is error, 2 is not loaded.
+#
+unload_stack_user()
+{
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+    PLUGIN_MODULE=&quot;ocfs2_stack_${PLUGIN}&quot;
+
+    if status_daemon &gt;/dev/null 2&gt;&amp;1
+    then
+        echo &quot;Unable to unload modules as the cluster is still online&quot; &gt;&amp;2
+        exit 1
+    fi
+
+    unload_stack_plugins
+}
+
+status_stack_plugin()
+{
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+
+    if [ ! -e &quot;$LOADED_PLUGINS_FILE&quot; ]
+    then
+        # The old stack may be fine here.
+        [ &quot;$PLUGIN&quot; = &quot;o2cb&quot; ] &amp;&amp; return
+
+        echo &quot;Stack glue driver: Not loaded&quot;
+        return
+    fi
+    echo &quot;Stack glue driver: Loaded&quot;
+
+    echo -n &quot;Stack plugin \&quot;$PLUGIN\&quot;: &quot;
+    if grep &quot;$PLUGIN&quot; &quot;$LOADED_PLUGINS_FILE&quot; &gt;/dev/null 2&gt;&amp;1
+    then
+        echo &quot;Loaded&quot;
+    else
+        echo &quot;Not loaded&quot;
+    fi
+}
+
+status_stack_o2cb()
+{
+    status_stack_plugin
+    status_filesystem &quot;ocfs2_dlmfs&quot; &quot;/dlm&quot;
+}
+
+status_stack_user()
+{
+    status_stack_plugin
+
+    echo -n &quot;Driver for \&quot;ocfs2\&quot;: &quot;
+    if driver_filesystem &quot;ocfs2&quot;
+    then
+        echo &quot;Loaded&quot;
+    else
+        echo &quot;Not loaded&quot;
+    fi
+ }
+
+#
+# unload_module()
+# Unload a module
+#
+# 0 is success, 1 is error, 2 is not loaded
+#
+unload_module()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;unload_module(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    MODNAME=&quot;$1&quot;
+
+    MODOUT=&quot;`awk '$1 ~ /^'$MODNAME'$/{print $1,$3;exit}' &lt; /proc/modules 2&gt;/dev/null`&quot;
+    if [ -z &quot;$MODOUT&quot; ]
+    then
+        return 2
+    fi
+    case &quot;$MODOUT&quot; in
+    $MODNAME\ 0)
+        ;;
+    $MODNAME\ *)
+        return 2
+        ;;
+    *)
+        echo -n &quot;Invalid module parsing! &quot;
+        return 1
+        ;;
+    esac
+
+    echo -n &quot;Unloading module \&quot;$MODNAME\&quot;: &quot;
+    modprobe -rs &quot;$MODNAME&quot;
+    if [ &quot;$?&quot; != 0 ]
+    then
+        echo &quot;Unable to unload module \&quot;$MODNAME\&quot;&quot; &gt;&amp;2
+        return 1
+    fi
+
+    return 0
+}
+
+#
+# check_load_module()
+#
+# 0 is not loaded, 1 is error, 2 is already loaded
+#
+check_load_module()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;check_load_module(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    MODNAME=&quot;$1&quot;
+
+    echo -n &quot;Module \&quot;$MODNAME\&quot;: &quot;
+    MODOUT=&quot;`awk '$1 ~ /^'$MODNAME'$/{print $1,$3;exit}' &lt; /proc/modules 2&gt;/dev/null`&quot;
+    if [ -z &quot;$MODOUT&quot; ]
+    then
+        echo &quot;Not loaded&quot;
+        return 0
+    fi
+    echo &quot;Loaded&quot;
+    return 2
+}
+
+load()
+{
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+
+    # XXX: SPECIAL CASE!  We must load configfs for configfs_path() to work
+    load_filesystem &quot;configfs&quot;
+    if_fail $?
+
+    mount_filesystem &quot;configfs&quot; &quot;$(configfs_path)&quot;
+    if_fail $?
+
+    load_stack_$PLUGIN
+
+    return 0
+}
+
+load_status()
+{
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+    status_filesystem &quot;configfs&quot; &quot;$(configfs_path)&quot;
+    status_stack_$PLUGIN
+
+    return 0
+}
+
+online_o2cb()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;online_o2cb(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+
+    if ! [ -f ${CLUSTERCONF} ]
+    then
+        echo -n &quot;Checking O2CB cluster configuration : &quot;
+        if_fail 1
+    fi
+
+    echo -n &quot;Starting O2CB cluster ${CLUSTER}: &quot;
+    OUTPUT=&quot;`o2cb_ctl -H -n &quot;${CLUSTER}&quot; -t cluster -a online=yes 2&gt;&amp;1`&quot;
+    if [ $? = 0 ]
+    then
+        set_timeouts
+        echo &quot;OK&quot;
+        return
+    else
+        echo &quot;Failed&quot;
+        echo &quot;$OUTPUT&quot;
+    fi
+
+    echo -n &quot;Stopping O2CB cluster ${CLUSTER}: &quot;
+    OUTPUT=&quot;`o2cb_ctl -H -n &quot;${CLUSTER}&quot; -t cluster -a online=no 2&gt;&amp;1`&quot;
+    if_fail &quot;$?&quot; &quot;$OUTPUT&quot;
+}
+
+online_user()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;online_user(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+
+    load_filesystem &quot;ocfs2&quot;
+    if_fail $? &quot;Unable to load ocfs2 driver&quot;
+
+    bringup_daemon
+    if_fail $? &quot;Unable to start control daemon&quot;
+}
+
+online()
+{
+    CLUSTER=&quot;${1:-${O2CB_BOOTCLUSTER}}&quot;
+    if [ -z &quot;$CLUSTER&quot; ]
+    then
+        echo &quot;Cluster not known&quot;
+        return
+    fi
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+
+    check_online $CLUSTER
+    if [ $? = 2 ]
+    then
+        echo &quot;Cluster ${CLUSTER} already online&quot;
+        return
+    fi
+
+    if [ -f &quot;$CLUSTER_STACK_FILE&quot; ]
+    then
+        echo -n &quot;Setting cluster stack \&quot;$O2CB_STACK\&quot;: &quot;
+        echo &quot;$O2CB_STACK&quot; &gt;&quot;$CLUSTER_STACK_FILE&quot; 2&gt;/dev/null
+        if_fail $? &quot;Unable to store cluster stack \&quot;$O2CB_STACK\&quot;&quot;
+    elif [ &quot;$O2CB_STACK&quot; != &quot;o2cb&quot; ]
+    then
+        echo -n &quot;Setting cluster stack \&quot;$O2CB_STACK\&quot;: &quot;
+        if_fail 1 &quot;Stack \&quot;$O2CB_STACK\&quot; is not supported&quot;
+    fi
+
+    online_$PLUGIN &quot;$CLUSTER&quot;
+}
+
+#
+# check_online_o2cb()
+#
+# 0 is not online, 1 is error, 2 is online
+#
+check_online_o2cb()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;check_online(): Requires an argument&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+
+    RC=0
+    if [ -d &quot;$(configfs_path)/cluster/${CLUSTER}/node/&quot; ]
+    then
+        ls -1 &quot;$(configfs_path)/cluster/${CLUSTER}/node/&quot; | while read NODE
+        do
+            LOCAL=&quot;`cat \&quot;$(configfs_path)/cluster/${CLUSTER}/node/${NODE}/local\&quot;`&quot;
+            if [ $LOCAL = 1 ]
+            then
+                return 2
+            fi
+        done
+        if [ $? = 2 ]
+        then
+            RC=2
+        fi
+    fi
+    return $RC
+}
+
+#
+# check_online_user()
+#
+# 0 is not online, 1 is error, 2 is online
+#
+check_online_user()
+{
+    if status_daemon &gt;/dev/null 2&gt;&amp;1
+    then
+        return 2
+    else
+        return 1
+    fi
+}
+
+#
+# check_online()
+#
+# 0 is not online, 1 is error, 2 is online
+#
+check_online()
+{
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+
+    check_online_$PLUGIN $1
+}
+
+offline_o2cb()
+{
+    if [ &quot;$#&quot; -lt &quot;2&quot; -o -z &quot;$1&quot; -o -z &quot;$2&quot; ]
+    then
+        echo &quot;offline_o2cb(): Missing arguments&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+    FORCE=&quot;$2&quot;
+
+    if [ ! -e &quot;$(configfs_path)/cluster/${CLUSTER}&quot; ]
+    then
+        return
+    fi
+
+    clean_heartbeat $CLUSTER
+
+    echo -n &quot;Stopping O2CB cluster ${CLUSTER}: &quot;
+    check_heartbeat $CLUSTER
+    if [ $? != 0 ]
+    then
+        echo &quot;Failed&quot;
+        echo &quot;Unable to stop cluster as heartbeat region still active&quot; &gt;&amp;2
+        exit 1
+    fi
+
+    if [ &quot;$FORCE&quot; -eq 1 ]
+    then
+        clean_cluster $CLUSTER
+        if_fail &quot;$?&quot; &quot;Unable to force-offline cluster $CLUSTER&quot; &gt;&amp;2
+    else
+        OUTPUT=&quot;`o2cb_ctl -H -n &quot;${CLUSTER}&quot; -t cluster -a online=no 2&gt;&amp;1`&quot;
+        if_fail &quot;$?&quot; &quot;$OUTPUT - Try to force-offline the O2CB cluster&quot;
+    fi
+}
+
+offline_user()
+{
+    if [ &quot;$#&quot; -lt &quot;2&quot; -o -z &quot;$1&quot; -o -z &quot;$2&quot; ]
+    then
+        echo &quot;offline_user(): Missing arguments&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+    FORCE=&quot;$2&quot;
+
+    kill_daemon
+    [ $? = 1 -a &quot;$FORCE&quot; -eq 1 ] &amp;&amp; kill_daemon -9
+}
+
+offline()
+{
+    CLUSTER=&quot;${1:-${O2CB_BOOTCLUSTER}}&quot;
+    if [ -z &quot;$CLUSTER&quot; ]
+    then
+        return
+    fi
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+
+    if [ $# -gt 1 ]
+    then
+        FORCE=$2
+    else
+        FORCE=0
+    fi
+
+    offline_$PLUGIN &quot;$CLUSTER&quot; &quot;$FORCE&quot;
+
+    unload_filesystem &quot;ocfs2&quot;
+    if_fail &quot;$?&quot;
+}
+
+start()
+{
+    if [ &quot;$O2CB_ENABLED&quot; != &quot;true&quot; ]
+    then
+        exit 0
+    fi
+
+    load
+    online &quot;$1&quot;
+}
+
+unload()
+{
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+
+    unload_stack_$PLUGIN
+
+    # Only unmount configfs if there are no other users
+    if [ -z &quot;$(ls -1 &quot;$(configfs_path)&quot;)&quot; ]
+    then
+        unmount_filesystem &quot;configfs&quot; &quot;$(configfs_path)&quot;
+        if_fail $?
+    fi
+}
+
+stop()
+{
+    offline &quot;$1&quot;
+    unload
+}
+
+configure()
+{
+    configure_ask
+    if [ -z &quot;$DPKGRECONF&quot; ]; then
+	write_sysconfig
+	if_fail &quot;$?&quot; &quot;Unable to write the driver configuration&quot;
+    fi
+}
+
+online_status_o2cb()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;online_status_o2cb(): Missing arguments&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+
+    echo -n &quot;Checking O2CB cluster $CLUSTER: &quot;
+    check_online_o2cb $CLUSTER
+    if [ $? = 2 ]
+    then
+       echo &quot;Online&quot;
+    else
+       echo &quot;Offline&quot;
+       return 0;
+    fi
+
+    show_timeouts
+
+    echo -n &quot;Checking O2CB heartbeat: &quot;
+    check_heartbeat $CLUSTER
+    if [ $? = 2 ]
+    then
+        echo &quot;Active&quot;
+    else
+        echo &quot;Not active&quot;
+        return 0;
+    fi
+
+}
+
+online_status_user()
+{
+    status_daemon
+}
+
+online_status()
+{
+    if [ &quot;$#&quot; -lt &quot;1&quot; -o -z &quot;$1&quot; ]
+    then
+        echo &quot;online_status(): Missing arguments&quot; &gt;&amp;2
+        return 1
+    fi
+    CLUSTER=&quot;$1&quot;
+    PLUGIN=&quot;$(select_stack_plugin)&quot;
+
+    online_status_$PLUGIN &quot;$CLUSTER&quot;
+}
+
+status()
+{
+    load_status
+
+    CLUSTER=&quot;${1:-${O2CB_BOOTCLUSTER}}&quot;
+    if [ -z &quot;$CLUSTER&quot; ]
+    then
+        return 1;
+    fi
+
+    online_status &quot;$CLUSTER&quot;
+}
+
+
+
+case &quot;$1&quot; in
+    start)
+        start &quot;$2&quot;
+        ;;
+
+    status)
+        status &quot;$2&quot;
+        ;;
+
+    stop)
+        stop &quot;$2&quot;
+        ;;
+
+    restart)
+        stop &quot;$2&quot;
+        start &quot;$2&quot;
+        ;;
+
+    force-reload)
+        stop &quot;$2&quot;
+        start &quot;$2&quot;
+        ;;
+
+    load)
+        load
+        ;;
+
+    online)
+        load
+        online &quot;$2&quot;
+        ;;
+
+    offline)
+        offline &quot;$2&quot;
+        ;;
+
+    force-offline)
+        offline &quot;$2&quot; 1
+        ;;
+
+    unload)
+        offline &quot;$2&quot;
+        unload
+        ;;
+
+    configure)
+        configure
+        if [ &quot;$O2CB_ENABLED&quot; = &quot;true&quot; ]
+        then
+            start
+        else
+            stop
+        fi
+        ;;
+
+    enable)
+        O2CB_ENABLED=true
+        write_sysconfig
+        if_fail &quot;$?&quot; &quot;Unable to write the driver configuration&quot;
+        start
+        ;;
+
+    disable)
+        O2CB_ENABLED=false
+        write_sysconfig
+        if_fail &quot;$?&quot; &quot;Unable to write the driver configuration&quot;
+        stop
+        ;;
+
+    *)
+        echo &quot;Usage: $0 {start|stop|restart|force-reload|enable|disable|configure|load|unload|online|offline|force-offline|status}&quot;
+        exit 1
+        ;;
+esac
+
+exit 0

Propchange: trunk/elrepo/dag/ocfs2-tools/o2cb.init.sh
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/ocfs2-tools/o2cb.sysconfig
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-tools/o2cb.sysconfig?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-tools/o2cb.sysconfig?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ocfs2-tools/o2cb.sysconfig (added)
+++ trunk/elrepo/dag/ocfs2-tools/o2cb.sysconfig Mon Nov 29 15:26:35 2010
@@ -1,0 +1,12 @@
+#
+# This is a configuration file for automatic startup of the O2CB
+# driver.  It is generated by running /etc/init.d/o2cb configure.
+# Please use that method to modify this file
+#
+
+# O2CB_ENABLED: 'true' means to load the driver on boot.
+O2CB_ENABLED=false
+
+# O2CB_BOOTCLUSTER: If not empty, the name of a cluster to start.
+O2CB_BOOTCLUSTER=ocfs2
+

Propchange: trunk/elrepo/dag/ocfs2-tools/o2cb.sysconfig
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/ocfs2-tools/ocfs2-tools.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-tools/ocfs2-tools.spec?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-tools/ocfs2-tools.spec?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ocfs2-tools/ocfs2-tools.spec (added)
+++ trunk/elrepo/dag/ocfs2-tools/ocfs2-tools.spec Mon Nov 29 15:26:35 2010
@@ -1,0 +1,145 @@
+# $Id$
+# Authority: dag
+
+%define python_sitearch %(%{__python} -c 'from distutils import sysconfig; print sysconfig.get_python_lib(1)')
+
+Summary: Tools for managing the Oracle Cluster Filesystem 2
+Name: ocfs2-tools
+Version: 1.4.4
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="http://oss.oracle.com/projects/ocfs2-tools/">http://oss.oracle.com/projects/ocfs2-tools/</A>
+
+Source: <A HREF="http://oss.oracle.com/projects/ocfs2-tools/dist/files/source/v1.4/ocfs2-tools-%{version">http://oss.oracle.com/projects/ocfs2-tools/dist/files/source/v1.4/ocfs2-tools-%{version</A>}.tar.gz
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+BuildRequires: compat-libcom_err
+BuildRequires: e2fsprogs-devel
+BuildRequires: glib2-devel &gt;= 2.2.3
+BuildRequires: ncurses-devel
+BuildRequires: pygtk2 &gt;= 1.99.16
+BuildRequires: python-devel &gt;= 2.3
+BuildRequires: readline-devel
+BuildRequires: util-linux &gt;= 2.12j
+Requires: bash
+Requires: coreutils
+Requires: chkconfig
+Requires: e2fsprogs
+Requires: glib2 &gt;= 2.2.3
+Requires: modutils
+Requires: net-tools
+Requires: redhat-lsb
+Requires: util-linux &gt;= 2.12j
+Requires: which
+
+%description
+Tools to manage Oracle Cluster Filesystem 2 volumes.
+
+%package devel
+Summary: Headers and static archives for ocfs2-tools
+Group: Development/Libraries
+Requires: %{name} = %{version}-%{release}
+Requires: e2fsprogs-devel  
+Requires: glib2-devel &gt;= 2.2.3
+
+%description devel
+ocfs2-tools-devel contains the libraries and header files needed to
+develop ocfs2 filesystem-specific programs.
+
+%package -n ocfs2console
+Summary: GUI frontend for OCFS2 management
+Group: System Environment/Kernel
+Requires: %{name} = %{version}-%{release}
+Requires: e2fsprogs
+Requires: glib2 &gt;= 2.2.3
+Requires: pygtk2 &gt;= 1.99.16
+Requires: python &gt;= 2.3
+Requires: vte &gt;= 0.11.10
+
+%description -n ocfs2console
+GUI frontend for management and debugging of Oracle Cluster Filesystem 2
+volumes.
+
+%prep
+%setup
+
+### (According to Oracle) Red Hat chkconfig is completely and utterly broken
+%{__perl} -pi -e 'BEGIN() { $k=0;} if (/^###/) { $k++ } elsif ($k == 1) { printf &quot;#&quot;};' vendor/common/*.init
+
+%build
+%configure --disable-debug
+
+%{__make} #%{?_smp_mflags}
+
+%install
+%{__rm} -rf %{buildroot}
+%{__make} install DESTDIR=&quot;%{buildroot}&quot;
+
+%{__install} -Dp -m0755 vendor/common/o2cb.init %{buildroot}%{_initrddir}/o2cb
+%{__install} -Dp -m0644 vendor/common/o2cb.sysconfig %{buildroot}%{_sysconfdir}/sysconfig/o2cb
+%{__install} -Dp -m0755 vendor/common/ocfs2.init %{buildroot}%{_initrddir}/ocfs2
+
+%post
+/sbin/chkconfig --add o2cb &amp;&gt;/dev/null
+/sbin/chkconfig --add ocfs2 &amp;&gt;/dev/null
+
+%preun
+if [ $1 -eq 0 ]; then
+    /sbin/chkconfig --del ocfs2 &amp;&gt;/dev/null
+    /sbin/chkconfig --del o2cb &amp;&gt;/dev/null
+fi
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%files
+%defattr(-, root, root, 0755)
+%doc COPYING CREDITS MAINTAINERS README*
+%doc documentation/*
+%doc %{_mandir}/man7/o2cb.7*
+%doc %{_mandir}/man8/debugfs.ocfs2.8*
+%doc %{_mandir}/man8/fsck.ocfs2.8*
+%doc %{_mandir}/man8/fsck.ocfs2.checks.8*
+%doc %{_mandir}/man8/mkfs.ocfs2.8*
+%doc %{_mandir}/man8/mount.ocfs2.8*
+%doc %{_mandir}/man8/mounted.ocfs2.8*
+%doc %{_mandir}/man8/o2cb_ctl.8*
+%doc %{_mandir}/man8/o2image.8*
+%doc %{_mandir}/man8/ocfs2_hb_ctl.8*
+%doc %{_mandir}/man8/tunefs.ocfs2.8*
+%config %{_initrddir}/o2cb
+%config %{_initrddir}/ocfs2
+%config(noreplace) %{_sysconfdir}/sysconfig/o2cb
+/sbin/debugfs.ocfs2
+/sbin/fsck.ocfs2
+/sbin/mkfs.ocfs2
+/sbin/mount.ocfs2
+/sbin/mounted.ocfs2
+/sbin/o2cb_ctl
+/sbin/o2image
+/sbin/ocfs2_hb_ctl
+/sbin/tunefs.ocfs2
+
+%files devel
+%defattr(-, root, root, 0755)
+%{_includedir}/o2cb/
+%{_includedir}/o2dlm/
+%{_includedir}/ocfs2-kernel/
+%{_includedir}/ocfs2/
+%{_libdir}/libo2cb.a
+%{_libdir}/libo2dlm.a
+%{_libdir}/libocfs2.a
+%{_libdir}/pkgconfig/o2cb.pc
+%{_libdir}/pkgconfig/o2dlm.pc
+%{_libdir}/pkgconfig/ocfs2.pc
+
+%files -n ocfs2console
+%defattr(-, root, root, 0755)
+%doc %{_mandir}/man8/ocfs2console.8*
+%{python_sitearch}/ocfs2interface/
+%{_sbindir}/ocfs2console
+
+%changelog
+* Wed Jun 16 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at elrepo.org</A>&gt; - 1.4.4-1
+- Initial package.

Propchange: trunk/elrepo/dag/ocfs2-tools/ocfs2-tools.spec
------------------------------------------------------------------------------
    svn:executable = *

Added: trunk/elrepo/dag/ocfs2-tools/ocfs2.init
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-tools/ocfs2.init?rev=9324&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/elrepo/dag/ocfs2-tools/ocfs2.init?rev=9324&amp;view=markup</A>
==============================================================================
--- trunk/elrepo/dag/ocfs2-tools/ocfs2.init (added)
+++ trunk/elrepo/dag/ocfs2-tools/ocfs2.init Mon Nov 29 15:26:35 2010
@@ -1,0 +1,180 @@
+#! /bin/bash
+# Copyright (c) 2005 Oracle
+# All rights reserved.
+#
+# chkconfig: 2345 25 19
+# description: Mount OCFS2 volumes at boot.
+#
+### BEGIN INIT INFO
+# Provides: ocfs2
+# Required-Start: $network o2cb
+# Required-Stop: 
+# X-UnitedLinux-Should-Start:
+# X-UnitedLinux-Should-Stop:
+# Default-Start:  2 3 5
+# Default-Stop:
+# Short-Description: Mount OCFS2 volumes at boot.
+# Description:  Mount OCFS2 volumes at boot.
+### END INIT INFO
+
+if [ -f /etc/redhat-release ]
+then
+. /etc/init.d/functions
+
+init_status()
+{
+    return 0
+}
+
+success_status()
+{
+    success
+    echo
+}
+
+failure_status()
+{
+    failure $1
+    echo
+}
+
+exit_status()
+{
+    exit $?
+}
+elif [ -f /etc/SuSE-release -o -f /etc/UnitedLinux-release ]
+then
+. /etc/rc.status
+
+init_status()
+{
+    rc_reset
+}
+
+success_status()
+{
+    /bin/true
+    rc_status -v
+}
+
+failure_status()
+{
+    /bin/false
+    rc_status -v
+}
+
+exit_status()
+{
+    rc_exit
+}
+else
+init_status()
+{
+    return 0
+}
+
+success_status()
+{
+    echo &quot;OK&quot;
+    return 0
+}
+
+failure_status()
+{
+    echo &quot;Failed&quot;
+    return 0
+}
+
+exit_status()
+{
+    exit $?
+}
+fi
+
+ocfs2mounts()
+{
+    LC_ALL=C awk '$3 == &quot;ocfs2&quot;  { print $2 }' /proc/mounts
+}
+
+ocfs2fstab()
+{
+    LC_ALL=C awk '!/^#/ &amp;&amp; $3 == &quot;ocfs2&quot; &amp;&amp; $4 !~ /noauto/ { print $2 }' /etc/fstab
+}
+
+init_status
+
+FUSER=`which fuser`
+
+case &quot;$1&quot; in
+    start|reload)
+        if [ -d /var/lock/subsys ] ; then
+            touch /var/lock/subsys/ocfs2
+        fi
+        if [ -n &quot;`ocfs2fstab`&quot; ] ; then
+            echo -n &quot;Starting Oracle Cluster File System (OCFS2) &quot;
+            mount -at ocfs2
+            if [ $? = 0 ]
+            then
+                success_status
+            else
+                failure_status &quot;Unable to mount OCFS2 filesystems&quot;
+            fi
+        fi
+        ;;
+    stop)
+        echo -n &quot;Stopping Oracle Cluster File System (OCFS2) &quot;
+        remaining=&quot;`ocfs2mounts`&quot;
+        sig=
+        retry=3
+        while [ -n &quot;$remaining&quot; -a &quot;$retry&quot; -gt 0 ]
+        do
+            if [ &quot;$retry&quot; -lt 3 ]; then
+                echo -n &quot;Retry stopping Oracle Cluster File System (OCFS2) &quot;
+            fi
+            umount -a -t ocfs2 2&gt;/dev/null
+            sleep 1
+
+            remaining=&quot;`ocfs2mounts`&quot;
+            [ -z &quot;$remaining&quot; ] &amp;&amp; break
+            failure_status &quot;Unable to unmount OCFS2 filesystems&quot;
+
+            $FUSER -km $sig $remaining &gt;/dev/null
+            sleep 5
+            retry=$(($retry - 1))
+            sig=-9
+        done
+        if [ -z &quot;$remaining&quot; ] &amp;&amp; [ -e /var/lock/subsys/ocfs2 ] ; then
+                rm /var/lock/subsys/ocfs2
+        fi
+        [ -z &quot;$remaining&quot; ] &amp;&amp; success_status
+        ;;
+    restart|force-reload)
+        $0 stop
+        $0 start
+        ;;
+    status)
+        if [ -f /proc/mounts ] ; then
+            [ -n &quot;`ocfs2fstab`&quot; ] &amp;&amp; {
+                echo &quot;Configured OCFS2 mountpoints: &quot; `ocfs2fstab`
+            }
+
+            [ -n &quot;`ocfs2mounts`&quot; ] &amp;&amp; {
+                echo &quot;Active OCFS2 mountpoints: &quot; `ocfs2mounts`
+            }
+        else
+            echo -n &quot;Checking OCFS2 mountpoints: &quot;
+            failure_status
+        fi
+        ;;
+    try-restart|condrestart)
+        $0 status
+        if test $? = 0; then
+            $0 restart
+        fi
+        ;;
+    *)
+        echo &quot;Usage: $0 {start|stop|status|reload|force-reload|restart|try-restart}&quot;
+        exit 1
+esac
+
+exit_status

Propchange: trunk/elrepo/dag/ocfs2-tools/ocfs2.init
------------------------------------------------------------------------------
    svn:executable = *


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008107.html">[svn] r9323 - in /trunk/elrepo: ./ dag/
</A></li>
	<LI>Next message: <A HREF="008109.html">[svn] r9325 - /trunk/elrepo/dag/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8108">[ date ]</a>
              <a href="thread.html#8108">[ thread ]</a>
              <a href="subject.html#8108">[ subject ]</a>
              <a href="author.html#8108">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
