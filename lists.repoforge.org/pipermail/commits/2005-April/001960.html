<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r3158 - in trunk/tools/pydar2: . pydar sql
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r3158%20-%20in%20trunk/tools/pydar2%3A%20.%20pydar%20sql&In-Reply-To=%3C20050424133418.61D425C40E7%40pooch.vmhosting.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001959.html">
   <LINK REL="Next"  HREF="001961.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r3158 - in trunk/tools/pydar2: . pydar sql</H1>
    <B>packagers at lists.rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r3158%20-%20in%20trunk/tools/pydar2%3A%20.%20pydar%20sql&In-Reply-To=%3C20050424133418.61D425C40E7%40pooch.vmhosting.org%3E"
       TITLE="[svn] r3158 - in trunk/tools/pydar2: . pydar sql">packagers at lists.rpmforge.net
       </A><BR>
    <I>Sun Apr 24 15:34:18 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001959.html">[svn] r3157 - in trunk/tools/pydar2: . pydar sql
</A></li>
        <LI>Next message: <A HREF="001961.html">[svn] r3159 - in trunk/tools/pydar2: pydar sql
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1960">[ date ]</a>
              <a href="thread.html#1960">[ thread ]</a>
              <a href="subject.html#1960">[ subject ]</a>
              <a href="author.html#1960">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dries
Date: 2005-04-24 15:34:16 +0200 (Sun, 24 Apr 2005)
New Revision: 3158

Modified:
   trunk/tools/pydar2/pydar-buildserver-master.py
   trunk/tools/pydar2/pydar-buildserver-slave.py
   trunk/tools/pydar2/pydar-remote.py
   trunk/tools/pydar2/pydar/command.py
   trunk/tools/pydar2/pydar/commandlist.py
   trunk/tools/pydar2/pydar/config.py
   trunk/tools/pydar2/pydar/postgresqlstorage.py
   trunk/tools/pydar2/pydar/storage.py
   trunk/tools/pydar2/pydar/target.py
   trunk/tools/pydar2/pydar/targetlist.py
   trunk/tools/pydar2/sql/master.sql
Log:
update

Modified: trunk/tools/pydar2/pydar/command.py
===================================================================
--- trunk/tools/pydar2/pydar/command.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar/command.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -17,19 +17,44 @@
 # Copyright 2004 Dries Verachtert
 
 class Command:
-    def __init__(self, commandName,userId,specName,toEmail,releaseTag,machRoot,priority):
-        self.commandName=commandName
-        self.userId=userId
-        self.specName = specName
-        self.toEmail = toEmail
-        self.releaseTag = releaseTag
-        self.machRoot = machRoot
-        self.priority = priority
-
+    def __init__(self, commandName,userId,specRepoId,specFileId,toEmail,distroArchTag,priority,targetId):
+        self.__commandName=commandName
+        self.__userId=userId
+        self.__specRepoId = specRepoId
+        self.__specFileId = specFileId
+        self.__toEmail = toEmail
+        self.__distroArchTag = distroArchTag
+        self.__priority = priority
+        self.__targetId = targetId
+        
     def setCommandId(self,id):
-        self.commandId = id
-
+        self.__commandId = id
+    
+    def getCommandName(self):
+        return self.__commandName
+        
+    def getUserId(self):
+        return self.__userId
+        
+    def getSpecRepoId(self):
+        return self.__specRepoId
+        
+    def getSpecFileId(self):
+        return self.__specFileId
+        
+    def getToEmail(self):
+        return self.__toEmail
+        
+    def getDistroArchTag(self):
+        return self.__distroArchTag
+    
+    def getPriority(self):
+        return self.__priority
+        
+    def getTargetId(self):
+        return self.__targetId
+    
     def toString(self):
-        return &quot;commandName=&quot; + self.commandName + &quot;,userId=&quot; + self.userId + &quot;,specName=&quot; + self.specName + &quot;,toEmail=&quot; + self.toEmail + &quot;,releaseTag=&quot; + self.releaseTag + &quot;,machRoot=&quot; + self.machRoot + &quot;,commandId=&quot; + self.commandId + &quot;,priority=&quot; + self.priority
+        return &quot;commandName=&quot; + self.__commandName + &quot;,userId=&quot; + self.__userId + &quot;,specRepoId=&quot; + self.__specRepoId + &quot;,toEmail=&quot; + self.__toEmail + &quot;,specFileId=&quot; + self.__specFileId + &quot;,distroArchTag=&quot; + self.__distroArchTag + &quot;,commandId=&quot; + self.__commandId + &quot;,priority=&quot; + self.__priority
 
 

Modified: trunk/tools/pydar2/pydar/commandlist.py
===================================================================
--- trunk/tools/pydar2/pydar/commandlist.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar/commandlist.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -18,6 +18,7 @@
 
 import config
 import storagefactory
+from command import Command
 from log4py import Logger
 
 class CommandList:
@@ -40,4 +41,5 @@
         if target == None:
             raise Exception(&quot;unknown target&quot;)
         self.__cat.debug(&quot;command looks ok&quot;)
-        
+        aCommand = Command(commandName,userId,specRepo.getId(),specRepoSpecFile.getId(),toEmail,distroArchTag,priority,target.getId())
+        self.__storage.createCommand(aCommand)

Modified: trunk/tools/pydar2/pydar/config.py
===================================================================
--- trunk/tools/pydar2/pydar/config.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar/config.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -27,6 +27,7 @@
 from filter import Filter
 from log4py import Logger
 from targetlist import TargetList
+from target import Target
 
 class Config:
     __myInstance = None
@@ -90,22 +91,19 @@
         self.userid = myParser.get('client','userid')
         self.__dbconnectstring = myParser.get('master','dbconnectstring')
         self.__cat.debug('dbconnectstring set to:' + self.__dbconnectstring)
-        self.buildmachineid = myParser.get('slave','buildmachineid')
+        self.__buildmachineid = myParser.get('slave','buildmachineid')
         self.dirtestbuilds = myParser.get('slave','dirtestbuilds')
 
         self.__savespecrepositoryspecfiletags = True
         #self.__
         
-        self.sleeptime = 5
+        self.__sleeptime = 5
 
-        # get the supported machroots
-        self.machroots = []
+        # get the supported distro + arch strings like fc3-i386
+        self.__distroArchTags = []
         for key in myParser.options('machroots'):
-            self.machroots.append(myParser.get('machroots',key))
+            self.__distroArchTags.append(myParser.get('machroots',key))
         
-        
-        
-        
         # todo: rewrite this stuff so everything is read from some nice configuration files
         self.__specreposrootdir=&quot;/var/lib/pydar2/specrepos&quot;
         self.__specRepositoryList = SpecRepositoryList()
@@ -127,7 +125,9 @@
         #sr = SpecRepository(&quot;local&quot;,SpecRepositoryFactory.TYPE_FILES,self.specreposrootdir + &quot;/local&quot;)
         #sr = srf.createSpecRepository(&quot;local&quot;,SpecRepository.TYPE_FILES,self.__specreposrootdir + &quot;/local&quot;)
         #self.getSpecRepositoryList().add(sr)
+        self.getTargetList().addTarget(Target(&quot;dries&quot;))
  
+ 
         __withinFullInit = False
         __fullInitDone = True
         self.__cat.debug('end')
@@ -146,6 +146,10 @@
         self.__fullInit()
         return self.__commandList
         
+    def getTargetList(self):
+        self.__fullInit()
+        return self.__targetList
+        
     def getSaveSpecRepositorySpecFileTags(self):
         self.__fullInit()
         return self.__savespecrepositoryspecfiletags
@@ -157,3 +161,16 @@
     def getUpdateUserId(self):
         self.__fullInit()
         return self.__updateUserId
+
+    def getDistroArchTags(self):
+        self.__fullInit()
+        return self.__distroArchTags
+        
+    def getBuildMachineId(self):
+        self.__fullInit()
+        return self.__buildmachineid
+        
+    def getSleepTime(self):
+        self.__fullInit()
+        return self.__sleeptime
+        

Modified: trunk/tools/pydar2/pydar/postgresqlstorage.py
===================================================================
--- trunk/tools/pydar2/pydar/postgresqlstorage.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar/postgresqlstorage.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -222,23 +222,23 @@
         self.__releaseConnection(conn)
         return retval
         
-    def createCommand(self,commandName,userId,specName,toEmail,releaseTag,machRoot,priority):
-        # spec name can also be the contents of a specfile...
+    def createCommand(self,aCommand):
         self.__cat.debug(&quot;start&quot;)
-        aCommand = Command(commandName,userId,specName,toEmail,releaseTag,machRoot,priority)
-        conn = pgdb.connect(self.config.dbconnectstring)
+        conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;insert into pydar_commands (commandname,userid,specname,toemail,releasetag,machroot,priority) values ('&quot;
-        + aCommand.commandName + &quot;','&quot;
-        + aCommand.userId + &quot;','&quot;
-        + aCommand.specName + &quot;','&quot;
-        + aCommand.toEmail + &quot;','&quot;
-        + aCommand.releaseTag + &quot;','&quot;
-        + aCommand.machRoot + &quot;',&quot;
-        + aCommand.priority + &quot;)&quot;)
+        #commandName,userId,specrepoid,specfileid,toEmail,distroArchTag,priority,targetid
+        cursor.execute(&quot;insert into pydar2_commands (commandname,userid,specrepoid,specfileid,toemail,distroarchtag,priority,targetid) values ('&quot;
+        + aCommand.getCommandName() + &quot;','&quot;
+        + str(aCommand.getUserId()) + &quot;',&quot;
+        + str(aCommand.getSpecRepoId()) + &quot;,&quot;
+        + str(aCommand.getSpecFileId()) + &quot;,'&quot;
+        + str(aCommand.getToEmail()) + &quot;','&quot;
+        + str(aCommand.getDistroArchTag()) + &quot;',&quot;
+        + str(aCommand.getPriority()) + &quot;,&quot;
+        + str(aCommand.getTargetId()) + &quot;)&quot;)
         conn.commit()
         cursor.close()
-        conn.close()
+        self.__releaseConnection(conn)
 
     def checkIfValidUserId(self, userId):
         self.__cat.debug(&quot;start, userId=&quot; + str(userId))
@@ -255,35 +255,35 @@
 
     def checkIfValidBuildMachineId(self, buildmachineid):
         self.__cat.debug(&quot;start, id=&quot; + buildmachineid)
-        conn = pgdb.connect(self.config.dbconnectstring)
+        conn = self.__getConnection()
         retval = 0
         cursor = conn.cursor()
-        cursor.execute(&quot;select * from pydar_buildmachines where id='&quot; + buildmachineid + &quot;'&quot;)
+        cursor.execute(&quot;select * from pydar2_buildmachines where id='&quot; + buildmachineid + &quot;'&quot;)
         if cursor.rowcount &gt; 0:
             retval = 1
         cursor.close()
-        conn.close()
+        self.__releaseConnection(conn)
         self.__cat.debug(&quot;retval=&quot; + str(retval))
         return retval
 
     def registerSlave(self, buildmachineid):
         self.__cat.debug(&quot;start, buildmachineid=&quot; + buildmachineid)
-        conn = pgdb.connect(self.config.dbconnectstring)
+        conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;insert into pydar_buildmachine_registrations (id) values ('&quot; + buildmachineid + &quot;')&quot;)
-        cursor.execute(&quot;delete from pydar_buildmachine_machroots where buildmachineid='&quot; + buildmachineid + &quot;'&quot;)
+        cursor.execute(&quot;insert into pydar2_buildmachine_registrations (id) values ('&quot; + buildmachineid + &quot;')&quot;)
+        cursor.execute(&quot;delete from pydar2_buildmachine_distroarchtags where buildmachineid='&quot; + buildmachineid + &quot;'&quot;)
         conn.commit()
         cursor.close()
-        conn.close()
+        self.__releaseConnection(conn)
 
-    def addMachRoot(self, buildmachineid, machroot):
-        self.__cat.debug(&quot;start, id=&quot; + buildmachineid + &quot;,machroot=&quot; + machroot)
-        conn = pgdb.connect(self.config.dbconnectstring)
+    def addDistroArchTag(self, buildmachineid, distroArchTag):
+        self.__cat.debug(&quot;start, id=&quot; + buildmachineid + &quot;,distroArchTag=&quot; + distroArchTag)
+        conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;insert into pydar_buildmachine_machroots (buildmachineid,machroot) values ('&quot; + buildmachineid + &quot;','&quot; + machroot + &quot;')&quot;)
+        cursor.execute(&quot;insert into pydar2_buildmachine_distroarchtags (buildmachineid,distroarchtag) values ('&quot; + buildmachineid + &quot;','&quot; + distroArchTag + &quot;')&quot;)
         conn.commit()
         cursor.close()
-        conn.close()
+        self.__releaseConnection(conn)
 
     def addResultFileName(self,buildmachineid,commandId,fileName):
         # no check on buildmachineid yet...
@@ -316,22 +316,31 @@
 
     def reserveCommand(self, buildmachineid):
         self.__cat.debug(&quot;start, buildmachineid=&quot; + buildmachineid)
-        conn = pgdb.connect(self.config.dbconnectstring)
+        conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;select pc.id, pc.specname, pc.toemail, pc.releasetag, pc.machroot, pc.commandname from pydar_commands pc where (pc.commandname='BUILD' or pc.commandname='TESTBUILD') and not pc.handled and not pc.inprogress and pc.machroot in (select machroot from pydar_buildmachine_machroots where buildmachineid='&quot; + buildmachineid + &quot;')  order by pc.priority desc, pc.machroot desc, pc.id asc&quot;)
+        cursor.execute(&quot;select pc.id, pc.specfileid, pc.specrepoid, pc.toemail, pc.distroarchtag, pc.targetid, pc.commandname, pc.userid, pc.priority from pydar2_commands pc where pc.commandname='BUILD' and not pc.handled and not pc.inprogress and pc.distroarchtag in (select distroarchtag from pydar2_buildmachine_distroarchtags where buildmachineid='&quot; + buildmachineid + &quot;')  order by pc.priority desc, pc.distroarchtag desc, pc.id asc&quot;)
         retval = &quot;&quot;
         if cursor.rowcount &gt; 0:
             rs = cursor.fetchone()
             self.__cat.debug(&quot;command found for buildmachineid=&quot; + buildmachineid + &quot;,rs=&quot; + str(rs))
-            aCommand = Command(rs[5],'-1',rs[1],rs[2],rs[3],rs[4])
+            commandId = rs[0]
+            specFileId = rs[1]
+            specRepoId = rs[2]
+            toEmail = rs[3]
+            distroArchTag = rs[4]
+            targetId = rs[5]
+            commandName = rs[6]
+            userId = rs[7]
+            priority = rs[8]
+            aCommand = Command(commandName,userId,specRepoId,specFileId,toEmail,distroArchTag,priority,targetId)
             aCommand.setCommandId(rs[0])
-            cursor.execute(&quot;update pydar_commands set inprogress=true where id=&quot; + str(aCommand.commandId))
-            cursor.execute(&quot;insert into pydar_actions (commandid, statusid, buildmachineid) values (&quot; + str(aCommand.commandId) + &quot;,0,'&quot; + buildmachineid + &quot;')&quot;)
+            cursor.execute(&quot;update pydar2_commands set inprogress=true where id=&quot; + str(aCommand.commandId))
+            cursor.execute(&quot;insert into pydar2_actions (commandid, statusid, buildmachineid) values (&quot; + str(aCommand.commandId) + &quot;,0,'&quot; + buildmachineid + &quot;')&quot;)
             retval = aCommand
         else:
             self.__cat.debug(&quot;nothing to do for buildmachineid=&quot; + buildmachineid)
             retval = &quot;&quot;
         conn.commit()
         cursor.close()
-        conn.close()
+        self.__releaseConnection(conn)
         return retval

Modified: trunk/tools/pydar2/pydar/storage.py
===================================================================
--- trunk/tools/pydar2/pydar/storage.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar/storage.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -72,7 +72,7 @@
     def registerSlave(self, buildmachineid):
         raise Exception(&quot;Dont use Storage but a subclass of Storage, use getInstance()&quot;)
 
-    def addMachRoot(self, buildmachineid, machroot):
+    def addDistroArchTag(self, buildmachineid, machroot):
         raise Exception(&quot;Dont use Storage but a subclass of Storage, use getInstance()&quot;)
 
     def addResultFileName(self,buildmachineid,commandId,fileName):

Modified: trunk/tools/pydar2/pydar/target.py
===================================================================
--- trunk/tools/pydar2/pydar/target.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar/target.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -21,5 +21,14 @@
 from log4py import Logger
 
 class Target:
-    def __init__(self):
+    def __init__(self, name):
         self.__cat = Logger().get_instance(self)
+        self.__name = name
+        self.__id = -1
+        
+    def getName(self):
+        return self.__name
+
+    def getId(self):
+        return self.__id
+        

Modified: trunk/tools/pydar2/pydar/targetlist.py
===================================================================
--- trunk/tools/pydar2/pydar/targetlist.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar/targetlist.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -28,7 +28,7 @@
         self.__targets = []
         
     def getTargetByName(self,name):
-        for i in self__targets:
+        for i in self.__targets:
             if i.getName() == name:
                 return i
         return None

Modified: trunk/tools/pydar2/pydar-buildserver-master.py
===================================================================
--- trunk/tools/pydar2/pydar-buildserver-master.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar-buildserver-master.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -83,11 +83,10 @@
             return &quot;UNKNOWN BUILDMACHINEID&quot;
 
 
-    def addMachRoot(self,buildmachineId,machRoot):
-        METHOD_NAME = &quot;MasterRpc::addMachRoot(..) - &quot;
-        self.__cat.debug(&quot;start, buildmachineId=&quot; + buildmachineId + &quot;, machRoot=&quot; + machRoot)
+    def addDistroArch(self,buildmachineId,distroArchTag):
+        self.__cat.debug(&quot;start, buildmachineId=&quot; + buildmachineId + &quot;, distroArchTag=&quot; + distroArchTag)
         if self.__storage.checkIfValidBuildMachineId(buildmachineId):
-            self.__storage.addMachRoot(buildmachineId,machRoot)
+            self.__storage.addDistroArchTag(buildmachineId,distroArchTag)
             return &quot;OK&quot;
         else:
             return &quot;UNKNOWN BUILDMACHINEID&quot;

Modified: trunk/tools/pydar2/pydar-buildserver-slave.py
===================================================================
--- trunk/tools/pydar2/pydar-buildserver-slave.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar-buildserver-slave.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -19,7 +19,7 @@
 
 
 import getopt, os, sys, Queue, posix, posixpath, string, re, os.path, shutil
-sys.path.append(&quot;/usr/share/pydar/pydar&quot;)
+#sys.path.append(&quot;/usr/share/pydar/pydar&quot;)
 sys.path.append(&quot;pydar&quot;)
 from log4py import Logger
 from config import Config
@@ -28,92 +28,73 @@
 from SimpleXMLRPCServer import SimpleXMLRPCServer
 from xmlrpclib import Server
 import time
-from svnwrapper import SvnWrapper
-from stringfile import StringFile
-import mach
+#from svnwrapper import SvnWrapper
+#from stringfile import StringFile
+#import mach
 import smtplib
 from svn import fs, repos
 from email.MIMEText import MIMEText
 
 class Slave:
-    def __init__(self,myconfig):
-        self.cat = Logger().get_instance(self)
-        self.config = myconfig
-        self.dirMapping = {}
-        self.cat.debug(&quot;initialized&quot;)
+    def __init__(self):
+        self.__cat = Logger().get_instance(self)
+        self.__config = Config.getInstance()
+        self.__cat.debug(&quot;initialized&quot;)
 
     def run(self):
-        self.cat.debug(&quot;url of master: &quot; + self.config.buildmasterurl)
-        self.cat.debug(&quot;local buildmachineid: &quot; + self.config.buildmachineid)
-        self.myserverclient = Server(self.config.buildmasterurl)
+        self.__cat.debug(&quot;url of master: &quot; + self.__config.getBuildMasterUrl())
+        self.__cat.debug(&quot;local getBuildMachineId(): &quot; + self.__config.getBuildMachineId())
+        self.__myserverclient = Server(self.__config.getBuildMasterUrl())
         # let the master now that we exist
-        self.notifyMaster()
-        # wait for commands from the master
-        #self.startListener()
-        self.doBuilds()
+        self.__notifyMaster()
+        self.__doBuilds()
 
-    def notifyMaster(self):
+    def __notifyMaster(self):
         # do a call to the master server so he knows
         # we're ready to build rpms
-        retval = self.myserverclient.registerSlave(self.config.buildmachineid)
-        self.cat.debug(&quot;retval:&quot; + retval)
-        for m in self.config.machroots:
-            self.cat.debug(&quot;machroot:&quot; + m)
-            retval = self.myserverclient.addMachRoot(self.config.buildmachineid, m)
-            self.cat.debug(&quot;retval=&quot; + retval)
-        self.cat.debug(&quot;notify done&quot;)
+        retval = self.__myserverclient.registerSlave(self.__config.getBuildMachineId())
+        self.__cat.debug(&quot;retval:&quot; + retval)
+        for m in self.__config.getDistroArchTags():
+            self.__cat.debug(&quot;distoArchTag:&quot; + m)
+            retval = self.__myserverclient.addDistroArch(self.__config.getBuildMachineId(), m)
+            self.__cat.debug(&quot;retval=&quot; + str(retval))
+        self.__cat.debug(&quot;notify done&quot;)
 
-    def doSvnUpdate(self):
-        self.cat.debug(&quot;start&quot;)
-        svnwrap = SvnWrapper(self.config)
-        svnwrap.startTransaction()
-        svnwrap.updateLocalCopy()
-        svnwrap.stopTransaction()
-        self.cat.debug(&quot;end&quot;)
-
-    def doCheckAllSpecs(self):
-        self.cat.debug(&quot;start&quot;)
-        self.dirMapping = {}
-        rpmsDirList = posix.listdir(self.config.mastersvnrpmsdir)
-        for rpmDir in rpmsDirList:
-            #self.cat.debug(&quot;rpmDir=&quot; + rpmDir)
-            fullRpmDir = posixpath.join(self.config.mastersvnrpmsdir,rpmDir)
-            if posixpath.isdir(fullRpmDir):
-                #self.cat.debug(&quot;it's a dir!&quot;)
-                fileList = posix.listdir(fullRpmDir)
-                for file in fileList:
-                    #self.cat.debug(&quot;part1:&quot; + str(string.rfind(file,'.spec')))
-                    #self.cat.debug(&quot;part2:&quot; + str(len(file) - len('.spec')))
-                    rindex = string.rfind(file,'.spec')
-                    if rindex &gt; 0 and rindex == len(file) - len('.spec'):
-                        #self.cat.debug(&quot;spec match, file=&quot; + file)
-                        self.doCheckSpec(rpmDir, fullRpmDir, file)
-
-    def doCheckSpec(self,rpmDirName,fullRpmDir,specFileName):
-        self.dirMapping[specFileName] = fullRpmDir;
-
-    def getLastChangedSvnRevId(self, dirName, specName):
-        svnwrap = SvnWrapper(self.cat,self.config)
-        svnwrap.startTransaction()
-        retval = svnwrap.getLastCommitRev(dirName,dirName + &quot;/&quot; + specName)
-        svnwrap.stopTransaction()
-        return string.rstrip(str(retval))
-
-    def doBuildSpec(self,command):
+    def __doBuilds(self):
+        self.__cat.debug(&quot;start&quot;)
+        while 1:
+            retval = self.__myserverclient.getCommand(self.__config.getBuildMachineId())
+            if retval == &quot;&quot;:
+                time.sleep(self.__config.getSleepTime())
+            else:
+                commandName = retval['commandName']
+                userId = retval['userId']
+                specName = retval['specName']
+                toEmail = retval['toEmail']
+                releaseTag = retval['releaseTag']
+                machRoot = retval['machRoot']
+                commandId = retval['commandId']
+                aCommand = Command(commandName,userId,specName,toEmail,releaseTag,machRoot)
+                aCommand.setCommandId(commandId)
+                self.__cat.debug(&quot;aCommand=&quot; + str(aCommand))
+                self.__cat.debug(&quot;commandid=&quot; + str(aCommand.commandId))
+                if commandName == &quot;BUILD&quot;:
+                    self.__doBuildSpec(aCommand)
+                else:
+                    self.__cat.error(&quot;command is not BUILD or TESTBUILD ?? commandName=&quot; + commandName)
+        
+    def __doBuildSpec(self,command):
         # choose one implementation
         self.doBuildSpecRsyncYumBased(command)
         
-    
     def doBuildSpecRsyncYumBased(self,command):
         specFileName = command.specName
-        lastChangedSvnRevId = self.getLastChangedSvnRevId(self.dirMapping[specFileName], command.specName)
+        #lastChangedSvnRevId = self.getLastChangedSvnRevId(self.dirMapping[specFileName], command.specName)
         self.cat.debug(&quot;start, specFileName=&quot; + specFileName)
-        
-        
-        
+
     def doBuildSpecMachBased(self,command):
         specFileName=command.specName
-        lastChangedSvnRevId = self.getLastChangedSvnRevId(self.dirMapping[specFileName], command.specName)
+        #lastChangedSvnRevId = self.getLastChangedSvnRevId(self.dirMapping[specFileName], command.specName)
         finalOutputDir = &quot;&quot;
         self.cat.debug(&quot;start, specFileName=&quot; + specFileName)
         buffer = StringFile()
@@ -130,7 +111,7 @@
             self.cat.debug(&quot;mach config set to quiet&quot;)
             os.chdir(self.dirMapping[specFileName])
             shutil.copyfile(specFileName,'rpmforge-' + specFileName)
-	    commandLine = 'perl -i -npe ' + &quot;'&quot; + 'if ($ch==1) {chomp; $_ = $_ . &quot; #' + lastChangedSvnRevId + '\n&quot;; $ch=0;} if (/\%changelog/) {$ch=1;}' + &quot;' rpmforge-&quot; + specFileName;
+            commandLine = 'perl -i -npe ' + &quot;'&quot; + 'if ($ch==1) {chomp; $_ = $_ . &quot; #' + lastChangedSvnRevId + '\n&quot;; $ch=0;} if (/\%changelog/) {$ch=1;}' + &quot;' rpmforge-&quot; + specFileName;
             self.cat.debug(&quot;command: &quot; + commandLine)
             os.system(commandLine)
             sys.stdout = buffer2
@@ -185,72 +166,17 @@
         self.informMasterAfterRebuild(buildResult, tempbuf, srpm, rpms, command, self.dirMapping[specFileName])
         self.mailOutput(tempbuf,command.toEmail, specFileName, &quot;build: &quot; + str(buildResult), command)
 
-    def doTestBuildSpec(self,command):
-        METHOD_NAME = &quot;Slave::doTestBuildSpec(..) - &quot;
-        specContents=command.specName
-        specFileName=str(command.commandId) + &quot;.spec&quot;
-        finalOutputDir = &quot;&quot;
-        
-        self.cat.debug(&quot;start, specFileName=&quot; + specFileName)
-        buffer = StringFile()
-        buildResult = 0
-        srpm = &quot;&quot;
-        rpms = ()
-        try:
-            specDir = self.config.dirtestbuilds + &quot;/&quot; + str(command.commandId)
-            self.cat.debug(&quot;dir will be: &quot; + specDir)
-            mach.config['quiet'] = 1
-            mach.config['release'] = command.releaseTag
-            mach.config['defaultroot'] = command.machRoot
-            self.cat.debug(&quot;mach config set to quiet&quot;)
-            os.mkdir(specDir)
-            os.chdir(specDir)
-            f = open(specFileName, 'w')
-            f.write(specContents)
-            f.close()
-            sys.stdout = buffer
-            sys.stderr = buffer
-            mach.config['collect'] = 1
-            mach.DEBUG = 1
-            mach.main(mach.config,[&quot;unlock&quot;])
-            (srpm, rpms) = mach.main(mach.config,[&quot;build&quot;,specFileName])
-            self.cat.debug(&quot;srpm:&quot; + srpm)
-            self.cat.debug(&quot;rpms:&quot; + str(rpms))
-            buildResult = 1
-            os.mkdir(str(command.commandId))
-            myFileName = self.getRpmFileName(srpm)
-            os.rename(myFileName , str(command.commandId) + &quot;/&quot; + myFileName)
-            for rpmname in rpms:
-                myFileName = self.getRpmFileName(rpmname)
-                os.rename(myFileName, str(command.commandId) + &quot;/&quot; + myFileName)
-            #os.system(&quot;mv *.log *.md5sum *.*.spec &quot; + str(command.commandId))                
-        except:
-            sys.stdout = sys.__stdout__
-            sys.stderr = sys.__stderr__
-            self.cat.debug(&quot;in except part&quot;)
-            self.cat.print_exc()
-            buildResult = 0
-        sys.stdout = sys.__stdout__
-        sys.stderr = sys.__stderr__
-        self.cat.debug(&quot;buffer contains: &quot;)
-        tempbuf = &quot;&quot;
-        for line in buffer.readlines():
-            self.cat.debug(&quot;line: &quot; + line)
-            tempbuf = tempbuf + line
-        #  blabla to server
-        self.informMasterAfterRebuild(buildResult, tempbuf, srpm, rpms, command, specDir)
-        self.mailOutput(tempbuf,command.toEmail, specFileName, &quot;build: &quot; + str(buildResult), command)
 
     def informMasterAfterRebuild(self,buildResult, logbuffer, srpmname, rpmsnames, command, dirName):
         METHOD_NAME=&quot;informMasterAfterRebuild(..) - &quot;
         self.cat.debug(&quot;start&quot;)
         if buildResult:
             fileName = self.getRpmFileName(srpmname)
-            self.myserverclient.sendResultFileName(self.config.buildmachineid, command.commandId,fileName)
+            self.myserverclient.sendResultFileName(self.__config.getBuildMachineId(), command.commandId,fileName)
             for rpm in rpmsnames:
                 fileName = self.getRpmFileName(rpm)
-                self.myserverclient.sendResultFileName(self.config.buildmachineid, command.commandId, fileName)
-        self.myserverclient.sendBuildResult(self.config.buildmachineid, command.commandId, buildResult)
+                self.myserverclient.sendResultFileName(self.__config.getBuildMachineId(), command.commandId, fileName)
+        self.myserverclient.sendBuildResult(self.__config.getBuildMachineId(), command.commandId, buildResult)
 
 
     def getRpmFileName(self, rpmname):
@@ -265,47 +191,107 @@
         output = &quot;Results can be found at:\<A HREF="nhttp://buildmachine1.edesign.be/">nhttp://buildmachine1.edesign.be/</A>&quot; + string.replace(specName,&quot;.spec&quot;,&quot;&quot;) + &quot;/&quot; + str(command.commandId) + &quot;\n\n&quot; + output
         msg = MIMEText(output)
         msg['Subject'] = &quot;pydar: &quot; + command.machRoot + &quot; &quot; + str(command.commandId) + &quot; &quot; + specName + &quot;: &quot; + subjectPart
-        msg['From'] = self.config.mailFrom
+        msg['From'] = self.__config.mailFrom
         msg['To'] = victim
-        me = self.config.mailFrom
+        me = self.__config.mailFrom
         you = victim
         # copypaste from example on www.python.org
-        s = smtplib.SMTP(self.config.smtpserver)
+        s = smtplib.SMTP(self.__config.smtpserver)
         #s.connect()
         s.sendmail(me, [you], msg.as_string())
         s.close()
 
-    def doBuilds(self):
-        METHOD_NAME = &quot;Slave::doBuilds(self) - &quot;
-        self.cat.debug(&quot;start&quot;)
-	self.doCheckAllSpecs()
-        while 1:
-            retval = self.myserverclient.getCommand(self.config.buildmachineid)
-            if retval == &quot;&quot;:
-                time.sleep(self.config.sleeptime)
-            else:
-                commandName = retval['commandName']
-                userId = retval['userId']
-                specName = retval['specName']
-                toEmail = retval['toEmail']
-                releaseTag = retval['releaseTag']
-                machRoot = retval['machRoot']
-                commandId = retval['commandId']
-                aCommand = Command(commandName,userId,specName,toEmail,releaseTag,machRoot)
-                aCommand.setCommandId(commandId)
-                self.cat.debug(&quot;aCommand=&quot; + str(aCommand))
-                self.cat.debug(&quot;commandid=&quot; + str(aCommand.commandId))
-                if commandName == &quot;BUILD&quot;:
-                    #self.doSvnUpdate()
-                    self.doCheckAllSpecs()
-                    self.doBuildSpec(aCommand)
-                else:
-                    if commandName == &quot;TESTBUILD&quot;:
-                        self.doTestBuildSpec(aCommand)
-                    else:
-                        self.cat.debug(&quot;command is not BUILD or TESTBUILD ?? commandName=&quot; + commandName)
+                      
+    #def doSvnUpdate(self):
+    #    self.cat.debug(&quot;start&quot;)
+    #    svnwrap = SvnWrapper(self.config)
+    #    svnwrap.startTransaction()
+    #    svnwrap.updateLocalCopy()
+    #    svnwrap.stopTransaction()
+    #    self.cat.debug(&quot;end&quot;)
 
+    #def doCheckAllSpecs(self):
+    #    self.cat.debug(&quot;start&quot;)
+    #    self.dirMapping = {}
+    #    rpmsDirList = posix.listdir(self.config.mastersvnrpmsdir)
+    #    for rpmDir in rpmsDirList:
+    #        #self.cat.debug(&quot;rpmDir=&quot; + rpmDir)
+    #        fullRpmDir = posixpath.join(self.config.mastersvnrpmsdir,rpmDir)
+    #        if posixpath.isdir(fullRpmDir):
+    #            #self.cat.debug(&quot;it's a dir!&quot;)
+    #            fileList = posix.listdir(fullRpmDir)
+    #            for file in fileList:
+    #                #self.cat.debug(&quot;part1:&quot; + str(string.rfind(file,'.spec')))
+    #                #self.cat.debug(&quot;part2:&quot; + str(len(file) - len('.spec')))
+    #                rindex = string.rfind(file,'.spec')
+    #                if rindex &gt; 0 and rindex == len(file) - len('.spec'):
+    #                    #self.cat.debug(&quot;spec match, file=&quot; + file)
+    #                    self.doCheckSpec(rpmDir, fullRpmDir, file)
 
-myConfig = Config()
-myInstance = Slave(myConfig)
+    #def doCheckSpec(self,rpmDirName,fullRpmDir,specFileName):
+    #    self.dirMapping[specFileName] = fullRpmDir;
+
+    #def getLastChangedSvnRevId(self, dirName, specName):
+    #    svnwrap = SvnWrapper(self.cat,self.config)
+    #    svnwrap.startTransaction()
+    #    retval = svnwrap.getLastCommitRev(dirName,dirName + &quot;/&quot; + specName)
+    #    svnwrap.stopTransaction()
+    #    return string.rstrip(str(retval))
+    
+    #def doTestBuildSpec(self,command):
+    #    METHOD_NAME = &quot;Slave::doTestBuildSpec(..) - &quot;
+    #    specContents=command.specName
+    #    specFileName=str(command.commandId) + &quot;.spec&quot;
+    #    finalOutputDir = &quot;&quot;
+    #    
+    #    self.cat.debug(&quot;start, specFileName=&quot; + specFileName)
+    #    buffer = StringFile()
+    #    buildResult = 0
+    #    srpm = &quot;&quot;
+    #    rpms = ()
+    #    try:
+    #        specDir = self.config.dirtestbuilds + &quot;/&quot; + str(command.commandId)
+    #        self.cat.debug(&quot;dir will be: &quot; + specDir)
+    #        mach.config['quiet'] = 1
+    #        mach.config['release'] = command.releaseTag
+    #        mach.config['defaultroot'] = command.machRoot
+    #        self.cat.debug(&quot;mach config set to quiet&quot;)
+    #        os.mkdir(specDir)
+    #        os.chdir(specDir)
+    #        f = open(specFileName, 'w')
+    #        f.write(specContents)
+    #        f.close()
+    #        sys.stdout = buffer
+    #        mach.config['collect'] = 1
+    #        mach.DEBUG = 1
+    #        mach.main(mach.config,[&quot;unlock&quot;])
+    #        (srpm, rpms) = mach.main(mach.config,[&quot;build&quot;,specFileName])
+    #        self.cat.debug(&quot;srpm:&quot; + srpm)
+    #        self.cat.debug(&quot;rpms:&quot; + str(rpms))
+    #        buildResult = 1
+    #        os.mkdir(str(command.commandId))
+    #        myFileName = self.getRpmFileName(srpm)
+    #        os.rename(myFileName , str(command.commandId) + &quot;/&quot; + myFileName)
+    #        for rpmname in rpms:
+    #            myFileName = self.getRpmFileName(rpmname)
+    #            os.rename(myFileName, str(command.commandId) + &quot;/&quot; + myFileName)
+    #        #os.system(&quot;mv *.log *.md5sum *.*.spec &quot; + str(command.commandId))                
+    #    except:
+    #        sys.stdout = sys.__stdout__
+    #        sys.stderr = sys.__stderr__
+    #        self.cat.debug(&quot;in except part&quot;)
+    #        self.cat.print_exc()
+    #        buildResult = 0
+    #    sys.stdout = sys.__stdout__
+    #    sys.stderr = sys.__stderr__
+    #    self.cat.debug(&quot;buffer contains: &quot;)
+    #    tempbuf = &quot;&quot;
+    #    for line in buffer.readlines():
+    #        self.cat.debug(&quot;line: &quot; + line)
+    #        tempbuf = tempbuf + line
+    #    #  blabla to server
+    #    self.informMasterAfterRebuild(buildResult, tempbuf, srpm, rpms, command, specDir)
+    #    self.mailOutput(tempbuf,command.toEmail, specFileName, &quot;build: &quot; + str(buildResult), command)
+
+myInstance = Slave()
 myInstance.run()

Modified: trunk/tools/pydar2/pydar-remote.py
===================================================================
--- trunk/tools/pydar2/pydar-remote.py	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/pydar-remote.py	2005-04-24 13:34:16 UTC (rev 3158)
@@ -23,9 +23,8 @@
 # todo: parse with getopt
 
 if len(sys.argv) &lt; 2 or sys.argv[1] == &quot;&quot;:
-    myLog.error(&quot;you need to specify a command&quot;)
     print &quot;known commands:&quot;
-    print &quot;    build &lt;userid&gt; &lt;specreponame&gt; &lt;specfilepath&gt; &lt;toemail&gt; &lt;distroarchtag&gt; priority&gt; &lt;taraget&gt;  rebuild a specfile on the server &quot;
+    print &quot;    build &lt;userid&gt; &lt;specreponame&gt; &lt;specfilepath&gt; &lt;toemail&gt; &lt;distroarchtag&gt; &lt;priority&gt; &lt;taraget&gt;  rebuild a specfile on the server &quot;
     print &quot;                and use the specified releasetag and machroot&quot;
     sys.exit(1)
 

Modified: trunk/tools/pydar2/sql/master.sql
===================================================================
--- trunk/tools/pydar2/sql/master.sql	2005-04-23 14:19:18 UTC (rev 3157)
+++ trunk/tools/pydar2/sql/master.sql	2005-04-24 13:34:16 UTC (rev 3158)
@@ -15,10 +15,12 @@
 	addtimestamp	TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
 	commandname	VARCHAR(255) NOT NULL,
         userid		VARCHAR(255) NOT NULL,
-        specname	VARCHAR(64000) NOT NULL,
+        specrepoid	INTEGER NOT NULL,
+	specfileid	INTEGER NOT NULL,
         toemail		VARCHAR(255) NOT NULL,
-        releasetag	VARCHAR(255) NOT NULL,
-        machroot	VARCHAR(255) NOT NULL,
+        distroarchtag	VARCHAR(255) NOT NULL,
+        priority	INTEGER NOT NULL default 0,
+	targetid	INTEGER NOT NULL,
         handled		BOOLEAN NOT NULL DEFAULT FALSE,
         inprogress	BOOLEAN NOT NULL DEFAULT FALSE
 );
@@ -50,9 +52,9 @@
 	id		VARCHAR(255) NOT NULL,
         ts		TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
 );
-create table pydar2_buildmachine_machroots (
+create table pydar2_buildmachine_distroarchtags (
 	buildmachineid	VARCHAR(255) NOT NULL,
-	machroot	VARCHAR(255) NOT NULL
+	distroarchtag	VARCHAR(255) NOT NULL
 );
 
 insert into pydar2_users (id,name) values ('0','test user');


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001959.html">[svn] r3157 - in trunk/tools/pydar2: . pydar sql
</A></li>
	<LI>Next message: <A HREF="001961.html">[svn] r3159 - in trunk/tools/pydar2: pydar sql
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1960">[ date ]</a>
              <a href="thread.html#1960">[ thread ]</a>
              <a href="subject.html#1960">[ subject ]</a>
              <a href="author.html#1960">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
