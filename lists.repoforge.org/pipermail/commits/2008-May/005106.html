<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r6307 - trunk/tools/dar
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r6307%20-%20trunk/tools/dar&In-Reply-To=%3C200805092059.m49KxwpF028886%40surya.karan.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005105.html">
   <LINK REL="Next"  HREF="005107.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r6307 - trunk/tools/dar</H1>
    <B>packagers at lists.rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r6307%20-%20trunk/tools/dar&In-Reply-To=%3C200805092059.m49KxwpF028886%40surya.karan.org%3E"
       TITLE="[svn] r6307 - trunk/tools/dar">packagers at lists.rpmforge.net
       </A><BR>
    <I>Fri May  9 22:59:58 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="005105.html">[svn] r6306 - in trunk/rpms: dkms-kqemu fuse-ntfs-3g htop imapsync	python-celementtree tcpreplay uni2ascii yasm
</A></li>
        <LI>Next message: <A HREF="005107.html">[svn] r6308 - in trunk/rpms: . fontforge htpdate lshw	perl-Date-Holidays-DE perl-GStreamer perl-Geo-IP	perl-Lemonldap-NG-Manager perl-Lingua-Han-PinYin	perl-Lingua-Han-Stroke perl-Lingua-Han-Utils perl-List-Member	perl-Locale-Currency-Format perl-Locale-PO perl-Log-Trivial	perl-Params-Validate qemu wine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5106">[ date ]</a>
              <a href="thread.html#5106">[ thread ]</a>
              <a href="subject.html#5106">[ subject ]</a>
              <a href="author.html#5106">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dag
Date: 2008-05-09 21:59:58 +0100 (Fri, 09 May 2008)
New Revision: 6307

Modified:
   trunk/tools/dar/commands.txt
   trunk/tools/dar/dar-build
   trunk/tools/dar/dar-functions
   trunk/tools/dar/dar-perl.py
   trunk/tools/dar/dar.conf
Log:
Updates

Modified: trunk/tools/dar/commands.txt
===================================================================
--- trunk/tools/dar/commands.txt	2008-05-09 19:56:13 UTC (rev 6306)
+++ trunk/tools/dar/commands.txt	2008-05-09 20:59:58 UTC (rev 6307)
@@ -13,7 +13,10 @@
 ### Clean up chroots
 #dar-exec
 
+### Update perl packages in RPMforge
+for pkg in $(/dar/tools/dar/dar-list-perl.py --new | cut -d' ' -f1); do /dar/tools/dar/dar-diff-perl.sh $pkg; done
 
+
 ### INSTALLING
 ### &quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
 

Modified: trunk/tools/dar/dar-build
===================================================================
--- trunk/tools/dar/dar-build	2008-05-09 19:56:13 UTC (rev 6306)
+++ trunk/tools/dar/dar-build	2008-05-09 20:59:58 UTC (rev 6307)
@@ -8,468 +8,478 @@
 PKGS=&quot;$OPTS&quot;
 
 if [ ! -d &quot;$ROOT&quot; ]; then
-	echo &quot;ERROR: probably in chroot jail&quot; &gt;&amp;2
-	exit 1
+    echo &quot;ERROR: probably in chroot jail&quot; &gt;&amp;2
+    exit 1
 fi
 
 ### Clear important build variables
 export -n CC_FLAGS CXX_FLAGS LD_PRELOAD LINGUAS
 
 for arg in $PKGS; do
-	DARBUILDRC=1
+    DARBUILDRC=1
 
-	SPECDIR=&quot;$(dirname $arg)&quot;
-	app=&quot;$(basename $arg .spec)&quot;
-	SPECFILE=&quot;$PWD/$app.spec&quot;
+    SPECDIR=&quot;$(dirname $arg)&quot;
+    app=&quot;$(basename $arg .spec)&quot;
+    SPECFILE=&quot;$PWD/$app.spec&quot;
 
-	if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECDIR/$app.spec&quot;; fi
-	if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECSDIR/$app.spec&quot;; fi
-	if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$PWD/$app/$app.spec&quot;; fi
-	if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECDIR/$app/$app.spec&quot;; fi
-	if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECSDIR/$app/$app.spec&quot;; fi
-	if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECSDIR/$SPECDIR/$app.spec&quot;; fi
+    if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECDIR/$app.spec&quot;; fi
+    if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECSDIR/$app.spec&quot;; fi
+    if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$PWD/$app/$app.spec&quot;; fi
+    if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECDIR/$app/$app.spec&quot;; fi
+    if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECSDIR/$app/$app.spec&quot;; fi
+    if [ ! -f &quot;$SPECFILE&quot; ]; then SPECFILE=&quot;$SPECSDIR/$SPECDIR/$app.spec&quot;; fi
 
-	if [ &quot;${SPECFILE:0:1}&quot; != &quot;/&quot; ]; then SPECFILE=&quot;$PWD/$SPECFILE&quot;; fi
+    if [ &quot;${SPECFILE:0:1}&quot; != &quot;/&quot; ]; then SPECFILE=&quot;$PWD/$SPECFILE&quot;; fi
 
-	SPECDIR=&quot;$(dirname $SPECFILE)&quot;
-	SPECFILE=&quot;$SPECDIR/$app.spec&quot;
+    SPECDIR=&quot;$(dirname $SPECFILE)&quot;
+    SPECFILE=&quot;$SPECDIR/$app.spec&quot;
 
-	if [ ! -f &quot;$SPECFILE&quot; ]; then 
-		echo &quot;ERROR: specfile \&quot;$(basename $SPECFILE)\&quot; is not found.&quot;
-		continue
-	fi
+    if [ ! -f &quot;$SPECFILE&quot; ]; then 
+        echo &quot;ERROR: specfile \&quot;$(basename $SPECFILE)\&quot; is not found.&quot;
+        continue
+    fi
 
-	if [ ! -d &quot;$SPECDIR&quot; ]; then 
-		echo &quot;ERROR: specdir \&quot;$SPECDIR\&quot; is not found.&quot;
-		continue
-	fi
+    if [ ! -d &quot;$SPECDIR&quot; ]; then 
+        echo &quot;ERROR: specdir \&quot;$SPECDIR\&quot; is not found.&quot;
+        continue
+    fi
 
-#	if [ -d &quot;$SPECDIR/.svn/&quot; ]; then
-#		svn -q up &quot;$SPECDIR/&quot;
-#	fi
+#   if [ -d &quot;$SPECDIR/.svn/&quot; ]; then
+#       svn -q up &quot;$SPECDIR/&quot;
+#   fi
 
-	### Export to rpmconf
-	export RVERSION=&quot;$(rpmmacro real_version)&quot;
-	export RRELEASE=&quot;$(rpmmacro real_release)&quot;
+    ### Export to rpmconf
+    export RVERSION=&quot;$(rpmmacro real_version)&quot;
+    export RRELEASE=&quot;$(rpmmacro real_release)&quot;
 
-	app=&quot;$(rpmconf Name)&quot;
-	VERSION=&quot;$(rpmconf Version)&quot;
-	RELEASE=&quot;$(rpmconf Release)&quot;
+    app=&quot;$(rpmconf Name)&quot;
+    VERSION=&quot;$(rpmconf Version)&quot;
+    RELEASE=&quot;$(rpmconf Release)&quot;
 
-	if [ -z &quot;$app&quot; ]; then
-		error &quot;Problem with specfile \&quot;$SPECFILE\&quot;. (Name is empty)&quot;
-		continue
-	fi
+    if [ -z &quot;$app&quot; ]; then
+        error &quot;Problem with specfile \&quot;$SPECFILE\&quot;. (Name is empty)&quot;
+        continue
+    fi
 
-	if [ -z &quot;$VERSION&quot; ]; then
-		VERSION=&quot;vs&quot;
-#		die &quot;Problem with specfile \&quot;$SPECFILE\&quot;. (Version is empty)&quot;
-	fi
+    if [ -z &quot;$VERSION&quot; ]; then
+        VERSION=&quot;vs&quot;
+#       die &quot;Problem with specfile \&quot;$SPECFILE\&quot;. (Version is empty)&quot;
+    fi
 
-	mkdir -p &quot;$PACKAGEDIR/$app/_buildlogs/&quot; &quot;$SPECDIR/&quot;
-	ln -sf &quot;$PACKAGEDIR/$app/_buildlogs/&quot; &quot;$SPECDIR/&quot;
-	chown -R $BUILD_USER.$BUILD_GROUP &quot;$PACKAGEDIR/$app/&quot;
-	chown -R $BUILD_USER.$BUILD_GROUP &quot;$SPECDIR/&quot;
-	chmod -R a+r &quot;$SPECDIR/&quot;
+    mkdir -p &quot;$PACKAGEDIR/$app/_buildlogs/&quot; &quot;$SPECDIR/&quot;
+    ln -sf &quot;$PACKAGEDIR/$app/_buildlogs/&quot; &quot;$SPECDIR/&quot;
+    chown -R $BUILD_USER.$BUILD_GROUP &quot;$PACKAGEDIR/$app/&quot;
+    chown -R $BUILD_USER.$BUILD_GROUP &quot;$SPECDIR/&quot;
+    chmod -R a+r &quot;$SPECDIR/&quot;
 
-	set_tag
-	set_dists
-	set_exclude_dist
-	set_exclusive_dist
-	set_source_dists
-	set_soapbox
-	set_as_root
-	set_ccache
-	set_distcc
+    set_tag
+    set_dists
+    set_exclude_dist
+    set_exclusive_dist
+    set_source_dists
+    set_soapbox
+    set_as_root
+    set_ccache
+    set_distcc
 
-	if ! download_sources; then
-		continue
-	fi
+    if ! download_sources; then
+        continue
+    fi
 
-#	echo &quot;Building $app package for dists: '$DISTS' and archs: '$ARCHS', tagged: '$TAG'&quot;
-	for dist in $DISTS; do
-		RPMBUILDOPTS=&quot;&quot;
-		if [ -r &quot;$CONFIGDIR/dists/$dist/config&quot; ]; then
-			source &quot;$CONFIGDIR/dists/$dist/config&quot;
-		else
-			warning &quot;Configfile $CONFIGDIR/dists/$dist/config missing. Aborting.&quot;
-			continue
-		fi
+#   echo &quot;Building $app package for dists: '$DISTS' and archs: '$ARCHS', tagged: '$TAG'&quot;
+    for dist in $DISTS; do
+        RPMBUILDOPTS=&quot;&quot;
+        if [ -r &quot;$CONFIGDIR/dists/$dist/config&quot; ]; then
+            source &quot;$CONFIGDIR/dists/$dist/config&quot;
+        else
+            warning &quot;Configfile $CONFIGDIR/dists/$dist/config missing. Aborting.&quot;
+            continue
+        fi
 
-		if [ &quot;$NODIST&quot; ]; then
-			DISTTAG=&quot;0&quot;
-			DISTNAME=&quot;nodist&quot;
-#			ARCHS=&quot;noarch&quot;
-		fi
+        if [ &quot;$NODIST&quot; ]; then
+            DISTTAG=&quot;0&quot;
+            DISTNAME=&quot;nodist&quot;
+#           ARCHS=&quot;noarch&quot;
+        fi
 
 
-		if [ ! -d &quot;$CHROOTDIR/$DISTNICK&quot; ]; then
-			warning &quot;Distribution $DISTNICK has no build environment ($CHROOTDIR/$DISTNICK). Aborting.&quot;
-			continue
-		fi
+        if [ ! -d &quot;$CHROOTDIR/$DISTNICK&quot; ]; then
+            warning &quot;Distribution $DISTNICK has no build environment ($CHROOTDIR/$DISTNICK). Aborting.&quot;
+            continue
+        fi
 
-		for exclude_dist in $EXCLUDE_DIST; do
-			if [ &quot;$exclude_dist&quot; == &quot;$DISTNAME&quot; -o &quot;$exclude_dist&quot; == &quot;$DISTNICK&quot; -o &quot;$DISTNAME&quot; == &quot;nodist&quot; ]; then
-				warning &quot;Distribution $DISTNAME/$DISTARCH is excluded for package $app. Aborting.&quot;
-				continue 2
-			fi
-		done
+        for exclude_dist in $EXCLUDE_DIST; do
+            if [ &quot;$exclude_dist&quot; == &quot;$DISTNAME&quot; -o &quot;$exclude_dist&quot; == &quot;$DISTNICK&quot; -o &quot;$DISTNAME&quot; == &quot;nodist&quot; ]; then
+                warning &quot;Distribution $DISTNAME/$DISTARCH is excluded for package $app. Aborting.&quot;
+                continue 2
+            fi
+        done
 
-		if [ &quot;$EXCLUSIVE_DIST&quot; ]; then
-			EXCLUSIVE=0
-			for exclusive_dist in $EXCLUSIVE_DIST; do
-				if [ &quot;$exclusive_dist&quot; == &quot;$DISTNAME&quot; -o &quot;$exclusive_dist&quot; == &quot;$DISTNICK&quot; -o &quot;$DISTNAME&quot; == &quot;nodist&quot; ]; then
-					EXCLUSIVE=1
-				fi
-			done
-			if [ $EXCLUSIVE -ne 1 ]; then
-				warning &quot;Distribution $DISTNAME/$DISTARCH is excluded for package $app. Aborting.&quot;
-				continue
-			fi
-		fi
+        if [ &quot;$EXCLUSIVE_DIST&quot; ]; then
+            EXCLUSIVE=0
+            for exclusive_dist in $EXCLUSIVE_DIST; do
+                if [ &quot;$exclusive_dist&quot; == &quot;$DISTNAME&quot; -o &quot;$exclusive_dist&quot; == &quot;$DISTNICK&quot; -o &quot;$DISTNAME&quot; == &quot;nodist&quot; ]; then
+                    EXCLUSIVE=1
+                fi
+            done
+            if [ $EXCLUSIVE -ne 1 ]; then
+                warning &quot;Distribution $DISTNAME/$DISTARCH is excluded for package $app. Aborting.&quot;
+                continue
+            fi
+        fi
 
-		### Cleaning up nodebug shit
-#		perl -pi -e 's|-O2 -g|-O2|' $CHROOTDIR/$DISTNICK/usr/lib/rpm/{macros,*/macros,rpmrc}
+        ### Cleaning up nodebug shit
+#       perl -pi -e 's|-O2 -g|-O2|' $CHROOTDIR/$DISTNICK/usr/lib/rpm/{macros,*/macros,rpmrc}
 
-		### Export RPMVER to rpmconf
-		export RPMVER=&quot;$(chroot $CHROOTDIR/$DISTNICK /bin/su -lm $BUILD_USER -c &quot;rpm --version&quot; | cut -d' ' -f3)&quot;
+        ### Export RPMVER to rpmconf
+        export RPMVER=&quot;$(chroot $CHROOTDIR/$DISTNICK /bin/su -lm $BUILD_USER -c &quot;rpm --version&quot; | cut -d' ' -f3)&quot;
 
-		set_archs
+        set_archs
 
-		### TODO: Check if etc/rpm/macros exists with proper content
+        ### TODO: Check if etc/rpm/macros exists with proper content
 
-		for arch in $ARCHS; do
-			VERSION=&quot;$(rpmconf Version)&quot;
-			RELEASE=&quot;$(rpmconf Release)&quot;
+        for arch in $ARCHS; do
+            VERSION=&quot;$(rpmconf Version)&quot;
+            RELEASE=&quot;$(rpmconf Release)&quot;
 
-			NEWSPECFILE=&quot;$TEMPDIR/$app-$VERSION-$RELEASE.$TAG.spec&quot;
-			RPMFILE=&quot;$app-$VERSION-$RELEASE.$DISTNAME.$TAG.$arch.rpm&quot;
-			LOGFILE=&quot;$app-$VERSION-$RELEASE.$DISTNAME.$TAG.$arch.log&quot;
-			export MAKEFLAGS=&quot;%nil&quot;
+            NEWSPECFILE=&quot;$TEMPDIR/$app-$VERSION-$RELEASE.$TAG.spec&quot;
+            RPMFILE=&quot;$app-$VERSION-$RELEASE.$DISTNAME.$TAG.$arch.rpm&quot;
+            LOGFILE=&quot;$app-$VERSION-$RELEASE.$DISTNAME.$TAG.$arch&quot;
+            LOGFILE_OK=&quot;$app-$VERSION-$RELEASE.$DISTNAME.$TAG.$arch.ok.log&quot;
+            LOGFILE_KO=&quot;$app-$VERSION-$RELEASE.$DISTNAME.$TAG.$arch.ko.log&quot;
+            export MAKEFLAGS=&quot;%nil&quot;
 
-			if [ &quot;$arch&quot; == &quot;nosrc&quot; ]; then
-				DARBUILDRC=0
-				break
-			fi
+            if [ &quot;$arch&quot; == &quot;nosrc&quot; ]; then
+                DARBUILDRC=0
+                break
+            fi
 
-			### Check if already build (2 version schemes, multiple disttags)
-			for disttag in $DISTNAME $DISTTAG; do
-				for tag in $TAGS; do
-					NEWRPMFILE=&quot;$app-$VERSION-$RELEASE.$disttag.$tag.$arch.rpm&quot;
-					OLDRPMFILE=&quot;$app-$VERSION-$RELEASE.$tag.$disttag.$arch.rpm&quot;
-					for rpmfile in $NEWRPMFILE $OLDRPMFILE; do
-#						echo $rpmfile
-						if [ -z &quot;$FORCE_OVERWRITE&quot; -a -f &quot;$PACKAGEDIR/$app/$rpmfile&quot; ]; then
-							warning &quot;Package \&quot;$PACKAGEDIR/$app/$rpmfile\&quot; already exists.&quot;
-			
-#							if [ -z &quot;$SOURCE_DISTS&quot; ]; then
-#								SOURCE_DISTS=&quot;$DISTNICK&quot;
-#							fi
-			
-							continue 4
-						fi
-					done
-				done
-			done
+            ### Check if already build (2 version schemes, multiple disttags)
+            for disttag in $DISTNAME $DISTTAG; do
+                for tag in $TAGS; do
+                    NEWRPMFILE=&quot;$app-$VERSION-$RELEASE.$disttag.$tag.$arch.rpm&quot;
+                    OLDRPMFILE=&quot;$app-$VERSION-$RELEASE.$tag.$disttag.$arch.rpm&quot;
+                    for rpmfile in $NEWRPMFILE $OLDRPMFILE; do
+#                       echo $rpmfile
+                        if [ -z &quot;$FORCE_OVERWRITE&quot; -a -f &quot;$PACKAGEDIR/$app/$rpmfile&quot; ]; then
+                            warning &quot;Package \&quot;$PACKAGEDIR/$app/$rpmfile\&quot; already exists.&quot;
+            
+#                           if [ -z &quot;$SOURCE_DISTS&quot; ]; then
+#                               SOURCE_DISTS=&quot;$DISTNICK&quot;
+#                           fi
+            
+                            continue 4
+                        fi
+                    done
+                done
+            done
 
-			cp -af &quot;$SPECFILE&quot; &quot;$NEWSPECFILE&quot;
+            cp -af &quot;$SPECFILE&quot; &quot;$NEWSPECFILE&quot;
 
-			export origspecfile=&quot;$SPECFILE&quot; specfile=&quot;$NEWSPECFILE&quot; builddir=&quot;$BUILDDIR&quot; chrootdir=&quot;$CHROOTDIR/$dist&quot;
-			export app buildarch=&quot;$arch&quot; distarch=&quot;$DISTARCH&quot; disttag=&quot;$DISTNAME&quot; repotag=&quot;$TAG&quot; release=&quot;$RELEASE&quot;
-			export force=&quot;$FORCE_OVERWRITE&quot;
-			for script in $CONFIGDIR/scripts/pre-*.sh; do
-				source &quot;$script&quot;
-			done
+            export origspecfile=&quot;$SPECFILE&quot; specfile=&quot;$NEWSPECFILE&quot; builddir=&quot;$BUILDDIR&quot; chrootdir=&quot;$CHROOTDIR/$dist&quot;
+            export app buildarch=&quot;$arch&quot; distarch=&quot;$DISTARCH&quot; disttag=&quot;$DISTNAME&quot; repotag=&quot;$TAG&quot; release=&quot;$RELEASE&quot;
+            export force=&quot;$FORCE_OVERWRITE&quot;
+            for script in $CONFIGDIR/scripts/pre-*.sh; do
+                source &quot;$script&quot;
+            done
 
-			### Start logging
-			rm -f &quot;$PACKAGEDIR/$app/$LOGFILE&quot;
-			(	echo &quot;----- Build information -----&quot;
-				echo &quot;Package name: $app&quot;
-				echo &quot;Package version: $VERSION&quot;
-				echo &quot;Package release: $RELEASE.$DISTNAME.$TAG&quot;
-				echo &quot;Packager: $(logname)&quot;
-				echo &quot;Distribution: $DISTNAME/$DISTARCH&quot;
-				echo &quot;Package arch: $arch&quot;
-				echo &quot;Build host: $(uname -n)&quot;
-				echo &quot;Build date: $(date)&quot;
+            ### Start logging
+#            rm -f &quot;$PACKAGEDIR/$app/$LOGFILE&quot;
+            (   echo &quot;----- Build information -----&quot;
+                echo &quot;Package name: $app&quot;
+                echo &quot;Package version: $VERSION&quot;
+                echo &quot;Package release: $RELEASE.$DISTNAME.$TAG&quot;
+                echo &quot;Packager: $(logname)&quot;
+                echo &quot;Distribution: $DISTNAME/$DISTARCH&quot;
+                echo &quot;Package arch: $arch&quot;
+                echo &quot;Build host: $(uname -n)&quot;
+                echo &quot;Build date: $(date)&quot;
 
-				if [ $SOAPBOX -eq 1 -a -f &quot;/lib/libsoapbox.so&quot; -a -f &quot;$CHROOTDIR/$dist/lib/libsoapbox.so&quot; ]; then
-					echo &quot;Soapbox: enabled&quot;
-				else
-					echo &quot;Soapbox: disabled&quot;
-				fi
+                if [ $SOAPBOX -eq 1 -a -f &quot;/lib/libsoapbox.so&quot; -a -f &quot;$CHROOTDIR/$dist/lib/libsoapbox.so&quot; ]; then
+                    echo &quot;Soapbox: enabled&quot;
+                else
+                    echo &quot;Soapbox: disabled&quot;
+                fi
 
-				if [ $AS_ROOT -eq 1 ]; then
-					echo &quot;BuildAsRoot: enabled (root)&quot;
-					export HOME=&quot;/root&quot;
-					export USER=&quot;root&quot;
-				else
-					echo &quot;BuildAsRoot: disabled ($BUILD_USER)&quot;
-					export HOME=&quot;/home/$BUILD_USER&quot;
-					export USER=&quot;$BUILD_USER&quot;
-				fi
+                if [ $AS_ROOT -eq 1 ]; then
+                    echo &quot;BuildAsRoot: enabled (root)&quot;
+                    export HOME=&quot;/root&quot;
+                    export USER=&quot;root&quot;
+                else
+                    echo &quot;BuildAsRoot: disabled ($BUILD_USER)&quot;
+                    export HOME=&quot;/home/$BUILD_USER&quot;
+                    export USER=&quot;$BUILD_USER&quot;
+                fi
 
-				if [ $USE_DISTCC -ne 0 -a $DISTCC -eq 1 -a -n &quot;$DISTCC_HOSTS&quot; -a -x &quot;$CHROOTDIR/$dist/usr/bin/distcc&quot; -a -d &quot;$CHROOTDIR/$dist/usr/lib/distcc/bin&quot; ]; then
-					echo &quot;Distcc: enabled&quot;
-					echo &quot;Distcc hosts: $DISTCC_HOSTS&quot;
-				else
-					echo &quot;Distcc: disabled&quot;
-				fi
+                if [ $USE_DISTCC -ne 0 -a $DISTCC -eq 1 -a -n &quot;$DISTCC_HOSTS&quot; -a -x &quot;$CHROOTDIR/$dist/usr/bin/distcc&quot; -a -d &quot;$CHROOTDIR/$dist/usr/lib/distcc/bin&quot; ]; then
+                    echo &quot;Distcc: enabled&quot;
+                    echo &quot;Distcc hosts: $DISTCC_HOSTS&quot;
+                else
+                    echo &quot;Distcc: disabled&quot;
+                fi
 
-				if [ $USE_CCACHE -ne 0 -a $CCACHE -eq 1 -a -x &quot;$CHROOTDIR/$dist/usr/bin/ccache&quot; -a -d &quot;$CHROOTDIR/$dist/usr/lib/ccache/bin&quot; ]; then
-					echo &quot;Ccache: enabled&quot;
-				else
-					echo &quot;Ccache: disabled&quot;
-				fi
+                if [ $USE_CCACHE -ne 0 -a $CCACHE -eq 1 -a -x &quot;$CHROOTDIR/$dist/usr/bin/ccache&quot; -a -d &quot;$CHROOTDIR/$dist/usr/lib/ccache/bin&quot; ]; then
+                    echo &quot;Ccache: enabled&quot;
+                else
+                    echo &quot;Ccache: disabled&quot;
+                fi
 
-			) &amp;&gt;&quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE&quot;
+            ) &amp;&gt;&quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO&quot;
 
-			### Backup PATH
-			OLDPATH=&quot;$PATH&quot;
+            ### Backup PATH
+            OLDPATH=&quot;$PATH&quot;
 
-			### Check for Distcc
-			if [ $USE_DISTCC -ne 0 -a $DISTCC -eq 1 -a -n &quot;$DISTCC_HOSTS&quot; -a -x &quot;$CHROOTDIR/$dist/usr/bin/distcc&quot; -a -d &quot;$CHROOTDIR/$dist/usr/lib/distcc/bin&quot; ]; then
-				if [ -z &quot;$CPUNR&quot; ]; then
-					CPUNR=&quot;$(( $(echo $DISTCC_HOSTS | wc -w) * 2 ))&quot;
-				fi
-				if [ &quot;$FORCE_VERBOSE&quot; ]; then
-					export DISTCC_VERBOSE=&quot;1&quot;
-				fi
-				if [ -d /root/.distcc/state/ ]; then
-					rmdir /root/.distcc/state/ &amp;&gt;/dev/null
-				fi
-				if [ $USE_ROOT -ne 1 -o $AS_ROOT -ne 1 ]; then
-					chown $BUILD_USER.$BUILD_USER $CHROOTDIR/$dist/root/.distcc/
-#					ln -sf $CHROOTDIR/$dist/home/$BUILD_USER/.distcc/state /root/.distcc/
-#				else
-#					ln -sf $CHROOTDIR/$dist/root/.distcc/state /root/.distcc/
-				fi
-				ln -sf $CHROOTDIR/$dist/root/.distcc/state /root/.distcc/
-				export DISTCC_LOG=&quot;$TEMPDIR/distcc-$LOGFILE&quot;
-				rm -f &quot;$DISTCC_LOG&quot;
-				export MAKEFLAGS=&quot;-j$CPUNR CC=\&quot;$DISTCC_CC\&quot; CXX=\&quot;$DISTCC_CXX\&quot; GXX=\&quot;$DISTCC_CXX\&quot;&quot;
-				export DISTCC_HOSTS CC=&quot;$DISTCC_CC&quot; CXX=&quot;$DISTCC_CXX&quot; GXX=&quot;$DISTCC_CXX&quot;
-				export PATH=&quot;/usr/lib/distcc/bin:$PATH&quot;
-			else
-				if [ &quot;$CPUNR&quot; -a $CPUNR -ne 0 -a $CPUNR -ne 1 ]; then
-					export MAKEFLAGS=&quot;-j$CPUNR&quot;
-				else
-					export MAKEFLAGS=&quot;-j1&quot;
-				fi
-				export -n DISTCC_HOSTS CC CXX GXX
-			fi
+            ### Check for Distcc
+            if [ $USE_DISTCC -ne 0 -a $DISTCC -eq 1 -a -n &quot;$DISTCC_HOSTS&quot; -a -x &quot;$CHROOTDIR/$dist/usr/bin/distcc&quot; -a -d &quot;$CHROOTDIR/$dist/usr/lib/distcc/bin&quot; ]; then
+                if [ -z &quot;$CPUNR&quot; ]; then
+                    CPUNR=&quot;$(( $(echo $DISTCC_HOSTS | wc -w) * 2 ))&quot;
+                fi
+                if [ &quot;$FORCE_VERBOSE&quot; ]; then
+                    export DISTCC_VERBOSE=&quot;1&quot;
+                fi
+                if [ -d /root/.distcc/state/ ]; then
+                    rmdir /root/.distcc/state/ &amp;&gt;/dev/null
+                fi
+                if [ $USE_ROOT -ne 1 -o $AS_ROOT -ne 1 ]; then
+                    chown $BUILD_USER.$BUILD_USER $CHROOTDIR/$dist/root/.distcc/
+#                   ln -sf $CHROOTDIR/$dist/home/$BUILD_USER/.distcc/state /root/.distcc/
+#               else
+#                   ln -sf $CHROOTDIR/$dist/root/.distcc/state /root/.distcc/
+                fi
+                ln -sf $CHROOTDIR/$dist/root/.distcc/state /root/.distcc/
+                export DISTCC_LOG=&quot;$TEMPDIR/distcc-$LOGFILE&quot;
+                rm -f &quot;$DISTCC_LOG&quot;
+                export MAKEFLAGS=&quot;-j$CPUNR CC=\&quot;$DISTCC_CC\&quot; CXX=\&quot;$DISTCC_CXX\&quot; GXX=\&quot;$DISTCC_CXX\&quot;&quot;
+                export DISTCC_HOSTS CC=&quot;$DISTCC_CC&quot; CXX=&quot;$DISTCC_CXX&quot; GXX=&quot;$DISTCC_CXX&quot;
+                export PATH=&quot;/usr/lib/distcc/bin:$PATH&quot;
+            else
+                if [ &quot;$CPUNR&quot; -a $CPUNR -ne 0 -a $CPUNR -ne 1 ]; then
+                    export MAKEFLAGS=&quot;-j$CPUNR&quot;
+                else
+                    export MAKEFLAGS=&quot;-j1&quot;
+                fi
+                export -n DISTCC_HOSTS CC CXX GXX
+            fi
 
-			### Check for Ccache
-			if [ $USE_CCACHE -ne 0 -a $CCACHE -eq 1 -a -x &quot;$CHROOTDIR/$dist/usr/bin/ccache&quot; -a -d &quot;$CHROOTDIR/$dist/usr/lib/ccache/bin&quot; ]; then
-				export CCACHE_DIR=&quot;$TEMPDIR/ccache-$dist&quot;
-				export -n CCACHE_RECACHE
-				export PATH=&quot;/usr/lib/ccache/bin:$PATH&quot;
-				mkdir -p &quot;$CCACHE_DIR&quot;
-			else
-				export CCACHE_RECACHE=&quot;1&quot;
-			fi
+            ### Check for Ccache
+            if [ $USE_CCACHE -ne 0 -a $CCACHE -eq 1 -a -x &quot;$CHROOTDIR/$dist/usr/bin/ccache&quot; -a -d &quot;$CHROOTDIR/$dist/usr/lib/ccache/bin&quot; ]; then
+                export CCACHE_DIR=&quot;$TEMPDIR/ccache-$dist&quot;
+                export -n CCACHE_RECACHE
+                export PATH=&quot;/usr/lib/ccache/bin:$PATH&quot;
+                mkdir -p &quot;$CCACHE_DIR&quot;
+            else
+                export CCACHE_RECACHE=&quot;1&quot;
+            fi
 
-			### Check for Setarch
-			if [ -x &quot;/usr/bin/setarch&quot; -a &quot;$DISTARCH&quot; != &quot;$(uname -m)&quot; ]; then
-				SETARCH=&quot;/usr/bin/setarch $DISTARCH&quot;
-			else
-				unset SETARCH
-			fi
+            ### Check for Setarch
+            if [ -x &quot;/usr/bin/setarch&quot; -a &quot;$DISTARCH&quot; != &quot;$(uname -m)&quot; ]; then
+                SETARCH=&quot;/usr/bin/setarch $DISTARCH&quot;
+            else
+                unset SETARCH
+            fi
 
-			### Disable ExtUtils::AutoInstall in perl packages
-			export PERL_EXTUTILS_AUTOINSTALL=&quot;--skipdeps --skip&quot;
+            ### Disable ExtUtils::AutoInstall in perl packages
+            export PERL_EXTUTILS_AUTOINSTALL=&quot;--skipdeps --skip&quot;
 
-			### Remove buildroot
-			rm -rf &quot;$TEMPDIR/root-$app-$VERSION&quot;
+            ### Remove buildroot
+            rm -rf &quot;$TEMPDIR/root-$app-$VERSION&quot;
 
-			### Prepare rpm options
-			if [ &quot;$FORCE_VERBOSE&quot; ]; then
-				RPMBUILDOPTS=&quot;$RPMBUILDOPTS -vv --target $arch&quot;
-			else
-				RPMBUILDOPTS=&quot;$RPMBUILDOPTS --target $arch&quot;
-			fi
+            ### Prepare rpm options
+            if [ &quot;$FORCE_VERBOSE&quot; ]; then
+                RPMBUILDOPTS=&quot;$RPMBUILDOPTS -vv --target $arch&quot;
+            else
+                RPMBUILDOPTS=&quot;$RPMBUILDOPTS --target $arch&quot;
+            fi
 
-			if [ &quot;$FORCE_VERBOSE&quot; == &quot;yes&quot; ]; then
-				echo &quot;Building $dist/$arch [$SPECDIR/_buildlogs/$LOGFILE].&quot;
-			fi
+            if [ &quot;$FORCE_VERBOSE&quot; == &quot;yes&quot; ]; then
+                echo &quot;Building $dist/$arch [$SPECDIR/_buildlogs/$LOGFILE].&quot;
+            fi
 
-			### Check for Soapbox
-			if [ &quot;$SOAPBOX&quot; == &quot;1&quot; -a -f &quot;/lib/libsoapbox.so&quot; -a -f &quot;$CHROOTDIR/$dist/lib/libsoapbox.so&quot; ]; then
-				export SOAPBOXPATH=&quot;$PACKAGEDIR/$app/_buildlogs:$PACKAGEDIR/$app:$TEMPDIR:$BUILDDIR:/dev/null:/dev/tty:/tmp:/var/lib/rpm/__db:$HOME/.distcc&quot;
-				export SOAPBOXLOG=&quot;$TEMPDIR/soapbox-$LOGFILE&quot;
-				rm -f &quot;$SOAPBOXLOG&quot;
-				export LD_PRELOAD=&quot;/lib/libsoapbox.so&quot;
-			fi
+            ### Check for Soapbox
+            if [ &quot;$SOAPBOX&quot; == &quot;1&quot; -a -f &quot;/lib/libsoapbox.so&quot; -a -f &quot;$CHROOTDIR/$dist/lib/libsoapbox.so&quot; ]; then
+                export SOAPBOXPATH=&quot;$PACKAGEDIR/$app/_buildlogs:$PACKAGEDIR/$app:$TEMPDIR:$BUILDDIR:/dev/null:/dev/tty:/tmp:/var/lib/rpm/__db:$HOME/.distcc&quot;
+                export SOAPBOXLOG=&quot;$TEMPDIR/soapbox-$LOGFILE.log&quot;
+                rm -f &quot;$SOAPBOXLOG&quot;
+                export LD_PRELOAD=&quot;/lib/libsoapbox.so&quot;
+            fi
 
-			BUILDCMD=&quot;/usr/bin/rpmbuild -bb --clean $RPMBUILDOPTS \
-					--define \&quot;_smp_mflags $MAKEFLAGS\&quot; \
-					--define \&quot;_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm\&quot; \
-					--define \&quot;_initrddir %{_sysconfdir}/rc.d/init.d\&quot; \
-					--define \&quot;_rpmdir $PACKAGEDIR/$app\&quot; \
-					--define \&quot;_sourcedir $SPECDIR\&quot; \
-					--define \&quot;_builddir $BUILDDIR\&quot; \
-					--define \&quot;_tmppath $TEMPDIR\&quot; \
-					--define \&quot;debug_package %nil\&quot; \
-					--define \&quot;dtag $DISTNAME\&quot; \
-					--define \&quot;disttag $DISTNAME\&quot; \
-					--define \&quot;$DISTNAME 1\&quot; \
-					--define \&quot;$DISTNICK 1\&quot; \&quot;$NEWSPECFILE\&quot;&quot;
+            BUILDCMD=&quot;/usr/bin/rpmbuild -bb --clean $RPMBUILDOPTS \
+                    --define \&quot;_smp_mflags $MAKEFLAGS\&quot; \
+                    --define \&quot;_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm\&quot; \
+                    --define \&quot;_initrddir %{_sysconfdir}/rc.d/init.d\&quot; \
+                    --define \&quot;_rpmdir $PACKAGEDIR/$app\&quot; \
+                    --define \&quot;_sourcedir $SPECDIR\&quot; \
+                    --define \&quot;_builddir $BUILDDIR\&quot; \
+                    --define \&quot;_tmppath $TEMPDIR\&quot; \
+                    --define \&quot;debug_package %nil\&quot; \
+                    --define \&quot;dtag $DISTNAME\&quot; \
+                    --define \&quot;disttag $DISTNAME\&quot; \
+                    --define \&quot;$DISTNAME 1\&quot; \
+                    --define \&quot;$DISTNICK 1\&quot; \&quot;$NEWSPECFILE\&quot;&quot;
 
-			(
-				echo &quot;Build command:&quot; $BUILDCMD
-				echo &quot;Build path: $PATH&quot;
+            (
+                echo &quot;Build command:&quot; $BUILDCMD
+                echo &quot;Build path: $PATH&quot;
 
-				echo -e &quot;\n----- Spec file -----&quot;
-				cat &quot;$NEWSPECFILE&quot;
+                echo -e &quot;\n----- Spec file -----&quot;
+                cat &quot;$NEWSPECFILE&quot;
 
-				echo -e &quot;\n----- Build log -----&quot;
+                echo -e &quot;\n----- Expanded spec file -----&quot;
+                rpmdb -D &quot;dtag $DISTNAME&quot; -D &quot;disttag $DISTNAME&quot; -D &quot;$DISTNICK 1&quot; -D &quot;$DISTNAME 1&quot; -D &quot;_smp_mflags $MAKEFLAGS&quot; -E &quot;%{expand:%(cat $SPECFILE)}&quot;
 
-				### Check for building as user
-				if [ $AS_ROOT -eq 1 ]; then
-					$SETARCH chroot &quot;$CHROOTDIR/$dist&quot; /usr/bin/rpmbuild -bb --clean $RPMBUILDOPTS \
-						--define &quot;_smp_mflags $MAKEFLAGS&quot; \
-						--define &quot;_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm&quot; \
-						--define &quot;_initrddir %{_sysconfdir}/rc.d/init.d&quot; \
-						--define &quot;_rpmdir $PACKAGEDIR/$app&quot; \
-						--define &quot;_sourcedir $SPECDIR&quot; \
-						--define &quot;_builddir $ROOT/build&quot; \
-						--define &quot;_buildroot $TEMPDIR/$app-$VERSION-$RELEASE-root&quot; \
-						--define &quot;debug_package %nil&quot; \
-						--define &quot;dtag $DISTNAME&quot; \
-						--define &quot;disttag $DISTNAME&quot; \
-						--define &quot;$DISTNAME 1&quot; \
-						--define &quot;$DISTNICK 1&quot; \
-						&quot;$NEWSPECFILE&quot;
-				else
-					$SETARCH chroot &quot;$CHROOTDIR/$dist&quot; /bin/su -lm $BUILD_USER -c &quot;/usr/bin/rpmbuild -bb --clean $RPMBUILDOPTS \
-						--define '_smp_mflags $MAKEFLAGS' \
-						--define '_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm' \
-						--define '_initrddir %{_sysconfdir}/rc.d/init.d' \
-						--define '_rpmdir $PACKAGEDIR/$app' \
-						--define '_sourcedir $SPECDIR' \
-						--define '_builddir $ROOT/build' \
-						--define '_tmppath $TEMPDIR' \
-						--define '_buildroot $TEMPDIR/$app-$VERSION-$RELEASE-root' \
-						--define 'debug_package %nil' \
-						--define 'dist $DISTNAME' \
-						--define 'disttag $DISTNAME' \
-						--define '$DISTNAME 1' \
-						--define '$DISTNICK 1' \
-						$NEWSPECFILE&quot;
-				fi
+                echo -e &quot;\n----- Build log -----&quot;
 
-			) &gt;&gt;&quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE&quot; 2&gt;&amp;1
-#			CHROOT=&quot;/usr/bin/compartment --chroot $CHROOTDIR/$dist --user $BUILD_USER --group $BUILD_USER --init /usr/lib/dar/compartment.sh --quiet&quot;
+                ### Check for building as user
+                if [ $AS_ROOT -eq 1 ]; then
+                    $SETARCH chroot &quot;$CHROOTDIR/$dist&quot; /usr/bin/rpmbuild -bb --clean $RPMBUILDOPTS \
+                        --define &quot;_smp_mflags $MAKEFLAGS&quot; \
+                        --define &quot;_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm&quot; \
+                        --define &quot;_initrddir %{_sysconfdir}/rc.d/init.d&quot; \
+                        --define &quot;_rpmdir $PACKAGEDIR/$app&quot; \
+                        --define &quot;_sourcedir $SPECDIR&quot; \
+                        --define &quot;_builddir $ROOT/build&quot; \
+                        --define &quot;_buildroot $TEMPDIR/$app-$VERSION-$RELEASE-root&quot; \
+                        --define &quot;debug_package %nil&quot; \
+                        --define &quot;dtag $DISTNAME&quot; \
+                        --define &quot;disttag $DISTNAME&quot; \
+                        --define &quot;$DISTNAME 1&quot; \
+                        --define &quot;$DISTNICK 1&quot; \
+                        &quot;$NEWSPECFILE&quot;
+                else
+                    $SETARCH chroot &quot;$CHROOTDIR/$dist&quot; /bin/su -lm $BUILD_USER -c &quot;/usr/bin/rpmbuild -bb --clean $RPMBUILDOPTS \
+                        --define '_smp_mflags $MAKEFLAGS' \
+                        --define '_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm' \
+                        --define '_initrddir %{_sysconfdir}/rc.d/init.d' \
+                        --define '_rpmdir $PACKAGEDIR/$app' \
+                        --define '_sourcedir $SPECDIR' \
+                        --define '_builddir $ROOT/build' \
+                        --define '_tmppath $TEMPDIR' \
+                        --define '_buildroot $TEMPDIR/$app-$VERSION-$RELEASE-root' \
+                        --define 'debug_package %nil' \
+                        --define 'dtag $DISTNAME' \
+                        --define 'disttag $DISTNAME' \
+                        --define '$DISTNAME 1' \
+                        --define '$DISTNICK 1' \
+                        $NEWSPECFILE&quot;
+                fi
 
-			RC=$?
-			export -n LD_PRELOAD
+            ) &gt;&gt;&quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO&quot; 2&gt;&amp;1
+#           CHROOT=&quot;/usr/bin/compartment --chroot $CHROOTDIR/$dist --user $BUILD_USER --group $BUILD_USER --init /usr/lib/dar/compartment.sh --quiet&quot;
 
-			### Restore PATH
-			export PATH=&quot;$OLDPATH&quot;
+            RC=$?
+            export -n LD_PRELOAD
 
-			### Finish logging
-			(	echo -e &quot;\n----- Return code -----&quot;
-				echo &quot;$RC&quot;
-				if [ -d &quot;$TEMPDIR/$app-$VERSION-$RELEASE-root&quot; ]; then
-					echo -e &quot;\n----- Buildroot content -----&quot;
-					find &quot;$TEMPDIR/$app-$VERSION-$RELEASE-root&quot; 2&gt;/dev/null
-				fi
-				if [ -s &quot;$SOAPBOXLOG&quot; ]; then
-					if [ $RC -eq 0 ]; then
-						warning &quot;Soapbox violations, see \&quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE.bz2\&quot;.&quot;
-					else
-						warning &quot;Soapbox violations, see log.&quot;
-					fi
-					echo -e &quot;\n----- Actions outside buildroot -----&quot;
-					cat &quot;$SOAPBOXLOG&quot;
-					RC=15
-				fi
-				rm -f &quot;$SOAPBOXLOG&quot;
-				echo -e &quot;\n----- End of file -----&quot;
-			) &gt;&gt;&quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE&quot; 2&gt;&amp;1
+            ### Restore PATH
+            export PATH=&quot;$OLDPATH&quot;
 
+            ### Finish logging
+            (   echo -e &quot;\n----- Return code -----&quot;
+                echo &quot;$RC&quot;
+                if [ -d &quot;$TEMPDIR/$app-$VERSION-$RELEASE-root&quot; ]; then
+                    echo -e &quot;\n----- Buildroot content -----&quot;
+                    find &quot;$TEMPDIR/$app-$VERSION-$RELEASE-root&quot; 2&gt;/dev/null
+                fi
+                if [ -s &quot;$SOAPBOXLOG&quot; ]; then
+                    if [ $RC -eq 0 ]; then
+                        warning &quot;Soapbox violations, see \&quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO.gz\&quot;.&quot;
+                    else
+                        warning &quot;Soapbox violations, see log.&quot;
+                    fi
+                    echo -e &quot;\n----- Actions outside buildroot -----&quot;
+                    cat &quot;$SOAPBOXLOG&quot;
+                    RC=15
+                fi
+                rm -f &quot;$SOAPBOXLOG&quot;
+                echo -e &quot;\n----- End of file -----&quot;
+            ) &gt;&gt;&quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO&quot; 2&gt;&amp;1
 
-			if [ $RC -eq 0 ]; then
-				DARBUILDRC=0
-				if [ &quot;$FORCE_VERBOSE&quot; == &quot;yes&quot; ]; then
-					echo -e &quot;${_GR}Success${_DE} $app [$dist/$arch], file in [$PACKAGEDIR/$app/]&quot;
-				fi
-				echo &quot;$app [$dist/$arch] ${SPECFILE/*\/} $LOGFILE&quot; &gt;&gt;/dar/log/dar-build-success.log
-				cp -au &quot;$SPECFILE&quot; &quot;$PACKAGEDIR/$app/&quot;
+            ### Check if an RPM package was successfully built.
+            grep -q -E '^Wrote: .*.rpm$' &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO&quot;
+            RC=$?
 
-				if [ &quot;$RETAIN_LOGS&quot; == &quot;yes&quot; ]; then
-#					bzip2 -9 -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE&quot;
-					gzip -9 --rsyncable -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE&quot;
-				fi
+            if [ $RC -eq 0 ]; then
+                DARBUILDRC=0
+                mv -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO&quot; &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_OK&quot;
+                rm -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO.gz&quot;
+                if [ &quot;$FORCE_VERBOSE&quot; == &quot;yes&quot; ]; then
+                    echo -e &quot;${_GR}Success${_DE} $app [$dist/$arch], see log [$SPECDIR/_buildlogs/$LOGFILE_OK]&quot;
+                fi
+                echo &quot;$app [$dist/$arch] ${SPECFILE/*\/} $LOGFILE_OK&quot; &gt;&gt;/dar/log/dar-build-success.log
+                cp -au &quot;$SPECFILE&quot; &quot;$PACKAGEDIR/$app/&quot;
 
-				### Clean up current and older logfile
-				rm -f &quot;$DISTCC_LOG&quot;
+                if [ &quot;$RETAIN_LOGS&quot; == &quot;yes&quot; ]; then
+#                   bzip2 -9 -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_OK&quot;
+                    gzip -9 --rsyncable -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_OK&quot;
+                fi
 
-				if [ -z &quot;$SOURCE_DISTS&quot; ]; then
-					SOURCE_DISTS=&quot;$DISTNICK&quot;
-				fi
-			else
-#				log &quot;Failed building package $app for $dist/$arch.&quot; &gt;&gt; &quot;$LOGDIR/dar.log&quot;
-				error &quot;${_RE}Failed${_DE} $app [$dist/$arch], see log [$SPECDIR/_buildlogs/$LOGFILE]&quot;
-				echo &quot;$app [$dist/$arch] ${SPECFILE/*\/} $LOGFILE&quot; &gt;&gt;/dar/log/dar-build-failed.log
-#				bzip2 -9 -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE&quot;
-				gzip -9 --rsyncable -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE&quot;
-			fi
-			rm -f &quot;$NEWSPECFILE&quot;
-		done
-	done
+                ### Clean up current and older logfile
+                rm -f &quot;$DISTCC_LOG&quot;
 
-	RPMFILE=&quot;$app-$VERSION-$RELEASE.$TAG.src.rpm&quot;
-	### Only build when there was a succesful binary build
-#	if [ -z &quot;$NOSOURCE&quot; -a &quot;$DARBUILDRC&quot; -eq 0 -o ! -f &quot;$PACKAGEDIR/$app/$RPMFILE&quot; ]; then
-	if [ -z &quot;$NOSOURCE&quot; -a &quot;$DARBUILDRC&quot; -eq 0 ]; then
+                if [ -z &quot;$SOURCE_DISTS&quot; ]; then
+                    SOURCE_DISTS=&quot;$DISTNICK&quot;
+                fi
+            else
+#               log &quot;Failed building package $app for $dist/$arch.&quot; &gt;&gt; &quot;$LOGDIR/dar.log&quot;
+                error &quot;${_RE}Failed${_DE} $app [$dist/$arch], see log [$SPECDIR/_buildlogs/$LOGFILE_KO]&quot;
+                echo &quot;$app [$dist/$arch] ${SPECFILE/*\/} $LOGFILE_KO&quot; &gt;&gt;/dar/log/dar-build-failed.log
+#               bzip2 -9 -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO&quot;
+                gzip -9 --rsyncable -f &quot;$PACKAGEDIR/$app/_buildlogs/$LOGFILE_KO&quot;
+            fi
+            rm -f &quot;$NEWSPECFILE&quot;
+        done
+    done
 
-		if [ -z &quot;$SOURCE_DISTS&quot; ]; then SOURCE_DISTS=&quot;$DEFAULT_SOURCE_DISTS&quot;; fi
+    RPMFILE=&quot;$app-$VERSION-$RELEASE.$TAG.src.rpm&quot;
+    ### Only build when there was a succesful binary build
+#   if [ -z &quot;$NOSOURCE&quot; -a &quot;$DARBUILDRC&quot; -eq 0 -o ! -f &quot;$PACKAGEDIR/$app/$RPMFILE&quot; ]; then
+    if [ -z &quot;$NOSOURCE&quot; -a &quot;$DARBUILDRC&quot; -eq 0 ]; then
 
-		for dist in $SOURCE_DISTS; do
-			if [ -r &quot;$CONFIGDIR/dists/$dist/config&quot; ]; then
-				source &quot;$CONFIGDIR/dists/$dist/config&quot;
-			else
-				warning &quot;Configfile $CONFIGDIR/dists/$dist/config missing. Aborting.&quot;
-				continue
-			fi
+        if [ -z &quot;$SOURCE_DISTS&quot; ]; then SOURCE_DISTS=&quot;$DEFAULT_SOURCE_DISTS&quot;; fi
 
-			RPMFILE=&quot;$app-$VERSION-$RELEASE.$TAG.src.rpm&quot;
+        for dist in $SOURCE_DISTS; do
+            if [ -r &quot;$CONFIGDIR/dists/$dist/config&quot; ]; then
+                source &quot;$CONFIGDIR/dists/$dist/config&quot;
+            else
+                warning &quot;Configfile $CONFIGDIR/dists/$dist/config missing. Aborting.&quot;
+                continue
+            fi
 
-			NEWSPECFILE=&quot;$TEMPDIR/$app.spec&quot;
-			cp -af &quot;$SPECFILE&quot; &quot;$NEWSPECFILE&quot;
-			export buildarch=&quot;src&quot; distarch=&quot;$DISTARCH&quot; disttag=&quot;$DISTNAME&quot; specfile=&quot;$NEWSPECFILE&quot; repotag=&quot;$TAG&quot;
-			for script in $CONFIGDIR/scripts/pre-*.sh; do
-				source &quot;$script&quot;
-			done
+            RPMFILE=&quot;$app-$VERSION-$RELEASE.$TAG.src.rpm&quot;
 
-			if [ &quot;$FORCE_VERBOSE&quot; == &quot;yes&quot; ]; then
-				echo &quot;Building source package $app using \&quot;$SPECFILE\&quot; for $dist&quot;
-			fi
-			chroot &quot;$CHROOTDIR/$dist&quot; /usr/bin/rpmbuild -bs \
-				--define &quot;_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm&quot; \
-				--define &quot;_srcrpmdir $PACKAGEDIR/$app&quot; \
-				--define &quot;_sourcedir $SPECDIR&quot; \
-				--define &quot;$dist 1&quot; \
-				--define &quot;dist $DISTNAME&quot; \
-				--define &quot;disttag $DISTNAME&quot; \
-				--define &quot;$DISTNAME 1&quot; \
-				&quot;$NEWSPECFILE&quot; &amp;&gt;/dev/null
-			RC=$?
-			if [ $RC -eq 0 ]; then
-				if [ &quot;$FORCE_VERBOSE&quot; == &quot;yes&quot; ]; then
-					echo -e &quot;${_GR}Success${_DE} $app [$dist/src], file in [$PACKAGEDIR/$app/]&quot;
-				fi
-				echo &quot;$app [$dist/src] ${SPECFILE/*\/}&quot; &gt;&gt;/dar/log/dar-build-success.log
-			else
-				error &quot;${_RE}Failed${_DE} $app [$dist/src], see log [$SPECDIR/_buildlogs/$LOGFILE]&quot;
-				echo &quot;$app [$dist/src] ${SPECFILE/*\/}&quot; &gt;&gt;/dar/log/dar-build-failed.log
-			fi
+            NEWSPECFILE=&quot;$TEMPDIR/$app.spec&quot;
+            cp -af &quot;$SPECFILE&quot; &quot;$NEWSPECFILE&quot;
+            export buildarch=&quot;src&quot; distarch=&quot;$DISTARCH&quot; disttag=&quot;$DISTNAME&quot; specfile=&quot;$NEWSPECFILE&quot; repotag=&quot;$TAG&quot;
+            for script in $CONFIGDIR/scripts/pre-*.sh; do
+                source &quot;$script&quot;
+            done
 
-			cp -au &quot;$SPECFILE&quot; &quot;$PACKAGEDIR/$app/&quot;
-		done
+            if [ &quot;$FORCE_VERBOSE&quot; == &quot;yes&quot; ]; then
+                echo &quot;Building source package $app using \&quot;$SPECFILE\&quot; for $dist&quot;
+            fi
+            chroot &quot;$CHROOTDIR/$dist&quot; /usr/bin/rpmbuild -bs \
+                --define &quot;_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm&quot; \
+                --define &quot;_srcrpmdir $PACKAGEDIR/$app&quot; \
+                --define &quot;_sourcedir $SPECDIR&quot; \
+                --define &quot;$dist 1&quot; \
+                --define &quot;dist $DISTNAME&quot; \
+                --define &quot;disttag $DISTNAME&quot; \
+                --define &quot;$DISTNAME 1&quot; \
+                &quot;$NEWSPECFILE&quot; &amp;&gt;/dev/null
+            RC=$?
+            if [ $RC -eq 0 ]; then
+                if [ &quot;$FORCE_VERBOSE&quot; == &quot;yes&quot; ]; then
+                    echo -e &quot;${_GR}Success${_DE} $app [$dist/src], file in [$PACKAGEDIR/$app/]&quot;
+                fi
+                echo &quot;$app [$dist/src] ${SPECFILE/*\/}&quot; &gt;&gt;/dar/log/dar-build-success.log
+            else
+                error &quot;${_RE}Failed${_DE} $app [$dist/src], see log [$SPECDIR/_buildlogs/$LOGFILE]&quot;
+                echo &quot;$app [$dist/src] ${SPECFILE/*\/}&quot; &gt;&gt;/dar/log/dar-build-failed.log
+            fi
 
-	fi
+            cp -au &quot;$SPECFILE&quot; &quot;$PACKAGEDIR/$app/&quot;
+        done
+
+    fi
 done
 
 exit 0

Modified: trunk/tools/dar/dar-functions
===================================================================
--- trunk/tools/dar/dar-functions	2008-05-09 19:56:13 UTC (rev 6306)
+++ trunk/tools/dar/dar-functions	2008-05-09 20:59:58 UTC (rev 6307)
@@ -96,7 +96,8 @@
 		fi
 
     (
-	if [ -z &quot;$DISTNICK&quot; ] || [ &quot;$RPMVER&quot; \&lt; &quot;4.1&quot; ] || ! chroot &quot;$CHROOTDIR/$DISTNICK&quot; /bin/su -lm $BUILD_USER -c &quot;rpmdb -D \&quot;dist $DISTNAME\&quot; -D \&quot;disttag $DISTNAME\&quot; -D \&quot;$DISTNICK 1\&quot; -D \&quot;$DISTNAME 1\&quot; -E \&quot;%{expand:%(head -n128 $SPECFILE)}\&quot;&quot; | grep -i &quot;^ *$CONFIG *:&quot; | sed -e &quot;s/^ *$CONFIG *: *//i&quot; | head -1; then
+#	if [ -z &quot;$DISTNICK&quot; ] || [ &quot;$RPMVER&quot; \&lt; &quot;4.1&quot; ] || ! chroot &quot;$CHROOTDIR/$DISTNICK&quot; /bin/su -lm $BUILD_USER -c &quot;rpmdb -D \&quot;dtag $DISTNAME\&quot; -D \&quot;disttag $DISTNAME\&quot; -D \&quot;$DISTNICK 1\&quot; -D \&quot;$DISTNAME 1\&quot; -E \&quot;%{expand:%(head -n128 $SPECFILE)}\&quot;&quot; | grep -i &quot;^ *$CONFIG *:&quot; | sed -e &quot;s/^ *$CONFIG *: *//i&quot; | head -1; then
+	if [ -z &quot;$DISTNICK&quot; ] || [ &quot;$RPMVER&quot; \&lt; &quot;4.1&quot; ] || ! chroot &quot;$CHROOTDIR/$DISTNICK&quot; /bin/su -lm $BUILD_USER -c &quot;rpmdb -D \&quot;dtag $DISTNAME\&quot; -D \&quot;disttag $DISTNAME\&quot; -D \&quot;$DISTNICK 1\&quot; -D \&quot;$DISTNAME 1\&quot; -E \&quot;%{expand:%(head -n128 $SPECFILE)}\&quot;&quot; | grep -i &quot;^ *$CONFIG *:&quot; | sed -e &quot;s/^ *$CONFIG *: *//i&quot; | head -1; then
 		if ! grep -i &quot;^ *$CONFIG *:&quot; $SPECFILE | sed -e &quot;s/^ *$CONFIG *: *//i&quot; | head -1; then
 			debug &quot;Config $CONFIG not found in $SPECFILE&quot;
 		fi
@@ -526,9 +527,9 @@
 	done
 	echo &quot;&lt;/repomd&gt;&quot; &gt;&gt;&quot;$REPODATA/repomd.xml&quot;
 
-	echo &quot;Building repoview.&quot;
-	repoview --quiet --title=&quot;RPMforge: $DISTDESC&quot; &quot;$FTPDIR/$DISTPATH/$REPO&quot;
-	repoview --quiet --url=&quot;<A HREF="http://apt.sw.be/$DISTPATH/">http://apt.sw.be/$DISTPATH/</A>&quot; &quot;$FTPDIR/$DISTPATH/$REPO&quot;
+#	echo &quot;Building repoview.&quot;
+#	repoview --quiet --title=&quot;RPMforge: $DISTDESC&quot; &quot;$FTPDIR/$DISTPATH/$REPO&quot;
+#	repoview --quiet --url=&quot;<A HREF="http://apt.sw.be/$DISTPATH/">http://apt.sw.be/$DISTPATH/</A>&quot; &quot;$FTPDIR/$DISTPATH/$REPO&quot;
 }
 
 function build_repo_srpms {

Modified: trunk/tools/dar/dar-perl.py
===================================================================
--- trunk/tools/dar/dar-perl.py	2008-05-09 19:56:13 UTC (rev 6306)
+++ trunk/tools/dar/dar-perl.py	2008-05-09 20:59:58 UTC (rev 6307)
@@ -258,7 +258,7 @@
     realversion = version
     ### FIXME: take care of file like Acme-6502-v0.0.6 or something.tgz
     ### Get the version from the cdistname
-    m = re.match('[^\d]+([\d\.]+).tar.gz', cdistname)
+    m = re.match('[^\d]+([\d\.\w]+).tar.gz', cdistname)
     if m:
         l = m.groups()
         version = l[0]
@@ -515,7 +515,7 @@
 ### FIXME: Add BuildRequires from Makefile.PL ?
 if meta.has_key('requires') and meta['requires'] and meta['requires'].has_key('perl'):
     ### FIXME: lstrip 'v' from version if it is a string
-    print &gt;&gt;out, &quot;BuildRequires: perl &gt;= %s &quot; % epochify(meta['requires']['perl'])
+    print &gt;&gt;out, &quot;BuildRequires: perl &gt;= %s&quot; % epochify(meta['requires']['perl'])
 else:
     print &gt;&gt;out, 'BuildRequires: perl'
 
@@ -532,6 +532,10 @@
         else:
             print &gt;&gt;out, &quot;BuildRequires: perl(%s)&quot; % key
 
+if meta.has_key('requires') and meta['requires'] and meta['requires'].has_key('perl'):
+    ### FIXME: lstrip 'v' from version if it is a string
+    print &gt;&gt;out, &quot;Requires: perl &gt;= %s&quot; % epochify(meta['requires']['perl'])
+
 ### Requires are extracted by RPM itself
 #print &quot;Requires: perl&quot;
 #if meta.has_key('requires'):

Modified: trunk/tools/dar/dar.conf
===================================================================
--- trunk/tools/dar/dar.conf	2008-05-09 19:56:13 UTC (rev 6306)
+++ trunk/tools/dar/dar.conf	2008-05-09 20:59:58 UTC (rev 6307)
@@ -29,10 +29,12 @@
 DISTCC_HOSTS=&quot;emyn localhost&quot;
 
 ### Variables for dar-sync
-RSYNC_OPTIONS=&quot;-avHl --progress --delete-after --exclude /bert/ --exclude /dries/ --exclude /redhat/6.2/ --exclude /redhat/8.0/ --include /rpmforge/persona/dag/ --exclude /rpmforge/persona/* --delay-updates&quot;
+#RSYNC_OPTIONS=&quot;-avHl --progress --delete-after --delay-updates&quot;
+#RSYNC_TARGET=&quot;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at surya.karan.org</A>:/mnt/rpmforge/incoming/dag/packages/&quot;
 #RSYNC_OPTIONS=&quot;-avHl --progress --delete-after --exclude /bert/ --exclude /dries/ --exclude /redhat/6.2/ --exclude /redhat/8.0/ --include /rpmforge/persona/dag/ --exclude /rpmforge/persona/* --delay-updates --fuzzy&quot;
+RSYNC_OPTIONS=&quot;-avHl --progress --delete-after --exclude /arrfab/ --exclude /bert/ --exclude /dries/ --exclude /redhat/6.2/ --exclude /redhat/8.0/ --include /rpmforge/persona/dag/ --exclude /rpmforge/persona/* --delay-updates&quot;
 RSYNC_TARGET=&quot;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at rsync.sw.be</A>:dag.wieers.com/pub/&quot;
 ### Use wondershaper
-RSYNC_LIMIT=&quot;16&quot;
+RSYNC_LIMIT=&quot;32&quot;
 GPG_PATH=&quot;/home/dag/.gnupg&quot;
 GPG_NAME=&quot;Dag Wieers (Dag Apt Repository v1.0)&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005105.html">[svn] r6306 - in trunk/rpms: dkms-kqemu fuse-ntfs-3g htop imapsync	python-celementtree tcpreplay uni2ascii yasm
</A></li>
	<LI>Next message: <A HREF="005107.html">[svn] r6308 - in trunk/rpms: . fontforge htpdate lshw	perl-Date-Holidays-DE perl-GStreamer perl-Geo-IP	perl-Lemonldap-NG-Manager perl-Lingua-Han-PinYin	perl-Lingua-Han-Stroke perl-Lingua-Han-Utils perl-List-Member	perl-Locale-Currency-Format perl-Locale-PO perl-Log-Trivial	perl-Params-Validate qemu wine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5106">[ date ]</a>
              <a href="thread.html#5106">[ thread ]</a>
              <a href="subject.html#5106">[ subject ]</a>
              <a href="author.html#5106">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
