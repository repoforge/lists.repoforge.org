<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r4122 - trunk/tools/yam
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r4122%20-%20trunk/tools/yam&In-Reply-To=%3C20060303085233.659EE3180D3%40pooch.vmhosting.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002921.html">
   <LINK REL="Next"  HREF="002923.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r4122 - trunk/tools/yam</H1>
    <B>packagers at lists.rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r4122%20-%20trunk/tools/yam&In-Reply-To=%3C20060303085233.659EE3180D3%40pooch.vmhosting.org%3E"
       TITLE="[svn] r4122 - trunk/tools/yam">packagers at lists.rpmforge.net
       </A><BR>
    <I>Fri Mar  3 09:52:33 CET 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002921.html">[svn] r4121 - in trunk/rpms: freelords gandi kleansweep libtorrent	svnmailer xnee yoltia
</A></li>
        <LI>Next message: <A HREF="002923.html">[svn] r4123 - trunk/tools/yam
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2922">[ date ]</a>
              <a href="thread.html#2922">[ thread ]</a>
              <a href="subject.html#2922">[ subject ]</a>
              <a href="author.html#2922">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dag
Date: 2006-03-03 09:52:32 +0100 (Fri, 03 Mar 2006)
New Revision: 4122

Modified:
   trunk/tools/yam/README.rhn
   trunk/tools/yam/yam
Log:
Documentation updates and small code improvements.

Modified: trunk/tools/yam/README.rhn
===================================================================
--- trunk/tools/yam/README.rhn	2006-03-02 22:26:44 UTC (rev 4121)
+++ trunk/tools/yam/README.rhn	2006-03-03 08:52:32 UTC (rev 4122)
@@ -42,13 +42,17 @@
 for but is simply not allowed to connect to the Internet.
 
 The gensystemid tool that comes with Yam will help you with creating
-valid systemids for Yam.
+valid systemids for Yam, eg.
 
+	gensystemid -r 4AS -a x86_64 /var/yam/rhel4as-x86_64
 
+You can manage your systems on the RHN website afterwards.
+
+
 Downloading from unsubscribed channels
 &quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
-You can now let Yam subscribe to the necessary channels, unfortunately
-this requires your RHN username and password. You can provide these in
+You can let Yam subscribe to the necessary channels, unfortunately this
+requires your RHN username and password. You can provide these in
 the main section, like:
 
 	[main]
@@ -68,8 +72,49 @@
 your system to the channels you require.
 
 
-Ignore packages you already have
-&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
+List of RHN channels
+&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
+For a complete and up-to-date list of available channels, check the RHN
+website. This list has been compiled with only EL2.1, EL3, EL4 and
+i386, x86_64 archs.
+
+	RHEL4
+		rhel-$arch-XX-4
+		rhel-$arch-XX-4-beta
+		rhel-$arch-XX-4-extras
+		rhel-$arch-XX-4-extras-beta
+		rhel-$arch-as-4-hwcert			(only for as)
+		rhel-$arch-XX-4-sdk
+		rhel-4-XX-$arch-rhaps-2
+		rhel-4-XX-$arch-rhaps-2-beta
+		rhel-4-XX-$arch-rhds-2.1
+		rhel-4-XX-$arch-rhds-2.1-beta
+
+
+	RHEL3
+		rhel-$arch-XX-3
+		rhel-$arch-XX-3-beta
+		rhel-$arch-XX-3-devsuite
+		rhel-$arch-XX-3-devsuite-beta
+		rhel-$arch-XX-3-extras
+		rhel-$arch-XX-3-extras-beta
+		rhel-$arch-as-3-hwcert			(only for as)
+		rhel-3-XX-i386-rhaps-1			(only for i386)
+		rhel-3-XX-$arch-rhaps-beta
+		rhel-3-XX-i386-rhds-2			(only for i386)
+
+	RHEL2.1
+		redhat-advanced-server-i386		(only for as)
+		redhat-ent-linux-i386-es-2.1		(only for es)
+		rhel-i386-XX-2.1-beta
+
+Where XX = as or es
+
+Please send updates on these.
+
+
+Ignore packages you already have elsewhere
+&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
 This is possible, although hard to implement currently. I could check
 whether the file exists on one of the ISOs (or in the RPMS/ directory),
 but I prefer to implement this after a redesign.
@@ -107,7 +152,7 @@
 &quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
 You can experiment with using a single systemid for multiple dists
 using the rhnrelease option:
-
+ 
 	[rhel3as]
 	rhnrelease = 3AS
 
@@ -115,47 +160,53 @@
 
 This works across the same entitlement. Eg. when you have an Advanced
 Server entitlement, you can download from 2.1AS, 3AS and 4AS channels.
-But not from the ES or WS channels and not for different architectures.
+But not from the ES or WS channels and not from different architectures.
 
-If you only have one systemid (eg. because you only have Advanced Server
-subscriptions) you don't have to move the systemid file, if Yam cannot
-find one in the dist directory, it will take the one from
-/etc/sysconfig/rhn/systemid
 
-
-Known problem with single systemid
-&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
+Known problems
+&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
 (Uninvestigated fully yet)
 
-I have seen problems when using a single systemid for multiple distributions
-in a single yam session. Somehow there is logininfo polution (subscribed
-channels from a previous distribution login polutes a subsequent login, ie.
-a previous EL2 run polutes the next EL3 channel subscription list in the same
-execute phase).
+I have seen the following problems:
 
-The result is that you will either get
+	'yam: Error subscribing %s to channel %s, skipping.'
+or
+	  File &quot;/usr/share/rhn/up2date_client/repoDirector.py&quot;, line 36, in getPackage
+	    return self.handlers[channel['type']].getPackage(pkg, msgCallback, progressCallback)
+	TypeError: unsubscriptable object
+or
+	yam: Error listing packages from channel rhel-i386-as-3-devsuite. Skipping.
+	Error communicating with server. The message was:
+	Authorization Required
 
-	'Failed to subscribe RHN id ... to channel ...'
-or	'Server already subscribed to ...'
+And when using a single systemid file, also:
 
-errors.
+	'yam: Failed to subscribe RHN id %s to channel %s, skipping.'
+or
+	'Server already subscribed to ...'
 
-So instead of doing:
 
-	yam -uxqg -d rhel2as,rhel3as,rhel4as
+Somehow there is loginInfo polution (subscribed channels from a previous
+distribution login polutes a subsequent login, ie. a previous EL2 run
+polutes the next EL3 channel subscription list in the same execute phase).
 
-a workaround would be to do:
+A workaround in this case is instead of doing:
 
-	for dist in rhel2as rhel3as rhel4as; do yam -uxqg -d $dist; done
+	yam -uxqg
+or	yam -uxqg -d rhel2as,rhel3as,rhel4as-i386,rhel4as-x86_64
 
+to do:
+
+	for dist in rhel2as rhel3as rhel4as-i386 rhel4as-x86_64; do
+		yam -uxqg -d $dist
+	done
+
 I still need to investigate and file a bugreport with Red Hat (seems to be
 a problem with the implementation of the python classes and the use of
-global variables in up2date).
+global variables in up2date). Although I clean the global variables used by
+the up2date classes, somehow some data is persistent.
 
-But the best thing to do is create a systemid file for every distribution
-and arch combination.
 
-
 RHN documentation and references
 &quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
 A useful list of RHN references:

Modified: trunk/tools/yam/yam
===================================================================
--- trunk/tools/yam/yam	2006-03-02 22:26:44 UTC (rev 4121)
+++ trunk/tools/yam/yam	2006-03-03 08:52:32 UTC (rev 4122)
@@ -640,19 +640,17 @@
 		return
 	mkdir(path)
 
-	opts = cf.rsyncoptions + ' --exclude=\&quot;/headers/\&quot; --exclude=\&quot;/repodata/\&quot;'
+	opts = cf.rsyncoptions
 	if op.verbose &lt;= 2: opts = opts + ' -q'
 	elif op.verbose == 3: opts = opts + ' -v'
 	elif op.verbose == 4: opts = opts + ' -v --progress'
 	elif op.verbose == 5: opts = opts + ' -vv --progress'
 	elif op.verbose &gt;= 6: opts = opts + ' -vvv --progress'
-
 	if op.dryrun: opts = opts + ' --dry-run'
-
 	if cf.rsynctimeout: opts = opts + ' --timeout=%s' % cf.rsynctimeout
 	if cf.rsynccleanup: opts = opts + ' --delete-after --delete-excluded'
 	if cf.rsyncbwlimit: opts = opts + ' --bwlimit=%s' % cf.rsyncbwlimit
-
+	opts = opts + ' --exclude=\&quot;/headers/\&quot; --exclude=\&quot;/repodata/\&quot;'
 	if cf.rsyncexclsrpm: opts = opts + ' --exclude=\&quot;*.src.rpm\&quot; --exclude=\&quot;/SRPMS/\&quot;'
 	if cf.rsyncexcldebug: opts = opts + ' --exclude=\&quot;*-debuginfo-*.rpm\&quot; --exclude=\&quot;/debug/\&quot;'
 	opts = opts + ' --include=\&quot;*.rpm\&quot;'
@@ -667,13 +665,12 @@
 		return
 	mkdir(path)
 
-	opts = cf.mirrordiroptions + ' -G \&quot;headers\&quot; -G \&quot;repodata\&quot;'
+	opts = cf.mirrordiroptions
 	if op.verbose &gt;= 3: opts = opts + ' -v' * (op.verbose - 3)	
-
 	if op.dryrun: opts = opts + ' --dry-run'
-
 	if cf.mirrordircleanup: opts = opts + ' -k'
 #	opts = opts + ' -I \&quot;*.rpm\&quot;'
+	opts = opts + ' -G \&quot;headers\&quot; -G \&quot;repodata\&quot;'
 	if cf.mirrordirexclsrpm: opts = opts + ' -G \&quot;*.src.rpm\&quot; -G \&quot;SRPMS\&quot;'
 	if cf.mirrordirexcldebug: opts = opts + ' -G \&quot;*-debuginfo-*.rpm\&quot; -G \&quot;debug\&quot;'
 
@@ -696,11 +693,8 @@
 
 	mirroropts = cf.lftpmirroroptions
 	if op.verbose &gt;= 3: mirroropts = mirroropts + ' -v' * (op.verbose - 2)
-
 	if op.dryrun: mirroropts = mirroropts + ' --dry-run'
-
 	if cf.lftpcleanup: mirroropts = mirroropts + ' -e'
-
 	mirroropts = mirroropts + ' -I *.rpm -X \&quot;/headers/\&quot; -X \&quot;/repodata/\&quot;'
 	if cf.lftpexclsrpm: mirroropts = mirroropts + ' -X \&quot;*.src.rpm\&quot; -X \&quot;/SRPMS/\&quot;'
 	if cf.lftpexcldebug: mirroropts = mirroropts + ' -X \&quot;*-debuginfo-*.rpm\&quot; -X \&quot;/debug/\&quot;'
@@ -726,41 +720,71 @@
 	dir = url.replace('<A HREF="yam://">yam://</A>', '')
 	symlink(os.path.join(cf.srcdir,dir), path)
 
-cfg = {}
-loginInfo = {}
+def rhnreset():
+	&quot;Clean up2date's global variables&quot;
+	global cfg, loginInfo, rd
+#	global cfg, loginInfo, rd, server_list, channel_blacklist, selected_channels, lastPercent
 
-def rhnlogin(url, path, dist):
-	global cfg, loginInfo
+### FIXME: Make module reloading work
+#	for mod in sys.modules:
+#		print mod
+#		reload(sys.module[mod])
+#		if mod in sys.modules.keys():
+#			reload(mod)
+#		else:
+#			print 'module %s not found.' % mod
 
+	cfg = {}
+	loginInfo = {}
+	rd = None
+
+#	server_list = None
+#	channel_blacklist = None
+#	selected_channels = None
+#	lastPercent = None
+#	pkgSack = None
+
+def rhnlogin(url, path, dist, force=False):
+	global cfg, loginInfo, rd
+#	global cfg, loginInfo, rd, server_list, channel_blacklist, selected_channels, lastPercent
+
 	rhnscheme, rhnserver, t, t, t, t = urlparse.urlparse(url)
 
 	if os.path.isfile(os.path.join(cf.srcdir, dist.nick, 'systemid')):
-		rhnsystemid = os.path.join(cf.srcdir, dist.nick, 'systemid')
+		systemidpath = os.path.join(cf.srcdir, dist.nick, 'systemid')
 	elif os.path.isfile('/etc/sysconfig/rhn/systemid'):
-		rhnsystemid = '/etc/sysconfig/rhn/systemid'
+		systemidpath = '/etc/sysconfig/rhn/systemid'
 	else:
 		info(1, 'No RHN systemid found, skipping download.')
 		return
-	info(5, 'Using RHN systemid from %s' % rhnsystemid)
+	info(5, 'Using RHN systemid from %s' % systemidpath)
 
+	systemid = open(systemidpath).read()
+
 	from up2date_client import config, rpcServer
 	from rhn import rpclib
 
-	cfg = {}
-	loginInfo = {}
+	rhnreset()
 
-	cfg['systemIdPath'] = rhnsystemid
+	cfg['systemIdPath'] = systemidpath
 	cfg = config.initUp2dateConfig()
-	cfg['systemIdPath'] = rhnsystemid
+	cfg['systemIdPath'] = systemidpath
 	cfg['storageDir'] = path
 	cfg['retrieveOnly'] = 1
 	cfg['keepAfterInstall'] = 1
 	cfg['noReboot'] = 1
 	cfg['useRhn'] = 1
 	cfg['showChannels'] = 1
+	cfg['showAvailablePackages'] = 1
+	cfg['isatty'] = 1
+	cfg['networkRetries'] = 3
+#	cfg['headerFetchCount'] = 20
 
 	if dist.rhnrelease:
 		cfg['versionOverride'] = dist.rhnrelease
+	else:
+		cfg['versionOverride'] = rpclib.xmlrpclib.loads(systemid)[0][0]['os_release']
+	info(5, 'Using RHN release %s' % cfg['versionOverride'])
 
 	if dist.arch:
 		cfg['forceArch'] = '%s-redhat-linux' % dist.arch
@@ -775,40 +799,30 @@
 	if op.verbose &gt;= 5:
 		cfg['debug'] = 10000
 
-	server = rpcServer.getServer()
-	systemid = open(cfg['systemIdPath']).read()
-#	info(5, '\nBEFORE LOGIN: logininfo: %s\n' % loginInfo)
+	info(6, '\nBEFORE LOGIN: logininfo: %s\n' % loginInfo)
 	try:
-		loginInfo = rpcServer.doCall(server.up2date.login, systemid)
+		server = rpcServer.getServer()
+		li = rpcServer.doCall(server.up2date.login, systemid)
+		loginInfo.update(li)
 	except rpclib.Fault, f:
-		info(0, 'Error logging in %s with systemid %s. %s' % (dist.nick, rhnsystemid, f.faultString))
-		return server, systemid
+		info(0, 'Error logging in %s with systemid %s. %s' % (dist.nick, systemidpath, f.faultString))
+		return None, None
 	info(6, '\nAFTER LOGIN: logininfo: %s\n' % loginInfo)
 
-	return server, systemid
+	return systemid
 
 def rhnprintchannels(repos, str):
 	global loginInfo
-	from up2date_client import rpcServer, rhnChannel
-	server = rpcServer.getServer()
-	systemid = open(cfg['systemIdPath']).read()
-	channels = rpcServer.doCall(server.up2date.listChannels, systemid)
-	info(1, str + ' s.u.listChannels: %s' % [ch['label'] for ch in channels])
+#	from up2date_client import rpcServer, rhnChannel
+#	systemid = open(cfg['systemIdPath']).read()
+#	server = rpcServer.getServer()
+#	channels = rpcServer.doCall(server.up2date.listChannels, systemid)
+#	info(1, str + ' s.u.listChannels: %s' % [ch['label'] for ch in channels])
+	info(1, str + ' logininfo: %s' % loginInfo.get('X-RHN-Auth-Channels'))
 	info(1, str + ' r.c.list: %s' % [ch['label'] for ch in repos.channels.list])
-	info(1, str + ' r.gC.list: %s' % [ch['label'] for ch in rhnChannel.getChannels().list])
-	info(1, str + ' logininfo: %s' % loginInfo.get('X-RHN-Auth-Channels'))
-	print
+#	info(1, str + ' r.gC.list: %s' % [ch['label'] for ch in rhnChannel.getChannels().list])
+#	print
 
-def rhnischannel(channels, label):
-	for c in channels:
-		if isinstance(c, types.ListType):
-			l = c[0]
-		else:
-			l = c['label']
-		if l == label:
-			return True
-	return False
-
 def rhngetchannel(channels, label):
 	import types
 	for c in channels:
@@ -840,25 +854,22 @@
 	t, t, label, t, t, t = urlparse.urlparse(url)
 	label = label.strip('/')
 
-	from up2date_client import config, rpcServer, wrapperUtils, rhnChannel, repoDirector, up2dateErrors
+	from up2date_client import rpcServer, wrapperUtils, up2dateErrors, repoDirector
 	from rhn import rpclib
 	import time, signal
 
-	### Clean up2date's global variables
-	global cfg, loginInfo
-
-	server, systemid = rhnlogin(url, path, dist)
+	systemid = rhnlogin(url, path, dist)
 	if not systemid: return
 
 	mkdir(cfg['storageDir'])
-	repos = repoDirector.initRepoDirector()
 
+	channel = rhngetchannel(loginInfo.get('X-RHN-Auth-Channels'), label)
 #	rhnprintchannels(repos, '=&gt; 1 &lt;=')
-	channels = loginInfo.get('X-RHN-Auth-Channels')
-	if not rhnischannel(channels, label):
+	if not channel:
 		if cf.rhnlogin:
 			rhnusername, rhnpasswd = cf.rhnlogin.split(':')
-			try:
+		   	try:
+				server = rpcServer.getServer()
 				channels = rpcServer.doCall(server.up2date.subscribeChannels, systemid, (label,), rhnusername, rhnpasswd)
 			except rpclib.Fault, f:
 				error(0, 'Error subscribing %s to channel %s, skipping.%s' % (dist.nick, label, f.faultString))
@@ -866,13 +877,13 @@
 #			rhnprintchannels(repos, '=&gt; 2 &lt;=')
 #			repos.channels.addChannel({'label':label, 'type':'up2date', 'version':'1000', 'url':cfg['serverURL']})
 #			rhnChannel.updateChannels(channels)
-			server, systemid = rhnlogin(url, path, dist)
+			systemid = rhnlogin(url, path, dist, force=True)
 			if not systemid: return
 #			rhnprintchannels(repos, '=&gt; 3 &lt;=')
 
 			info(6, '\nAFTER SUBSC: logininfo: %s\n' % loginInfo)
-			channels = loginInfo.get('X-RHN-Auth-Channels')
-			if not rhnischannel(channels, label):
+			channel = rhngetchannel(loginInfo.get('X-RHN-Auth-Channels'), label)
+			if not channel:
 				error(0, 'Failed to subscribe RHN id %s to channel %s, skipping.' % (dist.nick, label))
 				return
 		else:
@@ -880,15 +891,8 @@
 			return
 
 #	rhnprintchannels(repos, '=&gt; 4 &lt;=')
-	channels = loginInfo.get('X-RHN-Auth-Channels')
-	channel = rhngetchannel(channels, label)
-	
-	if not channel:
-		info(1, 'Something wicked happened. Channel %s was succesfully subscribed to, but not found.' % label)
-		return
 
-#	rhnprintchannels(repos, '=&gt; 6 &lt;=')
-
+	repos = repoDirector.initRepoDirector()
 	### FIXME: Make packagelist download verbose (hash progress)
 #	if cf.rhnallpkgs:
 #		method = repos.listAllPackages
@@ -1116,8 +1120,6 @@
 except NameError:
      True = 1
      False = 0
-Yes = yes = On = on = True
-No = no = Off = off = False
 
 ### Main entrance
 if __name__ == '__main__':


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002921.html">[svn] r4121 - in trunk/rpms: freelords gandi kleansweep libtorrent	svnmailer xnee yoltia
</A></li>
	<LI>Next message: <A HREF="002923.html">[svn] r4123 - trunk/tools/yam
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2922">[ date ]</a>
              <a href="thread.html#2922">[ thread ]</a>
              <a href="subject.html#2922">[ subject ]</a>
              <a href="author.html#2922">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
