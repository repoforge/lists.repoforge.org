<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r3531 - in trunk/tools/pydar2: . dries dries/pydar2 pydar	scripts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r3531%20-%20in%20trunk/tools/pydar2%3A%20.%20dries%20dries/pydar2%20pydar%0A%09scripts&In-Reply-To=%3C20050824214007.7FDCA318033%40pooch.vmhosting.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002331.html">
   <LINK REL="Next"  HREF="002333.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r3531 - in trunk/tools/pydar2: . dries dries/pydar2 pydar	scripts</H1>
    <B>packagers at lists.rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r3531%20-%20in%20trunk/tools/pydar2%3A%20.%20dries%20dries/pydar2%20pydar%0A%09scripts&In-Reply-To=%3C20050824214007.7FDCA318033%40pooch.vmhosting.org%3E"
       TITLE="[svn] r3531 - in trunk/tools/pydar2: . dries dries/pydar2 pydar	scripts">packagers at lists.rpmforge.net
       </A><BR>
    <I>Wed Aug 24 23:40:07 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002331.html">[svn] r3530 - in trunk/web/rpmforge.net: . developer dweb packager	packager/distributions packager/persona packager/persona/bert	packager/persona/dag packager/persona/dries	packager/persona/matthias user user/community user/faq
</A></li>
        <LI>Next message: <A HREF="002333.html">[svn] r3532 - trunk/rpms/gstreamer-python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2332">[ date ]</a>
              <a href="thread.html#2332">[ thread ]</a>
              <a href="subject.html#2332">[ subject ]</a>
              <a href="author.html#2332">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dries
Date: 2005-08-24 23:40:06 +0200 (Wed, 24 Aug 2005)
New Revision: 3531

Modified:
   trunk/tools/pydar2/Makefile
   trunk/tools/pydar2/dries/mirrors-part.html
   trunk/tools/pydar2/dries/pydar2/planning-part.html
   trunk/tools/pydar2/pydar/buildroot.py
   trunk/tools/pydar2/pydar/config.py
   trunk/tools/pydar2/pydar/postgresqlstorage.py
   trunk/tools/pydar2/pydar/smartbasedbuildroot.py
   trunk/tools/pydar2/pydar/svnwrapper.py
   trunk/tools/pydar2/pydar/yumbasedbuildroot.py
   trunk/tools/pydar2/scripts/norpmforgetemplatesfilter.py
   trunk/tools/pydar2/scripts/rpmforgesite.py
Log:
update

Modified: trunk/tools/pydar2/Makefile
===================================================================
--- trunk/tools/pydar2/Makefile	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/Makefile	2005-08-24 21:40:06 UTC (rev 3531)
@@ -17,6 +17,7 @@
 	echo cleaning up..
 	rm -f *~ */*~
 	echo nothing to build
+	touch emptyfile
 
 install:
 	install -m0755 -d  \
@@ -32,7 +33,8 @@
 		$(DESTDIR)$(datadir)/pydar2/sql \
 		$(DESTDIR)$(datadir)/pydar2/dries \
 		$(DESTDIR)$(datadir)/pydar2/dries/pydar2 \
-		$(DESTDIR)$(datadir)/pydar2/scripts
+		$(DESTDIR)$(datadir)/pydar2/scripts \
+		$(DESTDIR)$(sysconfdir)/pydar2/rpmforgeacceptcommandconfig
 	install -m0755 $(DIST_PYSCRIPTS) log4py.conf $(DESTDIR)$(datadir)/pydar2/
 	install -m0755 $(DIST_ETCFILES) $(DESTDIR)$(sysconfdir)/pydar2/
 	install -m0755 $(DIST_BASHSCRIPTS) $(DESTDIR)$(bindir)
@@ -43,8 +45,9 @@
 	install sql/master.sql $(DESTDIR)$(datadir)/pydar2/sql
 	install dries/*.txt dries/*.html $(DESTDIR)$(datadir)/pydar2/dries/
 	install dries/pydar2/*.html dries/pydar2/*.png dries/pydar2/*.xmi $(DESTDIR)$(datadir)/pydar2/dries/pydar2/
-
-	
+	install -m0755 emptyfile $(DESTDIR)$(sysconfdir)/pydar2/rpmforgeacceptcommandconfig/excludedauthoritytags
+	install -m0755 emptyfile $(DESTDIR)$(sysconfdir)/pydar2/rpmforgeacceptcommandconfig/excluded	
+	install -m0755 emptyfile $(DESTDIR)$(sysconfdir)/pydar2/rpmforgeacceptcommandconfig/temporarilyexcluded
 	#install -m0755 scripts/* $(DESTDIR)$(sysconfdir)/rc.d/init.d
 	#install -m0755 defaults.conf $(DESTDIR)$(datadir)/pydar/
 	#install -m0755 pydar.conf $(DESTDIR)$(sysconfdir)/pydar/

Modified: trunk/tools/pydar2/dries/mirrors-part.html
===================================================================
--- trunk/tools/pydar2/dries/mirrors-part.html	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/dries/mirrors-part.html	2005-08-24 21:40:06 UTC (rev 3531)
@@ -23,6 +23,9 @@
   &lt;li&gt;&lt;a href=&quot;<A HREF="http://rh-mirror.linux.iastate.edu/pub/dag/dries/">http://rh-mirror.linux.iastate.edu/pub/dag/dries/</A>&quot;&gt;<A HREF="http://rh-mirror.linux.iastate.edu/pub/dag/dries/&lt;/a">http://rh-mirror.linux.iastate.edu/pub/dag/dries/&lt;/a</A>&gt;&lt;/li&gt;
   &lt;li&gt;&lt;a href=&quot;<A HREF="http://ftp.riken.jp/Linux/dag/dries/">http://ftp.riken.jp/Linux/dag/dries/</A>&quot;&gt;<A HREF="http://ftp.riken.jp/Linux/dag/dries/&lt;/a">http://ftp.riken.jp/Linux/dag/dries/&lt;/a</A>&gt;&lt;/li&gt;
   &lt;li&gt;&lt;a href=&quot;<A HREF="ftp://ftp.cs.uu.nl/mirror/dag.wieers/dries">ftp://ftp.cs.uu.nl/mirror/dag.wieers/dries</A>&quot;&gt;<A HREF="ftp://ftp.cs.uu.nl/mirror/dag.wieers/dries&lt;/a">ftp://ftp.cs.uu.nl/mirror/dag.wieers/dries&lt;/a</A>&gt;&lt;/li&gt;
+  &lt;li&gt;&lt;a href=&quot;<A HREF="http://www.mirrorservice.org/sites/apt.sw.be/dries/">http://www.mirrorservice.org/sites/apt.sw.be/dries/</A>&quot;&gt;<A HREF="http://www.mirrorservice.org/sites/apt.sw.be/dries/&lt;/a">http://www.mirrorservice.org/sites/apt.sw.be/dries/&lt;/a</A>&gt;&lt;/li&gt;
+  &lt;li&gt;&lt;a href=&quot;<A HREF="ftp://ftp.mirrorservice.org/sites/apt.sw.be/dries/">ftp://ftp.mirrorservice.org/sites/apt.sw.be/dries/</A>&quot;&gt;<A HREF="ftp://ftp.mirrorservice.org/sites/apt.sw.be/dries/&lt;/a">ftp://ftp.mirrorservice.org/sites/apt.sw.be/dries/&lt;/a</A>&gt;&lt;/li&gt;
+  &lt;li&gt;&lt;a href=&quot;<A HREF="rsync://rsync.mirrorservice.org/sites/apt.sw.be/dries/">rsync://rsync.mirrorservice.org/sites/apt.sw.be/dries/</A>&quot;&gt;<A HREF="rsync://rsync.mirrorservice.org/sites/apt.sw.be/dries/&lt;/a">rsync://rsync.mirrorservice.org/sites/apt.sw.be/dries/&lt;/a</A>&gt;&lt;/li&gt;
   
 &lt;/ul&gt;
 &lt;/p&gt;

Modified: trunk/tools/pydar2/dries/pydar2/planning-part.html
===================================================================
--- trunk/tools/pydar2/dries/pydar2/planning-part.html	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/dries/pydar2/planning-part.html	2005-08-24 21:40:06 UTC (rev 3531)
@@ -1,4 +1,12 @@
 &lt;a href=&quot;index.html&quot;&gt;Back&lt;/a&gt;&lt;br /&gt; 
+&lt;h2&gt;Recent changes:&lt;/h2&gt;
+&lt;p&gt;
+&lt;ul&gt;
+  &lt;li&gt;New option in master config: checkmissingtagsperdistro. When this option is set, the master checks if the most recent version of each spec file has tags for each distro/arch combination in 
+  the database. This slows down the startup a lot and it shouldn't be needed with normal use.&lt;/li&gt;
+  &lt;li&gt;Fix: the slave now creates the cache dirs for yum if needed.&lt;/li&gt;
+&lt;/ul&gt;
+&lt;/p&gt;
 &lt;h2&gt;Short term:&lt;/h2&gt;
 &lt;p&gt;
 &lt;ul&gt;
@@ -12,7 +20,6 @@
   &lt;li&gt;finish the spec file of pydar2 and build the rpms + put them online: not yet done.. &lt;/li&gt;
   &lt;li&gt;Basic version of autoqueueing: done&lt;/li&gt;
   &lt;li&gt;RsyncYumBasedBuildRoot: first version done&lt;/li&gt;
-  
 &lt;/ul&gt;
 &lt;/p&gt;
 &lt;h2&gt;Near future:&lt;/h2&gt;

Modified: trunk/tools/pydar2/pydar/buildroot.py
===================================================================
--- trunk/tools/pydar2/pydar/buildroot.py	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/pydar/buildroot.py	2005-08-24 21:40:06 UTC (rev 3531)
@@ -31,13 +31,15 @@
 # normally you should check the result each time
 
 from log4py import Logger
+import buildrootresult
+import commands, re, os, string, shutil
 #from specfile import SpecFile
 
 class BuildRoot:
     # this will already set certain variables
     def __init__(self,buildRootTag):
-        self.__cat = Logger().get_instance(self)
-        self.__cat.debug(&quot;start&quot;)
+        self._cat = Logger().get_instance(self)
+        self._cat.debug(&quot;start&quot;)
         self._setBuildRootTag(buildRootTag)
     
     def _setBuildRootTag(self,buildRootTag):
@@ -47,23 +49,14 @@
     def getBuildRootTag(self):
         return self.__buildRootTag
     
-    # this cleans up this root
-    # depends on the implementation
-    # the result is a BuildRootResult object
-    def cleanRoot(self):
-        self.__cat.debug(&quot;start&quot;)
     
     # this prepares a buildroot so it can be used for building an rpm
     # this calls cleanRoot if needed
     # this creates the buildRoot from scratch if needed
     # the result is a BuildRootResult object
     def prepareRoot(self):
-        self.__cat.debug(&quot;start&quot;)
+        self._cat.debug(&quot;start&quot;)
        
-    # the argument is a SlaveCommand object
-    # the result is a BuildRootResult object
-    def buildRpm(self,command):
-        self.__cat.debug(&quot;start&quot;)
         
     # rpms is an array of strings (names of rpms)
     # this is used for installing the buildrequirements
@@ -71,5 +64,167 @@
     # otherwise you get a lot of errors (so use prepareRoot first)
     # the result is a BuildRootResult object
     def installRpms(self,rpms):
-        self.__cat.debug(&quot;start&quot;)
+        self._cat.debug(&quot;start&quot;)
+        raise Exception(&quot;you should override installRpms&quot;)
         
+    def setUseCacheOnly(self,bVar):
+        self.__useCacheOnly = bVar
+    
+    def _umounts(self, brr):
+        self._cat.debug(&quot;start&quot;)
+        cmd = &quot;sudo umount &quot; + self.rootdir + &quot;/proc&quot;
+        self.logCommandWithoutErrors(cmd,brr)
+        cmd = &quot;sudo umount &quot; + self.rootdir + &quot;/sys&quot;
+        self.logCommandWithoutErrors(cmd,brr)
+        
+    def cleanRoot(self):
+        self._cat.debug(&quot;cleaning this root..&quot;)
+        brr = buildrootresult.BuildRootResult(self)
+        self._umounts(brr)
+        cmd = &quot;sudo rm -Rf &quot; + self.rootdir
+        self.logCommand(cmd,brr)
+        return brr
+
+    def logCommands(self,cmdArr,brr):
+        for cmd in cmdArr:
+            self.logCommand(cmd,brr)
+            # todo: if error =&gt; stop
+        
+    def logCommand(self,cmd,brr):
+        brr.logDebugLine(&quot;CMD: Command line:&quot; + cmd)
+        (status,output) = commands.getstatusoutput(cmd)
+        brr.logDebugLine(&quot;CMD: Status:&quot; + str(status))
+        # first remove all the '\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*
+        output = re.sub('\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*',&quot;&quot;,output)
+        output = re.sub('\r',&quot;&quot;,output)
+        brr.logDebugLine(&quot;CMD: output:&quot; + str(output))
+        if status != 0:
+            brr.logErrorLine(&quot;CMD: status (&quot; + str(status) + &quot;) is not 0 !&quot;)
+        
+    def logCommandWithoutErrors(self,cmd,brr):
+        brr.logDebugLine(&quot;CMD: Command line:&quot; + cmd)
+        (status,output) = commands.getstatusoutput(cmd)
+        brr.logDebugLine(&quot;CMD: Status:&quot; + str(status))
+        # first remove all the '\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*
+        output = re.sub('\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*',&quot;&quot;,output)
+        output = re.sub('\r',&quot;&quot;,output)
+        brr.logDebugLine(&quot;CMD: output:&quot; + str(output))
+
+    def __getLogsAndRpmsAndSrpm(self,command,brr):
+        self._cat.debug(&quot;start&quot;)
+        shutil.copy(os.path.join(self.rootdir, &quot;buildlog.txt&quot;), command.getBuildDir())
+        cmd = &quot;gzip &quot; + command.getBuildDir() + &quot;/buildlog.txt&quot;
+        self.logCommand(cmd,brr)
+        # search in the /usr/src/redhat/RPMS and /usr/src/redhat/SRPMS dirs..
+        rpmsdir = os.path.join(self.rootdir,'usr/src/redhat/RPMS')
+        ld = os.listdir(rpmsdir)
+        for entry in ld:
+            self.__getRpmsOrSrpms(command,brr,os.path.join(rpmsdir,entry))
+        srpmsdir = os.path.join(self.rootdir,'usr/src/redhat/SRPMS')
+        self.__getRpmsOrSrpms(command,brr,srpmsdir)
+            
+    def __getRpmsOrSrpms(self,command,brr,path):
+        self._cat.debug('start, path=' + path)
+        ld  = os.listdir(path)
+        for entry in ld:
+            rindex = string.rfind(entry,'.rpm')
+            if os.path.isfile(os.path.join(path,entry)) and (rindex &gt; 0 and rindex == len(entry) - len('.rpm')):
+                # let's copy it
+                shutil.copy(os.path.join(path,entry),command.getBuildDir())
+                rindex = string.rfind(entry,'.src.rpm')
+                if  rindex &gt; 0 and rindex == len(entry) - len('.src.rpm'):
+                    brr.setSrpm(entry)
+                else:
+                    brr.addRpm(entry)
+    
+    def __createScript(self,command,brr):
+        self._cat.debug(&quot;start&quot;)
+        script = &quot;#!/bin/bash\n&quot;
+        script = script + 'for i in ' + self.rootdir + '/etc/profile.d/*.sh; do' + &quot;\n&quot;
+        script = script + '    if [ -r &quot;$i&quot; ]; then' + &quot;\n&quot;
+        script = script + '        . $i' + &quot;\n&quot;
+        script = script + &quot;    fi\n&quot;
+        script = script + &quot;done\n&quot;
+        script = script + &quot;chown -R root.root &quot; + self.rootdir + &quot;/usr/src/redhat\n&quot;
+        # the following command first checks if the dependencies are ok
+        # ex: --define '_topdir /var/lib/pydar2/roots/yum-fc3-i386/usr/src/redhat'
+        script = script + &quot;(echo file: &quot; + command.getSpecFileShortFileName() + &quot;;/usr/bin/rpmbuild --define '_topdir &quot; + self.rootdir + &quot;/usr/src/redhat' &quot; + command.getDefines() + &quot; --root=&quot; + self.rootdir + &quot; --nobuild --bs &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &amp;&amp; echo \&quot;deps check ok\&quot; &amp;&amp; &quot;
+        # do the real build
+        # todo: some 'post mortem analysis'
+        # if contains    error: Installed (but unpackaged) file(s) found:    -&gt; print output of a find in the buildroot
+        # if it contains a config.log:     See 'Config.log' for more details.
+        script = script + &quot;/usr/sbin/chroot &quot; + self.rootdir + &quot; /usr/bin/rpmbuild --nodeps -ba /usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &quot; + command.getDefines() + &quot; || &quot;
+        script = script + &quot;(echo ; echo ; echo CONFIG.LOG; echo ; cat &quot; + self.rootdir + &quot;/usr/src/redhat/BUILD/*/*onfig.log; echo ; echo ; echo FILES; echo ; echo ; (cd &quot; + self.rootdir  + &quot;/var/tmp/*-root*/ &amp;&amp; find .))) &gt; &quot; + self.rootdir + &quot;/buildlog.txt 2&gt;&amp;1&quot;
+        self._cat.debug( &quot;script contains: &quot; + script)
+        return script
+        
+    def __callBuildScript(self, scriptcontents, command, brr):
+        self._cat.debug(&quot;start&quot;)
+        # first write it to a temp file
+        filepath = self.rootdir + &quot;/tmp/pydar2build.sh&quot;
+        fd = open(filepath,&quot;w&quot;)
+        fd.write(scriptcontents)
+        fd.close()
+        cmd = &quot;sudo /bin/bash &quot; + self.rootdir + &quot;/tmp/pydar2build.sh&quot;
+        self.logCommand(cmd,brr)
+    
+    def __parseLog(self,command,brr):
+        self._cat.debug(&quot;start, not ready&quot;)
+
+    def buildRpm(self,command):
+        brr = buildrootresult.BuildRootResult(self)
+        self._cat.debug(&quot;start&quot;)
+        # copy the sources
+        self.__copySources(command,brr)
+        # create a script which does the actual building
+        scriptcontents = self.__createScript(command,brr)
+        # then we call the script
+        self.__callBuildScript(scriptcontents, command, brr)
+        # get all the results
+        self.__getLogsAndRpmsAndSrpm(command,brr)
+        # then we parse the log: get additional usefull files if need, for example config.log if the build has failed
+        self.__parseLog(command,brr)
+        return brr
+    
+    def __copySources(self,command,brr):
+        self._cat.debug(&quot;start&quot;)
+        startdir = command.getBuildDir()
+        listdir = os.listdir(startdir)
+        specdestdir = os.path.join(self.rootdir,'usr/src/redhat/SPECS')
+        sourcesdestdir = os.path.join(self.rootdir,'usr/src/redhat/SOURCES')
+        self._cat.debug('specdestdir: ' + specdestdir)
+        self._cat.debug('sourcesdestdir: ' + sourcesdestdir)
+        for entry in listdir:
+            rindex = string.rfind(entry,'.spec')
+            if os.path.isfile(os.path.join(startdir,entry)) and not (rindex &gt; 0 and rindex == len(entry) - len('.spec')):
+                # its not the spec files
+                shutil.copy(os.path.join(startdir,entry), sourcesdestdir)
+            else:
+                # its the spec file
+                shutil.copy(os.path.join(startdir,entry),specdestdir)
+        self._cat.debug('copy done')
+            
+    def _setGeneralVars(self):
+        # this definetely has to move to a config file
+        self.minimalRpmsPart1 = &quot;basesystem filesystem setup bash glibc&quot;
+        self.minimalRpmsPart2 = &quot;coreutils findutils&quot;
+        self.minimalRpmsPart3 = &quot;rpm-devel rpm-build make gcc tar gzip patch unzip bzip2 diffutils cpio elfutils redhat-rpm-config perl&quot;
+        self.minimalRpmsPart4 = &quot;&quot;
+        
+    def _getGeneralPrepareRootCommands(self):
+        cmd = []
+        # create some directories first
+        cmd.append(&quot;sudo mkdir -p &quot; + self.rootdir + &quot;/var/lib/rpm &quot; + self.rootdir + &quot;/var/log &quot; + self.rootdir + &quot;/var/cache &quot; + self.rootdir + &quot;/etc &quot; + self.rootdir + &quot;/proc &quot; + self.rootdir + &quot;/sys &quot; + self.rootdir + &quot;/usr/src/redhat/BUILD &quot; + self.rootdir + &quot;/usr/src/redhat/RPMS &quot; + self.rootdir + &quot;/usr/src/redhat/SOURCES &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS &quot; + self.rootdir + &quot;/usr/src/redhat/SRPMS &quot; + self.rootdir + &quot;/dev &quot; + self.rootdir + &quot;/home/pydar2slave &quot;)
+        # copy fstab
+        cmd.append(&quot;sudo cp /etc/fstab &quot; + self.rootdir + &quot;/etc&quot;)
+        # create hosts
+        cmd.append(&quot;sudo echo -e \&quot;127.0.0.1       localhost.localdomain   localhost\&quot; &gt; &quot; + self.rootdir + &quot;/etc/hosts&quot;)
+        # mount proc
+        cmd.append(&quot;sudo mount -t proc none &quot; + self.rootdir + &quot;/proc&quot;)
+        # mount sys
+        cmd.append(&quot;sudo mount -t sysfs none &quot; + self.rootdir + &quot;/sys&quot;)
+        # create /dev/null
+        cmd.append(&quot;sudo mknod &quot; + self.rootdir + &quot;/dev/null c 1 3&quot;)
+        # rpm initdb
+        cmd.append(&quot;sudo rpm --root=&quot; + self.rootdir + &quot; --initdb&quot;)
+        return cmd

Modified: trunk/tools/pydar2/pydar/config.py
===================================================================
--- trunk/tools/pydar2/pydar/config.py	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/pydar/config.py	2005-08-24 21:40:06 UTC (rev 3531)
@@ -37,6 +37,7 @@
 import yumbasedbuildroot
 import rsyncyumbasedbuildroot
 import storagefactory
+import smartbasedbuildroot
 
 class Config:
     __myInstance = None
@@ -130,7 +131,10 @@
         if myParser.has_option('master','checksumtype'):
             self.__checksumtype = myParser.get('master','checksumtype')
         if myParser.has_option('master','checkmissingtagsperdistro'):
-            self.__doCheckMissingTagsPerDistro = True
+            if myParser.get('master','checkmissingtagsperdistro') != &quot;0&quot;:
+                self.__doCheckMissingTagsPerDistro = True
+            else:
+                self.__doCheckMissingTagsPerDistro = False
         else:
             self.__doCheckMissingTagsPerDistro = False
         #
@@ -267,6 +271,8 @@
                     tmp = rsyncyumbasedbuildroot.RsyncYumBasedBuildRoot(sect)
                 if type == &quot;YUM&quot;:
                     tmp = yumbasedbuildroot.YumBasedBuildRoot(sect)
+                if type == &quot;SMART&quot;:
+                    tmp = smartbasedbuildroot.SmartBasedBuildRoot(sect)
                 if tmp == None:
                     self.__cat.error(&quot;unknown type for buildarch: &quot; + sect)
                 else:

Modified: trunk/tools/pydar2/pydar/postgresqlstorage.py
===================================================================
--- trunk/tools/pydar2/pydar/postgresqlstorage.py	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/pydar/postgresqlstorage.py	2005-08-24 21:40:06 UTC (rev 3531)
@@ -45,7 +45,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select id from pydar2_distroarch where id='&quot; + id + &quot;'&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             retval = True
         cursor.close()
@@ -57,7 +57,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select current.id, current.lastversionid, tname.value as name, tsumm.value as summary, tgroup.value as group from (select sf.id, max(sv.id) as lastversionid from pydar2_specfile sf, pydar2_specrepo repo, pydar2_specfile_version sv where repo.id=sf.specrepoid and repo.name='&quot; + specRepoName + &quot;' and sv.specfileid=sf.id group by sf.id) as current, pydar2_specfile_tags tname, pydar2_specfile_tags tsumm, pydar2_specfile_tags tgroup where tname.versionid=current.lastversionid and tsumm.versionid=current.lastversionid and tgroup.versionid=current.lastversionid and tname.name='NAME' and tsumm.name='SUMMARY' and tgroup.name='GROUP' and tname.distroid=1 and tsumm.distroid=1 and tgroup.distroid=1 order by tgroup.value asc, tname.value asc&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             temp = {}
             temp['id'] = row[0]
@@ -77,7 +77,7 @@
         cursor = conn.cursor()
         sql = &quot;select t.value from pydar2_specfile_version sv, pydar2_specfile_tags t where t.versionid=sv.id and upper(t.name)='# AUTHORITY' and sv.specfileid=&quot; + str(specFileId)  + &quot; order by sv.id desc limit 1&quot;
         self.__cat.debug(&quot;sql:&quot; + sql)
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             retval = row[0]
         cursor.close()
@@ -89,7 +89,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select min(v.addtimestamp)::date as mintimestamp, tname.value, f.filename, f.subdir from pydar2_specfile_version v, pydar2_specfile f, pydar2_specfile_tags tname, pydar2_specrepo sr where tname.name='NAME' and tname.versionid=v.id and f.id=v.specfileid and f.specrepoid=sr.id and sr.name='&quot; + specRepoName + &quot;' group by f.id, tname.value, f.filename, f.subdir having min(v.addtimestamp) &gt; (current_date - '1 month'::interval) order by mintimestamp asc&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             temphash = {}
             temphash['timestamp'] = row[0] # mintimestamp, first occurrence of this rpm with this version/release for this distroarchtag
@@ -107,7 +107,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select min(tf.addtimestamp)::date as mintimestamp, tf.filename, tf.name, tf.distroarchtag from pydar2_target_files tf, pydar2_targets targ, pydar2_specfile_version v, pydar2_specfile_tags tname, pydar2_distroarch distro where tf.version = v.version and tname.versionid=v.id and tname.name='NAME' and tname.value=tf.name and tname.distroid=distro.id and distro.distroarchtag=tf.distroarchtag and tf.targetid=targ.id and targ.name='&quot; + targetName + &quot;'  group by tf.filename, tf.name, tf.distroarchtag having (min(tf.addtimestamp) &gt; (current_date - '1 month'::interval)) order by mintimestamp asc, tf.name asc, tf.filename asc, tf.distroarchtag asc&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             temphash = {}
             temphash['timestamp'] = row[0] # mintimestamp, first occurrence of this rpm with this version/release for this distroarchtag
@@ -125,7 +125,7 @@
         cursor = conn.cursor()
         sql = &quot;select t.value from pydar2_specfile_version sv, pydar2_specfile_tags t where t.versionid=sv.id and upper(t.name)='NAME' and sv.specfileid=&quot; + str(specFileId)  + &quot; order by sv.id desc limit 1&quot;
         self.__cat.debug(&quot;sql:&quot; + sql)
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             retval = row[0]
         cursor.close()
@@ -137,7 +137,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select sv.specfileid, max(version) as maxversion from pydar2_specfile_version sv, pydar2_specfile v where sv.specfileid=v.id and v.specrepoid=&quot; + str(specRepository.getId()) + &quot; group by sv.specfileid order by maxversion desc&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             retval[row[0]] = row[1]
         cursor.close()
@@ -149,7 +149,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select specfileid, max(version) from (select sv.specfileid, sv.version from pydar2_specfile_version sv, pydar2_distroarch pd, pydar2_specfile_tags t1, pydar2_target_files tf, pydar2_specfile s where tf.name=t1.value and t1.name='NAME' and t1.versionid=sv.id and s.id=sv.specfileid and tf.version=sv.version and t1.distroid=pd.id and pd.distroarchtag=tf.distroarchtag and s.specrepoid=&quot; +  str(specRepository.getId())+ &quot; and tf.targetid=&quot; +  str(targetObj.getId() )+ &quot; and tf.distroarchtag='&quot; + datag + &quot;') as foo1 group by specfileid&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             retval[row[0]] = row[1]
         cursor.close()
@@ -162,7 +162,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;update pydar2_target_files set targetid=&quot; + str(targetObj.getId()) + &quot;, version=&quot; + str(version )+ &quot;,name='&quot;+ str(name) + &quot;',checksum='&quot;+ str(checksum) + &quot;',distroarchtag='&quot;+distroarchtag +&quot;' where fileName='&quot; + fileName + &quot;'&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -172,7 +172,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;insert into pydar2_target_files (targetid, filename, name, version, checksum, distroarchtag) values (&quot; + str(targetObj.getId()) + &quot;,'&quot;+ fileName + &quot;','&quot;+ name + &quot;',&quot; + str(version) + &quot;,'&quot; + str(checksum) + &quot;','&quot;+ distroarchtag+ &quot;')&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -182,7 +182,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select distroarchtag from pydar2_distroarch&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             retval.append(row[0])
         cursor.close()
@@ -194,7 +194,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select subdir, filename, id from pydar2_specfile where specrepoid=&quot; + str(specRepo.getId())
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             arr = cursor.fetchall()
             for row in arr:
@@ -215,7 +215,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select version from pydar2_specfile_version where specfileid=&quot; + str(specId)
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             row= cursor.fetchone()
             retval = row[0]
@@ -234,7 +234,7 @@
             sql = sql + &quot; specrepoid=&quot; + str(specRepo.getId()) + &quot;, &quot;
             sql = sql + &quot; checksum='&quot; + str(specRepoSpecFile.getCheckSum()) + &quot;' &quot;
             sql = sql + &quot; where id=&quot; + str(specRepoSpecFile.getId())
-            cursor.execute(sql)
+            self.__execute(cursor,sql)
             conn.commit()
         else:
             # new spec file, insert it
@@ -243,10 +243,11 @@
             sql = sql + &quot;'&quot; + str(specRepoSpecFile.getFileName()) + &quot;',&quot;
             sql = sql + &quot;'&quot; + str(specRepoSpecFile.getSubDir()) + &quot;',&quot;
             sql = sql + &quot;'&quot; + str(specRepoSpecFile.getCheckSum()) + &quot;')&quot;
-            cursor.execute(sql)
+            self.__execute(cursor,sql)
             conn.commit()
         # now get the id so we can return it at the end
-        cursor.execute(&quot;select id from pydar2_specfile where filename='&quot; + str(specRepoSpecFile.getFileName()) + &quot;' and subdir='&quot; + str(specRepoSpecFile.getSubDir()) + &quot;' and specrepoid=&quot; + str(specRepo.getId()))
+        sql=&quot;select id from pydar2_specfile where filename='&quot; + str(specRepoSpecFile.getFileName()) + &quot;' and subdir='&quot; + str(specRepoSpecFile.getSubDir()) + &quot;' and specrepoid=&quot; + str(specRepo.getId())
+        self.__execute(cursor,sql)
         retval = None
         if cursor.rowcount &gt; 0:
             arr = cursor.fetchall()
@@ -265,7 +266,7 @@
         cursor = conn.cursor()
         sql = &quot;select version from pydar2_specfile_version where specfileid=&quot; + str(specfileid) + &quot; and version=&quot; + str(currentversion)
         self.__cat.debug(sql)
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         retval = 0
         if cursor.rowcount &gt; 0: 
             retval = 1
@@ -276,7 +277,8 @@
     def __insertSpecRepositorySpecfileVersion(self,specfileid,currentversion):
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;insert into pydar2_specfile_version (specfileid,version) values (&quot; + str(specfileid) + &quot;,&quot; + str(currentversion) + &quot;)&quot;)
+        sql=&quot;insert into pydar2_specfile_version (specfileid,version) values (&quot; + str(specfileid) + &quot;,&quot; + str(currentversion) + &quot;)&quot;
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -310,7 +312,7 @@
         sql = &quot;select pd.id, pd.distroarchtag, defines, (select count(*) from pydar2_specfile_tags t, pydar2_specfile_version v where t.distroid=pd.id and t.versionid=v.id and v.specfileid=&quot; + str(specRepoSpecFile.getId()) + &quot; and v.version=&quot; + str(currentversion) + &quot;) as cnt from pydar2_distroarch pd&quot;
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         rsdistros = cursor.fetchall()
         for row in rsdistros:
             distroid=row[0]
@@ -332,7 +334,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select distroarchtag, defines from pydar2_distroarch where disabled='0'&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         rsdistros = cursor.fetchall()
         for row in rsdistros:
             code = row[0]
@@ -351,7 +353,7 @@
         # first get the versionid
         sql = &quot;select id from pydar2_specfile_version where specfileid=&quot; + str(specRepoSpecFile.getId()) + &quot; and version=&quot; + str(currentversion)
         versionid = None
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         versionid=&quot;&quot;
         rstmp = cursor.fetchall()
         for row in rstmp:
@@ -384,34 +386,38 @@
             #print 'value: ' + sf.rpmforgetags[tag]
             value = string.replace(sf.rpmforgetags[tag],&quot;'&quot;,&quot;''&quot;)
             value = string.rstrip(value,&quot;\\&quot;)
-            cursor.execute(&quot;insert into pydar2_specfile_tags (versionid,distroid,name,value) values (&quot; + str(versionid) + &quot;,(select id from pydar2_distroarch where distroarchtag='&quot; + str(distrocode) + &quot;'),'&quot;+ str(name) + &quot;','&quot; + str(value) + &quot;')&quot;)
+            sql=&quot;insert into pydar2_specfile_tags (versionid,distroid,name,value) values (&quot; + str(versionid) + &quot;,(select id from pydar2_distroarch where distroarchtag='&quot; + str(distrocode) + &quot;'),'&quot;+ str(name) + &quot;','&quot; + str(value) + &quot;')&quot;
+            self.__execute(cursor,sql)
         for tag in sf.standardtags:
             print 'standard tag: ' + tag
             name = tag
             # print 'value: ' + string.replace(sf.standardtags[tag],&quot;'&quot;,&quot;''&quot;)
             value = string.replace(sf.standardtags[tag],&quot;'&quot;,&quot;''&quot;)
             value = string.rstrip(value,&quot;\\&quot;)
-            cursor.execute(&quot;insert into pydar2_specfile_tags (versionid,distroid,name,value) values (&quot; + str(versionid)  + &quot;,(select id from pydar2_distroarch where distroarchtag='&quot; + str(distrocode) + &quot;'),'&quot;+ str(name) + &quot;','&quot; + str(value) + &quot;')&quot;)
+            sql=&quot;insert into pydar2_specfile_tags (versionid,distroid,name,value) values (&quot; + str(versionid)  + &quot;,(select id from pydar2_distroarch where distroarchtag='&quot; + str(distrocode) + &quot;'),'&quot;+ str(name) + &quot;','&quot; + str(value) + &quot;')&quot;
+            self.__execute(cursor,sql)
         
         
     
     def saveSpecRepository(self,specRepo):
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;select * from pydar2_specrepo where name='&quot; + str(specRepo.getName()) + &quot;'&quot;)
+        sql=&quot;select * from pydar2_specrepo where name='&quot; + str(specRepo.getName()) + &quot;'&quot;
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             # specrepo exists, update it
             sql = &quot;update pydar2_specrepo set rootdirectory='&quot; + str(specRepo.getRootDirectory()) + &quot;', type='&quot;
             sql = sql + str(specRepo.getType()) + &quot;', deleted='0' where name='&quot; + str(specRepo.getName()) + &quot;'&quot;
-            cursor.execute(sql)
+            self.__execute(cursor,sql)
             conn.commit()
         else:
             # specrepo does not exist, add it
             sql = &quot;insert into pydar2_specrepo (name, rootdirectory, type) values ('&quot; + str(specRepo.getName()) + &quot;','&quot; + str(specRepo.getRootDirectory()) + &quot;','&quot; + str(specRepo.getType()) + &quot;')&quot;
-            cursor.execute(sql)
+            self.__execute(cursor,sql)
             conn.commit()
         # now get the id again
-        cursor.execute(&quot;select id from pydar2_specrepo where name='&quot; + str(specRepo.getName()) + &quot;'&quot;)
+        sql=&quot;select id from pydar2_specrepo where name='&quot; + str(specRepo.getName()) + &quot;'&quot;
+        self.__execute(cursor,sql)
         retval = None
         arr = cursor.fetchall()
         for row in arr:
@@ -421,12 +427,21 @@
         return retval
         
     # @todo add some type of connection pooling 
+    myConnection = None
+    #currentConnectionUser = None
+    
     def __getConnection(self):
-        conn = pgdb.connect(config.Config.getInstance().getPostgresqlConnectString())
-        return conn
+        if PostgresqlStorage.myConnection == None:
+            PostgresqlStorage.myConnection = pgdb.connect(config.Config.getInstance().getPostgresqlConnectString())
+            #PostgresqlStorage.currentConnectionUser = name
+            return PostgresqlStorage.myConnection
+        else:
+            #if PostgresqlStorage.currentConnectionUser 
+            return PostgresqlStorage.myConnection
         
     def __releaseConnection(self,conn):
-        conn.close()
+        closes = 0
+        #conn.close()
     
     def getTargetFileListToChecksums(self, targetObj):
         self.__cat.debug(&quot;start&quot;)
@@ -434,7 +449,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select filename, checksum from pydar2_target_files where targetid=&quot; + str(targetObj.getId())
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             arr = cursor.fetchall()
             for row in arr:
@@ -453,7 +468,7 @@
         cursor = conn.cursor()
         sql = &quot;select subdir, filename, checksum from pydar2_specfile where specrepoid &quot;
         sql = sql + &quot;in (select id from pydar2_specrepo where name='&quot; + specRepo.getName() + &quot;')&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             arr = cursor.fetchall()
             for row in arr:
@@ -470,13 +485,14 @@
         self.__cat.debug(&quot;start&quot;)
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;select nextval('pydar2_commands_id_seq')&quot;)
+        sql=&quot;select nextval('pydar2_commands_id_seq')&quot;
+        self.__execute(cursor,sql)
         id = -1
         temparr = cursor.fetchall()
         for row in temparr:
             id = row[0]
         #commandName,userId,specrepoid,specfileid,toEmail,distroArchTag,priority,targetid
-        cursor.execute(&quot;insert into pydar2_commands (id,commandname,userid,specrepoid,specfileid,toemail,distroarchtag,priority,targetid,version) values (&quot;
+        sql=&quot;insert into pydar2_commands (id,commandname,userid,specrepoid,specfileid,toemail,distroarchtag,priority,targetid,version) values (&quot;
         + str(id) + &quot;,'&quot;
         + aCommand.getCommandName() + &quot;','&quot;
         + str(aCommand.getUserId()) + &quot;',&quot;
@@ -486,7 +502,8 @@
         + str(aCommand.getDistroArchTag()) + &quot;',&quot;
         + str(aCommand.getPriority()) + &quot;,&quot;
         + str(aCommand.getTargetId()) + &quot;,&quot;
-        + &quot;(select max(version) from pydar2_specfile_version sv where sv.specfileid=&quot;+str(aCommand.getSpecFileId())+&quot;))&quot;)
+        + &quot;(select max(version) from pydar2_specfile_version sv where sv.specfileid=&quot;+str(aCommand.getSpecFileId())+&quot;))&quot;
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -498,7 +515,8 @@
         retval = 0
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;select * from pydar2_users u, pydar2_rights r, pydar2_users_to_rights ur where u.id=ur.userid and ur.rightid=r.id and r.abbrev='&quot;+ str(right)  + &quot;' and u.id='&quot; + str(userId) + &quot;' and u.password='&quot; + str(password) + &quot;'&quot;)
+        sql=&quot;select * from pydar2_users u, pydar2_rights r, pydar2_users_to_rights ur where u.id=ur.userid and ur.rightid=r.id and r.abbrev='&quot;+ str(right)  + &quot;' and u.id='&quot; + str(userId) + &quot;' and u.password='&quot; + str(password) + &quot;'&quot;
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             retval = 1
         cursor.close()
@@ -511,7 +529,8 @@
         conn = self.__getConnection()
         retval = 0
         cursor = conn.cursor()
-        cursor.execute(&quot;select * from pydar2_buildmachines u, pydar2_rights r, pydar2_buildmachines_to_rights ur where u.id=ur.buildmachineid and ur.rightid=r.id and r.abbrev='&quot;+ str(right)  + &quot;' and u.id='&quot; + str(buildmachineid) + &quot;' and u.password='&quot;+ str(password)  + &quot;'&quot;)
+        sql=&quot;select * from pydar2_buildmachines u, pydar2_rights r, pydar2_buildmachines_to_rights ur where u.id=ur.buildmachineid and ur.rightid=r.id and r.abbrev='&quot;+ str(right)  + &quot;' and u.id='&quot; + str(buildmachineid) + &quot;' and u.password='&quot;+ str(password)  + &quot;'&quot;
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             retval = 1
         cursor.close()
@@ -525,15 +544,15 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select * from pydar2_targets where name='&quot; + newTarget.getName() + &quot;'&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         if cursor.rowcount == 0:
             sql = &quot;insert into pydar2_targets (name) values ('&quot; + newTarget.getName() + &quot;')&quot;
-            cursor.execute(sql)
+            self.__execute(cursor,sql)
             conn.commit()
         # else:
             # nothing to update yet..
         sql = &quot;select id from pydar2_targets where name='&quot; + newTarget.getName() + &quot;'&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         newId = None
         if cursor.rowcount &gt; 0:
             rs = cursor.fetchone()
@@ -546,8 +565,10 @@
         self.__cat.debug(&quot;start, buildmachineid=&quot; + buildmachineid)
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;insert into pydar2_buildmachine_registrations (id) values ('&quot; + buildmachineid + &quot;')&quot;)
-        cursor.execute(&quot;delete from pydar2_buildmachine_distroarchtags where buildmachineid='&quot; + buildmachineid + &quot;'&quot;)
+        sql=&quot;insert into pydar2_buildmachine_registrations (id) values ('&quot; + buildmachineid + &quot;')&quot;
+        self.__execute(cursor,sql)
+        sql=&quot;delete from pydar2_buildmachine_distroarchtags where buildmachineid='&quot; + buildmachineid + &quot;'&quot;
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -556,7 +577,8 @@
         self.__cat.debug(&quot;start, id=&quot; + buildmachineid + &quot;,distroArchTag=&quot; + distroArchTag)
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;insert into pydar2_buildmachine_distroarchtags (buildmachineid,distroarchtag) values ('&quot; + buildmachineid + &quot;','&quot; + distroArchTag + &quot;')&quot;)
+        sql=&quot;insert into pydar2_buildmachine_distroarchtags (buildmachineid,distroarchtag) values ('&quot; + buildmachineid + &quot;','&quot; + distroArchTag + &quot;')&quot;
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -565,7 +587,8 @@
         # no check on buildmachineid yet...
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;insert into pydar2_actions_files (commandid,filename) values (&quot; + str(commandId) + &quot;,'&quot; + fileName + &quot;')&quot;)
+        sql=&quot;insert into pydar2_actions_files (commandid,filename) values (&quot; + str(commandId) + &quot;,'&quot; + fileName + &quot;')&quot;
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -573,8 +596,10 @@
     def setBuildResult(self,buildmachineid,commandId,buildResult):
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;insert into pydar2_actions (buildmachineid,commandid,statusid) values ('&quot; + buildmachineid + &quot;',&quot; + str(commandId) + &quot;,&quot; + str(buildResult+1) + &quot;)&quot;)
-        cursor.execute(&quot;update pydar2_commands set handled=true,inprogress=false where id=&quot; + str(commandId))
+        sql=&quot;insert into pydar2_actions (buildmachineid,commandid,statusid) values ('&quot; + buildmachineid + &quot;',&quot; + str(commandId) + &quot;,&quot; + str(buildResult+1) + &quot;)&quot;
+        self.__execute(cursor,sql)
+        sql=&quot;update pydar2_commands set handled=true,inprogress=false where id=&quot; + str(commandId)
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -583,7 +608,8 @@
         retval = None
         conn = self.__getConnection()
         cursor = conn.cursor()
-        cursor.execute(&quot;select count(*) as total from pydar2_commands where not pc.handled and not pc.inprogress&quot;)
+        sql=&quot;select count(*) as total from pydar2_commands where not pc.handled and not pc.inprogress&quot;
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             row = cursor.fetchone()
             retval = row[0]
@@ -598,7 +624,7 @@
         cursor = conn.cursor()
         sql = &quot;select pc.id, pc.specfileid, pc.specrepoid, pc.toemail, pc.distroarchtag, pc.targetid, pc.commandname, pc.userid, pc.priority, pc.version from pydar2_commands pc where pc.commandname='BUILDSPECBYPATH' and not pc.handled and not pc.inprogress and pc.distroarchtag in (select distroarchtag from pydar2_buildmachine_distroarchtags where buildmachineid='&quot; + buildmachineid + &quot;')  order by pc.priority desc, pc.distroarchtag desc, pc.id asc limit 1&quot;
         self.__cat.debug(&quot;sql 1: &quot; + sql)
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         retval = &quot;&quot;
         if cursor.rowcount &gt; 0:
             rs = cursor.fetchone()
@@ -618,8 +644,10 @@
             self.__cat.debug(&quot;command id: &quot; + str(rs[0]))
             aCommand.setCommandId(rs[0])
             self.__cat.debug(&quot;id according to command object: &quot; + str(aCommand.getId()))
-            cursor.execute(&quot;update pydar2_commands set inprogress=true where id=&quot; + str(aCommand.getId()))
-            cursor.execute(&quot;insert into pydar2_actions (commandid, statusid, buildmachineid) values (&quot; + str(aCommand.getId()) + &quot;,0,'&quot; + str(buildmachineid) + &quot;')&quot;)
+            sql=&quot;update pydar2_commands set inprogress=true where id=&quot; + str(aCommand.getId())
+            self.__execute(cursor,sql)
+            sql=&quot;insert into pydar2_actions (commandid, statusid, buildmachineid) values (&quot; + str(aCommand.getId()) + &quot;,0,'&quot; + str(buildmachineid) + &quot;')&quot;
+            self.__execute(cursor,sql)
             retval = aCommand
         else:
             self.__cat.debug(&quot;nothing to do for buildmachineid=&quot; + buildmachineid)
@@ -635,7 +663,7 @@
         cursor = conn.cursor()
         sql = &quot;select pc.id, pc.specfileid, pc.specrepoid, pc.toemail, pc.distroarchtag, pc.targetid, pc.commandname, pc.userid, pc.priority, pc.version from pydar2_commands pc where pc.id=&quot; + str(commandId)
         self.__cat.debug(&quot;sql 1: &quot; + sql)
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         retval = &quot;&quot;
         if cursor.rowcount &gt; 0:
             self.__cat.debug(&quot;rowcount &gt; 0&quot;)
@@ -668,7 +696,7 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select buildmachineid, count(buildmachineid) as cnt from pydar2_actions where commandid=&quot; + str(commandId) + &quot; group by buildmachineid order by cnt desc&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             row = cursor.fetchone()
             retval = row[0]
@@ -681,7 +709,7 @@
         cursor = conn.cursor()
         retval = []
         sql = &quot;select id from pydar2_specfile_version where specfileid=&quot; + str(specRepoSpecFile.getId()) + &quot; order by id desc&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         all = cursor.fetchall()
         for row in all:
             retval.append(row[0])
@@ -695,7 +723,7 @@
         cursor = conn.cursor()
         retval = []
         sql = &quot;select t1.name, t1.value, d.distroarchtag from pydar2_specfile_tags t1, pydar2_distroarch d where t1.distroid=d.id and  versionid=&quot; + str(versionId) + &quot; order by t1.name asc, t1.distroid asc&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         for row in cursor.fetchall():
             h = {}
             h[&quot;name&quot;] = row[0]
@@ -706,13 +734,36 @@
         self.__releaseConnection(conn)
         return retval
         
+    # returns a hash of hashes with first key distroarchtag with as value a hash with key = name and val= value
+    def getTagsOfSpecFileVersionNew(self, versionId):
+        conn = self.__getConnection()
+        cursor = conn.cursor()
+        retval = {}
+        sql = &quot;select t1.name, t1.value, d.distroarchtag from pydar2_specfile_tags t1, pydar2_distroarch d where t1.distroid=d.id and  versionid=&quot; + str(versionId) + &quot; order by t1.distroid asc, t1.name asc&quot;
+        self.__execute(cursor,sql)
+        for row in cursor.fetchall():
+            name = row[0]
+            value = row[1]
+            distroarchtag = row[2]
+            if distroarchtag not in retval.keys():
+                retval[distroarchtag] = {}
+                # autofill certain values
+                retval[distroarchtag]['# Screenshot'] = &quot;&quot;
+                retval[distroarchtag]['# Authority'] = &quot;&quot;
+            retval[distroarchtag][name] = value
+        cursor.close()
+        self.__releaseConnection(conn)
+        return retval
+        
+        
+        
     # get a mapping from something like fc3-i386 to --define fc3 1 --define dist fc3 for example
     def getDefinesByDistroArchTag(self,distroArchTag):
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;select defines from pydar2_distroarch where distroarchtag='&quot; + distroArchTag + &quot;'&quot;
         retval = &quot;&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             rs = cursor.fetchone()
             retval = rs[0]
@@ -724,9 +775,9 @@
         conn = self.__getConnection()
         cursor = conn.cursor()
         sql = &quot;delete from pydar2_users_to_rights&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         sql = &quot;delete from pydar2_buildmachines_to_rights&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
@@ -739,13 +790,13 @@
         if type==&quot;BUILDMACHINE&quot;:
             tablename=&quot;pydar2_buildmachines&quot;
         sql = &quot;select * from &quot; + tablename + &quot; where id='&quot; + name + &quot;'&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         if cursor.rowcount &gt; 0:
             # update
             sql = &quot;update &quot; + tablename + &quot; set name='&quot; + fullname + &quot;', password='&quot; +str(passw)+ &quot;' where id='&quot; + name + &quot;'&quot;
         else:
             sql = &quot;insert into &quot; + tablename + &quot; (id,name,password) values ('&quot; + str(name) + &quot;','&quot; + str(fullname) + &quot;','&quot; + str(passw) + &quot;')&quot;
-        cursor.execute(sql)
+        self.__execute(cursor,sql)
         # add the rights
         tablename = &quot;pydar2_users_to_rights&quot;
         firstfield = &quot;userid&quot;
@@ -754,7 +805,24 @@
             firstfield=&quot;buildmachineid&quot;
         for r in rights:
             sql = &quot;insert into &quot; + str(tablename) + &quot; (&quot; + str(firstfield) + &quot;,rightid) values ('&quot; + str(name) + &quot;',(select id from pydar2_rights where abbrev='&quot; + str(r) + &quot;'))&quot;
-            cursor.execute(sql)
+            self.__execute(cursor,sql)
         conn.commit()
         cursor.close()
         self.__releaseConnection(conn)
+
+    
+    def printCounters(self):
+        queryKeys = PostgresqlStorage.queryCounter.keys()
+        queryKeys.sort(lambda x,y : PostgresqlStorage.queryCounter[x] &gt; PostgresqlStorage.queryCounter[y])
+        for k in queryKeys:
+            print &quot;k:&quot; + k + &quot;,val:&quot; + str(PostgresqlStorage.queryCounter[k])
+
+    def __execute(self,cursor,sql):
+        if sql in PostgresqlStorage.queryCounter.keys():
+            PostgresqlStorage.queryCounter[sql] = PostgresqlStorage.queryCounter[sql] + 1
+        else:
+            PostgresqlStorage.queryCounter[sql] = 1
+        cursor.execute(sql)
+    
+    queryCounter = {}
+    
\ No newline at end of file

Modified: trunk/tools/pydar2/pydar/smartbasedbuildroot.py
===================================================================
--- trunk/tools/pydar2/pydar/smartbasedbuildroot.py	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/pydar/smartbasedbuildroot.py	2005-08-24 21:40:06 UTC (rev 3531)
@@ -29,53 +29,30 @@
 # -orpm-root=/var/lib/pydar2/roots/ &lt;buildmachineid&gt; / &lt;buildroottag&gt;-smart /
 #  todo: how to change the dir /etc/smart/channels ?
 
-# not finished, todo
+# still not finished, todo
 
 class SmartBasedBuildRoot(BuildRoot):
     def __init__(self,buildRootTag):
-        self.__cat = Logger().get_instance(self)
+        self._cat = Logger().get_instance(self)
         brr = BuildRootResult(self)
         self.__config = config.Config.getInstance()
         self._setBuildRootTag( buildRootTag)
         self.__setVars(brr)
-        self.__cat.debug(&quot;initialized&quot;)
+        self._cat.debug(&quot;initialized&quot;)
         self.__useCacheOnly = False
         #return brr
         
-    # todo possible with smart?
-    def setUseCacheOnly(self,bVar):
-        self.__useCacheOnly = bVar
-    
-    def _umounts(self, brr):
-        self.__cat.debug(&quot;start&quot;)
-        cmd = &quot;sudo umount &quot; + self.rootdir + &quot;/proc&quot;
-        self.logCommandWithoutErrors(cmd,brr)
-        cmd = &quot;sudo umount &quot; + self.rootdir + &quot;/sys&quot;
-        self.logCommandWithoutErrors(cmd,brr)
-        
-    def cleanRoot(self):
-        self.__cat.debug(&quot;cleaning this root..&quot;)
-        brr = BuildRootResult(self)
-        self._umounts(brr)
-        cmd = &quot;sudo rm -Rf &quot; + self.rootdir
-        self.logCommand(cmd,brr)
-        return brr
-        
     def __setVars(self,brr):
-        self.yumConfFile = &quot;/etc/pydar2/smart/&quot; + self.__config.getBuildMachineId() + &quot;/&quot; + self.getBuildRootTag() + &quot;.conf&quot;
-        if os.path.exists(self.yumConfFile):
-            self.__cat.debug(&quot;using userdefined yum conf: &quot; + self.yumConfFile)
+        self.smartChannelsDir = &quot;/etc/pydar2/smart/&quot; + self.__config.getBuildMachineId() + &quot;/&quot; + self.getBuildRootTag() + &quot;&quot;
+        if os.path.exists(self.smartChannelsDir):
+            self._cat.debug(&quot;using userdefined smart channels dir: &quot; + self.smartChannelsDir)
         else:
-            self.yumConfFile = &quot;/etc/pydar2/yum/&quot; + self.getBuildRootTag() + &quot;.conf&quot;
-            self.__cat.debug(&quot;using normal yum conf: &quot; + self.yumConfFile)
-        self.yumCacheDir = &quot;/var/lib/pydar2/yum/cache/&quot; + self.getBuildRootTag()
-        self.rootdir = &quot;/var/lib/pydar2/roots/yum-&quot; + self.getBuildRootTag()
+            self.smartChannelsDir = &quot;/etc/pydar2/smart/&quot; + self.getBuildRootTag() + &quot;&quot;
+            self._cat.debug(&quot;using normal smart channels dir: &quot; + self.smartChannelsDir)
+        self.smartCacheDir = &quot;/var/lib/pydar2/smart/cache/&quot; + self.getBuildRootTag()
+        self.rootdir = &quot;/var/lib/pydar2/roots/smart-&quot; + self.getBuildRootTag()
         
-        # this definetely has to move to a config file
-        self.minimalRpmsPart1 = &quot;basesystem filesystem setup bash glibc&quot;
-        self.minimalRpmsPart2 = &quot;coreutils findutils&quot;
-        self.minimalRpmsPart3 = &quot;rpm-devel rpm-build make gcc tar gzip patch unzip bzip2 diffutils cpio elfutils redhat-rpm-config perl&quot;
-        self.minimalRpmsPart4 = &quot;&quot;
+        self._setGeneralVars()
         brr.logDebugLine(&quot;rootdir:&quot; + self.rootdir)
     
     def installRpms(self,builddepsarr):
@@ -88,7 +65,7 @@
                 cacheParam = &quot;&quot;
                 if self.__useCacheOnly:
                     cacheParam = &quot; -C &quot;
-            cmd = &quot;sudo yum &quot; + cacheParam + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + commandpart
+            cmd = &quot;sudo smart &quot; + cacheParam + &quot; --data-dir=&quot; + self.smartCacheDir + &quot;  -orpm-root=&quot; + self.rootdir + &quot; install &quot; + commandpart
             self.logCommand(cmd,brr)
         return brr
         
@@ -97,7 +74,7 @@
         brr = BuildRootResult(self)
         cmd = []
         # create some directories first
-        cmd.append(&quot;sudo mkdir -p &quot; + self.rootdir + &quot;/var/lib/rpm &quot; + self.rootdir + &quot;/var/log &quot; + self.rootdir + &quot;/var/cache &quot; + self.rootdir + &quot;/etc &quot; + self.rootdir + &quot;/proc &quot; + self.rootdir + &quot;/sys &quot; + self.rootdir + &quot;/usr/src/redhat/BUILD &quot; + self.rootdir + &quot;/usr/src/redhat/RPMS &quot; + self.rootdir + &quot;/usr/src/redhat/SOURCES &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS &quot; + self.rootdir + &quot;/usr/src/redhat/SRPMS &quot; + self.rootdir + &quot;/dev/&quot;)
+        cmd.append(&quot;sudo mkdir -p &quot; + self.rootdir + &quot;/var/lib/rpm &quot; + self.rootdir + &quot;/var/log &quot; + self.rootdir + &quot;/var/cache &quot; + self.rootdir + &quot;/etc &quot; + self.rootdir + &quot;/proc &quot; + self.rootdir + &quot;/sys &quot; + self.rootdir + &quot;/usr/src/redhat/BUILD &quot; + self.rootdir + &quot;/usr/src/redhat/RPMS &quot; + self.rootdir + &quot;/usr/src/redhat/SOURCES &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS &quot; + self.rootdir + &quot;/usr/src/redhat/SRPMS &quot; + self.rootdir + &quot;/dev/ &quot; + self.rootdir + &quot;/var/lib &quot;)
         # copy fstab
         cmd.append(&quot;sudo cp /etc/fstab &quot; + self.rootdir + &quot;/etc&quot;)
         # mount proc
@@ -109,143 +86,20 @@
         # rpm initdb
         cmd.append(&quot;sudo rpm --root=&quot; + self.rootdir + &quot; --initdb&quot;)
         # use a central yum cache
-        cmd.append(&quot;sudo ln -s &quot; + self.yumCacheDir + &quot; &quot; + self.rootdir + &quot;/var/cache/yum&quot;)
+        cmd.append(&quot;sudo ln -s &quot; + self.smartCacheDir + &quot; &quot; + self.rootdir + &quot;/var/lib/smart&quot;)
         # install the rpms
         cacheParam = &quot;&quot;
         if self.__useCacheOnly:
             cacheParam = &quot; -C &quot;
         if self.minimalRpmsPart1 != &quot;&quot;:
-            cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart1)
+            cmd.append(&quot;sudo smart &quot; + cacheParam + &quot; --data-dir=&quot; + self.smartCacheDir + &quot;  -orpm-root=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart1)
         if self.minimalRpmsPart2 != &quot;&quot;:
-            cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart2)
+            cmd.append(&quot;sudo smart &quot; + cacheParam + &quot; --data-dir=&quot; + self.smartCacheDir + &quot;  -orpm-root=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart2)
         if self.minimalRpmsPart3 != &quot;&quot;:
-            cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart3)
+            cmd.append(&quot;sudo smart &quot; + cacheParam + &quot; --data-dir=&quot; + self.smartCacheDir + &quot;  -orpm-root=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart3)
         if self.minimalRpmsPart4 != &quot;&quot;:
-            cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart4)
-        cmd.append(&quot;sudo chmod -R a+rwx &quot; + self.rootdir + &quot;/usr/src/redhat/&quot;)
+            cmd.append(&quot;sudo smart &quot; + cacheParam + &quot; --data-dir=&quot; + self.smartCacheDir + &quot;  -orpm-root=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart4)
+        cmd.append(&quot;sudo chmod -R a+rwx &quot; + self.rootdir + &quot;/usr/src/redhat/ &quot; + self.rootdir + &quot;/home/pydar2slave &quot;)
         self.logCommands(cmd,brr)
         return brr
         
-    def logCommands(self,cmdArr,brr):
-        for cmd in cmdArr:
-            self.logCommand(cmd,brr)
-            # todo: if error =&gt; stop
-        
-    def logCommand(self,cmd,brr):
-        brr.logDebugLine(&quot;CMD: Command line:&quot; + cmd)
-        (status,output) = commands.getstatusoutput(cmd)
-        brr.logDebugLine(&quot;CMD: Status:&quot; + str(status))
-        # first remove all the '\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*
-        output = re.sub('\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*',&quot;&quot;,output)
-        output = re.sub('\r',&quot;&quot;,output)
-        brr.logDebugLine(&quot;CMD: output:&quot; + str(output))
-        if status != 0:
-            brr.logErrorLine(&quot;CMD: status (&quot; + str(status) + &quot;) is not 0 !&quot;)
-        
-    def logCommandWithoutErrors(self,cmd,brr):
-        brr.logDebugLine(&quot;CMD: Command line:&quot; + cmd)
-        (status,output) = commands.getstatusoutput(cmd)
-        brr.logDebugLine(&quot;CMD: Status:&quot; + str(status))
-        # first remove all the '\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*
-        output = re.sub('\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*',&quot;&quot;,output)
-        output = re.sub('\r',&quot;&quot;,output)
-        brr.logDebugLine(&quot;CMD: output:&quot; + str(output))
-        
-    def buildRpm(self,command):
-        brr = BuildRootResult(self)
-        self.__cat.debug(&quot;start&quot;)
-        # copy the sources
-        self.__copySources(command,brr)
-        # create a script which does the actual building
-        scriptcontents = self.__createScript(command,brr)
-        # then we call the script
-        self.__callBuildScript(scriptcontents, command, brr)
-        # get all the results
-        self.__getLogsAndRpmsAndSrpm(command,brr)
-        # then we parse the log: get additional usefull files if need, for example config.log if the build has failed
-        self.__parseLog(command,brr)
-        return brr
-    
-    def __copySources(self,command,brr):
-        self.__cat.debug(&quot;start&quot;)
-        startdir = command.getBuildDir()
-        listdir = os.listdir(startdir)
-        specdestdir = os.path.join(self.rootdir,'usr/src/redhat/SPECS')
-        sourcesdestdir = os.path.join(self.rootdir,'usr/src/redhat/SOURCES')
-        self.__cat.debug('specdestdir: ' + specdestdir)
-        self.__cat.debug('sourcesdestdir: ' + sourcesdestdir)
-        for entry in listdir:
-            rindex = string.rfind(entry,'.spec')
-            if os.path.isfile(os.path.join(startdir,entry)) and not (rindex &gt; 0 and rindex == len(entry) - len('.spec')):
-                # its not the spec files
-                shutil.copy(os.path.join(startdir,entry), sourcesdestdir)
-            else:
-                # its the spec file
-                shutil.copy(os.path.join(startdir,entry),specdestdir)
-        self.__cat.debug('copy done')
-            
-    def __getLogsAndRpmsAndSrpm(self,command,brr):
-        self.__cat.debug(&quot;start&quot;)
-        shutil.copy(os.path.join(self.rootdir, &quot;buildlog.txt&quot;), command.getBuildDir())
-        cmd = &quot;gzip &quot; + command.getBuildDir() + &quot;/buildlog.txt&quot;
-        self.logCommand(cmd,brr)
-        # search in the /usr/src/redhat/RPMS and /usr/src/redhat/SRPMS dirs..
-        rpmsdir = os.path.join(self.rootdir,'usr/src/redhat/RPMS')
-        ld = os.listdir(rpmsdir)
-        for entry in ld:
-            self.__getRpmsOrSrpms(command,brr,os.path.join(rpmsdir,entry))
-        srpmsdir = os.path.join(self.rootdir,'usr/src/redhat/SRPMS')
-        self.__getRpmsOrSrpms(command,brr,srpmsdir)
-            
-    def __getRpmsOrSrpms(self,command,brr,path):
-        self.__cat.debug('start, path=' + path)
-        ld  = os.listdir(path)
-        for entry in ld:
-            rindex = string.rfind(entry,'.rpm')
-            if os.path.isfile(os.path.join(path,entry)) and (rindex &gt; 0 and rindex == len(entry) - len('.rpm')):
-                # let's copy it
-                shutil.copy(os.path.join(path,entry),command.getBuildDir())
-                rindex = string.rfind(entry,'.src.rpm')
-                if  rindex &gt; 0 and rindex == len(entry) - len('.src.rpm'):
-                    brr.setSrpm(entry)
-                else:
-                    brr.addRpm(entry)
-    
-    def __createScript(self,command,brr):
-        self.__cat.debug(&quot;start&quot;)
-        script = &quot;#!/bin/bash\n&quot;
-        script = script + 'for i in ' + self.rootdir + '/etc/profile.d/*.sh; do' + &quot;\n&quot;
-        script = script + '    if [ -r &quot;$i&quot; ]; then' + &quot;\n&quot;
-        script = script + '        . $i' + &quot;\n&quot;
-        script = script + &quot;    fi\n&quot;
-        script = script + &quot;done\n&quot;
-        script = script + &quot;chown -R root.root &quot; + self.rootdir + &quot;/usr/src/redhat\n&quot;
-        # the following command first checks if the dependencies are ok
-        # ex: --define '_topdir /var/lib/pydar2/roots/yum-fc3-i386/usr/src/redhat'
-        script = script + &quot;(/usr/bin/rpmbuild --define '_topdir &quot; + self.rootdir + &quot;/usr/src/redhat' &quot; + command.getDefines() + &quot; --root=&quot; + self.rootdir + &quot; --nobuild --bs &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &amp;&amp; echo \&quot;deps check ok\&quot; &amp;&amp; &quot;
-        # do the real build
-        script = script + &quot;/usr/sbin/chroot &quot; + self.rootdir + &quot; /usr/bin/rpmbuild --nodeps -ba /usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &quot; + command.getDefines() + &quot; ) &gt; &quot; + self.rootdir + &quot;/buildlog.txt 2&gt;&amp;1&quot;
-        self.__cat.debug( &quot;script contains: &quot; + script)
-        return script
-        
-    def __callBuildScript(self, scriptcontents, command, brr):
-        self.__cat.debug(&quot;start&quot;)
-        # first write it to a temp file
-        filepath = self.rootdir + &quot;/tmp/pydar2build.sh&quot;
-        fd = open(filepath,&quot;w&quot;)
-        fd.write(scriptcontents)
-        fd.close()
-        cmd = &quot;sudo /bin/bash &quot; + self.rootdir + &quot;/tmp/pydar2build.sh&quot;
-        self.logCommand(cmd,brr)
-    
-    def __parseLog(self,command,brr):
-        self.__cat.debug(&quot;start, not ready&quot;)
-    
-## tests
-#myRoot = YumBasedBuildRoot(&quot;&quot;,&quot;fedora-3-i386-core&quot;)
-#myRoot.cleanRoot()
-#myRoot.prepareRoot()
-#spec = SpecFile('/home/dries/projects/rap-svn/svn/trunk/rpms/aldo/aldo.spec',' --define &quot;fc3 1&quot; ')
-#myRoot.installRpms(spec.getBuildRequires())
-##myRoot.
-#print myRoot.logText

Modified: trunk/tools/pydar2/pydar/svnwrapper.py
===================================================================
--- trunk/tools/pydar2/pydar/svnwrapper.py	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/pydar/svnwrapper.py	2005-08-24 21:40:06 UTC (rev 3531)
@@ -94,6 +94,9 @@
     def update_callback(self):
         self.cat.debug(&quot;start&quot;)
 
+    # changed!
+    # now -1 is returned if it is not within svn
+
     def getLastCommitRev(self,dirpath,fullpath):
         #if dirpath[len(dirpath)-1] == &quot;/&quot;:
         #    self.cat.debug(&quot;removing last '/'&quot;)
@@ -101,12 +104,16 @@
         #else:
         #    self.cat.debug(&quot;last char:&quot; + dirpath[len(dirpath)-1])
         self.cat.debug(&quot;start,dirpath=&quot; + dirpath + &quot;,fullpath=&quot;+fullpath)
-        adm_baton = svn.wc.svn_wc_adm_open(None,dirpath,False,True,self.pool)
-        entry = svn.wc.svn_wc_entry(fullpath,adm_baton,0,self.pool)
-        self.cat.debug(&quot;entry: &quot; + str(entry))
-        self.cat.debug(&quot;cmtRev: &quot; + str(entry.cmt_rev))
-        svn.wc.svn_wc_adm_close(adm_baton)
-        return entry.cmt_rev
+        try:
+            adm_baton = svn.wc.svn_wc_adm_open(None,dirpath,False,True,self.pool)
+            entry = svn.wc.svn_wc_entry(fullpath,adm_baton,0,self.pool)
+            self.cat.debug(&quot;entry: &quot; + str(entry))
+            self.cat.debug(&quot;cmtRev: &quot; + str(entry.cmt_rev))
+            svn.wc.svn_wc_adm_close(adm_baton)
+            return entry.cmt_rev
+        except:
+            self.cat.debug(&quot;problem, probably not in svn&quot;)
+            return -1
 
 # tocheck: <A HREF="http://svn.slog.dk/repos/+svn/py/util.py">http://svn.slog.dk/repos/+svn/py/util.py</A>
 # <A HREF="http://www.contactor.se/~dast/svn/archive-2002-12/0234.shtml">http://www.contactor.se/~dast/svn/archive-2002-12/0234.shtml</A>

Modified: trunk/tools/pydar2/pydar/yumbasedbuildroot.py
===================================================================
--- trunk/tools/pydar2/pydar/yumbasedbuildroot.py	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/pydar/yumbasedbuildroot.py	2005-08-24 21:40:06 UTC (rev 3531)
@@ -26,48 +26,27 @@
 
 class YumBasedBuildRoot(BuildRoot):
     def __init__(self,buildRootTag):
-        self.__cat = Logger().get_instance(self)
+        self._cat = Logger().get_instance(self)
         brr = BuildRootResult(self)
         self.__config = config.Config.getInstance()
         self._setBuildRootTag( buildRootTag)
         self.__setVars(brr)
-        self.__cat.debug(&quot;initialized&quot;)
+        self._cat.debug(&quot;initialized&quot;)
         self.__useCacheOnly = False
         #return brr
         
-    def setUseCacheOnly(self,bVar):
-        self.__useCacheOnly = bVar
-    
-    def _umounts(self, brr):
-        self.__cat.debug(&quot;start&quot;)
-        cmd = &quot;sudo umount &quot; + self.rootdir + &quot;/proc&quot;
-        self.logCommandWithoutErrors(cmd,brr)
-        cmd = &quot;sudo umount &quot; + self.rootdir + &quot;/sys&quot;
-        self.logCommandWithoutErrors(cmd,brr)
         
-    def cleanRoot(self):
-        self.__cat.debug(&quot;cleaning this root..&quot;)
-        brr = BuildRootResult(self)
-        self._umounts(brr)
-        cmd = &quot;sudo rm -Rf &quot; + self.rootdir
-        self.logCommand(cmd,brr)
-        return brr
-        
     def __setVars(self,brr):
         self.yumConfFile = &quot;/etc/pydar2/yum/&quot; + self.__config.getBuildMachineId() + &quot;/&quot; + self.getBuildRootTag() + &quot;.conf&quot;
         if os.path.exists(self.yumConfFile):
-            self.__cat.debug(&quot;using userdefined yum conf: &quot; + self.yumConfFile)
+            self._cat.debug(&quot;using userdefined yum conf: &quot; + self.yumConfFile)
         else:
             self.yumConfFile = &quot;/etc/pydar2/yum/&quot; + self.getBuildRootTag() + &quot;.conf&quot;
-            self.__cat.debug(&quot;using normal yum conf: &quot; + self.yumConfFile)
+            self._cat.debug(&quot;using normal yum conf: &quot; + self.yumConfFile)
         self.yumCacheDir = &quot;/var/lib/pydar2/yum/cache/&quot; + self.getBuildRootTag()
         self.rootdir = &quot;/var/lib/pydar2/roots/yum-&quot; + self.getBuildRootTag()
         
-        # this definetely has to move to a config file
-        self.minimalRpmsPart1 = &quot;basesystem filesystem setup bash glibc&quot;
-        self.minimalRpmsPart2 = &quot;coreutils findutils&quot;
-        self.minimalRpmsPart3 = &quot;rpm-devel rpm-build make gcc tar gzip patch unzip bzip2 diffutils cpio elfutils redhat-rpm-config perl&quot;
-        self.minimalRpmsPart4 = &quot;&quot;
+        self._setGeneralVars()
         brr.logDebugLine(&quot;rootdir:&quot; + self.rootdir)
     
     def installRpms(self,builddepsarr):
@@ -87,21 +66,7 @@
     # makes a new root
     def prepareRoot(self):
         brr = BuildRootResult(self)
-        cmd = []
-        # create some directories first
-        cmd.append(&quot;sudo mkdir -p &quot; + self.rootdir + &quot;/var/lib/rpm &quot; + self.rootdir + &quot;/var/log &quot; + self.rootdir + &quot;/var/cache &quot; + self.rootdir + &quot;/etc &quot; + self.rootdir + &quot;/proc &quot; + self.rootdir + &quot;/sys &quot; + self.rootdir + &quot;/usr/src/redhat/BUILD &quot; + self.rootdir + &quot;/usr/src/redhat/RPMS &quot; + self.rootdir + &quot;/usr/src/redhat/SOURCES &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS &quot; + self.rootdir + &quot;/usr/src/redhat/SRPMS &quot; + self.rootdir + &quot;/dev &quot; + self.rootdir + &quot;/home/pydar2slave &quot;)
-        # copy fstab
-        cmd.append(&quot;sudo cp /etc/fstab &quot; + self.rootdir + &quot;/etc&quot;)
-        # create hosts
-        cmd.append(&quot;sudo echo -e \&quot;127.0.0.1       localhost.localdomain   localhost\&quot; &gt; &quot; + self.rootdir + &quot;/etc/hosts&quot;)
-        # mount proc
-        cmd.append(&quot;sudo mount -t proc none &quot; + self.rootdir + &quot;/proc&quot;)
-        # mount sys
-        cmd.append(&quot;sudo mount -t sysfs none &quot; + self.rootdir + &quot;/sys&quot;)
-        # create /dev/null
-        cmd.append(&quot;sudo mknod &quot; + self.rootdir + &quot;/dev/null c 1 3&quot;)
-        # rpm initdb
-        cmd.append(&quot;sudo rpm --root=&quot; + self.rootdir + &quot; --initdb&quot;)
+        cmd = self._getGeneralPrepareRootCommands()
         # use a central yum cache
         cmd.append(&quot;sudo mkdir -p &quot; + self.yumCacheDir)
         cmd.append(&quot;sudo ln -s &quot; + self.yumCacheDir + &quot; &quot; + self.rootdir + &quot;/var/cache/yum&quot;)
@@ -117,129 +82,12 @@
             cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart3)
         if self.minimalRpmsPart4 != &quot;&quot;:
             cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart4)
-        cmd.append(&quot;sudo chmod -R a+rwx &quot; + self.rootdir + &quot;/usr/src/redhat/&quot;)
+        cmd.append(&quot;sudo chmod -R a+rwx &quot; + self.rootdir + &quot;/usr/src/redhat/ &quot; + self.rootdir + &quot;/home/pydar2slave &quot;)
         self.logCommands(cmd,brr)
         return brr
         
-    def logCommands(self,cmdArr,brr):
-        for cmd in cmdArr:
-            self.logCommand(cmd,brr)
-            # todo: if error =&gt; stop
         
-    def logCommand(self,cmd,brr):
-        brr.logDebugLine(&quot;CMD: Command line:&quot; + cmd)
-        (status,output) = commands.getstatusoutput(cmd)
-        brr.logDebugLine(&quot;CMD: Status:&quot; + str(status))
-        # first remove all the '\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*
-        output = re.sub('\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*',&quot;&quot;,output)
-        output = re.sub('\r',&quot;&quot;,output)
-        brr.logDebugLine(&quot;CMD: output:&quot; + str(output))
-        if status != 0:
-            brr.logErrorLine(&quot;CMD: status (&quot; + str(status) + &quot;) is not 0 !&quot;)
-        
-    def logCommandWithoutErrors(self,cmd,brr):
-        brr.logDebugLine(&quot;CMD: Command line:&quot; + cmd)
-        (status,output) = commands.getstatusoutput(cmd)
-        brr.logDebugLine(&quot;CMD: Status:&quot; + str(status))
-        # first remove all the '\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*
-        output = re.sub('\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*',&quot;&quot;,output)
-        output = re.sub('\r',&quot;&quot;,output)
-        brr.logDebugLine(&quot;CMD: output:&quot; + str(output))
-        
-    def buildRpm(self,command):
-        brr = BuildRootResult(self)
-        self.__cat.debug(&quot;start&quot;)
-        # copy the sources
-        self.__copySources(command,brr)
-        # create a script which does the actual building
-        scriptcontents = self.__createScript(command,brr)
-        # then we call the script
-        self.__callBuildScript(scriptcontents, command, brr)
-        # get all the results
-        self.__getLogsAndRpmsAndSrpm(command,brr)
-        # then we parse the log: get additional usefull files if need, for example config.log if the build has failed
-        self.__parseLog(command,brr)
-        return brr
     
-    def __copySources(self,command,brr):
-        self.__cat.debug(&quot;start&quot;)
-        startdir = command.getBuildDir()
-        listdir = os.listdir(startdir)
-        specdestdir = os.path.join(self.rootdir,'usr/src/redhat/SPECS')
-        sourcesdestdir = os.path.join(self.rootdir,'usr/src/redhat/SOURCES')
-        self.__cat.debug('specdestdir: ' + specdestdir)
-        self.__cat.debug('sourcesdestdir: ' + sourcesdestdir)
-        for entry in listdir:
-            rindex = string.rfind(entry,'.spec')
-            if os.path.isfile(os.path.join(startdir,entry)) and not (rindex &gt; 0 and rindex == len(entry) - len('.spec')):
-                # its not the spec files
-                shutil.copy(os.path.join(startdir,entry), sourcesdestdir)
-            else:
-                # its the spec file
-                shutil.copy(os.path.join(startdir,entry),specdestdir)
-        self.__cat.debug('copy done')
-            
-    def __getLogsAndRpmsAndSrpm(self,command,brr):
-        self.__cat.debug(&quot;start&quot;)
-        shutil.copy(os.path.join(self.rootdir, &quot;buildlog.txt&quot;), command.getBuildDir())
-        cmd = &quot;gzip &quot; + command.getBuildDir() + &quot;/buildlog.txt&quot;
-        self.logCommand(cmd,brr)
-        # search in the /usr/src/redhat/RPMS and /usr/src/redhat/SRPMS dirs..
-        rpmsdir = os.path.join(self.rootdir,'usr/src/redhat/RPMS')
-        ld = os.listdir(rpmsdir)
-        for entry in ld:
-            self.__getRpmsOrSrpms(command,brr,os.path.join(rpmsdir,entry))
-        srpmsdir = os.path.join(self.rootdir,'usr/src/redhat/SRPMS')
-        self.__getRpmsOrSrpms(command,brr,srpmsdir)
-            
-    def __getRpmsOrSrpms(self,command,brr,path):
-        self.__cat.debug('start, path=' + path)
-        ld  = os.listdir(path)
-        for entry in ld:
-            rindex = string.rfind(entry,'.rpm')
-            if os.path.isfile(os.path.join(path,entry)) and (rindex &gt; 0 and rindex == len(entry) - len('.rpm')):
-                # let's copy it
-                shutil.copy(os.path.join(path,entry),command.getBuildDir())
-                rindex = string.rfind(entry,'.src.rpm')
-                if  rindex &gt; 0 and rindex == len(entry) - len('.src.rpm'):
-                    brr.setSrpm(entry)
-                else:
-                    brr.addRpm(entry)
-    
-    def __createScript(self,command,brr):
-        self.__cat.debug(&quot;start&quot;)
-        script = &quot;#!/bin/bash\n&quot;
-        script = script + 'for i in ' + self.rootdir + '/etc/profile.d/*.sh; do' + &quot;\n&quot;
-        script = script + '    if [ -r &quot;$i&quot; ]; then' + &quot;\n&quot;
-        script = script + '        . $i' + &quot;\n&quot;
-        script = script + &quot;    fi\n&quot;
-        script = script + &quot;done\n&quot;
-        script = script + &quot;chown -R root.root &quot; + self.rootdir + &quot;/usr/src/redhat\n&quot;
-        # the following command first checks if the dependencies are ok
-        # ex: --define '_topdir /var/lib/pydar2/roots/yum-fc3-i386/usr/src/redhat'
-        script = script + &quot;(echo file: &quot; + command.getSpecFileShortFileName() + &quot;;/usr/bin/rpmbuild --define '_topdir &quot; + self.rootdir + &quot;/usr/src/redhat' &quot; + command.getDefines() + &quot; --root=&quot; + self.rootdir + &quot; --nobuild --bs &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &amp;&amp; echo \&quot;deps check ok\&quot; &amp;&amp; &quot;
-        # do the real build
-        # todo: some 'post mortem analysis'
-        # if contains    error: Installed (but unpackaged) file(s) found:    -&gt; print output of a find in the buildroot
-        # if it contains a config.log:     See 'Config.log' for more details.
-        script = script + &quot;/usr/sbin/chroot &quot; + self.rootdir + &quot; /usr/bin/rpmbuild --nodeps -ba /usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &quot; + command.getDefines() + &quot; || &quot;
-        script = script + &quot;(echo ; echo ; echo CONFIG.LOG; echo ; cat &quot; + self.rootdir + &quot;/usr/src/redhat/BUILD/*/*onfig.log; echo ; echo ; echo FILES; echo ; echo ; (cd &quot; + self.rootdir  + &quot;/var/tmp/*-root*/ &amp;&amp; find .))) &gt; &quot; + self.rootdir + &quot;/buildlog.txt 2&gt;&amp;1&quot;
-        self.__cat.debug( &quot;script contains: &quot; + script)
-        return script
-        
-    def __callBuildScript(self, scriptcontents, command, brr):
-        self.__cat.debug(&quot;start&quot;)
-        # first write it to a temp file
-        filepath = self.rootdir + &quot;/tmp/pydar2build.sh&quot;
-        fd = open(filepath,&quot;w&quot;)
-        fd.write(scriptcontents)
-        fd.close()
-        cmd = &quot;sudo /bin/bash &quot; + self.rootdir + &quot;/tmp/pydar2build.sh&quot;
-        self.logCommand(cmd,brr)
-    
-    def __parseLog(self,command,brr):
-        self.__cat.debug(&quot;start, not ready&quot;)
-    
 ## tests
 #myRoot = YumBasedBuildRoot(&quot;&quot;,&quot;fedora-3-i386-core&quot;)
 #myRoot.cleanRoot()

Modified: trunk/tools/pydar2/scripts/norpmforgetemplatesfilter.py
===================================================================
--- trunk/tools/pydar2/scripts/norpmforgetemplatesfilter.py	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/scripts/norpmforgetemplatesfilter.py	2005-08-24 21:40:06 UTC (rev 3531)
@@ -23,7 +23,13 @@
 
 def NoRpmforgeTemplatesFilter(specRepoSpecFile):
     #print &quot;called with obj &quot; + str(specRepoSpecFile)
+
+    # needs to be converted to 1 encoding
+    otherencodings = [&quot;a52dec.spec&quot;,&quot;acroread.spec&quot;,&quot;akfquiz.spec&quot;,&quot;avifile.spec&quot;,&quot;bind.spec&quot;,&quot;bluez-bluefw.spec&quot;,&quot;dd2.spec&quot;,&quot;directfb.spec&quot;,&quot;easytag2.spec&quot;,&quot;easytag.spec&quot;,&quot;echoping.spec&quot;,&quot;fslint.spec&quot;,&quot;gambas-dag.spec&quot;,&quot;gambas.spec&quot;,&quot;gammu.spec&quot;,&quot;gcombust.spec&quot;,&quot;gkrellm.spec&quot;,&quot;gkrellm-plugins.spec&quot;,&quot;gnomeradio.spec&quot;,&quot;gpm.spec&quot;,&quot;grip.spec&quot;,&quot;Gtk-Perl.spec&quot;,&quot;gtoaster.spec&quot;,&quot;id3lib.spec&quot;,&quot;ifstat.spec&quot;,&quot;ipw2100-firmware.spec&quot;,&quot;ipw2200-firmware.spec&quot;,&quot;lftp.spec&quot;,&quot;libbraille.spec&quot;,&quot;libdvdread.spec&quot;,&quot;libsnack.spec&quot;,&quot;libtar.spec&quot;,&quot;libtc.spec&quot;,&quot;libXvMCW.spec&quot;,&quot;lumiere.spec&quot;,&quot;mc.spec&quot;,&quot;memcached.spec&quot;,&quot;micq.spec&quot;,&quot;mod_gzip.spec&quot;,&quot;netscape4.spec&quot;,&quot;netspeed_applet.spec&quot;,&quot;ogle_gui.spec&quot;,&quot;ogle.spec&quot;,&quot;ogmtools.spec&quot;,&quot;oidentd.spec&quot;,&quot;partimage-0.6.spec&quot;,&quot;partimage.spec&quot;,&quot;perl-RPM-Specfile.spec&quot;,&quot;perl-Text-Unaccent.spec&quot;,&quot;perl-XML-SAX.spec&quot;,&quot;pine.spec&quot;,&quot;pointless.spec&quot;,&quot;qemu.spec&quot;,&quot;rte.spec&quot;,&quot;sendmail-old.spec&quot;,&quot;sendmail.spec&quot;,&quot;spit.spec&quot;,&quot;sqlitemanager.spec&quot;,&quot;tcpreen.spec&quot;,&quot;transcode.spec&quot;,&quot;unrar.spec&quot;,&quot;uudeview.spec&quot;,&quot;xine-skins.spec&quot;,&quot;xmame-roms.spec&quot;,&quot;xmms.spec&quot;,&quot;xmule.spec&quot;,&quot;xvattr.spec&quot;,&quot;zapping.spec&quot;]
+
     fn = specRepoSpecFile.getFileName()
+    if fn in otherencodings:
+        return False
     if fn == &quot;_template.spec&quot; or fn == &quot;_template-fr.spec&quot; or fn == &quot;_perl-template.spec&quot;:
         return False
     else:

Modified: trunk/tools/pydar2/scripts/rpmforgesite.py
===================================================================
--- trunk/tools/pydar2/scripts/rpmforgesite.py	2005-08-24 07:32:17 UTC (rev 3530)
+++ trunk/tools/pydar2/scripts/rpmforgesite.py	2005-08-24 21:40:06 UTC (rev 3531)
@@ -19,195 +19,260 @@
 
 import sys, string, os, urllib,re ,shutil
 from datetime import datetime
+sys.path.append(&quot;pydar&quot;)
 sys.path.append(&quot;/usr/share/pydar2/pydar&quot;)
-sys.path.append(&quot;pydar&quot;)
+
 sys.path.append(&quot;.&quot;)
 from log4py import Logger
 from config import Config
-import storagefactory
+import storagefactory, time
 
 # currently this builds the site at dries.ulyssis.org
 # certain parts are added for building the general rpmforge site: these functions start with RF
 
-def RpmforgeSite(specRepo,useLocalFilesOnly):
-    print &quot;start, test&quot;
-    so = SiteObject(specRepo,useLocalFilesOnly)
+defaultQueryDistroArch = &quot;el4-i386&quot;
+
+def RpmforgeSite(specRepo,useLocalFilesOnly,buildSiteDries,buildSiteRpmforge):
+    so = SiteObject(specRepo,useLocalFilesOnly,buildSiteDries,buildSiteRpmforge)
     so.generate()
     
+
+stripDistRepoTagRegExpressions = [&quot;0\.el[234]\.dag\..*\.rpm&quot;,
+    &quot;0\.el[234]\.1\.dag\..*\.rpm&quot;,
+    &quot;rhel[234]\.1\.dag\..*\.rpm&quot;,
+    &quot;0\.el[234]\.rf\..*\.rpm&quot;,
+    &quot;1\.el3\.dag\..*\.rpm&quot;,
+    &quot;dag\.rhel3\..*\.rpm&quot;,
+    &quot;rhel3\.dag\..*\.rpm&quot;,
+    &quot;1\.el3\.rf\..*\.rpm&quot;,
+    &quot;2\.el4\.rf\..*\.rpm&quot;,
+    &quot;1\.fc[12]\.dag\..*\.rpm&quot;,
+    &quot;rhfc1\.dag\..*\.rpm&quot;,
+    &quot;rh80\.dag\..*\.rpm&quot;,
+    &quot;dag\.rh80\..*\.rpm&quot;,
+    &quot;rh90\.dag\..*\.rpm&quot;,
+    &quot;dag\.rh90\..*\.rpm&quot;,
+    &quot;0\.au1\.9[12]\..*\.rpm&quot;,
+    &quot;1\.fc[123]\.rf\..*\.rpm&quot;,
+    &quot;dag\.rhfc1\..*\.rpm&quot;,
+    &quot;1\.fc[12]\.dries\..*\.rpm&quot;,
+    &quot;2\.fc4\.rf\..*\.rpm&quot;,
+    &quot;dag\.rh62\..*\.rpm&quot;,
+    &quot;1\.el3\.dries\..*\.rpm&quot;,
+    &quot;rh6.\.dag\..*\.rpm&quot;,
+    &quot;0\.rh[6789]\.dag\..*\.rpm&quot;,
+    &quot;0\.dag\.noarch\.rpm&quot;,
+    &quot;rh73\.dag\..*\.rpm&quot;,
+    &quot;0\.rh[789]\.rf\..*\.rpm&quot;,
+    &quot;dag\.rh73\..*\.rpm&quot;,
+    &quot;0\.rf\.noarch\.rpm&quot;]
     
-class BinaryRpm:
-    def __init__(self,distroArchObject,name):
-        self.distroArchObject = distroArchObject
-        self.name = name
-        # let's extract the version-release
-        self.verrel = &quot;&quot;
-        tempname = name
+    
+stripDistRepoTagREs = []
+for exp in stripDistRepoTagRegExpressions:
+    stripDistRepoTagREs.append(re.compile(exp))
+
+
+# First some lists of rpms are constructed. These lists are represented by DistArchPackagerList objects. Such an object 
+# represents a list of rpms made by 1 packager for a certain dist/arch combination. For example: el4-i386-dries.
+# The list of rpms of such a list is made automatically from the index page with all the rpms, for example 
+# <A HREF="http://apt.sw.be/dries/redhat/el4/i386/en/RPMS.dries">http://apt.sw.be/dries/redhat/el4/i386/en/RPMS.dries</A>
+
+# Each rpm is represented with a RpmPackage object.
+# It contains a link to the distArchPackagerList object where the rpm is found
+
+
+
+class RpmPackage:
+    def setSpecRepoSpecFile(self,specRepoSpecFileObj):
+        self.__specRepoSpecFile = specRepoSpecFileObj
+
+    # only returns the filename without the url
+    def getName(self):
+        return self.__name
+    
+    # returns the full url which can be used in a webpage
+    def getFullUrl(self):
+        return self.__distArchPackagerList.rpmsUrl + self.__name
         
-        regex1 = re.compile(&quot;0\.el[234]\.dag\..*\.rpm&quot;)
-        regex2 = re.compile(&quot;0\.el[234]\.1\.dag\..*\.rpm&quot;)
-        regex3 = re.compile(&quot;rhel[234]\.1\.dag\..*\.rpm&quot;)
-        regex4 = re.compile(&quot;0\.el[234]\.rf\..*\.rpm&quot;)
-        regex5 = re.compile(&quot;1\.el3\.dag\..*\.rpm&quot;)
-        regex6 = re.compile(&quot;dag\.rhel3\..*\.rpm&quot;)
-        regex7 = re.compile(&quot;rhel3\.dag\..*\.rpm&quot;)
-        regex8 = re.compile(&quot;1\.el3\.rf\..*\.rpm&quot;)
-        regex9 = re.compile(&quot;2\.el4\.rf\..*\.rpm&quot;)
-        regex10 = re.compile(&quot;1\.fc[12]\.dag\..*\.rpm&quot;)
-        regex11 = re.compile(&quot;rhfc1\.dag\..*\.rpm&quot;)
-        regex12 = re.compile(&quot;rh80\.dag\..*\.rpm&quot;)
-        regex13 = re.compile(&quot;dag\.rh80\..*\.rpm&quot;)
-        regex14 = re.compile(&quot;rh90\.dag\..*\.rpm&quot;)
-        regex15 = re.compile(&quot;dag\.rh90\..*\.rpm&quot;)
-        regex16 = re.compile(&quot;0\.au1\.9[12]\..*\.rpm&quot;)
-        regex17 = re.compile(&quot;1\.fc[123]\.rf\..*\.rpm&quot;)
-        regex18 = re.compile(&quot;dag\.rhfc1\..*\.rpm&quot;)
-        regex19 = re.compile(&quot;1\.fc[12]\.dries\..*\.rpm&quot;)
-        regex20 = re.compile(&quot;2\.fc4\.rf\..*\.rpm&quot;)
-        regex21 = re.compile(&quot;dag\.rh62\..*\.rpm&quot;)
-        regex22 = re.compile(&quot;1\.el3\.dries\..*\.rpm&quot;)
-        regex23 = re.compile(&quot;rh6.\.dag\..*\.rpm&quot;)
-        regex24 = re.compile(&quot;0\.rh[6789]\.dag\..*\.rpm&quot;)
-        regex25 = re.compile(&quot;0\.dag\.noarch\.rpm&quot;)
-        regex26 = re.compile(&quot;rh73\.dag\..*\.rpm&quot;)
-        regex27 = re.compile(&quot;0\.rh[789]\.rf\..*\.rpm&quot;)
-        regex28 = re.compile(&quot;dag\.rh73\..*\.rpm&quot;)
-        regex29 = re.compile(&quot;0\.rf\.noarch\.rpm&quot;)
-        tempname = re.sub(regex1,&quot;&quot;,tempname)
-        tempname = re.sub(regex2,&quot;&quot;,tempname)
-        tempname = re.sub(regex3,&quot;&quot;,tempname)
-        tempname = re.sub(regex4,&quot;&quot;,tempname)
-        tempname = re.sub(regex5,&quot;&quot;,tempname)
-        tempname = re.sub(regex6,&quot;&quot;,tempname)
-        tempname = re.sub(regex7,&quot;&quot;,tempname)
-        tempname = re.sub(regex8,&quot;&quot;,tempname)
-        tempname = re.sub(regex9,&quot;&quot;,tempname)
-        tempname = re.sub(regex10,&quot;&quot;,tempname)
-        tempname = re.sub(regex11,&quot;&quot;,tempname)
-        tempname = re.sub(regex12,&quot;&quot;,tempname)
-        tempname = re.sub(regex13,&quot;&quot;,tempname)
-        tempname = re.sub(regex14,&quot;&quot;,tempname)
-        tempname = re.sub(regex15,&quot;&quot;,tempname)
-        tempname = re.sub(regex16,&quot;&quot;,tempname)
-        tempname = re.sub(regex17,&quot;&quot;,tempname)
-        tempname = re.sub(regex18,&quot;&quot;,tempname)
-        tempname = re.sub(regex19,&quot;&quot;,tempname)
-        tempname = re.sub(regex20,&quot;&quot;,tempname)
-        tempname = re.sub(regex21,&quot;&quot;,tempname)
-        tempname = re.sub(regex22,&quot;&quot;,tempname)
-        tempname = re.sub(regex23,&quot;&quot;,tempname)
-        tempname = re.sub(regex24,&quot;&quot;,tempname)
-        tempname = re.sub(regex25,&quot;&quot;,tempname)
-        tempname = re.sub(regex26,&quot;&quot;,tempname)
-        tempname = re.sub(regex27,&quot;&quot;,tempname)
-        tempname = re.sub(regex28,&quot;&quot;,tempname)
-        tempname = re.sub(regex29,&quot;&quot;,tempname)
+    def getDistArchPackagerList(self):
+        return self.__distArchPackagerList
         
+    def getVersion(self):
+        return self.__version
+        
+    def getRelease(self):
+        return self.__release
+        
+    #return version-release
+    def getRelVer(self):
+        return self.__version + &quot;-&quot; + self.__release
 
+    def __stripDistRepoTag(self,name):
+        for reObj in stripDistRepoTagREs:
+            name = re.sub(reObj,&quot;&quot;,name)
+        if name.find(&quot;.rpm&quot;) &gt; 0:
+            raise Exception(&quot;suffix not known: &quot; + name + &quot;, &quot; + name)        
+        return name
+
+    def __init__(self,distArchPackagerList,name):
+        self.__distArchPackagerList = distArchPackagerList
+        self.__name = name
+        # let's extract the version-release
+        self.__verrel = &quot;&quot;
+        tempname = self.__stripDistRepoTag(name)
         
-        
-        if tempname.find(&quot;.rpm&quot;) &gt; 0:
-            print &quot;suffix not known in BinaryRpm::__init__ : &quot; + name + &quot;, &quot; + tempname
-            exit(1)
         regexp = &quot;^(.*)-(.*?)-(.*?)\.$&quot;
         regex = re.compile(regexp)
         result = regex.match(tempname)
         if result:
-            self.version = result.group(2)
-            self.release = result.group(3)
-            self.verrel = self.version + &quot;-&quot; + self.release
+            self.__version = result.group(2)
+            self.__release = result.group(3)
+            self.__verrel = self.__version + &quot;-&quot; + self.__release
         else:
-            print &quot;could not get version and release, name&quot; + name + &quot;, tempname: &quot;+ tempname
-            exit(1)
+            raise Exception(&quot;could not get version and release, name:&quot; + name + &quot;, tempname:&quot;+ tempname)
+
+
+
     
-# actually not an object for each distro/arch combination, but an object for each distro/arch/packager combination!!
+# an object for each distro/arch/packager combination
 # it contains all the rpms on a certain url
-class DistroArchObject:
-    def __init__(self,packager, shortName,displayName, rpmsUrl, suffixes, fullName, additionalPaths, localFile, distroArch):
-        self.distroArch = distroArch
-        self.shortName = shortName
-        self.displayName = displayName
-        self.rpmsUrl = rpmsUrl
-        self.rpms = []
-        self.binaryRpms = []
-        self.srpms = []
-        self.binarySrpms = []
-        self.suffixes = suffixes
-        self.fullName = fullName
-        self.additionalPaths = additionalPaths
-        self.packager = packager
-        self.localFile = localFile
+class DistArchPackagerList:
+    def __init__(self, packager, displayShortName, rpmsUrl, displayFullName, additionalPaths, localFile, distroArch):
+        self.__distroArch = distroArch
+        #self.shortName = shortName
+        self.__displayShortName = displayShortName
+        self.__rpmsUrl = rpmsUrl
+        #self.rpms = []
+        self.__binaryRpms = []
+        #self.srpms = []
+        self.__binarySrpms = []
+        #self.__suffixes = suffixes
+        self.__displayFullName = displayFullName
+        self.__additionalPaths = additionalPaths
+        self.__packager = packager
+        self.__localFile = localFile
     
+    def getNumberOfBinaryRpms(self):
+        return len(self.__binaryRpms)
+      
+    def getNumberOfSourceRpms(self):
+        return len(self.__binarySrpms)
+    
+    # get the local file. the local file contains the page at the url rpmsUrl. this can be used for testing/debugging
+    # this local file is not automatically updated
+    def getLocalFile(self):
+        return self.__localFile
+        
+    # rpmsUrl is an url where a page can be found containing all those rpms
+    def getRpmsUrl(self):
+        return self.__rpmsUrl
+    
+    # short name of the packager like 'dries'
+    def getPackager(self):
+        return self.__packager
+        
+    # distroarch, for example: 'el4-i386'
+    def getDistArch(self):
+        return self.__distroArch
+        
+    # displayShortName, for example 'el4 i386 rpms' (was: displayName)
+    def getDisplayShortName(self):
+        return self.__displayShortName
+        
+    # displayFullName, for example 'Red Hat Enterprise Linux 4 for i386' (was: fullName)
+    def getDisplayFullName(self):
+        return self.__displayFullName
+      
+    # distroarchpackager, for example 'el4-i386-dries' (was: shortName)
+    def getDistArchPackager(self):
+      return self.__distroArch + &quot;-&quot; + self.__packager
+    
+    def addBinaryRpm(self, bo):
+      self.__binaryRpms.append(bo)
+    
+    
 class SiteObject:
-    def __init__(self,specRepo,useLocalFilesOnly):
+    def __init__(self,specRepo,useLocalFilesOnly,buildDriesSite,buildRpmforgeSite):
         self.__cat = Logger().get_instance(self)
         self.__cat.debug(&quot;start&quot;)
+        self.__timer(&quot;SiteObject init&quot;)
         self.__useLocalFilesOnly = useLocalFilesOnly
+        self.__buildDriesSite = buildDriesSite
+        self.__buildRpmforgeSite = buildRpmforgeSite
+        
         # this is a hash which contains values which can be used in templates
         # for example FC3-I386-DRIES-RPMS -&gt; 533     (the number of rpms)
         #                       LASTUPDATE -&gt; 4 jan 2010 5:07
         self.__siteValues = {}
         self.__specRepo = specRepo
-        self.__fullcontentstemplate = None
+        self.__Driesfullcontentstemplate = None
         self.__RFfullcontentstemplate = None
-        self.__siterootdir =  &quot;/tmp/packages/&quot;
+        self.__DriesSiterootdir =  &quot;/tmp/packages/&quot;
         self.__RFsiterootdir = &quot;/tmp/rpmforgesite/&quot;
         self.__storage = storagefactory.StorageFactory.getStorage()
-        self.__rpmlists = []
+        self.__timer(&quot;distArchPackagerLists init&quot;)
+        self.__distArchPackagerLists = []
         addPaths = ['redhat/el4/en/i386']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;el4-i386-dries&quot;, &quot;el4 i386 rpms&quot;,&quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el4/en/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el4/en/i386/RPMS.dries/</A>&quot;, [&quot;el4.rf&quot;], &quot;Red Hat Enterprise Linux 4 for i386&quot;, addPaths, &quot;scripts/cache/el4-i386-dries.html&quot;, &quot;el4-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;el4 i386 rpms&quot;,&quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el4/en/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el4/en/i386/RPMS.dries/</A>&quot;, &quot;Red Hat Enterprise Linux 4 for i386&quot;, addPaths, &quot;scripts/cache/el4-i386-dries.html&quot;, &quot;el4-i386&quot;))
         addPaths = ['redhat/el3/en/i386']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;el3-i386-dries&quot;, &quot;el3 i386 rpms&quot;,&quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el3/en/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el3/en/i386/RPMS.dries/</A>&quot;, [&quot;el3.rf&quot;], &quot;Red Hat Enterprise Linux 3 for i386&quot;, addPaths, &quot;scripts/cache/el3-i386-dries.html&quot;, &quot;el3-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;el3 i386 rpms&quot;,&quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el3/en/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el3/en/i386/RPMS.dries/</A>&quot;, &quot;Red Hat Enterprise Linux 3 for i386&quot;, addPaths, &quot;scripts/cache/el3-i386-dries.html&quot;, &quot;el3-i386&quot;))
         addPaths = ['fedora/fc3/i386']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;fc3-i386-dries&quot;, &quot;fc3 i386 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc3/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc3/i386/RPMS.dries/</A>&quot;, [&quot;fc3.rf&quot;, &quot;fc3.dries&quot;], &quot;Fedora Core 3 for i386&quot;, addPaths, &quot;scripts/cache/fc3-i386-dries.html&quot;, &quot;fc3-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;fc3 i386 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc3/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc3/i386/RPMS.dries/</A>&quot;, &quot;Fedora Core 3 for i386&quot;, addPaths, &quot;scripts/cache/fc3-i386-dries.html&quot;, &quot;fc3-i386&quot;))
         addPaths = ['fedora/fc2/i386']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;fc2-i386-dries&quot;, &quot;fc2 i386 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc2/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc2/i386/RPMS.dries/</A>&quot;, [&quot;fc2.rf&quot;, &quot;fc2.dries&quot;], &quot;Fedora Core 2 for i386&quot;, addPaths, &quot;scripts/cache/fc2-i386-dries.html&quot;, &quot;fc2-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;fc2 i386 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc2/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc2/i386/RPMS.dries/</A>&quot;, &quot;Fedora Core 2 for i386&quot;, addPaths, &quot;scripts/cache/fc2-i386-dries.html&quot;, &quot;fc2-i386&quot;))
         addPaths = ['fedora/fc1/i386']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;fc1-i386-dries&quot;, &quot;fc1 i386 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc1/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc1/i386/RPMS.dries/</A>&quot;, [&quot;fc1.rf&quot;, &quot;fc1.dries&quot;], &quot;Fedora Core 1 for i386&quot;, addPaths, &quot;scripts/cache/fc1-i386-dries.html&quot;, &quot;fc1-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;fc1 i386 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc1/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc1/i386/RPMS.dries/</A>&quot;, &quot;Fedora Core 1 for i386&quot;, addPaths, &quot;scripts/cache/fc1-i386-dries.html&quot;, &quot;fc1-i386&quot;))
         addPaths = ['fedora/fc4/i386']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;fc4-i386-dries&quot;, &quot;fc4 i386 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc4/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc4/i386/RPMS.dries/</A>&quot;, [&quot;fc4.rf&quot;, &quot;fc4.dries&quot;], &quot;Fedora Core 4 for i386&quot;, addPaths, &quot;scripts/cache/fc4-i386-dries.html&quot;, &quot;fc4-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;fc4 i386 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc4/i386/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc4/i386/RPMS.dries/</A>&quot;, &quot;Fedora Core 4 for i386&quot;, addPaths, &quot;scripts/cache/fc4-i386-dries.html&quot;, &quot;fc4-i386&quot;))
         addPaths = ['fedora/fc4/x86_64']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;fc4-x86_64-dries&quot;, &quot;fc4 x86_64 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc4/x86_64/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc4/x86_64/RPMS.dries/</A>&quot;, [&quot;fc4.rf&quot;, &quot;fc4.dries&quot;], &quot;Fedora Core 4 for x86_64&quot;, addPaths, &quot;scripts/cache/fc4-x86_64-dries.html&quot;, &quot;fc4-x86_64&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;fc4 x86_64 rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc4/x86_64/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/fc4/x86_64/RPMS.dries/</A>&quot;, &quot;Fedora Core 4 for x86_64&quot;, addPaths, &quot;scripts/cache/fc4-x86_64-dries.html&quot;, &quot;fc4-x86_64&quot;))
         addPaths = ['aurora/1.92/sparc']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;au1.92-sparc-dries&quot;, &quot;au1.92 sparc rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.92/sparc/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.92/sparc/RPMS.dries/</A>&quot;, [&quot;au1.92.rf&quot;, &quot;au1.92.dries&quot;], &quot;Aurora 1.92 for sparc&quot;, addPaths, &quot;scripts/cache/au1.92-sparc-dries.html&quot;, &quot;au1.92-sparc&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;au1.92 sparc rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.92/sparc/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.92/sparc/RPMS.dries/</A>&quot;, &quot;Aurora 1.92 for sparc&quot;, addPaths, &quot;scripts/cache/au1.92-sparc-dries.html&quot;, &quot;au1.92-sparc&quot;))
         addPaths = ['aurora/1.91/sparc']
-        self.__rpmlists.append(DistroArchObject(&quot;dries&quot;, &quot;au1.91-sparc-dries&quot;, &quot;au1.91 sparc rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.91/sparc/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.91/sparc/RPMS.dries/</A>&quot;, [&quot;au1.91.rf&quot;, &quot;au1.91.dries&quot;],&quot;Aurora 1.91 for sparc&quot;, addPaths, &quot;scripts/cache/au1.91-sparc-dries.html&quot;, &quot;au1.91-sparc&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dries&quot;, &quot;au1.91 sparc rpms&quot;, &quot;<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.91/sparc/RPMS.dries/">http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.91/sparc/RPMS.dries/</A>&quot;, &quot;Aurora 1.91 for sparc&quot;, addPaths, &quot;scripts/cache/au1.91-sparc-dries.html&quot;, &quot;au1.91-sparc&quot;))
         #dag:
         #<A HREF="http://apt.sw.be/fedora/3/en/i386/RPMS.dag/">http://apt.sw.be/fedora/3/en/i386/RPMS.dag/</A>
         #<A HREF="http://apt.sw.be/fedora/3/en/x86_64/RPMS.dag/">http://apt.sw.be/fedora/3/en/x86_64/RPMS.dag/</A>
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;rh6-i386-dag&quot;, &quot;rh6 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/6.2/en/i386/RPMS.dag/">http://apt.sw.be/redhat/6.2/en/i386/RPMS.dag/</A>&quot;, [&quot;rh6.rf&quot;, &quot;rh6.dag&quot;],&quot;Red Hat 6.2 for i386&quot;, addPaths, &quot;scripts/cache/rh6-i386-dag.html&quot;, &quot;rh6-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;rh6 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/6.2/en/i386/RPMS.dag/">http://apt.sw.be/redhat/6.2/en/i386/RPMS.dag/</A>&quot;, &quot;Red Hat 6.2 for i386&quot;, addPaths, &quot;scripts/cache/rh6-i386-dag.html&quot;, &quot;rh6-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;rh7-i386-dag&quot;, &quot;rh7 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/7.3/en/i386/RPMS.dag/">http://apt.sw.be/redhat/7.3/en/i386/RPMS.dag/</A>&quot;, [&quot;rh7.rf&quot;, &quot;rh7.dag&quot;],&quot;Red Hat 7.3 for i386&quot;, addPaths, &quot;scripts/cache/rh7-i386-dag.html&quot;, &quot;rh7-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;rh7 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/7.3/en/i386/RPMS.dag/">http://apt.sw.be/redhat/7.3/en/i386/RPMS.dag/</A>&quot;, &quot;Red Hat 7.3 for i386&quot;, addPaths, &quot;scripts/cache/rh7-i386-dag.html&quot;, &quot;rh7-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;rh8-i386-dag&quot;, &quot;rh8 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/8.0/en/i386/RPMS.dag/">http://apt.sw.be/redhat/8.0/en/i386/RPMS.dag/</A>&quot;, [&quot;rh8.rf&quot;, &quot;rh8.dag&quot;],&quot;Red Hat 8.0 for i386&quot;, addPaths, &quot;scripts/cache/rh8-i386-dag.html&quot;, &quot;rh8-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;rh8 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/8.0/en/i386/RPMS.dag/">http://apt.sw.be/redhat/8.0/en/i386/RPMS.dag/</A>&quot;, &quot;Red Hat 8.0 for i386&quot;, addPaths, &quot;scripts/cache/rh8-i386-dag.html&quot;, &quot;rh8-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;rh9-i386-dag&quot;, &quot;rh8 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/9/en/i386/RPMS.dag/">http://apt.sw.be/redhat/9/en/i386/RPMS.dag/</A>&quot;, [&quot;rh9.rf&quot;, &quot;rh9.dag&quot;],&quot;Red Hat 9 for i386&quot;, addPaths, &quot;scripts/cache/rh9-i386-dag.html&quot;, &quot;rh9-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;rh9 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/9/en/i386/RPMS.dag/">http://apt.sw.be/redhat/9/en/i386/RPMS.dag/</A>&quot;,&quot;Red Hat 9 for i386&quot;, addPaths, &quot;scripts/cache/rh9-i386-dag.html&quot;, &quot;rh9-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;el2-i386-dag&quot;, &quot;el2 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el2.1/en/i386/RPMS.dag/">http://apt.sw.be/redhat/el2.1/en/i386/RPMS.dag/</A>&quot;, [&quot;el2.rf&quot;, &quot;el.dag&quot;],&quot;Red Hat Enterprise Linux 2.1 for i386&quot;, addPaths, &quot;scripts/cache/el2-i386-dag.html&quot;, &quot;el2-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;el2 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el2.1/en/i386/RPMS.dag/">http://apt.sw.be/redhat/el2.1/en/i386/RPMS.dag/</A>&quot;, &quot;Red Hat Enterprise Linux 2.1 for i386&quot;, addPaths, &quot;scripts/cache/el2-i386-dag.html&quot;, &quot;el2-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;el3-i386-dag&quot;, &quot;el3 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el3/en/i386/RPMS.dag/">http://apt.sw.be/redhat/el3/en/i386/RPMS.dag/</A>&quot;, [&quot;el3.rf&quot;, &quot;el3.dag&quot;],&quot;Red Hat Enterprise Linux 3 for i386&quot;, addPaths, &quot;scripts/cache/el3-i386-dag.html&quot;, &quot;el3-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;el3 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el3/en/i386/RPMS.dag/">http://apt.sw.be/redhat/el3/en/i386/RPMS.dag/</A>&quot;, &quot;Red Hat Enterprise Linux 3 for i386&quot;, addPaths, &quot;scripts/cache/el3-i386-dag.html&quot;, &quot;el3-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;el3-x86_64-dag&quot;, &quot;el3 x86_64 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el3/en/x86_64/RPMS.dag/">http://apt.sw.be/redhat/el3/en/x86_64/RPMS.dag/</A>&quot;, [&quot;el3.rf&quot;, &quot;el3.dag&quot;],&quot;Red Hat Enterprise Linux 3 for x86_64&quot;, addPaths, &quot;scripts/cache/el3-x86_64-dag.html&quot;, &quot;el3-x86_64&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;el3 x86_64 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el3/en/x86_64/RPMS.dag/">http://apt.sw.be/redhat/el3/en/x86_64/RPMS.dag/</A>&quot;,&quot;Red Hat Enterprise Linux 3 for x86_64&quot;, addPaths, &quot;scripts/cache/el3-x86_64-dag.html&quot;, &quot;el3-x86_64&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;el4-i386-dag&quot;, &quot;el4 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el4/en/i386/RPMS.dag/">http://apt.sw.be/redhat/el4/en/i386/RPMS.dag/</A>&quot;, [&quot;el4.rf&quot;, &quot;el4.dag&quot;],&quot;Red Hat Enterprise Linux 4 for i386&quot;, addPaths, &quot;scripts/cache/el4-i386-dag.html&quot;, &quot;el4-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;el4 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el4/en/i386/RPMS.dag/">http://apt.sw.be/redhat/el4/en/i386/RPMS.dag/</A>&quot;, &quot;Red Hat Enterprise Linux 4 for i386&quot;, addPaths, &quot;scripts/cache/el4-i386-dag.html&quot;, &quot;el4-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;el4-x86_64-dag&quot;, &quot;el4 x86_64 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el4/en/x86_64/RPMS.dag/">http://apt.sw.be/redhat/el4/en/x86_64/RPMS.dag/</A>&quot;, [&quot;el4.rf&quot;, &quot;el4.dag&quot;],&quot;Red Hat Enterprise Linux 4 for x86_64&quot;, addPaths, &quot;scripts/cache/el4-x86_64-dag.html&quot;, &quot;el4-x86_64&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;el4 x86_64 rpms&quot;, &quot;<A HREF="http://apt.sw.be/redhat/el4/en/x86_64/RPMS.dag/">http://apt.sw.be/redhat/el4/en/x86_64/RPMS.dag/</A>&quot;, &quot;Red Hat Enterprise Linux 4 for x86_64&quot;, addPaths, &quot;scripts/cache/el4-x86_64-dag.html&quot;, &quot;el4-x86_64&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;fc1-i386-dag&quot;, &quot;fc1 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/1/en/i386/RPMS.dag/">http://apt.sw.be/fedora/1/en/i386/RPMS.dag/</A>&quot;, [&quot;fc1.rf&quot;, &quot;fc1.dag&quot;],&quot;Fedora Core 1 for i386&quot;, addPaths, &quot;scripts/cache/fc1-i386-dag.html&quot;, &quot;fc1-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;fc1 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/1/en/i386/RPMS.dag/">http://apt.sw.be/fedora/1/en/i386/RPMS.dag/</A>&quot;, &quot;Fedora Core 1 for i386&quot;, addPaths, &quot;scripts/cache/fc1-i386-dag.html&quot;, &quot;fc1-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;fc2-i386-dag&quot;, &quot;fc2 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/2/en/i386/RPMS.dag/">http://apt.sw.be/fedora/2/en/i386/RPMS.dag/</A>&quot;, [&quot;fc2.rf&quot;, &quot;fc2.dag&quot;],&quot;Fedora Core 2 for i386&quot;, addPaths, &quot;scripts/cache/fc2-i386-dag.html&quot;, &quot;fc2-i386&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;fc2 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/2/en/i386/RPMS.dag/">http://apt.sw.be/fedora/2/en/i386/RPMS.dag/</A>&quot;, &quot;Fedora Core 2 for i386&quot;, addPaths, &quot;scripts/cache/fc2-i386-dag.html&quot;, &quot;fc2-i386&quot;))
         addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;fc2-x86_64-dag&quot;, &quot;fc2 x86_64 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/2/en/x86_64/RPMS.dag/">http://apt.sw.be/fedora/2/en/x86_64/RPMS.dag/</A>&quot;, [&quot;fc2.rf&quot;, &quot;fc2.dag&quot;],&quot;Fedora Core 2 for x86_64&quot;, addPaths, &quot;scripts/cache/fc2-x86_64-dag.html&quot;, &quot;fc2-x86_64&quot;))
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;fc2 x86_64 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/2/en/x86_64/RPMS.dag/">http://apt.sw.be/fedora/2/en/x86_64/RPMS.dag/</A>&quot;, &quot;Fedora Core 2 for x86_64&quot;, addPaths, &quot;scripts/cache/fc2-x86_64-dag.html&quot;, &quot;fc2-x86_64&quot;))
         addPaths = []
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;fc3 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/3/en/i386/RPMS.dag/">http://apt.sw.be/fedora/3/en/i386/RPMS.dag/</A>&quot;, &quot;Fedora Core 3 for i386&quot;, addPaths, &quot;scripts/cache/fc3-i386-dag.html&quot;, &quot;fc3-i386&quot;))
+        addPaths = []
+        self.__distArchPackagerLists.append(DistArchPackagerList(&quot;dag&quot;, &quot;fc3 x86_64 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/3/en/x86_64/RPMS.dag/">http://apt.sw.be/fedora/3/en/x86_64/RPMS.dag/</A>&quot;, &quot;Fedora Core 3 for x86_64&quot;, addPaths, &quot;scripts/cache/fc3-x86_64-dag.html&quot;, &quot;fc3-x86_64&quot;))
+        self.__timer(&quot;distArchPackagerLists init&quot;)
         
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;fc3-i386-dag&quot;, &quot;fc3 i386 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/3/en/i386/RPMS.dag/">http://apt.sw.be/fedora/3/en/i386/RPMS.dag/</A>&quot;, [&quot;fc3.rf&quot;, &quot;fc3.dag&quot;],&quot;Fedora Core 3 for i386&quot;, addPaths, &quot;scripts/cache/fc3-i386-dag.html&quot;, &quot;fc3-i386&quot;))
-        addPaths = []
-        self.__rpmlists.append(DistroArchObject(&quot;dag&quot;, &quot;fc3-x86_64-dag&quot;, &quot;fc3 x86_64 rpms&quot;, &quot;<A HREF="http://apt.sw.be/fedora/3/en/x86_64/RPMS.dag/">http://apt.sw.be/fedora/3/en/x86_64/RPMS.dag/</A>&quot;, [&quot;fc3.rf&quot;, &quot;fc3.dag&quot;],&quot;Fedora Core 3 for x86_64&quot;, addPaths, &quot;scripts/cache/fc3-x86_64-dag.html&quot;, &quot;fc3-x86_64&quot;))
         self.__rpmNameToSpecSubDirName = {}
+        self.__timer(&quot;completeRpmsLists&quot;)
         self.__completeRpmsLists()
+        self.__timer(&quot;completeRpmsLists&quot;)
+        self.__timer(&quot;completeSiteValues&quot;)
         self.__completeSiteValues()
+        self.__timer(&quot;completeSiteValues&quot;)
+        self.__timer(&quot;SiteObject init&quot;)
         
-        
     # counters is a hash which contains interesting values which can be used on pages
     def __completeSiteValues(self):
         # it should already contain
@@ -218,35 +283,67 @@
         totsrpms = 0
         totrpmsdries = 0
         totrpmsdag = 0
-        for d in self.__rpmlists:
-            totrpms = totrpms + len(d.rpms)
-            totsrpms = totsrpms + len(d.srpms)
-            if d.packager == &quot;dries&quot;:
-                totrpmsdries = totrpmsdries + len(d.rpms)
-            if d.packager == &quot;dag&quot;:
-                totrpmsdag = totrpmsdag + len(d.rpms)
+        for d in self.__distArchPackagerLists:
+            totrpms = totrpms + d.getNumberOfBinaryRpms()
+            totsrpms = totsrpms + d.getNumberOfSourceRpms()
+            if d.getPackager() == &quot;dries&quot;:
+                totrpmsdries = totrpmsdries + d.getNumberOfBinaryRpms()
+            if d.getPackager() == &quot;dag&quot;:
+                totrpmsdag = totrpmsdag + d.getNumberOfBinaryRpms()
         self.__siteValues[&quot;TOTALRPMS&quot;] = totrpms
         self.__siteValues[&quot;TOTALSRPMS&quot;] = totsrpms
+        self.__siteValues[&quot;TOTAL-RPMS-DRIES&quot;] = totrpmsdries
+        self.__siteValues[&quot;TOTAL-RPMS-DAG&quot;] = totrpmsdag
+        for k in self.__siteValues.keys():
+          print &quot;siteval,k:&quot; + k + &quot;,v:&quot; + str(self.__siteValues[k])
         
     def __completeRpmsLists(self):
+        self.__completeBinaryRpmsLists()
+        #self.__completeSourceRpmsLists()
+    
+    lastTimerTimestamp = {}
+    totalTimerTimestamp = {}
+    isRunningTimerTimestamp = {}
+    
+    def __timer(self,msg):
+        if msg in SiteObject.lastTimerTimestamp.keys():
+            if SiteObject.isRunningTimerTimestamp[msg] == 1:
+                SiteObject.totalTimerTimestamp[msg] = SiteObject.totalTimerTimestamp[msg] + time.time() - SiteObject.lastTimerTimestamp[msg]
+                SiteObject.isRunningTimerTimestamp[msg] = 0
+                #print &quot;[TIMER] &quot; + msg + &quot;: &quot; + str(SiteObject.totalTimerTimestamp[msg])
+            else:
+                SiteObject.isRunningTimerTimestamp[msg] = 1
+                SiteObject.lastTimerTimestamp[msg] = time.time()
+        else:
+            SiteObject.lastTimerTimestamp[msg] = time.time()
+            SiteObject.totalTimerTimestamp[msg] = 0
+            SiteObject.isRunningTimerTimestamp[msg] = 1
+    
+    def printTimers(self):
+        for msg in SiteObject.totalTimerTimestamp.keys():
+            print &quot;TIMER: &quot;  + msg + &quot;: &quot; + str(SiteObject.totalTimerTimestamp[msg])
+            
+            
+    def __completeBinaryRpmsLists(self):
+        self.__timer(&quot;__completeBinaryRpmsLists&quot;)
         # list of packagenames
-        packagenames = self.__getPackageNameListSortedByLength()
+        extendedPackagenames = self.__getPackageNameListSortedByLength()
         # make a hash packagename -&gt; specrepospecfile
         nametospecrepospecfile = {}
         for srsf in self.__specRepo.getSpecRepositorySpecFiles():
             nametospecrepospecfile[srsf.getSubDir()] = srsf
         #firstre = re.compile('&lt;A HREF=&quot;.*\.rpm&lt;\/A&gt;')
         secondre = re.compile('&lt;[Aa] [Hh][Rr][Ee][Ff]=&quot;(.*\.rpm)&quot;&gt;.*\.rpm&lt;/[Aa]&gt; *([0-9]*)-([A-Za-z]*)-([0-9]*) ')
-        for listje in self.__rpmlists:
+        for listje in self.__distArchPackagerLists:
             # ok get the list of rpms and srpms of this list
             f = None
             if not self.__useLocalFilesOnly:
-                f = urllib.urlopen(listje.rpmsUrl)
+                f = urllib.urlopen(listje.getRpmsUrl())
             else:
-                print &quot;localFile: &quot; + listje.localFile
-                f = open(listje.localFile)
+                print &quot;localFile: &quot; + listje.getLocalFile()
+                f = open(listje.getLocalFile())
             #print f.info()
-            print  &quot;start, &quot; + listje.rpmsUrl
+            print  &quot;start, &quot; + listje.getRpmsUrl()
             lijn = f.readline()
             while lijn != &quot;&quot;:
                 #print l
@@ -255,25 +352,39 @@
                 mo = secondre.search(lijn)
                 if mo != None:
                     rpm = mo.group(1)
-                    listje.rpms.append(rpm)
-                    bo = BinaryRpm(listje,rpm)
-                    listje.binaryRpms.append(bo)
+                    #listje.rpms.append(rpm)
+                    bo = RpmPackage(listje,rpm)
+                    listje.addBinaryRpm(bo)
                     i = 0
-                    while ((i &lt; len(packagenames)) and (not rpm.startswith(packagenames[i]))):
-                        i = i + 1
-                        #print i, len(packagenames)
-                    if i&lt;len(packagenames):
-                        #print &quot;match: &quot; + rpm + &quot;, package=&quot; + packagenames[i]
-                        nametospecrepospecfile[packagenames[i]].rpmfilenames.append(listje.rpmsUrl + rpm)
-                        print &quot;adding: &quot; + rpm
-                        nametospecrepospecfile[packagenames[i]].binaryrpms.append(bo)
-                        self.__rpmNameToSpecSubDirName[rpm] = packagenames[i]
+                    #self.__timer(&quot;search in packagenames&quot;)
+                    #print &quot;rpm: &quot; + rpm
+                    start = rpm[0:2]
+                    if start in extendedPackagenames.keys():
+                        packagenames = extendedPackagenames[rpm[0:2]]
+                        while ((i &lt; len(packagenames)) and (not rpm.startswith(packagenames[i]))):
+                            i = i + 1
+                            #print i, len(packagenames), packagenames[i]
+                        #self.__timer(&quot;search in packagenames&quot;)
+                        if i&lt;len(packagenames):
+                            #print &quot;match: &quot; + rpm + &quot;, package=&quot; + packagenames[i]
+                            #nametospecrepospecfile[packagenames[i]].rpmfilenames.append(listje.getRpmsUrl() + rpm)
+                            #print &quot;adding: &quot; + rpm
+                            #nametospecrepospecfile[packagenames[i]].binaryrpms.append(bo)
+                            bo.setSpecRepoSpecFile(nametospecrepospecfile[packagenames[i]])
+                            #self.__rpmNameToSpecSubDirName[rpm] = packagenames[i]
+                        else:
+                            print &quot;not adding: &quot; + rpm
+                    else:
+                        print &quot;not in keys: &quot;+ start
                 else:
-                    print &quot;bad line: &quot; + lijn
+                    badLines = 1
+                    #print &quot;bad line: &quot; + lijn
                 lijn = f.readline()
             f.close()
-            self.__siteValues[listje.shortName.upper() + &quot;-RPMS&quot;] = len(listje.rpms)
+            self.__siteValues[listje.getDisplayShortName().upper() + &quot;-RPMS&quot;] = listje.getNumberOfBinaryRpms()
+        self.__timer(&quot;__completeBinaryRpmsLists&quot;)    
             
+    def completeSourceRpmsLists(self):    
         # the same for the sprms
         for listje in self.__rpmlists:
             # ok get the list of rpms and srpms of this list
@@ -307,96 +418,129 @@
         
     def __getPackageNameListSortedByLength(self):
         retval = []
+        #for srsf in self.__specRepo.getSpecRepositorySpecFiles():
+        #    name = srsf.getSubDir()
+        #    retval.append(name)
+        #retval.sort(lambda x, y : len(y)-len(x))
+        self.__timer(&quot;extra packagenamelists&quot;)
+        extendedPackageLists = {}
         for srsf in self.__specRepo.getSpecRepositorySpecFiles():
             name = srsf.getSubDir()
-            retval.append(name)
-        retval.sort(lambda x, y : len(y)-len(x))
-        return retval
+            start = name[0:2]
+            if start in extendedPackageLists.keys():
+                extendedPackageLists[start].append(name)
+            else:
+                tmplist = [name]
+                extendedPackageLists[start] = tmplist
+        for k in extendedPackageLists.keys():
+            extendedPackageLists[k].sort(lambda x, y: len(y) - len(x))
+        self.__timer(&quot;extra packagenamelists&quot;)
+        return extendedPackageLists
         
     def generate(self):
         # generate the content
         print &quot;start, static pages&quot;
-        self.generateIndexPage()
-        self.generateMirrorsPage()
-        self.generatePackagesPage()
-        self.generateRecentChangesPage()
-        self.generateGPGKeyPage()
-        self.clientConfigPage()
-        self.pydar2Pages()
-        self.setGPGKey()
+        self.__timer(&quot;generate&quot;)
+        if self.__buildDriesSite:
+            self.generateIndexPage()
+            self.generateMirrorsPage()
+            self.generatePackagesPage()
+            self.generateRecentChangesPage()
+            self.generateGPGKeyPage()
+            self.clientConfigPage()
+            self.pydar2Pages()
+            self.setGPGKey()
+        
         print &quot;start, specrepospecfile pages&quot;
-        for i in self.__specRepo.getSpecRepositorySpecFiles():
-            self.generateOnePackagePage(i)
-            #self.RFgenerateUserPackagePage(i)
-            self.RFgenerateSpecPages(i)
-        self.RFgeneratePackagesPages()
+        for specRepoSpecFile in self.__specRepo.getSpecRepositorySpecFiles():
+            shortName = specRepoSpecFile.getSubDir()
+            versions = self.__storage.getVersionIdsOfSpecRepoSpecFile(specRepoSpecFile)
+            hash = self.__storage.getTagsOfSpecFileVersionNew(versions[0])
+            if defaultQueryDistroArch in hash.keys():
+                if self.__buildDriesSite:
+                    self.generateOnePackagePage(specRepoSpecFile)
+                if self.__buildRpmforgeSite:        
+                    #self.RFgenerateSpecPages(specRepoSpecFile)
+                    self.RFgenerateUserPackagePage(specRepoSpecFile, hash)
+                    self.RFgenerateDeveloperPackagePage(specRepoSpecFile, hash)
+                    self.RFgeneratePackagerPackagePage(specRepoSpecFile)
+            else:
+                print &quot;ERROR: defaultQueryDistArch not in hash for &quot; + specRepoSpecFile.getSubDir()
+        if self.__buildRpmforgeSite:
+            self.RFgeneratePackagesPages()
         print &quot;start, distropages&quot;
-        for i in self.__rpmlists:
-            if i.packager == &quot;dries&quot;:
-                self.generateDistroArchPageRpm(i)
-                self.generateDistroArchPageSrpm(i)
-        # also create some directory indexes
-        dirs = [&quot;fedora&quot;, &quot;redhat&quot;, &quot;aurora&quot;]
-        for i in dirs:
-            self.generateDirectoryView(i)
-        # add some symbolic links
-        self.createDirHierarchy(&quot;fedora/core&quot;)
-        self.createDirHierarchy(&quot;fedora/linux&quot;)
-        self.createSymbolicLink(&quot;fedora/core/1&quot;, &quot;../fc1&quot;)
-        self.createSymbolicLink(&quot;fedora/core/2&quot;, &quot;../fc2&quot;)
-        self.createSymbolicLink(&quot;fedora/core/3&quot;, &quot;../fc3&quot;)
-        self.createSymbolicLink(&quot;fedora/core/4&quot;, &quot;../fc4&quot;)
-        self.createSymbolicLink(&quot;fedora/linux/1&quot;, &quot;../fc1&quot;)
-        self.createSymbolicLink(&quot;fedora/linux/2&quot;, &quot;../fc2&quot;)
-        self.createSymbolicLink(&quot;fedora/linux/3&quot;, &quot;../fc3&quot;)
-        self.createSymbolicLink(&quot;fedora/linux/4&quot;, &quot;../fc4&quot;)
-        self.generateDirectoryView(&quot;fedora&quot;)
-        self.generateDirectoryView(&quot;fedora/core&quot;)
-        self.generateDirectoryView(&quot;fedora/linux&quot;)
-        self.generateDirectoryView(&quot;redhat&quot;)
-        self.generateDirectoryView(&quot;aurora&quot;)
+        if self.__buildDriesSite:
+            for i in self.__rpmlists:
+                if i.packager == &quot;dries&quot;:
+                    self.generateDistroArchPageRpm(i)
+                    self.generateDistroArchPageSrpm(i)
+            # also create some directory indexes
+            dirs = [&quot;fedora&quot;, &quot;redhat&quot;, &quot;aurora&quot;]
+            for i in dirs:
+                self.generateDirectoryView(i)
+            # add some symbolic links
+            self.createDirHierarchy(&quot;fedora/core&quot;)
+            self.createDirHierarchy(&quot;fedora/linux&quot;)
+            self.createSymbolicLink(&quot;fedora/core/1&quot;, &quot;../fc1&quot;)
+            self.createSymbolicLink(&quot;fedora/core/2&quot;, &quot;../fc2&quot;)
+            self.createSymbolicLink(&quot;fedora/core/3&quot;, &quot;../fc3&quot;)
+            self.createSymbolicLink(&quot;fedora/core/4&quot;, &quot;../fc4&quot;)
+            self.createSymbolicLink(&quot;fedora/linux/1&quot;, &quot;../fc1&quot;)
+            self.createSymbolicLink(&quot;fedora/linux/2&quot;, &quot;../fc2&quot;)
+            self.createSymbolicLink(&quot;fedora/linux/3&quot;, &quot;../fc3&quot;)
+            self.createSymbolicLink(&quot;fedora/linux/4&quot;, &quot;../fc4&quot;)
+            self.generateDirectoryView(&quot;fedora&quot;)
+            self.generateDirectoryView(&quot;fedora/core&quot;)
+            self.generateDirectoryView(&quot;fedora/linux&quot;)
+            self.generateDirectoryView(&quot;redhat&quot;)
+            self.generateDirectoryView(&quot;aurora&quot;)
+        self.__timer(&quot;generate&quot;)
+        self.__timer(&quot;printCounters&quot;)
+        self.__storage.printCounters()
+        self.__timer(&quot;printCounters&quot;)
+        self.printTimers()
         
     def generateDirectoryView(self,path):
         contents = self.__getFileContents(&quot;dries/directoryview-part.html&quot;)
-        self.generateFullPage(contents,[],path + &quot;/index.php&quot;, &quot;Index of /rpm/&quot; + path + &quot; - Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],path + &quot;/index.php&quot;, &quot;Index of /rpm/&quot; + path + &quot; - Dries RPM Repository&quot;)
         
             
     def pydar2Pages(self):
         contents = self.__getFileContents(&quot;dries/pydar2/index-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;pydar2/index.html&quot;, &quot;Pydar2 rpm buildserver: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;pydar2/index.html&quot;, &quot;Pydar2 rpm buildserver: Dries RPM Repository&quot;)
         contents = self.__getFileContents(&quot;dries/pydar2/install-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;pydar2/install.html&quot;, &quot;Installation: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;pydar2/install.html&quot;, &quot;Installation: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
         contents = self.__getFileContents(&quot;dries/pydar2/install-slave-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;pydar2/install-slave.html&quot;, &quot;Installation: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;pydar2/install-slave.html&quot;, &quot;Installation: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
         contents = self.__getFileContents(&quot;dries/pydar2/terminology-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;pydar2/terminology.html&quot;, &quot;Terminology: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;pydar2/terminology.html&quot;, &quot;Terminology: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
         contents = self.__getFileContents(&quot;dries/pydar2/planning-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;pydar2/planning.html&quot;, &quot;Planning: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;pydar2/planning.html&quot;, &quot;Planning: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
         contents = self.__getFileContents(&quot;dries/pydar2/classdiagram-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;pydar2/classdiagram.html&quot;, &quot;Class diagram: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;pydar2/classdiagram.html&quot;, &quot;Class diagram: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
         contents = self.__getFileContents(&quot;dries/pydar2/needed-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;pydar2/needed.html&quot;, &quot;Todo: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;pydar2/needed.html&quot;, &quot;Todo: Pydar2 rpm buildserver: Dries RPM Repository&quot;)
         shutil.copy(&quot;dries/pydar2/classdiagram.png&quot;,self.__siterootdir + &quot;/pydar2/&quot;)
         shutil.copy(&quot;dries/pydar2/classdiagram.xmi&quot;,self.__siterootdir + &quot;/pydar2/&quot;)
             
     def clientConfigPage(self):
         contents = self.__getFileContents(&quot;dries/clientconfig-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;clientconfig.html&quot;, &quot;Smart, Yum or Apt configuration: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;clientconfig.html&quot;, &quot;Smart, Yum or Apt configuration: Dries RPM Repository&quot;)
             
     def generateIndexPage(self):
         contents = self.__getFileContents(&quot;dries/index-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;index.html&quot;, &quot;Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;index.html&quot;, &quot;Dries RPM Repository&quot;)
         
     def generateGPGKeyPage(self):
         contents = self.__getFileContents(&quot;dries/RPM-GPG-KEY.dries-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;RPM-GPG-KEY.dries.html&quot;, &quot;GPG Key: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;RPM-GPG-KEY.dries.html&quot;, &quot;GPG Key: Dries RPM Repository&quot;)
      
     def setGPGKey(self):
         shutil.copy(&quot;dries/RPM-GPG-KEY.dries.txt&quot;,self.__siterootdir)
         
     def generateMirrorsPage(self):
         contents = self.__getFileContents(&quot;dries/mirrors-part.html&quot;)
-        self.generateFullPage(contents,[],&quot;mirrors.html&quot;, &quot;Mirrors: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;mirrors.html&quot;, &quot;Mirrors: Dries RPM Repository&quot;)
         
     def generateRecentChangesPage(self):
         contents = &quot;&quot;
@@ -446,7 +590,7 @@
         if lastday != &quot;&quot;:
             subcontents = &quot;&lt;h3&gt;&quot; + day + &quot;&lt;/h3&gt;\n&quot; + subcontents
         contents = contents + subcontents
-        self.generateFullPage(contents,[],&quot;recentchanges.html&quot;, &quot;Updated and new rpms: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents,[],&quot;recentchanges.html&quot;, &quot;Updated and new rpms: Dries RPM Repository&quot;)
         
     def generateDistroArchPageRpm(self,distroArch):
         contents = &quot;&quot;
@@ -456,7 +600,7 @@
             if r in self.__rpmNameToSpecSubDirName:
                 linkToPackage = &quot;&amp;nbsp;-&amp;nbsp&lt;a href=\&quot;/rpm/packages/&quot; + self.__rpmNameToSpecSubDirName[r] + &quot;/info.html\&quot;&gt;&quot; + self.__rpmNameToSpecSubDirName[r] + &quot;&lt;/a&gt;&quot;
             contents = contents + &quot;&lt;a href=\&quot;&quot; + distroArch.rpmsUrl + r + &quot;\&quot;&gt;&quot; + r + &quot;&lt;/a&gt;&quot; + linkToPackage + &quot;&lt;br /&gt;&quot;
-        self.generateFullPage(contents, [distroArch.displayName], distroArch.shortName + &quot;-rpms.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents, [distroArch.displayName], distroArch.shortName + &quot;-rpms.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
         # also generate a page in redhat/el4/i386/ for example
         for path in distroArch.additionalPaths:
             # 1 create a .htaccess file which links release.* files in this DIR
@@ -516,7 +660,7 @@
             self.generateDirectoryView(path + &quot;/base&quot;)
             
             contents = &quot;This page now contains links to the rpms on one of the mirrors because the page is generating way too much traffic for this server.&lt;br /&gt;&lt;br /&gt;&quot; + contents
-            self.generateFullPage(contents, [distroArch.displayName], path + &quot;/RPMS.dries/index.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
+            self.DriesgenerateFullPage(contents, [distroArch.displayName], path + &quot;/RPMS.dries/index.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
     
     def createSymbolicLink(self, filename, target):
         (tempdir, fname) = os.path.split(filename)
@@ -565,19 +709,19 @@
             if r in self.__rpmNameToSpecSubDirName:
                 linkToPackage = &quot;&amp;nbsp;-&amp;nbsp&lt;a href=\&quot;/rpm/packages/&quot; + self.__rpmNameToSpecSubDirName[r] + &quot;/info.html\&quot;&gt;&quot; + self.__rpmNameToSpecSubDirName[r] + &quot;&lt;/a&gt;&quot;
             contents = contents + &quot;&lt;a href=\&quot;&quot; + url + r + &quot;\&quot;&gt;&quot; + r + &quot;&lt;/a&gt;&quot; + linkToPackage + &quot;&lt;br /&gt;&quot;
-        self.generateFullPage(contents, [distroArch.displayName], distroArch.shortName + &quot;-srpms.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents, [distroArch.displayName], distroArch.shortName + &quot;-srpms.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
         for path in distroArch.additionalPaths:
             contents = &quot;This page now contains links to the source rpms on one of the mirrors because the page is generating way too much traffic for this server.&lt;br /&gt;&lt;br /&gt;&quot; + contents
-            self.generateFullPage(contents, [distroArch.displayName], path + &quot;/SRPMS.dries/index.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
+            self.DriesgenerateFullPage(contents, [distroArch.displayName], path + &quot;/SRPMS.dries/index.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
             
     def generatePackagesPage(self):
         contents = &quot;&quot;
         for i in self.__specRepo.getSpecRepositorySpecFiles():
             contents = contents + &quot;&lt;a href=\&quot;packages/&quot; + i.getSubDir() + &quot;/info.html\&quot;&gt;&quot; + i.getSubDir() + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
         print contents
-        self.generateFullPage(contents, [&quot;Packages&quot;], &quot;packages.html&quot;,&quot;List of rpm packages: Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents, [&quot;Packages&quot;], &quot;packages.html&quot;,&quot;List of rpm packages: Dries RPM Repository&quot;)
         
-    def fillFullContentsTemplate(self):
+    def DriesfillFullContentsTemplate(self):
         self.__fullcontentstemplate = self.__getFileContents(&quot;dries/fullcontentstemplate.txt&quot;)
     
     def RFfillFullContentsTemplate(self):
@@ -595,6 +739,7 @@
         return tmp
         
     def __getMenu(self,levels):
+        self.__timer(&quot;__getMenu&quot;)
         menu = &quot;&quot;
         menu = menu + &quot;&lt;strong&gt;General&lt;/strong&gt;&lt;br /&gt;&quot;
         menu = menu + &quot;&quot;
@@ -617,10 +762,14 @@
         menu = menu + &quot;Buildsystem hosted at &lt;a href=\&quot;<A HREF="http://www.ithomi.com/\">http://www.ithomi.com/\</A>&quot;&gt;ithomi&lt;/a&gt;&lt;br /&gt;&quot;
         menu = menu + &quot;Static site hosted at &lt;a href=\&quot;<A HREF="http://www.ulyssis.org/\">http://www.ulyssis.org/\</A>&quot;&gt;ULYSSIS&lt;/a&gt;&lt;br /&gt;&quot;
         menu = menu + &quot;Primary mirrors hosted at &lt;a href=\&quot;<A HREF="http://www.belnet.be/\">http://www.belnet.be/\</A>&quot;&gt;BELNET&lt;/a&gt;, &lt;a href=\&quot;<A HREF="http://www.hea.net/\">http://www.hea.net/\</A>&quot;&gt;HEAnet&lt;/a&gt;, &lt;a href=\&quot;<A HREF="http://3ti.ericom.be/\">http://3ti.ericom.be/\</A>&quot;&gt;3TI&lt;/a&gt;&lt;br /&gt;&quot;
+        self.__timer(&quot;__getMenu&quot;)
         return menu
         
         
+    alreadyCreatedDirs = []
+        
     def RFgenerateFullPage(self,contents,levels,filename, title):
+        self.__timer(&quot;RFGenerateFullPage&quot;)
         if self.__RFfullcontentstemplate == None:
             self.RFfillFullContentsTemplate()
         full = self.__RFfullcontentstemplate
@@ -630,20 +779,23 @@
         (tempdir, fname) = os.path.split(filename)
         dir = os.path.join(self.__RFsiterootdir, tempdir)
         #print dir
-        errors = 0
-        try:
-            os.makedirs(dir)
-        except:
-            errors = errors + 1
+        if dir not in SiteObject.alreadyCreatedDirs:
+            try:
+                os.makedirs(dir)
+                SiteObject.alreadyCreatedDirs.append(dir)
+            except:
+                errors = 1
         f = open(os.path.join(dir,fname), &quot;w&quot;)
         f.write(full)
         f.close()
+        self.__timer(&quot;RFGenerateFullPage&quot;)
         
         
-    def generateFullPage(self, contents, levels, filename, title):
-        if self.__fullcontentstemplate == None:
-            self.fillFullContentsTemplate()
-        full = self.__fullcontentstemplate
+    def DriesgenerateFullPage(self, contents, levels, filename, title):
+        self.__timer(&quot;DriesgenerateFullPage&quot;)
+        if self.__Driesfullcontentstemplate == None:
+            self.DriesfillFullContentsTemplate()
+        full = self.__Driesfullcontentstemplate
         full = string.replace(full,&quot;CONTENTS&quot;,contents)
         full = string.replace(full,&quot;PAGETITLE&quot;, title)
         full = string.replace(full,&quot;TITLEAREA&quot;, &quot;&lt;h1&gt;&quot; + title + &quot;&lt;/h1&gt;&quot;)
@@ -656,33 +808,33 @@
         (tempdir, fname) = os.path.split(filename)
         dir = os.path.join(self.__siterootdir, tempdir)
         #print dir
-        errors = 0
-        try:
-            os.makedirs(dir)
-        except:
-            errors = errors + 1
+        if dir not in SiteObject.alreadyCreatedDirs:
+            if os.path.exists(dir):
+                SiteObject.alreadyCreatedDirs.append(dir)
+            try:
+                os.makedirs(dir)
+                SiteObject.alreadyCreatedDirs.append(dir)
+            except:
+                errors =  1
         f = open(os.path.join(dir,fname), &quot;w&quot;)
         f.write(full)
         f.close()
-
+        self.__timer(&quot;DriesgenerateFullPage&quot;)
     #### start of rpmforge track pages
         
         
-    def RFgenerateSpecPages(self, specRepoSpecFile):
-        shortName = specRepoSpecFile.getSubDir()
-        versions = self.__storage.getVersionIdsOfSpecRepoSpecFile(specRepoSpecFile)
-        arr = self.__storage.getTagsOfSpecFileVersion(versions[0])
-        self.RFgenerateUserPackagePage(specRepoSpecFile, arr)
-        self.RFgenerateDeveloperPackagePage(specRepoSpecFile, arr)
-        self.RFgeneratePackagerPackagePage(specRepoSpecFile)
         
+    def RFgroupTagToPageName(self,groupTag):
+        urlpart = groupTag.replace('/','-').replace(' ','').lower()
+        return &quot;group-&quot; + urlpart + &quot;.php&quot;
+        
     def RFgeneratePackagesPages(self):
         # 1 pagina met daarop:
         #  - de lijst van groepen
         #  - de lijst van beginletters
         # 1 pagina per beginletter
         # 1 pagina per groep
-
+        self.__timer(&quot;RFgeneratePackagesPages&quot;)
         groupcount = {}
         grouppages = {}
         letterpages = {}
@@ -692,9 +844,9 @@
             name = specHash['name']
             summary = specHash['summary']
             group = specHash['group']
-            print &quot;name: &quot; + str(name)
+            #print &quot;name: &quot; + str(name)
             beginletter = name[0].capitalize()
-            print &quot;name: &quot;+ name + &quot;,beginletter:&quot;+ beginletter + &quot;,group:&quot;+ group
+            #print &quot;name: &quot;+ name + &quot;,beginletter:&quot;+ beginletter + &quot;,group:&quot;+ group
         
             currentgroupcontents = &quot;&quot;
             if group in grouppages.keys():
@@ -722,9 +874,8 @@
         keys = grouppages.keys()
         keys.sort()
         for key in keys:
-            urlpart = key.replace('/','-').replace(' ','').lower()
-            contents = contents + &quot;&lt;a href=\&quot;group-&quot; + urlpart + &quot;.php\&quot;&gt;&quot; + key + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
-            self.RFgenerateFullPage(grouppages[key],[&quot;Packages&quot;,&quot;User track: list of packages&quot;], &quot;user/packages/group-&quot; + urlpart + &quot;.php&quot;,key + &quot; RPM packages for Red Hat / Fedora / Aurora&quot;)
+            contents = contents + &quot;&lt;a href=\&quot;&quot; + self.RFgroupTagToPageName(key) + &quot;\&quot;&gt;&quot; + key + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
+            self.RFgenerateFullPage(grouppages[key],[&quot;Packages&quot;,&quot;User track: list of packages&quot;], &quot;user/packages/&quot; + self.RFgroupTagToPageName(key),key + &quot; RPM packages for Red Hat / Fedora / Aurora&quot;)
             groupcnt = groupcnt + 1
                        
         contents = contents + &quot;&lt;h2&gt;Packages sorted by first letter&lt;/h2&gt;&quot;
@@ -739,46 +890,48 @@
         contents = contents + &quot;&lt;br /&gt;&quot;
                             
         self.RFgenerateFullPage(contents,[&quot;Packages&quot;,&quot;User track: list of packages&quot;], &quot;user/packages/index.php&quot;,&quot;RPM packages for Red Hat / Fedora / Aurora&quot;)
-            
+        self.__timer(&quot;RFgeneratePackagesPages&quot;)    
         
-    def RFgenerateUserPackagePage(self, specRepoSpecFile, distNameValueArr):
+    def RFgenerateUserPackagePage(self, specRepoSpecFile, distNameValueHash):
         shortName = specRepoSpecFile.getSubDir()
         contents = &quot;&quot;
         #contents = contents + &quot;&lt;a href=\&quot;/developer/packages/&quot; + shortName + &quot;/\&quot;&gt;developer page of &quot; + shortName + &quot;&lt;/a&gt; | &quot;
         #contents = contents + &quot;&lt;a href=\&quot;/packager/packages/&quot; + shortName + &quot;/\&quot;&gt;packager page of &quot; + shortName + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
-        
-        name = &quot;&quot;
-        summary = &quot;&quot;
-        group = &quot;&quot;
-        url = &quot;&quot;
-        description = &quot;&quot;
-        version = &quot;&quot;
-        release = &quot;&quot;
-        epoch = &quot;&quot;
-        authority = &quot;&quot;
-        license = &quot;&quot;
-        screenshot = &quot;&quot;
-        for h in distNameValueArr:
-            if h['name'] == &quot;NAME&quot;:
-                name = h['value']
-            if h['name'] == &quot;SUMMARY&quot;:
-                summary = h['value']
-            if h['name'] == &quot;GROUP&quot;:
-                group = h['value']
-            if h['name'] == &quot;URL&quot;:
-                url = h['value']
-            if h['name'] == &quot;DESCRIPTION&quot;:
-                description = h['value']
-            if h['name'] == &quot;VERSION&quot;:
-                version = h['value']
-            if h['name'] == &quot;RELEASE&quot;:
-                release = h['value']
-            if h['name'] == &quot;# Authority&quot;:
-                authority = h['value']
-            if h['name'] == &quot;LICENSE&quot;:
-                license = h['value']
-            if h['name'] == &quot;# Screenshot&quot;:
-                screenshot = h['value']
+        myTempHash = distNameValueHash[defaultQueryDistroArch]
+        if 'NAME' not in myTempHash.keys():
+            print &quot;NO name in for spec &quot; + specRepoSpecFile.getSubDir()
+            return
+        name = myTempHash['NAME']
+        summary = myTempHash['SUMMARY']
+        group = myTempHash['GROUP']
+        url = myTempHash['URL']
+        description = myTempHash['DESCRIPTION']
+        version = myTempHash['VERSION']
+        release = myTempHash['RELEASE']
+        authority = myTempHash['# Authority']
+        license = myTempHash['LICENSE']
+        screenshot = myTempHash['# Screenshot']
+        #for h in distNameValueArr:
+        #    if h['name'] == &quot;NAME&quot;:
+        #        name = h['value']
+        #    if h['name'] == &quot;SUMMARY&quot;:
+        #        summary = h['value']
+        #    if h['name'] == &quot;GROUP&quot;:
+        #        group = h['value']
+        #    if h['name'] == &quot;URL&quot;:
+        #        url = h['value']
+        #    if h['name'] == &quot;DESCRIPTION&quot;:
+        #        description = h['value']
+        #    if h['name'] == &quot;VERSION&quot;:
+        #        version = h['value']
+        #    if h['name'] == &quot;RELEASE&quot;:
+        #        release = h['value']
+        #    if h['name'] == &quot;# Authority&quot;:
+        #        authority = h['value']
+        #    if h['name'] == &quot;LICENSE&quot;:
+        #        license = h['value']
+        #    if h['name'] == &quot;# Screenshot&quot;:
+        #        screenshot = h['value']
         contents = contents + &quot;&lt;b&gt;&quot; + summary + &quot;&lt;/b&gt;&lt;br /&gt;&quot;
         contents = contents + &quot;&lt;pre&gt;&quot; + description.strip() + &quot;&lt;/pre&gt;&lt;br /&gt;&quot;
         contents = contents + &quot;&lt;small&gt;&quot;
@@ -786,7 +939,7 @@
         contents = contents + &quot;&lt;b&gt;Latest release:&lt;/b&gt; &quot; + version + &quot;-&quot; + release + &quot;&lt;br /&gt;&lt;br /&gt;&quot;
         contents = contents + &quot;&lt;b&gt;Website:&lt;/b&gt; &lt;a href=\&quot;&quot; +  url + &quot;\&quot;&gt;&quot; + url + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
         contents = contents + &quot;&lt;b&gt;License:&lt;/b&gt; &quot; + license + &quot;&lt;br /&gt;&quot;
-        contents = contents + &quot;&lt;b&gt;Group:&lt;/b&gt; &quot; + group + &quot;&lt;br /&gt;&quot;
+        contents = contents + &quot;&lt;b&gt;Group:&lt;/b&gt; &lt;a href=\&quot;/user/packages/&quot; + self.RFgroupTagToPageName(group) + &quot;\&quot;&gt;&quot; + group + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
         contents = contents + &quot;&lt;b&gt;Maintainer:&lt;/b&gt; &lt;a href=\&quot;/packager/persona/&quot; + authority + &quot;/\&quot;&gt;&quot; + authority + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
         
         if screenshot != &quot;&quot;:
@@ -812,46 +965,27 @@
             
         self.RFgenerateFullPage(contents,[&quot;Packages&quot;,&quot;User track: &quot; + shortName], &quot;user/packages/&quot; + shortName + &quot;/index.php&quot;, shortName + &quot; RPM package for Red Hat / Fedora / Aurora&quot;)
         
-    def RFgenerateDeveloperPackagePage(self, specRepoSpecFile,distNameValueArr):
+    def RFgenerateDeveloperPackagePage(self, specRepoSpecFile,distNameValueHash):
         shortName = specRepoSpecFile.getSubDir()
         contents = &quot;&quot;
         contents = contents + &quot;&lt;a href=\&quot;/user/packages/&quot; + shortName + &quot;/\&quot;&gt;user page of &quot; + shortName + &quot;&lt;/a&gt; | &quot;
         contents = contents + &quot;&lt;a href=\&quot;/packager/packages/&quot; + shortName + &quot;/\&quot;&gt;packager page of &quot; + shortName + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
         
-        name = &quot;&quot;
-        summary = &quot;&quot;
-        group = &quot;&quot;
-        url = &quot;&quot;
-        description = &quot;&quot;
-        version = &quot;&quot;
-        release = &quot;&quot;
-        epoch = &quot;&quot;
-        authority = &quot;&quot;
-        license = &quot;&quot;
-        screenshot = &quot;&quot;
-        for h in distNameValueArr:
-            if h['name'] == &quot;NAME&quot;:
-                name = h['value']
-            if h['name'] == &quot;SUMMARY&quot;:
-                summary = h['value']
-            if h['name'] == &quot;GROUP&quot;:
-                group = h['value']
-            if h['name'] == &quot;URL&quot;:
-                url = h['value']
-            if h['name'] == &quot;DESCRIPTION&quot;:
-                description = h['value']
-            if h['name'] == &quot;VERSION&quot;:
-                version = h['value']
-            if h['name'] == &quot;RELEASE&quot;:
-                release = h['value']
-            if h['name'] == &quot;EPOCH&quot;:
-                epoch = h['value']
-            if h['name'] == &quot;# Authority&quot;:
-                authority = h['value']
-            if h['name'] == &quot;LICENSE&quot;:
-                license = h['value']
-            if h['name'] == &quot;# Screenshot&quot;:
-                screenshot = h['value']
+        myTempHash = distNameValueHash[defaultQueryDistroArch]
+        if 'NAME' not in myTempHash.keys():
+            print &quot;NO name in for spec &quot; + specRepoSpecFile.getSubDir()
+            return
+        name = myTempHash['NAME']
+        summary = myTempHash['SUMMARY']
+        group = myTempHash['GROUP']
+        url = myTempHash['URL']
+        description = myTempHash['DESCRIPTION']
+        version = myTempHash['VERSION']
+        release = myTempHash['RELEASE']
+        authority = myTempHash['# Authority']
+        license = myTempHash['LICENSE']
+        screenshot = myTempHash['# Screenshot']
+        epoch = myTempHash['EPOCH']
             
         contents = contents + &quot;Name: &quot; + name + &quot;&lt;br /&gt;&quot;
         contents = contents + &quot;Summary: &quot; + summary + &quot;&lt;br /&gt;&quot;
@@ -920,7 +1054,7 @@
             contents = contents + &quot;&lt;tr&gt;&lt;td&gt;&quot; + latesttag + &quot;&lt;/td&gt;&quot;
             contents = contents + &quot;&lt;td&gt;&quot; + latestvalue + &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;
         contents = contents + &quot;&lt;/table&gt;&quot;
-        self.generateFullPage(contents,[&quot;Packages&quot;, shortName, &quot;Version &quot; + str(versionId) + &quot; of &quot; + shortName], &quot;packages/&quot; + shortName + &quot;/&quot; + shortName + &quot;-version-&quot; + str(versionId) + &quot;.html&quot;, shortName + &quot; spec file, version &quot; + str(versionId))
+        self.DriesgenerateFullPage(contents,[&quot;Packages&quot;, shortName, &quot;Version &quot; + str(versionId) + &quot; of &quot; + shortName], &quot;packages/&quot; + shortName + &quot;/&quot; + shortName + &quot;-version-&quot; + str(versionId) + &quot;.html&quot;, shortName + &quot; spec file, version &quot; + str(versionId))
         
         
     def generateOnePackagePageSpecPage(self,specRepoSpecFile):
@@ -931,7 +1065,7 @@
         contents = contents + &quot;&lt;pre&gt;&quot;
         contents = contents + self.__getFileContents(specRepoSpecFile.getFullPath())
         contents = contents + &quot;&lt;/pre&gt;&quot;
-        self.generateFullPage(contents, [&quot;Packages&quot;,shortName, shortName + &quot; spec file&quot;], &quot;packages/&quot; + shortName  + &quot;/&quot; + shortName + &quot;-spec.html&quot;, shortName + &quot; spec file : Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents, [&quot;Packages&quot;,shortName, shortName + &quot; spec file&quot;], &quot;packages/&quot; + shortName  + &quot;/&quot; + shortName + &quot;-spec.html&quot;, shortName + &quot; spec file : Dries RPM Repository&quot;)
         htcontents = &quot;RewriteEngine on\n&quot; + 'RewriteRule ^.*spec$ ' + shortName + &quot;-spec.html&quot; + &quot;\n&quot;
         self.createFile(&quot;packages/&quot; + shortName  + &quot;/.htaccess&quot;, htcontents)
         
@@ -1049,7 +1183,7 @@
         contents = contents + &quot;&lt;h2&gt;Versions in pydar2:&lt;/h2&gt;&quot;
         for versionId in versions:
             contents = contents  + &quot;&lt;a href=\&quot;&quot; + shortName + &quot;-version-&quot; + str(versionId) + &quot;.html\&quot;&gt;version &quot; + str(versionId) + &quot; of &quot; + shortName + &quot;&lt;/a&gt;&lt;br /&gt;&quot;
-        self.generateFullPage(contents, [&quot;Packages&quot;,shortName + &quot; RPM&quot;], &quot;packages/&quot; + shortName  + &quot;/info.html&quot;, shortName + &quot; RPM : Dries RPM Repository&quot;)
+        self.DriesgenerateFullPage(contents, [&quot;Packages&quot;,shortName + &quot; RPM&quot;], &quot;packages/&quot; + shortName  + &quot;/info.html&quot;, shortName + &quot; RPM : Dries RPM Repository&quot;)
         
 class TmpOptions:
     def __init__(self):
@@ -1059,4 +1193,4 @@
 c.specifyGetOptOptions(TmpOptions())
 c.getSpecRepositoryList().updateAllFileLists()
 r = c.getSpecRepositoryList().getSpecRepositoryByName(&quot;rpmforge&quot;)
-RpmforgeSite(r,False)
+RpmforgeSite(r,True,False,True)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002331.html">[svn] r3530 - in trunk/web/rpmforge.net: . developer dweb packager	packager/distributions packager/persona packager/persona/bert	packager/persona/dag packager/persona/dries	packager/persona/matthias user user/community user/faq
</A></li>
	<LI>Next message: <A HREF="002333.html">[svn] r3532 - trunk/rpms/gstreamer-python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2332">[ date ]</a>
              <a href="thread.html#2332">[ thread ]</a>
              <a href="subject.html#2332">[ subject ]</a>
              <a href="author.html#2332">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
