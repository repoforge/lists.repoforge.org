<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r9026 - in /branches/rpms/dag: ./ kmod-drbd-src/ kmod-fuse-src/ kmod-kqemu-src/ kmod-lin_tape-src/ kmod-ndiswrapper-src/ kmod-ocfs2-src/
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r9026%20-%20in%20/branches/rpms/dag%3A%20./%20kmod-drbd-src/%0A%20kmod-fuse-src/%0A%20kmod-kqemu-src/%20kmod-lin_tape-src/%20kmod-ndiswrapper-src/%20kmod-ocfs2-src/&In-Reply-To=%3C201008021220.o72CKksK024362%40surya.karan.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007819.html">
   <LINK REL="Next"  HREF="007821.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r9026 - in /branches/rpms/dag: ./ kmod-drbd-src/ kmod-fuse-src/ kmod-kqemu-src/ kmod-lin_tape-src/ kmod-ndiswrapper-src/ kmod-ocfs2-src/</H1>
    <B>Dag Wieers</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r9026%20-%20in%20/branches/rpms/dag%3A%20./%20kmod-drbd-src/%0A%20kmod-fuse-src/%0A%20kmod-kqemu-src/%20kmod-lin_tape-src/%20kmod-ndiswrapper-src/%20kmod-ocfs2-src/&In-Reply-To=%3C201008021220.o72CKksK024362%40surya.karan.org%3E"
       TITLE="[svn] r9026 - in /branches/rpms/dag: ./ kmod-drbd-src/ kmod-fuse-src/ kmod-kqemu-src/ kmod-lin_tape-src/ kmod-ndiswrapper-src/ kmod-ocfs2-src/">dag at wieers.com
       </A><BR>
    <I>Mon Aug  2 14:20:46 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007819.html">[svn] r9025 - /trunk/rpms/perl-Nagios-Object/perl-Nagios-Object.spec
</A></li>
        <LI>Next message: <A HREF="007821.html">[svn] r9027 - /branches/rpms/dag/kmod-lin_tape-src-1.29.0.tar.gz
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7820">[ date ]</a>
              <a href="thread.html#7820">[ thread ]</a>
              <a href="subject.html#7820">[ subject ]</a>
              <a href="author.html#7820">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dag
Date: Mon Aug  2 13:20:46 2010
New Revision: 9026

URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge?rev=9026&amp;view=rev">http://svn.rpmforge.net/viewvc/rpmforge?rev=9026&amp;view=rev</A>
Log:
Imported kmod packages that are now in ELRepo

Added:
    branches/rpms/dag/kmod-drbd-src/
    branches/rpms/dag/kmod-drbd-src/drbd-km.spec   (with props)
    branches/rpms/dag/kmod-drbd-src/drbd-kmod.centos.spec   (with props)
    branches/rpms/dag/kmod-drbd-src/drbd-kmod.spec.orig
    branches/rpms/dag/kmod-drbd-src/find-requires   (with props)
    branches/rpms/dag/kmod-drbd-src/find-requires.ksyms   (with props)
    branches/rpms/dag/kmod-drbd-src/kmod-drbd-src.spec   (with props)
    branches/rpms/dag/kmod-drbd-src/kmodtool   (with props)
    branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83   (with props)
    branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83.new   (with props)
    branches/rpms/dag/kmod-drbd-src/kmodtool.elrepo   (with props)
    branches/rpms/dag/kmod-drbd-src/template.spec.elrepo
    branches/rpms/dag/kmod-fuse-src/
    branches/rpms/dag/kmod-fuse-src/kmod-fuse-src.spec   (with props)
    branches/rpms/dag/kmod-fuse-src/kmodtool-fuse   (with props)
    branches/rpms/dag/kmod-kqemu-src/
    branches/rpms/dag/kmod-kqemu-src/kmod-kqemu-src.spec   (with props)
    branches/rpms/dag/kmod-kqemu-src/kmodtool-kqemu   (with props)
    branches/rpms/dag/kmod-lin_tape-src/
    branches/rpms/dag/kmod-lin_tape-src-1.29.0.tar.gz   (with props)
    branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec   (with props)
    branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec.old
    branches/rpms/dag/kmod-lin_tape-src/kmodtool-lin_tape
    branches/rpms/dag/kmod-lin_tape-src/lin_tape-98-lin_tape.permissions
    branches/rpms/dag/kmod-lin_tape-src/lin_tape-depmod.conf
    branches/rpms/dag/kmod-ndiswrapper-src/
    branches/rpms/dag/kmod-ndiswrapper-src/kmod-ndiswrapper-src.spec   (with props)
    branches/rpms/dag/kmod-ndiswrapper-src/kmodtool-ndiswrapper   (with props)
    branches/rpms/dag/kmod-ocfs2-src/
    branches/rpms/dag/kmod-ocfs2-src/kmod-ocfs2-src.spec   (with props)
    branches/rpms/dag/kmod-ocfs2-src/kmodtool-ocfs2

Added: branches/rpms/dag/kmod-drbd-src/drbd-km.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/drbd-km.spec?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/drbd-km.spec?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/drbd-km.spec (added)
+++ branches/rpms/dag/kmod-drbd-src/drbd-km.spec Mon Aug  2 13:20:46 2010
@@ -1,0 +1,162 @@
+# &quot;uname -r&quot; output of the kernel to build for, the running one
+# if none was specified with &quot;--define 'kernelversion &lt;uname -r&gt;'&quot;
+# PLEASE: provide both (correctly) or none!!
+%{!?kernelversion: %{expand: %%define kernelversion %(uname -r)}}
+%{!?kdir: %{expand: %%define kdir /lib/modules/%(uname -r)/build}}
+
+# encode - to _ to be able to include that in a package name or release &quot;number&quot;
+%global krelver  %(echo %{kernelversion} | tr -s '-' '_')
+
+Name: @<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">PACKAGE_TARNAME at -km</A>
+Summary: DRBD driver for Linux
+Version: @PACKAGE_VERSION@
+Release: <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">12 at RPM_DIST_TAG</A>@
+Source: <A HREF="http://oss.linbit.com/%{name">http://oss.linbit.com/%{name</A>}/8.3/drbd-%{version}.tar.gz
+License: GPLv2+
+ExclusiveOS: linux
+Group: System Environment/Kernel
+URL: <A HREF="http://www.drbd.org/">http://www.drbd.org/</A>
+BuildRoot: %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
+BuildRequires: gcc, @RPM_BUILDREQ_KM@
+
+%description
+DRBD mirrors a block device over the network to another machine.
+Think of it as networked raid 1. It is a building block for
+setting up high availability (HA) clusters.
+
+# I choose to have the kernelversion as part of the package name!
+# drbd-km is prepended...
+%package %{krelver}
+Summary: Kernel driver for DRBD.
+Group: System Environment/Kernel
+Conflicts: @RPM_CONFLICTS_KM@
+# always require a suitable userland and depmod.
+Requires: drbd-utils = %{version}, /sbin/depmod
+# to be able to override from build scripts which flavor of kernel we are building against.
+Requires: %{expand: %(echo ${DRBD_KMOD_REQUIRES:-kernel})}
+# TODO: break up this generic .spec file into per distribution ones,
+# and use the distribution specific naming and build conventions for kernel modules.
+
+%description %{krelver}
+This module is the kernel-dependent driver for DRBD.  This is split out so
+that multiple kernel driver versions can be installed, one for each
+installed kernel.
+
+%files %{krelver}
+%defattr(-,root,root)
+/lib/modules/%{kernelversion}/
+%doc COPYING
+%doc ChangeLog
+%doc drbd/k-config-%{kernelversion}.gz
+
+%prep
+%setup -q -n drbd-%{version}
+test -d %{kdir}/.
+test &quot;$(KDIR=%{kdir} scripts/get_uts_release.sh)&quot; = %{kernelversion}
+
+%build
+%configure \
+    --without-utils \
+    --with-km \
+    --without-udev \
+    --without-xen \
+    --without-pacemaker \
+    --without-heartbeat \
+    --without-rgmanager \
+    --without-bashcompletion
+echo kernelversion=%{kernelversion}
+echo kversion=%{kversion}
+echo krelver=%{krelver}
+make %{_smp_mflags} module KDIR=%{kdir}
+
+
+%install
+rm -rf %{buildroot}
+make install DESTDIR=%{buildroot}
+cd drbd
+mv .kernel.config.gz k-config-%{kernelversion}.gz
+
+%clean
+rm -rf %{buildroot}
+
+%preun %{krelver}
+lsmod | grep drbd &gt; /dev/null 2&gt;&amp;1
+if [ $? -eq 0 ]; then
+    rmmod drbd
+fi
+
+%post %{krelver}
+# hack for distribution kernel packages,
+# which already contain some (probably outdated) drbd module
+EXTRA_DRBD_KO=/lib/modules/%{kernelversion}/extra/drbd.ko
+if test -e $EXTRA_DRBD_KO; then
+    mv $EXTRA_DRBD_KO $EXTRA_DRBD_KO.orig
+fi
+uname -r | grep BOOT ||
+/sbin/depmod -a -F /boot/System.map-%{kernelversion} %{kernelversion} &gt;/dev/null 2&gt;&amp;1 || true
+
+%postun %{krelver}
+/sbin/depmod -a -F /boot/System.map-%{kernelversion} %{kernelversion} &gt;/dev/null 2&gt;&amp;1 || true
+
+
+%changelog
+* Wed Oct 21 2009 Florian Haas &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">florian at linbit.com</A>&gt; - 8.3.4-12
+- Packaging makeover.
+
+* Thu Oct  6 2009 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.3.4-1
+- New upstream release.
+
+* Thu Oct  5 2009 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.3.3-1
+- New upstream release.
+
+* Fri Jul  3 2009 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.3.2-1
+- New upstream release.
+
+* Fri Mar 27 2009 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.3.1-1
+- New upstream release.
+
+* Thu Dec 18 2008 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.3.0-1
+- New upstream release.
+
+* Thu Nov 12 2008 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.2.7-1
+- New upstream release.
+
+* Fri May 30 2008 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.2.6-1
+- New upstream release.
+
+* Tue Feb 12 2008 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.2.5-1
+- New upstream release.
+
+* Fri Jan 11 2008 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.2.4-1
+- New upstream release.
+
+* Wed Jan  9 2008 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.2.3-1
+- New upstream release.
+
+* Fri Nov  2 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.2.1-1
+- New upstream release.
+
+* Fri Sep 28 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.2.0-1
+- New upstream release.
+
+* Mon Sep  3 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.0.6-1
+- New upstream release.
+
+* Fri Aug  3 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.0.5-1
+- New upstream release.
+
+* Wed Jun 27 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.0.4-1
+- New upstream release.
+
+* Mon May 7 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.0.3-1
+- New upstream release.
+
+* Fri Apr 6 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.0.2-1
+- New upstream release.
+
+* Mon Mar 3 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt; - 8.0.1-1
+- New upstream release.
+
+* Wed Jan 24 2007 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;  - 8.0.0-1
+- New upstream release.
+

Propchange: branches/rpms/dag/kmod-drbd-src/drbd-km.spec
------------------------------------------------------------------------------
    svn:eol-style = native

Propchange: branches/rpms/dag/kmod-drbd-src/drbd-km.spec
------------------------------------------------------------------------------
    svn:keywords = Id Revision

Added: branches/rpms/dag/kmod-drbd-src/drbd-kmod.centos.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/drbd-kmod.centos.spec?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/drbd-kmod.centos.spec?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/drbd-kmod.centos.spec (added)
+++ branches/rpms/dag/kmod-drbd-src/drbd-kmod.centos.spec Mon Aug  2 13:20:46 2010
@@ -1,0 +1,330 @@
+Source10: kmodtool
+Source11: find-requires
+Source12: find-requires.ksyms
+%define   kmodtool bash %{SOURCE10}
+%{!?centos_ver: %define centos_ver %(Z=`rpm -q --whatprovides /etc/redhat-release`;A=`rpm -q --qf '%{V}' $Z`; echo ${A:0:1})}
+
+# if kversion isn't defined on rpm build line, build against current kernel
+%if %{centos_ver} == 4
+%{!?kversion: %define kversion 2.6.9-89.EL}
+%endif
+%if %{centos_ver} == 5
+%{!?kversion: %define kversion 2.6.18-194.el5}
+%endif
+
+# hint: this can he overridden with &quot;--define kversion foo&quot; on the rpmbuild command line, e.g.
+# --define &quot;kversion 2.6.18-8.el5&quot;
+
+%define kmod_name drbd83
+%define short_name drbd
+
+%define kverrel %(%{kmodtool} verrel %{?kversion} 2&gt;/dev/null)
+
+%define upvar &quot;&quot;
+
+%if %{centos_ver} == 4
+%ifarch i686 x86_64 ia64
+%define xenvar xenU
+%define smpvar smp
+%endif
+
+%ifarch i686
+%define paevar hugemem
+%endif
+
+%ifarch x86_64
+%define largesmpvar largesmp
+%endif
+
+%ifarch ppc64 ppc64iseries
+%define kdumpvar kdump
+%endif
+
+%ifarch sparc64 ppc
+%define smpvar smp
+%endif
+
+%{!?kvariants: %define kvariants %{?upvar} %{?smpvar} %{?xenvar} %{?paevar} %{?kdumpvar} %{?largesmpvar}}
+%endif
+
+%if %{centos_ver} == 5
+%ifarch i686 x86_64 ia64
+%define xenvar xen
+%endif
+
+%ifarch i686
+%define paevar PAE
+%endif
+
+%ifarch ppc64 ppc64iseries
+%define kdumpvar kdump
+%endif
+
+%ifarch sparc64 ppc
+%define smpvar smp
+%endif
+
+%{!?kvariants: %define kvariants %{?upvar} %{?smpvar} %{?xenvar} %{?paevar} %{?kdumpvar}}
+%endif
+
+Name: %{kmod_name}-kmod
+Summary: Distributed Redundant Block Device driver for Linux
+Version: 8.3.8
+Release: 1%{?dist}
+Source: %{short_name}-%{version}.tar.gz
+License: GPL
+ExclusiveOS: linux
+Group: System Environment/Kernel
+Provides: %{name}
+URL: <A HREF="http://www.drbd.org/">http://www.drbd.org/</A>
+BuildRoot: %{_tmppath}/%{name}-%{version}-root
+ExclusiveArch: i686 x86_64
+
+# Override find_provides to use a script that provides &quot;kernel(symbol) = hash&quot;.
+# Pass path of the RPM temp dir containing kabideps to find-provides script.
+%global _use_internal_dependency_generator 0
+%define __find_requires %_sourcedir/find-requires %{name}
+
+%description
+Drbd is a distributed replicated block device. It mirrors a
+block device over the network to another machine. Think of it
+as networked raid 1. It is a building block for setting up
+high availability (HA) clusters.
+
+Authors:
+--------
+    Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">philipp.reisner at linbit.com</A>&gt;
+    Lars Ellenberg  &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">lars.ellenberg at linbit.com</A>&gt;
+
+# magic hidden here:
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kverrel} %{kvariants} 2&gt;/dev/null)}
+
+%prep
+%setup -n %{short_name}-%{version} -q -c -T -a 0
+pushd %{short_name}-%{version}
+%configure --without-utils --with-km --without-udev --without-xen \
+           --without-pacemaker --without-heartbeat --without-rgmanager \
+           --without-bashcompletion
+popd
+
+for kvariant in %{kvariants} ; do
+    cp -a %{short_name}-%{version} _kmod_build_$kvariant
+done
+cd %{short_name}-%{version}
+
+%build
+
+[ -n $RPM_BUILD_ROOT -a &quot;$RPM_BUILD_ROOT&quot; != &quot;/&quot; ] &amp;&amp; rm -rf $RPM_BUILD_ROOT
+mkdir -p %{buildroot}
+
+for kvariant in %{kvariants}
+do
+    ksrc=%{_usrsrc}/kernels/%{kverrel}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant
+    make KDIR=&quot;${ksrc}&quot; module
+    popd
+done
+
+%install
+
+for kvariant in %{kvariants}
+do
+    ksrc=%{_usrsrc}/kernels/%{kverrel}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant/drbd
+    make -C &quot;${ksrc}&quot; INSTALL_MOD_PATH=$RPM_BUILD_ROOT INSTALL_MOD_DIR=extra/%{kmod_name} modules_install M=$PWD
+    popd
+    find $RPM_BUILD_ROOT -type f -name \*.ko -exec strip --strip-debug \{\} \;
+done
+
+%clean
+[ -n $RPM_BUILD_ROOT -a &quot;$RPM_BUILD_ROOT&quot; != &quot;/&quot; ] &amp;&amp; rm -rf $RPM_BUILD_ROOT
+
+%changelog
+* Fri Jun 04 2010 Ralph Angenendt &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ralph at centos.org</A>&gt; drbd83-8.3.8-1
+- upgraded to upstream version 8.3.8
+* Thu Mar 18 2010 Ralph Angenendt &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ralph at centos.org</A>&gt;
+- upgraded to upstream version 8.3.7
+* Mon May  4 2009 Ralph Angenendt &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ralph at centos.org</A>&gt;
+- upgraded to upstream version 8.3.1 
+- created drbd83 branch to allow people to stay at 8.0/8.2
+- make spec file work with 4 and 5
+- First release of 8.3.x for CentOS
+ 
+* Thu Oct  2 2008 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- modified to work with CentOS-5 weak updates
+
+* Mon Jun  2 2008 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to upstream version 8.2.6
+
+* Tue Feb 26 2008 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to upstream version 8.2.5
+
+* Thu Feb  7 2008 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to version 8.2.4 and built drbd82
+
+* Sun Oct 10 2007 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to upstream version 8.0.6
+
+* Thu Jul 26 2007 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to upstream version 8.0.4
+
+* Thu May 10 2007 04:30:00 +0600 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- modified to roll in kmod building, this is the package to build modules only. 
+
+* Mon May 7 2007 17:10:14 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0.3-1)
+ * Fixed a race condition that could cause us to continue to traverse a bio
+   after it was freed. (led to an OOPS)
+ * Fixed a race condition that could cause us to use members of an ee, after
+   it was freed. (led to various weirdness)
+ * Language fixes for the man pages.
+ * The drbdsetup commands (events, wait-connect,...) release the lock now.
+ * Minor fixes and updates to the user land tools and to the peer outdater.
+
+* Fri Apr 6 2007 21:32:39 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0.2-1)
+ * Removed a bug that could cause an OOPS in drbd_al_to_on_disk_bm()
+ * Improved the robustness of the UUID based algorithm that decides
+   about the resync direction.
+ * Fixed the error handling in case a the open() of a backing
+   blockdevice fails.
+ * Fixed a race condition that could cause a &quot;drbdadm disconnect&quot; to hang.
+ * More verbosity in we can not claim a backing block device.
+ * More verbosity and paranoia in the bitmap area.
+ * On some vendor kernels 8.0.1 did not load because of kzalloc. fixed.
+ * Fault injection can now not only be turned on or off, but can be 
+   enabled on a per device basis.
+ * Fixed the scripts and files needed to build drbd into a kernel.
+
+* Mon Mar 3 2007 10:10:26 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0.1-1)
+ * Fixed some race conditions that could trigger an OOPS when the loca disk
+   failes and DRBD detaches itself from the failing disk.
+ * Added a missing call to drbd_try_outdate_peer().
+ * LVM's LVs expose ambiguous queue settings. When a RAID-0 (md) PV is
+   used the present a segment size of 64k but at the same time allow only
+   8 sectors. Fixed DRBD to deal with that fact corretly.
+ * New option &quot;always-asbp&quot; to also use the after-after-split-brain-policy
+   handlers, even it is not possible to determine from the UUIDs that
+   the data of the two nodes was related in the past.
+ * More verbosity in case a bio_add_page() fails.
+ * Replaced kmalloc()/memset() with kzmalloc(), and a wrapper for older kernls
+ * A fast version of drbd_al_to_on_disk_bm(). This is necessary for short
+   (even sub-second) switchover times while having large &quot;al-extents&quot; settings.
+ * Fixed drbdadm's array overflows (of on stack objects)
+ * drbdsetup can now dump its usage in a XML format
+ * New init script for gentoo
+ * Fixed Typos in the usage of /proc/sysrq-trigger in the example config.
+
+* Wed Jan 24 2007 16:10:09 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0.0-1)
+ * No effecitve changes to rc2.
+
+* Wed Jan 17 2007 17:30:23 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0rc2-1)
+ * Added the well known automagiacally adjust drbd_config.h to
+   make drbd compile on every by vendor's backports defaced 
+   kernel. ( Linux-2.6.x only of course )
+ * Fixed races with starting and finishing resync processes 
+   while heavy application IO is going on.
+ * Ported DRBD to the new crypto API (and added a emulation of the
+   now API on top of the old one for older 2.6.x kernels)
+ * Code to perform better on ethernet networks with jumbo
+   frames.
+ * Bugfixes to our request code (race conditions).
+ * Every error code that is returned by drbdsetup has a 
+   textual description by now.
+
+* Fri Dec 22 2006 15:19:10 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0rc1-1)
+ * The drbd-peer-outdater got updated to work in multi node heartbeat
+   clusters. (But we still not suceeded to get this into Heartbeat's
+   repository accepted.)
+ * Fixed resync decission after a crash in a pri-pri cluster.
+ * Implemented the ping-timeout option for &quot;sub-second&quot; failover clusters.
+ * Implemented all the &quot;violently&quot; options in the reconnect handling.
+ * Updated man pages of drbd.conf and drbdsetup.
+ * Removed the &quot;self-claiming&quot; on secondary nodes.
+ * Fixed an uncountable number of bugs.
+
+* Fri Nov  3 2006 15:20:54 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0pre6-1)
+ * All panic() calls where removed from DRBD.
+ * IO errors while accessing the backing storage device are now handled
+   correct.
+ * Conflict detection for two primaries is in place and tested.
+ * More tracing stuff
+ * Lots of bugs found and fixed
+
+* Sun Oct 31 2006 22:03:54 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0pre5-1)
+ * The request code was completely rewritten.
+ * The write conflict detection code for primary-primary is currently
+   broken, but will be fixed soon.
+ * drbdsetup is no longer based on IOCTL but works now via
+   netlink/connector.
+ * drbd_panic() is on its way out.
+ * A runtime configurable tracing framework got added.
+ * A lot of effort was put into finding and fixing bugs.
+
+* Mon Jul 31 2006 12:04:41 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0pre4-1)
+ * Added the &quot;drbd-peer-outdater&quot; heartbeat plugin.
+ * New (&quot;cluster wide&quot;) state changes. (Cluster wide serialisation of
+   major state changes, like becomming primary, invalidateing a disk etc...)
+ * Write requests are now sent by the worker instead out of the process's
+   context that calls make_request().
+ * The worker thread no longer gets restarted upon loss of connection.
+ * A testsuite developed by students of 'FH Hagenberg' was added.
+
+* Tue Apr 20 2006 13:46:18 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0pre3-1)
+ * Now it works on device mapper (LVM) as well as on &quot;real&quot; block devices.
+ * Finally (after years) a sane &quot;drbdadm adjust&quot; imprementation, which is
+   really really robust.
+ * Fixes for 64bit kernel / 32 bit userland environments
+ * Fixes in the sys-v init script
+ * Renamed &quot;--do-what-I-say&quot; to &quot;--overwrite-data-of-peer&quot;. Hopefully
+   people now understand what this option does.
+
+* Tue Apr  6 2006 17:53:56 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0-pre2-1)
+ * removed the &quot;on-disconnect&quot; and &quot;split-brain-fix&quot; config options and
+   added the &quot;fencing&quot; config option instead.
+ * Updated all manpages to cover drbd-8.0
+ * /proc/drbd shows the whole drbd_state_t, as well the logging of state
+   changes shows every field of drbd_state_t now.
+ * Deactivated most of the TCQ code for now, since it changed again
+   in the mainline kernel.
+ * Minor other fixes.
+
+* Tue Mar 14 2006 11:37:56 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0_pre1-1)
+ * Removed support for Linux-2.4.x
+ * Cleanup of the wire protocol.
+ * Added optional peer authentication with a shared secret.
+ * Consolidated state changes into a central function.
+ * Improved, tunable after-split-brain recovery strategies.
+ * Always verify all IDs used in the protocol that are used as pointers.
+ * Introduced the &quot;outdate&quot; disk state, and commands for managing it.
+ * Introduced the &quot;drbdmeta&quot; command, and require the user to create
+   meta-data explicitly.
+ * Support for primary/primary (for OCFS2, GFS...)
+ * Replaced the sync-groups with the sync-after mechanism.
+ * The &quot;common&quot; section in the configuration file.
+ * Replaced the generation counters (GCs) with data-generation-UUIDs
+ * Improved performance by using Linux-2.6's BIOs with up to 32k per
+   IO request. Before we transferred only up to 4k per IO request.
+ * A Warning if the disk sizes are more than 10% different.
+ * A connection teardown packet to differentiate between a crash
+   of the peer and a peer that is shut down gracefully.
+ * External imposable SyncPause states, to serialize DRBD's resynchronisation
+   with the resynchronisation of backing storage's RAID configurations.
+ * Backing storage can be hot added to disk less nodes.
+ * Prepared for advanced integration to Heartbeat-2.0
+ * Changed internal APIs so that missed writes of the meta-data super
+   block are reported as they happen.
+ * The <A HREF="http://usage.drbd.org">http://usage.drbd.org</A> sub project.
+ * Rewrote the scanner/parser of drbd.conf. 10 times smaller/faster and
+   easier to maintain.
+ * Asynchronous meta-data IO [ Code drop from the DRBD+ branch ]

Propchange: branches/rpms/dag/kmod-drbd-src/drbd-kmod.centos.spec
------------------------------------------------------------------------------
    svn:eol-style = native

Propchange: branches/rpms/dag/kmod-drbd-src/drbd-kmod.centos.spec
------------------------------------------------------------------------------
    svn:keywords = Id Revision

Added: branches/rpms/dag/kmod-drbd-src/drbd-kmod.spec.orig
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/drbd-kmod.spec.orig?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/drbd-kmod.spec.orig?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/drbd-kmod.spec.orig (added)
+++ branches/rpms/dag/kmod-drbd-src/drbd-kmod.spec.orig Mon Aug  2 13:20:46 2010
@@ -1,0 +1,332 @@
+Source10: kmodtool
+Source11: find-requires
+Source12: find-requires.ksyms
+%define   kmodtool bash %{SOURCE10}
+%{!?centos_ver: %define centos_ver %(Z=`rpm -q --whatprovides /etc/redhat-release`;A=`rpm -q --qf '%{V}' $Z`; echo ${A:0:1})}
+
+# if kversion isn't defined on rpm build line, build against current kernel
+%if %{centos_ver} == 4
+%{!?kversion: %define kversion 2.6.9-89.0.9.EL}
+%endif
+%if %{centos_ver} == 5
+%{!?kversion: %define kversion 2.6.18-128.7.1.el5}
+%endif
+
+# hint: this can he overridden with &quot;--define kversion foo&quot; on the rpmbuild command line, e.g.
+# --define &quot;kversion 2.6.18-8.el5&quot;
+
+%define kmod_name drbd83
+%define short_name drbd
+
+%define kverrel %(%{kmodtool} verrel %{?kversion} 2&gt;/dev/null)
+
+%define upvar &quot;&quot;
+
+%if %{centos_ver} == 4
+%ifarch i686 x86_64 ia64
+%define xenvar xenU
+%define smpvar smp
+%endif
+
+%ifarch i686
+%define paevar hugemem
+%endif
+
+%ifarch x86_64
+%define largesmpvar largesmp
+%endif
+
+%ifarch ppc64 ppc64iseries
+%define kdumpvar kdump
+%endif
+
+%ifarch sparc64 ppc
+%define smpvar smp
+%endif
+
+%{!?kvariants: %define kvariants %{?upvar} %{?smpvar} %{?xenvar} %{?paevar} %{?kdumpvar} %{?largesmpvar}}
+%endif
+
+%if %{centos_ver} == 5
+%ifarch i686 x86_64 ia64
+%define xenvar xen
+%endif
+
+%ifarch i686
+%define paevar PAE
+%endif
+
+%ifarch ppc64 ppc64iseries
+%define kdumpvar kdump
+%endif
+
+%ifarch sparc64 ppc
+%define smpvar smp
+%endif
+
+%{!?kvariants: %define kvariants %{?upvar} %{?smpvar} %{?xenvar} %{?paevar} %{?kdumpvar}}
+%endif
+
+Name: %{kmod_name}-kmod
+Summary: Distributed Redundant Block Device driver for Linux
+Version: 8.3.2
+Release: 6%{?dist}
+Source: %{short_name}-%{version}.tar.gz
+License: GPL
+ExclusiveOS: linux
+Group: System Environment/Kernel
+Provides: %{name}
+URL: <A HREF="http://www.drbd.org/">http://www.drbd.org/</A>
+BuildRoot: %{_tmppath}/%{name}-%{version}-root
+ExclusiveArch: i686 x86_64 ppc64 sparc64
+
+# Override find_provides to use a script that provides &quot;kernel(symbol) = hash&quot;.
+# Pass path of the RPM temp dir containing kabideps to find-provides script.
+%global _use_internal_dependency_generator 0
+%define __find_requires %_sourcedir/find-requires %{name}
+
+%description
+Drbd is a distributed replicated block device. It mirrors a
+block device over the network to another machine. Think of it
+as networked raid 1. It is a building block for setting up
+high availability (HA) clusters.
+
+Authors:
+--------
+    Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">philipp.reisner at linbit.com</A>&gt;
+    Lars Ellenberg  &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">lars.ellenberg at linbit.com</A>&gt;
+
+# magic hidden here:
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kverrel} %{kvariants} 2&gt;/dev/null)}
+
+%prep
+%setup -n %{short_name}-%{version} -q -c -T -a 0
+
+for kvariant in %{kvariants} ; do
+    cp -a %{short_name}-%{version} _kmod_build_$kvariant
+done
+cd %{short_name}-%{version}
+
+%build
+
+[ -n $RPM_BUILD_ROOT -a &quot;$RPM_BUILD_ROOT&quot; != &quot;/&quot; ] &amp;&amp; rm -rf $RPM_BUILD_ROOT
+mkdir -p %{buildroot}
+
+for kvariant in %{kvariants}
+do
+    ksrc=%{_usrsrc}/kernels/%{kverrel}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant
+    make KDIR=&quot;${ksrc}&quot; module
+    popd
+done
+
+%install
+
+for kvariant in %{kvariants}
+do
+    ksrc=%{_usrsrc}/kernels/%{kverrel}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant/drbd
+    make -C &quot;${ksrc}&quot; INSTALL_MOD_PATH=$RPM_BUILD_ROOT INSTALL_MOD_DIR=extra/%{kmod_name} modules_install M=$PWD
+    popd
+done
+
+#stripping the modules
+find ${RPM_BUILD_ROOT} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+[ -n $RPM_BUILD_ROOT -a &quot;$RPM_BUILD_ROOT&quot; != &quot;/&quot; ] &amp;&amp; rm -rf $RPM_BUILD_ROOT
+
+%changelog
+* Sat Aug 29 2009 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at cetos.org</A>&gt;
+- added support for ppc64 and sparc64
+- updated default kernels to the latest in c4 and c5
+
+* Sat Aug 22 2009 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to version 8.3.2
+- added module stripping with the debug option to match main centos kernel modules
+- changed file permissions of modules to 744 to match main centos kernel modules
+
+* Mon May  4 2009 Ralph Angenendt &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ralph at centos.org</A>&gt;
+- upgraded to upstream version 8.3.1 
+- created drbd83 branch to allow people to stay at 8.0/8.2
+- make spec file work with 4 and 5
+- First release of 8.3.x for CentOS
+ 
+* Thu Oct  2 2008 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- modified to work with CentOS-5 weak updates
+
+* Mon Jun  2 2008 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to upstream version 8.2.6
+
+* Tue Feb 26 2008 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to upstream version 8.2.5
+
+* Thu Feb  7 2008 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to version 8.2.4 and built drbd82
+
+* Sun Oct 10 2007 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to upstream version 8.0.6
+
+* Thu Jul 26 2007 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- upgraded to upstream version 8.0.4
+
+* Thu May 10 2007 04:30:00 +0600 Johnny Hughes &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">johnny at centos.org</A>&gt;
+- modified to roll in kmod building, this is the package to build modules only. 
+
+* Mon May 7 2007 17:10:14 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0.3-1)
+ * Fixed a race condition that could cause us to continue to traverse a bio
+   after it was freed. (led to an OOPS)
+ * Fixed a race condition that could cause us to use members of an ee, after
+   it was freed. (led to various weirdness)
+ * Language fixes for the man pages.
+ * The drbdsetup commands (events, wait-connect,...) release the lock now.
+ * Minor fixes and updates to the user land tools and to the peer outdater.
+
+* Fri Apr 6 2007 21:32:39 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0.2-1)
+ * Removed a bug that could cause an OOPS in drbd_al_to_on_disk_bm()
+ * Improved the robustness of the UUID based algorithm that decides
+   about the resync direction.
+ * Fixed the error handling in case a the open() of a backing
+   blockdevice fails.
+ * Fixed a race condition that could cause a &quot;drbdadm disconnect&quot; to hang.
+ * More verbosity in we can not claim a backing block device.
+ * More verbosity and paranoia in the bitmap area.
+ * On some vendor kernels 8.0.1 did not load because of kzalloc. fixed.
+ * Fault injection can now not only be turned on or off, but can be 
+   enabled on a per device basis.
+ * Fixed the scripts and files needed to build drbd into a kernel.
+
+* Mon Mar 3 2007 10:10:26 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0.1-1)
+ * Fixed some race conditions that could trigger an OOPS when the loca disk
+   failes and DRBD detaches itself from the failing disk.
+ * Added a missing call to drbd_try_outdate_peer().
+ * LVM's LVs expose ambiguous queue settings. When a RAID-0 (md) PV is
+   used the present a segment size of 64k but at the same time allow only
+   8 sectors. Fixed DRBD to deal with that fact corretly.
+ * New option &quot;always-asbp&quot; to also use the after-after-split-brain-policy
+   handlers, even it is not possible to determine from the UUIDs that
+   the data of the two nodes was related in the past.
+ * More verbosity in case a bio_add_page() fails.
+ * Replaced kmalloc()/memset() with kzmalloc(), and a wrapper for older kernls
+ * A fast version of drbd_al_to_on_disk_bm(). This is necessary for short
+   (even sub-second) switchover times while having large &quot;al-extents&quot; settings.
+ * Fixed drbdadm's array overflows (of on stack objects)
+ * drbdsetup can now dump its usage in a XML format
+ * New init script for gentoo
+ * Fixed Typos in the usage of /proc/sysrq-trigger in the example config.
+
+* Wed Jan 24 2007 16:10:09 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0.0-1)
+ * No effecitve changes to rc2.
+
+* Wed Jan 17 2007 17:30:23 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0rc2-1)
+ * Added the well known automagiacally adjust drbd_config.h to
+   make drbd compile on every by vendor's backports defaced 
+   kernel. ( Linux-2.6.x only of course )
+ * Fixed races with starting and finishing resync processes 
+   while heavy application IO is going on.
+ * Ported DRBD to the new crypto API (and added a emulation of the
+   now API on top of the old one for older 2.6.x kernels)
+ * Code to perform better on ethernet networks with jumbo
+   frames.
+ * Bugfixes to our request code (race conditions).
+ * Every error code that is returned by drbdsetup has a 
+   textual description by now.
+
+* Fri Dec 22 2006 15:19:10 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0rc1-1)
+ * The drbd-peer-outdater got updated to work in multi node heartbeat
+   clusters. (But we still not suceeded to get this into Heartbeat's
+   repository accepted.)
+ * Fixed resync decission after a crash in a pri-pri cluster.
+ * Implemented the ping-timeout option for &quot;sub-second&quot; failover clusters.
+ * Implemented all the &quot;violently&quot; options in the reconnect handling.
+ * Updated man pages of drbd.conf and drbdsetup.
+ * Removed the &quot;self-claiming&quot; on secondary nodes.
+ * Fixed an uncountable number of bugs.
+
+* Fri Nov  3 2006 15:20:54 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0pre6-1)
+ * All panic() calls where removed from DRBD.
+ * IO errors while accessing the backing storage device are now handled
+   correct.
+ * Conflict detection for two primaries is in place and tested.
+ * More tracing stuff
+ * Lots of bugs found and fixed
+
+* Sun Oct 31 2006 22:03:54 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0pre5-1)
+ * The request code was completely rewritten.
+ * The write conflict detection code for primary-primary is currently
+   broken, but will be fixed soon.
+ * drbdsetup is no longer based on IOCTL but works now via
+   netlink/connector.
+ * drbd_panic() is on its way out.
+ * A runtime configurable tracing framework got added.
+ * A lot of effort was put into finding and fixing bugs.
+
+* Mon Jul 31 2006 12:04:41 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0pre4-1)
+ * Added the &quot;drbd-peer-outdater&quot; heartbeat plugin.
+ * New (&quot;cluster wide&quot;) state changes. (Cluster wide serialisation of
+   major state changes, like becomming primary, invalidateing a disk etc...)
+ * Write requests are now sent by the worker instead out of the process's
+   context that calls make_request().
+ * The worker thread no longer gets restarted upon loss of connection.
+ * A testsuite developed by students of 'FH Hagenberg' was added.
+
+* Tue Apr 20 2006 13:46:18 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0pre3-1)
+ * Now it works on device mapper (LVM) as well as on &quot;real&quot; block devices.
+ * Finally (after years) a sane &quot;drbdadm adjust&quot; imprementation, which is
+   really really robust.
+ * Fixes for 64bit kernel / 32 bit userland environments
+ * Fixes in the sys-v init script
+ * Renamed &quot;--do-what-I-say&quot; to &quot;--overwrite-data-of-peer&quot;. Hopefully
+   people now understand what this option does.
+
+* Tue Apr  6 2006 17:53:56 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0-pre2-1)
+ * removed the &quot;on-disconnect&quot; and &quot;split-brain-fix&quot; config options and
+   added the &quot;fencing&quot; config option instead.
+ * Updated all manpages to cover drbd-8.0
+ * /proc/drbd shows the whole drbd_state_t, as well the logging of state
+   changes shows every field of drbd_state_t now.
+ * Deactivated most of the TCQ code for now, since it changed again
+   in the mainline kernel.
+ * Minor other fixes.
+
+* Tue Mar 14 2006 11:37:56 +0200 Philipp Reisner &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at linbit.com</A>&gt;
+- drbd (8.0_pre1-1)
+ * Removed support for Linux-2.4.x
+ * Cleanup of the wire protocol.
+ * Added optional peer authentication with a shared secret.
+ * Consolidated state changes into a central function.
+ * Improved, tunable after-split-brain recovery strategies.
+ * Always verify all IDs used in the protocol that are used as pointers.
+ * Introduced the &quot;outdate&quot; disk state, and commands for managing it.
+ * Introduced the &quot;drbdmeta&quot; command, and require the user to create
+   meta-data explicitly.
+ * Support for primary/primary (for OCFS2, GFS...)
+ * Replaced the sync-groups with the sync-after mechanism.
+ * The &quot;common&quot; section in the configuration file.
+ * Replaced the generation counters (GCs) with data-generation-UUIDs
+ * Improved performance by using Linux-2.6's BIOs with up to 32k per
+   IO request. Before we transferred only up to 4k per IO request.
+ * A Warning if the disk sizes are more than 10% different.
+ * A connection teardown packet to differentiate between a crash
+   of the peer and a peer that is shut down gracefully.
+ * External imposable SyncPause states, to serialize DRBD's resynchronisation
+   with the resynchronisation of backing storage's RAID configurations.
+ * Backing storage can be hot added to disk less nodes.
+ * Prepared for advanced integration to Heartbeat-2.0
+ * Changed internal APIs so that missed writes of the meta-data super
+   block are reported as they happen.
+ * The <A HREF="http://usage.drbd.org">http://usage.drbd.org</A> sub project.
+ * Rewrote the scanner/parser of drbd.conf. 10 times smaller/faster and
+   easier to maintain.
+ * Asynchronous meta-data IO [ Code drop from the DRBD+ branch ]

Added: branches/rpms/dag/kmod-drbd-src/find-requires
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/find-requires?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/find-requires?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/find-requires (added)
+++ branches/rpms/dag/kmod-drbd-src/find-requires Mon Aug  2 13:20:46 2010
@@ -1,0 +1,163 @@
+#!/bin/bash
+
+#
+# Auto-generate requirements for executables (both ELF and a.out) and library
+# sonames, script interpreters, and perl modules.
+#
+
+RPM_SOURCE_DIR=`rpm --eval &quot;%_sourcedir&quot;`
+
+ulimit -c 0
+
+#
+# --- Set needed to 0 for traditional find-requires behavior.
+needed=1
+if [ X&quot;$1&quot; = Xldd ]; then
+    needed=0
+elif [ X&quot;$1&quot; = Xobjdump ]; then
+    needed=1
+fi
+[ -z &quot;$OBJDUMP&quot; ] &amp;&amp; OBJDUMP=objdump
+
+#
+# --- Grab the file manifest and classify files.
+#filelist=`sed &quot;s/['\&quot;]/\\\&amp;/g&quot;`
+filelist=`sed &quot;s/[]['\&quot;*?{}]/\\\\\&amp;/g&quot;`
+exelist=`echo $filelist | xargs -r file | egrep -v &quot;:.* (commands|script) &quot; | \
+	grep &quot;:.*executable&quot; | cut -d: -f1`
+scriptlist=`echo $filelist | xargs -r file | \
+	egrep &quot;:.* (commands|script) &quot; | cut -d: -f1`
+liblist=`echo $filelist | xargs -r file | \
+	grep &quot;:.*shared object&quot; | cut -d : -f1`
+
+interplist=
+perllist=
+pythonlist=
+tcllist=
+
+#
+# --- Alpha does not mark 64bit dependencies
+case `uname -m` in
+  alpha*)	mark64=&quot;&quot; ;;
+  *)		mark64=&quot;()(64bit)&quot; ;;
+esac
+
+if [ &quot;$needed&quot; -eq 0 ]; then
+#
+# --- Executable dependency sonames.
+  for f in $exelist; do
+    [ -r $f -a -x $f ] || continue
+    lib64=`if file -L $f 2&gt;/dev/null | \
+	grep &quot;ELF 64-bit&quot; &gt;/dev/null; then echo &quot;$mark64&quot;; fi`
+    ldd $f | awk '/=&gt;/ {
+	if ($1 !~ /libNoVersion.so/ &amp;&amp; $1 !~ /4[um]lib.so/ &amp;&amp; $1 !~ /libredhat-kernel.so/) {
+	    gsub(/'\''&quot;/,&quot;\\&amp;&quot;,$1);
+	    printf &quot;%s'$lib64'\n&quot;, $1
+	}
+    }'
+  done | xargs -r -n 1 basename | sort -u
+
+#
+# --- Library dependency sonames.
+  for f in $liblist; do
+    [ -r $f ] || continue
+    lib64=`if file -L $f 2&gt;/dev/null | \
+	grep &quot;ELF 64-bit&quot; &gt;/dev/null; then echo &quot;$mark64&quot;; fi`
+    ldd $f | awk '/=&gt;/ {
+	if ($1 !~ /libNoVersion.so/ &amp;&amp; $1 !~ /4[um]lib.so/ &amp;&amp; $1 !~ /libredhat-kernel.so/) {
+	    gsub(/'\''&quot;/,&quot;\\&amp;&quot;,$1);
+	    printf &quot;%s'$lib64'\n&quot;, $1
+	}
+    }'
+  done | xargs -r -n 1 basename | sort -u
+fi
+
+#
+# --- Script interpreters.
+for f in $scriptlist; do
+    [ -r $f -a -x $f ] || continue
+    interp=`head -n 1 $f | sed -e 's/^\#\![ 	]*//' | cut -d&quot; &quot; -f1`
+    interplist=&quot;$interplist $interp&quot;
+    case $interp in
+    */perl)	perllist=&quot;$perllist $f&quot; ;;
+    esac
+done
+[ -n &quot;$interplist&quot; ] &amp;&amp; { echo &quot;$interplist&quot; | tr '[:blank:]' \\n | sort -u ; }
+
+#
+# --- Add perl module files to perllist.
+for f in $filelist; do
+    [ -r $f -a &quot;${f%.pm}&quot; != &quot;${f}&quot; ] &amp;&amp; perllist=&quot;$perllist $f&quot;
+done
+
+#
+# --- Weak symbol versions (from glibc).
+[ -n &quot;$mark64&quot; ] &amp;&amp; mark64=&quot;(64bit)&quot;
+for f in $liblist $exelist ; do
+    [ -r $f ] || continue
+    lib64=`if file -L $f 2&gt;/dev/null | \
+	grep &quot;ELF 64-bit&quot; &gt;/dev/null; then echo &quot;$mark64&quot;; fi`
+    $OBJDUMP -p $f | awk 'BEGIN { START=0; LIBNAME=&quot;&quot;; needed='$needed'; }
+	/^$/ { START=0; }
+	/^Dynamic Section:$/ { START=1; }
+	(START==1) &amp;&amp; /NEEDED/ {
+	    if (needed) {
+		if (&quot;'$lib64'&quot; != &quot;&quot;) {
+		    sub(/$/, &quot;()'$lib64'&quot;, $2) ;
+		}
+		print $2 ;
+	    }
+	}
+	/^Version References:$/ { START=2; }
+	(START==2) &amp;&amp; /required from/ {
+	    sub(/:/, &quot;&quot;, $3);
+	    LIBNAME=$3;
+	}
+	(START==2) &amp;&amp; (LIBNAME!=&quot;&quot;) &amp;&amp; ($4!=&quot;&quot;) {
+	    print LIBNAME &quot;(&quot; $4 &quot;)'$lib64'&quot;;
+	}
+    '
+done | sort -u
+
+#
+# --- Perl modules.
+[ -x /usr/lib/rpm/redhat/perl.req -a -n &quot;$perllist&quot; ] &amp;&amp; \
+    echo $perllist | tr '[:blank:]' \\n | /usr/lib/rpm/redhat/perl.req | sort -u
+
+#
+# --- Python modules.
+[ -x /usr/lib/rpm/redhat/python.req -a -n &quot;$pythonlist&quot; ] &amp;&amp; \
+    echo $pythonlist | tr '[:blank:]' \\n | /usr/lib/rpm/redhat/python.req | sort -u
+
+#
+# --- Tcl modules.
+[ -x /usr/lib/rpm/redhat/tcl.req -a -n &quot;$tcllist&quot; ] &amp;&amp; \
+    echo $tcllist | tr '[:blank:]' \\n | /usr/lib/rpm/redhat/tcl.req | sort -u
+
+#
+# --- Kernel module imported symbols
+#
+# Since we don't (yet) get passed the name of the package being built, we
+# cheat a little here by looking first for a kernel, then for a kmod.
+#
+
+unset is_kmod
+
+for f in $filelist; do
+    if [ $(echo &quot;$f&quot; | sed -r -ne 's:^.*/lib/modules/(.*)/(.*).ko$:\2:p') ]
+    then
+        is_kmod=1;
+    elif [ $(echo &quot;$f&quot; | sed -r -ne 's:^.*/boot/(.*):\1:p') ]
+    then
+	unset is_kmod;
+	break;
+    fi
+done
+
+if [ -x find-requires.ksyms -a &quot;$is_kmod&quot; ]; then
+    printf &quot;%s\n&quot; &quot;${filelist[@]}&quot; | find-requires.ksyms
+elif [ -x /usr/lib/rpm/redhat/find-requires.ksyms -a &quot;$is_kmod&quot; ]; then
+    printf &quot;%s\n&quot; &quot;${filelist[@]}&quot; | /usr/lib/rpm/redhat/find-requires.ksyms
+fi
+
+exit 0

Propchange: branches/rpms/dag/kmod-drbd-src/find-requires
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-drbd-src/find-requires.ksyms
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/find-requires.ksyms?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/find-requires.ksyms?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/find-requires.ksyms (added)
+++ branches/rpms/dag/kmod-drbd-src/find-requires.ksyms Mon Aug  2 13:20:46 2010
@@ -1,0 +1,46 @@
+#! /bin/bash
+
+IFS=$'\n'
+
+all_provides() {
+    nm &quot;$@&quot; \
+    | sed -r -ne 's:^0*([0-9a-f]+) A __crc_(.+):\1\t\2:p' \
+    | sort -k2 -u
+}
+
+all_requires() {
+    for module in &quot;$@&quot;; do
+        set -- $(/sbin/modinfo -F vermagic &quot;$module&quot; | sed -e 's: .*::' -e q)
+        /sbin/modprobe --dump-modversions &quot;$module&quot; \
+        | sed -r -e 's:^0x0*::' -e 's:$:\t'&quot;$1&quot;':'
+    done \
+    | sort -k2 -u
+}
+
+if ! [ -e /sbin/modinfo -a -e /sbin/modprobe ]; then
+    cat &gt; /dev/null
+    exit 0
+fi
+
+modules=($(grep -E '/lib/modules/.+\.ko$'))
+if [ ${#modules[@]} -gt 0 ]; then
+    symset_table=$(mktemp -t ${0##*/}.XXXXX)
+    /usr/lib/rpm/redhat/symset-table | sort &gt; $symset_table
+
+    join -t $'\t' -j 1 -a 2 $symset_table &lt;(
+        # Filter out requirements that we fulfill ourself.
+        join -t $'\t' -j 2 -v 1 \
+            &lt;(all_requires &quot;${modules[@]}&quot;) \
+            &lt;(all_provides &quot;${modules[@]}&quot;) \
+        | awk '
+        BEGIN { FS = &quot;\t&quot; ; OFS = &quot;\t&quot; }
+        { print $3 &quot;/&quot; $2 &quot;/&quot; $1 }
+        ' \
+        | sort -u) \
+    | sort -u \
+    | awk '
+    { FS = &quot;\t&quot; ; OFS = &quot;\t&quot; }
+    NF == 3 { print &quot;kernel(&quot; $2 &quot;) = &quot; $3
+              next }
+    '
+fi

Propchange: branches/rpms/dag/kmod-drbd-src/find-requires.ksyms
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-drbd-src/kmod-drbd-src.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmod-drbd-src.spec?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmod-drbd-src.spec?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/kmod-drbd-src.spec (added)
+++ branches/rpms/dag/kmod-drbd-src/kmod-drbd-src.spec Mon Aug  2 13:20:46 2010
@@ -1,0 +1,104 @@
+# $Id$
+# Authority: dag
+
+# ExclusiveDist: el5
+# Archs: i686 x86_64
+
+# Tag: test
+
+%define kversion 2.6.18-194.3.1.el5
+%{!?kversion:%define kversion %(rpm -q kernel-devel --qf '%{RPMTAG_VERSION}-%{RPMTAG_RELEASE}' | tail -1)}
+
+### Define the kmod package name here.
+%define kmod_name drbd83
+%define short_name drbd
+
+Summary: Distributed Redundant Block Device driver for Linux
+Name: kmod-drbd-src
+Version: 8.3.8
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="http://www.drbd.org/">http://www.drbd.org/</A>
+
+Source0: <A HREF="http://oss.linbit.com/drbd/8.3/drbd-%{version">http://oss.linbit.com/drbd/8.3/drbd-%{version</A>}.tar.gz
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+### We cannot obsolete all Linbit drbd-km-%{kversion} variants
+Conflicts: kmod-drbd &lt; 8.2
+Obsoletes: kmod-drbd82 &lt;= %{version}-%{release}
+
+### Define the variants for each architecture.
+%define basevar &quot;&quot;
+
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+### If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+### Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+Drbd is a distributed replicated block device. It mirrors a
+block device over the network to another machine. Think of it
+as networked raid 1. It is a building block for setting up
+high availability (HA) clusters.
+
+%prep
+%setup -c -T -a 0
+
+%define __find_requires sh %{_builddir}/%{buildsubdir}/filter-requires.sh
+echo &quot;/usr/lib/rpm/redhat/find-requires | sed -e '/^ksym.*/d'&quot; &gt;filter-requires.sh
+
+pushd %{short_name}-%{version}
+%configure \
+    --with-km \
+    --without-bashcompletion \
+    --without-heartbeat \
+    --without-pacemaker \
+    --without-rgmanager \
+    --without-udev \
+    --without-utils \
+    --without-xen
+popd
+for kvariant in %{kvariants} ; do
+    %{__cp} -av %{short_name}-%{version} _kmod_build_$kvariant
+done
+
+%build
+for kvariant in %{kvariants}; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant
+    %{__make} KDIR=&quot;${ksrc}&quot; module
+    popd
+done
+
+%install
+%{__rm} -rf %{buildroot}
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants}; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/drbd
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    popd
+done
+### Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Fri Jun 11 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 8.3.8-1
+- Initial package. (using DAR)

Propchange: branches/rpms/dag/kmod-drbd-src/kmod-drbd-src.spec
------------------------------------------------------------------------------
    svn:eol-style = native

Propchange: branches/rpms/dag/kmod-drbd-src/kmod-drbd-src.spec
------------------------------------------------------------------------------
    svn:keywords = Id Revision

Added: branches/rpms/dag/kmod-drbd-src/kmodtool
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmodtool?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmodtool?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/kmodtool (added)
+++ branches/rpms/dag/kmod-drbd-src/kmodtool Mon Aug  2 13:20:46 2010
@@ -1,0 +1,267 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2006 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp2&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+    
+    cat &lt;&lt;EOF
+Provides:         kernel-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+    
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+#
+# RHEL5 - Remove common package requirement on general kmod packages.
+# Requires: ${kmod_name}-kmod-common &gt;= %{?epoch:%{epoch}:}%{version}
+#
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Requires: ${kmod_name} &gt;= %{?epoch:%{epoch}:}%{version}
+Requires: module-init-tools &gt;= 3.1-0.pre5.3.10
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel modules built for the Linux
+kernel ${verrel}${variant} for the %{_target_cpu} family of processors.
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+modules=( \$(rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+        
+    fi
+    
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+  
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: branches/rpms/dag/kmod-drbd-src/kmodtool
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83 (added)
+++ branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83 Mon Aug  2 13:20:46 2010
@@ -1,0 +1,274 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+    
+    cat &lt;&lt;EOF
+Provides:         kernel-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+    
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+#
+# RHEL5 - Remove common package requirement on general kmod packages.
+# Requires: ${kmod_name}-kmod-common &gt;= %{?epoch:%{epoch}:}%{version}
+#
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Requires: drbd83-utils &gt;= %{?epoch:%{epoch}:}%{version}
+Requires: module-init-tools &gt;= 3.1-0.pre5.3.10
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel modules built for the Linux
+kernel ${verrel}${variant} for the %{_target_cpu} family of processors.
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+
+#modules=( \$(rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$') )
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} \
+          | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+        
+    fi
+    
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+  
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83.new
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83.new?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83.new?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83.new (added)
+++ branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83.new Mon Aug  2 13:20:46 2010
@@ -1,0 +1,276 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Provides:         kabi-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel module(s) built
+for the Linux kernel using the %{_target_cpu} family of processors.
+
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working, this may take some time ...&quot;
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+echo &quot;Done.&quot;
+#echo &quot;blacklist FOO&quot; &gt;&gt; /etc/modprobe.d/blacklist
+
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+    fi
+
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working, this may take some time ...&quot;
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+echo &quot;Done.&quot;
+#if [ \$(grep -c &quot;blacklist FOO&quot; /etc/modprobe.d/blacklist) -gt 1 ]; then
+#    sed -i '/blacklist FOO/d' /etc/modprobe.d/blacklist
+#    echo &quot;blacklist FOO&quot; &gt;&gt; /etc/modprobe.d/blacklist
+#else
+#    sed -i '/blacklist FOO/d' /etc/modprobe.d/blacklist
+#fi
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;%config /etc/depmod.d/${kmod_name}.conf&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: branches/rpms/dag/kmod-drbd-src/kmodtool-drbd83.new
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-drbd-src/kmodtool.elrepo
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmodtool.elrepo?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/kmodtool.elrepo?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/kmodtool.elrepo (added)
+++ branches/rpms/dag/kmod-drbd-src/kmodtool.elrepo Mon Aug  2 13:20:46 2010
@@ -1,0 +1,276 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Provides:         kabi-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel module(s) built
+for the Linux kernel using the %{_target_cpu} family of processors.
+
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working, this may take some time ...&quot;
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+echo &quot;Done.&quot;
+#echo &quot;blacklist FOO&quot; &gt;&gt; /etc/modprobe.d/blacklist
+
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+    fi
+
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Working, this may take some time ...&quot;
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+echo &quot;Done.&quot;
+#if [ \$(grep -c &quot;blacklist FOO&quot; /etc/modprobe.d/blacklist) -gt 1 ]; then
+#    sed -i '/blacklist FOO/d' /etc/modprobe.d/blacklist
+#    echo &quot;blacklist FOO&quot; &gt;&gt; /etc/modprobe.d/blacklist
+#else
+#    sed -i '/blacklist FOO/d' /etc/modprobe.d/blacklist
+#fi
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;%config /etc/depmod.d/${kmod_name}.conf&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: branches/rpms/dag/kmod-drbd-src/kmodtool.elrepo
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-drbd-src/template.spec.elrepo
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/template.spec.elrepo?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-drbd-src/template.spec.elrepo?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-drbd-src/template.spec.elrepo (added)
+++ branches/rpms/dag/kmod-drbd-src/template.spec.elrepo Mon Aug  2 13:20:46 2010
@@ -1,0 +1,79 @@
+# Define the kmod package name here.
+%define  kmod_name PHOO
+
+Name:    %{kmod_name}-kmod
+Version: 0.0
+Release: 1.el5.elrepo
+Group:   System Environment/Kernel
+License: GPL v2
+Summary: %{kmod_name} kernel modules
+URL:     <A HREF="http://www.kernel.org/">http://www.kernel.org/</A>
+
+BuildRoot:     %{_tmppath}/%{name}-%{version}-%{release}-build-%(%{__id_u} -n)
+ExclusiveArch: i686 x86_64
+
+# Sources.
+Source0:  %{kmod_name}-%{version}.tar.bz2
+Source10: kmodtool-%{kmod_name}
+
+# If kversion isn't defined on the rpmbuild line, define it here.
+%{!?kversion: %define kversion 2.6.18-8.el5}
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the %{kmod_name} kernel modules.
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the Linux kernel and not on any one specific build.
+
+%prep
+%setup -q -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -a %{kmod_name}-%{version} _kmod_build_$kvariant
+    %{__cat} &lt;&lt;-EOF &gt;_kmod_build_$kvariant/%{kmod_name}.conf
+        override %{kmod_name} * weak-updates/%{kmod_name}
+        EOF
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant
+    %{__make} -C &quot;${ksrc}&quot; modules M=$PWD
+    popd
+done
+
+%install
+export INSTALL_MOD_PATH=$RPM_BUILD_ROOT
+export INSTALL_MOD_DIR=extra/%{kmod_name}
+for kvariant in %{kvariants} ; do
+    ksrc=%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=$PWD
+    %{__install} -d ${INSTALL_MOD_PATH}/etc/depmod.d/
+    %{__install} %{kmod_name}.conf ${INSTALL_MOD_PATH}/etc/depmod.d/
+    popd
+done
+# Strip the module(s).
+find ${INSTALL_MOD_PATH} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf $RPM_BUILD_ROOT
+
+%changelog
+* Tue Sep 29 2009 Alan Bartlett &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ajb at elrepo.org</A>&gt;
+- Initial build of the kmod package.

Added: branches/rpms/dag/kmod-fuse-src/kmod-fuse-src.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-fuse-src/kmod-fuse-src.spec?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-fuse-src/kmod-fuse-src.spec?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-fuse-src/kmod-fuse-src.spec (added)
+++ branches/rpms/dag/kmod-fuse-src/kmod-fuse-src.spec Mon Aug  2 13:20:46 2010
@@ -1,0 +1,86 @@
+# $Id$
+# Authority: dag
+
+# ExclusiveDist: el5
+# Archs: i686 x86_64
+
+# Tag: test
+
+%define kversion 2.6.18-194.3.1.el5
+%{!?kversion:%define kversion %(rpm -q kernel-devel --qf '%{RPMTAG_VERSION}-%{RPMTAG_RELEASE}' | tail -1)}
+
+# Define the kmod package name here.
+%define kmod_name fuse
+
+Summary: Kernel module for the FUSE userspace filesystem support
+Name: kmod-fuse-src
+Version: 2.7.4
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="http://fuse.sourceforge.net/">http://fuse.sourceforge.net/</A>
+
+Source0: <A HREF="http://dl.sf.net/fuse/fuse-%{version">http://dl.sf.net/fuse/fuse-%{version</A>}.tar.gz
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the kernel module for the FUSE userspace filesystem
+support. With FUSE it is possible to implement a fully functional filesystem
+in a userspace program.
+
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the CentOS kernel and not on any one specific build.
+
+%prep
+%setup -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -av %{kmod_name}-%{version} _kmod_build_$kvariant
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/kernel
+    ./configure --enable-kernel-module --with-kernel=&quot;${ksrc}&quot;
+    %{__make} -C &quot;${ksrc}&quot; modules M=&quot;$PWD&quot;
+    popd
+done
+
+%install
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/kernel
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -d ${INSTALL_MOD_PATH}/usr/lib/debug
+    popd
+done
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Mon May 04 2009 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 2.7.4-1
+- Initial package. (using DAR)

Propchange: branches/rpms/dag/kmod-fuse-src/kmod-fuse-src.spec
------------------------------------------------------------------------------
    svn:eol-style = native

Propchange: branches/rpms/dag/kmod-fuse-src/kmod-fuse-src.spec
------------------------------------------------------------------------------
    svn:keywords = Id Revision

Added: branches/rpms/dag/kmod-fuse-src/kmodtool-fuse
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-fuse-src/kmodtool-fuse?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-fuse-src/kmodtool-fuse?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-fuse-src/kmodtool-fuse (added)
+++ branches/rpms/dag/kmod-fuse-src/kmodtool-fuse Mon Aug  2 13:20:46 2010
@@ -1,0 +1,274 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+    
+    cat &lt;&lt;EOF
+Provides:         kernel-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+    
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+#
+# RHEL5 - Remove common package requirement on general kmod packages.
+# Requires: ${kmod_name}-kmod-common &gt;= %{?epoch:%{epoch}:}%{version}
+#
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Requires: fuse
+Obsoletes: dkms-fuse
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel modules built for the Linux
+kernel ${verrel}${variant} for the %{_target_cpu} family of processors.
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+
+#modules=( \$(rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$') )
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} \
+          | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+        
+    fi
+    
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+  
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: branches/rpms/dag/kmod-fuse-src/kmodtool-fuse
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-kqemu-src/kmod-kqemu-src.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-kqemu-src/kmod-kqemu-src.spec?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-kqemu-src/kmod-kqemu-src.spec?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-kqemu-src/kmod-kqemu-src.spec (added)
+++ branches/rpms/dag/kmod-kqemu-src/kmod-kqemu-src.spec Mon Aug  2 13:20:46 2010
@@ -1,0 +1,94 @@
+# $Id$
+# Authority: dag
+
+# ExclusiveDist: el5
+# Archs: i686 x86_64
+
+# Tag: test
+
+%define kversion 2.6.18-164.10.1.el5
+%{!?kversion:%define kversion %(rpm -q kernel-devel --qf '%{RPMTAG_VERSION}-%{RPMTAG_RELEASE}' | tail -1)}
+
+# Define the kmod package name here.
+%define kmod_name kqemu
+
+Summary: Kernel module for the QEMU accelerator
+Name: kmod-kqemu-src
+%define real_version 1.4.0pre1
+Version: 1.4.0
+Release: 0.1.pre1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="http://fabrice.bellard.free.fr/qemu/">http://fabrice.bellard.free.fr/qemu/</A>
+
+Source: <A HREF="http://www.nongnu.org/qemu/kqemu-%{real_version">http://www.nongnu.org/qemu/kqemu-%{real_version</A>}.tar.gz
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the kernel module for the QEMU accelerator.
+The QEMU accelerator kernel module, a host driver to achieve near native
+performances when using QEMU as a virtualizer.
+
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the CentOS kernel and not on any one specific build.
+
+%prep
+%setup -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -av %{kmod_name}-%{real_version} _kmod_build_$kvariant
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant
+    ./configure --kernel-path=&quot;${ksrc}&quot;
+    %{__make}
+    popd
+done
+
+%install
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -d ${INSTALL_MOD_PATH}/usr/lib/debug
+    popd
+done
+
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+# Configuration for udev
+%{__mkdir_p} %{buildroot}/etc/udev/rules.d
+%{__cat} &gt; %{buildroot}/etc/udev/rules.d/60-kqemu.rules &lt;&lt; 'EOF'
+KERNEL==&quot;kqemu&quot;, NAME=&quot;%k&quot;, MODE=&quot;0666&quot;
+EOF
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Mon May 04 2009 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 1.4.0-0.1.pre1
+- Initial package. (using DAR)

Propchange: branches/rpms/dag/kmod-kqemu-src/kmod-kqemu-src.spec
------------------------------------------------------------------------------
    svn:eol-style = native

Propchange: branches/rpms/dag/kmod-kqemu-src/kmod-kqemu-src.spec
------------------------------------------------------------------------------
    svn:keywords = Id Revision

Added: branches/rpms/dag/kmod-kqemu-src/kmodtool-kqemu
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-kqemu-src/kmodtool-kqemu?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-kqemu-src/kmodtool-kqemu?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-kqemu-src/kmodtool-kqemu (added)
+++ branches/rpms/dag/kmod-kqemu-src/kmodtool-kqemu Mon Aug  2 13:20:46 2010
@@ -1,0 +1,274 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+    
+    cat &lt;&lt;EOF
+Provides:         kernel-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+    
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+#
+# RHEL5 - Remove common package requirement on general kmod packages.
+# Requires: ${kmod_name}-kmod-common &gt;= %{?epoch:%{epoch}:}%{version}
+#
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Obsoletes: dkms-kqemu
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel modules built for the Linux
+kernel ${verrel}${variant} for the %{_target_cpu} family of processors.
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+
+#modules=( \$(rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$') )
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} \
+          | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+        
+    fi
+    
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;/etc/udev/rules.d/60-kqemu.rules&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+  
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: branches/rpms/dag/kmod-kqemu-src/kmodtool-kqemu
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-lin_tape-src-1.29.0.tar.gz
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src-1.29.0.tar.gz?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src-1.29.0.tar.gz?rev=9026&amp;view=markup</A>
==============================================================================
Binary file - no diff available.

Propchange: branches/rpms/dag/kmod-lin_tape-src-1.29.0.tar.gz
------------------------------------------------------------------------------
    svn:mime-type = application/octet-stream

Added: branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec (added)
+++ branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec Mon Aug  2 13:20:46 2010
@@ -1,0 +1,98 @@
+# $Id$
+# Authority: dag
+
+# ExclusiveDist: el5
+# Archs: i686 x86_64
+
+# Tag: test
+
+%define kversion 2.6.18-164.10.1.el5
+%{!?kversion:%define kversion %(rpm -q kernel-devel --qf '%{RPMTAG_VERSION}-%{RPMTAG_RELEASE}\n' | tail -1)}
+
+# Define the kmod package name here.
+%define kmod_name lin_tape
+
+Summary: IBM Tape SCSI Device Driver for Linux
+Name: kmod-lin_tape-src
+Version: 1.29.0
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/">ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/</A>
+
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-build-%(%{__id_u} -n)
+ExclusiveArch: i686 x86_64
+
+# Sources.
+#<A HREF="ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/lin_tape/lin_tape-1.29.0-1.src.rpm.bin">ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/lin_tape/lin_tape-1.29.0-1.src.rpm.bin</A>
+Source0: %{kmod_name}-%{version}.tgz
+Source1: lin_tape-depmod.conf
+Source2: lin_tape-98-lin_tape.permissions
+Source10: kmodtool-%{kmod_name}
+
+# If kversion isn't defined on the rpmbuild line, build for the current kernel.
+%{!?kversion: %define kversion %(uname -r)}
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the The IBM Tape Device Driver driver module for
+IBM TotalStorage and SystemStorage tape devices.
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the Linux kernel and not on any one specific build.
+
+%prep
+%setup -q -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -a %{kmod_name}-%{version} _kmod_build_$kvariant
+    %{__cat} &lt;&lt;-EOF &gt;_kmod_build_$kvariant/%{kmod_name}.conf
+override %{kmod_name} * weak-updates/%{kmod_name}
+EOF
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant
+    %{__make} -C &quot;${ksrc}&quot; modules M=&quot;$PWD&quot;
+    popd
+done
+
+%install
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -d %{buildroot}%{_sysconfdir}/depmod.d/
+    %{__install} %{kmod_name}.conf %{buildroot}%{_sysconfdir}/depmod.d/
+    popd
+done
+# Strip the module(s).
+find ${INSTALL_MOD_PATH} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%{__install} -Dp -m0644 %{kmod_name}-%{version}/98-lin_tape.rules %{buildroot}%{_sysconfdir}/udev/rules/98-lin_tape.rules
+%{__install} -Dp -m0755 %{kmod_name}-%{version}/udev.get_lin_tape_id.sh %{buildroot}%{_sbindir}/udev.get_lin_tape_id.sh
+%{__install} -Dp -m0644 %{SOURCE2} %{buildroot}%{_sysconfdir}/udev/permissions.d/98-lin_tape.permissions
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Tue Jan 12 2010 Philip J Perry &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">phil at elrepo.org</A>&gt; - 1.29.0-1
+- Initial build of the kmod package.

Propchange: branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec
------------------------------------------------------------------------------
    svn:eol-style = native

Propchange: branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec
------------------------------------------------------------------------------
    svn:keywords = Id Revision

Added: branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec.old
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec.old?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec.old?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec.old (added)
+++ branches/rpms/dag/kmod-lin_tape-src/kmod-lin_tape-src.spec.old Mon Aug  2 13:20:46 2010
@@ -1,0 +1,92 @@
+# $Id$
+# Authority: dag
+
+# ExclusiveDist: el5
+# Archs: i686 x86_64
+
+# Tag: test
+
+%define kversion 2.6.18-164.10.1.el5
+%{!?kversion:%define kversion %(rpm -q kernel-devel --qf '%{RPMTAG_VERSION}-%{RPMTAG_RELEASE}\n' | tail -1)}
+
+%define _sbindir /sbin
+
+# Define the kmod package name here.
+%define kmod_name lin_tape
+
+Summary: IBM Tape SCSI Device Driver for Linux
+Name: kmod-lin_tape-src
+Version: 1.29.0
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/">ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/</A>
+
+#Source: <A HREF="ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/lin_tape/lin_tape-1.29.0-1.src.rpm.bin">ftp://ftp.software.ibm.com/storage/devdrvr/Linux/archive/lin_tape_source-lin_taped/lin_tape/lin_tape-1.29.0-1.src.rpm.bin</A>
+Source: lin_tape-%{version}.tgz
+Source1: lin_tape-depmod.conf
+Source2: lin_tape-98-lin_tape.permissions
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+The IBM Tape Device Driver, lin_tape, product is a device driver
+that provides attachment for the IBM TotalStorage and System
+Storage tape devices to Linux compatible platforms.
+
+%prep
+%setup -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -a %{kmod_name}-%{version} _kmod_build_$kvariant
+    %{__cat} &lt;&lt;EOF &gt;_kmod_build_$kvariant/%{kmod_name}.conf
+override %{kmod_name} * weak-updates/%{kmod_name}
+EOF
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    %{__make} -C _kmod_build_$kvariant KERNEL=&quot;%{kversion}&quot; PROC=&quot;%{_target_cpu}&quot; driver
+done
+
+%install
+export INSTALL_MOD_PATH=$RPM_BUILD_ROOT
+export INSTALL_MOD_DIR=extra/%{kmod_name}
+for kvariant in %{kvariants} ; do
+    ksrc=%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}
+    pushd _kmod_build_$kvariant
+    %{__install} -Dp -m0644 bldtmp/%{kmod_name}-%{kversion}.ko %{buildroot}/lib/modules/%{kversion}/${INSTALL_MOD_DIR}/%{kmod_name}.ko
+    popd
+done
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%{__install} -Dp -m0644 %{kmod_name}-%{version}/98-lin_tape.rules %{buildroot}%{_sysconfdir}/udev/rules/98-lin_tape.rules
+%{__install} -Dp -m0755 %{kmod_name}-%{version}/lin_tape %{buildroot}%{_initrddir}/lin_tape
+%{__install} -Dp -m0755 %{kmod_name}-%{version}/udev.get_lin_tape_id.sh %{buildroot}%{_sbindir}/udev.get_lin_tape_id.sh
+%{__install} -Dp -m0644 %{SOURCE1} %{buildroot}%{_sysconfdir}/depmod.d/lin_tape.conf
+%{__install} -Dp -m0644 %{SOURCE2} %{buildroot}%{_sysconfdir}/udev/permissions.d/98-lin_tape.permissions
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Mon Jan 11 2010 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 1.24.0-1
+- Initial package. (using DAR)

Added: branches/rpms/dag/kmod-lin_tape-src/kmodtool-lin_tape
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/kmodtool-lin_tape?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/kmodtool-lin_tape?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-lin_tape-src/kmodtool-lin_tape (added)
+++ branches/rpms/dag/kmod-lin_tape-src/kmodtool-lin_tape Mon Aug  2 13:20:46 2010
@@ -1,0 +1,272 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Provides:         kabi-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel module built
+for the Linux kernel using the %{_target_cpu} family of processors.
+
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Creating the symbolic links. This may take some time ...&quot;
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+echo &quot;Done.&quot;
+
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+    fi
+
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+echo &quot;Removing the symbolic links. This may take some time ...&quot;
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+echo &quot;Done.&quot;
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    echo &quot;%config %{_sysconfdir}/depmod.d/${kmod_name}.conf&quot;
+    echo &quot;%config %{_sysconfdir}/udev/rules/98-lin_tape.rules&quot;
+    echo &quot;%config %{_sysconfdir}/udev/permissions.d/98-lin_tape.permissions&quot;
+    echo &quot;%{_sbindir}/udev.get_lin_tape_id.sh&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Added: branches/rpms/dag/kmod-lin_tape-src/lin_tape-98-lin_tape.permissions
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/lin_tape-98-lin_tape.permissions?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/lin_tape-98-lin_tape.permissions?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-lin_tape-src/lin_tape-98-lin_tape.permissions (added)
+++ branches/rpms/dag/kmod-lin_tape-src/lin_tape-98-lin_tape.permissions Mon Aug  2 13:20:46 2010
@@ -1,0 +1,1 @@
+IBM*:root:tsm:0660

Added: branches/rpms/dag/kmod-lin_tape-src/lin_tape-depmod.conf
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/lin_tape-depmod.conf?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-lin_tape-src/lin_tape-depmod.conf?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-lin_tape-src/lin_tape-depmod.conf (added)
+++ branches/rpms/dag/kmod-lin_tape-src/lin_tape-depmod.conf Mon Aug  2 13:20:46 2010
@@ -1,0 +1,9 @@
+#
+# lin_tape.conf
+#
+
+# Add on (replacement) lin_tape IBM TotalStorage / SystemStorage driver
+
+# override default search ordering for kmod packaging
+override lin_tape * weak-updates/lin_tape
+

Added: branches/rpms/dag/kmod-ndiswrapper-src/kmod-ndiswrapper-src.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-ndiswrapper-src/kmod-ndiswrapper-src.spec?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-ndiswrapper-src/kmod-ndiswrapper-src.spec?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-ndiswrapper-src/kmod-ndiswrapper-src.spec (added)
+++ branches/rpms/dag/kmod-ndiswrapper-src/kmod-ndiswrapper-src.spec Mon Aug  2 13:20:46 2010
@@ -1,0 +1,109 @@
+# $Id$
+# Authority: dag
+
+# ExclusiveDist: el5
+# Archs: i686 x86_64
+
+# Tag: test
+
+%define kversion 2.6.18-164.10.1.el5
+%{!?kversion:%define kversion %(rpm -q kernel-devel --qf '%{RPMTAG_VERSION}-%{RPMTAG_RELEASE}' | tail -1)}
+
+# Define the kmod package name here.
+%define kmod_name ndiswrapper
+
+Summary: Kernel module for the Microsoft NDIS (Network Driver Interface Specification) API
+Name: kmod-ndiswrapper-src
+Version: 1.54
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="http://ndiswrapper.sourceforge.net/">http://ndiswrapper.sourceforge.net/</A>
+
+Source0: <A HREF="http://dl.sf.net/ndiswrapper/ndiswrapper-%{version">http://dl.sf.net/ndiswrapper/ndiswrapper-%{version</A>}.tar.gz
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the kernel module for the Microsoft NDIS (Network Driver
+Interface Specification) API. It allows the use of binary drivers written to
+this specification to be run natively in the Linux kernel.
+
+It is built to depend upon the specific ABI provided by a range of releases
+of the same variant of the CentOS kernel and not on any one specific build.
+
+%package -n ndiswrapper
+Summary: Utilities for the ndiswrapper kernel module
+Group: System Environment/Kernel
+
+%description -n ndiswrapper
+The ndiswrapper utils required to use ndiswrapper.
+
+%prep
+%setup -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -av %{kmod_name}-%{version} _kmod_build_$kvariant
+done
+
+%build
+%{__make} -C %{kmod_name}-%{version}/utils CFLAGS=&quot;%{optflags} -I../driver&quot;
+
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/driver
+    %{__make} -C &quot;${ksrc}&quot; modules M=&quot;$PWD&quot; KBUILD=&quot;${ksrc}&quot;
+    popd
+done
+
+%install
+%{__rm} -rf %{buildroot}
+%{__make} -C %{kmod_name}-%{version}/utils install DESTDIR=&quot;%{buildroot}&quot;
+%{__install} -d -m0755 %{buildroot}%{_sysconfdir}/ndiswrapper
+%{__install} -Dp -m0644 %{kmod_name}-%{version}/ndiswrapper.8 %{buildroot}%{_mandir}/man8/ndiswrapper.8
+
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/driver
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -d ${INSTALL_MOD_PATH}/usr/lib/debug
+    popd
+done
+
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%files -n ndiswrapper
+%defattr(-, root, root, 0755)
+%doc %{kmod_name}-%{version}/AUTHORS %{kmod_name}-%{version}/ChangeLog %{kmod_name}-%{version}/INSTALL %{kmod_name}-%{version}/README
+%doc %{_mandir}/man8/ndiswrapper.8*
+%dir %{_sysconfdir}/ndiswrapper/
+/sbin/loadndisdriver
+%{_sbindir}/ndiswrapper
+%{_sbindir}/ndiswrapper-buginfo
+
+%changelog
+* Mon May 04 2009 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 1.54-1
+- Initial package. (using DAR)

Propchange: branches/rpms/dag/kmod-ndiswrapper-src/kmod-ndiswrapper-src.spec
------------------------------------------------------------------------------
    svn:eol-style = native

Propchange: branches/rpms/dag/kmod-ndiswrapper-src/kmod-ndiswrapper-src.spec
------------------------------------------------------------------------------
    svn:keywords = Id Revision

Added: branches/rpms/dag/kmod-ndiswrapper-src/kmodtool-ndiswrapper
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-ndiswrapper-src/kmodtool-ndiswrapper?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-ndiswrapper-src/kmodtool-ndiswrapper?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-ndiswrapper-src/kmodtool-ndiswrapper (added)
+++ branches/rpms/dag/kmod-ndiswrapper-src/kmodtool-ndiswrapper Mon Aug  2 13:20:46 2010
@@ -1,0 +1,274 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+    
+    cat &lt;&lt;EOF
+Provides:         kernel-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+    
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+#
+# RHEL5 - Remove common package requirement on general kmod packages.
+# Requires: ${kmod_name}-kmod-common &gt;= %{?epoch:%{epoch}:}%{version}
+#
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Requires: ndiswrapper
+Obsoletes: dkms-ndiswrapper
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel modules built for the Linux
+kernel ${verrel}${variant} for the %{_target_cpu} family of processors.
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+
+#modules=( \$(rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$') )
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} \
+          | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+        
+    fi
+    
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+  
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et

Propchange: branches/rpms/dag/kmod-ndiswrapper-src/kmodtool-ndiswrapper
------------------------------------------------------------------------------
    svn:executable = *

Added: branches/rpms/dag/kmod-ocfs2-src/kmod-ocfs2-src.spec
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-ocfs2-src/kmod-ocfs2-src.spec?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-ocfs2-src/kmod-ocfs2-src.spec?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-ocfs2-src/kmod-ocfs2-src.spec (added)
+++ branches/rpms/dag/kmod-ocfs2-src/kmod-ocfs2-src.spec Mon Aug  2 13:20:46 2010
@@ -1,0 +1,92 @@
+# $Id$
+# Authority: dag
+
+# ExclusiveDist: el5
+# Archs: i686 x86_64
+
+# Tag: test
+
+%define kversion 2.6.18-164.10.1.el5
+%{!?kversion:%define kversion %(rpm -q kernel-devel --qf '%{RPMTAG_VERSION}-%{RPMTAG_RELEASE}' | tail -1)}
+
+# Define the kmod package name here.
+%define kmod_name ocfs2
+
+Summary: Kernel module for the OCFS2 cluster file system
+Name: kmod-ocfs2-src
+Version: 1.4.2
+Release: 1%{?dist}
+License: GPL
+Group: System Environment/Kernel
+URL: <A HREF="http://oss.oracle.com/projects/ocfs2/">http://oss.oracle.com/projects/ocfs2/</A>
+
+Source0: <A HREF="http://oss.oracle.com/projects/ocfs2/dist/files/source/v1.4/ocfs2-%{version">http://oss.oracle.com/projects/ocfs2/dist/files/source/v1.4/ocfs2-%{version</A>}.tar.gz
+Source10: kmodtool-%{kmod_name}
+BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
+
+ExclusiveArch: i686 x86_64
+
+# Define the variants for each architecture.
+%define basevar &quot;&quot;
+%ifarch i686
+%define paevar PAE
+%endif
+%ifarch i686 x86_64
+%define xenvar xen
+%endif
+
+# If kvariants isn't defined on the rpmbuild line, build all variants for this architecture.
+%{!?kvariants: %define kvariants %{?basevar} %{?xenvar} %{?paevar}}
+
+# Magic hidden here.
+%define kmodtool sh %{SOURCE10}
+%{expand:%(%{kmodtool} rpmtemplate_kmp %{kmod_name} %{kversion} %{kvariants} 2&gt;/dev/null)}
+
+%description
+This package provides the kernel module for the OCFS2 cluster file system.
+
+OCFS2 is a POSIX-compliant shared-disk cluster file system for Linux capable
+of providing both high performance and high availability.
+
+As it provides local file system semantics, it can be used with any
+application. Cluster-aware applications can make use of parallel I/O for
+higher performance. Applications, not able to benefit from parallel I/O,
+can take advantage of the file system to provide a fail-over setup to
+increase its availability. 
+
+%prep
+%setup -c -T -a 0
+for kvariant in %{kvariants} ; do
+    %{__cp} -av %{kmod_name}-%{version} _kmod_build_$kvariant
+done
+
+%build
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/
+    %configure --with-vendor=&quot;rhel5&quot; --with-vendorkernel=&quot;${kversion}&quot;
+    pushd fs
+    %{__make} -C &quot;${ksrc}&quot; modules M=&quot;$PWD&quot;
+    popd
+    popd
+done
+
+%install
+export INSTALL_MOD_PATH=&quot;%{buildroot}&quot;
+export INSTALL_MOD_DIR=&quot;extra/%{kmod_name}&quot;
+for kvariant in %{kvariants} ; do
+    ksrc=&quot;%{_usrsrc}/kernels/%{kversion}${kvariant:+-$kvariant}-%{_target_cpu}&quot;
+    pushd _kmod_build_$kvariant/
+    %{__make} -C &quot;${ksrc}&quot; modules_install M=&quot;$PWD&quot;
+    %{__install} -d ${INSTALL_MOD_PATH}/usr/lib/debug
+    popd
+done
+# Strip the module(s).
+find %{buildroot} -type f -name \*.ko -exec strip --strip-debug \{\} \;
+
+%clean
+%{__rm} -rf %{buildroot}
+
+%changelog
+* Wed Aug 12 2009 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 1.4.2-1
+- Initial package. (using DAR)

Propchange: branches/rpms/dag/kmod-ocfs2-src/kmod-ocfs2-src.spec
------------------------------------------------------------------------------
    svn:eol-style = native

Propchange: branches/rpms/dag/kmod-ocfs2-src/kmod-ocfs2-src.spec
------------------------------------------------------------------------------
    svn:keywords = Id Revision

Added: branches/rpms/dag/kmod-ocfs2-src/kmodtool-ocfs2
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-ocfs2-src/kmodtool-ocfs2?rev=9026&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/branches/rpms/dag/kmod-ocfs2-src/kmodtool-ocfs2?rev=9026&amp;view=markup</A>
==============================================================================
--- branches/rpms/dag/kmod-ocfs2-src/kmodtool-ocfs2 (added)
+++ branches/rpms/dag/kmod-ocfs2-src/kmodtool-ocfs2 Mon Aug  2 13:20:46 2010
@@ -1,0 +1,275 @@
+#!/bin/bash
+
+# kmodtool - Helper script for building kernel module RPMs
+# Copyright (c) 2003-2008 Ville Skytt&#195;&#164; &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ville.skytta at iki.fi</A>&gt;,
+#                         Thorsten Leemhuis &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fedora at leemhuis.info</A>&gt;
+#                         Jon Masters &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">jcm at redhat.com</A>&gt;
+#
+# Permission is hereby granted, free of charge, to any person obtaining
+# a copy of this software and associated documentation files (the
+# &quot;Software&quot;), to deal in the Software without restriction, including
+# without limitation the rights to use, copy, modify, merge, publish,
+# distribute, sublicense, and/or sell copies of the Software, and to
+# permit persons to whom the Software is furnished to do so, subject to
+# the following conditions:
+#
+# The above copyright notice and this permission notice shall be
+# included in all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+
+shopt -s extglob
+
+myprog=&quot;kmodtool&quot;
+myver=&quot;0.10.10_kmp3&quot;
+knownvariants=@(BOOT|PAE|@(big|huge)mem|debug|enterprise|kdump|?(large)smp|uml|xen[0U]?(-PAE)|xen)
+kmod_name=
+kver=
+verrel=
+variant=
+kmp=
+
+get_verrel ()
+{
+  verrel=${1:-$(uname -r)}
+  verrel=${verrel%%$knownvariants}
+}
+
+print_verrel ()
+{
+  get_verrel $@
+  echo &quot;${verrel}&quot;
+}
+
+get_variant ()
+{
+  get_verrel $@
+  variant=${1:-$(uname -r)}
+  variant=${variant##$verrel}
+  variant=${variant:-'&quot;&quot;'}
+}
+
+print_variant ()
+{
+  get_variant $@
+  echo &quot;${variant}&quot;
+}
+
+get_rpmtemplate ()
+{
+    local variant=&quot;${1}&quot;
+    local dashvariant=&quot;${variant:+-${variant}}&quot;
+    case &quot;$verrel&quot; in
+        *.el*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *.EL*) kdep=&quot;kernel${dashvariant}-%{_target_cpu} = ${verrel}&quot; ;;
+        *)     kdep=&quot;kernel-%{_target_cpu} = ${verrel}${variant}&quot;     ;;
+    esac
+
+    echo &quot;%package       -n kmod-${kmod_name}${dashvariant}&quot;
+
+    if [ -z &quot;$kmp_provides_summary&quot; ]; then
+        echo &quot;Summary:          ${kmod_name} kernel module(s)&quot;
+    fi
+
+    if [ -z &quot;$kmp_provides_group&quot; ]; then
+        echo &quot;Group:            System Environment/Kernel&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_version&quot; ]; then
+        echo &quot;Version: %{kmp_version}&quot;
+    fi
+
+    if [ ! -z &quot;$kmp_release&quot; ]; then
+        echo &quot;Release: %{kmp_release}&quot;
+    fi
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        echo &quot;%global _use_internal_dependency_generator 0&quot;
+    fi
+    
+    cat &lt;&lt;EOF
+Provides:         kernel-modules = ${verrel}${variant}
+Provides:         ${kmod_name}-kmod = %{?epoch:%{epoch}:}%{version}-%{release}
+EOF
+    
+    if [ -z &quot;$kmp&quot; ]; then
+        echo &quot;Requires:         ${kdep}&quot;
+    fi
+
+#
+# RHEL5 - Remove common package requirement on general kmod packages.
+# Requires: ${kmod_name}-kmod-common &gt;= %{?epoch:%{epoch}:}%{version}
+#
+
+    cat &lt;&lt;EOF
+Requires(post):   /sbin/depmod
+Requires(postun): /sbin/depmod
+Requires: ocfs2-tools
+Obsoletes: ocfs2 &lt;= %{version}-%{release}
+Provides: ocfs2 = %{version}-%{release}
+EOF
+
+if [ &quot;no&quot; != &quot;$kmp_nobuildreqs&quot; ]
+then
+    echo &quot;BuildRequires: kernel${dashvariant}-devel-%{_target_cpu} = ${verrel}&quot;
+fi
+
+if [ &quot;&quot; != &quot;$kmp_override_preamble&quot; ]
+then
+    cat &quot;$kmp_override_preamble&quot;
+fi
+
+cat &lt;&lt;EOF
+%description   -n kmod-${kmod_name}${dashvariant}
+This package provides the ${kmod_name} kernel modules built for the Linux
+kernel ${verrel}${variant} for the %{_target_cpu} family of processors.
+%post          -n kmod-${kmod_name}${dashvariant}
+if [ -e &quot;/boot/System.map-${verrel}${variant}&quot; ]; then
+    /sbin/depmod -aeF &quot;/boot/System.map-${verrel}${variant}&quot; &quot;${verrel}${variant}&quot; &gt; /dev/null || :
+fi
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+
+#modules=( \$(rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$') )
+modules=( \$(find /lib/modules/${verrel}${variant}/extra/${kmod_name} \
+          | grep '\.ko$') )
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --add-modules
+fi
+%preun         -n kmod-${kmod_name}${dashvariant}
+rpm -ql kmod-${kmod_name}${dashvariant} | grep '\.ko$' \
+    &gt; /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+EOF
+        
+    fi
+    
+    cat &lt;&lt;EOF
+%postun        -n kmod-${kmod_name}${dashvariant}
+/sbin/depmod -aF /boot/System.map-${verrel}${variant} ${verrel}${variant} &amp;&gt; /dev/null || :
+EOF
+    
+    if [ ! -z &quot;$kmp&quot; ]; then
+        cat &lt;&lt;EOF
+modules=( \$(cat /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules) )
+#rm /var/run/rpm-kmod-${kmod_name}${dashvariant}-modules
+if [ -x &quot;/sbin/weak-modules&quot; ]; then
+    printf '%s\n' &quot;\${modules[@]}&quot; \
+    | /sbin/weak-modules --remove-modules
+fi
+EOF
+    fi
+
+echo &quot;%files         -n kmod-${kmod_name}${dashvariant}&quot;
+
+if [ &quot;&quot; == &quot;$kmp_override_filelist&quot; ];
+then
+    echo &quot;%defattr(644,root,root,755)&quot;
+    echo &quot;/lib/modules/${verrel}${variant}/&quot;
+    #BZ252188 - I've commented this out for the moment since RHEL5 doesn't
+    #           really support external firmware e.g. at install time. If
+    #           you really want it, use an override filelist solution.
+    #echo &quot;/lib/firmware/&quot;
+else
+    cat &quot;$kmp_override_filelist&quot;
+fi
+}
+
+print_rpmtemplate ()
+{
+  kmod_name=&quot;${1}&quot;
+  shift
+  kver=&quot;${1}&quot;
+  get_verrel &quot;${1}&quot;
+  shift
+  if [ -z &quot;${kmod_name}&quot; ] ; then
+    echo &quot;Please provide the kmodule-name as first parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${kver}&quot; ] ; then
+    echo &quot;Please provide the kver as second parameter.&quot; &gt;&amp;2
+    exit 2
+  elif [ -z &quot;${verrel}&quot; ] ; then
+    echo &quot;Couldn't find out the verrel.&quot; &gt;&amp;2
+    exit 2
+  fi
+  
+  for variant in &quot;$@&quot; ; do
+      if [ &quot;default&quot; == &quot;$variant&quot; ];
+      then
+            get_rpmtemplate &quot;&quot;
+      else
+            get_rpmtemplate &quot;${variant}&quot;
+      fi
+  done
+}
+
+usage ()
+{
+  cat &lt;&lt;EOF
+You called: ${invocation}
+
+Usage: ${myprog} &lt;command&gt; &lt;option&gt;+
+ Commands:
+  verrel &lt;uname&gt;                               
+    - Get &quot;base&quot; version-release.
+  variant &lt;uname&gt;                               
+    - Get variant from uname.
+  rpmtemplate &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt; 
+    - Return a template for use in a source RPM
+  rpmtemplate_kmp &lt;mainpgkname&gt; &lt;uname&gt; &lt;variants&gt;
+    - Return a template for use in a source RPM with KMP dependencies
+  version  
+    - Output version number and exit.
+EOF
+}
+
+invocation=&quot;$(basename ${0}) $@&quot;
+while [ &quot;${1}&quot; ] ; do
+  case &quot;${1}&quot; in
+    verrel)
+      shift
+      print_verrel $@
+      exit $?
+      ;;
+    variant)
+      shift
+      print_variant $@
+      exit $?
+      ;;
+    rpmtemplate)
+      shift
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    rpmtemplate_kmp)
+      shift
+      kmp=1
+      print_rpmtemplate &quot;$@&quot;
+      exit $?
+      ;;
+    version)
+      echo &quot;${myprog} ${myver}&quot;
+      exit 0
+      ;;
+    *)
+      echo &quot;Error: Unknown option '${1}'.&quot; &gt;&amp;2
+      usage &gt;&amp;2
+      exit 2
+      ;;
+  esac
+done
+
+# Local variables:
+# mode: sh
+# sh-indentation: 2
+# indent-tabs-mode: nil
+# End:
+# ex: ts=2 sw=2 et


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007819.html">[svn] r9025 - /trunk/rpms/perl-Nagios-Object/perl-Nagios-Object.spec
</A></li>
	<LI>Next message: <A HREF="007821.html">[svn] r9027 - /branches/rpms/dag/kmod-lin_tape-src-1.29.0.tar.gz
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7820">[ date ]</a>
              <a href="thread.html#7820">[ thread ]</a>
              <a href="subject.html#7820">[ subject ]</a>
              <a href="author.html#7820">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
