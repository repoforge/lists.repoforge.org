<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r8825 - in /trunk/tools/dstat: ./ docs/ plugins/
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r8825%20-%20in%20/trunk/tools/dstat%3A%20./%20docs/%20plugins/&In-Reply-To=%3C201005261252.o4QCqjfj024143%40surya.karan.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007619.html">
   <LINK REL="Next"  HREF="007621.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r8825 - in /trunk/tools/dstat: ./ docs/ plugins/</H1>
    <B>Dag Wieers</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r8825%20-%20in%20/trunk/tools/dstat%3A%20./%20docs/%20plugins/&In-Reply-To=%3C201005261252.o4QCqjfj024143%40surya.karan.org%3E"
       TITLE="[svn] r8825 - in /trunk/tools/dstat: ./ docs/ plugins/">dag at wieers.com
       </A><BR>
    <I>Wed May 26 14:52:45 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="007619.html">[svn] r8824 -	/trunk/rpms/perl-Image-ExifTool/perl-Image-ExifTool.spec
</A></li>
        <LI>Next message: <A HREF="007621.html">[svn] r8826 - /trunk/tools/dstat/plugins/dstat_dstat_cpu.py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7620">[ date ]</a>
              <a href="thread.html#7620">[ thread ]</a>
              <a href="subject.html#7620">[ subject ]</a>
              <a href="author.html#7620">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dag
Date: Wed May 26 13:52:45 2010
New Revision: 8825

URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge?rev=8825&amp;view=rev">http://svn.rpmforge.net/viewvc/rpmforge?rev=8825&amp;view=rev</A>
Log:
- Added external dstat_squid plugin to show squid counters (Jason Friedland)
- Introduced blockdevices() to list available blockdevices
- Added support for CCISS block devices (named cciss/c0d0)
- Introduced cmd_test() to verify command and options
- Introduced cmd_readlines() to read from command output
- Introduced cmd_splitlines() to split lines read from command output
- Implement best effort /proc integer overflow handling in dstat_net (Ross Brattain)
- Added external dstat_dstat_mem plugin to show dstat's memory usage
- Added external dstat_dstat_cpu plugin to show dstat's cpu usage
- Added external dstat_top_bio_adv plugin to show advanced top I/O usage
- Added external dstat_top_cpu_adv plugin to show advanced top cpu usage
- Added external dstat_top_io_adv plugin to show advanced top block I/O usage
- Allow specifying separator for splitline() and splitlines() functions
- Make top-plugins free memory for processes that no longer exist

Added:
    trunk/tools/dstat/plugins/dstat_dstat_cpu.py
    trunk/tools/dstat/plugins/dstat_dstat_mem.py
    trunk/tools/dstat/plugins/dstat_squid.py
    trunk/tools/dstat/plugins/dstat_top_bio_adv.py
    trunk/tools/dstat/plugins/dstat_top_cpu_adv.py
    trunk/tools/dstat/plugins/dstat_top_io_adv.py
Modified:
    trunk/tools/dstat/ChangeLog
    trunk/tools/dstat/TODO
    trunk/tools/dstat/docs/dstat.1.txt
    trunk/tools/dstat/dstat
    trunk/tools/dstat/plugins/dstat_disk_tps.py
    trunk/tools/dstat/plugins/dstat_disk_util.py
    trunk/tools/dstat/plugins/dstat_dstat.py
    trunk/tools/dstat/plugins/dstat_net_packets.py
    trunk/tools/dstat/plugins/dstat_proc_count.py
    trunk/tools/dstat/plugins/dstat_top_bio.py
    trunk/tools/dstat/plugins/dstat_top_childwait.py
    trunk/tools/dstat/plugins/dstat_top_cpu.py
    trunk/tools/dstat/plugins/dstat_top_cputime.py
    trunk/tools/dstat/plugins/dstat_top_cputime_avg.py
    trunk/tools/dstat/plugins/dstat_top_io.py
    trunk/tools/dstat/plugins/dstat_top_latency.py
    trunk/tools/dstat/plugins/dstat_top_latency_avg.py
    trunk/tools/dstat/plugins/dstat_top_mem.py
    trunk/tools/dstat/plugins/dstat_top_oom.py

Modified: trunk/tools/dstat/ChangeLog
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/ChangeLog?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/ChangeLog?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/ChangeLog (original)
+++ trunk/tools/dstat/ChangeLog Wed May 26 13:52:45 2010
@@ -1,6 +1,20 @@
 * 0.7.1svn - ... - release 23/02/2010
 - Added external dstat_disk_tps plugin to show transactions per second
 - Added support for filtering /dev/vdaX devices (KVM virtio)
+- Added external dstat_squid plugin to show squid counters (Jason Friedland)
+- Introduced blockdevices() to list available blockdevices
+- Added support for CCISS block devices (named cciss/c0d0)
+- Introduced cmd_test() to verify command and options
+- Introduced cmd_readlines() to read from command output
+- Introduced cmd_splitlines() to split lines read from command output
+- Implement best effort /proc integer overflow handling in dstat_net (Ross Brattain)
+- Added external dstat_dstat_mem plugin to show dstat's memory usage
+- Added external dstat_dstat_cpu plugin to show dstat's cpu usage
+- Added external dstat_top_bio_adv plugin to show advanced top I/O usage
+- Added external dstat_top_cpu_adv plugin to show advanced top cpu usage
+- Added external dstat_top_io_adv plugin to show advanced top block I/O usage
+- Allow specifying separator for splitline() and splitlines() functions
+- Make top-plugins free memory for processes that no longer exist
 
 * 0.7.1 - Just the three of us - release 22/02/2010
 - Fix external plugins on python 2.2 and older (eg. RHEL3)

Modified: trunk/tools/dstat/TODO
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/TODO?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/TODO?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/TODO (original)
+++ trunk/tools/dstat/TODO Wed May 26 13:52:45 2010
@@ -19,7 +19,8 @@
 + Look into adding sched_setscheduler() calls for improved priority
 
 ### General improvements
-+ Implement better (?) protection against counter rollovers (see mail from Sebastien Prud'homme)
++ Implement better (?) protection against counter rollovers
+  (see mail from Sebastien Prud'homme/Ross Brattain)
 
 ### Documentation (help welcome!)
 + Document every plugin as part of python comments (explain unit, what it means etc...)
@@ -52,17 +53,18 @@
   - amavisd, apache, bind, cifs, dhcpd, dnsmasq, gfs, samba, squid
 + Look into interfacing with specific HW counters in /proc
   - qla2300
-+ Look at /proc/meminfo, /proc/mdstat, /proc/net/netstat, /proc/net/snmp, /proc/vmstat
++ Look at /proc/meminfo, /proc/mdstat, /proc/net/netstat, /proc/net/snmp, /proc/vmstat, /proc/drbd
 + Look at /proc/fs/cifs/stats
 + Add i2c plugin (see /sys/class/i2c-adapter/i2c-*/*/*/*/*/*)
 + Allow for SNMP counters to be added
 + Add LVM stats
-+ Add 'most expensive io app' based on /proc/pid/io (topio_ops)
 + Allow to have multiple '1st expensive ... app' and '2nd expensive ... app'
 + Add 'most iowaiting app' plugin
++ Add 'most busy interrupt' plugin
++ Add systemtap/perf integration
 
 ### Plugin issues
-+ plugins that use /proc/pid are reasonably slow (implement in C and cache file-content between plugins might help)
++ plugins that use /proc/pid are reasonably slow (implement in C might help)
 + disk plugin: /proc/partitions can have negative numbers, seen on systems with long uptime. dstat handles this except for calculating the very first stat, no work-around possible?
 + proc plugin: (run and blk) does not work on 2.4.24+ (to be confirmed ?)
 + swap plugin: (new one) is slower than swapold

Modified: trunk/tools/dstat/docs/dstat.1.txt
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/docs/dstat.1.txt?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/docs/dstat.1.txt?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/docs/dstat.1.txt (original)
+++ trunk/tools/dstat/docs/dstat.1.txt Wed May 26 13:52:45 2010
@@ -195,6 +195,12 @@
 --dstat::
     show dstat cputime consumption and latency
 
+--dstat-cpu::
+    show dstat advanced cpu usage
+
+--dstat-mem::
+    show dstat advanced memory usage
+
 --fan::
     fan speed (needs ACPI)
 
@@ -285,6 +291,9 @@
 --snooze::
     show number of ticks per second
 
+--squid::
+    show squid usage statistics
+
 --test::
     show test plugin output
 
@@ -294,12 +303,18 @@
 --top-bio::
     show most expensive block I/O process
 
+--top-bio-adv::
+    show most expensive block I/O process (incl. pid and other stats)
+
 --top-childwait::
     show process waiting for child the most
 
 --top-cpu::
     show most expensive CPU process
 
+--top-cpu-adv::
+    show most expensive CPU process (incl. pid and other stats)
+
 --top-cputime::
     show process using the most CPU time (in ms)
 
@@ -308,6 +323,9 @@
 
 --top-io::
     show most expensive I/O process
+
+--top-io-adv::
+    show most expensive I/O process (incl. pid and other stats)
 
 --top-latency::
     show process with highest total latency (in ms)

Modified: trunk/tools/dstat/dstat
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/dstat?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/dstat?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/dstat (original)
+++ trunk/tools/dstat/dstat Wed May 26 13:52:45 2010
@@ -384,25 +384,25 @@
 #                yield line
 #                i += 1
 
-    def splitlines(self, delim=None, replace=None):
+    def splitlines(self, sep=None, replace=None):
         &quot;Return split lines from any file descriptor&quot;
         for fd in self.fd:
             fd.seek(0)
             for line in fd.readlines():
-                if replace and delim:
-                    yield line.replace(replace, delim).split(delim)
+                if replace and sep:
+                    yield line.replace(replace, sep).split(sep)
                 elif replace:
                     yield line.replace(replace, ' ').split()
                 else:
-                    yield line.split(delim)
+                    yield line.split(sep)
 #        ### Implemented linecache (for top-plugins) but slows down normal plugins
 #        for fd in self.fd:
-#                if replace and delim:
-#                    yield line.replace(replace, delim).split(delim)
+#                if replace and sep:
+#                    yield line.replace(replace, sep).split(sep)
 #                elif replace:
 #                    yield line.replace(replace, ' ').split()
 #                else:
-#                    yield line.split(delim)
+#                    yield line.split(sep)
 #                i += 1
 
     def statwidth(self):
@@ -492,6 +492,8 @@
     def show(self):
         &quot;Display stat results&quot;
         line = ''
+        if hasattr(self, 'output'):
+            return cprint(self.output, self.type, self.width, self.scale)
         for i, name in enumerate(self.vars):
             if isinstance(self.val[name], types.TupleType) or isinstance(self.val[name], types.ListType):
                 line = line + cprintlist(self.val[name], self.type, self.width, self.scale)
@@ -652,10 +654,10 @@
     def name(self):
         ret = []
         for name in self.vars:
-            if name:
+            if name == 'total':
+                ret.append('cpu usage')
+            else:
                 ret.append('cpu' + name)
-            else:
-                ret.append('cpu total')
         return ret
 
     def extract(self):
@@ -673,7 +675,7 @@
     def __init__(self):
         self.nick = ('read', 'writ')
         self.type = 'd'
-        self.diskfilter = re.compile('^(dm-[0-9]+|md[0-9]+|[hsv]d[a-z]+[0-9]+)$')
+        self.diskfilter = re.compile('^(dm-\d+|md\d+|[hsv]d[a-z]+\d+)$')
         self.open('/proc/diskstats')
         self.cols = 2
 
@@ -697,10 +699,9 @@
             varlist = ('total',)
         else:
             varlist = []
-            blockdevices = [os.path.basename(filename) for filename in glob.glob('/sys/block/*')]
             for name in self.discover:
                 if self.diskfilter.match(name): continue
-                if name not in blockdevices: continue
+                if name not in blockdevices(): continue
                 varlist.append(name)
 #           if len(varlist) &gt; 2: varlist = varlist[0:2]
             varlist.sort()
@@ -710,7 +711,7 @@
         return ret
 
     def name(self):
-        return ['dsk/'+name for name in self.vars]
+        return ['dsk/'+sysfs_dev(name) for name in self.vars]
 
     def extract(self):
         for name in self.vars: self.set2[name] = (0, 0)
@@ -740,7 +741,7 @@
     def __init__(self):
         self.nick = ('read', 'writ')
         self.type = 'd'
-        self.diskfilter = re.compile('(dm-[0-9]+|md[0-9]+|[hsv]d[a-z]+[0-9]+)')
+        self.diskfilter = re.compile('(dm-\d+|md\d+|[hsv]d[a-z]+\d+)')
         self.open('/proc/partitions')
         if self.fd and not self.discover:
             raise Exception, 'Kernel is not compiled with CONFIG_BLK_STATS'
@@ -805,7 +806,7 @@
     def __init__(self):
         self.nick = ('read', 'writ')
         self.type = 'd'
-        self.diskfilter = re.compile('(dm-[0-9]+|md[0-9]+|[hsv]d[a-z]+[0-9]+)')
+        self.diskfilter = re.compile('(dm-\d+|md\d+|[hsv]d[a-z]+\d+)')
         self.regexp = re.compile('^\((\d+),(\d+)\):\(\d+,\d+,(\d+),\d+,(\d+)\)$')
         self.open('/proc/stat')
         self.cols = 2
@@ -1054,7 +1055,7 @@
         self.type = 'f'
         self.width = 5
         self.scale = 1000
-        self.diskfilter = re.compile('(dm-[0-9]+|md[0-9]+|[hsv]d[a-z]+[0-9]+)')
+        self.diskfilter = re.compile('(dm-\d+|md\d+|[hsv]d[a-z]+\d+)')
         self.open('/proc/diskstats')
         self.cols = 3
 
@@ -1078,10 +1079,9 @@
             varlist = ('total',)
         else:
             varlist = []
-            blockdevices = [os.path.basename(filename) for filename in glob.glob('/sys/block/*')]
             for name in self.discover:
                 if self.diskfilter.match(name): continue
-                if name not in blockdevices: continue
+                if name not in blockdevices(): continue
                 varlist.append(name)
 #           if len(varlist) &gt; 2: varlist = varlist[0:2]
             varlist.sort()
@@ -1160,14 +1160,10 @@
         for name in self.vars: self.val[name] = 0
         for l in self.splitlines():
             if len(l) &lt; 4: continue
-            if l[1] == 'POSIX':
-                self.val['posix'] = self.val['posix'] + 1
-            elif l[1] == 'FLOCK':
-                self.val['flock'] = self.val['flock'] + 1
-            if l[3] == 'READ':
-                self.val['read'] = self.val['read'] + 1
-            elif l[3] == 'WRITE':
-                self.val['write'] = self.val['write'] + 1
+            if l[1] == 'POSIX': self.val['posix'] += 1
+            elif l[1] == 'FLOCK': self.val['flock'] += 1
+            if l[3] == 'READ': self.val['read'] += 1
+            elif l[3] == 'WRITE': self.val['write'] += 1
 
 class dstat_mem(dstat):
     def __init__(self):
@@ -1188,7 +1184,7 @@
     def __init__(self):
         self.nick = ('recv', 'send')
         self.type = 'd'
-        self.totalfilter = re.compile('^(lo|bond[0-9]+|face|.+\.[0-9]+)$')
+        self.totalfilter = re.compile('^(lo|bond\d+|face|.+\.\d+)$')
         self.open('/proc/net/dev')
         self.cols = 2
 
@@ -1240,6 +1236,8 @@
                     (self.set2[name][0] - self.set1[name][0]) * 1.0 / elapsed,
                     (self.set2[name][1] - self.set1[name][1]) * 1.0 / elapsed,
                  )
+                if self.val[name][0] &lt; 0: self.val[name][0] += maxint + 1
+                if self.val[name][1] &lt; 0: self.val[name][1] += maxint + 1
         if step == op.delay:
             self.set1.update(self.set2)
 
@@ -1451,13 +1449,12 @@
             ### 01: established, 02: syn_sent,  03: syn_recv, 04: fin_wait1,
             ### 05: fin_wait2,   06: time_wait, 07: close,    08: close_wait,
             ### 09: last_ack,    0A: listen,    0B: closing
-            if l[3] in ('0A',): self.val['listen'] = self.val['listen'] + 1
-            elif l[3] in ('01',): self.val['established'] = self.val['established'] + 1
-            elif l[3] in ('02', '03', '09',): self.val['syn'] = self.val['syn'] + 1
-            elif l[3] in ('06',): self.val['wait'] = self.val['wait'] + 1
-            elif l[3] in ('04', '05', '07', '08', '0B',): self.val['close'] = self.val['close'] + 1
-
-### FIXME: If timefmt &lt; len(self.nick) output is fucked up
+            if l[3] in ('0A',): self.val['listen'] += 1
+            elif l[3] in ('01',): self.val['established'] += 1
+            elif l[3] in ('02', '03', '09',): self.val['syn'] += 1
+            elif l[3] in ('06',): self.val['wait'] += 1
+            elif l[3] in ('04', '05', '07', '08', '0B',): self.val['close'] += 1
+
 class dstat_time(dstat):
     def __init__(self):
         self.name = 'system'
@@ -1468,7 +1465,6 @@
         else:
             self.width = len(time.strftime(self.timefmt, time.localtime()))
         self.scale = 0
-        self.nick = ('date/time',)
         self.vars = ('time',)
 
     ### We are now using the starttime for this plugin, not the execution time of this plugin
@@ -1491,8 +1487,8 @@
     def extract(self):
         for name in self.vars: self.val[name] = 0
         for l in self.splitlines():
-            if l[3] == '07': self.val['listen'] = self.val['listen'] + 1
-            elif l[3] == '01': self.val['established'] = self.val['established'] + 1
+            if l[3] == '07': self.val['listen'] += 1
+            elif l[3] == '01': self.val['established'] += 1
 
 class dstat_unix(dstat):
     def __init__(self):
@@ -1507,14 +1503,11 @@
     def extract(self):
         for name in self.vars: self.val[name] = 0
         for l in self.splitlines():
-            if l[4] == '0002':
-                self.val['datagram'] = self.val['datagram'] + 1
+            if l[4] == '0002': self.val['datagram'] += 1
             elif l[4] == '0001':
-                self.val['stream'] = self.val['stream'] + 1
-                if l[5] == '01':
-                    self.val['listen'] = self.val['listen'] + 1
-                elif l[5] == '03':
-                    self.val['established'] = self.val['established'] + 1
+                self.val['stream'] += 1
+                if l[5] == '01': self.val['listen'] += 1
+                elif l[5] == '03': self.val['established'] += 1
 
 class dstat_vm(dstat):
     def __init__(self):
@@ -1691,7 +1684,8 @@
 
 def dpopen(cmd):
     &quot;Open a pipe for reuse, if already opened, return pipes&quot;
-    global pipes
+    global pipes, select
+    import select
     if 'pipes' not in globals().keys(): pipes = {}
     if cmd not in pipes.keys():
         pipes[cmd] = os.popen3(cmd, 't', 0)
@@ -1741,6 +1735,21 @@
         raise Exception, 'Nothing found during matchpipe data collection'
     return None
 
+def cmd_test(cmd):
+    pipes = os.popen3(cmd, 't', 0)
+    for line in pipes[2].readlines():
+        raise Exception, line.strip()
+
+def cmd_readlines(cmd):
+    pipes = os.popen3(cmd, 't', 0)
+    for line in pipes[1].readlines():
+       yield line
+
+def cmd_splitlines(cmd, sep=None):
+    pipes = os.popen3(cmd, 't', 0)
+    for line in pipes[1].readlines():
+       yield line.split(sep)
+
 def proc_readlines(filename):
     &quot;Return the lines of a file, one by one&quot;
 #    for line in open(filename).readlines():
@@ -1754,17 +1763,17 @@
         yield line
         i += 1
 
-def proc_splitlines(filename):
+def proc_splitlines(filename, sep=None):
     &quot;Return the splitted lines of a file, one by one&quot;
 #    for line in open(filename).readlines():
-#       yield line.split()
+#       yield line.split(sep)
 
     ### Implemented linecache (for top-plugins)
     i = 1
     while True:
         line = linecache.getline(filename, i);
         if not line: break
-        yield line.split()
+        yield line.split(sep)
         i += 1
 
 def proc_readline(filename):
@@ -1772,10 +1781,10 @@
 #    return open(filename).read()
     return linecache.getline(filename, 1)
 
-def proc_splitline(filename):
+def proc_splitline(filename, sep=None):
     &quot;Return the first line of a file splitted&quot;
-#    return open(filename).read().split()
-    return linecache.getline(filename, 1).split()
+#    return open(filename).read().split(sep)
+    return linecache.getline(filename, 1).split(sep)
 
 ### FIXME: Should we cache this within every step ?
 def proc_pidlist():
@@ -2066,16 +2075,24 @@
         raise &quot;Problem finding number of CPUs in system.&quot;
     return cpunr
 
+def blockdevices():
+    ### We have to replace '!' by '/' to support cciss!c0d0 type devices :-/
+    return [os.path.basename(filename).replace('!', '/') for filename in glob.glob('/sys/block/*')]
+
 ### FIXME: Add scsi support too and improve
 def sysfs_dev(device):
     &quot;Convert sysfs device names into device names&quot;
-    m = re.match('ide/host([0-9])/bus([0-9])/target([0-9])/lun([0-9])/disc', device)
+    m = re.match('ide/host(\d)/bus(\d)/target(\d)/lun(\d)/disc', device)
     if m:
         l = m.groups()
         # ide/host0/bus0/target0/lun0/disc -&gt; 0 -&gt; hda
         # ide/host0/bus1/target0/lun0/disc -&gt; 2 -&gt; hdc
         nr = int(l[1]) * 2 + int(l[3])
         return 'hd' + chr(ord('a') + nr)
+    m = re.match('cciss/(c\dd\d)', device)
+    if m:
+        l = m.groups()
+        return l[0]
     m = re.match('placeholder', device)
     if m:
         return 'sdX'
@@ -2229,13 +2246,16 @@
 
 def main():
     &quot;Initialization of the program, terminal, internal structures&quot;
-    global pagesize, cpunr, hz, ansi, theme, outputfile
+    global cpunr, hz, maxint, ownpid, pagesize
+    global ansi, theme, outputfile
     global totlist, inittime
     global update, missed
 
-    pagesize = resource.getpagesize()
     cpunr = getcpunr()
     hz = os.sysconf('SC_CLK_TCK')
+    maxint = (sys.maxint + 1) * 2
+    ownpid = str(os.getpid())
+    pagesize = resource.getpagesize()
     interval = 1
 
     user = getpass.getuser()
@@ -2328,13 +2348,17 @@
                     ### Try loading python plugin
                     if description[0] in ('.py', ):
                         execfile(pathname)
-                        exec 'o = dstat_plugin(); o.filename = &quot;%s&quot;; o.check(); o.prepare(); del(dstat_plugin);' % pluginfile
+                        exec 'o = dstat_plugin(); del(dstat_plugin)'
+                        o.filename = pluginfile
+                        o.check()
+                        o.prepare()
 
                     ### Try loading C plugin (not functional yet)
                     elif description[0] == '.so':
                         exec 'import %s' % pluginfile
-                        exec 'o = %s.new(); o.check(); o.prepare();' % pluginfile
-#                        exec 'o = %s.init(dstat)' % pluginfile
+                        exec 'o = %s.new()' % pluginfile
+                        o.check()
+                        o.prepare()
 #                        print dir(o)
 #                        print o.__module__
 #                        print o.name
@@ -2342,7 +2366,9 @@
                         print &gt;&gt;sys.stderr, 'Module %s is of unknown type.' % pluginfile
 
                 else:
-                    exec 'o = %s(); o.check(); o.prepare();' % pluginfile
+                    exec 'o = %s()' % pluginfile
+                    o.check()
+                    o.prepare()
 #                print o.__module__
             except Exception, e:
                 if mod == mods[-1]:
@@ -2353,6 +2379,8 @@
                     raise
 #                tb = sys.exc_info()[2]
                 continue
+            except:
+                print &gt;&gt;sys.stderr, 'Module %s caused unknown exception' % pluginfile
 
             linewidth = linewidth + o.statwidth() + 1
             totlist.append(o)

Modified: trunk/tools/dstat/plugins/dstat_disk_tps.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_disk_tps.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_disk_tps.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_disk_tps.py (original)
+++ trunk/tools/dstat/plugins/dstat_disk_tps.py Wed May 26 13:52:45 2010
@@ -13,7 +13,7 @@
         self.nick = ('reads', 'writs' )
         self.type = 'd'
         self.scale = 1000
-        self.diskfilter = re.compile('^(dm-[0-9]+|md[0-9]+|[hsv]d[a-z]+[0-9]+)$')
+        self.diskfilter = re.compile('^(dm-\d+|md\d+|[hsv]d[a-z]+\d+)$')
         self.open('/proc/diskstats')
         self.cols = 2
 
@@ -37,10 +37,9 @@
             varlist = ('total',)
         else:
             varlist = []
-            blockdevices = [os.path.basename(filename) for filename in glob.glob('/sys/block/*')]
             for name in self.discover:
                 if self.diskfilter.match(name): continue
-                if name not in blockdevices: continue
+                if name not in blockdevices(): continue
                 varlist.append(name)
 #           if len(varlist) &gt; 2: varlist = varlist[0:2]
             varlist.sort()
@@ -50,7 +49,7 @@
         return ret
 
     def name(self):
-        return ['dsk/'+name for name in self.vars]
+        return ['dsk/'+sysfs_dev(name) for name in self.vars]
 
     def extract(self):
         for name in self.vars: self.set2[name] = (0, 0)

Modified: trunk/tools/dstat/plugins/dstat_disk_util.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_disk_util.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_disk_util.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_disk_util.py (original)
+++ trunk/tools/dstat/plugins/dstat_disk_util.py Wed May 26 13:52:45 2010
@@ -14,7 +14,7 @@
         self.type = 'f'
         self.width = 4
         self.scale = 34
-        self.diskfilter = re.compile('^(dm-[0-9]+|md[0-9]+|[hsv]d[a-z]+[0-9]+)$')
+        self.diskfilter = re.compile('^(dm-\d+|md\d+|[hsv]d[a-z]+\d+)$')
         self.open('/proc/diskstats')
         self.cols = 1
 
@@ -36,10 +36,9 @@
             varlist = op.disklist
         else:
             varlist = []
-            blockdevices = [os.path.basename(filename) for filename in glob.glob('/sys/block/*')]
             for name in self.discover:
                 if self.diskfilter.match(name): continue
-                if name not in blockdevices: continue
+                if name not in blockdevices(): continue
                 varlist.append(name)
 #           if len(varlist) &gt; 2: varlist = varlist[0:2]
             varlist.sort()
@@ -49,7 +48,7 @@
         return ret
 
     def name(self):
-        return self.vars
+        return [sysfs_dev(name) for name in self.vars]
 
     def extract(self):
         for name in self.vars: self.set2[name] = (0, )

Modified: trunk/tools/dstat/plugins/dstat_dstat.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_dstat.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_dstat.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_dstat.py (original)
+++ trunk/tools/dstat/plugins/dstat_dstat.py Wed May 26 13:52:45 2010
@@ -14,13 +14,11 @@
         self.type = 'd'
         self.width = 4
         self.scale = 100
-        self.pid = str(os.getpid())
 
     def extract(self):
         ### Extract counters
-        l = dopen('/proc/%s/schedstat' % self.pid).read().split()
+        l = dopen('/proc/%s/schedstat' % ownpid).read().split()
 #        l = linecache.getline('/proc/%s/schedstat' % self.pid, 1).split()
-
         self.set2['cputime'] = long(l[0])
         self.set2['latency'] = long(l[1])
 

Added: trunk/tools/dstat/plugins/dstat_dstat_cpu.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_dstat_cpu.py?rev=8825&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_dstat_cpu.py?rev=8825&amp;view=markup</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_dstat_cpu.py (added)
+++ trunk/tools/dstat/plugins/dstat_dstat_cpu.py Wed May 26 13:52:45 2010
@@ -1,0 +1,32 @@
+### Author: Dag Wieers &lt;dag$wieers,com&gt;
+
+class dstat_plugin(dstat):
+    &quot;&quot;&quot;
+    Provide memory information related to the dstat process.
+
+    The various values provide information about the memory usage of the
+    dstat process. This plugin gives you the possibility to follow memory
+    usage changes of dstat over time.
+    &quot;&quot;&quot;
+    def __init__(self):
+        self.name = 'dstat cputime'
+        self.vars = ('system', 'user', 'total')
+        self.type = 'd'
+        self.width = 4
+        self.scale = 100
+
+    def extract(self):
+        ### Extract counters
+        l = resource.getrusage(resource.RUSAGE_SELF)
+
+        self.set2['system'] = float(l[0])
+        self.set2['user'] = float(l[1])
+        self.set2['total'] = (float(l[0]) + float(l[1]))
+
+        for name in self.vars:
+            self.val[name] = (self.set2[name] - self.set1[name]) * 1000.0 / elapsed
+
+        if step == op.delay:
+            self.set1.update(self.set2)
+
+# vim:ts=4:sw=4:et

Added: trunk/tools/dstat/plugins/dstat_dstat_mem.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_dstat_mem.py?rev=8825&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_dstat_mem.py?rev=8825&amp;view=markup</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_dstat_mem.py (added)
+++ trunk/tools/dstat/plugins/dstat_dstat_mem.py Wed May 26 13:52:45 2010
@@ -1,0 +1,27 @@
+### Author: Dag Wieers &lt;dag$wieers,com&gt;
+
+class dstat_plugin(dstat):
+    &quot;&quot;&quot;
+    Provide memory information related to the dstat process.
+
+    The various values provide information about the memory usage of the
+    dstat process. This plugin gives you the possibility to follow memory
+    usage changes of dstat over time.
+    &quot;&quot;&quot;
+    def __init__(self):
+        self.name = 'dstat memory usage'
+        self.vars = ('virtual', 'resident', 'shared', 'data')
+        self.type = 'd'
+
+    def extract(self):
+        ### Extract counters
+        l = dopen('/proc/%s/statm' % ownpid).read().split()
+#        l = linecache.getline('/proc/%s/schedstat' % self.pid, 1).split()
+        self.val['virtual'] = long(l[0]) * pagesize / 1024
+        self.val['resident'] = long(l[1]) * pagesize / 1024
+        self.val['shared'] = long(l[2]) * pagesize / 1024
+#        self.val['text'] = long(l[3]) * pagesize / 1024
+#        self.val['library'] = long(l[4]) * pagesize / 1024
+        self.val['data'] = long(l[5]) * pagesize / 1024
+
+# vim:ts=4:sw=4:et

Modified: trunk/tools/dstat/plugins/dstat_net_packets.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_net_packets.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_net_packets.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_net_packets.py (original)
+++ trunk/tools/dstat/plugins/dstat_net_packets.py Wed May 26 13:52:45 2010
@@ -10,7 +10,7 @@
         self.type = 'f'
         self.width = 5
         self.scale = 1000
-        self.totalfilter = re.compile('^(lo|bond[0-9]+|face|.+\.[0-9]+)$')
+        self.totalfilter = re.compile('^(lo|bond\d+|face|.+\.\d+)$')
         self.open('/proc/net/dev')
         self.cols = 2
 

Modified: trunk/tools/dstat/plugins/dstat_proc_count.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_proc_count.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_proc_count.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_proc_count.py (original)
+++ trunk/tools/dstat/plugins/dstat_proc_count.py Wed May 26 13:52:45 2010
@@ -12,4 +12,4 @@
         self.scale = 10
 
     def extract(self):
-        self.val['total'] = len(glob.glob('/proc/[0-9]*'))
+        self.val['total'] = len([pid for pid in proc_pidlist()])

Added: trunk/tools/dstat/plugins/dstat_squid.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_squid.py?rev=8825&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_squid.py?rev=8825&amp;view=markup</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_squid.py (added)
+++ trunk/tools/dstat/plugins/dstat_squid.py Wed May 26 13:52:45 2010
@@ -1,0 +1,49 @@
+# Dstat plugin for measuring various squid statistics.
+# Author: Jason Friedland &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thesuperjason at gmail.com</A>&gt;
+#
+# This plugin has been tested with:
+# - Dstat 0.6.7
+# - CentOS release 5.4 (Final)
+# - Python 2.4.3
+# - Squid 2.6 and 2.7
+ 
+global squidclient_options
+squidclient_options = os.getenv('DSTAT_SQUID_OPTS') # -p 8080
+ 
+class dstat_plugin(dstat):
+    def __init__(self):
+        self.name = 'squid status'
+        self.type = 's'
+        self.width = 5
+        self.scale = 1000
+        self.vars = ('Number of file desc currently in use',
+            'CPU Usage, 5 minute avg',
+            'Total accounted',
+            'Number of clients accessing cache',
+            'Mean Object Size')
+        self.nick = ('fdesc',
+            'cpu5',
+            'mem',
+            'clnts',
+            'objsz')
+
+    def check(self):
+        if not os.access('/usr/sbin/squidclient', os.X_OK):
+            raise Exception, 'Needs squidclient binary'
+        cmd_test('/usr/sbin/squidclient %s mgr:info' % squidclient_options)
+        return True
+ 
+    def extract(self):
+        try:
+            for l in cmd_splitlines('/usr/sbin/squidclient %s mgr:info' % squidclient_options, ':'):
+                if l[0].strip() in self.vars:
+                    self.val[l[0].strip()] = l[1].strip()
+                    break
+        except IOError, e:
+            if op.debug &gt; 1: print '%s: lost pipe to squidclient, %s' % (self.filename, e)
+            for name in self.vars: self.val[name] = -1
+        except Exception, e:
+            if op.debug &gt; 1: print '%s: exception' (self.filename, e)
+            for name in self.vars: self.val[name] = -1
+
+# vim:ts=4:sw=4:et

Modified: trunk/tools/dstat/plugins/dstat_top_bio.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_bio.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_bio.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_bio.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_bio.py Wed May 26 13:52:45 2010
@@ -2,7 +2,7 @@
 
 class dstat_plugin(dstat):
     &quot;&quot;&quot;
-    Top most expesnive block I/O process.
+    Top most expensive block I/O process.
 
     Displays the name of the most expensive block I/O process.
     &quot;&quot;&quot;
@@ -12,15 +12,16 @@
         self.type = 's'
         self.width = 22
         self.scale = 0
-        self.pidset1 = {}; self.pidset2 = {}
+        self.pidset1 = {}
 
     def check(self):
         if not os.access('/proc/self/io', os.R_OK):
             raise Exception, 'Kernel has no I/O accounting, use at least 2.6.20'
 
     def extract(self):
+        self.output = ''
+        self.pidset2 = {}
         self.val['usage'] = 0.0
-        self.val['block i/o process'] = ''
         for pid in proc_pidlist():
             try:
                 ### Reset values
@@ -55,14 +56,13 @@
 #                st = os.stat(&quot;/proc/%s&quot; % pid)
 
         if step == op.delay:
-            for pid in self.pidset2.keys():
-                self.pidset1[pid].update(self.pidset2[pid])
+            self.pidset1 = self.pidset2
 
         if self.val['usage'] != 0.0:
-            self.val['block i/o process'] = '%-*s%s %s' % (self.width-11, self.val['name'][0:self.width-11], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024))
+            self.output = '%-*s%s %s' % (self.width-11, self.val['name'][0:self.width-11], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024))
 
         ### Debug (show PID)
-#        self.val['block i/o process'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
+#        self.output = '%*s %-*s%s %s' % (5, self.val['pid'], self.width-17, self.val['name'][0:self.width-17], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024))
 
     def showcsv(self):
         return '%s / %d:%d' % (self.val['name'], self.val['read_usage'], self.val['write_usage'])

Added: trunk/tools/dstat/plugins/dstat_top_bio_adv.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_bio_adv.py?rev=8825&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_bio_adv.py?rev=8825&amp;view=markup</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_bio_adv.py (added)
+++ trunk/tools/dstat/plugins/dstat_top_bio_adv.py Wed May 26 13:52:45 2010
@@ -1,0 +1,75 @@
+### Dstat all I/O process plugin
+### Displays all processes' I/O read/write stats and CPU usage
+###
+### Authority: Guillermo Cantu Luna
+
+class dstat_plugin(dstat):
+    def __init__(self):
+        self.name = 'most expensive block i/o process'
+        self.vars = ('process             pid   read:write:cpu',)
+        self.type = 's'
+        self.width = 40
+        self.scale = 0
+        self.pidset1 = {}
+
+    def check(self):
+        if not os.access('/proc/self/io', os.R_OK):
+            raise Exception, 'Kernel has no I/O accounting, use at least 2.6.20.'
+        return True
+
+    def extract(self):
+        self.output = ''
+        self.pidset2 = {}
+        self.val['usage'] = 0.0
+        for pid in proc_pidlist():
+            try:
+                ### Reset values
+                if not self.pidset2.has_key(pid):
+                    self.pidset2[pid] = {'read_bytes:': 0, 'write_bytes:': 0, 'cputime:': 0, 'cpuper:': 0}
+                if not self.pidset1.has_key(pid):
+                    self.pidset1[pid] = {'read_bytes:': 0, 'write_bytes:': 0, 'cputime:': 0, 'cpuper:': 0}
+
+                ### Extract name
+                name = proc_splitline('/proc/%s/stat' % pid)[1][1:-1]
+
+                ### Extract counters
+                for l in proc_splitlines('/proc/%s/io' % pid):
+                    if len(l) != 2: continue
+                    self.pidset2[pid][l[0]] = int(l[1])
+
+                ### Get CPU usage
+                l = proc_splitline('/proc/%s/stat' % pid)
+                if len(l) &lt; 15:
+                    cpu_usage = 0
+                else:
+                    self.pidset2[pid]['cputime:'] = int(l[13]) + int(l[14])
+                    cpu_usage = (self.pidset2[pid]['cputime:'] - self.pidset1[pid]['cputime:']) * 1.0 / elapsed / cpunr
+
+            except ValueError:
+                continue
+            except IOError:
+                continue
+            except IndexError:
+                continue
+
+            read_usage = (self.pidset2[pid]['read_bytes:'] - self.pidset1[pid]['read_bytes:']) * 1.0 / elapsed
+            write_usage = (self.pidset2[pid]['write_bytes:'] - self.pidset1[pid]['write_bytes:']) * 1.0 / elapsed
+            usage = read_usage + write_usage
+
+            ### Get the process that spends the most jiffies
+            if usage &gt; self.val['usage']:
+                self.val['usage'] = usage
+                self.val['read_usage'] = read_usage
+                self.val['write_usage'] = write_usage
+                self.val['pid'] = pid
+                self.val['name'] = getnamebypid(pid, name)
+                self.val['cpu_usage'] = cpu_usage
+
+        if step == op.delay:
+            self.pidset1 = self.pidset2
+
+        if self.val['usage'] != 0.0:
+            self.output = '%-*s%s%-5s%s:%s:%s' % (self.width-16-len(pid), self.val['name'][0:self.width-16-len(pid)], ansi['darkblue'], self.val['pid'], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024), cprint(self.val['cpu_usage'], 'f', 3, 34))
+
+    def showcsv(self):
+        return self.output + 'Top: %s\t%s\t%s\t%s' % (self.val['name'][0:self.width-20], self.val['read_usage'], self.val['write_usage'], self.val['cpu_usage'])

Modified: trunk/tools/dstat/plugins/dstat_top_childwait.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_childwait.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_childwait.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_childwait.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_childwait.py Wed May 26 13:52:45 2010
@@ -14,6 +14,7 @@
         self.scale = 0
 
     def extract(self):
+        self.set2 = {}
         self.val['max'] = 0.0
         for pid in proc_pidlist():
             try:
@@ -42,7 +43,7 @@
 #       self.val['process'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
 
         if step == op.delay:
-            self.set1.update(self.set2)
+            self.set1 = self.set2
 
     def show(self):
         if self.val['max'] == 0.0:

Modified: trunk/tools/dstat/plugins/dstat_top_cpu.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_cpu.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_cpu.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_cpu.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_cpu.py Wed May 26 13:52:45 2010
@@ -14,11 +14,12 @@
         self.type = 's'
         self.width = 16
         self.scale = 0
-        self.pidset1 = {}; self.pidset2 = {}
+        self.pidset1 = {}
 
     def extract(self):
+        self.output = ''
+        self.pidset2 = {}
         self.val['max'] = 0.0
-        self.val['cpu process'] = ''
         for pid in proc_pidlist():
             try:
                 ### Using dopen() will cause too many open files
@@ -46,13 +47,13 @@
 #            self.val['name'] = name
 
         if self.val['max'] != 0.0:
-            self.val['cpu process'] = '%-*s%s' % (self.width-3, self.val['name'][0:self.width-3], cprint(self.val['max'], 'f', 3, 34))
+            self.output = '%-*s%s' % (self.width-3, self.val['name'][0:self.width-3], cprint(self.val['max'], 'f', 3, 34))
 
         ### Debug (show PID)
-#        self.val['cpu process'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
+#        self.output = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
 
         if step == op.delay:
-            self.pidset1.update(self.pidset2)
+            self.pidset1 = self.pidset2
 
     def showcsv(self):
         return '%s / %d%%' % (self.val['name'], self.val['max'])

Added: trunk/tools/dstat/plugins/dstat_top_cpu_adv.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_cpu_adv.py?rev=8825&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_cpu_adv.py?rev=8825&amp;view=markup</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_cpu_adv.py (added)
+++ trunk/tools/dstat/plugins/dstat_top_cpu_adv.py Wed May 26 13:52:45 2010
@@ -1,0 +1,73 @@
+### Dstat all I/O process plugin
+### Displays all processes' I/O read/write stats and CPU usage
+###
+### Authority: Guillermo Cantu Luna
+
+class dstat_plugin(dstat):
+    def __init__(self):
+        self.name = 'most expensive cpu process'
+        self.vars = ('process              pid  cpu read write',)
+        self.type = 's'
+        self.width = 40
+        self.scale = 0
+        self.pidset1 = {}
+
+    def check(self):
+        if not os.access('/proc/self/io', os.R_OK):
+            raise Exception, 'Kernel has no I/O accounting, use at least 2.6.20.'
+        return True
+
+    def extract(self):
+        self.output = ''
+        self.pidset2 = {}
+        self.val['cpu_usage'] = 0
+        for pid in proc_pidlist():
+            try:
+                ### Reset values
+                if not self.pidset2.has_key(pid):
+                    self.pidset2[pid] = {'rchar:': 0, 'wchar:': 0, 'cputime:': 0, 'cpuper:': 0}
+                if not self.pidset1.has_key(pid):
+                    self.pidset1[pid] = {'rchar:': 0, 'wchar:': 0, 'cputime:': 0, 'cpuper:': 0}
+
+                ### Extract name
+                name = proc_splitline('/proc/%s/stat' % pid)[1][1:-1]
+
+                ### Extract counters
+                for l in proc_splitlines('/proc/%s/io' % pid):
+                    if len(l) != 2: continue
+                    self.pidset2[pid][l[0]] = int(l[1])
+
+                ### Get CPU usage
+                l = proc_splitline('/proc/%s/stat' % pid)
+                if len(l) &lt; 15:
+                    cpu_usage = 0.0
+                else:
+                    self.pidset2[pid]['cputime:'] = int(l[13]) + int(l[14])
+                    cpu_usage = (self.pidset2[pid]['cputime:'] - self.pidset1[pid]['cputime:']) * 1.0 / elapsed / cpunr
+
+            except ValueError:
+                continue
+            except IOError:
+                continue
+            except IndexError:
+                continue
+
+            read_usage = (self.pidset2[pid]['rchar:'] - self.pidset1[pid]['rchar:']) * 1.0 / elapsed
+            write_usage = (self.pidset2[pid]['wchar:'] - self.pidset1[pid]['wchar:']) * 1.0 / elapsed
+
+            ### Get the process that spends the most jiffies
+            if cpu_usage &gt; self.val['cpu_usage']:
+                self.val['read_usage'] = read_usage
+                self.val['write_usage'] = write_usage
+                self.val['pid'] = pid
+                self.val['name'] = getnamebypid(pid, name)
+                self.val['cpu_usage'] = cpu_usage
+
+        if step == op.delay:
+            self.pidset1 = self.pidset2
+
+        if self.val['cpu_usage'] != 0.0:
+            self.output = '%-*s%s%-5s%s%s%%%s%s' % (self.width-15-len(pid), self.val['name'][0:self.width-15-len(pid)], ansi['darkblue'], self.val['pid'], cprint(self.val['cpu_usage'], 'f', 3, 34), ansi['darkgray'],cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024))
+
+    def showcsv(self):
+        return self.output + 'Top: %s\t%s\t%s\t%s' % (self.val['name'][0:self.width-20], self.val['cpu_usage'], self.val['read_usage'], self.val['write_usage'])

Modified: trunk/tools/dstat/plugins/dstat_top_cputime.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_cputime.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_cputime.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_cputime.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_cputime.py Wed May 26 13:52:45 2010
@@ -18,15 +18,16 @@
         self.type = 's'
         self.width = 17
         self.scale = 0
-        self.pidset1 = {}; self.pidset2 = {}
+        self.pidset1 = {}
 
     def check(self):
         if not os.access('/proc/self/schedstat', os.R_OK):
             raise Exception, 'Kernel has no scheduler statistics, use at least 2.6.12'
 
     def extract(self):
+        self.output = ''
+        self.pidset2 = {}
         self.val['result'] = 0
-        self.val['cputime process'] = ''
         for pid in proc_pidlist():
             try:
                 ### Reset values
@@ -56,14 +57,13 @@
                 self.val['name'] = getnamebypid(pid, name)
 
         if step == op.delay:
-            for pid in self.pidset2.keys():
-                self.pidset1[pid].update(self.pidset2[pid])
+            self.pidset1 = self.pidset2
 
         if self.val['result'] != 0.0:
-            self.val['cputime process'] = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['result'], 'd', 4, 100))
+            self.output = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['result'], 'd', 4, 100))
 
         ### Debug (show PID)
-#       self.val['cputime process'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
+#       self.output = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
 
     def showcsv(self):
         return '%s / %.4f' % (self.val['name'], self.val['result'])

Modified: trunk/tools/dstat/plugins/dstat_top_cputime_avg.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_cputime_avg.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_cputime_avg.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_cputime_avg.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_cputime_avg.py Wed May 26 13:52:45 2010
@@ -22,15 +22,16 @@
         self.type = 's'
         self.width = 17
         self.scale = 0
-        self.pidset1 = {}; self.pidset2 = {}
+        self.pidset1 = {}
 
     def check(self):
         if not os.access('/proc/self/schedstat', os.R_OK):
             raise Exception, 'Kernel has no scheduler statistics, use at least 2.6.12'
 
     def extract(self):
+        self.output = ''
+        self.pidset2 = {}
         self.val['result'] = 0
-        self.val['cputime process'] = ''
         for pid in proc_pidlist():
             try:
                 ### Reset values
@@ -63,14 +64,13 @@
                 self.val['name'] = getnamebypid(pid, name)
 
         if step == op.delay:
-            for pid in self.pidset2.keys():
-                self.pidset1[pid].update(self.pidset2[pid])
+            self.pidset1 = self.pidset2
 
         if self.val['result'] != 0.0:
-            self.val['cputime process'] = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['result'], 'f', 4, 100))
+            self.output = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['result'], 'f', 4, 100))
 
         ### Debug (show PID)
-#       self.val['cputime process'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
+#       self.output = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
 
     def showcsv(self):
         return '%s / %.4f' % (self.val['name'], self.val['result'])

Modified: trunk/tools/dstat/plugins/dstat_top_io.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_io.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_io.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_io.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_io.py Wed May 26 13:52:45 2010
@@ -1,24 +1,27 @@
-### Dstat most expensive I/O process plugin
-### Displays the name of the most expensive I/O process
-###
-### Authority: <A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>
+### Author: Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt;
 
 class dstat_plugin(dstat):
+    &quot;&quot;&quot;
+    Top most expensive I/O process
+
+    Displays the name of the most expensive I/O process
+    &quot;&quot;&quot;
     def __init__(self):
         self.name = 'most expensive'
         self.vars = ('i/o process',)
         self.type = 's'
         self.width = 22
         self.scale = 0
-        self.pidset1 = {}; self.pidset2 = {}
+        self.pidset1 = {}
 
     def check(self):
         if not os.access('/proc/self/io', os.R_OK):
             raise Exception, 'Kernel has no I/O accounting, use at least 2.6.20'
 
     def extract(self):
+        self.output = ''
+        self.pidset2 = {}
         self.val['usage'] = 0.0
-        self.val['i/o process'] = ''
         for pid in proc_pidlist():
             try:
                 ### Reset values
@@ -54,14 +57,13 @@
                 self.val['name'] = getnamebypid(pid, name)
 
         if step == op.delay:
-            for pid in self.pidset2.keys():
-                self.pidset1[pid].update(self.pidset2[pid])
+            self.pidset1 = self.pidset2
 
         if self.val['usage'] != 0.0:
-            self.val['i/o process'] = '%-*s%s %s' % (self.width-11, self.val['name'][0:self.width-11], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024))
+            self.output = '%-*s%s %s' % (self.width-11, self.val['name'][0:self.width-11], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024))
 
         ### Debug (show PID)
-#        self.val['i/o process'] = '%*s %-*s%s %s' % (5, self.val['pid'], self.width-17, self.val['name'][0:self.width-17], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024))
+#        self.output = '%*s %-*s%s %s' % (5, self.val['pid'], self.width-17, self.val['name'][0:self.width-17], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024))
 
     def showcsv(self):
         return '%s / %d:%d' % (self.val['name'], self.val['read_usage'], self.val['write_usage'])

Added: trunk/tools/dstat/plugins/dstat_top_io_adv.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_io_adv.py?rev=8825&amp;view=markup">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_io_adv.py?rev=8825&amp;view=markup</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_io_adv.py (added)
+++ trunk/tools/dstat/plugins/dstat_top_io_adv.py Wed May 26 13:52:45 2010
@@ -1,0 +1,75 @@
+### Dstat all I/O process plugin
+### Displays all processes' I/O read/write stats and CPU usage
+###
+### Authority: Guillermo Cantu Luna
+
+class dstat_plugin(dstat):
+    def __init__(self):
+        self.name = 'most expensive i/o process'
+        self.vars = ('process              pid  read write cpu',)
+        self.type = 's'
+        self.width = 40
+        self.scale = 0
+        self.pidset1 = {}
+
+    def check(self):
+        if not os.access('/proc/self/io', os.R_OK):
+            raise Exception, 'Kernel has no I/O accounting, use at least 2.6.20.'
+        return True
+
+    def extract(self):
+        self.output = ''
+        self.pidset2 = {}
+        self.val['usage'] = 0.0
+        for pid in proc_pidlist():
+            try:
+                ### Reset values
+                if not self.pidset2.has_key(pid):
+                    self.pidset2[pid] = {'rchar:': 0, 'wchar:': 0, 'cputime:': 0, 'cpuper:': 0}
+                if not self.pidset1.has_key(pid):
+                    self.pidset1[pid] = {'rchar:': 0, 'wchar:': 0, 'cputime:': 0, 'cpuper:': 0}
+
+                ### Extract name
+                name = proc_splitline('/proc/%s/stat' % pid)[1][1:-1]
+
+                ### Extract counters
+                for l in proc_splitlines('/proc/%s/io' % pid):
+                    if len(l) != 2: continue
+                    self.pidset2[pid][l[0]] = int(l[1])
+
+                ### Get CPU usage
+                l = proc_splitline('/proc/%s/stat' % pid)
+                if len(l) &lt; 15:
+                    cpu_usage = 0
+                else:
+                    self.pidset2[pid]['cputime:'] = int(l[13]) + int(l[14])
+                    cpu_usage = (self.pidset2[pid]['cputime:'] - self.pidset1[pid]['cputime:']) * 1.0 / elapsed / cpunr
+
+            except ValueError:
+                continue
+            except IOError:
+                continue
+            except IndexError:
+                continue
+
+            read_usage = (self.pidset2[pid]['rchar:'] - self.pidset1[pid]['rchar:']) * 1.0 / elapsed
+            write_usage = (self.pidset2[pid]['wchar:'] - self.pidset1[pid]['wchar:']) * 1.0 / elapsed
+            usage = read_usage + write_usage
+
+            ### Get the process that spends the most jiffies
+            if usage &gt; self.val['usage']:
+                self.val['usage'] = usage
+                self.val['read_usage'] = read_usage
+                self.val['write_usage'] = write_usage
+                self.val['pid'] = pid
+                self.val['name'] = getnamebypid(pid, name)
+                self.val['cpu_usage'] = cpu_usage
+
+        if step == op.delay:
+            self.pidset1 = self.pidset2
+
+        if self.val['usage'] != 0.0:
+            self.output = '%-*s%s%-5s%s%s%s%s%%' % (self.width-15-len(pid), self.val['name'][0:self.width-15-len(pid)], ansi['darkblue'], self.val['pid'], cprint(self.val['read_usage'], 'd', 5, 1024), cprint(self.val['write_usage'], 'd', 5, 1024), cprint(self.val['cpu_usage'], 'f', 3, 34), ansi['darkgray'])
+
+    def showcsv(self):
+        return self.val['i/o process'] + 'Top: %s\t%s\t%s\t%s' % (self.val['name'][0:self.width-20], self.val['read_usage'], self.val['write_usage'], self.val['cpu_usage'])

Modified: trunk/tools/dstat/plugins/dstat_top_latency.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_latency.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_latency.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_latency.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_latency.py Wed May 26 13:52:45 2010
@@ -19,15 +19,16 @@
         self.type = 's'
         self.width = 17
         self.scale = 0
-        self.pidset1 = {}; self.pidset2 = {}
+        self.pidset1 = {}
 
     def check(self):
         if not os.access('/proc/self/schedstat', os.R_OK):
             raise Exception, 'Kernel has no scheduler statistics, use at least 2.6.12'
 
     def extract(self):
+        self.output = ''
+        self.pidset2 = {}
         self.val['result'] = 0
-        self.val['latency process'] = ''
         for pid in proc_pidlist():
             try:
                 ### Reset values
@@ -57,14 +58,13 @@
                 self.val['name'] = getnamebypid(pid, name)
 
         if step == op.delay:
-            for pid in self.pidset2.keys():
-                self.pidset1[pid].update(self.pidset2[pid])
+            self.pidset1 = self.pidset2
 
         if self.val['result'] != 0.0:
-            self.val['latency process'] = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['result'], 'd', 4, 100))
+            self.output = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['result'], 'd', 4, 100))
 
         ### Debug (show PID)
-#       self.val['latency process'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
+#       self.output = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
 
     def showcsv(self):
         return '%s / %.4f' % (self.val['name'], self.val['result'])

Modified: trunk/tools/dstat/plugins/dstat_top_latency_avg.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_latency_avg.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_latency_avg.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_latency_avg.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_latency_avg.py Wed May 26 13:52:45 2010
@@ -13,15 +13,16 @@
         self.type = 's'
         self.width = 17
         self.scale = 0
-        self.pidset1 = {}; self.pidset2 = {}
+        self.pidset1 = {}
 
     def check(self):
         if not os.access('/proc/self/schedstat', os.R_OK):
             raise Exception, 'Kernel has no scheduler statistics, use at least 2.6.12'
 
     def extract(self):
+        self.output = ''
+        self.pidset2 = {}
         self.val['result'] = 0
-        self.val['latency process'] = ''
         for pid in proc_pidlist():
             try:
                 ### Reset values
@@ -54,14 +55,13 @@
                 self.val['name'] = getnamebypid(pid, name)
 
         if step == op.delay:
-            for pid in self.pidset2.keys():
-                self.pidset1[pid].update(self.pidset2[pid])
+            self.pidset1 = self.pidset2
 
         if self.val['result'] != 0.0:
-            self.val['latency process'] = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['result'], 'f', 4, 100))
+            self.output = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['result'], 'f', 4, 100))
 
         ### Debug (show PID)
-#       self.val['latency process'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
+#       self.output = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
 
     def showcsv(self):
         return '%s / %.4f' % (self.val['name'], self.val['result'])

Modified: trunk/tools/dstat/plugins/dstat_top_mem.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_mem.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_mem.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_mem.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_mem.py Wed May 26 13:52:45 2010
@@ -34,7 +34,7 @@
             self.val['name'] = getnamebypid(pid, l[1][1:-1])
             self.val['pid'] = pid
 
-        self.val['memory process'] = '%-*s%s' % (self.width-5, self.val['name'][0:self.width-5], cprint(self.val['max'], 'f', 5, 1024))
+        self.output = '%-*s%s' % (self.width-5, self.val['name'][0:self.width-5], cprint(self.val['max'], 'f', 5, 1024))
 
         ### Debug (show PID)
 #       self.val['memory process'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])

Modified: trunk/tools/dstat/plugins/dstat_top_oom.py
URL: <A HREF="http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_oom.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff">http://svn.rpmforge.net/viewvc/rpmforge/trunk/tools/dstat/plugins/dstat_top_oom.py?rev=8825&amp;r1=8824&amp;r2=8825&amp;view=diff</A>
==============================================================================
--- trunk/tools/dstat/plugins/dstat_top_oom.py (original)
+++ trunk/tools/dstat/plugins/dstat_top_oom.py Wed May 26 13:52:45 2010
@@ -19,8 +19,8 @@
             raise Exception, 'Kernel does not support /proc/pid/oom_score, use at least 2.6.11.'
 
     def extract(self):
+        self.output = ''
         self.val['max'] = 0.0
-        self.val['kill score'] = ''
         for pid in proc_pidlist():
             try:
                 ### Extract name
@@ -44,10 +44,10 @@
             self.val['pid'] = pid
 
         if self.val['max'] != 0.0:
-            self.val['kill score'] = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['max'], 'f', 4, 1000))
+            self.output = '%-*s%s' % (self.width-4, self.val['name'][0:self.width-4], cprint(self.val['max'], 'f', 4, 1000))
 
         ### Debug (show PID)
-#       self.val['kill score'] = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
+#       self.output = '%*s %-*s' % (5, self.val['pid'], self.width-6, self.val['name'])
 
     def showcsv(self):
         return '%s / %d%%' % (self.val['name'], self.val['max'])


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007619.html">[svn] r8824 -	/trunk/rpms/perl-Image-ExifTool/perl-Image-ExifTool.spec
</A></li>
	<LI>Next message: <A HREF="007621.html">[svn] r8826 - /trunk/tools/dstat/plugins/dstat_dstat_cpu.py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7620">[ date ]</a>
              <a href="thread.html#7620">[ thread ]</a>
              <a href="subject.html#7620">[ subject ]</a>
              <a href="author.html#7620">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
