<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [SVN] r2095 - in trunk/rpms: ipw2100-firmware kernel-module-ipw2100	kernel-module-qc-usb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5BSVN%5D%20r2095%20-%20in%20trunk/rpms%3A%20ipw2100-firmware%20kernel-module-ipw2100%0A%09kernel-module-qc-usb&In-Reply-To=%3C20040825150115.2B2DE17F74%40web22.us.megagiga.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000900.html">
   <LINK REL="Next"  HREF="000902.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[SVN] r2095 - in trunk/rpms: ipw2100-firmware kernel-module-ipw2100	kernel-module-qc-usb</H1>
    <B>svn-commits at rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5BSVN%5D%20r2095%20-%20in%20trunk/rpms%3A%20ipw2100-firmware%20kernel-module-ipw2100%0A%09kernel-module-qc-usb&In-Reply-To=%3C20040825150115.2B2DE17F74%40web22.us.megagiga.com%3E"
       TITLE="[SVN] r2095 - in trunk/rpms: ipw2100-firmware kernel-module-ipw2100	kernel-module-qc-usb">svn-commits at rpmforge.net
       </A><BR>
    <I>Wed Aug 25 17:01:15 CEST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000900.html">[SVN] r2094 - in trunk/rpms: denemo devhelp distcc drivel tinc	tinyca tvtime xkobo zenity
</A></li>
        <LI>Next message: <A HREF="000902.html">[SVN] r2096 - trunk/rpms/pearpc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#901">[ date ]</a>
              <a href="thread.html#901">[ thread ]</a>
              <a href="subject.html#901">[ subject ]</a>
              <a href="author.html#901">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dude
Date: 2004-08-25 17:01:13 +0200 (Wed, 25 Aug 2004)
New Revision: 2095

Added:
   trunk/rpms/kernel-module-ipw2100/ieee802_11.h
   trunk/rpms/kernel-module-ipw2100/ipw2100-0.53-autotools.patch
   trunk/rpms/kernel-module-ipw2100/ipw2100-0.53-vfs_read_2.patch
   trunk/rpms/kernel-module-qc-usb/qc-usb-0.6.1-autotools.patch
Removed:
   trunk/rpms/kernel-module-ipw2100/ipw2100.autotools.patch
   trunk/rpms/kernel-module-qc-usb/qc-usb.autotools.patch
Modified:
   trunk/rpms/ipw2100-firmware/ipw2100-firmware.spec
   trunk/rpms/kernel-module-ipw2100/kernel-module-ipw2100.spec
   trunk/rpms/kernel-module-qc-usb/kernel-module-qc-usb.spec
Log:
Updates.


Modified: trunk/rpms/ipw2100-firmware/ipw2100-firmware.spec
===================================================================
--- trunk/rpms/ipw2100-firmware/ipw2100-firmware.spec	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/ipw2100-firmware/ipw2100-firmware.spec	2004-08-25 15:01:13 UTC (rev 2095)
@@ -1,16 +1,16 @@
 # $Id$
 # Authority: matthias
-
 # Dist: nodist
 
 Summary: Firmware for Intel&#174; PRO/Wireless 2100 network adaptors
 Name: ipw2100-firmware
-Version: 1.1
+Version: 1.2
 Release: 1
 License: Distributable
 Group: System Environment/Kernel
 URL: <A HREF="http://ipw2100.sourceforge.net/firmware.php">http://ipw2100.sourceforge.net/firmware.php</A>
-Source0: <A HREF="http://cache-www.intel.com/cd/00/00/09/63/96377_96377.zip">http://cache-www.intel.com/cd/00/00/09/63/96377_96377.zip</A>
+# Full path not available because of the end user agreement
+Source: ipw2100-fw-1.2.tgz
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
 BuildArch: noarch
 
@@ -52,6 +52,9 @@
 
 
 %changelog
+* Wed Aug 25 2004 Matthias Saou &lt;<A HREF="http://freshrpms.net">http://freshrpms.net</A>&gt; 1.2-1
+- Update to 1.2.
+
 * Wed Jun 16 2004 Matthias Saou &lt;<A HREF="http://freshrpms.net">http://freshrpms.net</A>&gt; 1.1-1
 - Cosmetic spec file changes.
 

Added: trunk/rpms/kernel-module-ipw2100/ieee802_11.h
===================================================================
--- trunk/rpms/kernel-module-ipw2100/ieee802_11.h	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/kernel-module-ipw2100/ieee802_11.h	2004-08-25 15:01:13 UTC (rev 2095)
@@ -0,0 +1,79 @@
+#ifndef _IEEE802_11_H
+#define _IEEE802_11_H
+
+#define IEEE802_11_DATA_LEN		2304
+/* Maximum size for the MA-UNITDATA primitive, 802.11 standard section
+   6.2.1.1.2.
+
+   The figure in section 7.1.2 suggests a body size of up to 2312
+   bytes is allowed, which is a bit confusing, I suspect this
+   represents the 2304 bytes of real data, plus a possible 8 bytes of
+   WEP IV and ICV. (this interpretation suggested by Ramiro Barreiro) */
+
+
+#define IEEE802_11_HLEN			30
+#define IEEE802_11_FRAME_LEN		(IEEE802_11_DATA_LEN + IEEE802_11_HLEN)
+
+struct ieee802_11_hdr {
+	u16 frame_ctl;
+	u16 duration_id;
+	u8 addr1[ETH_ALEN];
+	u8 addr2[ETH_ALEN];
+	u8 addr3[ETH_ALEN];
+	u16 seq_ctl;
+	u8 addr4[ETH_ALEN];
+} __attribute__ ((packed));
+
+/* Frame control field constants */
+#define IEEE802_11_FCTL_VERS		0x0002
+#define IEEE802_11_FCTL_FTYPE		0x000c
+#define IEEE802_11_FCTL_STYPE		0x00f0
+#define IEEE802_11_FCTL_TODS		0x0100
+#define IEEE802_11_FCTL_FROMDS		0x0200
+#define IEEE802_11_FCTL_MOREFRAGS	0x0400
+#define IEEE802_11_FCTL_RETRY		0x0800
+#define IEEE802_11_FCTL_PM		0x1000
+#define IEEE802_11_FCTL_MOREDATA	0x2000
+#define IEEE802_11_FCTL_WEP		0x4000
+#define IEEE802_11_FCTL_ORDER		0x8000
+
+#define IEEE802_11_FTYPE_MGMT		0x0000
+#define IEEE802_11_FTYPE_CTL		0x0004
+#define IEEE802_11_FTYPE_DATA		0x0008
+
+/* management */
+#define IEEE802_11_STYPE_ASSOC_REQ	0x0000
+#define IEEE802_11_STYPE_ASSOC_RESP 	0x0010
+#define IEEE802_11_STYPE_REASSOC_REQ	0x0020
+#define IEEE802_11_STYPE_REASSOC_RESP	0x0030
+#define IEEE802_11_STYPE_PROBE_REQ	0x0040
+#define IEEE802_11_STYPE_PROBE_RESP	0x0050
+#define IEEE802_11_STYPE_BEACON		0x0080
+#define IEEE802_11_STYPE_ATIM		0x0090
+#define IEEE802_11_STYPE_DISASSOC	0x00A0
+#define IEEE802_11_STYPE_AUTH		0x00B0
+#define IEEE802_11_STYPE_DEAUTH		0x00C0
+
+/* control */
+#define IEEE802_11_STYPE_PSPOLL		0x00A0
+#define IEEE802_11_STYPE_RTS		0x00B0
+#define IEEE802_11_STYPE_CTS		0x00C0
+#define IEEE802_11_STYPE_ACK		0x00D0
+#define IEEE802_11_STYPE_CFEND		0x00E0
+#define IEEE802_11_STYPE_CFENDACK	0x00F0
+
+/* data */
+#define IEEE802_11_STYPE_DATA		0x0000
+#define IEEE802_11_STYPE_DATA_CFACK	0x0010
+#define IEEE802_11_STYPE_DATA_CFPOLL	0x0020
+#define IEEE802_11_STYPE_DATA_CFACKPOLL	0x0030
+#define IEEE802_11_STYPE_NULLFUNC	0x0040
+#define IEEE802_11_STYPE_CFACK		0x0050
+#define IEEE802_11_STYPE_CFPOLL		0x0060
+#define IEEE802_11_STYPE_CFACKPOLL	0x0070
+
+#define IEEE802_11_SCTL_FRAG		0x000F
+#define IEEE802_11_SCTL_SEQ		0xFFF0
+
+#endif /* _IEEE802_11_H */
+

Added: trunk/rpms/kernel-module-ipw2100/ipw2100-0.53-autotools.patch
===================================================================
--- trunk/rpms/kernel-module-ipw2100/ipw2100-0.53-autotools.patch	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/kernel-module-ipw2100/ipw2100-0.53-autotools.patch	2004-08-25 15:01:13 UTC (rev 2095)
@@ -0,0 +1,1121 @@
+diff -Naupr ipw2100-0.53/autogen.sh ipw2100-0.53-autotools/autogen.sh
+--- ipw2100-0.53/autogen.sh	1970-01-01 01:00:00.000000000 +0100
++++ ipw2100-0.53-autotools/autogen.sh	2004-08-25 14:20:02.554270520 +0200
+@@ -0,0 +1,6 @@
++#!/bin/bash
++set -x
++aclocal -I m4 || exit 1
++autoconf || exit 1
++automake -a --foreign || exit 1
++./configure $@
+diff -Naupr ipw2100-0.53/configure.ac ipw2100-0.53-autotools/configure.ac
+--- ipw2100-0.53/configure.ac	1970-01-01 01:00:00.000000000 +0100
++++ ipw2100-0.53-autotools/configure.ac	2004-08-25 14:20:02.554270520 +0200
+@@ -0,0 +1,81 @@
++AC_INIT(ipw2100_main.c)
++
++AM_INIT_AUTOMAKE(ipw2100, 0.53)
++dnl AM_CONFIG_HEADER(config.h)
++
++dnl pick up ACLOCAL flags
++ACLOCAL_AMFLAGS=&quot;\${ACLOCAL_FLAGS} -I m4&quot;
++AC_SUBST(ACLOCAL_AMFLAGS)
++
++dnl do all checks
++AS_LINUX
++
++dnl generate modtool
++AS_LINUX_MODTOOL
++
++dnl add a parameter to disable legacy loading of firmware
++AC_ARG_ENABLE(legacy-fw-load,
++  AC_HELP_STRING([--disable-legacy-fw-load],
++                 [disable loading of firmware the legacy way]),
++  LEGACY_FW_LOAD=$enableval, LEGACY_FW_LOAD=yes)
++if test &quot;x$LEGACY_FW_LOAD&quot; = &quot;xyes&quot;
++then
++  AC_MSG_NOTICE([Compiling with legacy firmware loading])
++else
++  AC_MSG_NOTICE([Compiling with hotplug firmware loading])
++fi
++AM_CONDITIONAL(LEGACY_FW_LOAD, test &quot;x$LEGACY_FW_LOAD&quot; = &quot;xyes&quot;)
++
++dnl add a parameter to disable promisc - enabled by default
++AC_ARG_ENABLE(promisc,
++  AC_HELP_STRING([--disable-promisc],
++                 [disable promisc]),
++  PROMISC=$enableval, PROMISC=yes)
++if test &quot;x$PROMISC&quot; = &quot;xyes&quot;
++then
++  AC_MSG_NOTICE([Compiling with promisc])
++else
++  AC_MSG_NOTICE([Compiling without promisc])
++fi
++AM_CONDITIONAL(PROMISC, test &quot;x$PROMISC&quot; = &quot;xyes&quot;)
++
++dnl add a parameter to disable debug - enabled by default
++AC_ARG_ENABLE(debug,
++  AC_HELP_STRING([--disable-debug],
++                 [disable debug]),
++  DEBUG=$enableval, DEBUG=yes)
++if test &quot;x$DEBUG&quot; = &quot;xyes&quot;
++then
++  AC_MSG_NOTICE([Compiling with debug])
++else
++  AC_MSG_NOTICE([Compiling without debug])
++fi
++AM_CONDITIONAL(DEBUG, test &quot;x$DEBUG&quot; = &quot;xyes&quot;)
++
++dnl add a parameter to disable WEP - enabled by default
++AC_ARG_ENABLE(wep,
++  AC_HELP_STRING([--disable-wep],
++                 [disable WEP support]),
++  WEP=$enableval, WEP=yes)
++if test &quot;x$WEP&quot; = &quot;xyes&quot;
++then
++  AC_MSG_NOTICE([Compiling with WEP support])
++else
++  AC_MSG_NOTICE([Compiling without WEP support])
++fi
++AM_CONDITIONAL(WEP, test &quot;x$WEP&quot; = &quot;xyes&quot;)
++
++dnl add a parameter to enable WPA - disabled by default
++AC_ARG_ENABLE(wpa,
++  AC_HELP_STRING([--enable-wpa],
++                 [enable WPA support]),
++  WPA=$enableval, WPA=no)
++if test &quot;x$WPA&quot; = &quot;xyes&quot;
++then
++  AC_MSG_NOTICE([Compiling with WPA support])
++else
++  AC_MSG_NOTICE([Compiling without WPA support])
++fi
++AM_CONDITIONAL(WPA, test &quot;x$WPA&quot; = &quot;xyes&quot;)
++
++AC_OUTPUT(Makefile)
+diff -Naupr ipw2100-0.53/m4/as-linux.m4 ipw2100-0.53-autotools/m4/as-linux.m4
+--- ipw2100-0.53/m4/as-linux.m4	1970-01-01 01:00:00.000000000 +0100
++++ ipw2100-0.53-autotools/m4/as-linux.m4	2004-08-24 19:33:18.000000000 +0200
+@@ -0,0 +1,775 @@
++dnl as-linux.m4 0.2.4
++
++dnl autostars m4 macro for detecting a Linux source tree (or
++dnl equivalent) for compiling modules.
++
++dnl David Schleef &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ds at schleef.org</A>&gt;
++dnl Frank Mori Hess &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fmhess at users.sourceforge.net</A>&gt;
++dnl Thomas Vander Stichele &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thomas at apestaart.org</A>&gt;
++
++dnl $Id: as-linux.m4,v 1.21 2004/08/24 15:52:07 thomasvs Exp $
++
++dnl AS_LINUX()
++dnl
++dnl this macro adds the options
++dnl --with-linuxdir        to specify a kernel build tree location
++dnl --with-linuxconfig     to specify a kernel .config file
++dnl --with-kernel-release  to specify an alternative uname -r
++dnl --with-machine         to specify an alternative uname -m
++dnl --with-rpm-target      to specify to match the given rpm --target option
++dnl --with-extraversion    to specify an EXTRAVERSION override
++dnl --with-modulesdir      to specify the base install location of modules
++dnl --with-modulesdeveldir to specify the base install location of build stuff
++dnl --without-modules      to specify not to build the modules
++dnl --without-userspace    to specify not to build userspace stuff
++
++dnl this macro defines:
++dnl LINUX_DIR
++dnl   The directory where the Linux source resides.
++dnl CONFIG_FILE
++dnl   The Linux config file
++dnl LINUX_ARCH
++dnl   $(ARCH) in kernel Makefiles
++dnl LINUX_AFLAGS
++dnl   $(AFLAGS) in kernel Makefiles
++dnl LINUX_LDFLAGS
++dnl   Linker flags used by Linux
++dnl LINUX_ARFLAGS
++dnl   Archiver flags used by Linux
++dnl LINUX_CROSS_COMPILE
++dnl   Cross-compiler prefix, if any. (example: &quot;powerpc-linux-&quot;)
++dnl LINUX_KERNELRELEASE
++dnl   Kernel release name (2.4.5-pre4-ac5-rmk), $(KERNELRELEASE) in
++dnl   Linux Makefiles.
++dnl LINUX_CFLAGS
++dnl   CFLAGS used by Linux.  Includes both $CFLAGS and $MODFLAGS from
++dnl   kernel Makefiles. Also includes warnings and optimization.
++dnl LINUX_CC
++dnl   Compiler used by Linux.
++dnl LINUX_LD
++dnl   Path to linker (possibly with options) used by Linux.
++dnl LINUX_AS
++dnl   Assembler used by Linux.
++dnl LINUX_MODULE_EXT
++dnl   Module extension (.o or .ko)
++dnl LINUX_MODPOST
++dnl   path to modpost script
++dnl LINUX_SMP
++dnl   set to yes if the kernel is SMP
++dnl modulesdir
++dnl   base install path for kernel modules
++dnl modulesdeveldir
++dnl   base install path for kernel module development files
++dnl 
++dnl End of search list.
++
++dnl main entry point
++dnl checks the version, and figures out all flags to use to make modules.
++AC_DEFUN([AS_LINUX],
++[
++	dnl check whether or not to build modules
++	AS_LINUX_CHECK_BUILD_MODULES()
++	dnl check whether or not to build userspace
++	AS_LINUX_CHECK_BUILD_USERSPACE()
++
++	if test &quot;x$BUILD_MODULES&quot; != &quot;xno&quot;
++        then
++	dnl check if user supplied a uname -r, and if not use the running one
++	AS_LINUX_KERNEL_RELEASE()
++	dnl check if user supplied a uname -m, and if not use the running one
++	AS_LINUX_MACHINE() 	 
++	dnl check if the user supplied an rpm target arch
++	dnl override the LINUX_MACHINE value if he did
++	AS_LINUX_RPM_TARGET($LINUX_KERNEL_RELEASE) 	 
++  	 
++	dnl find the kernel source tree for the given uname -r 	 
++	AS_LINUX_DIR($LINUX_KERNEL_RELEASE) 	 
++	dnl check if user supplied an EXTRAVERSION, and if not get from uname -r
++	AS_LINUX_EXTRAVERSION($LINUX_KERNEL_RELEASE) 	 
++	dnl check if user supplied a config file; if not, guess a good one
++	AS_LINUX_CONFIG($LINUX_DIR, $LINUX_KERNEL_RELEASE, $LINUX_MACHINE) 	 
++	dnl check if we're building on pre-FC2 Red Hat/Fedora,
++	dnl and add some flags if we are 	 
++	AS_CHECK_REDHAT_PRE_FC2() 	 
++	dnl check if we're building SMP, and set LINUX_SMP if we are
++	AS_CHECK_SMP()
++	dnl check for where to install modules
++	AS_LINUX_MODULESDIR($LINUX_KERNEL_RELEASE)
++	dnl check for where to install module development files
++	AS_LINUX_MODULESDEVELDIR($LINUX_DIR)
++	dnl check for the MAJOR/MINOR version of Linux 	 
++	AS_LINUX_VERSION_MAJOR_MINOR($LINUX_DIR)
++
++	dnl now call the correct macro to get compiler flags
++	dnl the versioned AS_LINUX macros just use the global variables
++	dnl this could be cleaned up later on if we feel like it
++	case $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR in
++		2.6)
++			AS_LINUX_2_6()
++			;;
++		2.[[01234]])
++			AS_LINUX_2_4()
++			;;
++		*)
++			AC_MSG_ERROR([Unknown Linux major.minor $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR])
++			;;
++	esac
++        fi
++])
++
++
++dnl check if we can find a source dir for the Linux kernel
++dnl defines LINUX_DIR to the absolute location of a usable kernel source tree
++AC_DEFUN([AS_LINUX_DIR],
++[
++	AC_ARG_WITH([linuxdir],
++		[AC_HELP_STRING([--with-linuxdir=DIR],
++			[specify path to Linux source directory])],
++		[LINUX_DIR=&quot;${withval}&quot;],
++		[LINUX_DIR=default])
++
++	dnl if specified, use the specified one
++	if test &quot;${LINUX_DIR}&quot; != &quot;default&quot; ; then
++		AS_TRY_LINUX_DIR([${LINUX_DIR}], , AC_MSG_ERROR([Linux dir not found]) )
++	fi
++
++	dnl if not specified, first try with previously set LINUX_KERNEL_RELEASE
++	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
++		dir=&quot;/lib/modules/$LINUX_KERNEL_RELEASE/build&quot;;
++		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
++	fi
++
++	dnl next try using the kernel source dir
++	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
++		dir=&quot;/usr/src/linux-$LINUX_KERNEL_RELEASE&quot;;
++		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
++	fi
++
++	dnl then try a common default of /usr/src/linux
++	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
++		dir=&quot;/usr/src/linux&quot;;
++		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
++	fi
++
++	dnl if still nothing found, fail
++	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
++		AC_MSG_ERROR([Linux source directory not found])
++	fi
++
++	AC_SUBST(LINUX_DIR)
++])
++
++dnl check if the given candidate path for a linux source tree is usable
++AC_DEFUN([AS_TRY_LINUX_DIR],
++	[AC_MSG_CHECKING(for Linux in $1)
++
++	if test -f &quot;$1/Makefile&quot; ; then
++		result=yes
++		$2
++	else
++		result=&quot;not found&quot;
++		$3
++	fi
++
++	AC_MSG_RESULT($result)
++])
++
++dnl allow for specifying a kernel release (uname -r) to build for
++dnl use uname -r of running one if not specified
++dnl store result in LINUX_KERNEL_RELEASE
++AC_DEFUN([AS_LINUX_KERNEL_RELEASE],
++[
++	AC_ARG_WITH([kernel-release],
++		[AC_HELP_STRING([--with-kernel-release=RELEASE],
++			[specify the &quot;uname -r&quot;-value to build for])],
++		[LINUX_KERNEL_RELEASE=&quot;${withval}&quot;],
++		[LINUX_KERNEL_RELEASE=`uname -r`])
++        if test &quot;x$LINUX_KERNEL_RELEASE&quot; = &quot;xyes&quot;;
++        then
++		LINUX_KERNEL_RELEASE=`uname -r`
++        fi
++        AC_MSG_NOTICE([Using $LINUX_KERNEL_RELEASE as the uname -r value])
++])
++
++dnl allow for specifying a machine (uname -m) to build for
++dnl use uname -, of running one if not specified
++dnl store result in LINUX_MACHINE
++AC_DEFUN([AS_LINUX_MACHINE],
++[
++	AC_ARG_WITH([machine],
++		[AC_HELP_STRING([--with-machine=MACHINE],
++			[specify the &quot;uname -m&quot;-value to build for])],
++		[LINUX_MACHINE=&quot;${withval}&quot;],
++		[LINUX_MACHINE=`uname -m`])
++        if test &quot;x$LINUX_MACHINE&quot; = &quot;xyes&quot;;
++        then
++		LINUX_MACHINE=`uname -r`
++        fi
++        AC_MSG_NOTICE([Using $LINUX_MACHINE as the uname -m value])
++])
++dnl allow for specifying an rpm target arch
++dnl if none specified, try to guess one from running rpm querying for
++dnl the kernel with the uname -r
++dnl this is so configure without arguments works out of the box
++dnl FIXME: investigate if uname -p is a correct guess for this, and if
++dnl we should have a flag for specifying it instead
++
++dnl this macro possibly overrides LINUX_MACHINE
++
++dnl first argument is the kernel release building for
++AC_DEFUN([AS_LINUX_RPM_TARGET],
++[
++	RELEASE=$1
++	AC_ARG_WITH([rpm-target],
++		[AC_HELP_STRING([--with-rpm-target=TARGET],
++			[specify the target arch to build for])],
++		[LINUX_RPM_TARGET=&quot;${withval}&quot;],
++		[LINUX_RPM_TARGET=])
++	if test &quot;x$LINUX_RPM_TARGET&quot; = &quot;x&quot;
++	then
++		dnl if we have rpm, try to guess the target of the kernel
++		dnl we want to build for using rpm
++		AC_PATH_PROG(RPM, rpm, yes, no)
++		if test &quot;x$RPM&quot; = &quot;xyes&quot;
++		then
++			if rpm -q kernel-$RELEASE &gt; /dev/null
++			then
++				LINUX_RPM_TARGET=`rpm -q --queryformat %{arch} kernel-$RELEASE`
++			else
++				AC_MSG_NOTICE([Cannot guess target arch, consider setting it using --with-rpm-target])
++			fi
++		fi
++	fi
++
++	dnl now override LINUX_MACHINE if LINUX_RPM_TARGET is set
++	if test &quot;x$LINUX_RPM_TARGET&quot; != &quot;x&quot;
++	then
++		dnl override LINUX_MACHINE based on this
++		dnl FIXME: add other possible Red Hat/Fedora/rpm targets here
++		LINUX_MACHINE=
++		case &quot;$LINUX_RPM_TARGET&quot; in
++			i?86) LINUX_MACHINE=i386;;
++			athlon) LINUX_MACHINE=i386;;
++			x86_64) LINUX_MACHINE=x86_64;;
++		esac
++		if test &quot;x$LINUX_MACHINE&quot; = &quot;x&quot;
++		then
++		AC_MSG_ERROR(Could not guess uname -m value from target $LINUX_RPM_TARGET)
++		fi
++	fi
++])
++
++
++dnl allow for specifying an override for EXTRAVERSION
++dnl if none specified, make it from the passed-in KERNEL_RELEASE (uname -r)
++dnl resulting value is stored in LINUX_EXTRAVERSION
++dnl first argument is the uname -r string to use as a fallback
++AC_DEFUN([AS_LINUX_EXTRAVERSION],
++[
++	KERNEL_RELEASE=[$1]
++	dnl extract the default by getting everything after first -
++	LINUX_EXTRAVERSION=&quot;-`echo $KERNEL_RELEASE | cut -d- -f 2-`&quot;
++	AC_ARG_WITH([extraversion],
++		[AC_HELP_STRING([--with-extraversion=FILE],
++			[specify override for kernel EXTRAVERSION])],
++		[LINUX_EXTRAVERSION=&quot;${withval}&quot;],)
++])
++
++
++dnl check if we can find a config file for the Linux kernel
++dnl defines LINUX_CONFIG to the absolute location of a usable
++dnl kernel source config file
++
++dnl for rpm distros, it can try and guess the correct config file by
++dnl checking the global LINUX_RPM_TARGET variable set somewhere else
++dnl (FIXME: move this to an argument instead ?)
++
++dnl first argument is LINUX_DIR to check for possible configs
++dnl second argument is kernel-release (uname -r)
++dnl third argument is machine (uname -m)
++
++AC_DEFUN([AS_LINUX_CONFIG],
++[
++	LINUX_DIR=[$1]
++	KERNEL_RELEASE=[$2]
++	MACHINE=[$3]
++	AC_ARG_WITH([linuxconfig],
++		[AC_HELP_STRING([--with-linuxconfig=FILE],
++			[specify path to Linux configuration file])],
++		[LINUX_CONFIG=&quot;${withval}&quot;],
++		[LINUX_CONFIG=default])
++
++	dnl if a file got specified, try it as a linux config file
++	if test &quot;${LINUX_CONFIG}&quot; != &quot;default&quot; ; then
++		AS_TRY_LINUX_CONFIG($LINUX_CONFIG, $MACHINE,
++                                    ,, AC_MSG_ERROR([Linux config not found]) )
++	fi
++
++        dnl if no file specified, first check for the regular .config file
++        dnl in LINUX_DIR created by manual configuration
++	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; ; then
++		file=&quot;$LINUX_DIR/.config&quot;;
++		AS_TRY_LINUX_CONFIG($file, $MACHINE,
++		                    [LINUX_CONFIG=${file}], )
++	fi
++        dnl second, try to guess what config file to use for the current kernel
++	dnl FIXME: the possible arch is from rpmbuild --target, and is
++	dnl different from the value of ARCH (Makefile) or MACHINE (uname -m)
++	dnl so we should have a redhat flag to specify the target to find
++	dnl the correct config file
++	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; &amp;&amp; test &quot;x$LINUX_RPM_TARGET&quot; != &quot;x&quot;; then
++		dnl Red Hat stores configuration files for their built kernels
++		dnl named kernel-(version)-(arch)(extra).config
++		dnl where arch is athlon, i386, i586, i686, x86_64
++		dnl and (extra) is empty or -smp, -BOOT, -bigmem
++		dnl haven't seen combinations of extra yet as of FC1
++		KVERSION=`echo $KERNEL_RELEASE | cut -d- -f1`
++		extra=
++		echo $KERNEL_RELEASE | grep smp &amp;&amp; EXTRA=&quot;-smp&quot;
++		echo $KERNEL_RELEASE | grep bigmem &amp;&amp; EXTRA=&quot;-bigmem&quot;
++		echo $KERNEL_RELEASE | grep BOOT &amp;&amp; EXTRA=&quot;-BOOT&quot;
++		file=&quot;$LINUX_DIR/configs/kernel-$KVERSION-$LINUX_RPM_TARGET$EXTRA.config&quot;
++		AS_TRY_LINUX_CONFIG($file, $MACHINE,
++		                    [LINUX_CONFIG=${file}], )
++	fi
++	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; ; then
++		AC_MSG_ERROR([
++The kernel source tree at ${LINUX_DIR} is not configured,
++and no configuration files in config/ matching your kernel were found.
++Fix before continuing or specify a config file using --with-configfile.])
++	fi
++
++	AC_SUBST(LINUX_CONFIG)
++])
++
++dnl check if the given candidate config file is usable
++dnl FIXME: it would be nice if it could check if it matches the
++dnl given machine (uname -m)
++AC_DEFUN([AS_TRY_LINUX_CONFIG],
++[
++	CFG=[$1]
++	MACHINE=[$2]
++	AC_MSG_CHECKING($CFG)
++
++	if test -f &quot;$CFG&quot; ; then
++		result=yes
++		ifelse([$3], , :, [$3])
++	else
++		result=&quot;not found&quot;
++		ifelse([$4], , :, [$4])
++	fi
++	AC_MSG_RESULT($result)
++])
++
++dnl check if RED_HAT_LINUX_KERNEL is defined
++dnl pre-FC2 RH/Fedora defines this in linux/rhconfig.h
++dnl included from linux/version.h
++dnl if this is present, a few extra defines need to be present to make sure
++dnl symbol versioning is correct
++dnl uses LINUX_DIR to find rhconfig.h
++AC_DEFUN([AS_CHECK_REDHAT_PRE_FC2],
++[
++	AC_MSG_CHECKING(Pre-FC2 Red Hat/Fedora kernel)
++        HAVE_REDHAT_KERNEL=false
++        ac_save_CFLAGS=&quot;$CFLAGS&quot;
++        CFLAGS=&quot;$CFLAGS -I${LINUX_DIR}/include/linux&quot;
++        AC_COMPILE_IFELSE(AC_LANG_PROGRAM([
++#define __BOOT_KERNEL_H_
++#include &quot;rhconfig.h&quot;
++int code = RED_HAT_LINUX_KERNEL;
++	]),
++        AC_MSG_RESULT(found); HAVE_REDHAT_KERNEL=true,
++        AC_MSG_RESULT(not found))
++	dnl restore CFLAGS
++        CFLAGS=&quot;$ac_save_CFLAGS&quot;
++
++	dnl check for Red Hat define flags to use - see /sbin/mkkerneldoth
++
++	dnl initialize the booleans we want to detect
++	ENTERPRISE='0'
++	SMP='0'
++	UP='0'
++	BIGMEM='0'
++	HUGEMEM='0'
++
++	dnl get variables from the currently running kernel as default 
++	KERNEL_TYPE=`uname -r | sed 's_^.*\(smp\|enterprise\|bigmem\|hugemem\)$_\1_;t;s_.*__;'`
++	KERNEL_RELEASE=`uname -r | sed 's|smp\|enterprise\|bigmem\|hugemem||g'`
++	KERNEL_ARCH=`uname -m`
++
++	dnl check the config file and override KERNEL_ARCH
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M386, KERNEL_ARCH=i386)
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M586, KERNEL_ARCH=i586)
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M686, KERNEL_ARCH=i686)
++	dnl for some reason the i686 bigmem config file has PENTIUM
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_MPENTIUMIII, KERNEL_ARCH=i686)
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_MK7, KERNEL_ARCH=athlon)
++
++	dnl check the config file and override KERNEL_TYPE
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_SMP, KERNEL_TYPE=smp)
++	dnl bigmem is also smp, so this check is done after smp to override
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_HIGHMEM64G, KERNEL_TYPE=bigmem)
++
++	dnl FIXME: need to check hugemem and enterprise config files, which
++	dnl aren't provided in Fedora Core 1 !
++
++	case &quot;$KERNEL_TYPE&quot; in
++		smp) SMP='1';;
++		enterprise) ENTERPRISE='1';;
++		bigmem) BIGMEM='1';;
++		hugemem) HUGEMEM='1';;
++		*) UP='1';;
++	esac
++	REDHAT_CFLAGS=&quot;-D__BOOT_KERNEL_H_ -D__MODULE_KERNEL_$KERNEL_ARCH=1&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_ENTERPRISE=$ENTERPRISE&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_UP=$UP&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_SMP=$SMP&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_BIGMEM=$BIGMEM&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_HUGEMEM=$HUGEMEM&quot;
++
++	LINUX_REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS&quot;
++
++	AC_SUBST(LINUX_KERNEL_TYPE, &quot;$KERNEL_TYPE&quot;)
++])
++
++dnl check if we're building on SMP
++dnl set LINUX_SMP to yes if we are
++AC_DEFUN([AS_CHECK_SMP],
++[
++	LINUX_SMP=&quot;no&quot;
++	dnl check the config file and override KERNEL_TYPE
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_SMP, LINUX_SMP=&quot;yes&quot;)
++	AC_SUBST(LINUX_SMP)
++])
++
++dnl add an argument to specify/override the module install path
++dnl if nothing specified, it will be /lib/modules/(kernelrel)
++AC_DEFUN([AS_LINUX_MODULESDIR],
++[
++	KERNEL_RELEASE=[$1]
++	AC_ARG_WITH([modulesdir],
++		[AC_HELP_STRING([--with-modulesdir=DIR],
++			[specify path to kernel-specific modules install directory])],
++		[MODULESDIR=&quot;${withval}&quot;],
++		[MODULESDIR=default])
++
++	if test &quot;${MODULESDIR}&quot; = &quot;default&quot; ; then
++		MODULESDIR=&quot;/lib/modules/${KERNEL_RELEASE}&quot;
++	fi
++	dnl make it available to Makefiles so it can be used in ...dir
++	AC_SUBST(modulesdir, $MODULESDIR)
++	AC_MSG_NOTICE([Putting kernel modules under ${MODULESDIR}])
++])
++
++dnl add an argument to specify/override the module devel install path
++dnl if nothing specified, it will be the passed in LINUXDIR)
++AC_DEFUN([AS_LINUX_MODULESDEVELDIR],
++[
++	LINUXDIR=[$1]
++	AC_ARG_WITH([modulesdeveldir],
++		[AC_HELP_STRING([--with-modulesdeveldir=DIR],
++			[specify path to kernel-specific module development install directory])],
++		[MODULESDEVELDIR=&quot;${withval}&quot;],
++		[MODULESDEVELDIR=default])
++
++	if test &quot;${MODULESDEVELDIR}&quot; = &quot;default&quot; ; then
++		MODULESDEVELDIR=&quot;${LINUXDIR}&quot;
++	fi
++	dnl make it available to Makefiles so it can be used in ...dir
++	AC_SUBST(modulesdeveldir, $MODULESDEVELDIR)
++	AC_MSG_NOTICE([Putting kernel module development files under ${MODULESDEVELDIR}])
++])
++
++dnl add an argument to build without modules
++dnl sets variable BUILD_MODULES
++AC_DEFUN([AS_LINUX_CHECK_BUILD_MODULES],
++[
++	AC_ARG_WITH([modules],
++		[AC_HELP_STRING([--without-modules],
++			[do not build kernel modules])],
++		[BUILD_MODULES=&quot;${withval}&quot;],
++		[BUILD_MODULES=&quot;yes&quot;])
++
++	AC_MSG_CHECKING([whether to build kernel modules])
++	if test &quot;x$BUILD_MODULES&quot; = &quot;xno&quot;
++	then
++		AC_MSG_RESULT([no])
++	else
++		AC_MSG_RESULT([yes])
++	fi
++	dnl make it available as a conditional to Makefiles
++	AM_CONDITIONAL(BUILD_MODULES, test &quot;x$BUILD_MODULES&quot; != &quot;xno&quot;)
++])
++
++dnl add an argument to build without userspace
++AC_DEFUN([AS_LINUX_CHECK_BUILD_USERSPACE],
++[
++	AC_ARG_WITH([userspace],
++		[AC_HELP_STRING([--without-userspace],
++			[do not build userspace stuff])],
++		[BUILD_USERSPACE=&quot;${withval}&quot;],
++		[BUILD_USERSPACE=&quot;yes&quot;])
++
++	AC_MSG_CHECKING([whether to build userspace stuff])
++	if test &quot;x$BUILD_USERSPACE&quot; = &quot;xno&quot;
++	then
++		AC_MSG_RESULT([no])
++	else
++		AC_MSG_RESULT([yes])
++	fi
++	dnl make it available as a conditional to Makefiles
++	AM_CONDITIONAL(BUILD_USERSPACE, test &quot;x$BUILD_USERSPACE&quot; != &quot;xno&quot;)
++])
++
++AC_DEFUN([AS_LINUX_2_6],
++[
++	AC_MSG_CHECKING(for Linux CFLAGS)
++
++	{
++	  tmpdir=`(umask 077 &amp;&amp; mktemp -d -q &quot;./confstatXXXXXX&quot;) 2&gt;/dev/null` &amp;&amp;
++	  test -n &quot;$tmpdir&quot; &amp;&amp; test -d &quot;$tmpdir&quot;
++	} ||
++	{
++	  tmpdir=./confstat$$-$RANDOM
++	  (umask 077 &amp;&amp; mkdir $tmpdir)
++	} ||
++	{
++	  echo &quot;$me: cannot create a temporary directory in .&quot; &gt;&amp;2
++	  { (exit 1); exit 1; }
++	}
++
++	tmpdir=`pwd`/$tmpdir
++
++	cat &gt;${tmpdir}/Makefile &lt;&lt;EOF
++obj-m += fake.o
++
++\$(obj)/fake.c: flags
++	touch \$(obj)/fake.c
++
++.PHONY: flags
++flags:
++	echo LINUX_ARCH=\&quot;\$(ARCH)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_AFLAGS=\&quot;\$(AFLAGS)\&quot; | sed 's,include,&quot;\$(LINUXDIR)/include&quot;,g'&gt;&gt;\$(obj)/flags
++	echo LINUX_LDFLAGS=\&quot;\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_ARFLAGS=\&quot;\$(ARFLAGS)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_CROSS_COMPILE=\&quot;\$(CROSS_COMPILE)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_KERNELRELEASE=\&quot;\$(KERNELRELEASE)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_CFLAGS=\&quot;\$(CFLAGS) \$(CPPFLAGS)\&quot; | sed 's,Iinclude,I\$(LINUXDIR)/include,g' &gt;&gt;\$(obj)/flags
++	echo LINUX_CFLAGS_MODULE=\&quot;\$(CFLAGS_MODULE)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_CC=\&quot;\$(CC)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_LD=\&quot;\$(LD) \$(LDFLAGS) \$(LDFLAGS_MODULE)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_AS=\&quot;\$(AS)\&quot; &gt;&gt;\$(obj)/flags
++EOF
++
++	echo ${MAKE-make} -C ${LINUX_DIR} V=1 SUBDIRS=${tmpdir} LINUXDIR=${LINUX_DIR} MODVERDIR=${tmpdir} modules &gt;&amp;5 2&gt;&amp;5
++	${MAKE-make} -C ${LINUX_DIR} V=1 SUBDIRS=${tmpdir} LINUXDIR=${LINUX_DIR} MODVERDIR=${tmpdir} modules &gt;&amp;5 2&gt;&amp;5
++	. ${tmpdir}/flags
++	rm -rf ${tmpdir}
++
++	LINUX_MODULE_EXT=&quot;.ko&quot;
++
++	LINUX_CFLAGS=&quot;$LINUX_CFLAGS $LINUX_CFLAGS_MODULE&quot;
++	AC_SUBST(LINUX_ARCH)
++	AC_SUBST(LINUX_AFLAGS)
++	AC_SUBST(LINUX_LDFLAGS)
++	AC_SUBST(LINUX_ARFLAGS)
++	AC_SUBST(LINUX_CROSS_COMPILE)
++	AC_SUBST(LINUX_KERNELRELEASE)
++	AC_SUBST(LINUX_CFLAGS)
++	AC_SUBST(LINUX_CC)
++	AC_SUBST(LINUX_LD)
++	AC_SUBST(LINUX_AS)
++	AC_SUBST(LINUX_MODULE_EXT)
++	AC_MSG_RESULT([$LINUX_CFLAGS])
++
++	dnl find a usable modpost script
++	AC_MSG_CHECKING([usable modpost])
++	for CAND in $LINUX_DIR/scripts/modpost $LINUX_DIR/scripts/mod/modpost
++	do
++		if test -f &quot;$CAND&quot;
++		then
++			LINUX_MODPOST=$CAND
++		fi
++	done
++	AC_SUBST(LINUX_MODPOST)
++	if test -z &quot;$LINUX_MODPOST&quot;
++	then
++		AC_MSG_WARN([No usable modpost script found])
++	else
++		AC_MSG_RESULT([$LINUX_MODPOST])
++	fi
++])
++
++dnl checks kernel's Makefile for make variables for Linux 2.4
++dnl adds LINUX_REDHAT_CFLAGS if non-empty
++AC_DEFUN([AS_LINUX_2_4],
++[
++	AC_MSG_CHECKING(for Linux 2.4 make flags)
++	dnl we try to figure out the CFLAGS by invoking the Makefile on
++        dnl a test dir
++        dnl we use the correct config file by substituting the MAKEFILES
++        dnl Makefile variable, which originally points to .config
++
++	if [[ ! -e &quot;${LINUX_DIR}/.hdepend&quot; ]];then
++		AC_MSG_ERROR([
++You need to run 'make dep' on the kernel source before continuing.])
++	fi
++
++        if test &quot;x$LINUX_EXTRAVERSION&quot; == &quot;x&quot;; then
++          EX=
++        else
++          EX=&quot;EXTRAVERSION=$LINUX_EXTRAVERSION&quot;
++        fi
++
++        POPDIR=`(pwd)`
++        cd ${LINUX_DIR}
++        TMPFILE=`mktemp /tmp/linux.XXXXXXXX` || exit 1
++	# combine the kernel's Makefile,
++	# sedded to use our proposed config file,
++	# sedded to use our proposed machine value,
++	# with the extra target we add here, to get cflags
++	# we do not want entering/leaving info on distcheck so we run with -s
++	( cat Makefile | sed &quot;s|\.config|${LINUX_CONFIG}|g&quot; | sed &quot;s|shell uname -m|shell echo ${LINUX_MACHINE}|g&quot; &amp;&amp; cat &lt;&lt;EOF ) | make -s -f - get_cflags $EX &gt; ${TMPFILE}
++get_cflags:
++	@echo LINUX_ARCH=\&quot;\$(ARCH)\&quot;
++	@echo LINUX_AFLAGS=\&quot;\$(AFLAGS)\&quot; | sed 's_Iinclude_I\&quot;\$(LINUXDIR)/include\&quot;_g'
++	@echo LINUX_LDFLAGS=\&quot;\&quot;
++	@echo LINUX_ARFLAGS=\&quot;\$(ARFLAGS)\&quot;
++	@echo LINUX_CROSS_COMPILE=\&quot;\$(CROSS_COMPILE)\&quot;
++	@echo LINUX_KERNELRELEASE=\&quot;\$(KERNELRELEASE)\&quot;
++	@echo LINUX_CFLAGS=\&quot;\$(CFLAGS)\&quot; | sed 's_Iinclude_I\&quot;\$(LINUXDIR)/include\&quot;_g'
++	@echo LINUX_MODFLAGS=\&quot;\$(MODFLAGS)\&quot;
++	@echo LINUX_CC=\&quot;\$(CC)\&quot;
++	@echo LINUX_LD=\&quot;\$(LD) \$(LDFLAGS)\&quot;
++	@echo LINUX_AS=\&quot;\$(AS)\&quot;
++EOF
++        . ${TMPFILE}
++        rm -rf ${TMPFILE}
++        cd $POPDIR
++
++        LINUX_MODULE_EXT=&quot;.o&quot;
++
++	LINUX_CFLAGS=&quot;$LINUX_CFLAGS $LINUX_MODFLAGS&quot;
++
++	dnl if we have REDHAT_CFLAGS, put them in LINUX_CFLAGS
++	if test &quot;x$REDHAT_CFLAGS&quot; != &quot;x&quot;;
++	then
++		LINUX_CFLAGS=&quot;$LINUX_CFLAGS $REDHAT_CFLAGS&quot;
++	fi
++	AC_SUBST(LINUX_ARCH)
++	AC_SUBST(LINUX_AFLAGS)
++	AC_SUBST(LINUX_LDFLAGS)
++	AC_SUBST(LINUX_ARFLAGS)
++	AC_SUBST(LINUX_CROSS_COMPILE)
++	AC_SUBST(LINUX_KERNELRELEASE)
++	AC_SUBST(LINUX_CFLAGS)
++	AC_SUBST(LINUX_CC)
++	AC_SUBST(LINUX_LD)
++	AC_SUBST(LINUX_AS)
++	AC_SUBST(LINUX_MODULE_EXT)
++
++	AC_MSG_RESULT([ok])
++
++	AC_MSG_CHECKING(for Linux 2.4 CFLAGS)
++	AC_MSG_RESULT($LINUX_CFLAGS)
++	AC_MSG_CHECKING(for Linux 2.4 LDFLAGS)
++	AC_MSG_RESULT($LINUX_LDFLAGS)
++])
++
++AC_DEFUN([AS_CHECK_LINUX_CONFIG_OPTION],
++[
++	AC_MSG_CHECKING([Linux config option $1])
++
++	if grep '^$1=y$' ${LINUX_CONFIG} &gt;/dev/null 2&gt;/dev/null; then
++		result=yes
++		$2
++	else if grep '^$1=m$' ${LINUX_CONFIG} &gt;/dev/null 2&gt;/dev/null; then
++		result=module
++		$3
++	else
++		result=no
++		$4
++	fi
++	fi
++
++	AC_MSG_RESULT([$result])
++])
++
++AC_DEFUN([AS_LINUX_CONFIG_OPTION],
++[
++	AS_CHECK_LINUX_CONFIG_OPTION([$1],
++		[$1=yes],
++		[$1=module],
++		[$1=no])
++
++	AM_CONDITIONAL([$1],[test &quot;${$1}&quot; = yes])
++])
++
++AC_DEFUN([AS_LINUX_CONFIG_OPTION_MODULE],
++[
++	AS_CHECK_LINUX_CONFIG_OPTION([$1],
++		[$1=yes],
++		[$1=module],
++		[$1=no])
++
++	AM_CONDITIONAL([$1],[test &quot;${$1}&quot; = yes -o &quot;${$1}&quot; = module])
++])
++
++dnl check for the major/minor version of the Linux source by checking
++dnl the headers
++dnl first argument is the linux directory
++dnl sets LINUX_VERSION_MAJOR and LINUX_VERSION_MINOR
++AC_DEFUN([AS_LINUX_VERSION_MAJOR_MINOR],
++[
++	LINUX_DIR=[$1]
++	AC_MSG_CHECKING([Linux major/minor version])
++
++	if [[ ! -f &quot;${LINUX_DIR}/include/linux/version.h&quot; ]];then
++		AC_MSG_ERROR([The header file include/linux/version.h does not exist.
++For 2.6 kernels, it can be generated by running 'make prepare' in
++the kernel source directory.])
++	fi
++        dnl the next set of tests is for figuring out version major/minor
++        dnl we make sure we have the right version.h by faking out CFLAGS
++	dnl since we want to avoid including linux/version.h and acidentally
++	dnl pick up /usr/include/linux
++	dnl we still add ${LINUX_DIR}/include so the Red Hat version can pick
++	dnl up linux/rhversion.h
++        ac_save_CFLAGS=&quot;$CFLAGS&quot;
++        CFLAGS=&quot;$CFLAGS -I${LINUX_DIR}/include/linux -I${LINUX_DIR}/include&quot;
++        dnl make sure we find version.h and it contains LINUX_VERSION_CODE
++        AC_COMPILE_IFELSE(AC_LANG_PROGRAM([
++/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
++#define __BOOT_KERNEL_H_
++#include &quot;version.h&quot;
++int code = LINUX_VERSION_CODE;
++]),
++ :, AC_MSG_ERROR([${LINUX_DIR}/include/linux/version.h does not contain LINUX_VERSION_CODE]))
++
++
++        dnl figure out the linux kernel version major and minor
++        dnl using the LINUX_VERSION_CODE defined in include/linux/version.h
++        AC_RUN_IFELSE(AC_LANG_PROGRAM([
++/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
++#define __BOOT_KERNEL_H_
++#include &quot;version.h&quot;
++#define KERNEL_VERSION_MAJOR(code) ((code) &gt;&gt; 16)
++],[
++  return KERNEL_VERSION_MAJOR(LINUX_VERSION_CODE);
++]),
++		LINUX_VERSION_MAJOR=0, 
++		LINUX_VERSION_MAJOR=$?)
++        AC_RUN_IFELSE(AC_LANG_PROGRAM([
++/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
++#define __BOOT_KERNEL_H_
++#include &quot;version.h&quot;
++#define KERNEL_VERSION_MINOR(code) (((code) &gt;&gt; 8) % (2 &lt;&lt; 8))
++],[
++  return KERNEL_VERSION_MINOR(LINUX_VERSION_CODE);
++]),
++		LINUX_VERSION_MINOR=0, 
++		LINUX_VERSION_MINOR=$?)
++        AC_MSG_RESULT($LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR)
++	dnl restore CFLAGS
++        CFLAGS=&quot;$ac_save_CFLAGS&quot;
++])
+diff -Naupr ipw2100-0.53/m4/as-modtool.m4 ipw2100-0.53-autotools/m4/as-modtool.m4
+--- ipw2100-0.53/m4/as-modtool.m4	1970-01-01 01:00:00.000000000 +0100
++++ ipw2100-0.53-autotools/m4/as-modtool.m4	2004-08-24 19:33:18.000000000 +0200
+@@ -0,0 +1,147 @@
++dnl as-modtool.m4 0.0.1
++dnl autostars m4 macro for building modtool, a linker for Linux kernel
++dnl modules
++
++dnl David Schleef &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ds at schleef.org</A>&gt;
++dnl Frank Mori Hess &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fmhess at users.sourceforge.net</A>&gt;
++dnl Thomas Vander Stichele &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thomas at apestaart.org</A>&gt;
++
++dnl $Id: as-modtool.m4,v 1.12 2004/06/03 15:20:11 thomasvs Exp $
++
++dnl AS_LINUX_MODTOOL()
++dnl
++dnl this macro defines:
++dnl moduledir
++dnl modulePROGRAMS_INSTALL
++dnl modulePROGRAMS_UNINSTALL
++dnl
++dnl End of search list.
++
++dnl
++dnl FIXME:
++dnl  How do you specify that the building of modtool should go to the
++dnl  end of the configure script?
++dnl
++
++dnl SYMVERS_INCLUDES can be used to add additional .symvers files to the
++dnl modpost step
++
++AC_DEFUN([AS_LINUX_MODTOOL],
++[
++	AC_PATH_PROG(STRIP, strip)
++	AC_PATH_PROG([DEPMOD], [depmod], [no], [$PATH:/sbin:/usr/sbin:/usr/local/sbin])
++	AC_PATH_PROG([GENKSYMS], [genksyms], [no], [$PATH:/sbin:/usr/sbin:/usr/local/sbin])
++
++	if test &quot;x$LINUX_SMP&quot; = &quot;xyes&quot;
++	then
++		GENKSYMS=&quot;$GENKSYMS -p smp_&quot;
++	fi
++	dnl this can be overridden in Makefile.am
++	dnl FIXME: it'd be nice if we could specify different target_PROGRAMS
++	dnl and different targetdir
++	moduledir=&quot;\$(modulesdir)/\$(PACKAGE)&quot;
++	modulePROGRAMS_INSTALL=&quot;\$(top_builddir)/modtool --install&quot;
++	modulePROGRAMS_UNINSTALL=&quot;\$(top_builddir)/modtool --uninstall&quot;
++	AC_SUBST(moduledir)
++	AC_SUBST(modulePROGRAMS_INSTALL)
++
++	LINUX_VERSION=`echo $LINUX_KERNELRELEASE | cut -d- -f1`
++
++	AC_MSG_NOTICE(creating modtool)
++	cat &gt;modtool &lt;&lt;EOF
++#!/bin/sh
++
++set -e
++
++LINUX_LD=&quot;$LINUX_LD&quot;
++LINUX_MODPOST=&quot;$LINUX_MODPOST&quot;
++LINUX_VERSION=&quot;$LINUX_VERSION&quot;
++GENKSYMS=&quot;$GENKSYMS&quot;
++CC=&quot;$LINUX_CC&quot;
++INSTALL=&quot;$INSTALL&quot;
++LINUX_MODULE_EXT=&quot;$LINUX_MODULE_EXT&quot;
++STRIP=&quot;$STRIP&quot;
++CFLAGS=&quot;$CFLAGS $LINUX_CFLAGS&quot;
++LINUX_DIR=&quot;$LINUX_DIR&quot;
++
++mode=\$[1]
++shift
++
++case \$mode in
++--link)
++	# we accept -i (symvers) and -o (target) as options
++	# at least -o (target) needs to be specified
++	SYMVERS_INCLUDES=&quot;&quot;
++	done=false
++	while test ! -z &quot;\$[0]&quot; -a &quot;\$done&quot; = &quot;false&quot;
++	do
++		case \$[1] in
++		-i)
++                        SYMVERS_INCLUDES=&quot;\$SYMVERS_INCLUDES \$[2]&quot;
++                        shift 2
++                        ;;
++                -o)
++                        target=\$(echo \$[2] | sed s/.ko$//)
++                        shift 2
++                        ;;
++                *)
++                        done=true
++                        ;;
++                esac
++        done
++
++	mkdir -p .mods
++	if test &quot;\$LINUX_MODULE_EXT&quot; = .ko ; then
++
++		\$LINUX_LD -r -o .mods/\$target.o \$[*]
++
++		cat \$LINUX_DIR/Module.symvers \$SYMVERS_INCLUDES &gt;.mods/symvers.tmp
++
++		\$LINUX_MODPOST -o .mods/\$target.o.symvers.tmp -i .mods/symvers.tmp .mods/\$target.o
++
++		grep .mods/\$target .mods/\$target.o.symvers.tmp &gt;.mods/\$target.o.symvers || true
++
++		rm -f .mods/\$target.o.symvers.tmp .mods/symvers.tmp
++		
++		\$CC \$CFLAGS -DKBUILD_MODNAME=\$target -c -o .mods/\$target.mod.o .mods/\$target.mod.c
++
++		\$LINUX_LD -r -o \$target.ko .mods/\$target.mod.o .mods/\$target.o
++		set +x
++	else
++		echo \$LINUX_LD -r -o \$target.ko \$[*]
++		\$LINUX_LD -r -o \$target.ko \$[*]
++                                                                      
++		if test &quot;x\$SOURCES&quot; != &quot;x&quot;
++		then
++			echo &quot;\$CC \$CFLAGS -E -D__GENKSYMS__ \$SOURCES | \$GENKSYMS -k \$LINUX_VERSION &gt; .mods/\$target.ver&quot;
++			\$CC \$CFLAGS -E -D__GENKSYMS__ \$SOURCES | \$GENKSYMS -k \$LINUX_VERSION &gt; .mods/\$target.ver
++		fi
++
++	fi
++
++	;;
++--install)
++	module_src=\$[1]
++	module_dest=\`echo \$[2] | sed &quot;s/\.ko$/\${LINUX_MODULE_EXT}/&quot;\`
++	echo \$INSTALL -m644 &quot;\$module_src&quot; &quot;\$module_dest&quot;
++	\$INSTALL -m644 &quot;\$module_src&quot; &quot;\$module_dest&quot;
++	\$STRIP -g &quot;\$module_dest&quot;
++	;;
++--uninstall)
++	module_src=\$[1]
++	module_dest=\`echo \$[2] | sed &quot;s/\.ko$/\${LINUX_MODULE_EXT}/&quot;\`
++	echo uninstall &quot;\$module_src&quot; &quot;\$module_dest&quot;
++	rm -f &quot;\$module_dest&quot;
++	;;
++*)
++	echo Unknown mode \$mode &gt;&amp;2
++	exit 1
++esac
++
++EOF
++	chmod +x modtool
++
++
++])
++
++
+diff -Naupr ipw2100-0.53/Makefile.am ipw2100-0.53-autotools/Makefile.am
+--- ipw2100-0.53/Makefile.am	1970-01-01 01:00:00.000000000 +0100
++++ ipw2100-0.53-autotools/Makefile.am	2004-08-25 14:20:02.567268544 +0200
+@@ -0,0 +1,92 @@
++### check options for modules
++
++# check if we want legacy firmware loading
++if LEGACY_FW_LOAD
++LEGACY_FW_LOAD_CFLAGS = -DCONFIG_IPW2100_LEGACY_FW_LOAD=y
++else
++LEGACY_FW_LOAD_CFLAGS =
++endif
++
++# check if we want DEBUG
++if DEBUG
++DEBUG_CFLAGS = -DCONFIG_IPW2100_DEBUG=y
++else
++DEBUG_CFLAGS =
++endif
++
++# check if we want PROMISC
++if PROMISC
++PROMISC_CFLAGS = -DCONFIG_IPW2100_PROMISC=y
++else
++PROMISC_CFLAGS =
++endif
++
++### check optional modules
++
++# WEP
++if WEP
++WEP_MODULES = ieee80211_crypt_wep.ko
++else
++WEP_MODULES =
++endif
++
++# WPA
++if WPA
++WPA_MODULES = ieee80211_crypt_ccmp.ko ieee80211_crypt_tkip.ko
++else
++WPA_MODULES =
++endif
++
++### which modules and where to install
++
++moduledir = $(modulesdir)/kernel/drivers/net/wireless
++module_PROGRAMS = \
++	ipw2100.ko \
++	ieee80211.ko \
++	ieee80211_crypt.ko \
++	$(WEP_MODULES) \
++	$(WPA_MODULES)
++
++ipw2100_ko_SOURCES = \
++        ipw2100_main.c \
++        ipw2100_fw.c \
++        ipw2100_wx.c
++
++ieee80211_ko_SOURCES = \
++        ieee80211_module.c \
++        ieee80211_tx.c \
++        ieee80211_rx.c \
++        ieee80211_wx.c
++
++# we are building from this package and not included in kernel
++AM_CFLAGS = \
++  $(LINUX_CFLAGS) \
++  -DNOKERNEL \
++  $(LEGACY_FW_LOAD_CFLAGS) \
++  $(DEBUG_CFLAGS) \
++  $(PROMISC_CFLAGS)
++
++LINK = $(top_builddir)/modtool --link -o $@
++#eee80211_ko_LINK = $(top_builddir)/modtool --link -o $@
++
++# FIXME: might be good to make hostap install the hostap_crypt header !
++noinst_HEADERS = \
++  ieee802_11.h \
++  ieee80211_crypt.h \
++  ieee80211.h \
++  ipw2100_fw.h \
++  ipw2100.h \
++  ipw2100_hw.h \
++  ipw2100_wx.h \
++  ipwversion.h
++
++EXTRA_DIST = \
++  m4/as-linux.m4 \
++  m4/as-modtool.m4
++
++DISTCHECK_CONFIGURE_FLAGS = --with-modulesdir=`mktemp -d`
++
++DISTCLEANFILES = modtool
++
++distclean-local:
++	-rm -rf .mods

Added: trunk/rpms/kernel-module-ipw2100/ipw2100-0.53-vfs_read_2.patch
===================================================================
--- trunk/rpms/kernel-module-ipw2100/ipw2100-0.53-vfs_read_2.patch	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/kernel-module-ipw2100/ipw2100-0.53-vfs_read_2.patch	2004-08-25 15:01:13 UTC (rev 2095)
@@ -0,0 +1,120 @@
+diff -u ipw2100-0.53.orig/ipw2100_fw.c ipw2100-0.53/ipw2100_fw.c
+--- ipw2100-0.53.orig/ipw2100_fw.c	2004-08-19 12:30:23.000000000 +0800
++++ ipw2100-0.53/ipw2100_fw.c	2004-08-20 22:31:02.000000000 +0800
+@@ -39,7 +39,6 @@
+ 
+ #include &lt;linux/compiler.h&gt;
+ #include &lt;linux/config.h&gt;
+-#include &lt;linux/errno.h&gt;
+ #include &lt;linux/if_arp.h&gt;
+ #include &lt;linux/in6.h&gt;
+ #include &lt;linux/in.h&gt;
+@@ -58,14 +57,6 @@
+ #include &lt;linux/types.h&gt;
+ #include &lt;linux/version.h&gt;
+ 
+-#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,6,8)
+-#include &lt;linux/syscalls.h&gt;
+-#define read sys_read
+-#define lseek sys_lseek
+-#define open sys_open
+-#define close sys_close
+-#endif
+-
+ #include &lt;asm/io.h&gt;
+ #include &lt;asm/uaccess.h&gt;
+ #define __KERNEL_SYSCALLS__
+@@ -169,7 +160,11 @@
+ }
+ 
+ 
++#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,0)
+ static int ipw2100_fw_load(int fd, struct ipw2100_fw_chunk_set *cs, long size)
++#else
++static int ipw2100_fw_load(struct file *filp, struct ipw2100_fw_chunk_set *cs, long size)
++#endif
+ {
+ 	struct ipw2100_fw_chunk *c;
+ 	int i = 0;
+@@ -209,7 +204,11 @@
+ 			goto fail;
+ 			
+ 		}
++#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,0)
+ 		if (read(fd, c-&gt;buf, c-&gt;len) != c-&gt;len) {
++#else
++		if (vfs_read(filp, c-&gt;buf, c-&gt;len, &amp;filp-&gt;f_pos) != c-&gt;len) {
++#endif
+ 			printk(KERN_INFO &quot;Failed to read chunk firmware &quot;
+ 			       &quot;chunk %d.\n&quot;, i);
+ 			goto fail;
+@@ -228,6 +227,8 @@
+ 	return 1;
+ }
+ 
++#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,0)
++
+ static int errno;
+ static int ipw2100_do_mod_firmware_load(const char *fn, struct ipw2100_fw *fw)
+ {
+@@ -280,6 +281,60 @@
+ 	return 1;
+ }
+ 
++#else
++
++static int ipw2100_do_mod_firmware_load(const char *fn, struct ipw2100_fw *fw)
++{
++	struct file *filp;
++	long l;
++	struct ipw2100_fw_header h;
++
++	/* Make sure the lists are init'd so that error paths can safely walk
++        * them to free potentially allocated storage */
++	INIT_LIST_HEAD(&amp;fw-&gt;fw.chunk_list);
++	INIT_LIST_HEAD(&amp;fw-&gt;uc.chunk_list);
++	
++	filp = filp_open(fn, 0, 0);
++	if (IS_ERR(filp)) {
++		printk(KERN_INFO &quot;Unable to load '%s'.\n&quot;, fn);
++		return 1;
++	}
++
++	l = i_size_read(filp-&gt;f_dentry-&gt;d_inode);
++	IPW2100_DEBUG_FW(&quot;Loading %ld bytes for firmware '%s'\n&quot;, l, fn);
++	
++	if (vfs_read(filp, (char *)&amp;h, sizeof(h), &amp;filp-&gt;f_pos) != sizeof(h)) {
++		printk(KERN_INFO &quot;Failed to read '%s'.\n&quot;, fn);
++		goto fail;
++	}
++
++	if (IPW2100_FW_MAJOR(h.version) != IPW2100_FW_MAJOR_VERSION) {
++		printk(KERN_WARNING &quot;Firmware image not compatible &quot;
++		       &quot;(detected version id of %u). &quot;
++		       &quot;See Documentation/networking/README.ipw2100\n&quot;,
++		       h.version);
++		goto fail;
++	}
++
++	fw-&gt;version = h.version;
++
++	if (ipw2100_fw_load(filp, &amp;fw-&gt;fw, h.fw_size))
++		goto fail;
++
++	if (ipw2100_fw_load(filp, &amp;fw-&gt;uc, h.uc_size))
++		goto fail;
++
++	filp_close(filp, current-&gt;files);
++	return 0;
++
++ fail:
++	ipw2100_fw_free(fw);
++	filp_close(filp, current-&gt;files);
++	return 1;
++}
++
++#endif /* LINUX_VERSION_CODE &lt; 2.6.0 */
++
+ 
+ static int ipw2100_mod_firmware_load(const char *fn, struct ipw2100_fw *fw)
+ {

Deleted: trunk/rpms/kernel-module-ipw2100/ipw2100.autotools.patch
===================================================================
--- trunk/rpms/kernel-module-ipw2100/ipw2100.autotools.patch	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/kernel-module-ipw2100/ipw2100.autotools.patch	2004-08-25 15:01:13 UTC (rev 2095)
@@ -1,1009 +0,0 @@
-Index: kernel-module-ipw2100/ipw2100-0.45/configure.ac
---- kernel-module-ipw2100~autotools.0.45/ipw2100-0.45/configure.ac	2004-05-22 13:40:37.000000000 +0200
-+++ kernel-module-ipw2100/ipw2100-0.45/configure.ac	2004-05-22 15:32:23.000000000 +0200
-@@ -0,0 +1,63 @@
-+AC_INIT(ipw2100_main.c)
-+
-+AM_INIT_AUTOMAKE(ipw2100, 0.40)
-+dnl AM_CONFIG_HEADER(config.h)
-+
-+dnl pick up ACLOCAL flags
-+ACLOCAL_AMFLAGS=&quot;\${ACLOCAL_FLAGS} -I m4&quot;
-+AC_SUBST(ACLOCAL_AMFLAGS)
-+
-+dnl do all checks
-+AS_LINUX
-+
-+dnl generate modtool
-+AS_LINUX_MODTOOL
-+
-+dnl to do proper versioning, we need to know if we have pre-2.4 style
-+dnl kernel or post-2.6
-+AC_MSG_CHECKING([for correct way to include symbol versions])
-+case $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR in
-+  2.[[67]])
-+    dnl we have to modtool include a .symvers symbol file
-+    AC_MSG_RESULT([post-2.6 .symvers modtool include])
-+    SYMVERS_MODE=&quot;symvers&quot;
-+    ;;
-+  2.[[01234]])
-+    dnl we have to source include a .ver include file
-+    AC_MSG_RESULT([pre-2.6 .ver compile include])
-+    SYMVERS_MODE=&quot;ver&quot;
-+    ;;
-+  *)
-+    AC_MSG_ERROR([Unknown Linux major.minor $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR])
-+    ;;
-+esac
-+AM_CONDITIONAL(SYMVERS_MODE, [test &quot;$SYMVERS_MODE&quot; = &quot;symvers&quot;])
-+
-+dnl add a parameter to disable legacy loading of firmware
-+AC_ARG_ENABLE(legacy-fw-load,
-+  AC_HELP_STRING([--disable-legacy-fw-load],
-+                 [disable loading of firmware the legacy way]),
-+  LEGACY_FW_LOAD=$enableval, LEGACY_FW_LOAD=yes)
-+if test &quot;x$LEGACY_FW_LOAD&quot; = &quot;xyes&quot;
-+then
-+  AC_MSG_NOTICE([Compiling with legacy firmware loading])
-+else
-+  AC_MSG_NOTICE([Compiling with hotplug firmware loading])
-+fi
-+AM_CONDITIONAL(LEGACY_FW_LOAD, test &quot;x$LEGACY_FW_LOAD&quot; = &quot;xyes&quot;)
-+
-+dnl add a parameter to disable WEP
-+AC_ARG_ENABLE(wep,
-+  AC_HELP_STRING([--disable-wep],
-+                 [disable WEP support]),
-+  WEP=$enableval, WEP=yes)
-+if test &quot;x$WEP&quot; = &quot;xyes&quot;
-+then
-+  AC_MSG_NOTICE([Compiling with WEP support (which needs hostap)])
-+  dnl FIXME: add a check for hostap.ver here ?
-+else
-+  AC_MSG_NOTICE([Compiling without WEP support])
-+fi
-+AM_CONDITIONAL(WEP, test &quot;x$WEP&quot; = &quot;xyes&quot;)
-+
-+AC_OUTPUT(Makefile)
-Index: kernel-module-ipw2100/ipw2100-0.45/autogen.sh
---- kernel-module-ipw2100~autotools.0.45/ipw2100-0.45/autogen.sh	2004-05-22 13:40:41.000000000 +0200
-+++ kernel-module-ipw2100/ipw2100-0.45/autogen.sh	2004-05-22 13:41:31.000000000 +0200
-@@ -0,0 +1,6 @@
-+#!/bin/bash
-+set -x
-+aclocal -I m4 || exit 1
-+autoconf || exit 1
-+automake -a --foreign || exit 1
-+./configure $@
-Index: kernel-module-ipw2100/ipw2100-0.45/Makefile.am
---- kernel-module-ipw2100~autotools.0.45/ipw2100-0.45/Makefile.am	2004-05-22 13:40:44.000000000 +0200
-+++ kernel-module-ipw2100/ipw2100-0.45/Makefile.am	2004-06-04 12:10:09.000000000 +0200
-@@ -0,0 +1,69 @@
-+moduledir = $(modulesdir)/kernel/drivers/net/wireless
-+module_PROGRAMS = ipw2100.ko
-+                                                                                
-+# check if we want legacy firmware loading
-+if LEGACY_FW_LOAD
-+LEGACY_FW_LOAD_CFLAGS = -DCONFIG_IPW2100_LEGACY_FW_LOAD
-+else
-+LEGACY_FW_LOAD_CFLAGS =
-+endif
-+
-+# check if we want to disable WEP
-+# FIXME: maybe we should also check if we're compiling with module versioning
-+if WEP
-+if SYMVERS_MODE
-+# for post-2.6
-+WEP_SYMVERSFLAGS = -i $(LINUX_DIR)/hostap.o.symvers
-+WEP_CFLAGS =
-+else
-+# for 2.4
-+WEP_SYMVERSFLAGS =
-+WEP_CFLAGS = -include linux/modules/hostap.ver
-+endif
-+else
-+WEP_CFLAGS = -DCONFIG_IPW2100_NOWEP
-+WEP_SYMVERSFLAGS =
-+endif
-+
-+ipw2100_ko_SOURCES = \
-+        ipw2100_main.c \
-+        ipw2100_fw.c \
-+        ipw2100_wx.c \
-+        ieee80211_tx.c \
-+        ieee80211_rx.c \
-+        ieee80211.c \
-+        ieee80211_wx.c
-+
-+# we are building from this package and not included in kernel
-+# we add an include path for builddir/include/modules/hostap
-+# we also include the hostap version file since we use module versioning
-+ipw2100_ko_CFLAGS = \
-+  $(LINUX_CFLAGS) \
-+  -I $(LINUX_DIR)/include/modules/hostap \
-+  -DNOKERNEL \
-+  $(LEGACY_FW_LOAD_CFLAGS) \
-+  $(WEP_CFLAGS)
-+ipw2100_ko_LINK = $(top_builddir)/modtool --link $(WEP_SYMVERSFLAGS) -o $@
-+
-+# FIXME: might be good to make hostap install the hostap_crypt header !
-+noinst_HEADERS = \
-+  ieee80211_crypt.h \
-+  ieee80211.h \
-+  ipw2100_fw.h \
-+  ipw2100.h \
-+  ipw2100_hw.h \
-+  ipw2100_wx.h \
-+  ipwversion.h
-+
-+EXTRA_DIST = \
-+  m4/as-linux.m4 \
-+  av5100.c \
-+  ieee80211.c \
-+  pbe5.c
-+
-+DISTCHECK_CONFIGURE_FLAGS = --with-modulesdir=`mktemp -d`
-+
-+DISTCLEANFILES = modtool
-+
-+distclean-local:
-+	-rm -rf .mods
-Index: kernel-module-ipw2100/ipw2100-0.45/m4/as-linux.m4
---- kernel-module-ipw2100~autotools.0.45/ipw2100-0.45/m4/as-linux.m4	2004-05-22 13:40:58.000000000 +0200
-+++ kernel-module-ipw2100/ipw2100-0.45/m4/as-linux.m4	2004-06-04 11:31:16.000000000 +0200
-@@ -0,0 +1,704 @@
-+dnl as-linux.m4 0.2.1
-+
-+dnl autostars m4 macro for detecting a Linux source tree (or
-+dnl equivalent) for compiling modules.
-+
-+dnl David Schleef &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ds at schleef.org</A>&gt;
-+dnl Frank Mori Hess &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fmhess at users.sourceforge.net</A>&gt;
-+dnl Thomas Vander Stichele &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thomas at apestaart.org</A>&gt;
-+
-+dnl $Id: as-linux.m4,v 1.18 2004/06/03 16:35:58 thomasvs Exp $
-+
-+dnl AS_LINUX()
-+dnl
-+dnl this macro adds the options
-+dnl --with-linuxdir        to specify a kernel build tree location
-+dnl --with-linuxconfig     to specify a kernel .config file
-+dnl --with-kernel-release  to specify an alternative uname -r
-+dnl --with-machine         to specify an alternative uname -m
-+dnl --with-rpm-target      to specify to match the given rpm --target option
-+dnl --with-extraversion    to specify an EXTRAVERSION override
-+dnl --with-modulesdir      to specify the base install location of modules
-+dnl --with-modulesdeveldir to specify the base install location of build stuff
-+
-+dnl this macro defines:
-+dnl LINUX_DIR
-+dnl   The directory where the Linux source resides.
-+dnl CONFIG_FILE
-+dnl   The Linux config file
-+dnl LINUX_ARCH
-+dnl   $(ARCH) in kernel Makefiles
-+dnl LINUX_AFLAGS
-+dnl   $(AFLAGS) in kernel Makefiles
-+dnl LINUX_LDFLAGS
-+dnl   Linker flags used by Linux
-+dnl LINUX_ARFLAGS
-+dnl   Archiver flags used by Linux
-+dnl LINUX_CROSS_COMPILE
-+dnl   Cross-compiler prefix, if any. (example: &quot;powerpc-linux-&quot;)
-+dnl LINUX_KERNELRELEASE
-+dnl   Kernel release name (2.4.5-pre4-ac5-rmk), $(KERNELRELEASE) in
-+dnl   Linux Makefiles.
-+dnl LINUX_CFLAGS
-+dnl   CFLAGS used by Linux.  Includes both $CFLAGS and $MODFLAGS from
-+dnl   kernel Makefiles. Also includes warnings and optimization.
-+dnl LINUX_CC
-+dnl   Compiler used by Linux.
-+dnl LINUX_LD
-+dnl   Path to linker (possibly with options) used by Linux.
-+dnl LINUX_AS
-+dnl   Assembler used by Linux.
-+dnl LINUX_MODULE_EXT
-+dnl   Module extension (.o or .ko)
-+dnl LINUX_MODPOST
-+dnl   path to modpost script
-+dnl LINUX_SMP
-+dnl   set to yes if the kernel is SMP
-+dnl modulesdir
-+dnl   base install path for kernel modules
-+dnl modulesdeveldir
-+dnl   base install path for kernel module development files
-+dnl 
-+dnl End of search list.
-+
-+dnl main entry point
-+dnl checks the version, and figures out all flags to use to make modules.
-+AC_DEFUN([AS_LINUX],
-+[
-+	dnl check if user supplied a uname -r, and if not use the running one
-+	AS_LINUX_KERNEL_RELEASE()
-+	dnl check if user supplied a uname -m, and if not use the running one
-+	AS_LINUX_MACHINE() 	 
-+	dnl check if the user supplied an rpm target arch
-+	dnl override the LINUX_MACHINE value if he did
-+	AS_LINUX_RPM_TARGET($LINUX_KERNEL_RELEASE) 	 
-+  	 
-+	dnl find the kernel source tree for the given uname -r 	 
-+	AS_LINUX_DIR($LINUX_KERNEL_RELEASE) 	 
-+	dnl check if user supplied an EXTRAVERSION, and if not get from uname -r
-+	AS_LINUX_EXTRAVERSION($LINUX_KERNEL_RELEASE) 	 
-+	dnl check if user supplied a config file; if not, guess a good one
-+	AS_LINUX_CONFIG($LINUX_DIR, $LINUX_KERNEL_RELEASE, $LINUX_MACHINE) 	 
-+	dnl check if we're building on pre-FC2 Red Hat/Fedora,
-+	dnl and add some flags if we are 	 
-+	AS_CHECK_REDHAT_PRE_FC2() 	 
-+	dnl check if we're building SMP, and set LINUX_SMP if we are
-+	AS_CHECK_SMP()
-+	dnl check for where to install modules
-+	AS_LINUX_MODULESDIR($LINUX_KERNEL_RELEASE)
-+	dnl check for where to install module development files
-+	AS_LINUX_MODULESDEVELDIR($LINUX_DIR)
-+	dnl check for the MAJOR/MINOR version of Linux 	 
-+	AS_LINUX_VERSION_MAJOR_MINOR($LINUX_DIR)
-+
-+	dnl now call the correct macro to get compiler flags
-+	dnl the versioned AS_LINUX macros just use the global variables
-+	dnl this could be cleaned up later on if we feel like it
-+	case $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR in
-+		2.6)
-+			AS_LINUX_2_6()
-+			;;
-+		2.[[01234]])
-+			AS_LINUX_2_4()
-+			;;
-+		*)
-+			AC_MSG_ERROR([Unknown Linux major.minor $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR])
-+			;;
-+	esac
-+])
-+
-+
-+dnl check if we can find a source dir for the Linux kernel
-+dnl defines LINUX_DIR to the absolute location of a usable kernel source tree
-+AC_DEFUN([AS_LINUX_DIR],
-+[
-+	AC_ARG_WITH([linuxdir],
-+		[AC_HELP_STRING([--with-linuxdir=DIR],
-+			[specify path to Linux source directory])],
-+		[LINUX_DIR=&quot;${withval}&quot;],
-+		[LINUX_DIR=default])
-+
-+	if test &quot;${LINUX_DIR}&quot; != &quot;default&quot; ; then
-+		AS_TRY_LINUX_DIR([${LINUX_DIR}], , AC_MSG_ERROR([Linux dir not found]) )
-+	fi
-+
-+	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
-+		dir=&quot;/lib/modules/`uname -r`/build&quot;;
-+		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
-+	fi
-+	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
-+		dir=&quot;../linux&quot;;
-+		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
-+	fi
-+	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
-+		dir=&quot;/usr/src/linux&quot;;
-+		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
-+	fi
-+
-+	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
-+		AC_MSG_ERROR([Linux source directory not found])
-+	fi
-+
-+	AC_SUBST(LINUX_DIR)
-+])
-+
-+dnl check if the given candidate path for a linux source tree is usable
-+AC_DEFUN([AS_TRY_LINUX_DIR],
-+	[AC_MSG_CHECKING(for Linux in $1)
-+
-+	if test -f &quot;$1/Makefile&quot; ; then
-+		result=yes
-+		$2
-+	else
-+		result=&quot;not found&quot;
-+		$3
-+	fi
-+
-+	AC_MSG_RESULT($result)
-+])
-+
-+dnl allow for specifying a kernel release (uname -r) to build for
-+dnl use uname -r of running one if not specified
-+dnl store result in LINUX_KERNEL_RELEASE
-+AC_DEFUN([AS_LINUX_KERNEL_RELEASE],
-+[
-+	AC_ARG_WITH([kernel-release],
-+		[AC_HELP_STRING([--with-kernel-release=RELEASE],
-+			[specify the &quot;uname -r&quot;-value to build for])],
-+		[LINUX_KERNEL_RELEASE=&quot;${withval}&quot;],
-+		[LINUX_KERNEL_RELEASE=`uname -r`])
-+        if test &quot;x$LINUX_KERNEL_RELEASE&quot; = &quot;xyes&quot;;
-+        then
-+		LINUX_KERNEL_RELEASE=`uname -r`
-+        fi
-+        AC_MSG_NOTICE([Using $LINUX_KERNEL_RELEASE as the uname -r value])
-+])
-+
-+dnl allow for specifying a machine (uname -m) to build for
-+dnl use uname -, of running one if not specified
-+dnl store result in LINUX_MACHINE
-+AC_DEFUN([AS_LINUX_MACHINE],
-+[
-+	AC_ARG_WITH([machine],
-+		[AC_HELP_STRING([--with-machine=MACHINE],
-+			[specify the &quot;uname -m&quot;-value to build for])],
-+		[LINUX_MACHINE=&quot;${withval}&quot;],
-+		[LINUX_MACHINE=`uname -m`])
-+        if test &quot;x$LINUX_MACHINE&quot; = &quot;xyes&quot;;
-+        then
-+		LINUX_MACHINE=`uname -r`
-+        fi
-+        AC_MSG_NOTICE([Using $LINUX_MACHINE as the uname -m value])
-+])
-+dnl allow for specifying an rpm target arch
-+dnl if none specified, try to guess one from running rpm querying for
-+dnl the kernel with the uname -r
-+dnl this is so configure without arguments works out of the box
-+dnl FIXME: investigate if uname -p is a correct guess for this, and if
-+dnl we should have a flag for specifying it instead
-+
-+dnl this macro possibly overrides LINUX_MACHINE
-+
-+dnl first argument is the kernel release building for
-+AC_DEFUN([AS_LINUX_RPM_TARGET],
-+[
-+	RELEASE=$1
-+	AC_ARG_WITH([rpm-target],
-+		[AC_HELP_STRING([--with-rpm-target=TARGET],
-+			[specify the target arch to build for])],
-+		[LINUX_RPM_TARGET=&quot;${withval}&quot;],
-+		[LINUX_RPM_TARGET=])
-+	if test &quot;x$LINUX_RPM_TARGET&quot; = &quot;x&quot;
-+	then
-+		dnl if we have rpm, try to guess the target of the kernel
-+		dnl we want to build for using rpm
-+		AC_PATH_PROG(RPM, rpm, yes, no)
-+		if test &quot;x$RPM&quot; = &quot;xyes&quot;
-+		then
-+			if rpm -q kernel-$RELEASE &gt; /dev/null
-+			then
-+				LINUX_RPM_TARGET=`rpm -q --queryformat %{arch} kernel-$RELEASE`
-+			else
-+				AC_MSG_NOTICE([Cannot guess target arch, consider setting it using --with-rpm-target])
-+			fi
-+		fi
-+	fi
-+
-+	dnl now override LINUX_MACHINE if LINUX_RPM_TARGET is set
-+	if test &quot;x$LINUX_RPM_TARGET&quot; != &quot;x&quot;
-+	then
-+		dnl override LINUX_MACHINE based on this
-+		dnl FIXME: add other possible Red Hat/Fedora/rpm targets here
-+		LINUX_MACHINE=
-+		case &quot;$LINUX_RPM_TARGET&quot; in
-+			i?86) LINUX_MACHINE=i386;;
-+			athlon) LINUX_MACHINE=i386;;
-+			x86_64) LINUX_MACHINE=x86_64;;
-+		esac
-+		if test &quot;x$LINUX_MACHINE&quot; = &quot;x&quot;
-+		then
-+		AC_MSG_ERROR(Could not guess uname -m value from target $LINUX_RPM_TARGET)
-+		fi
-+	fi
-+])
-+
-+
-+dnl allow for specifying an override for EXTRAVERSION
-+dnl if none specified, make it from the passed-in KERNEL_RELEASE (uname -r)
-+dnl resulting value is stored in LINUX_EXTRAVERSION
-+dnl first argument is the uname -r string to use as a fallback
-+AC_DEFUN([AS_LINUX_EXTRAVERSION],
-+[
-+	KERNEL_RELEASE=[$1]
-+	dnl extract the default by getting everything after first -
-+	LINUX_EXTRAVERSION=&quot;-`echo $KERNEL_RELEASE | cut -d- -f 2-`&quot;
-+	AC_ARG_WITH([extraversion],
-+		[AC_HELP_STRING([--with-extraversion=FILE],
-+			[specify override for kernel EXTRAVERSION])],
-+		[LINUX_EXTRAVERSION=&quot;${withval}&quot;],)
-+])
-+
-+
-+dnl check if we can find a config file for the Linux kernel
-+dnl defines LINUX_CONFIG to the absolute location of a usable
-+dnl kernel source config file
-+
-+dnl for rpm distros, it can try and guess the correct config file by
-+dnl checking the global LINUX_RPM_TARGET variable set somewhere else
-+dnl (FIXME: move this to an argument instead ?)
-+
-+dnl first argument is LINUX_DIR to check for possible configs
-+dnl second argument is kernel-release (uname -r)
-+dnl third argument is machine (uname -m)
-+
-+AC_DEFUN([AS_LINUX_CONFIG],
-+[
-+	LINUX_DIR=[$1]
-+	KERNEL_RELEASE=[$2]
-+	MACHINE=[$3]
-+	AC_ARG_WITH([linuxconfig],
-+		[AC_HELP_STRING([--with-linuxconfig=FILE],
-+			[specify path to Linux configuration file])],
-+		[LINUX_CONFIG=&quot;${withval}&quot;],
-+		[LINUX_CONFIG=default])
-+
-+	dnl if a file got specified, try it as a linux config file
-+	if test &quot;${LINUX_CONFIG}&quot; != &quot;default&quot; ; then
-+		AS_TRY_LINUX_CONFIG($LINUX_CONFIG, $MACHINE,
-+                                    ,, AC_MSG_ERROR([Linux config not found]) )
-+	fi
-+
-+        dnl if no file specified, first check for the regular .config file
-+        dnl in LINUX_DIR created by manual configuration
-+	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; ; then
-+		file=&quot;$LINUX_DIR/.config&quot;;
-+		AS_TRY_LINUX_CONFIG($file, $MACHINE,
-+		                    [LINUX_CONFIG=${file}], )
-+	fi
-+        dnl second, try to guess what config file to use for the current kernel
-+	dnl FIXME: the possible arch is from rpmbuild --target, and is
-+	dnl different from the value of ARCH (Makefile) or MACHINE (uname -m)
-+	dnl so we should have a redhat flag to specify the target to find
-+	dnl the correct config file
-+	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; &amp;&amp; test &quot;x$LINUX_RPM_TARGET&quot; != &quot;x&quot;; then
-+		dnl Red Hat stores configuration files for their built kernels
-+		dnl named kernel-(version)-(arch)(extra).config
-+		dnl where arch is athlon, i386, i586, i686, x86_64
-+		dnl and (extra) is empty or -smp, -BOOT, -bigmem
-+		dnl haven't seen combinations of extra yet as of FC1
-+		KVERSION=`echo $KERNEL_RELEASE | cut -d- -f1`
-+		extra=
-+		echo $KERNEL_RELEASE | grep smp &amp;&amp; EXTRA=&quot;-smp&quot;
-+		echo $KERNEL_RELEASE | grep bigmem &amp;&amp; EXTRA=&quot;-bigmem&quot;
-+		echo $KERNEL_RELEASE | grep BOOT &amp;&amp; EXTRA=&quot;-BOOT&quot;
-+		file=&quot;$LINUX_DIR/configs/kernel-$KVERSION-$LINUX_RPM_TARGET$EXTRA.config&quot;
-+		AS_TRY_LINUX_CONFIG($file, $MACHINE,
-+		                    [LINUX_CONFIG=${file}], )
-+	fi
-+	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; ; then
-+		AC_MSG_ERROR([
-+The kernel source tree at ${LINUX_DIR} is not configured,
-+and no configuration files in config/ matching your kernel were found.
-+Fix before continuing or specify a config file using --with-configfile.])
-+	fi
-+
-+	AC_SUBST(LINUX_CONFIG)
-+])
-+
-+dnl check if the given candidate config file is usable
-+dnl FIXME: it would be nice if it could check if it matches the
-+dnl given machine (uname -m)
-+AC_DEFUN([AS_TRY_LINUX_CONFIG],
-+[
-+	CFG=[$1]
-+	MACHINE=[$2]
-+	AC_MSG_CHECKING($CFG)
-+
-+	if test -f &quot;$CFG&quot; ; then
-+		result=yes
-+		ifelse([$3], , :, [$3])
-+	else
-+		result=&quot;not found&quot;
-+		ifelse([$4], , :, [$4])
-+	fi
-+	AC_MSG_RESULT($result)
-+])
-+
-+dnl check if RED_HAT_LINUX_KERNEL is defined
-+dnl pre-FC2 RH/Fedora defines this in linux/rhconfig.h
-+dnl included from linux/version.h
-+dnl if this is present, a few extra defines need to be present to make sure
-+dnl symbol versioning is correct
-+dnl uses LINUX_DIR to find rhconfig.h
-+AC_DEFUN([AS_CHECK_REDHAT_PRE_FC2],
-+[
-+	AC_MSG_CHECKING(Pre-FC2 Red Hat/Fedora kernel)
-+        HAVE_REDHAT_KERNEL=false
-+        ac_save_CFLAGS=&quot;$CFLAGS&quot;
-+        CFLAGS=&quot;$CFLAGS -I${LINUX_DIR}/include/linux&quot;
-+        AC_COMPILE_IFELSE(AC_LANG_PROGRAM([
-+#define __BOOT_KERNEL_H_
-+#include &quot;rhconfig.h&quot;
-+int code = RED_HAT_LINUX_KERNEL;
-+	]),
-+        AC_MSG_RESULT(found); HAVE_REDHAT_KERNEL=true,
-+        AC_MSG_RESULT(not found))
-+	dnl restore CFLAGS
-+        CFLAGS=&quot;$ac_save_CFLAGS&quot;
-+
-+	dnl check for Red Hat define flags to use - see /sbin/mkkerneldoth
-+
-+	dnl initialize the booleans we want to detect
-+	ENTERPRISE='0'
-+	SMP='0'
-+	UP='0'
-+	BIGMEM='0'
-+	HUGEMEM='0'
-+
-+	dnl get variables from the currently running kernel as default 
-+	KERNEL_TYPE=`uname -r | sed 's_^.*\(smp\|enterprise\|bigmem\|hugemem\)$_\1_;t;s_.*__;'`
-+	KERNEL_RELEASE=`uname -r | sed 's|smp\|enterprise\|bigmem\|hugemem||g'`
-+	KERNEL_ARCH=`uname -m`
-+
-+	dnl check the config file and override KERNEL_ARCH
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M386, KERNEL_ARCH=i386)
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M586, KERNEL_ARCH=i586)
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M686, KERNEL_ARCH=i686)
-+	dnl for some reason the i686 bigmem config file has PENTIUM
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_MPENTIUMIII, KERNEL_ARCH=i686)
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_MK7, KERNEL_ARCH=athlon)
-+
-+	dnl check the config file and override KERNEL_TYPE
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_SMP, KERNEL_TYPE=smp)
-+	dnl bigmem is also smp, so this check is done after smp to override
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_HIGHMEM64G, KERNEL_TYPE=bigmem)
-+
-+	dnl FIXME: need to check hugemem and enterprise config files, which
-+	dnl aren't provided in Fedora Core 1 !
-+
-+	case &quot;$KERNEL_TYPE&quot; in
-+		smp) SMP='1';;
-+		enterprise) ENTERPRISE='1';;
-+		bigmem) BIGMEM='1';;
-+		hugemem) HUGEMEM='1';;
-+		*) UP='1';;
-+	esac
-+	REDHAT_CFLAGS=&quot;-D__BOOT_KERNEL_H_ -D__MODULE_KERNEL_$KERNEL_ARCH=1&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_ENTERPRISE=$ENTERPRISE&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_UP=$UP&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_SMP=$SMP&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_BIGMEM=$BIGMEM&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_HUGEMEM=$HUGEMEM&quot;
-+
-+	LINUX_REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS&quot;
-+
-+	AC_SUBST(LINUX_KERNEL_TYPE, &quot;$KERNEL_TYPE&quot;)
-+])
-+
-+dnl check if we're building on SMP
-+dnl set LINUX_SMP to yes if we are
-+AC_DEFUN([AS_CHECK_SMP],
-+[
-+	LINUX_SMP=&quot;no&quot;
-+	dnl check the config file and override KERNEL_TYPE
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_SMP, LINUX_SMP=&quot;yes&quot;)
-+	AC_SUBST(LINUX_SMP)
-+])
-+
-+dnl add an argument to specify/override the module install path
-+dnl if nothing specified, it will be /lib/modules/(kernelrel)
-+AC_DEFUN([AS_LINUX_MODULESDIR],
-+[
-+	KERNEL_RELEASE=[$1]
-+	AC_ARG_WITH([modulesdir],
-+		[AC_HELP_STRING([--with-modulesdir=DIR],
-+			[specify path to kernel-specific modules install directory])],
-+		[MODULESDIR=&quot;${withval}&quot;],
-+		[MODULESDIR=default])
-+
-+	if test &quot;${MODULESDIR}&quot; = &quot;default&quot; ; then
-+		MODULESDIR=&quot;/lib/modules/${KERNEL_RELEASE}&quot;
-+	fi
-+	dnl make it available to Makefiles so it can be used in ...dir
-+	AC_SUBST(modulesdir, $MODULESDIR)
-+	AC_MSG_NOTICE([Putting kernel modules under ${MODULESDIR}])
-+])
-+
-+dnl add an argument to specify/override the module devel install path
-+dnl if nothing specified, it will be the passed in LINUXDIR)
-+AC_DEFUN([AS_LINUX_MODULESDEVELDIR],
-+[
-+	LINUXDIR=[$1]
-+	AC_ARG_WITH([modulesdeveldir],
-+		[AC_HELP_STRING([--with-modulesdeveldir=DIR],
-+			[specify path to kernel-specific module development install directory])],
-+		[MODULESDEVELDIR=&quot;${withval}&quot;],
-+		[MODULESDEVELDIR=default])
-+
-+	if test &quot;${MODULESDEVELDIR}&quot; = &quot;default&quot; ; then
-+		MODULESDEVELDIR=&quot;${LINUXDIR}&quot;
-+	fi
-+	dnl make it available to Makefiles so it can be used in ...dir
-+	AC_SUBST(modulesdeveldir, $MODULESDEVELDIR)
-+	AC_MSG_NOTICE([Putting kernel module development files under ${MODULESDEVELDIR}])
-+])
-+
-+AC_DEFUN([AS_LINUX_2_6],
-+[
-+	AC_MSG_CHECKING(for Linux CFLAGS)
-+
-+	{
-+	  tmpdir=`(umask 077 &amp;&amp; mktemp -d -q &quot;./confstatXXXXXX&quot;) 2&gt;/dev/null` &amp;&amp;
-+	  test -n &quot;$tmpdir&quot; &amp;&amp; test -d &quot;$tmpdir&quot;
-+	} ||
-+	{
-+	  tmpdir=./confstat$$-$RANDOM
-+	  (umask 077 &amp;&amp; mkdir $tmpdir)
-+	} ||
-+	{
-+	  echo &quot;$me: cannot create a temporary directory in .&quot; &gt;&amp;2
-+	  { (exit 1); exit 1; }
-+	}
-+
-+	tmpdir=`pwd`/$tmpdir
-+
-+	cat &gt;${tmpdir}/Makefile &lt;&lt;EOF
-+obj-m += fake.o
-+
-+\$(obj)/fake.c: flags
-+	touch \$(obj)/fake.c
-+
-+.PHONY: flags
-+flags:
-+	echo LINUX_ARCH=\&quot;\$(ARCH)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_AFLAGS=\&quot;\$(AFLAGS)\&quot; | sed 's,include,&quot;\$(LINUXDIR)/include&quot;,g'&gt;&gt;\$(obj)/flags
-+	echo LINUX_LDFLAGS=\&quot;\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_ARFLAGS=\&quot;\$(ARFLAGS)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_CROSS_COMPILE=\&quot;\$(CROSS_COMPILE)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_KERNELRELEASE=\&quot;\$(KERNELRELEASE)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_CFLAGS=\&quot;\$(CFLAGS) \$(CPPFLAGS)\&quot; | sed 's,Iinclude,I\$(LINUXDIR)/include,g' &gt;&gt;\$(obj)/flags
-+	echo LINUX_CFLAGS_MODULE=\&quot;\$(CFLAGS_MODULE)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_CC=\&quot;\$(CC)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_LD=\&quot;\$(LD) \$(LDFLAGS) \$(LDFLAGS_MODULE)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_AS=\&quot;\$(AS)\&quot; &gt;&gt;\$(obj)/flags
-+EOF
-+
-+	echo ${MAKE-make} -C ${LINUX_DIR} V=1 SUBDIRS=${tmpdir} LINUXDIR=${LINUX_DIR} MODVERDIR=${tmpdir} modules &gt;&amp;5 2&gt;&amp;5
-+	${MAKE-make} -C ${LINUX_DIR} V=1 SUBDIRS=${tmpdir} LINUXDIR=${LINUX_DIR} MODVERDIR=${tmpdir} modules &gt;&amp;5 2&gt;&amp;5
-+	. ${tmpdir}/flags
-+	rm -rf ${tmpdir}
-+
-+	LINUX_MODULE_EXT=&quot;.ko&quot;
-+
-+	LINUX_CFLAGS=&quot;$LINUX_CFLAGS $LINUX_CFLAGS_MODULE&quot;
-+	LINUX_MODPOST=&quot;$LINUX_DIR/scripts/modpost&quot;
-+
-+	AC_SUBST(LINUX_ARCH)
-+	AC_SUBST(LINUX_AFLAGS)
-+	AC_SUBST(LINUX_LDFLAGS)
-+	AC_SUBST(LINUX_ARFLAGS)
-+	AC_SUBST(LINUX_CROSS_COMPILE)
-+	AC_SUBST(LINUX_KERNELRELEASE)
-+	AC_SUBST(LINUX_CFLAGS)
-+	AC_SUBST(LINUX_CC)
-+	AC_SUBST(LINUX_LD)
-+	AC_SUBST(LINUX_AS)
-+	AC_SUBST(LINUX_MODULE_EXT)
-+	AC_SUBST(LINUX_MODPOST)
-+
-+	AC_MSG_RESULT([$LINUX_CFLAGS])
-+])
-+
-+dnl checks kernel's Makefile for make variables for Linux 2.4
-+dnl adds LINUX_REDHAT_CFLAGS if non-empty
-+AC_DEFUN([AS_LINUX_2_4],
-+[
-+	AC_MSG_CHECKING(for Linux 2.4 make flags)
-+	dnl we try to figure out the CFLAGS by invoking the Makefile on
-+        dnl a test dir
-+        dnl we use the correct config file by substituting the MAKEFILES
-+        dnl Makefile variable, which originally points to .config
-+
-+	if [[ ! -e &quot;${LINUX_DIR}/.hdepend&quot; ]];then
-+		AC_MSG_ERROR([
-+You need to run 'make dep' on the kernel source before continuing.])
-+	fi
-+
-+        if test &quot;x$LINUX_EXTRAVERSION&quot; == &quot;x&quot;; then
-+          EX=
-+        else
-+          EX=&quot;EXTRAVERSION=$LINUX_EXTRAVERSION&quot;
-+        fi
-+
-+        POPDIR=`(pwd)`
-+        cd ${LINUX_DIR}
-+        TMPFILE=`mktemp /tmp/linux.XXXXXXXX` || exit 1
-+	# combine the kernel's Makefile,
-+	# sedded to use our proposed config file,
-+	# sedded to use our proposed machine value,
-+	# with the extra target we add here, to get cflags
-+	# we do not want entering/leaving info on distcheck so we run with -s
-+	( cat Makefile | sed &quot;s|\.config|${LINUX_CONFIG}|g&quot; | sed &quot;s|shell uname -m|shell echo ${LINUX_MACHINE}|g&quot; &amp;&amp; cat &lt;&lt;EOF ) | make -s -f - get_cflags $EX &gt; ${TMPFILE}
-+get_cflags:
-+	@echo LINUX_ARCH=\&quot;\$(ARCH)\&quot;
-+	@echo LINUX_AFLAGS=\&quot;\$(AFLAGS)\&quot; | sed 's_Iinclude_I\&quot;\$(LINUXDIR)/include\&quot;_g'
-+	@echo LINUX_LDFLAGS=\&quot;\&quot;
-+	@echo LINUX_ARFLAGS=\&quot;\$(ARFLAGS)\&quot;
-+	@echo LINUX_CROSS_COMPILE=\&quot;\$(CROSS_COMPILE)\&quot;
-+	@echo LINUX_KERNELRELEASE=\&quot;\$(KERNELRELEASE)\&quot;
-+	@echo LINUX_CFLAGS=\&quot;\$(CFLAGS)\&quot; | sed 's_Iinclude_I\&quot;\$(LINUXDIR)/include\&quot;_g'
-+	@echo LINUX_MODFLAGS=\&quot;\$(MODFLAGS)\&quot;
-+	@echo LINUX_CC=\&quot;\$(CC)\&quot;
-+	@echo LINUX_LD=\&quot;\$(LD) \$(LDFLAGS)\&quot;
-+	@echo LINUX_AS=\&quot;\$(AS)\&quot;
-+EOF
-+        . ${TMPFILE}
-+        rm -rf ${TMPFILE}
-+        cd $POPDIR
-+
-+        LINUX_MODULE_EXT=&quot;.o&quot;
-+
-+	LINUX_CFLAGS=&quot;$LINUX_CFLAGS $LINUX_MODFLAGS&quot;
-+
-+	dnl if we have REDHAT_CFLAGS, put them in LINUX_CFLAGS
-+	if test &quot;x$REDHAT_CFLAGS&quot; != &quot;x&quot;;
-+	then
-+		LINUX_CFLAGS=&quot;$LINUX_CFLAGS $REDHAT_CFLAGS&quot;
-+	fi
-+	AC_SUBST(LINUX_ARCH)
-+	AC_SUBST(LINUX_AFLAGS)
-+	AC_SUBST(LINUX_LDFLAGS)
-+	AC_SUBST(LINUX_ARFLAGS)
-+	AC_SUBST(LINUX_CROSS_COMPILE)
-+	AC_SUBST(LINUX_KERNELRELEASE)
-+	AC_SUBST(LINUX_CFLAGS)
-+	AC_SUBST(LINUX_CC)
-+	AC_SUBST(LINUX_LD)
-+	AC_SUBST(LINUX_AS)
-+	AC_SUBST(LINUX_MODULE_EXT)
-+
-+	AC_MSG_RESULT([ok])
-+
-+	AC_MSG_CHECKING(for Linux 2.4 CFLAGS)
-+	AC_MSG_RESULT($LINUX_CFLAGS)
-+	AC_MSG_CHECKING(for Linux 2.4 LDFLAGS)
-+	AC_MSG_RESULT($LINUX_LDFLAGS)
-+])
-+
-+AC_DEFUN([AS_CHECK_LINUX_CONFIG_OPTION],
-+[
-+	AC_MSG_CHECKING([Linux config option $1])
-+
-+	if grep '^$1=y$' ${LINUX_CONFIG} &gt;/dev/null 2&gt;/dev/null; then
-+		result=yes
-+		$2
-+	else if grep '^$1=m$' ${LINUX_CONFIG} &gt;/dev/null 2&gt;/dev/null; then
-+		result=module
-+		$3
-+	else
-+		result=no
-+		$4
-+	fi
-+	fi
-+
-+	AC_MSG_RESULT([$result])
-+])
-+
-+AC_DEFUN([AS_LINUX_CONFIG_OPTION],
-+[
-+	AS_CHECK_LINUX_CONFIG_OPTION([$1],
-+		[$1=yes],
-+		[$1=module],
-+		[$1=no])
-+
-+	AM_CONDITIONAL([$1],[test &quot;${$1}&quot; = yes])
-+])
-+
-+AC_DEFUN([AS_LINUX_CONFIG_OPTION_MODULE],
-+[
-+	AS_CHECK_LINUX_CONFIG_OPTION([$1],
-+		[$1=yes],
-+		[$1=module],
-+		[$1=no])
-+
-+	AM_CONDITIONAL([$1],[test &quot;${$1}&quot; = yes -o &quot;${$1}&quot; = module])
-+])
-+
-+dnl check for the major/minor version of the Linux source by checking
-+dnl the headers
-+dnl first argument is the linux directory
-+dnl sets LINUX_VERSION_MAJOR and LINUX_VERSION_MINOR
-+AC_DEFUN([AS_LINUX_VERSION_MAJOR_MINOR],
-+[
-+	LINUX_DIR=[$1]
-+	AC_MSG_CHECKING([Linux major/minor version])
-+
-+	if [[ ! -f &quot;${LINUX_DIR}/include/linux/version.h&quot; ]];then
-+		AC_MSG_ERROR([The header file include/linux/version.h does not exist.
-+For 2.6 kernels, it can be generated by running 'make prepare' in
-+the kernel source directory.])
-+	fi
-+        dnl the next set of tests is for figuring out version major/minor
-+        dnl we make sure we have the right version.h by faking out CFLAGS
-+	dnl since we want to avoid including linux/version.h and acidentally
-+	dnl pick up /usr/include/linux
-+	dnl we still add ${LINUX_DIR}/include so the Red Hat version can pick
-+	dnl up linux/rhversion.h
-+        ac_save_CFLAGS=&quot;$CFLAGS&quot;
-+        CFLAGS=&quot;$CFLAGS -I${LINUX_DIR}/include/linux -I${LINUX_DIR}/include&quot;
-+        dnl make sure we find version.h and it contains LINUX_VERSION_CODE
-+        AC_COMPILE_IFELSE(AC_LANG_PROGRAM([
-+/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
-+#define __BOOT_KERNEL_H_
-+#include &quot;version.h&quot;
-+int code = LINUX_VERSION_CODE;
-+]),
-+ :, AC_MSG_ERROR([${LINUX_DIR}/include/linux/version.h does not contain LINUX_VERSION_CODE]))
-+
-+
-+        dnl figure out the linux kernel version major and minor
-+        dnl using the LINUX_VERSION_CODE defined in include/linux/version.h
-+        AC_RUN_IFELSE(AC_LANG_PROGRAM([
-+/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
-+#define __BOOT_KERNEL_H_
-+#include &quot;version.h&quot;
-+#define KERNEL_VERSION_MAJOR(code) ((code) &gt;&gt; 16)
-+],[
-+  return KERNEL_VERSION_MAJOR(LINUX_VERSION_CODE);
-+]),
-+		LINUX_VERSION_MAJOR=0, 
-+		LINUX_VERSION_MAJOR=$?)
-+        AC_RUN_IFELSE(AC_LANG_PROGRAM([
-+/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
-+#define __BOOT_KERNEL_H_
-+#include &quot;version.h&quot;
-+#define KERNEL_VERSION_MINOR(code) (((code) &gt;&gt; 8) % (2 &lt;&lt; 8))
-+],[
-+  return KERNEL_VERSION_MINOR(LINUX_VERSION_CODE);
-+]),
-+		LINUX_VERSION_MINOR=0, 
-+		LINUX_VERSION_MINOR=$?)
-+        AC_MSG_RESULT($LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR)
-+	dnl restore CFLAGS
-+        CFLAGS=&quot;$ac_save_CFLAGS&quot;
-+])
-Index: kernel-module-ipw2100/ipw2100-0.45/m4/as-modtool.m4
---- kernel-module-ipw2100~autotools.0.45/ipw2100-0.45/m4/as-modtool.m4	2004-05-22 13:41:02.000000000 +0200
-+++ kernel-module-ipw2100/ipw2100-0.45/m4/as-modtool.m4	2004-06-04 11:31:18.000000000 +0200
-@@ -0,0 +1,147 @@
-+dnl as-modtool.m4 0.0.1
-+dnl autostars m4 macro for building modtool, a linker for Linux kernel
-+dnl modules
-+
-+dnl David Schleef &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ds at schleef.org</A>&gt;
-+dnl Frank Mori Hess &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fmhess at users.sourceforge.net</A>&gt;
-+dnl Thomas Vander Stichele &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thomas at apestaart.org</A>&gt;
-+
-+dnl $Id: as-modtool.m4,v 1.12 2004/06/03 15:20:11 thomasvs Exp $
-+
-+dnl AS_LINUX_MODTOOL()
-+dnl
-+dnl this macro defines:
-+dnl moduledir
-+dnl modulePROGRAMS_INSTALL
-+dnl modulePROGRAMS_UNINSTALL
-+dnl
-+dnl End of search list.
-+
-+dnl
-+dnl FIXME:
-+dnl  How do you specify that the building of modtool should go to the
-+dnl  end of the configure script?
-+dnl
-+
-+dnl SYMVERS_INCLUDES can be used to add additional .symvers files to the
-+dnl modpost step
-+
-+AC_DEFUN([AS_LINUX_MODTOOL],
-+[
-+	AC_PATH_PROG(STRIP, strip)
-+	AC_PATH_PROG([DEPMOD], [depmod], [no], [$PATH:/sbin:/usr/sbin:/usr/local/sbin])
-+	AC_PATH_PROG([GENKSYMS], [genksyms], [no], [$PATH:/sbin:/usr/sbin:/usr/local/sbin])
-+
-+	if test &quot;x$LINUX_SMP&quot; = &quot;xyes&quot;
-+	then
-+		GENKSYMS=&quot;$GENKSYMS -p smp_&quot;
-+	fi
-+	dnl this can be overridden in Makefile.am
-+	dnl FIXME: it'd be nice if we could specify different target_PROGRAMS
-+	dnl and different targetdir
-+	moduledir=&quot;\$(modulesdir)/\$(PACKAGE)&quot;
-+	modulePROGRAMS_INSTALL=&quot;\$(top_builddir)/modtool --install&quot;
-+	modulePROGRAMS_UNINSTALL=&quot;\$(top_builddir)/modtool --uninstall&quot;
-+	AC_SUBST(moduledir)
-+	AC_SUBST(modulePROGRAMS_INSTALL)
-+
-+	LINUX_VERSION=`echo $LINUX_KERNELRELEASE | cut -d- -f1`
-+
-+	AC_MSG_NOTICE(creating modtool)
-+	cat &gt;modtool &lt;&lt;EOF
-+#!/bin/sh
-+
-+set -e
-+
-+LINUX_LD=&quot;$LINUX_LD&quot;
-+LINUX_MODPOST=&quot;$LINUX_MODPOST&quot;
-+LINUX_VERSION=&quot;$LINUX_VERSION&quot;
-+GENKSYMS=&quot;$GENKSYMS&quot;
-+CC=&quot;$LINUX_CC&quot;
-+INSTALL=&quot;$INSTALL&quot;
-+LINUX_MODULE_EXT=&quot;$LINUX_MODULE_EXT&quot;
-+STRIP=&quot;$STRIP&quot;
-+CFLAGS=&quot;$CFLAGS $LINUX_CFLAGS&quot;
-+LINUX_DIR=&quot;$LINUX_DIR&quot;
-+
-+mode=\$[1]
-+shift
-+
-+case \$mode in
-+--link)
-+	# we accept -i (symvers) and -o (target) as options
-+	# at least -o (target) needs to be specified
-+	SYMVERS_INCLUDES=&quot;&quot;
-+	done=false
-+	while test ! -z &quot;\$[0]&quot; -a &quot;\$done&quot; = &quot;false&quot;
-+	do
-+		case \$[1] in
-+		-i)
-+                        SYMVERS_INCLUDES=&quot;\$SYMVERS_INCLUDES \$[2]&quot;
-+                        shift 2
-+                        ;;
-+                -o)
-+                        target=\$(echo \$[2] | sed s/.ko$//)
-+                        shift 2
-+                        ;;
-+                *)
-+                        done=true
-+                        ;;
-+                esac
-+        done
-+
-+	mkdir -p .mods
-+	if test &quot;\$LINUX_MODULE_EXT&quot; = .ko ; then
-+
-+		\$LINUX_LD -r -o .mods/\$target.o \$[*]
-+
-+		cat \$LINUX_DIR/Module.symvers \$SYMVERS_INCLUDES &gt;.mods/symvers.tmp
-+
-+		\$LINUX_MODPOST -o .mods/\$target.o.symvers.tmp -i .mods/symvers.tmp .mods/\$target.o
-+
-+		grep .mods/\$target .mods/\$target.o.symvers.tmp &gt;.mods/\$target.o.symvers || true
-+
-+		rm -f .mods/\$target.o.symvers.tmp .mods/symvers.tmp
-+		
-+		\$CC \$CFLAGS -DKBUILD_MODNAME=\$target -c -o .mods/\$target.mod.o .mods/\$target.mod.c
-+
-+		\$LINUX_LD -r -o \$target.ko .mods/\$target.mod.o .mods/\$target.o
-+		set +x
-+	else
-+		echo \$LINUX_LD -r -o \$target.ko \$[*]
-+		\$LINUX_LD -r -o \$target.ko \$[*]
-+                                                                      
-+		if test &quot;x\$SOURCES&quot; != &quot;x&quot;
-+		then
-+			echo &quot;\$CC \$CFLAGS -E -D__GENKSYMS__ \$SOURCES | \$GENKSYMS -k \$LINUX_VERSION &gt; .mods/\$target.ver&quot;
-+			\$CC \$CFLAGS -E -D__GENKSYMS__ \$SOURCES | \$GENKSYMS -k \$LINUX_VERSION &gt; .mods/\$target.ver
-+		fi
-+
-+	fi
-+
-+	;;
-+--install)
-+	module_src=\$[1]
-+	module_dest=\`echo \$[2] | sed &quot;s/\.ko$/\${LINUX_MODULE_EXT}/&quot;\`
-+	echo \$INSTALL -m644 &quot;\$module_src&quot; &quot;\$module_dest&quot;
-+	\$INSTALL -m644 &quot;\$module_src&quot; &quot;\$module_dest&quot;
-+	\$STRIP -g &quot;\$module_dest&quot;
-+	;;
-+--uninstall)
-+	module_src=\$[1]
-+	module_dest=\`echo \$[2] | sed &quot;s/\.ko$/\${LINUX_MODULE_EXT}/&quot;\`
-+	echo uninstall &quot;\$module_src&quot; &quot;\$module_dest&quot;
-+	rm -f &quot;\$module_dest&quot;
-+	;;
-+*)
-+	echo Unknown mode \$mode &gt;&amp;2
-+	exit 1
-+esac
-+
-+EOF
-+	chmod +x modtool
-+
-+
-+])
-+
-+

Modified: trunk/rpms/kernel-module-ipw2100/kernel-module-ipw2100.spec
===================================================================
--- trunk/rpms/kernel-module-ipw2100/kernel-module-ipw2100.spec	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/kernel-module-ipw2100/kernel-module-ipw2100.spec	2004-08-25 15:01:13 UTC (rev 2095)
@@ -28,21 +28,20 @@
 
 Summary: Driver for Intel&#194;&#174; PRO/Wireless 2100 network adaptors
 Name: kernel-module-ipw2100
-Version: 0.49
-Release: 1
+Version: 0.53
+Release: 0
 License: GPL
 Group: System Environment/Kernel
 URL: <A HREF="http://ipw2100.sourceforge.net/">http://ipw2100.sourceforge.net/</A>
 Source: <A HREF="http://dl.sf.net/ipw2100/ipw2100-%{version">http://dl.sf.net/ipw2100/ipw2100-%{version</A>}.tgz
 Source1: ieee802_11.h
-Patch: ipw2100-0.49-autotools.patch
+Patch0: ipw2100-0.53-autotools.patch
+Patch1: ipw2100-0.53-vfs_read_2.patch
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
 %if %{post26}
 BuildRequires: kernel-module-devel-%{krel}
-BuildRequires: kernel-module-hostap-devel-%{krel}
 %else
 BuildRequires: kernel-source = %{krel}
-BuildRequires: kernel-module-hostap-%{krel}
 %endif
 BuildRequires: autoconf, automake
 
@@ -62,10 +61,8 @@
 Requires(post): modutils
 Requires(postun): modutils
 Requires: /boot/vmlinuz-%{kernel}
-# We require the hostap module
-Requires: kernel-module-hostap-%{krel}
 # And firmware too
-Requires: ipw2100-firmware
+Requires: ipw2100-firmware &gt;= 1.2
 
 %description %{kernel}
 This package contains a kernel module for the Intel&#194;&#174; PRO/Wireless 2100
@@ -74,7 +71,8 @@
 
 %prep
 %setup -q -n ipw2100-%{version}
-%patch -p1
+%patch0 -p1
+%patch1 -p1
 # Include file missing from the Fedora Core kernels (as of 2.6.6-1.435.2.3)
 %{__install} -m 0644 %{SOURCE1} ieee802_11.h
 
@@ -113,9 +111,18 @@
 %files %{kernel}
 %defattr(-, root, root, 0755)
 /lib/modules/%{kernel}%{?updates}/kernel/drivers/net/wireless/ipw2100.*o
+/lib/modules/%{kernel}%{?updates}/kernel/drivers/net/wireless/ieee80211.*o
+/lib/modules/%{kernel}%{?updates}/kernel/drivers/net/wireless/ieee80211_crypt.*o
+/lib/modules/%{kernel}%{?updates}/kernel/drivers/net/wireless/ieee80211_crypt_wep.*o
 
 
 %changelog
+* Wed Aug 25 2004 Matthias Saou &lt;<A HREF="http://freshrpms.net">http://freshrpms.net</A>&gt; 0.53-0
+- Update to 0.53 with Thomas's new patch.
+- Remove no longer needed hostap module stuff.
+- Added ipw2100-0.53-vfs_read_2.patch to workaround sys_* symbols not being
+  exported in RH kernels (see bugzilla #115843).
+
 * Tue Jul 13 2004 Matthias Saou &lt;<A HREF="http://freshrpms.net">http://freshrpms.net</A>&gt; 0.49-1
 - Update to 0.49.
 - Bundle ieee802_11.h for now, ugly.

Modified: trunk/rpms/kernel-module-qc-usb/kernel-module-qc-usb.spec
===================================================================
--- trunk/rpms/kernel-module-qc-usb/kernel-module-qc-usb.spec	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/kernel-module-qc-usb/kernel-module-qc-usb.spec	2004-08-25 15:01:13 UTC (rev 2095)
@@ -31,13 +31,13 @@
 
 Summary: Driver for Logitech QuickCam webcams using qc-usb
 Name: kernel-module-qc-usb
-Version: 0.6.0
+Version: 0.6.1
 Release: 0
 License: GPL
 Group: System Environment/Kernel
 URL: <A HREF="http://qce-ga.sourceforge.net/">http://qce-ga.sourceforge.net/</A>
 Source: <A HREF="http://dl.sf.net/qce-ga/qc-usb-%{version">http://dl.sf.net/qce-ga/qc-usb-%{version</A>}.tar.gz
-Patch: qc-usb.autotools.patch
+Patch: qc-usb-0.6.1-autotools.patch
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
 %if %{post26}
 BuildRequires: kernel-module-devel-%{krel}
@@ -78,7 +78,7 @@
 
 %prep
 %setup -q -n qc-usb-%{version}
-%patch -p2
+%patch -p1
 
 
 %build
@@ -134,6 +134,10 @@
 
 
 %changelog
+* Wed Aug 25 2004 Matthias Saou &lt;<A HREF="http://freshrpms.net">http://freshrpms.net</A>&gt; 0.6.1-0
+- Update to 0.6.1.
+- Updated m4 files to Thomas's latest.
+
 * Thu Jun 17 2004 Matthias Saou &lt;<A HREF="http://freshrpms.net">http://freshrpms.net</A>&gt; 0.6.0-0
 - Takeover the spec.
 

Added: trunk/rpms/kernel-module-qc-usb/qc-usb-0.6.1-autotools.patch
===================================================================
--- trunk/rpms/kernel-module-qc-usb/qc-usb-0.6.1-autotools.patch	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/kernel-module-qc-usb/qc-usb-0.6.1-autotools.patch	2004-08-25 15:01:13 UTC (rev 2095)
@@ -0,0 +1,988 @@
+diff -Naupr qc-usb-0.6.1.orig/autogen.sh qc-usb-0.6.1/autogen.sh
+--- qc-usb-0.6.1.orig/autogen.sh	1970-01-01 01:00:00.000000000 +0100
++++ qc-usb-0.6.1/autogen.sh	2004-08-25 15:54:48.811827976 +0200
+@@ -0,0 +1,6 @@
++#!/bin/bash
++set -x
++aclocal -I m4 || exit 1
++autoconf || exit 1
++automake -a --foreign || exit 1
++./configure $@
+diff -Naupr qc-usb-0.6.1.orig/configure.ac qc-usb-0.6.1/configure.ac
+--- qc-usb-0.6.1.orig/configure.ac	1970-01-01 01:00:00.000000000 +0100
++++ qc-usb-0.6.1/configure.ac	2004-08-25 15:54:48.811827976 +0200
+@@ -0,0 +1,10 @@
++AC_INIT(qc-driver.c)
++
++AM_INIT_AUTOMAKE(qc-usb, 0.5.1)
++dnl AM_CONFIG_HEADER(config.h)
++
++dnl look for Linux kernel source
++AS_LINUX
++AS_LINUX_MODTOOL
++
++AC_OUTPUT(Makefile testquickcam/Makefile)
+diff -Naupr qc-usb-0.6.1.orig/m4/as-linux.m4 qc-usb-0.6.1/m4/as-linux.m4
+--- qc-usb-0.6.1.orig/m4/as-linux.m4	1970-01-01 01:00:00.000000000 +0100
++++ qc-usb-0.6.1/m4/as-linux.m4	2004-08-25 15:54:48.815827368 +0200
+@@ -0,0 +1,775 @@
++dnl as-linux.m4 0.2.4
++
++dnl autostars m4 macro for detecting a Linux source tree (or
++dnl equivalent) for compiling modules.
++
++dnl David Schleef &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ds at schleef.org</A>&gt;
++dnl Frank Mori Hess &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fmhess at users.sourceforge.net</A>&gt;
++dnl Thomas Vander Stichele &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thomas at apestaart.org</A>&gt;
++
++dnl $Id: as-linux.m4,v 1.21 2004/08/24 15:52:07 thomasvs Exp $
++
++dnl AS_LINUX()
++dnl
++dnl this macro adds the options
++dnl --with-linuxdir        to specify a kernel build tree location
++dnl --with-linuxconfig     to specify a kernel .config file
++dnl --with-kernel-release  to specify an alternative uname -r
++dnl --with-machine         to specify an alternative uname -m
++dnl --with-rpm-target      to specify to match the given rpm --target option
++dnl --with-extraversion    to specify an EXTRAVERSION override
++dnl --with-modulesdir      to specify the base install location of modules
++dnl --with-modulesdeveldir to specify the base install location of build stuff
++dnl --without-modules      to specify not to build the modules
++dnl --without-userspace    to specify not to build userspace stuff
++
++dnl this macro defines:
++dnl LINUX_DIR
++dnl   The directory where the Linux source resides.
++dnl CONFIG_FILE
++dnl   The Linux config file
++dnl LINUX_ARCH
++dnl   $(ARCH) in kernel Makefiles
++dnl LINUX_AFLAGS
++dnl   $(AFLAGS) in kernel Makefiles
++dnl LINUX_LDFLAGS
++dnl   Linker flags used by Linux
++dnl LINUX_ARFLAGS
++dnl   Archiver flags used by Linux
++dnl LINUX_CROSS_COMPILE
++dnl   Cross-compiler prefix, if any. (example: &quot;powerpc-linux-&quot;)
++dnl LINUX_KERNELRELEASE
++dnl   Kernel release name (2.4.5-pre4-ac5-rmk), $(KERNELRELEASE) in
++dnl   Linux Makefiles.
++dnl LINUX_CFLAGS
++dnl   CFLAGS used by Linux.  Includes both $CFLAGS and $MODFLAGS from
++dnl   kernel Makefiles. Also includes warnings and optimization.
++dnl LINUX_CC
++dnl   Compiler used by Linux.
++dnl LINUX_LD
++dnl   Path to linker (possibly with options) used by Linux.
++dnl LINUX_AS
++dnl   Assembler used by Linux.
++dnl LINUX_MODULE_EXT
++dnl   Module extension (.o or .ko)
++dnl LINUX_MODPOST
++dnl   path to modpost script
++dnl LINUX_SMP
++dnl   set to yes if the kernel is SMP
++dnl modulesdir
++dnl   base install path for kernel modules
++dnl modulesdeveldir
++dnl   base install path for kernel module development files
++dnl 
++dnl End of search list.
++
++dnl main entry point
++dnl checks the version, and figures out all flags to use to make modules.
++AC_DEFUN([AS_LINUX],
++[
++	dnl check whether or not to build modules
++	AS_LINUX_CHECK_BUILD_MODULES()
++	dnl check whether or not to build userspace
++	AS_LINUX_CHECK_BUILD_USERSPACE()
++
++	if test &quot;x$BUILD_MODULES&quot; != &quot;xno&quot;
++        then
++	dnl check if user supplied a uname -r, and if not use the running one
++	AS_LINUX_KERNEL_RELEASE()
++	dnl check if user supplied a uname -m, and if not use the running one
++	AS_LINUX_MACHINE() 	 
++	dnl check if the user supplied an rpm target arch
++	dnl override the LINUX_MACHINE value if he did
++	AS_LINUX_RPM_TARGET($LINUX_KERNEL_RELEASE) 	 
++  	 
++	dnl find the kernel source tree for the given uname -r 	 
++	AS_LINUX_DIR($LINUX_KERNEL_RELEASE) 	 
++	dnl check if user supplied an EXTRAVERSION, and if not get from uname -r
++	AS_LINUX_EXTRAVERSION($LINUX_KERNEL_RELEASE) 	 
++	dnl check if user supplied a config file; if not, guess a good one
++	AS_LINUX_CONFIG($LINUX_DIR, $LINUX_KERNEL_RELEASE, $LINUX_MACHINE) 	 
++	dnl check if we're building on pre-FC2 Red Hat/Fedora,
++	dnl and add some flags if we are 	 
++	AS_CHECK_REDHAT_PRE_FC2() 	 
++	dnl check if we're building SMP, and set LINUX_SMP if we are
++	AS_CHECK_SMP()
++	dnl check for where to install modules
++	AS_LINUX_MODULESDIR($LINUX_KERNEL_RELEASE)
++	dnl check for where to install module development files
++	AS_LINUX_MODULESDEVELDIR($LINUX_DIR)
++	dnl check for the MAJOR/MINOR version of Linux 	 
++	AS_LINUX_VERSION_MAJOR_MINOR($LINUX_DIR)
++
++	dnl now call the correct macro to get compiler flags
++	dnl the versioned AS_LINUX macros just use the global variables
++	dnl this could be cleaned up later on if we feel like it
++	case $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR in
++		2.6)
++			AS_LINUX_2_6()
++			;;
++		2.[[01234]])
++			AS_LINUX_2_4()
++			;;
++		*)
++			AC_MSG_ERROR([Unknown Linux major.minor $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR])
++			;;
++	esac
++        fi
++])
++
++
++dnl check if we can find a source dir for the Linux kernel
++dnl defines LINUX_DIR to the absolute location of a usable kernel source tree
++AC_DEFUN([AS_LINUX_DIR],
++[
++	AC_ARG_WITH([linuxdir],
++		[AC_HELP_STRING([--with-linuxdir=DIR],
++			[specify path to Linux source directory])],
++		[LINUX_DIR=&quot;${withval}&quot;],
++		[LINUX_DIR=default])
++
++	dnl if specified, use the specified one
++	if test &quot;${LINUX_DIR}&quot; != &quot;default&quot; ; then
++		AS_TRY_LINUX_DIR([${LINUX_DIR}], , AC_MSG_ERROR([Linux dir not found]) )
++	fi
++
++	dnl if not specified, first try with previously set LINUX_KERNEL_RELEASE
++	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
++		dir=&quot;/lib/modules/$LINUX_KERNEL_RELEASE/build&quot;;
++		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
++	fi
++
++	dnl next try using the kernel source dir
++	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
++		dir=&quot;/usr/src/linux-$LINUX_KERNEL_RELEASE&quot;;
++		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
++	fi
++
++	dnl then try a common default of /usr/src/linux
++	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
++		dir=&quot;/usr/src/linux&quot;;
++		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
++	fi
++
++	dnl if still nothing found, fail
++	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
++		AC_MSG_ERROR([Linux source directory not found])
++	fi
++
++	AC_SUBST(LINUX_DIR)
++])
++
++dnl check if the given candidate path for a linux source tree is usable
++AC_DEFUN([AS_TRY_LINUX_DIR],
++	[AC_MSG_CHECKING(for Linux in $1)
++
++	if test -f &quot;$1/Makefile&quot; ; then
++		result=yes
++		$2
++	else
++		result=&quot;not found&quot;
++		$3
++	fi
++
++	AC_MSG_RESULT($result)
++])
++
++dnl allow for specifying a kernel release (uname -r) to build for
++dnl use uname -r of running one if not specified
++dnl store result in LINUX_KERNEL_RELEASE
++AC_DEFUN([AS_LINUX_KERNEL_RELEASE],
++[
++	AC_ARG_WITH([kernel-release],
++		[AC_HELP_STRING([--with-kernel-release=RELEASE],
++			[specify the &quot;uname -r&quot;-value to build for])],
++		[LINUX_KERNEL_RELEASE=&quot;${withval}&quot;],
++		[LINUX_KERNEL_RELEASE=`uname -r`])
++        if test &quot;x$LINUX_KERNEL_RELEASE&quot; = &quot;xyes&quot;;
++        then
++		LINUX_KERNEL_RELEASE=`uname -r`
++        fi
++        AC_MSG_NOTICE([Using $LINUX_KERNEL_RELEASE as the uname -r value])
++])
++
++dnl allow for specifying a machine (uname -m) to build for
++dnl use uname -, of running one if not specified
++dnl store result in LINUX_MACHINE
++AC_DEFUN([AS_LINUX_MACHINE],
++[
++	AC_ARG_WITH([machine],
++		[AC_HELP_STRING([--with-machine=MACHINE],
++			[specify the &quot;uname -m&quot;-value to build for])],
++		[LINUX_MACHINE=&quot;${withval}&quot;],
++		[LINUX_MACHINE=`uname -m`])
++        if test &quot;x$LINUX_MACHINE&quot; = &quot;xyes&quot;;
++        then
++		LINUX_MACHINE=`uname -r`
++        fi
++        AC_MSG_NOTICE([Using $LINUX_MACHINE as the uname -m value])
++])
++dnl allow for specifying an rpm target arch
++dnl if none specified, try to guess one from running rpm querying for
++dnl the kernel with the uname -r
++dnl this is so configure without arguments works out of the box
++dnl FIXME: investigate if uname -p is a correct guess for this, and if
++dnl we should have a flag for specifying it instead
++
++dnl this macro possibly overrides LINUX_MACHINE
++
++dnl first argument is the kernel release building for
++AC_DEFUN([AS_LINUX_RPM_TARGET],
++[
++	RELEASE=$1
++	AC_ARG_WITH([rpm-target],
++		[AC_HELP_STRING([--with-rpm-target=TARGET],
++			[specify the target arch to build for])],
++		[LINUX_RPM_TARGET=&quot;${withval}&quot;],
++		[LINUX_RPM_TARGET=])
++	if test &quot;x$LINUX_RPM_TARGET&quot; = &quot;x&quot;
++	then
++		dnl if we have rpm, try to guess the target of the kernel
++		dnl we want to build for using rpm
++		AC_PATH_PROG(RPM, rpm, yes, no)
++		if test &quot;x$RPM&quot; = &quot;xyes&quot;
++		then
++			if rpm -q kernel-$RELEASE &gt; /dev/null
++			then
++				LINUX_RPM_TARGET=`rpm -q --queryformat %{arch} kernel-$RELEASE`
++			else
++				AC_MSG_NOTICE([Cannot guess target arch, consider setting it using --with-rpm-target])
++			fi
++		fi
++	fi
++
++	dnl now override LINUX_MACHINE if LINUX_RPM_TARGET is set
++	if test &quot;x$LINUX_RPM_TARGET&quot; != &quot;x&quot;
++	then
++		dnl override LINUX_MACHINE based on this
++		dnl FIXME: add other possible Red Hat/Fedora/rpm targets here
++		LINUX_MACHINE=
++		case &quot;$LINUX_RPM_TARGET&quot; in
++			i?86) LINUX_MACHINE=i386;;
++			athlon) LINUX_MACHINE=i386;;
++			x86_64) LINUX_MACHINE=x86_64;;
++		esac
++		if test &quot;x$LINUX_MACHINE&quot; = &quot;x&quot;
++		then
++		AC_MSG_ERROR(Could not guess uname -m value from target $LINUX_RPM_TARGET)
++		fi
++	fi
++])
++
++
++dnl allow for specifying an override for EXTRAVERSION
++dnl if none specified, make it from the passed-in KERNEL_RELEASE (uname -r)
++dnl resulting value is stored in LINUX_EXTRAVERSION
++dnl first argument is the uname -r string to use as a fallback
++AC_DEFUN([AS_LINUX_EXTRAVERSION],
++[
++	KERNEL_RELEASE=[$1]
++	dnl extract the default by getting everything after first -
++	LINUX_EXTRAVERSION=&quot;-`echo $KERNEL_RELEASE | cut -d- -f 2-`&quot;
++	AC_ARG_WITH([extraversion],
++		[AC_HELP_STRING([--with-extraversion=FILE],
++			[specify override for kernel EXTRAVERSION])],
++		[LINUX_EXTRAVERSION=&quot;${withval}&quot;],)
++])
++
++
++dnl check if we can find a config file for the Linux kernel
++dnl defines LINUX_CONFIG to the absolute location of a usable
++dnl kernel source config file
++
++dnl for rpm distros, it can try and guess the correct config file by
++dnl checking the global LINUX_RPM_TARGET variable set somewhere else
++dnl (FIXME: move this to an argument instead ?)
++
++dnl first argument is LINUX_DIR to check for possible configs
++dnl second argument is kernel-release (uname -r)
++dnl third argument is machine (uname -m)
++
++AC_DEFUN([AS_LINUX_CONFIG],
++[
++	LINUX_DIR=[$1]
++	KERNEL_RELEASE=[$2]
++	MACHINE=[$3]
++	AC_ARG_WITH([linuxconfig],
++		[AC_HELP_STRING([--with-linuxconfig=FILE],
++			[specify path to Linux configuration file])],
++		[LINUX_CONFIG=&quot;${withval}&quot;],
++		[LINUX_CONFIG=default])
++
++	dnl if a file got specified, try it as a linux config file
++	if test &quot;${LINUX_CONFIG}&quot; != &quot;default&quot; ; then
++		AS_TRY_LINUX_CONFIG($LINUX_CONFIG, $MACHINE,
++                                    ,, AC_MSG_ERROR([Linux config not found]) )
++	fi
++
++        dnl if no file specified, first check for the regular .config file
++        dnl in LINUX_DIR created by manual configuration
++	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; ; then
++		file=&quot;$LINUX_DIR/.config&quot;;
++		AS_TRY_LINUX_CONFIG($file, $MACHINE,
++		                    [LINUX_CONFIG=${file}], )
++	fi
++        dnl second, try to guess what config file to use for the current kernel
++	dnl FIXME: the possible arch is from rpmbuild --target, and is
++	dnl different from the value of ARCH (Makefile) or MACHINE (uname -m)
++	dnl so we should have a redhat flag to specify the target to find
++	dnl the correct config file
++	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; &amp;&amp; test &quot;x$LINUX_RPM_TARGET&quot; != &quot;x&quot;; then
++		dnl Red Hat stores configuration files for their built kernels
++		dnl named kernel-(version)-(arch)(extra).config
++		dnl where arch is athlon, i386, i586, i686, x86_64
++		dnl and (extra) is empty or -smp, -BOOT, -bigmem
++		dnl haven't seen combinations of extra yet as of FC1
++		KVERSION=`echo $KERNEL_RELEASE | cut -d- -f1`
++		extra=
++		echo $KERNEL_RELEASE | grep smp &amp;&amp; EXTRA=&quot;-smp&quot;
++		echo $KERNEL_RELEASE | grep bigmem &amp;&amp; EXTRA=&quot;-bigmem&quot;
++		echo $KERNEL_RELEASE | grep BOOT &amp;&amp; EXTRA=&quot;-BOOT&quot;
++		file=&quot;$LINUX_DIR/configs/kernel-$KVERSION-$LINUX_RPM_TARGET$EXTRA.config&quot;
++		AS_TRY_LINUX_CONFIG($file, $MACHINE,
++		                    [LINUX_CONFIG=${file}], )
++	fi
++	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; ; then
++		AC_MSG_ERROR([
++The kernel source tree at ${LINUX_DIR} is not configured,
++and no configuration files in config/ matching your kernel were found.
++Fix before continuing or specify a config file using --with-configfile.])
++	fi
++
++	AC_SUBST(LINUX_CONFIG)
++])
++
++dnl check if the given candidate config file is usable
++dnl FIXME: it would be nice if it could check if it matches the
++dnl given machine (uname -m)
++AC_DEFUN([AS_TRY_LINUX_CONFIG],
++[
++	CFG=[$1]
++	MACHINE=[$2]
++	AC_MSG_CHECKING($CFG)
++
++	if test -f &quot;$CFG&quot; ; then
++		result=yes
++		ifelse([$3], , :, [$3])
++	else
++		result=&quot;not found&quot;
++		ifelse([$4], , :, [$4])
++	fi
++	AC_MSG_RESULT($result)
++])
++
++dnl check if RED_HAT_LINUX_KERNEL is defined
++dnl pre-FC2 RH/Fedora defines this in linux/rhconfig.h
++dnl included from linux/version.h
++dnl if this is present, a few extra defines need to be present to make sure
++dnl symbol versioning is correct
++dnl uses LINUX_DIR to find rhconfig.h
++AC_DEFUN([AS_CHECK_REDHAT_PRE_FC2],
++[
++	AC_MSG_CHECKING(Pre-FC2 Red Hat/Fedora kernel)
++        HAVE_REDHAT_KERNEL=false
++        ac_save_CFLAGS=&quot;$CFLAGS&quot;
++        CFLAGS=&quot;$CFLAGS -I${LINUX_DIR}/include/linux&quot;
++        AC_COMPILE_IFELSE(AC_LANG_PROGRAM([
++#define __BOOT_KERNEL_H_
++#include &quot;rhconfig.h&quot;
++int code = RED_HAT_LINUX_KERNEL;
++	]),
++        AC_MSG_RESULT(found); HAVE_REDHAT_KERNEL=true,
++        AC_MSG_RESULT(not found))
++	dnl restore CFLAGS
++        CFLAGS=&quot;$ac_save_CFLAGS&quot;
++
++	dnl check for Red Hat define flags to use - see /sbin/mkkerneldoth
++
++	dnl initialize the booleans we want to detect
++	ENTERPRISE='0'
++	SMP='0'
++	UP='0'
++	BIGMEM='0'
++	HUGEMEM='0'
++
++	dnl get variables from the currently running kernel as default 
++	KERNEL_TYPE=`uname -r | sed 's_^.*\(smp\|enterprise\|bigmem\|hugemem\)$_\1_;t;s_.*__;'`
++	KERNEL_RELEASE=`uname -r | sed 's|smp\|enterprise\|bigmem\|hugemem||g'`
++	KERNEL_ARCH=`uname -m`
++
++	dnl check the config file and override KERNEL_ARCH
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M386, KERNEL_ARCH=i386)
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M586, KERNEL_ARCH=i586)
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M686, KERNEL_ARCH=i686)
++	dnl for some reason the i686 bigmem config file has PENTIUM
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_MPENTIUMIII, KERNEL_ARCH=i686)
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_MK7, KERNEL_ARCH=athlon)
++
++	dnl check the config file and override KERNEL_TYPE
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_SMP, KERNEL_TYPE=smp)
++	dnl bigmem is also smp, so this check is done after smp to override
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_HIGHMEM64G, KERNEL_TYPE=bigmem)
++
++	dnl FIXME: need to check hugemem and enterprise config files, which
++	dnl aren't provided in Fedora Core 1 !
++
++	case &quot;$KERNEL_TYPE&quot; in
++		smp) SMP='1';;
++		enterprise) ENTERPRISE='1';;
++		bigmem) BIGMEM='1';;
++		hugemem) HUGEMEM='1';;
++		*) UP='1';;
++	esac
++	REDHAT_CFLAGS=&quot;-D__BOOT_KERNEL_H_ -D__MODULE_KERNEL_$KERNEL_ARCH=1&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_ENTERPRISE=$ENTERPRISE&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_UP=$UP&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_SMP=$SMP&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_BIGMEM=$BIGMEM&quot;
++        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_HUGEMEM=$HUGEMEM&quot;
++
++	LINUX_REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS&quot;
++
++	AC_SUBST(LINUX_KERNEL_TYPE, &quot;$KERNEL_TYPE&quot;)
++])
++
++dnl check if we're building on SMP
++dnl set LINUX_SMP to yes if we are
++AC_DEFUN([AS_CHECK_SMP],
++[
++	LINUX_SMP=&quot;no&quot;
++	dnl check the config file and override KERNEL_TYPE
++        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_SMP, LINUX_SMP=&quot;yes&quot;)
++	AC_SUBST(LINUX_SMP)
++])
++
++dnl add an argument to specify/override the module install path
++dnl if nothing specified, it will be /lib/modules/(kernelrel)
++AC_DEFUN([AS_LINUX_MODULESDIR],
++[
++	KERNEL_RELEASE=[$1]
++	AC_ARG_WITH([modulesdir],
++		[AC_HELP_STRING([--with-modulesdir=DIR],
++			[specify path to kernel-specific modules install directory])],
++		[MODULESDIR=&quot;${withval}&quot;],
++		[MODULESDIR=default])
++
++	if test &quot;${MODULESDIR}&quot; = &quot;default&quot; ; then
++		MODULESDIR=&quot;/lib/modules/${KERNEL_RELEASE}&quot;
++	fi
++	dnl make it available to Makefiles so it can be used in ...dir
++	AC_SUBST(modulesdir, $MODULESDIR)
++	AC_MSG_NOTICE([Putting kernel modules under ${MODULESDIR}])
++])
++
++dnl add an argument to specify/override the module devel install path
++dnl if nothing specified, it will be the passed in LINUXDIR)
++AC_DEFUN([AS_LINUX_MODULESDEVELDIR],
++[
++	LINUXDIR=[$1]
++	AC_ARG_WITH([modulesdeveldir],
++		[AC_HELP_STRING([--with-modulesdeveldir=DIR],
++			[specify path to kernel-specific module development install directory])],
++		[MODULESDEVELDIR=&quot;${withval}&quot;],
++		[MODULESDEVELDIR=default])
++
++	if test &quot;${MODULESDEVELDIR}&quot; = &quot;default&quot; ; then
++		MODULESDEVELDIR=&quot;${LINUXDIR}&quot;
++	fi
++	dnl make it available to Makefiles so it can be used in ...dir
++	AC_SUBST(modulesdeveldir, $MODULESDEVELDIR)
++	AC_MSG_NOTICE([Putting kernel module development files under ${MODULESDEVELDIR}])
++])
++
++dnl add an argument to build without modules
++dnl sets variable BUILD_MODULES
++AC_DEFUN([AS_LINUX_CHECK_BUILD_MODULES],
++[
++	AC_ARG_WITH([modules],
++		[AC_HELP_STRING([--without-modules],
++			[do not build kernel modules])],
++		[BUILD_MODULES=&quot;${withval}&quot;],
++		[BUILD_MODULES=&quot;yes&quot;])
++
++	AC_MSG_CHECKING([whether to build kernel modules])
++	if test &quot;x$BUILD_MODULES&quot; = &quot;xno&quot;
++	then
++		AC_MSG_RESULT([no])
++	else
++		AC_MSG_RESULT([yes])
++	fi
++	dnl make it available as a conditional to Makefiles
++	AM_CONDITIONAL(BUILD_MODULES, test &quot;x$BUILD_MODULES&quot; != &quot;xno&quot;)
++])
++
++dnl add an argument to build without userspace
++AC_DEFUN([AS_LINUX_CHECK_BUILD_USERSPACE],
++[
++	AC_ARG_WITH([userspace],
++		[AC_HELP_STRING([--without-userspace],
++			[do not build userspace stuff])],
++		[BUILD_USERSPACE=&quot;${withval}&quot;],
++		[BUILD_USERSPACE=&quot;yes&quot;])
++
++	AC_MSG_CHECKING([whether to build userspace stuff])
++	if test &quot;x$BUILD_USERSPACE&quot; = &quot;xno&quot;
++	then
++		AC_MSG_RESULT([no])
++	else
++		AC_MSG_RESULT([yes])
++	fi
++	dnl make it available as a conditional to Makefiles
++	AM_CONDITIONAL(BUILD_USERSPACE, test &quot;x$BUILD_USERSPACE&quot; != &quot;xno&quot;)
++])
++
++AC_DEFUN([AS_LINUX_2_6],
++[
++	AC_MSG_CHECKING(for Linux CFLAGS)
++
++	{
++	  tmpdir=`(umask 077 &amp;&amp; mktemp -d -q &quot;./confstatXXXXXX&quot;) 2&gt;/dev/null` &amp;&amp;
++	  test -n &quot;$tmpdir&quot; &amp;&amp; test -d &quot;$tmpdir&quot;
++	} ||
++	{
++	  tmpdir=./confstat$$-$RANDOM
++	  (umask 077 &amp;&amp; mkdir $tmpdir)
++	} ||
++	{
++	  echo &quot;$me: cannot create a temporary directory in .&quot; &gt;&amp;2
++	  { (exit 1); exit 1; }
++	}
++
++	tmpdir=`pwd`/$tmpdir
++
++	cat &gt;${tmpdir}/Makefile &lt;&lt;EOF
++obj-m += fake.o
++
++\$(obj)/fake.c: flags
++	touch \$(obj)/fake.c
++
++.PHONY: flags
++flags:
++	echo LINUX_ARCH=\&quot;\$(ARCH)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_AFLAGS=\&quot;\$(AFLAGS)\&quot; | sed 's,include,&quot;\$(LINUXDIR)/include&quot;,g'&gt;&gt;\$(obj)/flags
++	echo LINUX_LDFLAGS=\&quot;\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_ARFLAGS=\&quot;\$(ARFLAGS)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_CROSS_COMPILE=\&quot;\$(CROSS_COMPILE)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_KERNELRELEASE=\&quot;\$(KERNELRELEASE)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_CFLAGS=\&quot;\$(CFLAGS) \$(CPPFLAGS)\&quot; | sed 's,Iinclude,I\$(LINUXDIR)/include,g' &gt;&gt;\$(obj)/flags
++	echo LINUX_CFLAGS_MODULE=\&quot;\$(CFLAGS_MODULE)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_CC=\&quot;\$(CC)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_LD=\&quot;\$(LD) \$(LDFLAGS) \$(LDFLAGS_MODULE)\&quot; &gt;&gt;\$(obj)/flags
++	echo LINUX_AS=\&quot;\$(AS)\&quot; &gt;&gt;\$(obj)/flags
++EOF
++
++	echo ${MAKE-make} -C ${LINUX_DIR} V=1 SUBDIRS=${tmpdir} LINUXDIR=${LINUX_DIR} MODVERDIR=${tmpdir} modules &gt;&amp;5 2&gt;&amp;5
++	${MAKE-make} -C ${LINUX_DIR} V=1 SUBDIRS=${tmpdir} LINUXDIR=${LINUX_DIR} MODVERDIR=${tmpdir} modules &gt;&amp;5 2&gt;&amp;5
++	. ${tmpdir}/flags
++	rm -rf ${tmpdir}
++
++	LINUX_MODULE_EXT=&quot;.ko&quot;
++
++	LINUX_CFLAGS=&quot;$LINUX_CFLAGS $LINUX_CFLAGS_MODULE&quot;
++	AC_SUBST(LINUX_ARCH)
++	AC_SUBST(LINUX_AFLAGS)
++	AC_SUBST(LINUX_LDFLAGS)
++	AC_SUBST(LINUX_ARFLAGS)
++	AC_SUBST(LINUX_CROSS_COMPILE)
++	AC_SUBST(LINUX_KERNELRELEASE)
++	AC_SUBST(LINUX_CFLAGS)
++	AC_SUBST(LINUX_CC)
++	AC_SUBST(LINUX_LD)
++	AC_SUBST(LINUX_AS)
++	AC_SUBST(LINUX_MODULE_EXT)
++	AC_MSG_RESULT([$LINUX_CFLAGS])
++
++	dnl find a usable modpost script
++	AC_MSG_CHECKING([usable modpost])
++	for CAND in $LINUX_DIR/scripts/modpost $LINUX_DIR/scripts/mod/modpost
++	do
++		if test -f &quot;$CAND&quot;
++		then
++			LINUX_MODPOST=$CAND
++		fi
++	done
++	AC_SUBST(LINUX_MODPOST)
++	if test -z &quot;$LINUX_MODPOST&quot;
++	then
++		AC_MSG_WARN([No usable modpost script found])
++	else
++		AC_MSG_RESULT([$LINUX_MODPOST])
++	fi
++])
++
++dnl checks kernel's Makefile for make variables for Linux 2.4
++dnl adds LINUX_REDHAT_CFLAGS if non-empty
++AC_DEFUN([AS_LINUX_2_4],
++[
++	AC_MSG_CHECKING(for Linux 2.4 make flags)
++	dnl we try to figure out the CFLAGS by invoking the Makefile on
++        dnl a test dir
++        dnl we use the correct config file by substituting the MAKEFILES
++        dnl Makefile variable, which originally points to .config
++
++	if [[ ! -e &quot;${LINUX_DIR}/.hdepend&quot; ]];then
++		AC_MSG_ERROR([
++You need to run 'make dep' on the kernel source before continuing.])
++	fi
++
++        if test &quot;x$LINUX_EXTRAVERSION&quot; == &quot;x&quot;; then
++          EX=
++        else
++          EX=&quot;EXTRAVERSION=$LINUX_EXTRAVERSION&quot;
++        fi
++
++        POPDIR=`(pwd)`
++        cd ${LINUX_DIR}
++        TMPFILE=`mktemp /tmp/linux.XXXXXXXX` || exit 1
++	# combine the kernel's Makefile,
++	# sedded to use our proposed config file,
++	# sedded to use our proposed machine value,
++	# with the extra target we add here, to get cflags
++	# we do not want entering/leaving info on distcheck so we run with -s
++	( cat Makefile | sed &quot;s|\.config|${LINUX_CONFIG}|g&quot; | sed &quot;s|shell uname -m|shell echo ${LINUX_MACHINE}|g&quot; &amp;&amp; cat &lt;&lt;EOF ) | make -s -f - get_cflags $EX &gt; ${TMPFILE}
++get_cflags:
++	@echo LINUX_ARCH=\&quot;\$(ARCH)\&quot;
++	@echo LINUX_AFLAGS=\&quot;\$(AFLAGS)\&quot; | sed 's_Iinclude_I\&quot;\$(LINUXDIR)/include\&quot;_g'
++	@echo LINUX_LDFLAGS=\&quot;\&quot;
++	@echo LINUX_ARFLAGS=\&quot;\$(ARFLAGS)\&quot;
++	@echo LINUX_CROSS_COMPILE=\&quot;\$(CROSS_COMPILE)\&quot;
++	@echo LINUX_KERNELRELEASE=\&quot;\$(KERNELRELEASE)\&quot;
++	@echo LINUX_CFLAGS=\&quot;\$(CFLAGS)\&quot; | sed 's_Iinclude_I\&quot;\$(LINUXDIR)/include\&quot;_g'
++	@echo LINUX_MODFLAGS=\&quot;\$(MODFLAGS)\&quot;
++	@echo LINUX_CC=\&quot;\$(CC)\&quot;
++	@echo LINUX_LD=\&quot;\$(LD) \$(LDFLAGS)\&quot;
++	@echo LINUX_AS=\&quot;\$(AS)\&quot;
++EOF
++        . ${TMPFILE}
++        rm -rf ${TMPFILE}
++        cd $POPDIR
++
++        LINUX_MODULE_EXT=&quot;.o&quot;
++
++	LINUX_CFLAGS=&quot;$LINUX_CFLAGS $LINUX_MODFLAGS&quot;
++
++	dnl if we have REDHAT_CFLAGS, put them in LINUX_CFLAGS
++	if test &quot;x$REDHAT_CFLAGS&quot; != &quot;x&quot;;
++	then
++		LINUX_CFLAGS=&quot;$LINUX_CFLAGS $REDHAT_CFLAGS&quot;
++	fi
++	AC_SUBST(LINUX_ARCH)
++	AC_SUBST(LINUX_AFLAGS)
++	AC_SUBST(LINUX_LDFLAGS)
++	AC_SUBST(LINUX_ARFLAGS)
++	AC_SUBST(LINUX_CROSS_COMPILE)
++	AC_SUBST(LINUX_KERNELRELEASE)
++	AC_SUBST(LINUX_CFLAGS)
++	AC_SUBST(LINUX_CC)
++	AC_SUBST(LINUX_LD)
++	AC_SUBST(LINUX_AS)
++	AC_SUBST(LINUX_MODULE_EXT)
++
++	AC_MSG_RESULT([ok])
++
++	AC_MSG_CHECKING(for Linux 2.4 CFLAGS)
++	AC_MSG_RESULT($LINUX_CFLAGS)
++	AC_MSG_CHECKING(for Linux 2.4 LDFLAGS)
++	AC_MSG_RESULT($LINUX_LDFLAGS)
++])
++
++AC_DEFUN([AS_CHECK_LINUX_CONFIG_OPTION],
++[
++	AC_MSG_CHECKING([Linux config option $1])
++
++	if grep '^$1=y$' ${LINUX_CONFIG} &gt;/dev/null 2&gt;/dev/null; then
++		result=yes
++		$2
++	else if grep '^$1=m$' ${LINUX_CONFIG} &gt;/dev/null 2&gt;/dev/null; then
++		result=module
++		$3
++	else
++		result=no
++		$4
++	fi
++	fi
++
++	AC_MSG_RESULT([$result])
++])
++
++AC_DEFUN([AS_LINUX_CONFIG_OPTION],
++[
++	AS_CHECK_LINUX_CONFIG_OPTION([$1],
++		[$1=yes],
++		[$1=module],
++		[$1=no])
++
++	AM_CONDITIONAL([$1],[test &quot;${$1}&quot; = yes])
++])
++
++AC_DEFUN([AS_LINUX_CONFIG_OPTION_MODULE],
++[
++	AS_CHECK_LINUX_CONFIG_OPTION([$1],
++		[$1=yes],
++		[$1=module],
++		[$1=no])
++
++	AM_CONDITIONAL([$1],[test &quot;${$1}&quot; = yes -o &quot;${$1}&quot; = module])
++])
++
++dnl check for the major/minor version of the Linux source by checking
++dnl the headers
++dnl first argument is the linux directory
++dnl sets LINUX_VERSION_MAJOR and LINUX_VERSION_MINOR
++AC_DEFUN([AS_LINUX_VERSION_MAJOR_MINOR],
++[
++	LINUX_DIR=[$1]
++	AC_MSG_CHECKING([Linux major/minor version])
++
++	if [[ ! -f &quot;${LINUX_DIR}/include/linux/version.h&quot; ]];then
++		AC_MSG_ERROR([The header file include/linux/version.h does not exist.
++For 2.6 kernels, it can be generated by running 'make prepare' in
++the kernel source directory.])
++	fi
++        dnl the next set of tests is for figuring out version major/minor
++        dnl we make sure we have the right version.h by faking out CFLAGS
++	dnl since we want to avoid including linux/version.h and acidentally
++	dnl pick up /usr/include/linux
++	dnl we still add ${LINUX_DIR}/include so the Red Hat version can pick
++	dnl up linux/rhversion.h
++        ac_save_CFLAGS=&quot;$CFLAGS&quot;
++        CFLAGS=&quot;$CFLAGS -I${LINUX_DIR}/include/linux -I${LINUX_DIR}/include&quot;
++        dnl make sure we find version.h and it contains LINUX_VERSION_CODE
++        AC_COMPILE_IFELSE(AC_LANG_PROGRAM([
++/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
++#define __BOOT_KERNEL_H_
++#include &quot;version.h&quot;
++int code = LINUX_VERSION_CODE;
++]),
++ :, AC_MSG_ERROR([${LINUX_DIR}/include/linux/version.h does not contain LINUX_VERSION_CODE]))
++
++
++        dnl figure out the linux kernel version major and minor
++        dnl using the LINUX_VERSION_CODE defined in include/linux/version.h
++        AC_RUN_IFELSE(AC_LANG_PROGRAM([
++/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
++#define __BOOT_KERNEL_H_
++#include &quot;version.h&quot;
++#define KERNEL_VERSION_MAJOR(code) ((code) &gt;&gt; 16)
++],[
++  return KERNEL_VERSION_MAJOR(LINUX_VERSION_CODE);
++]),
++		LINUX_VERSION_MAJOR=0, 
++		LINUX_VERSION_MAJOR=$?)
++        AC_RUN_IFELSE(AC_LANG_PROGRAM([
++/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
++#define __BOOT_KERNEL_H_
++#include &quot;version.h&quot;
++#define KERNEL_VERSION_MINOR(code) (((code) &gt;&gt; 8) % (2 &lt;&lt; 8))
++],[
++  return KERNEL_VERSION_MINOR(LINUX_VERSION_CODE);
++]),
++		LINUX_VERSION_MINOR=0, 
++		LINUX_VERSION_MINOR=$?)
++        AC_MSG_RESULT($LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR)
++	dnl restore CFLAGS
++        CFLAGS=&quot;$ac_save_CFLAGS&quot;
++])
+diff -Naupr qc-usb-0.6.1.orig/m4/as-modtool.m4 qc-usb-0.6.1/m4/as-modtool.m4
+--- qc-usb-0.6.1.orig/m4/as-modtool.m4	1970-01-01 01:00:00.000000000 +0100
++++ qc-usb-0.6.1/m4/as-modtool.m4	2004-08-25 15:54:48.827825544 +0200
+@@ -0,0 +1,147 @@
++dnl as-modtool.m4 0.0.1
++dnl autostars m4 macro for building modtool, a linker for Linux kernel
++dnl modules
++
++dnl David Schleef &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ds at schleef.org</A>&gt;
++dnl Frank Mori Hess &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fmhess at users.sourceforge.net</A>&gt;
++dnl Thomas Vander Stichele &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thomas at apestaart.org</A>&gt;
++
++dnl $Id: as-modtool.m4,v 1.12 2004/06/03 15:20:11 thomasvs Exp $
++
++dnl AS_LINUX_MODTOOL()
++dnl
++dnl this macro defines:
++dnl moduledir
++dnl modulePROGRAMS_INSTALL
++dnl modulePROGRAMS_UNINSTALL
++dnl
++dnl End of search list.
++
++dnl
++dnl FIXME:
++dnl  How do you specify that the building of modtool should go to the
++dnl  end of the configure script?
++dnl
++
++dnl SYMVERS_INCLUDES can be used to add additional .symvers files to the
++dnl modpost step
++
++AC_DEFUN([AS_LINUX_MODTOOL],
++[
++	AC_PATH_PROG(STRIP, strip)
++	AC_PATH_PROG([DEPMOD], [depmod], [no], [$PATH:/sbin:/usr/sbin:/usr/local/sbin])
++	AC_PATH_PROG([GENKSYMS], [genksyms], [no], [$PATH:/sbin:/usr/sbin:/usr/local/sbin])
++
++	if test &quot;x$LINUX_SMP&quot; = &quot;xyes&quot;
++	then
++		GENKSYMS=&quot;$GENKSYMS -p smp_&quot;
++	fi
++	dnl this can be overridden in Makefile.am
++	dnl FIXME: it'd be nice if we could specify different target_PROGRAMS
++	dnl and different targetdir
++	moduledir=&quot;\$(modulesdir)/\$(PACKAGE)&quot;
++	modulePROGRAMS_INSTALL=&quot;\$(top_builddir)/modtool --install&quot;
++	modulePROGRAMS_UNINSTALL=&quot;\$(top_builddir)/modtool --uninstall&quot;
++	AC_SUBST(moduledir)
++	AC_SUBST(modulePROGRAMS_INSTALL)
++
++	LINUX_VERSION=`echo $LINUX_KERNELRELEASE | cut -d- -f1`
++
++	AC_MSG_NOTICE(creating modtool)
++	cat &gt;modtool &lt;&lt;EOF
++#!/bin/sh
++
++set -e
++
++LINUX_LD=&quot;$LINUX_LD&quot;
++LINUX_MODPOST=&quot;$LINUX_MODPOST&quot;
++LINUX_VERSION=&quot;$LINUX_VERSION&quot;
++GENKSYMS=&quot;$GENKSYMS&quot;
++CC=&quot;$LINUX_CC&quot;
++INSTALL=&quot;$INSTALL&quot;
++LINUX_MODULE_EXT=&quot;$LINUX_MODULE_EXT&quot;
++STRIP=&quot;$STRIP&quot;
++CFLAGS=&quot;$CFLAGS $LINUX_CFLAGS&quot;
++LINUX_DIR=&quot;$LINUX_DIR&quot;
++
++mode=\$[1]
++shift
++
++case \$mode in
++--link)
++	# we accept -i (symvers) and -o (target) as options
++	# at least -o (target) needs to be specified
++	SYMVERS_INCLUDES=&quot;&quot;
++	done=false
++	while test ! -z &quot;\$[0]&quot; -a &quot;\$done&quot; = &quot;false&quot;
++	do
++		case \$[1] in
++		-i)
++                        SYMVERS_INCLUDES=&quot;\$SYMVERS_INCLUDES \$[2]&quot;
++                        shift 2
++                        ;;
++                -o)
++                        target=\$(echo \$[2] | sed s/.ko$//)
++                        shift 2
++                        ;;
++                *)
++                        done=true
++                        ;;
++                esac
++        done
++
++	mkdir -p .mods
++	if test &quot;\$LINUX_MODULE_EXT&quot; = .ko ; then
++
++		\$LINUX_LD -r -o .mods/\$target.o \$[*]
++
++		cat \$LINUX_DIR/Module.symvers \$SYMVERS_INCLUDES &gt;.mods/symvers.tmp
++
++		\$LINUX_MODPOST -o .mods/\$target.o.symvers.tmp -i .mods/symvers.tmp .mods/\$target.o
++
++		grep .mods/\$target .mods/\$target.o.symvers.tmp &gt;.mods/\$target.o.symvers || true
++
++		rm -f .mods/\$target.o.symvers.tmp .mods/symvers.tmp
++		
++		\$CC \$CFLAGS -DKBUILD_MODNAME=\$target -c -o .mods/\$target.mod.o .mods/\$target.mod.c
++
++		\$LINUX_LD -r -o \$target.ko .mods/\$target.mod.o .mods/\$target.o
++		set +x
++	else
++		echo \$LINUX_LD -r -o \$target.ko \$[*]
++		\$LINUX_LD -r -o \$target.ko \$[*]
++                                                                      
++		if test &quot;x\$SOURCES&quot; != &quot;x&quot;
++		then
++			echo &quot;\$CC \$CFLAGS -E -D__GENKSYMS__ \$SOURCES | \$GENKSYMS -k \$LINUX_VERSION &gt; .mods/\$target.ver&quot;
++			\$CC \$CFLAGS -E -D__GENKSYMS__ \$SOURCES | \$GENKSYMS -k \$LINUX_VERSION &gt; .mods/\$target.ver
++		fi
++
++	fi
++
++	;;
++--install)
++	module_src=\$[1]
++	module_dest=\`echo \$[2] | sed &quot;s/\.ko$/\${LINUX_MODULE_EXT}/&quot;\`
++	echo \$INSTALL -m644 &quot;\$module_src&quot; &quot;\$module_dest&quot;
++	\$INSTALL -m644 &quot;\$module_src&quot; &quot;\$module_dest&quot;
++	\$STRIP -g &quot;\$module_dest&quot;
++	;;
++--uninstall)
++	module_src=\$[1]
++	module_dest=\`echo \$[2] | sed &quot;s/\.ko$/\${LINUX_MODULE_EXT}/&quot;\`
++	echo uninstall &quot;\$module_src&quot; &quot;\$module_dest&quot;
++	rm -f &quot;\$module_dest&quot;
++	;;
++*)
++	echo Unknown mode \$mode &gt;&amp;2
++	exit 1
++esac
++
++EOF
++	chmod +x modtool
++
++
++])
++
++
+diff -Naupr qc-usb-0.6.1.orig/Makefile.am qc-usb-0.6.1/Makefile.am
+--- qc-usb-0.6.1.orig/Makefile.am	1970-01-01 01:00:00.000000000 +0100
++++ qc-usb-0.6.1/Makefile.am	2004-08-25 16:06:20.704644280 +0200
+@@ -0,0 +1,22 @@
++SUBDIRS = testquickcam
++
++bin_PROGRAMS = qcset
++
++noinst_HEADERS = quickcam.h qc-memory.h
++
++moduledir = $(modulesdir)/kernel/drivers/video
++module_PROGRAMS = quickcam.ko
++
++# we are building from this package and not included in kernel
++quickcam_ko_CFLAGS = $(LINUX_CFLAGS) -DNOKERNEL
++quickcam_ko_SOURCES = \
++	qc-driver.c qc-formats.c qc-mjpeg.c qc-hdcs.c \
++	qc-pb0100.c qc-vv6410.c qc-memory.c
++quickcam_ko_LINK = $(top_builddir)/modtool --link -o $@
++                                                                                
++distclean-local:
++	-rm -rf .mods
++
++qcset_SOURCES = qcset.c
++qcset_LDFLAGS = -lm
++
+diff -Naupr qc-usb-0.6.1.orig/testquickcam/Makefile.am qc-usb-0.6.1/testquickcam/Makefile.am
+--- qc-usb-0.6.1.orig/testquickcam/Makefile.am	1970-01-01 01:00:00.000000000 +0100
++++ qc-usb-0.6.1/testquickcam/Makefile.am	2004-08-25 15:54:48.839823720 +0200
+@@ -0,0 +1,4 @@
++noinst_PROGRAMS = testquickcam
++
++testquickcam_SOURCES = testquickcam.c
++noinst_HEADERS = testquickcam.h

Deleted: trunk/rpms/kernel-module-qc-usb/qc-usb.autotools.patch
===================================================================
--- trunk/rpms/kernel-module-qc-usb/qc-usb.autotools.patch	2004-08-25 13:14:54 UTC (rev 2094)
+++ trunk/rpms/kernel-module-qc-usb/qc-usb.autotools.patch	2004-08-25 15:01:13 UTC (rev 2095)
@@ -1,915 +0,0 @@
-Index: kernel-module-qc-usb/qc-usb-0.6.0/testquickcam/Makefile.am
---- kernel-module-qc-usb~autotools/qc-usb-0.6.0/testquickcam/Makefile.am	2004-05-21 22:46:41.000000000 +0200
-+++ kernel-module-qc-usb/qc-usb-0.6.0/testquickcam/Makefile.am	2004-05-21 22:48:23.000000000 +0200
-@@ -0,0 +1,4 @@
-+noinst_PROGRAMS = testquickcam
-+
-+testquickcam_SOURCES = testquickcam.c
-+noinst_HEADERS = testquickcam.h
-Index: kernel-module-qc-usb/qc-usb-0.6.0/Makefile.am
---- kernel-module-qc-usb~autotools/qc-usb-0.6.0/Makefile.am	2004-05-21 22:46:41.000000000 +0200
-+++ kernel-module-qc-usb/qc-usb-0.6.0/Makefile.am	2004-06-16 11:19:22.570951736 +0200
-@@ -0,0 +1,20 @@
-+SUBDIRS = testquickcam
-+
-+bin_PROGRAMS = qcset
-+
-+noinst_HEADERS = quickcam.h qc-memory.h
-+
-+moduledir = $(modulesdir)/kernel/drivers/video
-+module_PROGRAMS = quickcam.ko
-+
-+# we are building from this package and not included in kernel
-+quickcam_ko_CFLAGS = $(LINUX_CFLAGS) -DNOKERNEL
-+quickcam_ko_SOURCES = \
-+	qc-driver.c qc-formats.c qc-mjpeg.c qc-hdcs.c \
-+	qc-pb0100.c qc-vv6410.c qc-memory.c
-+quickcam_ko_LINK = $(top_builddir)/modtool --link -o $@
-+                                                                                
-+distclean-local:
-+	-rm -rf .mods
-+
-+qcset_SOURCES = qcset.c
-Index: kernel-module-qc-usb/qc-usb-0.6.0/m4/as-linux.m4
---- kernel-module-qc-usb~autotools/qc-usb-0.6.0/m4/as-linux.m4	2004-05-21 22:46:41.000000000 +0200
-+++ kernel-module-qc-usb/qc-usb-0.6.0/m4/as-linux.m4	2004-06-16 11:09:16.305118152 +0200
-@@ -0,0 +1,704 @@
-+dnl as-linux.m4 0.2.1
-+
-+dnl autostars m4 macro for detecting a Linux source tree (or
-+dnl equivalent) for compiling modules.
-+
-+dnl David Schleef &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ds at schleef.org</A>&gt;
-+dnl Frank Mori Hess &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fmhess at users.sourceforge.net</A>&gt;
-+dnl Thomas Vander Stichele &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thomas at apestaart.org</A>&gt;
-+
-+dnl $Id: as-linux.m4,v 1.18 2004/06/03 16:35:58 thomasvs Exp $
-+
-+dnl AS_LINUX()
-+dnl
-+dnl this macro adds the options
-+dnl --with-linuxdir        to specify a kernel build tree location
-+dnl --with-linuxconfig     to specify a kernel .config file
-+dnl --with-kernel-release  to specify an alternative uname -r
-+dnl --with-machine         to specify an alternative uname -m
-+dnl --with-rpm-target      to specify to match the given rpm --target option
-+dnl --with-extraversion    to specify an EXTRAVERSION override
-+dnl --with-modulesdir      to specify the base install location of modules
-+dnl --with-modulesdeveldir to specify the base install location of build stuff
-+
-+dnl this macro defines:
-+dnl LINUX_DIR
-+dnl   The directory where the Linux source resides.
-+dnl CONFIG_FILE
-+dnl   The Linux config file
-+dnl LINUX_ARCH
-+dnl   $(ARCH) in kernel Makefiles
-+dnl LINUX_AFLAGS
-+dnl   $(AFLAGS) in kernel Makefiles
-+dnl LINUX_LDFLAGS
-+dnl   Linker flags used by Linux
-+dnl LINUX_ARFLAGS
-+dnl   Archiver flags used by Linux
-+dnl LINUX_CROSS_COMPILE
-+dnl   Cross-compiler prefix, if any. (example: &quot;powerpc-linux-&quot;)
-+dnl LINUX_KERNELRELEASE
-+dnl   Kernel release name (2.4.5-pre4-ac5-rmk), $(KERNELRELEASE) in
-+dnl   Linux Makefiles.
-+dnl LINUX_CFLAGS
-+dnl   CFLAGS used by Linux.  Includes both $CFLAGS and $MODFLAGS from
-+dnl   kernel Makefiles. Also includes warnings and optimization.
-+dnl LINUX_CC
-+dnl   Compiler used by Linux.
-+dnl LINUX_LD
-+dnl   Path to linker (possibly with options) used by Linux.
-+dnl LINUX_AS
-+dnl   Assembler used by Linux.
-+dnl LINUX_MODULE_EXT
-+dnl   Module extension (.o or .ko)
-+dnl LINUX_MODPOST
-+dnl   path to modpost script
-+dnl LINUX_SMP
-+dnl   set to yes if the kernel is SMP
-+dnl modulesdir
-+dnl   base install path for kernel modules
-+dnl modulesdeveldir
-+dnl   base install path for kernel module development files
-+dnl 
-+dnl End of search list.
-+
-+dnl main entry point
-+dnl checks the version, and figures out all flags to use to make modules.
-+AC_DEFUN([AS_LINUX],
-+[
-+	dnl check if user supplied a uname -r, and if not use the running one
-+	AS_LINUX_KERNEL_RELEASE()
-+	dnl check if user supplied a uname -m, and if not use the running one
-+	AS_LINUX_MACHINE() 	 
-+	dnl check if the user supplied an rpm target arch
-+	dnl override the LINUX_MACHINE value if he did
-+	AS_LINUX_RPM_TARGET($LINUX_KERNEL_RELEASE) 	 
-+  	 
-+	dnl find the kernel source tree for the given uname -r 	 
-+	AS_LINUX_DIR($LINUX_KERNEL_RELEASE) 	 
-+	dnl check if user supplied an EXTRAVERSION, and if not get from uname -r
-+	AS_LINUX_EXTRAVERSION($LINUX_KERNEL_RELEASE) 	 
-+	dnl check if user supplied a config file; if not, guess a good one
-+	AS_LINUX_CONFIG($LINUX_DIR, $LINUX_KERNEL_RELEASE, $LINUX_MACHINE) 	 
-+	dnl check if we're building on pre-FC2 Red Hat/Fedora,
-+	dnl and add some flags if we are 	 
-+	AS_CHECK_REDHAT_PRE_FC2() 	 
-+	dnl check if we're building SMP, and set LINUX_SMP if we are
-+	AS_CHECK_SMP()
-+	dnl check for where to install modules
-+	AS_LINUX_MODULESDIR($LINUX_KERNEL_RELEASE)
-+	dnl check for where to install module development files
-+	AS_LINUX_MODULESDEVELDIR($LINUX_DIR)
-+	dnl check for the MAJOR/MINOR version of Linux 	 
-+	AS_LINUX_VERSION_MAJOR_MINOR($LINUX_DIR)
-+
-+	dnl now call the correct macro to get compiler flags
-+	dnl the versioned AS_LINUX macros just use the global variables
-+	dnl this could be cleaned up later on if we feel like it
-+	case $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR in
-+		2.6)
-+			AS_LINUX_2_6()
-+			;;
-+		2.[[01234]])
-+			AS_LINUX_2_4()
-+			;;
-+		*)
-+			AC_MSG_ERROR([Unknown Linux major.minor $LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR])
-+			;;
-+	esac
-+])
-+
-+
-+dnl check if we can find a source dir for the Linux kernel
-+dnl defines LINUX_DIR to the absolute location of a usable kernel source tree
-+AC_DEFUN([AS_LINUX_DIR],
-+[
-+	AC_ARG_WITH([linuxdir],
-+		[AC_HELP_STRING([--with-linuxdir=DIR],
-+			[specify path to Linux source directory])],
-+		[LINUX_DIR=&quot;${withval}&quot;],
-+		[LINUX_DIR=default])
-+
-+	if test &quot;${LINUX_DIR}&quot; != &quot;default&quot; ; then
-+		AS_TRY_LINUX_DIR([${LINUX_DIR}], , AC_MSG_ERROR([Linux dir not found]) )
-+	fi
-+
-+	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
-+		dir=&quot;/lib/modules/`uname -r`/build&quot;;
-+		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
-+	fi
-+	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
-+		dir=&quot;../linux&quot;;
-+		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
-+	fi
-+	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
-+		dir=&quot;/usr/src/linux&quot;;
-+		AS_TRY_LINUX_DIR([${dir}], [LINUX_DIR=${dir}], )
-+	fi
-+
-+	if test &quot;${LINUX_DIR}&quot; = &quot;default&quot; ; then
-+		AC_MSG_ERROR([Linux source directory not found])
-+	fi
-+
-+	AC_SUBST(LINUX_DIR)
-+])
-+
-+dnl check if the given candidate path for a linux source tree is usable
-+AC_DEFUN([AS_TRY_LINUX_DIR],
-+	[AC_MSG_CHECKING(for Linux in $1)
-+
-+	if test -f &quot;$1/Makefile&quot; ; then
-+		result=yes
-+		$2
-+	else
-+		result=&quot;not found&quot;
-+		$3
-+	fi
-+
-+	AC_MSG_RESULT($result)
-+])
-+
-+dnl allow for specifying a kernel release (uname -r) to build for
-+dnl use uname -r of running one if not specified
-+dnl store result in LINUX_KERNEL_RELEASE
-+AC_DEFUN([AS_LINUX_KERNEL_RELEASE],
-+[
-+	AC_ARG_WITH([kernel-release],
-+		[AC_HELP_STRING([--with-kernel-release=RELEASE],
-+			[specify the &quot;uname -r&quot;-value to build for])],
-+		[LINUX_KERNEL_RELEASE=&quot;${withval}&quot;],
-+		[LINUX_KERNEL_RELEASE=`uname -r`])
-+        if test &quot;x$LINUX_KERNEL_RELEASE&quot; = &quot;xyes&quot;;
-+        then
-+		LINUX_KERNEL_RELEASE=`uname -r`
-+        fi
-+        AC_MSG_NOTICE([Using $LINUX_KERNEL_RELEASE as the uname -r value])
-+])
-+
-+dnl allow for specifying a machine (uname -m) to build for
-+dnl use uname -, of running one if not specified
-+dnl store result in LINUX_MACHINE
-+AC_DEFUN([AS_LINUX_MACHINE],
-+[
-+	AC_ARG_WITH([machine],
-+		[AC_HELP_STRING([--with-machine=MACHINE],
-+			[specify the &quot;uname -m&quot;-value to build for])],
-+		[LINUX_MACHINE=&quot;${withval}&quot;],
-+		[LINUX_MACHINE=`uname -m`])
-+        if test &quot;x$LINUX_MACHINE&quot; = &quot;xyes&quot;;
-+        then
-+		LINUX_MACHINE=`uname -r`
-+        fi
-+        AC_MSG_NOTICE([Using $LINUX_MACHINE as the uname -m value])
-+])
-+dnl allow for specifying an rpm target arch
-+dnl if none specified, try to guess one from running rpm querying for
-+dnl the kernel with the uname -r
-+dnl this is so configure without arguments works out of the box
-+dnl FIXME: investigate if uname -p is a correct guess for this, and if
-+dnl we should have a flag for specifying it instead
-+
-+dnl this macro possibly overrides LINUX_MACHINE
-+
-+dnl first argument is the kernel release building for
-+AC_DEFUN([AS_LINUX_RPM_TARGET],
-+[
-+	RELEASE=$1
-+	AC_ARG_WITH([rpm-target],
-+		[AC_HELP_STRING([--with-rpm-target=TARGET],
-+			[specify the target arch to build for])],
-+		[LINUX_RPM_TARGET=&quot;${withval}&quot;],
-+		[LINUX_RPM_TARGET=])
-+	if test &quot;x$LINUX_RPM_TARGET&quot; = &quot;x&quot;
-+	then
-+		dnl if we have rpm, try to guess the target of the kernel
-+		dnl we want to build for using rpm
-+		AC_PATH_PROG(RPM, rpm, yes, no)
-+		if test &quot;x$RPM&quot; = &quot;xyes&quot;
-+		then
-+			if rpm -q kernel-$RELEASE &gt; /dev/null
-+			then
-+				LINUX_RPM_TARGET=`rpm -q --queryformat %{arch} kernel-$RELEASE`
-+			else
-+				AC_MSG_NOTICE([Cannot guess target arch, consider setting it using --with-rpm-target])
-+			fi
-+		fi
-+	fi
-+
-+	dnl now override LINUX_MACHINE if LINUX_RPM_TARGET is set
-+	if test &quot;x$LINUX_RPM_TARGET&quot; != &quot;x&quot;
-+	then
-+		dnl override LINUX_MACHINE based on this
-+		dnl FIXME: add other possible Red Hat/Fedora/rpm targets here
-+		LINUX_MACHINE=
-+		case &quot;$LINUX_RPM_TARGET&quot; in
-+			i?86) LINUX_MACHINE=i386;;
-+			athlon) LINUX_MACHINE=i386;;
-+			x86_64) LINUX_MACHINE=x86_64;;
-+		esac
-+		if test &quot;x$LINUX_MACHINE&quot; = &quot;x&quot;
-+		then
-+		AC_MSG_ERROR(Could not guess uname -m value from target $LINUX_RPM_TARGET)
-+		fi
-+	fi
-+])
-+
-+
-+dnl allow for specifying an override for EXTRAVERSION
-+dnl if none specified, make it from the passed-in KERNEL_RELEASE (uname -r)
-+dnl resulting value is stored in LINUX_EXTRAVERSION
-+dnl first argument is the uname -r string to use as a fallback
-+AC_DEFUN([AS_LINUX_EXTRAVERSION],
-+[
-+	KERNEL_RELEASE=[$1]
-+	dnl extract the default by getting everything after first -
-+	LINUX_EXTRAVERSION=&quot;-`echo $KERNEL_RELEASE | cut -d- -f 2-`&quot;
-+	AC_ARG_WITH([extraversion],
-+		[AC_HELP_STRING([--with-extraversion=FILE],
-+			[specify override for kernel EXTRAVERSION])],
-+		[LINUX_EXTRAVERSION=&quot;${withval}&quot;],)
-+])
-+
-+
-+dnl check if we can find a config file for the Linux kernel
-+dnl defines LINUX_CONFIG to the absolute location of a usable
-+dnl kernel source config file
-+
-+dnl for rpm distros, it can try and guess the correct config file by
-+dnl checking the global LINUX_RPM_TARGET variable set somewhere else
-+dnl (FIXME: move this to an argument instead ?)
-+
-+dnl first argument is LINUX_DIR to check for possible configs
-+dnl second argument is kernel-release (uname -r)
-+dnl third argument is machine (uname -m)
-+
-+AC_DEFUN([AS_LINUX_CONFIG],
-+[
-+	LINUX_DIR=[$1]
-+	KERNEL_RELEASE=[$2]
-+	MACHINE=[$3]
-+	AC_ARG_WITH([linuxconfig],
-+		[AC_HELP_STRING([--with-linuxconfig=FILE],
-+			[specify path to Linux configuration file])],
-+		[LINUX_CONFIG=&quot;${withval}&quot;],
-+		[LINUX_CONFIG=default])
-+
-+	dnl if a file got specified, try it as a linux config file
-+	if test &quot;${LINUX_CONFIG}&quot; != &quot;default&quot; ; then
-+		AS_TRY_LINUX_CONFIG($LINUX_CONFIG, $MACHINE,
-+                                    ,, AC_MSG_ERROR([Linux config not found]) )
-+	fi
-+
-+        dnl if no file specified, first check for the regular .config file
-+        dnl in LINUX_DIR created by manual configuration
-+	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; ; then
-+		file=&quot;$LINUX_DIR/.config&quot;;
-+		AS_TRY_LINUX_CONFIG($file, $MACHINE,
-+		                    [LINUX_CONFIG=${file}], )
-+	fi
-+        dnl second, try to guess what config file to use for the current kernel
-+	dnl FIXME: the possible arch is from rpmbuild --target, and is
-+	dnl different from the value of ARCH (Makefile) or MACHINE (uname -m)
-+	dnl so we should have a redhat flag to specify the target to find
-+	dnl the correct config file
-+	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; &amp;&amp; test &quot;x$LINUX_RPM_TARGET&quot; != &quot;x&quot;; then
-+		dnl Red Hat stores configuration files for their built kernels
-+		dnl named kernel-(version)-(arch)(extra).config
-+		dnl where arch is athlon, i386, i586, i686, x86_64
-+		dnl and (extra) is empty or -smp, -BOOT, -bigmem
-+		dnl haven't seen combinations of extra yet as of FC1
-+		KVERSION=`echo $KERNEL_RELEASE | cut -d- -f1`
-+		extra=
-+		echo $KERNEL_RELEASE | grep smp &amp;&amp; EXTRA=&quot;-smp&quot;
-+		echo $KERNEL_RELEASE | grep bigmem &amp;&amp; EXTRA=&quot;-bigmem&quot;
-+		echo $KERNEL_RELEASE | grep BOOT &amp;&amp; EXTRA=&quot;-BOOT&quot;
-+		file=&quot;$LINUX_DIR/configs/kernel-$KVERSION-$LINUX_RPM_TARGET$EXTRA.config&quot;
-+		AS_TRY_LINUX_CONFIG($file, $MACHINE,
-+		                    [LINUX_CONFIG=${file}], )
-+	fi
-+	if test &quot;${LINUX_CONFIG}&quot; = &quot;default&quot; ; then
-+		AC_MSG_ERROR([
-+The kernel source tree at ${LINUX_DIR} is not configured,
-+and no configuration files in config/ matching your kernel were found.
-+Fix before continuing or specify a config file using --with-configfile.])
-+	fi
-+
-+	AC_SUBST(LINUX_CONFIG)
-+])
-+
-+dnl check if the given candidate config file is usable
-+dnl FIXME: it would be nice if it could check if it matches the
-+dnl given machine (uname -m)
-+AC_DEFUN([AS_TRY_LINUX_CONFIG],
-+[
-+	CFG=[$1]
-+	MACHINE=[$2]
-+	AC_MSG_CHECKING($CFG)
-+
-+	if test -f &quot;$CFG&quot; ; then
-+		result=yes
-+		ifelse([$3], , :, [$3])
-+	else
-+		result=&quot;not found&quot;
-+		ifelse([$4], , :, [$4])
-+	fi
-+	AC_MSG_RESULT($result)
-+])
-+
-+dnl check if RED_HAT_LINUX_KERNEL is defined
-+dnl pre-FC2 RH/Fedora defines this in linux/rhconfig.h
-+dnl included from linux/version.h
-+dnl if this is present, a few extra defines need to be present to make sure
-+dnl symbol versioning is correct
-+dnl uses LINUX_DIR to find rhconfig.h
-+AC_DEFUN([AS_CHECK_REDHAT_PRE_FC2],
-+[
-+	AC_MSG_CHECKING(Pre-FC2 Red Hat/Fedora kernel)
-+        HAVE_REDHAT_KERNEL=false
-+        ac_save_CFLAGS=&quot;$CFLAGS&quot;
-+        CFLAGS=&quot;$CFLAGS -I${LINUX_DIR}/include/linux&quot;
-+        AC_COMPILE_IFELSE(AC_LANG_PROGRAM([
-+#define __BOOT_KERNEL_H_
-+#include &quot;rhconfig.h&quot;
-+int code = RED_HAT_LINUX_KERNEL;
-+	]),
-+        AC_MSG_RESULT(found); HAVE_REDHAT_KERNEL=true,
-+        AC_MSG_RESULT(not found))
-+	dnl restore CFLAGS
-+        CFLAGS=&quot;$ac_save_CFLAGS&quot;
-+
-+	dnl check for Red Hat define flags to use - see /sbin/mkkerneldoth
-+
-+	dnl initialize the booleans we want to detect
-+	ENTERPRISE='0'
-+	SMP='0'
-+	UP='0'
-+	BIGMEM='0'
-+	HUGEMEM='0'
-+
-+	dnl get variables from the currently running kernel as default 
-+	KERNEL_TYPE=`uname -r | sed 's_^.*\(smp\|enterprise\|bigmem\|hugemem\)$_\1_;t;s_.*__;'`
-+	KERNEL_RELEASE=`uname -r | sed 's|smp\|enterprise\|bigmem\|hugemem||g'`
-+	KERNEL_ARCH=`uname -m`
-+
-+	dnl check the config file and override KERNEL_ARCH
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M386, KERNEL_ARCH=i386)
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M586, KERNEL_ARCH=i586)
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_M686, KERNEL_ARCH=i686)
-+	dnl for some reason the i686 bigmem config file has PENTIUM
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_MPENTIUMIII, KERNEL_ARCH=i686)
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_MK7, KERNEL_ARCH=athlon)
-+
-+	dnl check the config file and override KERNEL_TYPE
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_SMP, KERNEL_TYPE=smp)
-+	dnl bigmem is also smp, so this check is done after smp to override
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_HIGHMEM64G, KERNEL_TYPE=bigmem)
-+
-+	dnl FIXME: need to check hugemem and enterprise config files, which
-+	dnl aren't provided in Fedora Core 1 !
-+
-+	case &quot;$KERNEL_TYPE&quot; in
-+		smp) SMP='1';;
-+		enterprise) ENTERPRISE='1';;
-+		bigmem) BIGMEM='1';;
-+		hugemem) HUGEMEM='1';;
-+		*) UP='1';;
-+	esac
-+	REDHAT_CFLAGS=&quot;-D__BOOT_KERNEL_H_ -D__MODULE_KERNEL_$KERNEL_ARCH=1&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_ENTERPRISE=$ENTERPRISE&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_UP=$UP&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_SMP=$SMP&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_BIGMEM=$BIGMEM&quot;
-+        REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS -D__BOOT_KERNEL_HUGEMEM=$HUGEMEM&quot;
-+
-+	LINUX_REDHAT_CFLAGS=&quot;$REDHAT_CFLAGS&quot;
-+
-+	AC_SUBST(LINUX_KERNEL_TYPE, &quot;$KERNEL_TYPE&quot;)
-+])
-+
-+dnl check if we're building on SMP
-+dnl set LINUX_SMP to yes if we are
-+AC_DEFUN([AS_CHECK_SMP],
-+[
-+	LINUX_SMP=&quot;no&quot;
-+	dnl check the config file and override KERNEL_TYPE
-+        AS_CHECK_LINUX_CONFIG_OPTION(CONFIG_SMP, LINUX_SMP=&quot;yes&quot;)
-+	AC_SUBST(LINUX_SMP)
-+])
-+
-+dnl add an argument to specify/override the module install path
-+dnl if nothing specified, it will be /lib/modules/(kernelrel)
-+AC_DEFUN([AS_LINUX_MODULESDIR],
-+[
-+	KERNEL_RELEASE=[$1]
-+	AC_ARG_WITH([modulesdir],
-+		[AC_HELP_STRING([--with-modulesdir=DIR],
-+			[specify path to kernel-specific modules install directory])],
-+		[MODULESDIR=&quot;${withval}&quot;],
-+		[MODULESDIR=default])
-+
-+	if test &quot;${MODULESDIR}&quot; = &quot;default&quot; ; then
-+		MODULESDIR=&quot;/lib/modules/${KERNEL_RELEASE}&quot;
-+	fi
-+	dnl make it available to Makefiles so it can be used in ...dir
-+	AC_SUBST(modulesdir, $MODULESDIR)
-+	AC_MSG_NOTICE([Putting kernel modules under ${MODULESDIR}])
-+])
-+
-+dnl add an argument to specify/override the module devel install path
-+dnl if nothing specified, it will be the passed in LINUXDIR)
-+AC_DEFUN([AS_LINUX_MODULESDEVELDIR],
-+[
-+	LINUXDIR=[$1]
-+	AC_ARG_WITH([modulesdeveldir],
-+		[AC_HELP_STRING([--with-modulesdeveldir=DIR],
-+			[specify path to kernel-specific module development install directory])],
-+		[MODULESDEVELDIR=&quot;${withval}&quot;],
-+		[MODULESDEVELDIR=default])
-+
-+	if test &quot;${MODULESDEVELDIR}&quot; = &quot;default&quot; ; then
-+		MODULESDEVELDIR=&quot;${LINUXDIR}&quot;
-+	fi
-+	dnl make it available to Makefiles so it can be used in ...dir
-+	AC_SUBST(modulesdeveldir, $MODULESDEVELDIR)
-+	AC_MSG_NOTICE([Putting kernel module development files under ${MODULESDEVELDIR}])
-+])
-+
-+AC_DEFUN([AS_LINUX_2_6],
-+[
-+	AC_MSG_CHECKING(for Linux CFLAGS)
-+
-+	{
-+	  tmpdir=`(umask 077 &amp;&amp; mktemp -d -q &quot;./confstatXXXXXX&quot;) 2&gt;/dev/null` &amp;&amp;
-+	  test -n &quot;$tmpdir&quot; &amp;&amp; test -d &quot;$tmpdir&quot;
-+	} ||
-+	{
-+	  tmpdir=./confstat$$-$RANDOM
-+	  (umask 077 &amp;&amp; mkdir $tmpdir)
-+	} ||
-+	{
-+	  echo &quot;$me: cannot create a temporary directory in .&quot; &gt;&amp;2
-+	  { (exit 1); exit 1; }
-+	}
-+
-+	tmpdir=`pwd`/$tmpdir
-+
-+	cat &gt;${tmpdir}/Makefile &lt;&lt;EOF
-+obj-m += fake.o
-+
-+\$(obj)/fake.c: flags
-+	touch \$(obj)/fake.c
-+
-+.PHONY: flags
-+flags:
-+	echo LINUX_ARCH=\&quot;\$(ARCH)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_AFLAGS=\&quot;\$(AFLAGS)\&quot; | sed 's,include,&quot;\$(LINUXDIR)/include&quot;,g'&gt;&gt;\$(obj)/flags
-+	echo LINUX_LDFLAGS=\&quot;\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_ARFLAGS=\&quot;\$(ARFLAGS)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_CROSS_COMPILE=\&quot;\$(CROSS_COMPILE)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_KERNELRELEASE=\&quot;\$(KERNELRELEASE)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_CFLAGS=\&quot;\$(CFLAGS) \$(CPPFLAGS)\&quot; | sed 's,Iinclude,I\$(LINUXDIR)/include,g' &gt;&gt;\$(obj)/flags
-+	echo LINUX_CFLAGS_MODULE=\&quot;\$(CFLAGS_MODULE)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_CC=\&quot;\$(CC)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_LD=\&quot;\$(LD) \$(LDFLAGS) \$(LDFLAGS_MODULE)\&quot; &gt;&gt;\$(obj)/flags
-+	echo LINUX_AS=\&quot;\$(AS)\&quot; &gt;&gt;\$(obj)/flags
-+EOF
-+
-+	echo ${MAKE-make} -C ${LINUX_DIR} V=1 SUBDIRS=${tmpdir} LINUXDIR=${LINUX_DIR} MODVERDIR=${tmpdir} modules &gt;&amp;5 2&gt;&amp;5
-+	${MAKE-make} -C ${LINUX_DIR} V=1 SUBDIRS=${tmpdir} LINUXDIR=${LINUX_DIR} MODVERDIR=${tmpdir} modules &gt;&amp;5 2&gt;&amp;5
-+	. ${tmpdir}/flags
-+	rm -rf ${tmpdir}
-+
-+	LINUX_MODULE_EXT=&quot;.ko&quot;
-+
-+	LINUX_CFLAGS=&quot;$LINUX_CFLAGS $LINUX_CFLAGS_MODULE&quot;
-+	LINUX_MODPOST=&quot;$LINUX_DIR/scripts/modpost&quot;
-+
-+	AC_SUBST(LINUX_ARCH)
-+	AC_SUBST(LINUX_AFLAGS)
-+	AC_SUBST(LINUX_LDFLAGS)
-+	AC_SUBST(LINUX_ARFLAGS)
-+	AC_SUBST(LINUX_CROSS_COMPILE)
-+	AC_SUBST(LINUX_KERNELRELEASE)
-+	AC_SUBST(LINUX_CFLAGS)
-+	AC_SUBST(LINUX_CC)
-+	AC_SUBST(LINUX_LD)
-+	AC_SUBST(LINUX_AS)
-+	AC_SUBST(LINUX_MODULE_EXT)
-+	AC_SUBST(LINUX_MODPOST)
-+
-+	AC_MSG_RESULT([$LINUX_CFLAGS])
-+])
-+
-+dnl checks kernel's Makefile for make variables for Linux 2.4
-+dnl adds LINUX_REDHAT_CFLAGS if non-empty
-+AC_DEFUN([AS_LINUX_2_4],
-+[
-+	AC_MSG_CHECKING(for Linux 2.4 make flags)
-+	dnl we try to figure out the CFLAGS by invoking the Makefile on
-+        dnl a test dir
-+        dnl we use the correct config file by substituting the MAKEFILES
-+        dnl Makefile variable, which originally points to .config
-+
-+	if [[ ! -e &quot;${LINUX_DIR}/.hdepend&quot; ]];then
-+		AC_MSG_ERROR([
-+You need to run 'make dep' on the kernel source before continuing.])
-+	fi
-+
-+        if test &quot;x$LINUX_EXTRAVERSION&quot; == &quot;x&quot;; then
-+          EX=
-+        else
-+          EX=&quot;EXTRAVERSION=$LINUX_EXTRAVERSION&quot;
-+        fi
-+
-+        POPDIR=`(pwd)`
-+        cd ${LINUX_DIR}
-+        TMPFILE=`mktemp /tmp/linux.XXXXXXXX` || exit 1
-+	# combine the kernel's Makefile,
-+	# sedded to use our proposed config file,
-+	# sedded to use our proposed machine value,
-+	# with the extra target we add here, to get cflags
-+	# we do not want entering/leaving info on distcheck so we run with -s
-+	( cat Makefile | sed &quot;s|\.config|${LINUX_CONFIG}|g&quot; | sed &quot;s|shell uname -m|shell echo ${LINUX_MACHINE}|g&quot; &amp;&amp; cat &lt;&lt;EOF ) | make -s -f - get_cflags $EX &gt; ${TMPFILE}
-+get_cflags:
-+	@echo LINUX_ARCH=\&quot;\$(ARCH)\&quot;
-+	@echo LINUX_AFLAGS=\&quot;\$(AFLAGS)\&quot; | sed 's_Iinclude_I\&quot;\$(LINUXDIR)/include\&quot;_g'
-+	@echo LINUX_LDFLAGS=\&quot;\&quot;
-+	@echo LINUX_ARFLAGS=\&quot;\$(ARFLAGS)\&quot;
-+	@echo LINUX_CROSS_COMPILE=\&quot;\$(CROSS_COMPILE)\&quot;
-+	@echo LINUX_KERNELRELEASE=\&quot;\$(KERNELRELEASE)\&quot;
-+	@echo LINUX_CFLAGS=\&quot;\$(CFLAGS)\&quot; | sed 's_Iinclude_I\&quot;\$(LINUXDIR)/include\&quot;_g'
-+	@echo LINUX_MODFLAGS=\&quot;\$(MODFLAGS)\&quot;
-+	@echo LINUX_CC=\&quot;\$(CC)\&quot;
-+	@echo LINUX_LD=\&quot;\$(LD) \$(LDFLAGS)\&quot;
-+	@echo LINUX_AS=\&quot;\$(AS)\&quot;
-+EOF
-+        . ${TMPFILE}
-+        rm -rf ${TMPFILE}
-+        cd $POPDIR
-+
-+        LINUX_MODULE_EXT=&quot;.o&quot;
-+
-+	LINUX_CFLAGS=&quot;$LINUX_CFLAGS $LINUX_MODFLAGS&quot;
-+
-+	dnl if we have REDHAT_CFLAGS, put them in LINUX_CFLAGS
-+	if test &quot;x$REDHAT_CFLAGS&quot; != &quot;x&quot;;
-+	then
-+		LINUX_CFLAGS=&quot;$LINUX_CFLAGS $REDHAT_CFLAGS&quot;
-+	fi
-+	AC_SUBST(LINUX_ARCH)
-+	AC_SUBST(LINUX_AFLAGS)
-+	AC_SUBST(LINUX_LDFLAGS)
-+	AC_SUBST(LINUX_ARFLAGS)
-+	AC_SUBST(LINUX_CROSS_COMPILE)
-+	AC_SUBST(LINUX_KERNELRELEASE)
-+	AC_SUBST(LINUX_CFLAGS)
-+	AC_SUBST(LINUX_CC)
-+	AC_SUBST(LINUX_LD)
-+	AC_SUBST(LINUX_AS)
-+	AC_SUBST(LINUX_MODULE_EXT)
-+
-+	AC_MSG_RESULT([ok])
-+
-+	AC_MSG_CHECKING(for Linux 2.4 CFLAGS)
-+	AC_MSG_RESULT($LINUX_CFLAGS)
-+	AC_MSG_CHECKING(for Linux 2.4 LDFLAGS)
-+	AC_MSG_RESULT($LINUX_LDFLAGS)
-+])
-+
-+AC_DEFUN([AS_CHECK_LINUX_CONFIG_OPTION],
-+[
-+	AC_MSG_CHECKING([Linux config option $1])
-+
-+	if grep '^$1=y$' ${LINUX_CONFIG} &gt;/dev/null 2&gt;/dev/null; then
-+		result=yes
-+		$2
-+	else if grep '^$1=m$' ${LINUX_CONFIG} &gt;/dev/null 2&gt;/dev/null; then
-+		result=module
-+		$3
-+	else
-+		result=no
-+		$4
-+	fi
-+	fi
-+
-+	AC_MSG_RESULT([$result])
-+])
-+
-+AC_DEFUN([AS_LINUX_CONFIG_OPTION],
-+[
-+	AS_CHECK_LINUX_CONFIG_OPTION([$1],
-+		[$1=yes],
-+		[$1=module],
-+		[$1=no])
-+
-+	AM_CONDITIONAL([$1],[test &quot;${$1}&quot; = yes])
-+])
-+
-+AC_DEFUN([AS_LINUX_CONFIG_OPTION_MODULE],
-+[
-+	AS_CHECK_LINUX_CONFIG_OPTION([$1],
-+		[$1=yes],
-+		[$1=module],
-+		[$1=no])
-+
-+	AM_CONDITIONAL([$1],[test &quot;${$1}&quot; = yes -o &quot;${$1}&quot; = module])
-+])
-+
-+dnl check for the major/minor version of the Linux source by checking
-+dnl the headers
-+dnl first argument is the linux directory
-+dnl sets LINUX_VERSION_MAJOR and LINUX_VERSION_MINOR
-+AC_DEFUN([AS_LINUX_VERSION_MAJOR_MINOR],
-+[
-+	LINUX_DIR=[$1]
-+	AC_MSG_CHECKING([Linux major/minor version])
-+
-+	if [[ ! -f &quot;${LINUX_DIR}/include/linux/version.h&quot; ]];then
-+		AC_MSG_ERROR([The header file include/linux/version.h does not exist.
-+For 2.6 kernels, it can be generated by running 'make prepare' in
-+the kernel source directory.])
-+	fi
-+        dnl the next set of tests is for figuring out version major/minor
-+        dnl we make sure we have the right version.h by faking out CFLAGS
-+	dnl since we want to avoid including linux/version.h and acidentally
-+	dnl pick up /usr/include/linux
-+	dnl we still add ${LINUX_DIR}/include so the Red Hat version can pick
-+	dnl up linux/rhversion.h
-+        ac_save_CFLAGS=&quot;$CFLAGS&quot;
-+        CFLAGS=&quot;$CFLAGS -I${LINUX_DIR}/include/linux -I${LINUX_DIR}/include&quot;
-+        dnl make sure we find version.h and it contains LINUX_VERSION_CODE
-+        AC_COMPILE_IFELSE(AC_LANG_PROGRAM([
-+/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
-+#define __BOOT_KERNEL_H_
-+#include &quot;version.h&quot;
-+int code = LINUX_VERSION_CODE;
-+]),
-+ :, AC_MSG_ERROR([${LINUX_DIR}/include/linux/version.h does not contain LINUX_VERSION_CODE]))
-+
-+
-+        dnl figure out the linux kernel version major and minor
-+        dnl using the LINUX_VERSION_CODE defined in include/linux/version.h
-+        AC_RUN_IFELSE(AC_LANG_PROGRAM([
-+/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
-+#define __BOOT_KERNEL_H_
-+#include &quot;version.h&quot;
-+#define KERNEL_VERSION_MAJOR(code) ((code) &gt;&gt; 16)
-+],[
-+  return KERNEL_VERSION_MAJOR(LINUX_VERSION_CODE);
-+]),
-+		LINUX_VERSION_MAJOR=0, 
-+		LINUX_VERSION_MAJOR=$?)
-+        AC_RUN_IFELSE(AC_LANG_PROGRAM([
-+/* to bypass the /boot/kernel.h inclusion for pre-2.6 Red Hat */
-+#define __BOOT_KERNEL_H_
-+#include &quot;version.h&quot;
-+#define KERNEL_VERSION_MINOR(code) (((code) &gt;&gt; 8) % (2 &lt;&lt; 8))
-+],[
-+  return KERNEL_VERSION_MINOR(LINUX_VERSION_CODE);
-+]),
-+		LINUX_VERSION_MINOR=0, 
-+		LINUX_VERSION_MINOR=$?)
-+        AC_MSG_RESULT($LINUX_VERSION_MAJOR.$LINUX_VERSION_MINOR)
-+	dnl restore CFLAGS
-+        CFLAGS=&quot;$ac_save_CFLAGS&quot;
-+])
-Index: kernel-module-qc-usb/qc-usb-0.6.0/configure.ac
---- kernel-module-qc-usb~autotools/qc-usb-0.6.0/configure.ac	2004-05-21 22:46:41.000000000 +0200
-+++ kernel-module-qc-usb/qc-usb-0.6.0/configure.ac	2004-05-21 22:58:27.000000000 +0200
-@@ -0,0 +1,10 @@
-+AC_INIT(qc-driver.c)
-+
-+AM_INIT_AUTOMAKE(qc-usb, 0.5.1)
-+dnl AM_CONFIG_HEADER(config.h)
-+
-+dnl look for Linux kernel source
-+AS_LINUX
-+AS_LINUX_MODTOOL
-+
-+AC_OUTPUT(Makefile testquickcam/Makefile)
-Index: kernel-module-qc-usb/qc-usb-0.6.0/autogen.sh
---- kernel-module-qc-usb~autotools/qc-usb-0.6.0/autogen.sh	2004-05-21 22:46:42.000000000 +0200
-+++ kernel-module-qc-usb/qc-usb-0.6.0/autogen.sh	2004-05-21 22:48:23.000000000 +0200
-@@ -0,0 +1,6 @@
-+#!/bin/bash
-+set -x
-+aclocal -I m4 || exit 1
-+autoconf || exit 1
-+automake -a --foreign || exit 1
-+./configure $@
-Index: kernel-module-qc-usb/qc-usb-0.6.0/m4/as-modtool.m4
---- kernel-module-qc-usb~autotools/qc-usb-0.6.0/m4/as-modtool.m4	2004-05-21 22:49:36.000000000 +0200
-+++ kernel-module-qc-usb/qc-usb-0.6.0/m4/as-modtool.m4	2004-06-16 11:09:18.123841664 +0200
-@@ -0,0 +1,147 @@
-+dnl as-modtool.m4 0.0.1
-+dnl autostars m4 macro for building modtool, a linker for Linux kernel
-+dnl modules
-+
-+dnl David Schleef &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">ds at schleef.org</A>&gt;
-+dnl Frank Mori Hess &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">fmhess at users.sourceforge.net</A>&gt;
-+dnl Thomas Vander Stichele &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">thomas at apestaart.org</A>&gt;
-+
-+dnl $Id: as-modtool.m4,v 1.12 2004/06/03 15:20:11 thomasvs Exp $
-+
-+dnl AS_LINUX_MODTOOL()
-+dnl
-+dnl this macro defines:
-+dnl moduledir
-+dnl modulePROGRAMS_INSTALL
-+dnl modulePROGRAMS_UNINSTALL
-+dnl
-+dnl End of search list.
-+
-+dnl
-+dnl FIXME:
-+dnl  How do you specify that the building of modtool should go to the
-+dnl  end of the configure script?
-+dnl
-+
-+dnl SYMVERS_INCLUDES can be used to add additional .symvers files to the
-+dnl modpost step
-+
-+AC_DEFUN([AS_LINUX_MODTOOL],
-+[
-+	AC_PATH_PROG(STRIP, strip)
-+	AC_PATH_PROG([DEPMOD], [depmod], [no], [$PATH:/sbin:/usr/sbin:/usr/local/sbin])
-+	AC_PATH_PROG([GENKSYMS], [genksyms], [no], [$PATH:/sbin:/usr/sbin:/usr/local/sbin])
-+
-+	if test &quot;x$LINUX_SMP&quot; = &quot;xyes&quot;
-+	then
-+		GENKSYMS=&quot;$GENKSYMS -p smp_&quot;
-+	fi
-+	dnl this can be overridden in Makefile.am
-+	dnl FIXME: it'd be nice if we could specify different target_PROGRAMS
-+	dnl and different targetdir
-+	moduledir=&quot;\$(modulesdir)/\$(PACKAGE)&quot;
-+	modulePROGRAMS_INSTALL=&quot;\$(top_builddir)/modtool --install&quot;
-+	modulePROGRAMS_UNINSTALL=&quot;\$(top_builddir)/modtool --uninstall&quot;
-+	AC_SUBST(moduledir)
-+	AC_SUBST(modulePROGRAMS_INSTALL)
-+
-+	LINUX_VERSION=`echo $LINUX_KERNELRELEASE | cut -d- -f1`
-+
-+	AC_MSG_NOTICE(creating modtool)
-+	cat &gt;modtool &lt;&lt;EOF
-+#!/bin/sh
-+
-+set -e
-+
-+LINUX_LD=&quot;$LINUX_LD&quot;
-+LINUX_MODPOST=&quot;$LINUX_MODPOST&quot;
-+LINUX_VERSION=&quot;$LINUX_VERSION&quot;
-+GENKSYMS=&quot;$GENKSYMS&quot;
-+CC=&quot;$LINUX_CC&quot;
-+INSTALL=&quot;$INSTALL&quot;
-+LINUX_MODULE_EXT=&quot;$LINUX_MODULE_EXT&quot;
-+STRIP=&quot;$STRIP&quot;
-+CFLAGS=&quot;$CFLAGS $LINUX_CFLAGS&quot;
-+LINUX_DIR=&quot;$LINUX_DIR&quot;
-+
-+mode=\$[1]
-+shift
-+
-+case \$mode in
-+--link)
-+	# we accept -i (symvers) and -o (target) as options
-+	# at least -o (target) needs to be specified
-+	SYMVERS_INCLUDES=&quot;&quot;
-+	done=false
-+	while test ! -z &quot;\$[0]&quot; -a &quot;\$done&quot; = &quot;false&quot;
-+	do
-+		case \$[1] in
-+		-i)
-+                        SYMVERS_INCLUDES=&quot;\$SYMVERS_INCLUDES \$[2]&quot;
-+                        shift 2
-+                        ;;
-+                -o)
-+                        target=\$(echo \$[2] | sed s/.ko$//)
-+                        shift 2
-+                        ;;
-+                *)
-+                        done=true
-+                        ;;
-+                esac
-+        done
-+
-+	mkdir -p .mods
-+	if test &quot;\$LINUX_MODULE_EXT&quot; = .ko ; then
-+
-+		\$LINUX_LD -r -o .mods/\$target.o \$[*]
-+
-+		cat \$LINUX_DIR/Module.symvers \$SYMVERS_INCLUDES &gt;.mods/symvers.tmp
-+
-+		\$LINUX_MODPOST -o .mods/\$target.o.symvers.tmp -i .mods/symvers.tmp .mods/\$target.o
-+
-+		grep .mods/\$target .mods/\$target.o.symvers.tmp &gt;.mods/\$target.o.symvers || true
-+
-+		rm -f .mods/\$target.o.symvers.tmp .mods/symvers.tmp
-+		
-+		\$CC \$CFLAGS -DKBUILD_MODNAME=\$target -c -o .mods/\$target.mod.o .mods/\$target.mod.c
-+
-+		\$LINUX_LD -r -o \$target.ko .mods/\$target.mod.o .mods/\$target.o
-+		set +x
-+	else
-+		echo \$LINUX_LD -r -o \$target.ko \$[*]
-+		\$LINUX_LD -r -o \$target.ko \$[*]
-+                                                                      
-+		if test &quot;x\$SOURCES&quot; != &quot;x&quot;
-+		then
-+			echo &quot;\$CC \$CFLAGS -E -D__GENKSYMS__ \$SOURCES | \$GENKSYMS -k \$LINUX_VERSION &gt; .mods/\$target.ver&quot;
-+			\$CC \$CFLAGS -E -D__GENKSYMS__ \$SOURCES | \$GENKSYMS -k \$LINUX_VERSION &gt; .mods/\$target.ver
-+		fi
-+
-+	fi
-+
-+	;;
-+--install)
-+	module_src=\$[1]
-+	module_dest=\`echo \$[2] | sed &quot;s/\.ko$/\${LINUX_MODULE_EXT}/&quot;\`
-+	echo \$INSTALL -m644 &quot;\$module_src&quot; &quot;\$module_dest&quot;
-+	\$INSTALL -m644 &quot;\$module_src&quot; &quot;\$module_dest&quot;
-+	\$STRIP -g &quot;\$module_dest&quot;
-+	;;
-+--uninstall)
-+	module_src=\$[1]
-+	module_dest=\`echo \$[2] | sed &quot;s/\.ko$/\${LINUX_MODULE_EXT}/&quot;\`
-+	echo uninstall &quot;\$module_src&quot; &quot;\$module_dest&quot;
-+	rm -f &quot;\$module_dest&quot;
-+	;;
-+*)
-+	echo Unknown mode \$mode &gt;&amp;2
-+	exit 1
-+esac
-+
-+EOF
-+	chmod +x modtool
-+
-+
-+])
-+
-+


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000900.html">[SVN] r2094 - in trunk/rpms: denemo devhelp distcc drivel tinc	tinyca tvtime xkobo zenity
</A></li>
	<LI>Next message: <A HREF="000902.html">[SVN] r2096 - trunk/rpms/pearpc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#901">[ date ]</a>
              <a href="thread.html#901">[ thread ]</a>
              <a href="subject.html#901">[ subject ]</a>
              <a href="author.html#901">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
