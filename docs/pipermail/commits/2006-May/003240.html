<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r4440 - in trunk/rpms: amavisd-new createrepo	perl-Authen-SASL perl-Bit-Vector-Minimal perl-GSSAPI	perl-IP-Country perl-Test-SimpleUnit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r4440%20-%20in%20trunk/rpms%3A%20amavisd-new%20createrepo%0A%09perl-Authen-SASL%20perl-Bit-Vector-Minimal%20perl-GSSAPI%0A%09perl-IP-Country%20perl-Test-SimpleUnit&In-Reply-To=%3C20060529031029.0EBE194CD68%40pooch.vmhosting.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003239.html">
   <LINK REL="Next"  HREF="003241.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r4440 - in trunk/rpms: amavisd-new createrepo	perl-Authen-SASL perl-Bit-Vector-Minimal perl-GSSAPI	perl-IP-Country perl-Test-SimpleUnit</H1>
    <B>packagers at lists.rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r4440%20-%20in%20trunk/rpms%3A%20amavisd-new%20createrepo%0A%09perl-Authen-SASL%20perl-Bit-Vector-Minimal%20perl-GSSAPI%0A%09perl-IP-Country%20perl-Test-SimpleUnit&In-Reply-To=%3C20060529031029.0EBE194CD68%40pooch.vmhosting.org%3E"
       TITLE="[svn] r4440 - in trunk/rpms: amavisd-new createrepo	perl-Authen-SASL perl-Bit-Vector-Minimal perl-GSSAPI	perl-IP-Country perl-Test-SimpleUnit">packagers at lists.rpmforge.net
       </A><BR>
    <I>Mon May 29 05:10:29 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="003239.html">[svn] r4439 - in trunk/rpms: . perl-Log-Message-Simple
</A></li>
        <LI>Next message: <A HREF="003241.html">[svn] r4441 - in trunk/tools/dar: . dists/fc2a scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3240">[ date ]</a>
              <a href="thread.html#3240">[ thread ]</a>
              <a href="subject.html#3240">[ subject ]</a>
              <a href="author.html#3240">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dag
Date: 2006-05-29 05:10:27 +0200 (Mon, 29 May 2006)
New Revision: 4440

Added:
   trunk/rpms/createrepo/createrepo-0.4.4-noepoch.patch
   trunk/rpms/createrepo/createrepo-0.4.4-update2.1.patch
Modified:
   trunk/rpms/amavisd-new/amavisd-new.spec
   trunk/rpms/createrepo/createrepo.spec
   trunk/rpms/perl-Authen-SASL/perl-Authen-SASL.spec
   trunk/rpms/perl-Bit-Vector-Minimal/perl-Bit-Vector-Minimal.spec
   trunk/rpms/perl-GSSAPI/perl-GSSAPI.spec
   trunk/rpms/perl-IP-Country/perl-IP-Country.spec
   trunk/rpms/perl-Test-SimpleUnit/perl-Test-SimpleUnit.spec
Log:
Updates

Modified: trunk/rpms/amavisd-new/amavisd-new.spec
===================================================================
--- trunk/rpms/amavisd-new/amavisd-new.spec	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/amavisd-new/amavisd-new.spec	2006-05-29 03:10:27 UTC (rev 4440)
@@ -12,7 +12,7 @@
 Summary: Mail virus-scanner
 Name: amavisd-new
 Version: 2.4.1
-Release: 1
+Release: 2
 License: GPL
 Group: System Environment/Daemons
 URL: <A HREF="http://www.ijs.si/software/amavisd/">http://www.ijs.si/software/amavisd/</A>
@@ -31,6 +31,7 @@
 Requires: perl(Digest::HMAC), perl(Net::DNS), perl(Mail::SpamAssassin)
 Requires: perl-MailTools, perl(Net::Server) &gt;= 0.93, perl-HTML-Parser &gt;= 3.24
 Requires: perl(DB_File), perl(Digest::MD5) &gt;= 2.22, perl(DBI) &gt;= 1.43
+Requires: perl(Net::Cmd) &gt;= 2.24
 
 Obsoletes: amavisd
 
@@ -312,8 +313,8 @@
 %{_sbindir}/amavis-milter
 
 %changelog
-* Thu May 11 2006 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 2.4.1-1
-- Updated to release 2.4.1.
+* Mon May 29 2006 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 2.4.1-2
+- Added perl-Net-Cmd &gt;= 2.24 as a new dependency. (Peter Bieringer)
 
 * Tue Apr 18 2006 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 2.4.0-3
 - Added perl-DBI &gt;= 1.43 as a new dependency. (Jim)

Added: trunk/rpms/createrepo/createrepo-0.4.4-noepoch.patch
===================================================================
--- trunk/rpms/createrepo/createrepo-0.4.4-noepoch.patch	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/createrepo/createrepo-0.4.4-noepoch.patch	2006-05-29 03:10:27 UTC (rev 4440)
@@ -0,0 +1,133 @@
+? createrepo-0.4.4-noepoch.patch
+Index: dumpMetadata.py
+===================================================================
+RCS file: /cvsroot/metadata/cvs-root/generate/dumpMetadata.py,v
+retrieving revision 1.36
+diff -u -r1.36 dumpMetadata.py
+--- dumpMetadata.py	21 Feb 2006 20:10:08 -0000	1.36
++++ dumpMetadata.py	17 May 2006 18:29:18 -0000
+@@ -225,6 +225,10 @@
+             raise MDError, &quot;Error Stat'ing file %s %s&quot; % (basedir, filename)
+         self.options = options
+         self.localurl = options['baseurl']
++        if options['noepoch']:
++           self.noepoch = &quot;&quot;
++        else:
++           self.noepoch = 0
+         self.relativepath = filename
+         fd = returnFD(os.path.join(basedir, filename))
+         self.hdr = returnHdr(ts, fd)
+@@ -323,7 +327,7 @@
+         if i != -1:
+             epoch = strng[:i]
+         else:
+-            epoch = '0'
++            epoch = self.noepoch
+         j = strng.find('-')
+         if j != -1:
+             if strng[i + 1:j] == '':
+@@ -438,7 +442,7 @@
+         
+     def epoch(self):
+         if self.hdr['epoch'] is None:
+-            return 0
++            return self.noepoch
+         else:
+             return self.tagByName('epoch')
+             
+@@ -592,7 +596,8 @@
+     pkgNode.newChild(None, 'name', rpmObj.tagByName('name'))
+     pkgNode.newChild(None, 'arch', rpmObj.arch())
+     version = pkgNode.newChild(None, 'version', None)
+-    version.newProp('epoch', str(rpmObj.epoch()))
++    if str(rpmObj.epoch()):
++        version.newProp('epoch', str(rpmObj.epoch()))
+     version.newProp('ver', str(rpmObj.tagByName('version')))
+     version.newProp('rel', str(rpmObj.tagByName('release')))
+     csum = pkgNode.newChild(None, 'checksum', rpmObj.pkgid)
+@@ -643,7 +648,7 @@
+                     if flags == 12: arg = 'GE'
+                     entry.newProp('flags', arg)
+                     # if we've got a flag we've got a version, I hope :)
+-                    if e:
++                    if str(e):
+                         entry.newProp('epoch', str(e))
+                     if v:
+                         entry.newProp('ver', str(v))
+@@ -664,7 +669,7 @@
+                 if flags == 12: arg = 'GE'
+                 entry.newProp('flags', arg)
+                 # if we've got a flag we've got a version, I hope :)
+-                if e:
++                if str(e):
+                     entry.newProp('epoch', str(e))
+                 if v:
+                     entry.newProp('ver', str(v))
+@@ -696,7 +701,8 @@
+     pkg.newProp('name', rpmObj.tagByName('name'))
+     pkg.newProp('arch', rpmObj.arch())
+     version = pkg.newChild(None, 'version', None)
+-    version.newProp('epoch', str(rpmObj.epoch()))
++    if str(rpmObj.epoch()):
++        version.newProp('epoch', str(rpmObj.epoch()))
+     version.newProp('ver', str(rpmObj.tagByName('version')))
+     version.newProp('rel', str(rpmObj.tagByName('release')))
+     for file in rpmObj.filenames:
+@@ -721,7 +727,8 @@
+     pkg.newProp('name', rpmObj.tagByName('name'))
+     pkg.newProp('arch', rpmObj.arch())
+     version = pkg.newChild(None, 'version', None)
+-    version.newProp('epoch', str(rpmObj.epoch()))
++    if str(rpmObj.epoch()):
++        version.newProp('epoch', str(rpmObj.epoch()))
+     version.newProp('ver', str(rpmObj.tagByName('version')))
+     version.newProp('rel', str(rpmObj.tagByName('release')))
+     clogs = rpmObj.changelogLists()
+Index: genpkgmetadata.py
+===================================================================
+RCS file: /cvsroot/metadata/cvs-root/generate/genpkgmetadata.py,v
+retrieving revision 1.51
+diff -u -r1.51 genpkgmetadata.py
+--- genpkgmetadata.py	21 Feb 2006 23:30:26 -0000	1.51
++++ genpkgmetadata.py	17 May 2006 18:29:18 -0000
+@@ -49,6 +49,9 @@
+      -o, --outputdir &lt;dir&gt; = optional directory to output to
+      -x, --exclude = files globs to exclude, can be specified multiple times
+      -q, --quiet = run quietly
++     -n, --noepoch = don't add zero epochs for non-existent epochs
++                    (incompatible with yum and smart but required for
++                     systems with rpm &lt; 4.2.1)
+      -g, --groupfile &lt;filename&gt; to point to for group information (precreated)
+                     (&lt;filename&gt; relative to directory-of-packages)
+      -v, --verbose = run verbosely
+@@ -364,6 +367,7 @@
+     cmds['baseurl'] = None
+     cmds['groupfile'] = None
+     cmds['sumtype'] = 'sha'
++    cmds['noepoch'] = False
+     cmds['pretty'] = 0
+ #    cmds['updategroupsonly'] = 0
+     cmds['cachedir'] = None
+@@ -375,11 +379,11 @@
+     cmds['dir-pattern-match'] = ['.*bin\/.*', '^\/etc\/.*']
+ 
+     try:
+-        gopts, argsleft = getopt.getopt(args, 'phqVvg:s:x:u:c:U:o:', ['help', 'exclude=',
++        gopts, argsleft = getopt.getopt(args, 'phqVvng:s:x:u:c:U:o:', ['help', 'exclude=',
+                                                                   'quiet', 'verbose', 'cachedir=', 'basedir=',
+                                                                   'baseurl=', 'groupfile=', 'checksum=',
+                                                                   'version', 'pretty', 'split', 'outputdir=',
+-                                                                  'update-info-location='])
++                                                                  'update-info-location=', 'noepoch'])
+     except getopt.error, e:
+         errorprint(_('Options Error: %s.') % e)
+         usage()
+@@ -443,6 +447,8 @@
+                 cmds['basedir'] = a
+             elif arg in ['-o','--outputdir']:
+                 cmds['outputdir'] = a
++            elif arg in ['-n', '--noepoch']:
++                cmds['noepoch'] = True
+                     
+     except ValueError, e:
+         errorprint(_('Options Error: %s') % e)

Added: trunk/rpms/createrepo/createrepo-0.4.4-update2.1.patch
===================================================================
--- trunk/rpms/createrepo/createrepo-0.4.4-update2.1.patch	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/createrepo/createrepo-0.4.4-update2.1.patch	2006-05-29 03:10:27 UTC (rev 4440)
@@ -0,0 +1,464 @@
+--- genpkgmetadata.py.orig	2006-05-29 04:38:51.562156888 +0200
++++ genpkgmetadata.py	2006-05-29 04:46:10.592414144 +0200
+@@ -30,6 +30,7 @@
+ import urlgrabber
+ 
+ import dumpMetadata
++import readMetadata
+ from dumpMetadata import _gzipOpen
+ __version__ = '0.4.3'
+ 
+@@ -60,6 +61,7 @@
+      -h, --help = show this help
+      -V, --version = output version
+      -p, --pretty = output xml files in pretty format.
++     --update = update existing metadata (if present)
+     &quot;&quot;&quot;)
+ 
+     sys.exit(retval)
+@@ -115,6 +117,15 @@
+         &quot;&quot;&quot;all the heavy lifting for the package metadata&quot;&quot;&quot;
+ 
+         # rpms we're going to be dealing with
++        if self.cmds['update']:
++            #build the paths
++            basefile = os.path.join(self.cmds['outputdir'], self.cmds['finaldir'], self.cmds['primaryfile'])
++            flfile = os.path.join(self.cmds['outputdir'], self.cmds['finaldir'], self.cmds['filelistsfile'])
++            otherfile = os.path.join(self.cmds['outputdir'], self.cmds['finaldir'], self.cmds['otherfile'])
++            opts = {'verbose' : self.cmds['verbose']}
++            #and scan the old repo
++            self.oldData = readMetadata.MetadataIndex(self.cmds['outputdir'],
++                                                      basefile, flfile, otherfile, opts)
+         files = self.getFileList(self.cmds['basedir'], directory, '.rpm', [])
+         files = self.trimRpms(files)
+         self.pkgcount = len(files)
+@@ -122,7 +133,6 @@
+         self.writeMetadataDocs(files)
+         self.closeMetadataDocs()
+ 
+-
+     def openMetadataDocs(self):
+         self._setupBase()
+         self._setupFilelists()
+@@ -165,85 +175,103 @@
+         self.otherfile.write('&lt;otherdata xmlns=&quot;<A HREF="http://linux.duke.edu/metadata/other">http://linux.duke.edu/metadata/other</A>&quot; packages=&quot;%s&quot;&gt;\n' %
+                        self.pkgcount)
+ 
++    def _getNodes(self,file,current):
++        basenode = None
++        filesnode = None
++        othernode = None
++        try:
++            mdobj = dumpMetadata.RpmMetaData(self.ts, self.cmds['basedir'], file, self.cmds)
++        except dumpMetadata.MDError, e:
++            errorprint('\n%s - %s' % (e, file))
++            return None
++        try:
++            basenode = dumpMetadata.generateXML(self.basedoc, self.baseroot, self.formatns, mdobj, self.cmds['sumtype'])
++        except dumpMetadata.MDError, e:
++            errorprint(_('\nAn error occurred creating primary metadata: %s') % e)
++            return None
++        try:
++            filesnode = dumpMetadata.fileListXML(self.filesdoc, self.filesroot, mdobj)
++        except dumpMetadata.MDError, e:
++            errorprint(_('\nAn error occurred creating filelists: %s') % e)
++            return None
++        try:
++            othernode = dumpMetadata.otherXML(self.otherdoc, self.otherroot, mdobj)
++        except dumpMetadata.MDError, e:
++            errorprint(_('\nAn error occurred: %s') % e)
++            return None
++        return basenode,filesnode,othernode
++
+     def writeMetadataDocs(self, files, current=0):
+         for file in files:
+             current+=1
+-            try:
+-                mdobj = dumpMetadata.RpmMetaData(self.ts, self.cmds['basedir'], file, self.cmds)
+-                if not self.cmds['quiet']:
+-                    if self.cmds['verbose']:
+-                        print '%d/%d - %s' % (current, len(files), file)
+-                    else:
+-                        sys.stdout.write('\r' + ' ' * 80)
+-                        sys.stdout.write(&quot;\r%d/%d - %s&quot; % (current, self.pkgcount, file))
+-                        sys.stdout.flush()
+-            except dumpMetadata.MDError, e:
+-                errorprint('\n%s - %s' % (e, file))
+-                continue
+-            else:
+-                try:
+-                    node = dumpMetadata.generateXML(self.basedoc, self.baseroot, self.formatns, mdobj, self.cmds['sumtype'])
+-                except dumpMetadata.MDError, e:
+-                    errorprint(_('\nAn error occurred creating primary metadata: %s') % e)
+-                    continue
+-                else:
+-                    try:
+-                        # Fetch the update metadata for this package
+-                        if self.cmds['update-info-location']:
+-                            metadata = urlgrabber.urlopen(
+-                                    self.cmds['update-info-location'] +
+-                                    '?pkg=%s' % file)
+-                            filename = file.replace('.rpm', '.xml')
+-                            metadata.filename = os.path.join(
+-                                    self.cmds['basedir'], self.cmds['tempdir'],
+-                                    self.cmds['update-info-dir'], filename)
+-                            metadata._do_grab()
+-                            metadata.close()
+-
+-                            # Get the update ID from the metadata
+-                            md = libxml2.parseFile(metadata.filename)
+-                            update_root = md.children
+-                            update = node.newChild(None, 'update', None)
+-                            update.newProp('id', update_root.prop('id'))
+-                            update.newProp('location', os.path.join(
+-                                    self.cmds['update-info-dir'], filename))
+-                            del md, metadata
+-                    except Exception, e:
+-                        pass
+-                    output = node.serialize('UTF-8', self.cmds['pretty'])
+-                    self.basefile.write(output)
+-                    self.basefile.write('\n')
+-                    node.unlinkNode()
+-                    node.freeNode()
+-                    del node
+-
+-                try:
+-                    node = dumpMetadata.fileListXML(self.filesdoc, self.filesroot, mdobj)
+-                except dumpMetadata.MDError, e:
+-                    errorprint(_('\nAn error occurred creating filelists: %s') % e)
+-                    continue
++            recycled = False
++            sep = '-'
++            if self.cmds['update']:
++                #see if we can pull the nodes from the old repo
++                nodes = self.oldData.getNodes(file)
++                if nodes is not None:
++                    recycled = True
++                    sep = '*'
++            if not recycled:
++                #scan rpm files
++                nodes = self._getNodes(file,current)
++            if nodes is None:
++                return
++            basenode, filenode, othernode = nodes
++            del nodes
++            if not self.cmds['quiet']:
++                if self.cmds['verbose']:
++                    print '%d/%d %s %s' % (current, self.pkgcount, sep, file)
+                 else:
+-                    output = node.serialize('UTF-8', self.cmds['pretty'])
+-                    self.flfile.write(output)
+-                    self.flfile.write('\n')
++                    sys.stdout.write('\r' + ' ' * 80)
++                    sys.stdout.write(&quot;\r%d/%d %s %s&quot; % (current, self.pkgcount, sep, file))
++                    sys.stdout.flush()
++            if basenode is None:
++                continue
++            # Fetch the update metadata for this package
++            if not recycled and self.cmds.get('update-info-location'):
++                _fetchUpdateMetadata(file, basenode)
++
++            for node, outfile in ((basenode,self.basefile),
++                                  (filenode,self.flfile),
++                                  (othernode,self.otherfile)):
++                if node is None:
++                    break
++                output = node.serialize('UTF-8', self.cmds['pretty'])
++                outfile.write(output)
++                outfile.write('\n')
++                if not recycled:
++                    #recycled nodes can be multiply referenced
+                     node.unlinkNode()
+                     node.freeNode()
+-                    del node
++            if recycled:
++                self.oldData.freeNodes(file)
+ 
+-                try:
+-                    node = dumpMetadata.otherXML(self.otherdoc, self.otherroot, mdobj)
+-                except dumpMetadata.MDError, e:
+-                    errorprint(_('\nAn error occurred: %s') % e)
+-                    continue
+-                else:
+-                    output = node.serialize('UTF-8', self.cmds['pretty'])
+-                    self.otherfile.write(output)
+-                    self.otherfile.write('\n')
+-                    node.unlinkNode()
+-                    node.freeNode()
+-                    del node
+         return current
+ 
++    def _fetchUpdateMetadata(file, node):
++        try:
++            # Fetch the update metadata for this package
++            metadata = urlgrabber.urlopen(
++                    self.cmds['update-info-location'] +
++                    '?pkg=%s' % file)
++            filename = file.replace('.rpm', '.xml')
++            metadata.filename = os.path.join(
++                    self.cmds['basedir'], self.cmds['tempdir'],
++                    self.cmds['update-info-dir'], filename)
++            metadata._do_grab()
++            metadata.close()
++
++            # Get the update ID from the metadata
++            md = libxml2.parseFile(metadata.filename)
++            update_root = md.children
++            update = node.newChild(None, 'update', None)
++            update.newProp('id', update_root.prop('id'))
++            update.newProp('location', os.path.join(
++                    self.cmds['update-info-dir'], filename))
++            del md, metadata
++        except Exception, e:
++            pass
+ 
+     def closeMetadataDocs(self):
+         if not self.cmds['quiet']:
+@@ -374,6 +402,7 @@
+     cmds['basedir'] = os.getcwd()
+     cmds['cache'] = False
+     cmds['split'] = False
++    cmds['update'] = False
+     cmds['outputdir'] = &quot;&quot;
+     cmds['file-pattern-match'] = ['.*bin\/.*', '^\/etc\/.*', '^\/usr\/lib\/sendmail$']
+     cmds['dir-pattern-match'] = ['.*bin\/.*', '^\/etc\/.*']
+@@ -383,7 +412,7 @@
+                                                                   'quiet', 'verbose', 'cachedir=', 'basedir=',
+                                                                   'baseurl=', 'groupfile=', 'checksum=',
+                                                                   'version', 'pretty', 'split', 'outputdir=',
+-                                                                  'update-info-location=', 'noepoch'])
++                                                                  'update-info-location=', 'noepoch', 'update'])
+     except getopt.error, e:
+         errorprint(_('Options Error: %s.') % e)
+         usage()
+@@ -443,6 +472,8 @@
+                 cmds['cachedir'] = a
+             elif arg in ['-U', '--update-info-location']:
+                 cmds['update-info-location'] = a
++            elif arg == '--update':
++                cmds['update'] = True
+             elif arg == '--basedir':
+                 cmds['basedir'] = a
+             elif arg in ['-o','--outputdir']:
+@@ -465,6 +496,7 @@
+     else:
+         cmds['basedir'] = os.path.realpath(os.path.join(cmds['basedir'], directory))
+         directory = '.'
++    directories[0] = directory
+     if not cmds['outputdir']:
+         cmds['outputdir'] = cmds['basedir']
+     if cmds['groupfile']:
+--- Makefile.orig	2006-05-29 04:50:49.680986232 +0200
++++ Makefile	2006-05-29 04:46:36.476479168 +0200
+@@ -40,7 +40,8 @@
+ SUBDIRS = bin docs
+ 
+ MODULES = $(srcdir)/genpkgmetadata.py \
+-    	  $(srcdir)/dumpMetadata.py 
++    	  $(srcdir)/dumpMetadata.py \
++          $(srcdir)/readMetadata.py
+ 
+ .SUFFIXES: .py .pyc
+ .py.pyc: 
+--- readMetadata.py.orig	1970-01-01 01:00:00.000000000 +0100
++++ readMetadata.py	2006-05-29 04:48:22.684333120 +0200
+@@ -0,0 +1,199 @@
++#!/usr/bin/python -t
++
++# This program is free software; you can redistribute it and/or modify
++# it under the terms of the GNU General Public License as published by
++# the Free Software Foundation; either version 2 of the License, or
++# (at your option) any later version.
++#
++# This program is distributed in the hope that it will be useful,
++# but WITHOUT ANY WARRANTY; without even the implied warranty of
++# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++# GNU Library General Public License for more details.
++#
++# You should have received a copy of the GNU General Public License
++# along with this program; if not, write to the Free Software
++# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++# Copyright 2006 Red Hat
++
++import os
++import sys
++import libxml2
++import pprint
++import stat
++
++def errorprint(stuff):
++    print &gt;&gt; sys.stderr, stuff
++
++def _(args):
++    &quot;&quot;&quot;Stub function for translation&quot;&quot;&quot;
++    return args
++
++class MetadataIndex(object):
++
++    def __init__(self, outputdir, basefile, filelistfile, otherfile, opts=None):
++        if opts is None:
++            opts = {}
++        self.opts = opts
++        self.outputdir = outputdir
++        self.files = {'base' : basefile,
++                      'filelist' : filelistfile,
++                      'other' : otherfile}
++        self.scan()
++
++    def scan(self):
++        &quot;&quot;&quot;Read in and index old repo data&quot;&quot;&quot;
++        self.basenodes = {}
++        self.filesnodes = {}
++        self.othernodes = {}
++        self.pkg_ids = {}
++        if self.opts.get('verbose'):
++            print _(&quot;Scanning old repo data&quot;)
++        for file in self.files.values():
++            if not os.path.exists(file):
++                #cannot scan
++                errorprint(_(&quot;Previous repo file missing: %s&quot;) % file)
++                return
++        root = libxml2.parseFile(self.files['base']).getRootElement()
++        self._scanPackageNodes(root, self._handleBase)
++        if self.opts.get('verbose'):
++            print _(&quot;Indexed %i base nodes&quot; % len(self.basenodes))
++        root = libxml2.parseFile(self.files['filelist']).getRootElement()
++        self._scanPackageNodes(root, self._handleFiles)
++        if self.opts.get('verbose'):
++            print _(&quot;Indexed %i filelist nodes&quot; % len(self.filesnodes))
++        root = libxml2.parseFile(self.files['other']).getRootElement()
++        self._scanPackageNodes(root, self._handleOther)
++        if self.opts.get('verbose'):
++            print _(&quot;Indexed %i other nodes&quot; % len(self.othernodes))
++        #reverse index pkg ids to track references
++        self.pkgrefs = {}
++        for relpath, pkgid in self.pkg_ids.iteritems():
++            self.pkgrefs.setdefault(pkgid,[]).append(relpath)
++
++    def _scanPackageNodes(self, root, handler):
++        node = root.children
++        while node is not None:
++            if node.type != &quot;element&quot;:
++                node = node.next
++                continue
++            if node.name == &quot;package&quot;:
++                handler(node)
++            node = node.next
++
++    def _handleBase(self, node):
++        top = node
++        node = node.children
++        pkgid = None
++        mtime = None
++        size = None
++        relpath = None
++        while node is not None:
++            if node.type != &quot;element&quot;:
++                node = node.next
++                continue
++            if node.name == &quot;checksum&quot;:
++                pkgid = node.content
++            elif node.name == &quot;time&quot;:
++                mtime = int(node.prop('file'))
++            elif node.name == &quot;size&quot;:
++                size = int(node.prop('package'))
++            elif node.name == &quot;location&quot;:
++                relpath = node.prop('href')
++            node = node.next
++        if relpath is None:
++            print _(&quot;Incomplete data for node&quot;)
++            return
++        if pkgid is None:
++            print _(&quot;pkgid missing for %s&quot;) % relpath
++            return
++        if mtime is None:
++            print _(&quot;mtime missing for %s&quot;) % relpath
++            return
++        if size is None:
++            print _(&quot;size missing for %s&quot;) % relpath
++            return
++        filepath = os.path.join(self.outputdir, relpath)
++        try:
++            st = os.stat(filepath)
++        except OSError:
++            #file missing -- ignore
++            return
++        if not stat.S_ISREG(st.st_mode):
++            #ignore non files
++            return
++        #check size and mtime
++        if st.st_size != size:
++            if self.opts.get('verbose'):
++                print _(&quot;Size (%i -&gt; %i) changed for file %s&quot;) % (size,st.st_size,filepath)
++            return
++        if st.st_mtime != mtime:
++            if self.opts.get('verbose'):
++                print _(&quot;Modification time changed for %s&quot;) % filepath
++            return
++        #otherwise we index
++        self.basenodes[relpath] = top
++        self.pkg_ids[relpath] = pkgid
++
++    def _handleFiles(self, node):
++        pkgid = node.prop('pkgid')
++        if pkgid:
++            self.filesnodes[pkgid] = node
++
++    def _handleOther(self, node):
++        pkgid = node.prop('pkgid')
++        if pkgid:
++            self.othernodes[pkgid] = node
++
++    def getNodes(self, relpath):
++        &quot;&quot;&quot;Return base, filelist, and other nodes for file, if they exist
++
++        Returns a tuple of nodes, or None if not found
++        &quot;&quot;&quot;
++        bnode = self.basenodes.get(relpath,None)
++        if bnode is None:
++            return None
++        pkgid = self.pkg_ids.get(relpath,None)
++        if pkgid is None:
++            print _(&quot;No pkgid found for: %s&quot;) % relpath
++            return None
++        fnode = self.filesnodes.get(pkgid,None)
++        if fnode is None:
++            return None
++        onode = self.othernodes.get(pkgid,None)
++        if onode is None:
++            return None
++        return bnode, fnode, onode
++
++    def freeNodes(self,relpath):
++        #causing problems
++        &quot;&quot;&quot;Free up nodes corresponding to file, if possible&quot;&quot;&quot;
++        bnode = self.basenodes.get(relpath,None)
++        if bnode is None:
++            print &quot;Missing node for %s&quot; % relpath
++            return
++        bnode.unlinkNode()
++        bnode.freeNode()
++        del self.basenodes[relpath]
++        pkgid = self.pkg_ids.get(relpath,None)
++        if pkgid is None:
++            print _(&quot;No pkgid found for: %s&quot;) % relpath
++            return None
++        del self.pkg_ids[relpath]
++        dups = self.pkgrefs.get(pkgid)
++        dups.remove(relpath)
++        if len(dups):
++            #still referenced
++            return
++        del self.pkgrefs[pkgid]
++        for nodes in self.filesnodes, self.othernodes:
++            node = nodes.get(pkgid)
++            if node is not None:
++                node.unlinkNode()
++                node.freeNode()
++                del nodes[pkgid]
++
++
++if __name__ == &quot;__main__&quot;:
++    #test code - attempts to read a repo in working directory
++    idx = MetadataIndex(&quot;.&quot;, &quot;repodata/primary.xml.gz&quot;, &quot;repodata/filelists.xml.gz&quot;,
++                        &quot;repodata/other.xml.gz&quot;, {'verbose':1})

Modified: trunk/rpms/createrepo/createrepo.spec
===================================================================
--- trunk/rpms/createrepo/createrepo.spec	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/createrepo/createrepo.spec	2006-05-29 03:10:27 UTC (rev 4440)
@@ -8,12 +8,14 @@
 Summary: Creates a common metadata repository
 Name: createrepo
 Version: 0.4.4
-Release: 2
+Release: 3
 License: GPL
 Group: System Environment/Base
 URL: <A HREF="http://linux.duke.edu/projects/metadata/">http://linux.duke.edu/projects/metadata/</A>
 
 Source: <A HREF="http://linux.duke.edu/projects/metadata/generate/createrepo-%{version">http://linux.duke.edu/projects/metadata/generate/createrepo-%{version</A>}.tar.gz
+Patch0: createrepo-0.4.4-noepoch.patch
+Patch1: <A HREF="http://people.redhat.com/mikem/software/createrepo-0.4.4-update2.1.patch">http://people.redhat.com/mikem/software/createrepo-0.4.4-update2.1.patch</A>
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
 
 BuildArch: noarch
@@ -24,27 +26,25 @@
 This utility will generate a common metadata repository from a directory of
 rpm packages
 
-
 %prep
 %setup
+%patch0
+%patch1
+
 # Replace interpreter's name if it's not &quot;python&quot;
 if [ &quot;%{python}&quot; != &quot;python&quot; ]; then
     %{__perl} -pi -e 's|/usr/bin/python|/usr/bin/%{python}|g' *.py
 fi
 
-
 %build
 
-
 %install
 %{__rm} -rf %{buildroot}
 %makeinstall
 
-
 %clean
 %{__rm} -rf %{buildroot}
 
-
 %files
 %defattr(-, root, root, 0755)
 %doc ChangeLog README
@@ -53,6 +53,9 @@
 %{_datadir}/createrepo/
 
 %changelog
+* Mon May 29 2006 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 0.4.4-3
+- Added noepoch an update2 patches.
+
 * Fri Mar 24 2006 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 0.4.4-2
 - Added python-urlgrabber as a dependency. (Robert Hardy)
 

Modified: trunk/rpms/perl-Authen-SASL/perl-Authen-SASL.spec
===================================================================
--- trunk/rpms/perl-Authen-SASL/perl-Authen-SASL.spec	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/perl-Authen-SASL/perl-Authen-SASL.spec	2006-05-29 03:10:27 UTC (rev 4440)
@@ -2,6 +2,11 @@
 # Authority: dries
 # Upstream: Graham Barr &lt;gbarr$pobox,com&gt;
 
+%{?el3:%define _without_gssapi 1}
+%{?rh9:%define _without_gssapi 1}
+%{?rh7:%define _without_gssapi 1}
+%{?el2:%define _without_gssapi 1}
+
 %define perl_vendorlib %(eval &quot;`perl -V:installvendorlib`&quot;; echo $installvendorlib)
 %define perl_vendorarch %(eval &quot;`perl -V:installvendorarch`&quot;; echo $installvendorarch)
 
@@ -19,7 +24,8 @@
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
 
 BuildArch: noarch
-BuildRequires: perl, perl(Digest::HMAC_MD5), perl(GSSAPI)
+BuildRequires: perl, perl(Digest::HMAC_MD5)
+%{!?_without_gssapi:BuildRequires: perl(GSSAPI)}
 
 %description
 This module permits authentication with SASL.
@@ -28,9 +34,7 @@
 %setup -n %{real_name}-%{version}
 
 %build
-%{__perl} Makefile.PL \
-	INSTALLDIRS=&quot;vendor&quot; \
-	PREFIX=&quot;%{buildroot}%{_prefix}&quot;
+%{__perl} Makefile.PL INSTALLDIRS=&quot;vendor&quot; PREFIX=&quot;%{buildroot}%{_prefix}&quot;
 %{__make} %{?_smp_mflags}
 
 %install
@@ -38,8 +42,7 @@
 %makeinstall
 
 ### Clean up buildroot
-%{__rm} -rf %{buildroot}%{perl_archlib} \
-                %{buildroot}%{perl_vendorarch}
+%{__rm} -rf %{buildroot}%{perl_archlib} %{buildroot}%{perl_vendorarch}
 
 %clean
 %{__rm} -rf %{buildroot}
@@ -47,7 +50,8 @@
 %files
 %defattr(-, root, root, 0755)
 %doc api.txt Changes example_pl
-%{_mandir}/man3/*
+%{_mandir}/man3/*.3*
+%dir %{perl_vendorlib}/Authen/
 %{perl_vendorlib}/Authen/SASL.pm
 %{perl_vendorlib}/Authen/SASL.pod
 %{perl_vendorlib}/Authen/SASL/
@@ -56,9 +60,6 @@
 * Sun Mar 26 2006 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 2.10-1
 - Updated to release 2.10.
 
-* Wed Mar 22 2006 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 2.09-1.2
-- Rebuild for Fedora Core 5.
-
 * Wed Jun  8 2005 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 2.09-1
 - Updated to release 2.09.
 

Modified: trunk/rpms/perl-Bit-Vector-Minimal/perl-Bit-Vector-Minimal.spec
===================================================================
--- trunk/rpms/perl-Bit-Vector-Minimal/perl-Bit-Vector-Minimal.spec	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/perl-Bit-Vector-Minimal/perl-Bit-Vector-Minimal.spec	2006-05-29 03:10:27 UTC (rev 4440)
@@ -38,8 +38,7 @@
 %makeinstall
 
 ### Clean up buildroot
-%{__rm} -rf %{buildroot}%{perl_archlib} \
-		%{buildroot}%{perl_vendorarch}
+%{__rm} -rf %{buildroot}%{perl_archlib} %{buildroot}%{perl_vendorarch}
 
 %clean
 %{__rm} -rf %{buildroot}
@@ -51,9 +50,6 @@
 %{perl_vendorlib}/Bit/
 
 %changelog
-* Wed Mar 22 2006 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 1.3-1.2
-- Rebuild for Fedora Core 5.
-
 * Sat Nov  5 2005 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 1.3-1
 - Updated to release 1.3.
 

Modified: trunk/rpms/perl-GSSAPI/perl-GSSAPI.spec
===================================================================
--- trunk/rpms/perl-GSSAPI/perl-GSSAPI.spec	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/perl-GSSAPI/perl-GSSAPI.spec	2006-05-29 03:10:27 UTC (rev 4440)
@@ -27,14 +27,9 @@
 
 %prep
 %setup -n GSSAPI-%{version}
-chmod a-x examples/*.pl
+%{__chmod} a-x examples/*.pl
 
 %build
-if pkg-config openssl; then
-        export CFLAGS=&quot;%{optflags} $(pkg-config --cflags openssl)&quot;
-        export CPPFLAGS=&quot;%{optflags} $(pkg-config --cflags openssl)&quot;
-        export LDFLAGS=&quot;$(pkg-config --libs-only-L openssl)&quot;
-fi
 %{__perl} Makefile.PL INSTALLDIRS=&quot;vendor&quot; PREFIX=&quot;%{buildroot}%{_prefix}&quot;
 %{__make} %{?_smp_mflags} OPTIMIZE=&quot;%{optflags}&quot;
 

Modified: trunk/rpms/perl-IP-Country/perl-IP-Country.spec
===================================================================
--- trunk/rpms/perl-IP-Country/perl-IP-Country.spec	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/perl-IP-Country/perl-IP-Country.spec	2006-05-29 03:10:27 UTC (rev 4440)
@@ -9,8 +9,8 @@
 
 Summary: Classes for fast lookup of country codes from IP addresses for Perl
 Name: perl-IP-Country
-Version: 2.20
-Release: 1.2
+Version: 2.21
+Release: 1
 License: distributable
 Group: Applications/CPAN
 URL: <A HREF="http://search.cpan.org/dist/IP-Country/">http://search.cpan.org/dist/IP-Country/</A>
@@ -39,9 +39,7 @@
 %setup -n %{real_name}-%{version}
 
 %build
-CFLAGS=&quot;%{optflags}&quot; %{__perl} Makefile.PL \
-	PREFIX=&quot;%{buildroot}%{_prefix}&quot; \
-	INSTALLDIRS=&quot;vendor&quot;
+CFLAGS=&quot;%{optflags}&quot; %{__perl} Makefile.PL INSTALLDIRS=&quot;vendor&quot; PREFIX=&quot;%{buildroot}%{_prefix}&quot;
 %{__make} %{?_smp_mflags}
 
 %install
@@ -49,8 +47,7 @@
 %makeinstall
 
 ### Clean up buildroot
-%{__rm} -rf %{buildroot}%{perl_archlib} \
-                %{buildroot}%{perl_vendorarch}
+%{__rm} -rf %{buildroot}%{perl_archlib} %{buildroot}%{perl_vendorarch}
 
 %clean
 %{__rm} -rf %{buildroot}
@@ -58,13 +55,14 @@
 %files
 %defattr(-, root, root, 0755)
 %doc CHANGES MANIFEST README
-%doc %{_mandir}/man?/*
+%doc %{_mandir}/man1/ip2cc.1*
+%doc %{_mandir}/man3/*.3*
 %{_bindir}/ip2cc
 %{perl_vendorlib}/IP/
 
 %changelog
-* Mon Apr 10 2006 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 2.20-1.2
-- Rebuild for Fedora Core 5.
+* Mon May 29 2006 Dag Wieers &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dag at wieers.com</A>&gt; - 2.21-1
+- Updated to release 2.21.
 
 * Sat Jun 18 2005 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 2.20-1
 - Updated to release 2.20.

Modified: trunk/rpms/perl-Test-SimpleUnit/perl-Test-SimpleUnit.spec
===================================================================
--- trunk/rpms/perl-Test-SimpleUnit/perl-Test-SimpleUnit.spec	2006-05-29 00:17:57 UTC (rev 4439)
+++ trunk/rpms/perl-Test-SimpleUnit/perl-Test-SimpleUnit.spec	2006-05-29 03:10:27 UTC (rev 4440)
@@ -15,7 +15,7 @@
 Group: Applications/CPAN
 URL: <A HREF="http://search.cpan.org/dist/Test-SimpleUnit/">http://search.cpan.org/dist/Test-SimpleUnit/</A>
 
-Source: <A HREF="http://search.cpan.org/CPAN/authors/id/G/GE/GED/Test-SimpleUnit-%{version">http://search.cpan.org/CPAN/authors/id/G/GE/GED/Test-SimpleUnit-%{version</A>}.tar.gz
+Source: <A HREF="http://www.cpan.org/modules/by-module/Test/Test-SimpleUnit-%{version">http://www.cpan.org/modules/by-module/Test/Test-SimpleUnit-%{version</A>}.tar.gz
 BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
 
 BuildArch: noarch
@@ -43,12 +43,10 @@
 %files
 %defattr(-, root, root, 0755)
 %doc ChangeLog README
-%doc %{_mandir}/man3/*
+%doc %{_mandir}/man3/*.3*
+%dir %{perl_vendorlib}/Test/
 %{perl_vendorlib}/Test/SimpleUnit.pm
 
 %changelog
-* Wed Mar 22 2006 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 1.21-1.2
-- Rebuild for Fedora Core 5.
-
 * Sat Apr  9 2005 Dries Verachtert &lt;<A HREF="http://lists.repoforge.org/mailman/listinfo/commits">dries at ulyssis.org</A>&gt; - 1.21-1
 - Initial package.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003239.html">[svn] r4439 - in trunk/rpms: . perl-Log-Message-Simple
</A></li>
	<LI>Next message: <A HREF="003241.html">[svn] r4441 - in trunk/tools/dar: . dists/fc2a scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3240">[ date ]</a>
              <a href="thread.html#3240">[ thread ]</a>
              <a href="subject.html#3240">[ subject ]</a>
              <a href="author.html#3240">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
