<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [svn] r3314 - in trunk/tools/pydar2: dries pydar scripts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r3314%20-%20in%20trunk/tools/pydar2%3A%20dries%20pydar%20scripts&In-Reply-To=%3C20050621195330.5D64931CD14%40pooch.vmhosting.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002115.html">
   <LINK REL="Next"  HREF="002117.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[svn] r3314 - in trunk/tools/pydar2: dries pydar scripts</H1>
    <B>packagers at lists.rpmforge.net</B> 
    <A HREF="mailto:commits%40lists.repoforge.org?Subject=Re:%20Re%3A%20%5Bsvn%5D%20r3314%20-%20in%20trunk/tools/pydar2%3A%20dries%20pydar%20scripts&In-Reply-To=%3C20050621195330.5D64931CD14%40pooch.vmhosting.org%3E"
       TITLE="[svn] r3314 - in trunk/tools/pydar2: dries pydar scripts">packagers at lists.rpmforge.net
       </A><BR>
    <I>Tue Jun 21 21:53:30 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002115.html">[svn] r3313 - in trunk/rpms: krusader perl-TimeDate texmacs
</A></li>
        <LI>Next message: <A HREF="002117.html">[svn] r3315 - in trunk/tools/dconf: . config rpmqa scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2116">[ date ]</a>
              <a href="thread.html#2116">[ thread ]</a>
              <a href="subject.html#2116">[ subject ]</a>
              <a href="author.html#2116">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: dries
Date: 2005-06-21 21:53:23 +0200 (Tue, 21 Jun 2005)
New Revision: 3314

Added:
   trunk/tools/pydar2/pydar/smartbasedbuildroot.py
Modified:
   trunk/tools/pydar2/dries/clientconfig-part.html
   trunk/tools/pydar2/dries/directoryview-part.html
   trunk/tools/pydar2/pydar/specfiletags.py
   trunk/tools/pydar2/scripts/rpmforgeacceptcommand.py
   trunk/tools/pydar2/scripts/rpmforgegetsources.py
   trunk/tools/pydar2/scripts/rpmforgesite.py
Log:
update

Modified: trunk/tools/pydar2/dries/clientconfig-part.html
===================================================================
--- trunk/tools/pydar2/dries/clientconfig-part.html	2005-06-21 19:49:34 UTC (rev 3313)
+++ trunk/tools/pydar2/dries/clientconfig-part.html	2005-06-21 19:53:23 UTC (rev 3314)
@@ -5,7 +5,7 @@
           &lt;pre&gt;
 [dries]
 name=Extra Fedora rpms dries - $releasever - $basearch
-baseurl=<A HREF="http://apt.sw.be/dries/redhat/el4/en/i386/dries/RPMS">http://apt.sw.be/dries/redhat/el4/en/i386/dries/RPMS</A>
+baseurl=<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el4/en/i386/dries/RPMS">http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el4/en/i386/dries/RPMS</A>
           &lt;/pre&gt;
         &lt;/div&gt;
       &lt;/div&gt;
@@ -28,7 +28,7 @@
           &lt;pre&gt;
 [dries]
 name=Extra Fedora rpms dries - $releasever - $basearch
-baseurl=<A HREF="http://apt.sw.be/dries/redhat/el3/en/i386/dries">http://apt.sw.be/dries/redhat/el3/en/i386/dries</A>
+baseurl=<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el3/en/i386/dries">http://ftp.belnet.be/packages/dries.ulyssis.org/redhat/el3/en/i386/dries</A>
           &lt;/pre&gt;
         &lt;/div&gt;
       &lt;/div&gt;
@@ -43,8 +43,28 @@
         &lt;/div&gt;
       &lt;/div&gt;
 
+     &lt;div class=&quot;alinea&quot;&gt;
+        &lt;div class=&quot;title&quot;&gt;YUM configuration for Fedora Core 4&lt;/div&gt;
+        You will need to add the following lines to your yum config: 
+        &lt;div class=&quot;aptlines&quot;&gt;
+          &lt;pre&gt;
+[dries]
+name=Extra Fedora rpms dries - $releasever - $basearch
+baseurl=<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/linux/$releasever/$basearch/dries/RPMS/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/linux/$releasever/$basearch/dries/RPMS/</A>
+          &lt;/pre&gt;
+        &lt;/div&gt;
+      &lt;/div&gt;
+      &lt;div class=&quot;alinea&quot;&gt;
+        &lt;div class=&quot;title&quot;&gt;APT configuration for Fedora Core 4 i386&lt;/div&gt;
+        You will need to add the following lines to your apt config:
+        &lt;div class=&quot;aptlines&quot;&gt;
+          &lt;pre&gt;
+rpm <A HREF="http://apt.sw.be">http://apt.sw.be</A> dries/fedora/fc4/i386 dries
+rpm-src <A HREF="http://apt.sw.be">http://apt.sw.be</A> dries/fedora/fc4/i386 dries
+          &lt;/pre&gt;
+        &lt;/div&gt;
+      &lt;/div&gt;      
 
-
       &lt;div class=&quot;alinea&quot;&gt;
         &lt;div class=&quot;title&quot;&gt;YUM configuration for Fedora Core 3&lt;/div&gt;
         You will need to add the following lines to your yum config: 
@@ -52,7 +72,7 @@
           &lt;pre&gt;
 [dries]
 name=Extra Fedora rpms dries - $releasever - $basearch
-baseurl=<A HREF="http://apt.sw.be/dries/fedora/linux/$releasever/$basearch/dries/RPMS/">http://apt.sw.be/dries/fedora/linux/$releasever/$basearch/dries/RPMS/</A>
+baseurl=<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/linux/$releasever/$basearch/dries/RPMS/">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/linux/$releasever/$basearch/dries/RPMS/</A>
           &lt;/pre&gt;
         &lt;/div&gt;
       &lt;/div&gt;
@@ -73,7 +93,7 @@
           &lt;pre&gt;
 [dries]
 name=Extra Fedora rpms dries - $releasever - $basearch
-baseurl=<A HREF="http://apt.sw.be/dries/fedora/linux/$releasever/$basearch/dries">http://apt.sw.be/dries/fedora/linux/$releasever/$basearch/dries</A>
+baseurl=<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/linux/$releasever/$basearch/dries">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/linux/$releasever/$basearch/dries</A>
           &lt;/pre&gt;
         &lt;/div&gt;
       &lt;/div&gt;
@@ -94,7 +114,7 @@
           &lt;pre&gt;
 [dries]
 name=Extra Fedora rpms dries - $releasever - $basearch
-baseurl=<A HREF="http://apt.sw.be/dries/fedora/linux/$releasever/$basearch/dries">http://apt.sw.be/dries/fedora/linux/$releasever/$basearch/dries</A>
+baseurl=<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/linux/$releasever/$basearch/dries">http://ftp.belnet.be/packages/dries.ulyssis.org/fedora/linux/$releasever/$basearch/dries</A>
           &lt;/pre&gt;
         &lt;/div&gt;
       &lt;/div&gt;
@@ -115,7 +135,7 @@
           &lt;pre&gt;
 [dries]
 name=Extra Fedora rpms dries - $releasever - $basearch
-baseurl=<A HREF="http://apt.sw.be/dries/aurora/1.91/sparc/dries">http://apt.sw.be/dries/aurora/1.91/sparc/dries</A>
+baseurl=<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.91/sparc/dries">http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.91/sparc/dries</A>
           &lt;/pre&gt;
         &lt;/div&gt;
       &lt;/div&gt;
@@ -136,7 +156,7 @@
           &lt;pre&gt;
 [dries]
 name=Extra Fedora rpms dries - $releasever - $basearch
-baseurl=<A HREF="http://apt.sw.be/dries/aurora/1.92/sparc/dries">http://apt.sw.be/dries/aurora/1.92/sparc/dries</A>
+baseurl=<A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.92/sparc/dries">http://ftp.belnet.be/packages/dries.ulyssis.org/aurora/1.92/sparc/dries</A>
           &lt;/pre&gt;
         &lt;/div&gt;
       &lt;/div&gt;

Modified: trunk/tools/pydar2/dries/directoryview-part.html
===================================================================
--- trunk/tools/pydar2/dries/directoryview-part.html	2005-06-21 19:49:34 UTC (rev 3313)
+++ trunk/tools/pydar2/dries/directoryview-part.html	2005-06-21 19:53:23 UTC (rev 3314)
@@ -1,9 +1,9 @@
 &lt;?php
-// todo updaten van file op ace
+
 $dh = opendir(&quot;.&quot;);
 ?&gt;&lt;a href=&quot;..&quot;&gt;Parent Directory&lt;/a&gt;&lt;br /&gt;&lt;?php
 while (($file = readdir($dh)) !== false) {
-        if (($file != &quot;.&quot;) &amp;&amp; ($file != &quot;..&quot;)) {
+        if (($file != &quot;.&quot;) &amp;&amp; ($file != &quot;..&quot;) &amp;&amp; ($file != &quot;.htaccess&quot;) &amp;&amp; ($file != &quot;index.php&quot;)) {
                 $suffix = &quot;&quot;;
                 if (is_dir($file)) {
                         $suffix = &quot;/&quot;;
@@ -12,4 +12,4 @@
         }
 }
 closedir($dh);
-?&gt;
\ No newline at end of file
+?&gt;

Added: trunk/tools/pydar2/pydar/smartbasedbuildroot.py
===================================================================
--- trunk/tools/pydar2/pydar/smartbasedbuildroot.py	2005-06-21 19:49:34 UTC (rev 3313)
+++ trunk/tools/pydar2/pydar/smartbasedbuildroot.py	2005-06-21 19:53:23 UTC (rev 3314)
@@ -0,0 +1,251 @@
+
+&quot;&quot;&quot; A buildroot based on smart &quot;&quot;&quot;
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Library General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+# Copyright 2004 Dries Verachtert
+
+
+import getopt, os, sys, Queue, posix, posixpath, string, re, os.path, shutil, commands
+from log4py import Logger
+from buildroot import BuildRoot
+from buildrootresult import BuildRootResult
+import config
+#from specfile import SpecFile
+
+# import stuff:
+# -odata-dir=/var/lib/pydar2/smart/ &lt;buildmachineid&gt; / &lt;buildroottag&gt; /
+# -orpm-root=/var/lib/pydar2/roots/ &lt;buildmachineid&gt; / &lt;buildroottag&gt;-smart /
+#  todo: how to change the dir /etc/smart/channels ?
+
+# not finished, todo
+
+class SmartBasedBuildRoot(BuildRoot):
+    def __init__(self,buildRootTag):
+        self.__cat = Logger().get_instance(self)
+        brr = BuildRootResult(self)
+        self.__config = config.Config.getInstance()
+        self._setBuildRootTag( buildRootTag)
+        self.__setVars(brr)
+        self.__cat.debug(&quot;initialized&quot;)
+        self.__useCacheOnly = False
+        #return brr
+        
+    # todo possible with smart?
+    def setUseCacheOnly(self,bVar):
+        self.__useCacheOnly = bVar
+    
+    def _umounts(self, brr):
+        self.__cat.debug(&quot;start&quot;)
+        cmd = &quot;sudo umount &quot; + self.rootdir + &quot;/proc&quot;
+        self.logCommandWithoutErrors(cmd,brr)
+        cmd = &quot;sudo umount &quot; + self.rootdir + &quot;/sys&quot;
+        self.logCommandWithoutErrors(cmd,brr)
+        
+    def cleanRoot(self):
+        self.__cat.debug(&quot;cleaning this root..&quot;)
+        brr = BuildRootResult(self)
+        self._umounts(brr)
+        cmd = &quot;sudo rm -Rf &quot; + self.rootdir
+        self.logCommand(cmd,brr)
+        return brr
+        
+    def __setVars(self,brr):
+        self.yumConfFile = &quot;/etc/pydar2/smart/&quot; + self.__config.getBuildMachineId() + &quot;/&quot; + self.getBuildRootTag() + &quot;.conf&quot;
+        if os.path.exists(self.yumConfFile):
+            self.__cat.debug(&quot;using userdefined yum conf: &quot; + self.yumConfFile)
+        else:
+            self.yumConfFile = &quot;/etc/pydar2/yum/&quot; + self.getBuildRootTag() + &quot;.conf&quot;
+            self.__cat.debug(&quot;using normal yum conf: &quot; + self.yumConfFile)
+        self.yumCacheDir = &quot;/var/lib/pydar2/yum/cache/&quot; + self.getBuildRootTag()
+        self.rootdir = &quot;/var/lib/pydar2/roots/yum-&quot; + self.getBuildRootTag()
+        
+        # this definetely has to move to a config file
+        self.minimalRpmsPart1 = &quot;basesystem filesystem setup bash glibc&quot;
+        self.minimalRpmsPart2 = &quot;coreutils findutils&quot;
+        self.minimalRpmsPart3 = &quot;rpm-devel rpm-build make gcc tar gzip patch unzip bzip2 diffutils cpio elfutils redhat-rpm-config perl&quot;
+        self.minimalRpmsPart4 = &quot;&quot;
+        brr.logDebugLine(&quot;rootdir:&quot; + self.rootdir)
+    
+    def installRpms(self,builddepsarr):
+        brr = BuildRootResult(self)
+        # todo auto remove all deps which are already installed , not only perl
+        if len(builddepsarr) &gt; 0 and not (len(builddepsarr) == 1 and builddepsarr[0] ==  &quot;perl&quot;):
+            commandpart = &quot;&quot;
+            for b in builddepsarr:
+                commandpart = commandpart + &quot; &quot; + b
+                cacheParam = &quot;&quot;
+                if self.__useCacheOnly:
+                    cacheParam = &quot; -C &quot;
+            cmd = &quot;sudo yum &quot; + cacheParam + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + commandpart
+            self.logCommand(cmd,brr)
+        return brr
+        
+    # makes a new root
+    def prepareRoot(self):
+        brr = BuildRootResult(self)
+        cmd = []
+        # create some directories first
+        cmd.append(&quot;sudo mkdir -p &quot; + self.rootdir + &quot;/var/lib/rpm &quot; + self.rootdir + &quot;/var/log &quot; + self.rootdir + &quot;/var/cache &quot; + self.rootdir + &quot;/etc &quot; + self.rootdir + &quot;/proc &quot; + self.rootdir + &quot;/sys &quot; + self.rootdir + &quot;/usr/src/redhat/BUILD &quot; + self.rootdir + &quot;/usr/src/redhat/RPMS &quot; + self.rootdir + &quot;/usr/src/redhat/SOURCES &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS &quot; + self.rootdir + &quot;/usr/src/redhat/SRPMS &quot; + self.rootdir + &quot;/dev/&quot;)
+        # copy fstab
+        cmd.append(&quot;sudo cp /etc/fstab &quot; + self.rootdir + &quot;/etc&quot;)
+        # mount proc
+        cmd.append(&quot;sudo mount -t proc none &quot; + self.rootdir + &quot;/proc&quot;)
+        # mount sys
+        cmd.append(&quot;sudo mount -t sysfs none &quot; + self.rootdir + &quot;/sys&quot;)
+        # create /dev/null
+        cmd.append(&quot;sudo mknod &quot; + self.rootdir + &quot;/dev/null c 1 3&quot;)
+        # rpm initdb
+        cmd.append(&quot;sudo rpm --root=&quot; + self.rootdir + &quot; --initdb&quot;)
+        # use a central yum cache
+        cmd.append(&quot;sudo ln -s &quot; + self.yumCacheDir + &quot; &quot; + self.rootdir + &quot;/var/cache/yum&quot;)
+        # install the rpms
+        cacheParam = &quot;&quot;
+        if self.__useCacheOnly:
+            cacheParam = &quot; -C &quot;
+        if self.minimalRpmsPart1 != &quot;&quot;:
+            cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart1)
+        if self.minimalRpmsPart2 != &quot;&quot;:
+            cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart2)
+        if self.minimalRpmsPart3 != &quot;&quot;:
+            cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart3)
+        if self.minimalRpmsPart4 != &quot;&quot;:
+            cmd.append(&quot;sudo yum &quot; + cacheParam  + &quot; -c &quot; + self.yumConfFile + &quot; -y -t --installroot=&quot; + self.rootdir + &quot; install &quot; + self.minimalRpmsPart4)
+        cmd.append(&quot;sudo chmod -R a+rwx &quot; + self.rootdir + &quot;/usr/src/redhat/&quot;)
+        self.logCommands(cmd,brr)
+        return brr
+        
+    def logCommands(self,cmdArr,brr):
+        for cmd in cmdArr:
+            self.logCommand(cmd,brr)
+            # todo: if error =&gt; stop
+        
+    def logCommand(self,cmd,brr):
+        brr.logDebugLine(&quot;CMD: Command line:&quot; + cmd)
+        (status,output) = commands.getstatusoutput(cmd)
+        brr.logDebugLine(&quot;CMD: Status:&quot; + str(status))
+        # first remove all the '\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*
+        output = re.sub('\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*',&quot;&quot;,output)
+        output = re.sub('\r',&quot;&quot;,output)
+        brr.logDebugLine(&quot;CMD: output:&quot; + str(output))
+        if status != 0:
+            brr.logErrorLine(&quot;CMD: status (&quot; + str(status) + &quot;) is not 0 !&quot;)
+        
+    def logCommandWithoutErrors(self,cmd,brr):
+        brr.logDebugLine(&quot;CMD: Command line:&quot; + cmd)
+        (status,output) = commands.getstatusoutput(cmd)
+        brr.logDebugLine(&quot;CMD: Status:&quot; + str(status))
+        # first remove all the '\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*
+        output = re.sub('\rInstalling: .*? [0-9][0-9]? % done [0-9]*\/[0-9]*',&quot;&quot;,output)
+        output = re.sub('\r',&quot;&quot;,output)
+        brr.logDebugLine(&quot;CMD: output:&quot; + str(output))
+        
+    def buildRpm(self,command):
+        brr = BuildRootResult(self)
+        self.__cat.debug(&quot;start&quot;)
+        # copy the sources
+        self.__copySources(command,brr)
+        # create a script which does the actual building
+        scriptcontents = self.__createScript(command,brr)
+        # then we call the script
+        self.__callBuildScript(scriptcontents, command, brr)
+        # get all the results
+        self.__getLogsAndRpmsAndSrpm(command,brr)
+        # then we parse the log: get additional usefull files if need, for example config.log if the build has failed
+        self.__parseLog(command,brr)
+        return brr
+    
+    def __copySources(self,command,brr):
+        self.__cat.debug(&quot;start&quot;)
+        startdir = command.getBuildDir()
+        listdir = os.listdir(startdir)
+        specdestdir = os.path.join(self.rootdir,'usr/src/redhat/SPECS')
+        sourcesdestdir = os.path.join(self.rootdir,'usr/src/redhat/SOURCES')
+        self.__cat.debug('specdestdir: ' + specdestdir)
+        self.__cat.debug('sourcesdestdir: ' + sourcesdestdir)
+        for entry in listdir:
+            rindex = string.rfind(entry,'.spec')
+            if os.path.isfile(os.path.join(startdir,entry)) and not (rindex &gt; 0 and rindex == len(entry) - len('.spec')):
+                # its not the spec files
+                shutil.copy(os.path.join(startdir,entry), sourcesdestdir)
+            else:
+                # its the spec file
+                shutil.copy(os.path.join(startdir,entry),specdestdir)
+        self.__cat.debug('copy done')
+            
+    def __getLogsAndRpmsAndSrpm(self,command,brr):
+        self.__cat.debug(&quot;start&quot;)
+        shutil.copy(os.path.join(self.rootdir, &quot;buildlog.txt&quot;), command.getBuildDir())
+        cmd = &quot;gzip &quot; + command.getBuildDir() + &quot;/buildlog.txt&quot;
+        self.logCommand(cmd,brr)
+        # search in the /usr/src/redhat/RPMS and /usr/src/redhat/SRPMS dirs..
+        rpmsdir = os.path.join(self.rootdir,'usr/src/redhat/RPMS')
+        ld = os.listdir(rpmsdir)
+        for entry in ld:
+            self.__getRpmsOrSrpms(command,brr,os.path.join(rpmsdir,entry))
+        srpmsdir = os.path.join(self.rootdir,'usr/src/redhat/SRPMS')
+        self.__getRpmsOrSrpms(command,brr,srpmsdir)
+            
+    def __getRpmsOrSrpms(self,command,brr,path):
+        self.__cat.debug('start, path=' + path)
+        ld  = os.listdir(path)
+        for entry in ld:
+            rindex = string.rfind(entry,'.rpm')
+            if os.path.isfile(os.path.join(path,entry)) and (rindex &gt; 0 and rindex == len(entry) - len('.rpm')):
+                # let's copy it
+                shutil.copy(os.path.join(path,entry),command.getBuildDir())
+                rindex = string.rfind(entry,'.src.rpm')
+                if  rindex &gt; 0 and rindex == len(entry) - len('.src.rpm'):
+                    brr.setSrpm(entry)
+                else:
+                    brr.addRpm(entry)
+    
+    def __createScript(self,command,brr):
+        self.__cat.debug(&quot;start&quot;)
+        script = &quot;#!/bin/bash\n&quot;
+        script = script + 'for i in ' + self.rootdir + '/etc/profile.d/*.sh; do' + &quot;\n&quot;
+        script = script + '    if [ -r &quot;$i&quot; ]; then' + &quot;\n&quot;
+        script = script + '        . $i' + &quot;\n&quot;
+        script = script + &quot;    fi\n&quot;
+        script = script + &quot;done\n&quot;
+        script = script + &quot;chown -R root.root &quot; + self.rootdir + &quot;/usr/src/redhat\n&quot;
+        # the following command first checks if the dependencies are ok
+        # ex: --define '_topdir /var/lib/pydar2/roots/yum-fc3-i386/usr/src/redhat'
+        script = script + &quot;(/usr/bin/rpmbuild --define '_topdir &quot; + self.rootdir + &quot;/usr/src/redhat' &quot; + command.getDefines() + &quot; --root=&quot; + self.rootdir + &quot; --nobuild --bs &quot; + self.rootdir + &quot;/usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &amp;&amp; echo \&quot;deps check ok\&quot; &amp;&amp; &quot;
+        # do the real build
+        script = script + &quot;/usr/sbin/chroot &quot; + self.rootdir + &quot; /usr/bin/rpmbuild --nodeps -ba /usr/src/redhat/SPECS/&quot; + command.getSpecFileShortFileName() + &quot; &quot; + command.getDefines() + &quot; ) &gt; &quot; + self.rootdir + &quot;/buildlog.txt 2&gt;&amp;1&quot;
+        self.__cat.debug( &quot;script contains: &quot; + script)
+        return script
+        
+    def __callBuildScript(self, scriptcontents, command, brr):
+        self.__cat.debug(&quot;start&quot;)
+        # first write it to a temp file
+        filepath = self.rootdir + &quot;/tmp/pydar2build.sh&quot;
+        fd = open(filepath,&quot;w&quot;)
+        fd.write(scriptcontents)
+        fd.close()
+        cmd = &quot;sudo /bin/bash &quot; + self.rootdir + &quot;/tmp/pydar2build.sh&quot;
+        self.logCommand(cmd,brr)
+    
+    def __parseLog(self,command,brr):
+        self.__cat.debug(&quot;start, not ready&quot;)
+    
+## tests
+#myRoot = YumBasedBuildRoot(&quot;&quot;,&quot;fedora-3-i386-core&quot;)
+#myRoot.cleanRoot()
+#myRoot.prepareRoot()
+#spec = SpecFile('/home/dries/projects/rap-svn/svn/trunk/rpms/aldo/aldo.spec',' --define &quot;fc3 1&quot; ')
+#myRoot.installRpms(spec.getBuildRequires())
+##myRoot.
+#print myRoot.logText


Property changes on: trunk/tools/pydar2/pydar/smartbasedbuildroot.py
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/tools/pydar2/pydar/specfiletags.py
===================================================================
--- trunk/tools/pydar2/pydar/specfiletags.py	2005-06-21 19:49:34 UTC (rev 3313)
+++ trunk/tools/pydar2/pydar/specfiletags.py	2005-06-21 19:53:23 UTC (rev 3314)
@@ -68,11 +68,26 @@
                 finalbuildreqs.append(br)
                 self.cat.debug(&quot;good buildreq: &quot; + br)
             else:
+                perlcheck = False
+                mo = re.search(re.compile('perl\((.*)::(.*)::(.*)\)'), br)
+                if perlcheck == False and mo != None:
+                    tempbr = &quot;perl-&quot; + mo.group(1) + &quot;-&quot; + mo.group(2) + &quot;-&quot; + mo.group(3)
+                    self.cat.debug(&quot;also good buildreq: &quot; + tempbr)
+                    finalbuildreqs.append(tempbr)
+                    perlcheck = True
                 mo = re.search(re.compile('perl\((.*)::(.*)\)'), br)
-                if mo != None:
+                if perlcheck == False and mo != None:
                     tempbr = &quot;perl-&quot; + mo.group(1) + &quot;-&quot; + mo.group(2)
                     self.cat.debug(&quot;also good buildreq: &quot; + tempbr)
                     finalbuildreqs.append(tempbr)
+                    perlcheck = True
+                mo = re.search(re.compile('perl\((.*)\)'), br)
+                if perlcheck == False and mo != None:
+                    tempbr = &quot;perl-&quot; + mo.group(1)
+                    self.cat.debug(&quot;also good buildreq: &quot; + tempbr)
+                    finalbuildreqs.append(tempbr)
+                    perlcheck = True
+                    
         return finalbuildreqs
        
         

Modified: trunk/tools/pydar2/scripts/rpmforgeacceptcommand.py
===================================================================
--- trunk/tools/pydar2/scripts/rpmforgeacceptcommand.py	2005-06-21 19:49:34 UTC (rev 3313)
+++ trunk/tools/pydar2/scripts/rpmforgeacceptcommand.py	2005-06-21 19:53:23 UTC (rev 3314)
@@ -36,12 +36,7 @@
     if authority == None:
         print &quot;spec file without authority, ignoring&quot;
         return False
-    #else:
-    #    #if string.find(authority, &quot;dries&quot;) &lt; 0:
-    #        return False
+    else:
+        if string.find(authority, &quot;axel&quot;) &gt; 0:
+            return False
     return True
-    
-    
-    
-    
-    

Modified: trunk/tools/pydar2/scripts/rpmforgegetsources.py
===================================================================
--- trunk/tools/pydar2/scripts/rpmforgegetsources.py	2005-06-21 19:49:34 UTC (rev 3313)
+++ trunk/tools/pydar2/scripts/rpmforgegetsources.py	2005-06-21 19:53:23 UTC (rev 3314)
@@ -76,12 +76,18 @@
         brr.logDebugLine(&quot;status: &quot; + str(status) + &quot;, output: &quot;+ str(output))
         
     # now copy everything from the cache to the commanddir
+    
     dirlist = os.listdir(cacheDir)
+    brr.logDebugLine(&quot;before copying, the cachedir:&quot; + str (cacheDir))
     for entry in dirlist:
+        brr.logDebugLine(&quot;entry: &quot; + str(entry))
         rindex = string.rfind(entry,'.spec')
-    if os.path.isfile(os.path.join(cacheDir,entry)) and not (rindex &gt; 0 and rindex == len(entry) - len('.spec')):
-        print &quot;lets copy  (cachedir-&gt;commanddir): &quot; + entry
-        
-        shutil.copy(os.path.join(cacheDir,entry), commanddir)
-    else:
-        print &quot;wont copy  (cachedir-&gt;commanddir): &quot; + entry
+        brr.logDebugLine(&quot;rindex: &quot; + str(rindex))
+        if os.path.isfile(os.path.join(cacheDir,entry)) and not (rindex &gt; 0 and rindex == len(entry) - len('.spec')):
+            print &quot;lets copy  (cachedir-&gt;commanddir): &quot; + entry
+            brr.logDebugLine(&quot;lets copy  (cachedir-&gt;commanddir): &quot; + str(entry))
+            shutil.copy(os.path.join(cacheDir,entry), commanddir)
+        else:
+            print &quot;wont copy  (cachedir-&gt;commanddir): &quot; + entry
+            brr.logDebugLine(&quot;wont copy  (cachedir-&gt;commanddir): &quot; + str(entry))
+            

Modified: trunk/tools/pydar2/scripts/rpmforgesite.py
===================================================================
--- trunk/tools/pydar2/scripts/rpmforgesite.py	2005-06-21 19:49:34 UTC (rev 3313)
+++ trunk/tools/pydar2/scripts/rpmforgesite.py	2005-06-21 19:53:23 UTC (rev 3314)
@@ -180,21 +180,23 @@
         dirs = [&quot;fedora&quot;, &quot;redhat&quot;, &quot;aurora&quot;]
         for i in dirs:
             self.generateDirectoryView(i)
-        # also create a HEADER.html which is used on the mirrors
-        self.generateHeaders()
+        # add some symbolic links
+        self.createDirHierarchy(&quot;fedora/core&quot;)
+        self.createDirHierarchy(&quot;fedora/linux&quot;)
+        self.createSymbolicLink(&quot;fedora/core/1&quot;, &quot;../fc1&quot;)
+        self.createSymbolicLink(&quot;fedora/core/2&quot;, &quot;../fc2&quot;)
+        self.createSymbolicLink(&quot;fedora/core/3&quot;, &quot;../fc3&quot;)
+        self.createSymbolicLink(&quot;fedora/core/4&quot;, &quot;../fc4&quot;)
+        self.createSymbolicLink(&quot;fedora/linux/1&quot;, &quot;../fc1&quot;)
+        self.createSymbolicLink(&quot;fedora/linux/2&quot;, &quot;../fc2&quot;)
+        self.createSymbolicLink(&quot;fedora/linux/3&quot;, &quot;../fc3&quot;)
+        self.createSymbolicLink(&quot;fedora/linux/4&quot;, &quot;../fc4&quot;)
+        self.generateDirectoryView(&quot;fedora&quot;)
+        self.generateDirectoryView(&quot;fedora/core&quot;)
+        self.generateDirectoryView(&quot;fedora/linux&quot;)
+        self.generateDirectoryView(&quot;redhat&quot;)
+        self.generateDirectoryView(&quot;aurora&quot;)
         
-    def generateHeaders(self):
-        contents = &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; media=\&quot;all\&quot; href=\&quot;<A HREF="http://dries.ulyssis.org/layout/rpm.css\">http://dries.ulyssis.org/layout/rpm.css\</A>&quot;/&gt;\n&quot;
-        contents = contents + &quot;&lt;div class=\&quot;dirheader\&quot;&gt;You can find more information about these rpms at &lt;a href=\&quot;<A HREF="http://dries.ulyssis.org/rpm/\">http://dries.ulyssis.org/rpm/\</A>&quot;&gt;<A HREF="http://dries.ulyssis.org/rpm/&lt;/a">http://dries.ulyssis.org/rpm/&lt;/a</A>&gt;&lt;/div&gt;\n&quot;
-        f = open(os.path.join(self.__siterootdir,&quot;HEADERS.html&quot;), &quot;w&quot;)
-        f.write(contents)
-        f.close()
-        contents = &quot;You can find more information about these rpms at <A HREF="http://dries.ulyssis.org/rpm/\n">http://dries.ulyssis.org/rpm/\n</A>&quot;
-        f = open(os.path.join(self.__siterootdir,&quot;HEADERS&quot;), &quot;w&quot;)
-        f.write(contents)
-        f.close()
-        
-        
     def generateDirectoryView(self,path):
         contents = self.__getFileContents(&quot;dries/directoryview-part.html&quot;)
         self.generateFullPage(contents,[],path + &quot;/index.php&quot;, &quot;Index of /rpm/&quot; + path + &quot; - Dries RPM Repository&quot;)
@@ -249,9 +251,103 @@
         self.generateFullPage(contents, [distroArch.displayName], distroArch.shortName + &quot;-rpms.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
         # also generate a page in redhat/el4/i386/ for example
         for path in distroArch.additionalPaths:
+            # 1 create a .htaccess file which links release.* files in this DIR
+            # 2 create a dir DIR/dries , DIR/dries/headers , DIR/base, DIR/RPMS.dries, DIR/SRPMS.dries DIR/RPMS.dries/repodata DIR/SRPMS.dries/repodata
+            # 3 create a symbolic link: DIR/dries/RPMS -&gt; ../RPMS.dries
+            # 4 create a symbolic link: DIR/dries/SRPMS -&gt; ../SRPMS.dries
+            # 5 create a DIR/dries/headers/.htaccess which redirects all .hdr files and the header.info file
+            # 6 create a DIR/base/.htaccess  which redirects all pkglist.* release.* and srclist.* files
+            # 7 create a DIR/RPMS.dries/.htaccess which redirects all  .*\.rpm files
+            # 8 create a DIR/RPMS.dries/repodata/.htaccess which redirects all filelist* other* primary* repomd* files
+            # 9 create a DIR/SRPMS.dries/.htaccess which redirects all .*\.rpm files
+            # 10 create a DIR/SRPMS.dries/repodata/.htaccess which redirects all filelist* other* primary* repomd* files
+            # 11 create dirindexes in DIR, DIR/dries, DIR/dries/headers, DIR/base
+            # 1
+            htcontents = &quot;RewriteEngine on\n&quot; + 'RewriteRule ^(release.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/$1' + &quot;\n&quot;
+            self.createFile(os.path.join(path,&quot;.htaccess&quot;), htcontents)
+            # 2
+            self.createDirHierarchy(os.path.join(path,&quot;dries/headers&quot;))
+            self.createDirHierarchy(os.path.join(path,&quot;base&quot;))
+            self.createDirHierarchy(os.path.join(path,&quot;RPMS.dries/repodata&quot;))
+            self.createDirHierarchy(os.path.join(path,&quot;SRPMS.dries/repodata&quot;))
+            # 3
+            self.createSymbolicLink(os.path.join(path,&quot;dries/RPMS&quot;), &quot;../RPMS.dries&quot;)
+            # 4
+            self.createSymbolicLink(os.path.join(path,&quot;dries/SRPMS&quot;), &quot;../SRPMS.dries&quot;)
+            # 5
+            htcontents = &quot;RewriteEngine on\n&quot; + 'RewriteRule ^(.*hdr)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/dries/headers/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(header.info)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/dries/headers/$1' + &quot;\n&quot;
+            self.createFile(os.path.join(path,&quot;dries/headers/.htaccess&quot;), htcontents)
+            # 6
+            htcontents = &quot;RewriteEngine on\n&quot; + 'RewriteRule ^(pkglist.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/base/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(release.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/base/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(srclist.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/base/$1' + &quot;\n&quot;
+            self.createFile(os.path.join(path,&quot;base/.htaccess&quot;), htcontents)
+            # 7
+            htcontents = &quot;RewriteEngine on\n&quot; + 'RewriteRule ^(.*.rpm)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/RPMS.dries/$1' + &quot;\n&quot;
+            self.createFile(os.path.join(path,&quot;RPMS.dries/.htaccess&quot;), htcontents)
+            # 8
+            htcontents = &quot;RewriteEngine on\n&quot; + 'RewriteRule ^(filelist.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/RPMS.dries/repodata/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(other.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/RPMS.dries/repodata/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(primary.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/RPMS.dries/repodata/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(repomd.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/RPMS.dries/repodata/$1' + &quot;\n&quot;
+            self.createFile(os.path.join(path,&quot;RPMS.dries/repodata/.htaccess&quot;), htcontents)
+            # 9
+            htcontents = &quot;RewriteEngine on\n&quot; + 'RewriteRule ^(.*.rpm)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/SRPMS.dries/$1' + &quot;\n&quot;
+            self.createFile(os.path.join(path,&quot;SRPMS.dries/.htaccess&quot;), htcontents)
+            # 10
+            htcontents = &quot;RewriteEngine on\n&quot; + 'RewriteRule ^(filelist.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/SRPMS.dries/repodata/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(other.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/SRPMS.dries/repodata/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(primary.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/SRPMS.dries/repodata/$1' + &quot;\n&quot;
+            htcontents = htcontents + 'RewriteRule ^(repomd.*)$ <A HREF="http://ftp.belnet.be/packages/dries.ulyssis.org/">http://ftp.belnet.be/packages/dries.ulyssis.org/</A>' + path + '/SRPMS.dries/repodata/$1' + &quot;\n&quot;
+            self.createFile(os.path.join(path,&quot;SRPMS.dries/repodata/.htaccess&quot;), htcontents)
+            # 11
+            self.generateDirectoryView(path)
+            self.generateDirectoryView(path + &quot;/dries&quot;)
+            self.generateDirectoryView(path + &quot;/dries/headers&quot;)
+            self.generateDirectoryView(path + &quot;/base&quot;)
+            
             contents = &quot;This page now contains links to the rpms on one of the mirrors because the page is generating way too much traffic for this server.&lt;br /&gt;&lt;br /&gt;&quot; + contents
-            self.generateFullPage(contents, [distroArch.displayName], path + &quot;/index.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
+            self.generateFullPage(contents, [distroArch.displayName], path + &quot;/RPMS.dries/index.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
     
+    def createSymbolicLink(self, filename, target):
+        (tempdir, fname) = os.path.split(filename)
+        dir = os.path.join(self.__siterootdir, tempdir)
+        #print dir
+        errors = 0
+        try:
+            os.makedirs(dir)
+        except:
+            errors = errors + 1
+        try:
+            os.symlink(target, os.path.join(dir,fname))
+        except:
+            errors = errors + 1
+            
+    def createFile(self, filename, contents):
+        # first make sure the directory exists
+        (tempdir, fname) = os.path.split(filename)
+        dir = os.path.join(self.__siterootdir, tempdir)
+        #print dir
+        errors = 0
+        try:
+            os.makedirs(dir)
+        except:
+            errors = errors + 1
+        f = open(os.path.join(dir,fname), &quot;w&quot;)
+        f.write(contents)
+        f.close()
+        
+        
+            
+    def createDirHierarchy(self, path):
+        dir = os.path.join(self.__siterootdir, path)
+        errors = 0
+        try:
+            os.makedirs(dir)
+        except:
+            errors = errors + 1
+            
     def generateDistroArchPageSrpm(self,distroArch):
         contents = &quot;&quot;
         url = distroArch.rpmsUrl.replace(&quot;RPMS&quot;,&quot;SRPMS&quot;)
@@ -262,7 +358,9 @@
                 linkToPackage = &quot;&amp;nbsp;-&amp;nbsp&lt;a href=\&quot;/rpm/packages/&quot; + self.__rpmNameToSpecSubDirName[r] + &quot;/info.html\&quot;&gt;&quot; + self.__rpmNameToSpecSubDirName[r] + &quot;&lt;/a&gt;&quot;
             contents = contents + &quot;&lt;a href=\&quot;&quot; + url + r + &quot;\&quot;&gt;&quot; + r + &quot;&lt;/a&gt;&quot; + linkToPackage + &quot;&lt;br /&gt;&quot;
         self.generateFullPage(contents, [distroArch.displayName], distroArch.shortName + &quot;-srpms.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
-        
+        for path in distroArch.additionalPaths:
+            contents = &quot;This page now contains links to the source rpms on one of the mirrors because the page is generating way too much traffic for this server.&lt;br /&gt;&lt;br /&gt;&quot; + contents
+            self.generateFullPage(contents, [distroArch.displayName], path + &quot;/SRPMS.dries/index.html&quot;,distroArch.fullName + &quot; (&quot; + distroArch.displayName + &quot;): Dries RPM Repository&quot;)
             
     def generatePackagesPage(self):
         contents = &quot;&quot;
@@ -288,6 +386,7 @@
         menu = &quot;&quot;
         menu = menu + &quot;&lt;strong&gt;General&lt;/strong&gt;&lt;br /&gt;&quot;
         menu = menu + &quot;&quot;
+        menu = menu + &quot;&lt;a href=\&quot;/rpm/\&quot;&gt;Start&lt;/a&gt;&lt;br /&gt;&quot;
         menu = menu + &quot;&lt;a href=\&quot;/rpm/clientconfig.html\&quot;&gt;APT/YUM/Smart config&lt;/a&gt;&lt;br /&gt;&quot;
         menu = menu + &quot;&lt;a href=\&quot;/rpm/packages.html\&quot;&gt;List of packages&lt;/a&gt;&lt;br /&gt;&quot;
         menu = menu + &quot;&lt;a href=\&quot;/rpm/RPM-GPG-KEY.dries.html\&quot;&gt;GPG key&lt;/a&gt;&lt;br /&gt;&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002115.html">[svn] r3313 - in trunk/rpms: krusader perl-TimeDate texmacs
</A></li>
	<LI>Next message: <A HREF="002117.html">[svn] r3315 - in trunk/tools/dconf: . config rpmqa scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2116">[ date ]</a>
              <a href="thread.html#2116">[ thread ]</a>
              <a href="subject.html#2116">[ subject ]</a>
              <a href="author.html#2116">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.repoforge.org/mailman/listinfo/commits">More information about the commits
mailing list</a><br>
</body></html>
